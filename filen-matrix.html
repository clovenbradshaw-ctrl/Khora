<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Encrypted Backup</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #08080d; --surface: #101018; --surface2: #181824; --surface3: #20202e;
    --border: #282838; --border-hover: #383850;
    --text: #e4e4f0; --text-dim: #7878a0; --text-faint: #505070;
    --accent: #7c6cf0; --accent-dim: rgba(124,108,240,0.15); --accent-glow: rgba(124,108,240,0.25);
    --green: #00d4a0; --green-dim: rgba(0,212,160,0.12);
    --red: #f06060; --red-dim: rgba(240,96,96,0.12);
    --yellow: #f0c840; --yellow-dim: rgba(240,200,64,0.1);
    --blue: #48a0f0;
    --mg: #0dbd8b; --mg-dim: rgba(13,189,139,0.12);
    --radius: 10px; --radius-sm: 6px;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
  .shell{max-width:840px;margin:0 auto;padding:20px}
  .header{display:flex;align-items:center;gap:14px;margin-bottom:24px}
  .logo{width:42px;height:42px;background:linear-gradient(135deg,var(--mg),var(--accent));border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 4px 20px rgba(13,189,139,0.25);flex-shrink:0}
  .header h1{font-size:20px;font-weight:700;letter-spacing:-0.5px}
  .header .sub{font-size:11px;color:var(--text-dim);font-family:'IBM Plex Mono',monospace}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:14px}
  label{display:block;font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;margin-top:16px}
  label:first-child{margin-top:0}
  input[type=text],input[type=email],input[type=password]{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:13px;outline:none;transition:border .2s}
  input:focus{border-color:var(--accent)}
  .btn{padding:8px 18px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
  .btn-primary{background:var(--mg);color:#000}
  .btn-primary:hover{background:#0fd4a0}
  .btn-primary:disabled{opacity:.5;cursor:default}
  .btn-ghost{background:transparent;color:var(--text-dim);border:1px solid var(--border)}
  .btn-ghost:hover{border-color:var(--border-hover);color:var(--text)}
  .btn-sm{padding:6px 12px;font-size:11px}
  .btn-icon{background:none;border:none;cursor:pointer;padding:3px 5px;font-size:15px;border-radius:4px;opacity:.5;transition:all .15s}
  .btn-icon:hover{opacity:1;background:var(--surface3)}
  .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
  .spinner.lg{width:24px;height:24px;border-width:3px}
  .spinner.brand{border-color:rgba(13,189,139,.2);border-top-color:var(--mg)}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

  .setup-step{display:none}.setup-step.active{display:block}
  .setup-icon{font-size:48px;text-align:center;margin-bottom:16px}
  .setup-title{font-size:18px;font-weight:700;text-align:center;margin-bottom:6px}
  .setup-desc{font-size:13px;color:var(--text-dim);text-align:center;margin-bottom:20px;line-height:1.5}
  .step-indicator{display:flex;justify-content:center;gap:8px;margin-bottom:20px}
  .step-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:all .3s}
  .step-dot.active{background:var(--mg);box-shadow:0 0 10px rgba(13,189,139,0.4)}
  .step-dot.done{background:var(--green)}
  .confirm-box{text-align:center;padding:20px 0}
  .confirm-box .email-addr{color:var(--mg);font-family:'IBM Plex Mono',monospace;font-weight:600}
  .auto-bar{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;display:flex;align-items:center;gap:10px;margin-bottom:14px;font-size:12px;color:var(--text-dim)}
  .recovery-key-box{background:var(--bg);border:2px dashed var(--border);border-radius:var(--radius-sm);padding:16px;margin:16px 0;text-align:center}
  .recovery-key-box .key{font-family:'IBM Plex Mono',monospace;font-size:14px;color:var(--mg);letter-spacing:0.5px;word-break:break-all;line-height:1.6;user-select:all}
  .recovery-key-box .rlabel{font-size:10px;color:var(--text-faint);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
  .notice{background:var(--yellow-dim);border:1px solid rgba(240,200,64,.15);border-radius:var(--radius-sm);padding:10px 14px;font-size:11px;color:var(--yellow);margin-bottom:14px;line-height:1.5}
  .notice code{background:rgba(0,0,0,.3);padding:1px 5px;border-radius:3px}

  .file-list{max-height:50vh;overflow-y:auto}
  .file-row{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:var(--radius-sm);transition:background .12s}
  .file-row:hover{background:var(--surface2)}
  .ficon{width:28px;text-align:center;font-size:17px;flex-shrink:0}
  .fname{flex:1;font-size:13px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .fname.click{cursor:pointer}
  .fmeta{font-size:11px;color:var(--text-dim);font-family:'IBM Plex Mono',monospace;white-space:nowrap;min-width:60px;text-align:right}
  .factions{display:flex;gap:3px;opacity:0;transition:opacity .15s}
  .file-row:hover .factions{opacity:1}
  .empty{text-align:center;padding:40px 20px;color:var(--text-dim)}
  .empty .big{font-size:42px;margin-bottom:8px}
  .upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:20px;text-align:center;cursor:pointer;transition:all .2s;margin-top:12px}
  .upload-zone:hover,.upload-zone.over{border-color:var(--mg);background:var(--mg-dim)}
  .upload-zone p{font-size:12px;color:var(--text-dim);margin-top:4px}
  .upload-zone input{display:none}
  .progress-track{height:4px;background:var(--surface3);border-radius:2px;margin:8px 0;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--mg),var(--accent));width:0;transition:width .3s;border-radius:2px}
  .toolbar{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--border)}
  .breadcrumb{flex:1;display:flex;align-items:center;gap:4px;font-size:12px;font-family:'IBM Plex Mono',monospace;overflow-x:auto;white-space:nowrap}
  .breadcrumb span{color:var(--text-dim);cursor:pointer;padding:3px 6px;border-radius:4px;transition:all .12s}
  .breadcrumb span:hover{color:var(--text);background:var(--surface3)}
  .breadcrumb .sep{color:var(--text-faint);cursor:default;padding:0 1px}
  .breadcrumb .sep:hover{background:none}
  .user-bar{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .avatar{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--mg),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0}
  .uname{font-size:13px;font-weight:600}
  .storage{font-size:11px;color:var(--text-dim);font-family:'IBM Plex Mono',monospace}
  .logout{margin-left:auto}
  .toast{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column-reverse;gap:8px;z-index:9999;max-width:360px}
  .toast-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;font-size:12px;display:flex;align-items:center;gap:8px;box-shadow:0 8px 32px rgba(0,0,0,.6)}
  .toast-item .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
  .toast-item.info .dot{background:var(--blue)}
  .toast-item.success .dot{background:var(--green)}
  .toast-item.error .dot{background:var(--red)}
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}
  .modal-overlay.show{display:flex}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;max-width:520px;width:90%;max-height:85vh;overflow-y:auto}
  .modal h3{font-size:15px;margin-bottom:14px}
  .modal .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:18px}
  .hidden{display:none!important}
  .link-box{display:flex;gap:8px;align-items:center;margin-top:12px}
  .link-url{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:10px 14px;font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent);word-break:break-all;cursor:text;user-select:all}
  .link-copied{background:var(--green-dim);color:var(--green);border-color:rgba(0,212,160,.3);transition:all .3s}
  .link-status{display:flex;align-items:center;gap:6px;font-size:12px;font-family:'IBM Plex Mono',monospace;margin-bottom:10px}
  .link-status .live{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite}
  .link-status .off{width:8px;height:8px;border-radius:50%;background:var(--text-faint)}
  @media(max-width:600px){.shell{padding:14px}.factions{opacity:1}.user-bar{flex-wrap:wrap}}
  /* Pool Bridge */
  .bridge-card{background:var(--mg-dim);border:1px solid rgba(13,189,139,0.2);border-radius:var(--radius);padding:20px;margin-bottom:14px}
  .bridge-card h3{font-size:14px;font-weight:700;margin-bottom:6px}
  .bridge-card p{font-size:12px;color:var(--text-dim);line-height:1.6;margin-bottom:14px}
  .bridge-cap-row{display:flex;align-items:center;gap:10px;margin-bottom:14px}
  .bridge-cap-row label{margin:0;flex-shrink:0}
  .bridge-cap-row input[type=number]{width:80px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:12px;outline:none}
  .bridge-cap-row input[type=number]:focus{border-color:var(--accent)}
  .bridge-cap-row .unit{font-size:11px;color:var(--text-faint)}
  .bridge-actions{display:flex;gap:8px}
  .bridge-status{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;display:flex;align-items:center;gap:10px;margin-bottom:14px;font-size:12px;color:var(--text-dim)}
  .bridge-status .live{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite;flex-shrink:0}
  .bridge-status .bridge-info{flex:1;font-family:'IBM Plex Mono',monospace}
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="shell">
  <div class="header">
    <div class="logo">üõ°Ô∏è</div>
    <div><h1>Encrypted Backup</h1><div class="sub">your data ¬∑ your keys ¬∑ always recoverable</div></div>
  </div>

  <div id="setupView">
    <div class="notice"><strong>‚ö† CORS:</strong> Serve via local server (<code>python3 -m http.server</code>) or embed in your app. All crypto runs client-side.</div>
    <div id="autoBar" class="auto-bar hidden"><div class="spinner brand"></div><span>Reconnecting as <strong id="autoBarId"></strong>‚Ä¶</span></div>

    <!-- Step 1: Setup -->
    <div id="step1" class="setup-step active">
      <div class="card">
        <div class="step-indicator"><div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div></div>
        <div class="setup-icon">üîê</div>
        <div class="setup-title">Set Up Encrypted Backup</div>
        <div class="setup-desc">Your Matrix ID is your recovery key.<br>If your server ever goes down, you can recover all your data<br>using just your Matrix ID and email.</div>
        <label>Matrix ID</label>
        <input type="text" id="inMatrixId" placeholder="@yourname:server.org" autocomplete="username" spellcheck="false">
        <label>Recovery Email</label>
        <input type="email" id="inSetupEmail" placeholder="you@example.com" autocomplete="email">
        <button class="btn btn-primary" id="setupBtn" onclick="startSetup()" style="margin-top:20px;width:100%;justify-content:center">Activate Backup</button>
        <div style="margin-top:16px;text-align:center"><button class="btn btn-ghost btn-sm" onclick="goStep('recover')" style="font-size:11px">üîì Recover existing backup</button></div>
      </div>
    </div>

    <!-- Step 2: Email confirmation -->
    <div id="step2" class="setup-step">
      <div class="card">
        <div class="step-indicator"><div class="step-dot done"></div><div class="step-dot active"></div><div class="step-dot"></div></div>
        <div class="confirm-box">
          <div class="setup-icon">üì¨</div>
          <div class="setup-title">Confirm Your Email</div>
          <div style="font-size:13px;color:var(--text-dim);margin:12px 0;line-height:1.5">We sent a verification link to<br><span class="email-addr" id="confirmEmailAddr">‚Äî</span></div>
          <div class="setup-desc">Click the link in the email, then come back here.</div>
          <button class="btn btn-primary" id="retryLoginBtn" onclick="retryAfterConfirm()" style="margin-top:8px">I've confirmed ‚Äî activate backup</button>
          <div style="margin-top:12px"><button class="btn btn-ghost btn-sm" onclick="resendConfirmation()">Resend email</button> <button class="btn btn-ghost btn-sm" onclick="goStep(1)">‚Üê Back</button></div>
        </div>
      </div>
    </div>

    <!-- Step 3: Recovery info display -->
    <div id="step3" class="setup-step">
      <div class="card">
        <div class="step-indicator"><div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot active"></div></div>
        <div class="setup-icon">üõ°Ô∏è</div>
        <div class="setup-title">Your Recovery Info</div>
        <div class="setup-desc">Save this somewhere safe. If your Matrix server ever goes down,<br>this is all you need to recover every file.</div>
        <div class="recovery-key-box"><div class="rlabel">Recovery Identity</div><div class="key" id="recoveryKeyDisplay">‚Äî</div></div>
        <div class="recovery-key-box" style="border-color:var(--border)"><div class="rlabel">Recovery Email</div><div class="key" id="recoveryEmailDisplay" style="color:var(--text)">‚Äî</div></div>
        <div style="font-size:11px;color:var(--text-faint);text-align:center;margin:12px 0;line-height:1.6">That's it ‚Äî those two things. No passwords to remember.<br>Your encryption key is derived automatically from your Matrix ID.</div>
        <button class="btn btn-primary" onclick="finishSetup()" style="margin-top:8px;width:100%;justify-content:center">Got it ‚Äî open my backup</button>
      </div>
    </div>

    <!-- Recovery mode -->
    <div id="stepRecover" class="setup-step">
      <div class="card">
        <div class="setup-icon">üîì</div>
        <div class="setup-title">Recover Your Backup</div>
        <div class="setup-desc">Enter the Matrix ID and email you used when you set up your backup.<br>Your encryption key will be derived automatically.</div>
        <label>Matrix ID</label>
        <input type="text" id="inRecoverMatrixId" placeholder="@yourname:server.org" spellcheck="false">
        <label>Recovery Email</label>
        <input type="email" id="inRecoverEmail" placeholder="you@example.com">
        <button class="btn btn-primary" id="recoverBtn" onclick="doRecover()" style="margin-top:20px;width:100%;justify-content:center">Recover My Data</button>
        <div style="margin-top:12px;text-align:center"><button class="btn btn-ghost btn-sm" onclick="goStep(1)">‚Üê Back to setup</button></div>
      </div>
    </div>
  </div>

  <div id="browserView" class="hidden">
    <div class="user-bar">
      <div class="avatar" id="uAvatar">?</div>
      <div><div class="uname" id="uName">‚Äî</div><div class="storage" id="uStorage"></div></div>
      <button class="btn btn-ghost btn-sm logout" onclick="doLogout()">Disconnect</button>
    </div>
    <!-- Pool Bridge Invitation -->
    <div id="poolBridgeCard" class="bridge-card hidden">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
        <div style="font-size:28px">üåê</div>
        <div>
          <h3>Help the Network</h3>
          <div style="font-size:12px;color:var(--text-dim)">Mirror encrypted files so others can fetch when uploaders are offline</div>
        </div>
      </div>
      <p>Your account supports public links. Enable bridge mode to automatically store and serve encrypted blobs for the Khora network. You'll never see the contents ‚Äî everything arrives pre-encrypted.</p>
      <div class="bridge-cap-row">
        <label style="margin-top:0">CAPACITY</label>
        <input type="number" id="bridgeCapacityInput" value="5" min="1" max="100" step="1">
        <span class="unit">GB of <span id="bridgeAvailable">‚Äî</span> available</span>
      </div>
      <div class="bridge-actions">
        <button class="btn btn-primary btn-sm" onclick="enableBridge()">Enable Bridge</button>
        <button class="btn btn-ghost btn-sm" onclick="dismissBridgeCard()">Not Now</button>
      </div>
    </div>
    <!-- Pool Bridge Status -->
    <div id="poolBridgeStatus" class="bridge-status hidden">
      <div class="live"></div>
      <div class="bridge-info"><strong>Pool Bridge active</strong> ¬∑ <span id="bridgeFileCount">0</span> files mirrored ¬∑ <span id="bridgeStorageUsed">0 B</span> used</div>
      <button class="btn btn-ghost btn-sm" onclick="disableBridge()" style="margin-left:auto;flex-shrink:0">Disable</button>
    </div>
    <div class="card">
      <div class="toolbar">
        <div class="breadcrumb" id="breadcrumb"></div>
        <button class="btn-icon" onclick="promptNewFolder()" title="New folder">Ôºã</button>
        <button class="btn-icon" onclick="refreshDir()" title="Refresh">‚Üª</button>
      </div>
      <div class="file-list" id="fileList"></div>
      <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileIn').click()">
        <div style="font-size:22px">üì§</div><p>Drop files here or click to upload</p>
        <input type="file" id="fileIn" multiple onchange="handleUpload(this.files)">
      </div>
      <div id="progressWrap" class="hidden"><div class="progress-track"><div class="progress-fill" id="progressFill"></div></div></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalBox"><h3 id="modalTitle"></h3><div id="modalBody"></div><div class="modal-actions" id="modalActions"></div></div>
</div>

<script>
const GW='https://gateway.filen.io';
const EGEST=['https://egest.filen.io','https://egest.filen.net','https://egest.filen-1.net','https://egest.filen-2.net','https://egest.filen-3.net','https://egest.filen-4.net','https://egest.filen-5.net','https://egest.filen-6.net'];
const INGEST=['https://ingest.filen.io','https://ingest.filen.net','https://ingest.filen-1.net','https://ingest.filen-2.net','https://ingest.filen-3.net','https://ingest.filen-4.net','https://ingest.filen-5.net','https://ingest.filen-6.net'];
const CHUNK=1048576;
const APP_SALT='khora-matrix-backup-bridge-v1';
const te=new TextEncoder(),td=new TextDecoder();

let S={apiKey:null,masterKeys:[],baseFolderUUID:null,email:null,matrixId:null,curDir:null,pathStack:[],filenPassword:null,canCreateLinks:false,maxStorage:0,usedStorage:0};
let curFolders=[],curFiles=[];

const hex=b=>Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');
const unhex=h=>{const a=new Uint8Array(h.length/2);for(let i=0;i<h.length;i+=2)a[i/2]=parseInt(h.substr(i,2),16);return a;};
const b64e=b=>{let s='';const a=new Uint8Array(b);for(let i=0;i<a.length;i++)s+=String.fromCharCode(a[i]);return btoa(s);};
const b64d=s=>{const b=atob(s);const a=new Uint8Array(b.length);for(let i=0;i<b.length;i++)a[i]=b.charCodeAt(i);return a;};
const rHex=n=>hex(crypto.getRandomValues(new Uint8Array(n)));
const pick=a=>a[Math.floor(Math.random()*a.length)];
function fmtSize(b){if(!b)return'0 B';const u=['B','KB','MB','GB','TB'];const i=Math.floor(Math.log(b)/Math.log(1024));return(b/Math.pow(1024,i)).toFixed(i?1:0)+' '+u[i];}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

let tid_=0;
function toast(m,t='info',d=4000){const id=++tid_;const el=document.createElement('div');el.className=`toast-item ${t}`;el.innerHTML=`<div class="dot"></div><span>${esc(m)}</span>`;el.id='_t'+id;document.getElementById('toast').appendChild(el);if(d>0)setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .3s';setTimeout(()=>el.remove(),300);},d);return id;}
function killToast(id){const el=document.getElementById('_t'+id);if(el)el.remove();}

function showModal(title,body,actions){document.getElementById('modalTitle').textContent=title;document.getElementById('modalBody').innerHTML=body;document.getElementById('modalActions').innerHTML=(actions||[]).join('');document.getElementById('modalOverlay').classList.add('show');}
function closeModal(){document.getElementById('modalOverlay').classList.remove('show');}
function showPrompt(msg,def=''){return new Promise(r=>{showModal('',`<div style="font-size:14px;margin-bottom:14px">${esc(msg)}</div><input type="text" id="_pIn" value="${esc(def)}" style="width:100%">`,[`<button class="btn btn-ghost btn-sm" onclick="closeModal();window._pR(null)">Cancel</button>`,`<button class="btn btn-primary btn-sm" onclick="closeModal();window._pR(document.getElementById('_pIn').value)">OK</button>`]);window._pR=r;setTimeout(()=>{const i=document.getElementById('_pIn');if(i){i.focus();i.select();}},100);});}
function showConfirm(msg,yesLabel='Confirm'){return new Promise(r=>{showModal('',`<div style="font-size:14px">${esc(msg)}</div>`,[`<button class="btn btn-ghost btn-sm" onclick="closeModal();window._cR(false)">Cancel</button>`,`<button class="btn btn-primary btn-sm" onclick="closeModal();window._cR(true)">${esc(yesLabel)}</button>`]);window._cR=r;});}
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&document.getElementById('modalOverlay').classList.contains('show'))closeModal();});

// ‚ïê‚ïê‚ïê CRYPTO ‚ïê‚ïê‚ïê
async function pbkdf2Bits(pw,salt,iter,hash,bits){
  const km=await crypto.subtle.importKey('raw',te.encode(pw),'PBKDF2',false,['deriveBits']);
  return crypto.subtle.deriveBits({name:'PBKDF2',salt:te.encode(salt),iterations:iter,hash},km,bits);
}
async function sha512(s){return hex(await crypto.subtle.digest('SHA-512',te.encode(s)));}
async function deriveFilenPassword(matrixId){return hex(await pbkdf2Bits(matrixId,APP_SALT,100000,'SHA-512',256));}
async function deriveLoginAndMaster(raw,salt,ver){
  if(ver!==2)throw new Error('Auth v'+ver+' unsupported');
  const dk=hex(await pbkdf2Bits(raw,salt,200000,'SHA-512',512));
  return{masterKey:dk.substring(0,dk.length/2),loginPassword:await sha512(dk.substring(dk.length/2))};
}
async function aesKey(key,use){
  const km=await crypto.subtle.importKey('raw',te.encode(key),'PBKDF2',false,['deriveBits']);
  const bits=await crypto.subtle.deriveBits({name:'PBKDF2',salt:te.encode(key),iterations:1,hash:'SHA-512'},km,256);
  return crypto.subtle.importKey('raw',bits,'AES-GCM',false,use);
}
async function metaEnc(data,key){
  const k=await aesKey(key,['encrypt']);const iv=crypto.getRandomValues(new Uint8Array(12));
  const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv,tagLength:128},k,te.encode(typeof data==='string'?data:JSON.stringify(data)));
  return'002'+td.decode(iv)+b64e(ct);
}
async function metaDec(meta,key){
  try{if(!meta||meta.startsWith('U2FsdGVk')||meta.substring(0,3)!=='002')return null;
  const iv=te.encode(meta.substring(3,15));const ct=b64d(meta.substring(15));
  const k=await aesKey(key,['decrypt']);
  return td.decode(await crypto.subtle.decrypt({name:'AES-GCM',iv,tagLength:128},k,ct));}catch{return null;}
}
async function decMeta(meta){
  for(let i=S.masterKeys.length-1;i>=0;i--){const r=await metaDec(meta,S.masterKeys[i]);if(r){try{return JSON.parse(r);}catch{return r;}}}return null;
}
async function aesKeyFromFileKey(fk,use){
  const kb=te.encode(fk);const km=await crypto.subtle.importKey('raw',kb,'PBKDF2',false,['deriveBits']);
  const bits=await crypto.subtle.deriveBits({name:'PBKDF2',salt:kb,iterations:1,hash:'SHA-512'},km,256);
  return crypto.subtle.importKey('raw',bits,'AES-GCM',false,use);
}
async function decryptChunk(buf,fileKey){
  const a=new Uint8Array(buf);
  if(td.decode(a.slice(0,3))==='002'){const iv=a.slice(3,15),ct=a.slice(15);const k=await aesKeyFromFileKey(fileKey,['decrypt']);return crypto.subtle.decrypt({name:'AES-GCM',iv,tagLength:128},k,ct);}
  const iv=a.slice(0,12),ct=a.slice(12);const raw=te.encode(fileKey);const kb=raw.length>=32?raw.slice(0,32):raw;
  const k=await crypto.subtle.importKey('raw',kb,'AES-GCM',false,['decrypt']);
  return crypto.subtle.decrypt({name:'AES-GCM',iv,tagLength:128},k,ct);
}
async function encryptChunk(chunk,fileKey){
  const iv=crypto.getRandomValues(new Uint8Array(12));const k=await aesKeyFromFileKey(fileKey,['encrypt']);
  const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv,tagLength:128},k,chunk);
  const out=new Uint8Array(3+12+ct.byteLength);out.set(te.encode('002'),0);out.set(iv,3);out.set(new Uint8Array(ct),15);return out;
}

// ‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê
async function apiPost(path,body,auth=true){
  const h={'Content-Type':'application/json'};if(auth&&S.apiKey)h['Authorization']=`Bearer ${S.apiKey}`;
  return(await fetch(`${GW}/v3${path}`,{method:'POST',headers:h,body:JSON.stringify(body)})).json();
}
async function apiGet(path){const h={};if(S.apiKey)h['Authorization']=`Bearer ${S.apiKey}`;return(await fetch(`${GW}/v3${path}`,{headers:h})).json();}

// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
function goStep(n){
  document.querySelectorAll('.setup-step').forEach(s=>s.classList.remove('active'));
  const map={1:'step1',2:'step2',3:'step3','recover':'stepRecover'};
  const el=document.getElementById(map[n]);if(el)el.classList.add('active');
}

async function tryLogin(email,rawPassword){
  try{
    const ai=await apiPost('/auth/info',{email},false);if(!ai.status)return false;
    const{masterKey,loginPassword}=await deriveLoginAndMaster(rawPassword,ai.data.salt,ai.data.authVersion);
    const lr=await apiPost('/login',{email,password:loginPassword,twoFactorCode:'XXXXXX',authVersion:ai.data.authVersion},false);
    if(!lr.status)return false;
    S.apiKey=lr.data.apiKey;S.email=email;S.masterKeys=[masterKey];
    try{const emk=await metaEnc(masterKey,masterKey);const mkr=await apiPost('/user/masterKeys',{masterKeys:emk});if(mkr.status&&mkr.data?.keys){const dk=await metaDec(mkr.data.keys,masterKey);if(dk)S.masterKeys=dk.split('|').filter(Boolean);}}catch{}
    const bf=await apiGet('/user/baseFolder');if(!bf.status)throw new Error('Base folder failed');S.baseFolderUUID=bf.data.uuid;
    try{const acc=await apiGet('/user/account');if(acc.status){const used=acc.data.storageUsed||0,max=acc.data.maxStorage||0;document.getElementById('uStorage').textContent=`${fmtSize(used)} / ${fmtSize(max)}`;S.maxStorage=max;S.usedStorage=used;S.canCreateLinks=max>11*1024*1024*1024;}}catch{}
    return true;
  }catch{return false;}
}
async function tryRegister(email,rawPassword){
  try{
    const salt=rHex(64);const{masterKey,loginPassword}=await deriveLoginAndMaster(rawPassword,salt,2);
    const r=await apiPost('/register',{email,password:loginPassword,salt,authVersion:2},false);
    if(r.status)return'registered';
    const msg=(r.message||'').toLowerCase();
    if(msg.includes('already')||msg.includes('exists')||msg.includes('registered'))return'exists_unconfirmed';
    return r.message||'Registration failed';
  }catch(e){return e.message;}
}

async function startSetup(){
  const matrixId=document.getElementById('inMatrixId').value.trim();
  const email=document.getElementById('inSetupEmail').value.trim();
  const btn=document.getElementById('setupBtn');
  if(!matrixId||!matrixId.startsWith('@')||!matrixId.includes(':')){toast('Enter a valid Matrix ID like @user:server.org','error');return;}
  if(!email||!email.includes('@')){toast('Enter a valid email','error');return;}
  btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Setting up‚Ä¶';
  let t=toast('Deriving encryption key‚Ä¶','info',0);
  try{
    const fp=await deriveFilenPassword(matrixId);S.matrixId=matrixId;S.filenPassword=fp;killToast(t);
    t=toast('Checking for existing backup‚Ä¶','info',0);
    const ok=await tryLogin(email,fp);killToast(t);
    if(ok){saveCreds(matrixId,email);if(!hasSeenRecovery()){showRecoveryStep(matrixId,email);}else{switchToBrowser(matrixId);toast('Backup connected','success');}return;}
    t=toast('Creating encrypted vault‚Ä¶','info',0);
    const reg=await tryRegister(email,fp);killToast(t);
    if(reg==='registered'||reg==='exists_unconfirmed'){
      saveCreds(matrixId,email);document.getElementById('confirmEmailAddr').textContent=email;goStep(2);
      toast(reg==='registered'?'Vault created ‚Äî check your email':'Confirm your email to continue','success');
    }else{throw new Error(reg);}
  }catch(e){killToast(t);toast(e.message,'error',8000);}
  finally{btn.disabled=false;btn.textContent='Activate Backup';}
}

function showRecoveryStep(matrixId,email){
  document.getElementById('recoveryKeyDisplay').textContent=matrixId;
  document.getElementById('recoveryEmailDisplay').textContent=email;
  goStep(3);
}
function finishSetup(){markRecoverySeen();switchToBrowser(S.matrixId);toast('Backup connected','success');}

async function retryAfterConfirm(){
  const btn=document.getElementById('retryLoginBtn');btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Connecting‚Ä¶';
  const creds=loadCreds();
  if(!creds){toast('No saved info','error');goStep(1);btn.disabled=false;btn.textContent="I've confirmed ‚Äî activate backup";return;}
  const t=toast('Deriving key‚Ä¶','info',0);
  try{
    const fp=await deriveFilenPassword(creds.matrixId);killToast(t);
    const ok=await tryLogin(creds.email,fp);
    if(ok){S.matrixId=creds.matrixId;S.filenPassword=fp;if(!hasSeenRecovery()){showRecoveryStep(creds.matrixId,creds.email);}else{switchToBrowser(creds.matrixId);toast('Backup connected','success');}}
    else{toast('Not ready ‚Äî check your email for the confirmation link','error',6000);}
  }catch(e){killToast(t);toast(e.message,'error',6000);}
  finally{btn.disabled=false;btn.textContent="I've confirmed ‚Äî activate backup";}
}
async function resendConfirmation(){
  const creds=loadCreds();if(!creds){toast('No email saved','error');return;}
  try{const r=await apiPost('/confirmationSend',{email:creds.email},false);toast(r.status?'Verification email resent':'Could not resend','info');}catch(e){toast('Failed: '+e.message,'error');}
}

async function doRecover(){
  const matrixId=document.getElementById('inRecoverMatrixId').value.trim();
  const email=document.getElementById('inRecoverEmail').value.trim();
  const btn=document.getElementById('recoverBtn');
  if(!matrixId||!matrixId.startsWith('@')||!matrixId.includes(':')){toast('Enter your Matrix ID','error');return;}
  if(!email||!email.includes('@')){toast('Enter your recovery email','error');return;}
  btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Recovering‚Ä¶';
  let t=toast('Deriving encryption key‚Ä¶','info',0);
  try{
    const fp=await deriveFilenPassword(matrixId);killToast(t);
    t=toast('Connecting to vault‚Ä¶','info',0);
    const ok=await tryLogin(email,fp);killToast(t);
    if(ok){S.matrixId=matrixId;S.filenPassword=fp;saveCreds(matrixId,email);switchToBrowser(matrixId);toast('Backup recovered ‚Äî all your files are here','success',6000);}
    else{toast('Could not connect ‚Äî check your Matrix ID and email','error',8000);}
  }catch(e){killToast(t);toast(e.message,'error',8000);}
  finally{btn.disabled=false;btn.textContent='Recover My Data';}
}

function saveCreds(m,e){try{localStorage.setItem('backup_creds',JSON.stringify({matrixId:m,email:e,ts:Date.now()}));}catch{}}
function loadCreds(){try{return JSON.parse(localStorage.getItem('backup_creds'));}catch{return null;}}
function clearCreds(){try{localStorage.removeItem('backup_creds');localStorage.removeItem('backup_seen');}catch{}}
function hasSeenRecovery(){try{return localStorage.getItem('backup_seen')==='1';}catch{return false;}}
function markRecoverySeen(){try{localStorage.setItem('backup_seen','1');}catch{}}

// ‚ïê‚ïê‚ïê POOL BRIDGE SETTINGS ‚ïê‚ïê‚ïê
function savePoolBridgeSettings(enabled,capacityGB){try{localStorage.setItem('backup_bridge',JSON.stringify({enabled,capacity_gb:capacityGB,enabled_at:enabled?new Date().toISOString():null,ts:Date.now()}));}catch{}}
function loadPoolBridgeSettings(){try{return JSON.parse(localStorage.getItem('backup_bridge'));}catch{return null;}}
function isBridgeDismissed(){try{return localStorage.getItem('backup_bridge_dismissed')==='1';}catch{return false;}}
function markBridgeDismissed(){try{localStorage.setItem('backup_bridge_dismissed','1');}catch{}}

function switchToBrowser(displayId){
  S.curDir=S.baseFolderUUID;S.pathStack=[{uuid:S.baseFolderUUID,name:'Backup'}];
  document.getElementById('setupView').classList.add('hidden');document.getElementById('browserView').classList.remove('hidden');
  document.getElementById('uName').textContent=displayId;
  document.getElementById('uAvatar').textContent=(displayId[0]==='@'?displayId[1]:displayId[0]).toUpperCase();
  loadDir(S.baseFolderUUID);
  setTimeout(()=>checkBridgeEligibility(),1000);
}
function doLogout(){
  S={apiKey:null,masterKeys:[],baseFolderUUID:null,email:null,matrixId:null,curDir:null,pathStack:[],filenPassword:null,canCreateLinks:false,maxStorage:0,usedStorage:0};
  curFiles=[];curFolders=[];clearCreds();
  document.getElementById('setupView').classList.remove('hidden');document.getElementById('browserView').classList.add('hidden');
  document.getElementById('autoBar').classList.add('hidden');
  document.getElementById('poolBridgeCard').classList.add('hidden');document.getElementById('poolBridgeStatus').classList.add('hidden');
  goStep(1);toast('Disconnected','success');
}

async function autoConnect(){
  const creds=loadCreds();if(!creds||!creds.matrixId||!creds.email)return;
  const bar=document.getElementById('autoBar');document.getElementById('autoBarId').textContent=creds.matrixId;bar.classList.remove('hidden');
  document.getElementById('inMatrixId').value=creds.matrixId;document.getElementById('inSetupEmail').value=creds.email;
  try{const fp=await deriveFilenPassword(creds.matrixId);const ok=await tryLogin(creds.email,fp);if(ok){S.matrixId=creds.matrixId;S.filenPassword=fp;bar.classList.add('hidden');switchToBrowser(creds.matrixId);return;}}catch{}
  bar.classList.add('hidden');toast('Auto-connect failed ‚Äî sign in manually','info');
}

// ‚ïê‚ïê‚ïê POOL BRIDGE LOGIC ‚ïê‚ïê‚ïê
function checkBridgeEligibility(){
  const card=document.getElementById('poolBridgeCard'),bar=document.getElementById('poolBridgeStatus');
  if(!S.canCreateLinks){card.classList.add('hidden');bar.classList.add('hidden');return;}
  const settings=loadPoolBridgeSettings();
  if(settings&&settings.enabled){card.classList.add('hidden');bar.classList.remove('hidden');updateBridgeStatus();return;}
  if(isBridgeDismissed()){card.classList.add('hidden');bar.classList.add('hidden');return;}
  const avail=S.maxStorage-S.usedStorage;
  document.getElementById('bridgeAvailable').textContent=fmtSize(avail);
  card.classList.remove('hidden');bar.classList.add('hidden');
}
function enableBridge(){
  const inp=document.getElementById('bridgeCapacityInput');
  const cap=Math.max(1,Math.min(100,parseInt(inp.value)||5));
  savePoolBridgeSettings(true,cap);
  document.getElementById('poolBridgeCard').classList.add('hidden');
  document.getElementById('poolBridgeStatus').classList.remove('hidden');
  updateBridgeStatus();
  toast('Pool Bridge enabled ‚Äî you\'re helping the network','success',6000);
  window.dispatchEvent(new CustomEvent('khora-bridge-ready',{detail:{capacity_gb:cap,maxStorage:S.maxStorage,usedStorage:S.usedStorage}}));
}
function dismissBridgeCard(){
  markBridgeDismissed();
  document.getElementById('poolBridgeCard').classList.add('hidden');
}
function disableBridge(){
  savePoolBridgeSettings(false,0);
  document.getElementById('poolBridgeStatus').classList.add('hidden');
  toast('Pool Bridge disabled','info');
  window.dispatchEvent(new CustomEvent('khora-bridge-stopped'));
}
function updateBridgeStatus(){
  const settings=loadPoolBridgeSettings();if(!settings||!settings.enabled)return;
  document.getElementById('bridgeStorageUsed').textContent=fmtSize(S.usedStorage);
}

// ‚ïê‚ïê‚ïê FILE BROWSER ‚ïê‚ïê‚ïê
async function loadDir(uuid){
  S.curDir=uuid;renderBread();const el=document.getElementById('fileList');
  el.innerHTML='<div class="empty"><div class="spinner lg" style="margin:0 auto 12px"></div><div style="font-size:12px">Decrypting‚Ä¶</div></div>';
  try{
    const r=await apiPost('/dir/content',{uuid});if(!r.status)throw new Error(r.message||'Load failed');
    curFolders=[];curFiles=[];
    for(const f of(r.data.folders||[])){if(f.uuid===uuid)continue;const n=await decMeta(f.name);curFolders.push({uuid:f.uuid,name:(typeof n==='object'?n.name:n)||'[Encrypted]',type:'dir',ts:f.timestamp});}
    for(const u of(r.data.uploads||[])){const m=await decMeta(u.metadata);curFiles.push({uuid:u.uuid,name:m?.name||'[Encrypted]',size:m?.size||u.size||0,mime:m?.mime||'',key:m?.key||'',type:'file',chunks:u.chunks,bucket:u.bucket,region:u.region,version:u.version||2,ts:u.timestamp});}
    renderList();
  }catch(e){el.innerHTML=`<div class="empty"><div class="big">‚ö†Ô∏è</div>${esc(e.message)}</div>`;}
}
async function refreshDir(){if(S.curDir)await loadDir(S.curDir);}
function navFolder(uuid,name){S.pathStack.push({uuid,name});loadDir(uuid);}
function navBread(idx){S.pathStack=S.pathStack.slice(0,idx+1);loadDir(S.pathStack[idx].uuid);}
function renderBread(){document.getElementById('breadcrumb').innerHTML=S.pathStack.map((p,i)=>`${i>0?'<span class="sep">/</span>':''}<span onclick="navBread(${i})">${esc(p.name)}</span>`).join('');}
function renderList(){
  const el=document.getElementById('fileList');
  const all=[...curFolders.sort((a,b)=>a.name.localeCompare(b.name)),...curFiles.sort((a,b)=>a.name.localeCompare(b.name))];
  if(!all.length){el.innerHTML='<div class="empty"><div class="big">üìÇ</div><div>Empty ‚Äî backed-up files will appear here</div></div>';return;}
  el.innerHTML=all.map(it=>{
    const d=it.type==='dir';const safeName=it.name.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    return`<div class="file-row"><div class="ficon">${d?'üìÅ':fIcon(it.name)}</div><div class="fname click" ondblclick="${d?`navFolder('${it.uuid}','${safeName}')`:`previewFile('${it.uuid}')`}">${esc(it.name)}</div><div class="fmeta">${d?'‚Äî':fmtSize(it.size)}</div><div class="factions">${!d?`<button class="btn-icon" onclick="previewFile('${it.uuid}')" title="Preview">üëÅ</button><button class="btn-icon" onclick="downloadFile('${it.uuid}')" title="Download">‚¨á</button>`:''}<button class="btn-icon" onclick="shareLink('${it.uuid}','${it.type}','${safeName}')" title="Share link">üîó</button><button class="btn-icon" onclick="renameItem('${it.uuid}','${it.type}','${safeName}')" title="Rename">‚úèÔ∏è</button><button class="btn-icon" onclick="trashItem('${it.uuid}','${it.type}','${safeName}')" title="Trash">üóë</button></div></div>`;
  }).join('');
}
function fIcon(n){const e=(n.split('.').pop()||'').toLowerCase();const m={pdf:'üìï',doc:'üìÑ',docx:'üìÑ',xls:'üìä',xlsx:'üìä',jpg:'üñº',jpeg:'üñº',png:'üñº',gif:'üñº',svg:'üñº',webp:'üñº',mp4:'üé¨',mov:'üé¨',webm:'üé¨',mp3:'üéµ',wav:'üéµ',flac:'üéµ',zip:'üì¶',tar:'üì¶',gz:'üì¶',rar:'üì¶',js:'üìú',ts:'üìú',py:'üìú',html:'üìú',css:'üìú',json:'üìú',md:'üìú',txt:'üìú',csv:'üìú'};return m[e]||'üìÑ';}
function findFile(uuid){return curFiles.find(f=>f.uuid===uuid);}

// ‚ïê‚ïê‚ïê DOWNLOAD / PREVIEW ‚ïê‚ïê‚ïê
async function downloadFileData(uuid){
  const f=findFile(uuid);if(!f)throw new Error('File not found');const parts=[];
  for(let i=0;i<f.chunks;i++){const host=pick(EGEST);const r=await fetch(`${host}/${f.region}/${f.bucket}/${f.uuid}/${i}`,{headers:{'Authorization':`Bearer ${S.apiKey}`}});if(!r.ok)throw new Error(`Chunk ${i}: HTTP ${r.status}`);parts.push(new Uint8Array(await decryptChunk(await r.arrayBuffer(),f.key)));}
  const total=parts.reduce((s,p)=>s+p.length,0);const out=new Uint8Array(total);let off=0;for(const p of parts){out.set(p,off);off+=p.length;}
  return{data:out,name:f.name,mime:f.mime};
}
async function downloadFile(uuid){
  const t=toast('Downloading‚Ä¶','info',0);
  try{const{data,name,mime}=await downloadFileData(uuid);const blob=new Blob([data],{type:mime||'application/octet-stream'});const u=URL.createObjectURL(blob);const a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u);killToast(t);toast('Downloaded','success');}
  catch(e){killToast(t);toast('Download failed: '+e.message,'error',6000);}
}
async function previewFile(uuid){
  const f=findFile(uuid);if(!f)return;const ext=(f.name.split('.').pop()||'').toLowerCase();
  const imgExts=['jpg','jpeg','png','gif','webp','svg','bmp'];const vidExts=['mp4','webm','mov'];const audExts=['mp3','wav','ogg','aac','flac'];
  const textExts=['txt','md','json','js','ts','jsx','tsx','css','html','xml','yaml','yml','toml','ini','sh','py','rb','go','rs','c','cpp','h','java','sql','lua','php','csv','log'];
  const previewable=[...imgExts,...vidExts,...audExts,'pdf',...textExts];
  if(!previewable.includes(ext)){downloadFile(uuid);return;}
  const t=toast('Decrypting‚Ä¶','info',0);
  try{const{data,name,mime}=await downloadFileData(uuid);killToast(t);const blob=new Blob([data],{type:mime||'application/octet-stream'});const url=URL.createObjectURL(blob);let content='';
    if(imgExts.includes(ext))content=`<img src="${url}" style="max-width:100%;max-height:70vh;border-radius:8px">`;
    else if(vidExts.includes(ext))content=`<video src="${url}" controls style="max-width:100%;max-height:70vh;border-radius:8px"></video>`;
    else if(audExts.includes(ext))content=`<audio src="${url}" controls style="width:100%"></audio>`;
    else if(ext==='pdf')content=`<iframe src="${url}" style="width:100%;height:70vh;border:none;border-radius:8px"></iframe>`;
    else{const txt=td.decode(data);content=`<pre style="max-height:70vh;overflow:auto;background:var(--bg);padding:14px;border-radius:8px;font-size:12px;font-family:'IBM Plex Mono',monospace;white-space:pre-wrap;word-break:break-all">${esc(txt)}</pre>`;}
    showModal(`üëÅ ${name}`,content,[`<button class="btn btn-ghost btn-sm" onclick="closeModal()">Close</button>`,`<button class="btn btn-primary btn-sm" onclick="downloadFile('${uuid}');closeModal()">‚¨á Download</button>`]);
  }catch(e){killToast(t);toast('Preview failed: '+e.message,'error',6000);}
}

// ‚ïê‚ïê‚ïê RENAME / TRASH ‚ïê‚ïê‚ïê
async function renameItem(uuid,type,oldName){
  const name=await showPrompt(`Rename "${oldName}" to:`,oldName);if(!name||name===oldName)return;const t=toast('Renaming‚Ä¶','info',0);
  try{const lk=S.masterKeys[S.masterKeys.length-1];const nh=await sha512(name.toLowerCase());
    if(type==='file'){const f=findFile(uuid);if(!f)throw new Error('Not found');const m=JSON.stringify({name,size:f.size,mime:f.mime,key:f.key,lastModified:Date.now()});const em=await metaEnc(m,lk);const en=await metaEnc(name,lk);const r=await apiPost('/file/rename',{uuid,metadataEncrypted:em,nameEncrypted:en,nameHashed:nh});if(!r.status)throw new Error(r.message||'Failed');}
    else{const em=await metaEnc({name},lk);const r=await apiPost('/dir/rename',{uuid,metadataEncrypted:em,nameHashed:nh});if(!r.status)throw new Error(r.message||'Failed');}
    killToast(t);toast(`Renamed to "${name}"`,'success');refreshDir();
  }catch(e){killToast(t);toast('Rename failed: '+e.message,'error',6000);}
}
async function trashItem(uuid,type,name){
  const ok=await showConfirm(`Move "${name}" to trash?`,'Trash');if(!ok)return;const t=toast('Trashing‚Ä¶','info',0);
  try{const r=await apiPost(type==='file'?'/file/trash':'/dir/trash',{uuid});if(!r.status)throw new Error(r.message||'Failed');killToast(t);toast(`"${name}" trashed`,'success');refreshDir();}
  catch(e){killToast(t);toast('Trash failed: '+e.message,'error',6000);}
}

// ‚ïê‚ïê‚ïê PUBLIC LINKS ‚ïê‚ïê‚ïê
async function shareLink(uuid,type,name){
  const t=toast('Checking link‚Ä¶','info',0);
  try{if(type==='file'){
    const status=await apiPost('/file/link/status',{uuid});killToast(t);
    if(status.status&&status.data&&status.data.enabled){const file=findFile(uuid);showLinkModal(name,`https://filen.io/f/${status.data.uuid}#${file?file.key:''}`,uuid,type,true,status.data.uuid);}
    else{const linkUUID=crypto.randomUUID();const t2=toast('Creating link‚Ä¶','info',0);const file=findFile(uuid);const r=await apiPost('/file/link/edit',{uuid:linkUUID,fileUUID:uuid,type:'enable',expiration:'never',password:'empty',passwordHashed:await sha512('empty'),salt:rHex(32),downloadBtn:true});killToast(t2);if(!r.status)throw new Error(r.message||'Failed');showLinkModal(name,`https://filen.io/f/${linkUUID}#${file?file.key:''}`,uuid,type,true,linkUUID);toast('Link created','success');}
  }else{
    const status=await apiPost('/dir/link/status',{uuid});killToast(t);
    if(status.status&&status.data&&status.data.enabled){showLinkModal(name,`https://filen.io/d/${status.data.uuid}#!${status.data.key||''}`,uuid,type,true,status.data.uuid);}
    else{const linkUUID=crypto.randomUUID(),linkKey=rHex(32);const t2=toast('Creating link‚Ä¶','info',0);const lk=S.masterKeys[S.masterKeys.length-1];const encMeta=await metaEnc({name},linkKey);const addR=await apiPost('/dir/link/add',{uuid,parent:'none',linkUUID,type:'folder',metadata:encMeta,key:await metaEnc(linkKey,lk),expiration:'never'});if(!addR.status){killToast(t2);throw new Error(addR.message||'Failed');}await apiPost('/dir/link/edit',{uuid:linkUUID,expiration:'never',password:'empty',passwordHashed:await sha512('empty'),salt:rHex(32),downloadBtn:true});killToast(t2);showLinkModal(name,`https://filen.io/d/${linkUUID}#!${linkKey}`,uuid,type,true,linkUUID);toast('Link created','success');}
  }}catch(e){killToast(t);toast('Link error: '+e.message,'error',6000);}
}
function showLinkModal(name,url,itemUUID,itemType,enabled,linkUUID){
  showModal(`üîó Share ‚Äî ${name}`,`<div class="link-status"><div class="${enabled?'live':'off'}"></div><span style="color:${enabled?'var(--green)':'var(--text-dim)'}">${enabled?'Active':'Disabled'}</span></div><div style="font-size:12px;color:var(--text-dim);margin-bottom:10px">Anyone with this link can download the ${itemType==='file'?'file':'folder'}:</div><div class="link-box"><div class="link-url" id="linkUrlBox" onclick="selectLinkUrl()">${esc(url)}</div><button class="btn btn-primary btn-sm" onclick="copyLink()" style="flex-shrink:0">üìã Copy</button></div><div style="margin-top:16px;display:flex;gap:8px"><button class="btn btn-ghost btn-sm" onclick="window.open('${url}','_blank')">‚Üó Open</button><button class="btn btn-ghost btn-sm" style="color:var(--red);border-color:rgba(240,96,96,.3)" onclick="disableLink('${linkUUID}','${itemType}','${esc(name)}')">Disable</button></div>`,[]);
}
function selectLinkUrl(){const el=document.getElementById('linkUrlBox');if(el){const r=document.createRange();r.selectNodeContents(el);const s=window.getSelection();s.removeAllRanges();s.addRange(r);}}
async function copyLink(){const el=document.getElementById('linkUrlBox');if(!el)return;try{await navigator.clipboard.writeText(el.textContent);el.classList.add('link-copied');el.textContent='‚úì Copied!';setTimeout(()=>el.classList.remove('link-copied'),2000);toast('Copied','success',2000);}catch{selectLinkUrl();toast('Select and copy manually','info',3000);}}
async function disableLink(linkUUID,type,name){
  const ok=await showConfirm(`Disable link for "${name}"?`,'Disable');if(!ok)return;const t=toast('Disabling‚Ä¶','info',0);
  try{if(type==='file')await apiPost('/file/link/edit',{uuid:linkUUID,fileUUID:'',type:'disable',expiration:'never',password:'empty',passwordHashed:await sha512('empty'),salt:rHex(32),downloadBtn:true});else await apiPost('/dir/link/remove',{uuid:linkUUID});killToast(t);closeModal();toast('Link disabled','success');}
  catch(e){killToast(t);toast('Failed: '+e.message,'error',6000);}
}

// ‚ïê‚ïê‚ïê FOLDER / UPLOAD ‚ïê‚ïê‚ïê
async function promptNewFolder(){
  const name=await showPrompt('New folder name','Untitled');if(!name)return;const t=toast('Creating‚Ä¶','info',0);
  try{const lk=S.masterKeys[S.masterKeys.length-1];const uuid=crypto.randomUUID();const en=await metaEnc({name},lk);const nh=await sha512(name.toLowerCase());const r=await apiPost('/dir/create',{uuid,name:en,nameHashed:nh,parent:S.curDir});if(!r.status)throw new Error(r.message||'Failed');killToast(t);toast(`Created "${name}"`,'success');refreshDir();}catch(e){killToast(t);toast('Failed: '+e.message,'error',6000);}
}
const dz=document.getElementById('dropZone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');handleUpload(e.dataTransfer.files);});

async function handleUpload(files){
  if(!files||!files.length)return;const pw=document.getElementById('progressWrap'),pf=document.getElementById('progressFill');
  pw.classList.remove('hidden');pf.style.width='0%';let done=0;
  for(const f of files){try{toast(`Encrypting ${f.name}‚Ä¶`,'info',3000);await uploadFile(f,p=>{pf.style.width=`${((done+p)/files.length)*100}%`;});done++;pf.style.width=`${(done/files.length)*100}%`;}catch(e){toast(`Failed: ${f.name} ‚Äî ${e.message}`,'error',8000);pw.classList.add('hidden');document.getElementById('fileIn').value='';return;}}
  toast(`Backed up ${files.length} file${files.length>1?'s':''}`,'success');
  setTimeout(()=>pw.classList.add('hidden'),2000);refreshDir();document.getElementById('fileIn').value='';
}

async function uploadFile(file,onProg){
  const uuid=crypto.randomUUID(),fileKey=rHex(32),uploadKey=rHex(32);const total=Math.max(1,Math.ceil(file.size/CHUNK));let bucket=null,region=null;
  for(let i=0;i<total;i++){const raw=new Uint8Array(await file.slice(i*CHUNK,Math.min((i+1)*CHUNK,file.size)).arrayBuffer());const enc=await encryptChunk(raw,fileKey);const hashHex=hex(await crypto.subtle.digest('SHA-512',enc));const host=pick(INGEST);const r=await(await fetch(`${host}/v3/upload?uuid=${uuid}&index=${i}&uploadKey=${uploadKey}&parent=${S.curDir}&hash=${hashHex}`,{method:'POST',headers:{'Authorization':`Bearer ${S.apiKey}`},body:enc})).json();if(!r.status)throw new Error(r.message||`Chunk ${i} failed`);if(i===0){bucket=r.data.bucket;region=r.data.region;}onProg((i+1)/total);}
  const lk=S.masterKeys[S.masterKeys.length-1];const meta=JSON.stringify({name:file.name,size:file.size,mime:file.type||'application/octet-stream',key:fileKey,lastModified:file.lastModified||Date.now()});
  const em=await metaEnc(meta,lk),nh=await sha512(file.name.toLowerCase());
  const dr=await apiPost('/upload/done',{uuid,name:em,nameHashed:nh,size:String(file.size),chunks:total,mime:em,rm:rHex(32),metadata:em,version:2,uploadKey});
  if(!dr.status)throw new Error(dr.message||'Finalize failed');
  return{uuid,fileKey,bucket,region,chunks:total};
}

// ‚ïê‚ïê‚ïê PROGRAMMATIC API ‚Äî for parent Matrix app ‚ïê‚ïê‚ïê

// Ensure a subfolder exists, return its UUID
async function ensureFolder(name,parent){
  parent=parent||S.baseFolderUUID;const nh=await sha512(name.toLowerCase());
  const exists=await apiPost('/dir/exists',{parent,nameHashed:nh});
  if(exists.status&&exists.data?.exists&&exists.data?.uuid)return exists.data.uuid;
  const uuid=crypto.randomUUID();const lk=S.masterKeys[S.masterKeys.length-1];
  const en=await metaEnc({name},lk);await apiPost('/dir/create',{uuid,name:en,nameHashed:nh,parent});return uuid;
}

// Upload + get public link
window.backupUploadAndLink=async function(file,folder){
  if(!S.apiKey)throw new Error('Not connected');const origDir=S.curDir;
  if(folder)S.curDir=await ensureFolder(folder);
  try{const info=await uploadFile(file,()=>{});const linkUUID=crypto.randomUUID();const r=await apiPost('/file/link/edit',{uuid:linkUUID,fileUUID:info.uuid,type:'enable',expiration:'never',password:'empty',passwordHashed:await sha512('empty'),salt:rHex(32),downloadBtn:true});if(!r.status)throw new Error(r.message||'Link failed');return`https://filen.io/f/${linkUUID}#${info.fileKey}`;}finally{S.curDir=origDir;}
};

// Silent backup (no public link)
window.backupUpload=async function(file,folder){
  if(!S.apiKey)throw new Error('Not connected');const origDir=S.curDir;
  if(folder)S.curDir=await ensureFolder(folder);
  try{return await uploadFile(file,()=>{});}finally{S.curDir=origDir;}
};

// Backup raw JSON data
window.backupJSON=async function(data,filename,folder){
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  return window.backupUpload(new File([blob],filename||`backup-${Date.now()}.json`,{type:'application/json'}),folder);
};

// State checks
window.backupIsConnected=()=>!!S.apiKey;
window.backupGetIdentity=()=>S.matrixId||loadCreds()?.matrixId||null;

// Programmatic connect (parent app provides Matrix ID + email)
window.backupConnect=async function(matrixId,email){
  const fp=await deriveFilenPassword(matrixId);
  const ok=await tryLogin(email,fp);
  if(ok){S.matrixId=matrixId;S.filenPassword=fp;saveCreds(matrixId,email);return true;}
  const reg=await tryRegister(email,fp);
  if(reg==='registered'||reg==='exists_unconfirmed')return'needs_confirmation';
  throw new Error(reg);
};

// ‚ïê‚ïê‚ïê POOL BRIDGE API ‚ïê‚ïê‚ïê
window.backupCanBridge=()=>!!S.canCreateLinks;
window.backupGetCapacity=()=>({total:S.maxStorage||0,used:S.usedStorage||0,available:Math.max(0,(S.maxStorage||0)-(S.usedStorage||0))});

window.backupDeleteFile=async function(folder,filename){
  if(!S.apiKey)throw new Error('Not connected');
  const folderUUID=folder?await ensureFolder(folder):S.baseFolderUUID;
  const r=await apiPost('/dir/content',{uuid:folderUUID});
  if(!r.status)throw new Error(r.message||'Folder not found');
  for(const u of(r.data.uploads||[])){const m=await decMeta(u.metadata);if(m&&m.name===filename){const tr=await apiPost('/file/trash',{uuid:u.uuid});if(!tr.status)throw new Error(tr.message||'Trash failed');return true;}}
  return false;
};

window.backupUploadBufferAndLink=async function(buffer,filename,folder){
  if(!S.apiKey)throw new Error('Not connected');
  const file=new File([buffer],filename,{type:'application/octet-stream',lastModified:Date.now()});
  return window.backupUploadAndLink(file,folder);
};

window.backupBridgeSettings=()=>loadPoolBridgeSettings();
window.backupEnableBridge=function(capacityGB){
  if(!S.canCreateLinks)throw new Error('Account does not support public links');
  const cap=Math.max(1,Math.min(100,capacityGB||5));
  savePoolBridgeSettings(true,cap);checkBridgeEligibility();
  window.dispatchEvent(new CustomEvent('khora-bridge-ready',{detail:{capacity_gb:cap,maxStorage:S.maxStorage,usedStorage:S.usedStorage}}));
};
window.backupDisableBridge=function(){
  savePoolBridgeSettings(false,0);checkBridgeEligibility();
  window.dispatchEvent(new CustomEvent('khora-bridge-stopped'));
};

// Key handlers
document.getElementById('inMatrixId').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('inSetupEmail').focus();});
document.getElementById('inSetupEmail').addEventListener('keydown',e=>{if(e.key==='Enter')startSetup();});
document.getElementById('inRecoverMatrixId').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('inRecoverEmail').focus();});
document.getElementById('inRecoverEmail').addEventListener('keydown',e=>{if(e.key==='Enter')doRecover();});

autoConnect();
</script>
</body>
</html>
