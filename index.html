<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Khora — Sovereign Case Management</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<!-- Resource hints: early DNS + connection setup for CDN origins -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://esm.sh" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<link rel="dns-prefetch" href="https://unpkg.com">
<link rel="dns-prefetch" href="https://esm.sh">
<!-- Preload heaviest scripts so download starts immediately -->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/matrix-js-sdk@34.11.1/lib/browser-matrix.min.js" as="script">
<!-- Core scripts (synchronous — needed before Babel processes JSX) -->
<script src="https://cdn.jsdelivr.net/npm/matrix-js-sdk@34.11.1/lib/browser-matrix.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Non-critical: username generator loaded as module (non-blocking) -->
<script type="module">
import { uniqueNamesGenerator, adjectives, animals } from 'https://esm.sh/unique-names-generator@4.7.1';
window.generateUsername = () => {
  const base = uniqueNamesGenerator({ dictionaries: [adjectives, animals], separator: '-', length: 2, style: 'lowerCase' });
  const num = Math.floor(Math.random() * 9000) + 1000;
  return base + '-' + num;
};
window._nameGenReady = true;
</script>
<!-- Lazy-loaded: in-browser embeddings for field definition fuzzy matching (non-blocking) -->
<script type="module">
try {
  const { pipeline, env } = await import('https://cdn.jsdelivr.net/npm/@huggingface/transformers@3');
  env.allowLocalModels = false;
  window.__hfPipeline = null;
  window.__hfReady = false;
  window.initEmbeddings = async () => {
    if (window.__hfReady) return window.__hfPipeline;
    try {
      window.__hfPipeline = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
      window.__hfReady = true;
      return window.__hfPipeline;
    } catch (e) { console.debug('Embeddings model load skipped:', e.message); return null; }
  };
} catch (e) { console.debug('transformers.js not available:', e.message); }
</script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500&family=Source+Serif+4:wght@300;400;500;600;700&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-0:#08090b;--bg-1:#0e1015;--bg-2:#141720;--bg-3:#1a1e29;--bg-4:#222735;
  --border-0:#1e2230;--border-1:#2a3040;--border-2:#353d50;
  --tx-0:#e6e9f0;--tx-1:#a0a8b8;--tx-2:#6b7385;--tx-3:#454d5f;
  --safe-b:env(safe-area-inset-bottom,0px);--safe-t:env(safe-area-inset-top,0px);
  --gold:#c9a352;--gold-dim:rgba(201,163,82,0.10);--gold-mid:rgba(201,163,82,0.22);
  --green:#3dd68c;--green-dim:rgba(61,214,140,0.10);
  --red:#e85d5d;--red-dim:rgba(232,93,93,0.10);
  --blue:#5b9cf5;--blue-dim:rgba(91,156,245,0.10);
  --teal:#3ec9b0;--teal-dim:rgba(62,201,176,0.10);
  --orange:#e0943a;--orange-dim:rgba(224,148,58,0.10);
  --purple:#a78bfa;--purple-dim:rgba(167,139,250,0.10);
  --serif:'Source Serif 4',Georgia,serif;--sans:'Manrope',system-ui,sans-serif;--mono:'IBM Plex Mono',monospace;
  --r:5px;--r-lg:8px;
}
/* ═══ Light theme — WCAG AA accessible (4.5:1+ text contrast) ═══ */
html.light {
  --bg-0:#f5f5f7;--bg-1:#ebedf0;--bg-2:#e0e2e7;--bg-3:#d4d7dd;--bg-4:#c8ccd4;
  --border-0:#cdd0d7;--border-1:#b8bcc6;--border-2:#a0a5b2;
  --tx-0:#1a1c20;--tx-1:#3d4250;--tx-2:#5a6073;--tx-3:#7e8498;
  --gold:#8a6d1e;--gold-dim:rgba(138,109,30,0.10);--gold-mid:rgba(138,109,30,0.18);
  --green:#177a4a;--green-dim:rgba(23,122,74,0.10);
  --red:#c03030;--red-dim:rgba(192,48,48,0.10);
  --blue:#2563b0;--blue-dim:rgba(37,99,176,0.10);
  --teal:#137a6a;--teal-dim:rgba(19,122,106,0.10);
  --orange:#a0600a;--orange-dim:rgba(160,96,10,0.10);
  --purple:#6938c0;--purple-dim:rgba(105,56,192,0.10);
}
html.light .b-pri:hover{box-shadow:0 4px 16px rgba(138,109,30,0.18)}
html.light .b-red{border-color:rgba(192,48,48,.22)}
html.light .b-grn{border-color:rgba(23,122,74,.22)}
html.light .toggle-knob{box-shadow:0 1px 3px rgba(0,0,0,.15);border:1px solid var(--border-1)}
html.light ::-webkit-scrollbar-thumb{background:var(--border-2)}
html.light .grid-bg{background-image:radial-gradient(circle at 20% 20%,rgba(138,109,30,.05) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(37,99,176,.04) 0%,transparent 50%),linear-gradient(var(--border-0) 1px,transparent 1px),linear-gradient(90deg,var(--border-0) 1px,transparent 1px);}
html.light .gm-crossing{background:linear-gradient(135deg,rgba(19,122,106,.10) 0%,rgba(138,109,30,.10) 100%);border-left-color:rgba(19,122,106,.25);border-right-color:rgba(138,109,30,.25)}
html.light .gm-crossing::before{background:repeating-linear-gradient(180deg,transparent,transparent 8px,rgba(138,109,30,.06) 8px,rgba(138,109,30,.06) 16px)}
html.light .gm-divergence{background:rgba(138,109,30,.08)}
html.light .gm-obs-field{background:var(--teal-dim);border-color:rgba(19,122,106,.20)}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;background:var(--bg-0);color:var(--tx-0);font-family:var(--sans);}
#root{height:calc(100% - 32px);background:var(--bg-0);color:var(--tx-0);font-family:var(--sans);}
.beta-banner{position:fixed;top:0;left:0;right:0;z-index:10000;height:32px;display:flex;align-items:center;justify-content:center;gap:6px;background:var(--gold-mid);border-bottom:1px solid var(--gold);font-family:var(--sans);font-size:12px;font-weight:600;color:var(--gold);letter-spacing:.01em;}
html.light .beta-banner{background:rgba(138,109,30,0.12);color:var(--gold);border-bottom-color:rgba(138,109,30,0.3);}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border-1);border-radius:3px;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideR{from{opacity:0;transform:translateX(-14px)}to{opacity:1;transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.anim-up{animation:fadeUp .3s ease both}.anim-in{animation:fadeIn .25s ease both}.anim-sl{animation:slideR .28s ease both}
input,textarea,select{font-family:var(--sans);background:var(--bg-1);border:1px solid var(--border-1);color:var(--tx-0);padding:11px 15px;border-radius:var(--r);font-size:14.5px;outline:none;transition:border .2s,box-shadow .2s;width:100%;}
input:focus,textarea:focus,select:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-dim)}
input::placeholder,textarea::placeholder{color:var(--tx-3)}textarea{resize:vertical;min-height:72px;line-height:1.55}
button{font-family:var(--sans);cursor:pointer;border:none;border-radius:var(--r);font-size:13.5px;font-weight:600;padding:9px 18px;transition:all .18s;letter-spacing:.01em;}
.b-pri{background:var(--gold);color:var(--bg-0)}.b-pri:hover{filter:brightness(1.12);transform:translateY(-1px);box-shadow:0 4px 16px var(--gold-dim)}.b-pri:disabled{opacity:.5;transform:none;cursor:default;filter:none}
.b-gho{background:transparent;color:var(--tx-1);border:1px solid var(--border-1)}.b-gho:hover{background:var(--bg-3);color:var(--tx-0);border-color:var(--border-2)}
.b-red{background:var(--red-dim);color:var(--red);border:1px solid rgba(232,93,93,.18)}.b-red:hover{background:rgba(232,93,93,.18)}
.b-grn{background:var(--green-dim);color:var(--green);border:1px solid rgba(61,214,140,.18)}
.b-sm{padding:7px 14px;font-size:12.5px}.b-xs{padding:5px 10px;font-size:12px}
.tag{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;font-size:12px;font-weight:600;font-family:var(--mono);letter-spacing:.03em}
.tag-gold{background:var(--gold-dim);color:var(--gold)}.tag-green{background:var(--green-dim);color:var(--green)}
.tag-red{background:var(--red-dim);color:var(--red)}.tag-blue{background:var(--blue-dim);color:var(--blue)}
.tag-teal{background:var(--teal-dim);color:var(--teal)}.tag-orange{background:var(--orange-dim);color:var(--orange)}
.tag-purple{background:var(--purple-dim);color:var(--purple)}
.card{background:var(--bg-2);border:1px solid var(--border-0);border-radius:var(--r-lg);padding:20px}
.card-h{background:var(--bg-2);border:1px solid var(--border-0);border-radius:var(--r-lg);padding:20px;transition:border-color .2s,transform .2s;cursor:pointer}
.card-h:hover{border-color:var(--gold);transform:translateY(-2px)}
.section-label{font-size:12px;font-family:var(--mono);color:var(--tx-1);letter-spacing:.07em;font-weight:500;margin-bottom:12px;display:block}
.app-sidebar .section-label{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.toggle-track{width:38px;height:20px;border-radius:10px;position:relative;cursor:pointer;transition:background .2s}
.toggle-track.on{background:var(--green)}.toggle-track.off{background:var(--border-1)}
.toggle-knob{width:16px;height:16px;border-radius:50%;background:#fff;position:absolute;top:2px;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.toggle-track.on .toggle-knob{left:20px}.toggle-track.off .toggle-knob{left:2px}
.grid-bg{background-image:radial-gradient(circle at 20% 20%,rgba(201,163,82,.03) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(91,156,245,.02) 0%,transparent 50%),linear-gradient(var(--border-0) 1px,transparent 1px),linear-gradient(90deg,var(--border-0) 1px,transparent 1px);background-size:100% 100%,100% 100%,48px 48px,48px 48px;}
.tabs{display:flex;gap:2px;background:var(--bg-1);border-radius:var(--r);padding:3px;margin-bottom:20px}
.tab{padding:9px 18px;border-radius:var(--r);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;color:var(--tx-1);background:transparent}
.tab.active{background:var(--bg-3);color:var(--tx-0);font-weight:600}
.tab:hover:not(.active){background:var(--bg-2);color:var(--tx-1)}

/* ═══ Inbox Responsive Styles ═══ */
.inbox-wrap{margin:0 auto;width:100%}
.inbox-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;gap:12px}
.inbox-panel{display:flex;gap:0;border:1px solid var(--border-0);border-radius:var(--r-lg);overflow:hidden;background:var(--bg-1);height:calc(100vh - 200px);min-height:520px;max-height:900px}
.inbox-list{width:300px;min-width:300px;border-right:1px solid var(--border-0);display:flex;flex-direction:column;background:var(--bg-2)}
.inbox-chat{flex:1;display:flex;flex-direction:column;background:var(--bg-1);min-width:0}
.inbox-msgs{flex:1;overflow:auto;padding:20px 24px;display:flex;flex-direction:column;gap:2px}
.inbox-compose{padding:14px 20px;border-top:1px solid var(--border-0);background:var(--bg-2)}
.inbox-chat-hdr{padding:16px 20px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;gap:12px;background:var(--bg-2)}

@media(max-width:1100px){
  .inbox-list{width:260px;min-width:260px}
}
@media(max-width:900px){
  .inbox-header{flex-direction:column;gap:8px}
  .inbox-panel{flex-direction:column;height:auto;max-height:none}
  .inbox-list{width:100%;min-width:100%;border-right:none;border-bottom:1px solid var(--border-0);max-height:260px}
  .inbox-chat{min-height:420px}
  .inbox-msgs{padding:14px 16px}
  .inbox-compose{padding:12px 14px}
  .inbox-chat-hdr{padding:12px 14px}
}
/* ═══ Mobile Bottom Nav ═══ */
.mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:900;background:var(--bg-1);border-top:1px solid var(--border-0);padding:4px 0 calc(4px + var(--safe-b));-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px)}
.mobile-bottom-nav-items{display:flex;justify-content:space-around;align-items:center}
.mobile-bottom-nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;min-width:56px;min-height:44px;border:none;background:transparent;color:var(--tx-2);font-size:10px;font-family:var(--sans);cursor:pointer;transition:color .15s;justify-content:center;-webkit-tap-highlight-color:transparent}
.mobile-bottom-nav-item.active{color:var(--gold)}
.mobile-bottom-nav-item .nav-badge{position:absolute;top:2px;right:2px;font-size:8px;min-width:14px;height:14px;padding:0 3px}

/* ═══ Mobile FAB ═══ */
.mobile-fab{display:none;position:fixed;bottom:calc(68px + var(--safe-b));right:16px;z-index:950;width:56px;height:56px;border-radius:50%;background:var(--gold);color:var(--bg-0);border:none;box-shadow:0 4px 16px rgba(0,0,0,.3);cursor:pointer;align-items:center;justify-content:center;transition:transform .2s,box-shadow .2s;-webkit-tap-highlight-color:transparent}
.mobile-fab:active{transform:scale(.92)}
.mobile-fab svg{pointer-events:none}

/* ═══ Mobile More Drawer ═══ */
.mobile-more-overlay{position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.5);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}
.mobile-more-drawer{position:fixed;bottom:0;left:0;right:0;z-index:1000;background:var(--bg-1);border-top-left-radius:16px;border-top-right-radius:16px;padding:8px 16px calc(70px + var(--safe-b)) 16px;box-shadow:0 -8px 32px rgba(0,0,0,.3);max-height:70vh;overflow:auto;animation:slideUp .25s ease both}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mobile-more-handle{width:36px;height:4px;border-radius:2px;background:var(--border-2);margin:0 auto 12px}
.mobile-more-item{display:flex;align-items:center;gap:12px;padding:14px 8px;min-height:44px;border-bottom:1px solid var(--border-0);font-size:14px;color:var(--tx-0);cursor:pointer;-webkit-tap-highlight-color:transparent}
.mobile-more-item:last-child{border-bottom:none}
.mobile-more-item:active{background:var(--bg-3)}

/* ═══ Mobile Note Sheet ═══ */
.note-sheet-mobile{position:fixed;inset:0;z-index:1100;background:var(--bg-0);display:flex;flex-direction:column;padding-top:var(--safe-t);animation:fadeUp .25s ease both}
.note-sheet-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border-0);background:var(--bg-1);flex-shrink:0}
.note-sheet-header button{min-height:44px}
.note-sheet-body{flex:1;overflow:auto;padding:16px;-webkit-overflow-scrolling:touch}
.note-sheet-body textarea{min-height:40vh;font-size:16px!important;border:none;background:transparent;padding:8px 0;resize:none}
.note-sheet-body textarea:focus{box-shadow:none;border-color:transparent}
.note-sheet-body input[type="text"]{font-size:16px!important}
.note-sheet-body .note-sheet-title{font-size:20px!important;font-weight:700;border:none;background:transparent;padding:8px 0;font-family:var(--serif)}
.note-sheet-body .note-sheet-title:focus{box-shadow:none;border-color:transparent}
.note-sheet-body .note-sheet-title::placeholder{color:var(--tx-3);font-weight:700}
.note-sheet-expand-toggle{display:flex;align-items:center;gap:6px;padding:12px 0;color:var(--tx-2);font-size:13px;cursor:pointer;border:none;background:none;font-family:var(--sans);-webkit-tap-highlight-color:transparent}
.note-sheet-expand{padding:12px 0;border-top:1px solid var(--border-0);margin-top:4px}

/* ═══ Responsive: tablet sidebar + EO vocab grid ═══ */
@media(max-width:1100px){
  .app-sidebar{width:220px!important;min-width:220px!important}
}
@media(max-width:900px){
  .app-sidebar{width:200px!important;min-width:200px!important}
  .eo-vocab-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))!important}
}
@media(max-width:700px){
  .app-sidebar{display:none!important}
  .app-main{padding:14px!important;padding-bottom:calc(70px + var(--safe-b))!important}
  .mobile-bottom-nav{display:block}
  .mobile-fab{display:flex}
  .inbox-list{max-height:200px}
  /* Touch targets */
  button,.tab,.profile-tab,.dt-panel-tab{min-height:44px}
  /* Prevent iOS zoom */
  input,textarea,select{font-size:16px!important}
  /* Profile tabs: horizontal scroll */
  .profile-tabs{overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap;scrollbar-width:none}
  .profile-tabs::-webkit-scrollbar{display:none}
  .profile-tab{white-space:nowrap;flex-shrink:0}
  /* Tabs: horizontal scroll */
  .tabs{overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap;scrollbar-width:none}
  .tabs::-webkit-scrollbar{display:none}
  .tab{white-space:nowrap;flex-shrink:0}
  /* Profile grid: single column */
  .profile-fields-grid{grid-template-columns:1fr}
  /* Dashboard stats: 2 columns */
  .pd-grid{grid-template-columns:repeat(2,1fr)}
  /* Page headers: stack vertically */
  .profile-header{flex-direction:column}
  /* Inbox */
  .inbox-panel{min-height:auto}
  .inbox-chat{min-height:300px}
  /* Note cards: more padding, bigger text */
  .note-card{padding:16px}
  .note-title{font-size:15px}
  .note-body{font-size:13.5px;-webkit-line-clamp:2}
  /* GIVEN/MEANT viz: stack */
  .gm-container{flex-direction:column}
  .gm-given{flex:none;min-width:auto}
  .gm-crossing{min-width:auto;min-height:40px}
  .gm-meant{flex:none}
  /* Data table: horizontal scroll with smaller cells */
  .dt-scroll{-webkit-overflow-scrolling:touch}
  table.dt th,table.dt td{padding:8px 10px;font-size:12px}
  /* Side panel: full width on mobile */
  .dt-panel{width:100%!important;min-width:100%!important}
  .dt-panel-overlay{display:block}
  /* Case view: remove max-width constraint */
  .profile-page{max-width:100%}
  /* Header flex-wrap for case/profile pages */
  .profile-badges{flex-wrap:wrap}
  /* Schema sidebar: overlay on mobile */
  .schema-sidebar{position:fixed!important;left:0!important;top:0!important;bottom:0!important;z-index:800!important;width:280px!important;box-shadow:4px 0 16px rgba(0,0,0,.3)!important}
}
@media(max-width:480px){
  .pd-grid{grid-template-columns:1fr}
  .inbox-header h2{font-size:18px}
  .note-sheet-body textarea{min-height:50vh}
  .eo-vocab-grid{grid-template-columns:1fr!important}
}

/* ═══ GIVEN/MEANT Divide Visualization ═══ */
@keyframes crossingPulse{0%,100%{opacity:.6}50%{opacity:1}}
@keyframes flowRight{from{background-position:0 0}to{background-position:20px 0}}
.gm-container{display:flex;gap:0;border-radius:var(--r-lg);overflow:hidden;border:1px solid var(--border-0);background:var(--bg-1);min-height:200px}
.gm-given{flex:0 0 340px;min-width:280px;background:var(--bg-2);padding:20px;border-right:none;position:relative}
.gm-given::after{content:'';position:absolute;top:0;right:0;bottom:0;width:2px;background:var(--teal);opacity:.3}
.gm-crossing{flex:0 0 56px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
  background:linear-gradient(135deg,rgba(62,201,176,.08) 0%,rgba(201,163,82,.08) 100%);
  border-left:1px solid rgba(62,201,176,.2);border-right:1px solid rgba(201,163,82,.2);position:relative;padding:12px 4px}
.gm-crossing::before{content:'';position:absolute;top:0;bottom:0;left:0;right:0;
  background:repeating-linear-gradient(180deg,transparent,transparent 8px,rgba(201,163,82,.04) 8px,rgba(201,163,82,.04) 16px);pointer-events:none}
.gm-crossing-arrow{width:24px;height:24px;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,var(--teal),var(--gold));border-radius:50%;color:var(--bg-0);font-size:11px;font-weight:800;flex-shrink:0}
.gm-crossing-label{writing-mode:vertical-rl;text-orientation:mixed;font-family:var(--mono);font-size:10px;
  font-weight:600;letter-spacing:.1em;background:linear-gradient(180deg,var(--teal),var(--gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.gm-crossing-op{padding:3px 6px;border-radius:8px;font-size:10px;font-family:var(--mono);font-weight:700;
  background:var(--bg-3);color:var(--tx-1);border:1px solid var(--border-1);flex-shrink:0}
.gm-meant{flex:1;min-width:0;background:var(--bg-1);padding:20px;display:flex;flex-direction:column;gap:10px;position:relative}
.gm-meant::before{content:'';position:absolute;top:0;left:0;bottom:0;width:2px;background:var(--gold);opacity:.3}
.gm-fw-card{border:1px solid var(--border-1);border-radius:var(--r);padding:14px;background:var(--bg-2);
  transition:border-color .2s,transform .15s;position:relative;overflow:hidden}
.gm-fw-card:hover{border-color:var(--gold);transform:translateX(2px)}
.gm-fw-card::before{content:'';position:absolute;top:0;left:0;bottom:0;width:3px}
.gm-fw-card[data-accent="blue"]::before{background:var(--blue)}
.gm-fw-card[data-accent="teal"]::before{background:var(--teal)}
.gm-fw-card[data-accent="orange"]::before{background:var(--orange)}
.gm-fw-card[data-accent="green"]::before{background:var(--green)}
.gm-fw-card[data-accent="purple"]::before{background:var(--purple)}
.gm-divergence{background:rgba(201,163,82,.06);border:1px dashed var(--gold);border-radius:var(--r);padding:10px 14px;
  display:flex;align-items:flex-start;gap:10px;font-size:13px;color:var(--tx-1)}
.gm-obs-field{font-family:var(--mono);font-size:14px;font-weight:500;color:var(--teal);padding:10px 14px;
  background:var(--teal-dim);border:1px solid rgba(62,201,176,.15);border-radius:var(--r)}
.gm-obs-value{font-size:16px;font-weight:600;color:var(--tx-0);margin:10px 0}
.gm-meta-row{display:flex;gap:14px;font-size:12px;color:var(--tx-1);font-family:var(--mono)}
.gm-eo-trace{font-family:var(--mono);font-size:11px;color:var(--purple);padding:5px 10px;background:var(--purple-dim);
  border-radius:var(--r);display:inline-block;margin-top:8px}
.gm-chain{display:flex;gap:3px;align-items:center;flex-wrap:wrap;margin-top:6px}
.gm-chain-step{padding:2px 7px;border-radius:6px;font-size:10px;font-family:var(--mono);font-weight:600}
.gm-wb-left{flex:0 0 340px;min-width:280px;overflow:auto;border-right:1px solid var(--border-0);padding:16px}
.gm-wb-right{flex:1;min-width:0;overflow:auto;padding:16px}
.gm-wb-field{padding:10px 12px;border-radius:var(--r);cursor:pointer;border:1px solid var(--border-0);
  margin-bottom:4px;transition:all .15s}
.gm-wb-field:hover{border-color:var(--teal);background:var(--teal-dim)}
.gm-wb-field.active{border-color:var(--teal);background:var(--teal-dim);border-left:3px solid var(--teal)}
.gm-wb-empty{padding:40px 20px;text-align:center;border:1px dashed var(--border-1);border-radius:var(--r);color:var(--tx-3)}
.gm-sankey-line{position:absolute;pointer-events:none}
.gm-sup-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:10px;
  font-size:11px;font-family:var(--mono);font-weight:600;background:var(--gold-dim);color:var(--gold);border:1px solid rgba(201,163,82,.2)}

/* ═══ Form Builder / Schema Builder UX ═══ */
/* fb-canvas, fb-header, fb-header-title, fb-header-meta removed — now inline */
/* ── Progress Steps ── */
.fb-progress{display:flex;align-items:center;gap:4px;justify-content:center;padding:6px 0}
.fb-step{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;transition:all .2s}
.fb-step.active{background:var(--teal-dim)}
.fb-step-num{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;background:var(--border-1);color:var(--tx-3);transition:all .2s}
.fb-step.active .fb-step-num{background:var(--teal);color:var(--bg-0)}
.fb-step-label{font-size:12px;font-weight:500;color:var(--tx-3);transition:color .2s}
.fb-step.active .fb-step-label{color:var(--teal)}
.fb-step-line{width:28px;height:1px;background:var(--border-1);margin:0 4px}

/* ── Mode Toggle (pill style) ── */
.fb-mode-toggle{display:flex;gap:6px;align-items:center}
.fb-mode-btn{padding:6px 14px;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;
  color:var(--tx-2);background:var(--bg-1);border:1px solid var(--border-0);font-family:inherit;display:flex;align-items:center;gap:6px;text-transform:capitalize}
.fb-mode-btn.active{background:var(--teal-dim);color:var(--teal);border-color:var(--teal);font-weight:600}
.fb-mode-btn:hover:not(.active){border-color:var(--border-2);color:var(--tx-1)}

/* ── Sidebar Mode Toggle ── */
.sidebar-mode-toggle{display:flex;gap:4px;padding:8px 14px;border-bottom:1px solid var(--border-0)}
.sidebar-mode-toggle button{flex:1}

/* ── Team Context Selector ── */
.team-ctx-wrap{padding:8px 14px;border-bottom:1px solid var(--border-0)}
.team-ctx-pills{display:flex;flex-wrap:wrap;gap:4px}
.team-ctx-pill{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;border-radius:20px;border:1px solid var(--border-1);background:var(--bg-2);color:var(--tx-1);font-size:11px;font-family:var(--sans);cursor:pointer;transition:all .15s;white-space:nowrap;outline:none;line-height:1}
.team-ctx-pill:hover{border-color:var(--tx-2);background:var(--bg-3)}
.team-ctx-pill.active{font-weight:600}
.team-ctx-pill.active-personal{background:var(--bg-4);border-color:var(--border-2);color:var(--tx-0);font-weight:600}
.team-ctx-pill .pill-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}

/* ── Sections ── */
.fb-section{border:1px solid var(--border-0);border-radius:var(--r-lg);margin-bottom:16px;overflow:hidden;background:var(--bg-1)}
.fb-section-header{padding:12px 20px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:background .15s}
.fb-section-header:hover{background:var(--bg-2)}
.fb-section-title{font-size:12px;font-weight:600;color:var(--tx-2);display:flex;align-items:center;gap:8px;
  letter-spacing:.03em;text-transform:uppercase;font-family:var(--mono)}
.fb-section-count{font-size:11px;color:var(--tx-3);font-family:var(--mono)}

/* ── Questions ── */
.fb-question{padding:16px 20px;border-bottom:1px solid var(--border-0);transition:background .15s;position:relative}
.fb-question:last-child{border-bottom:none}
.fb-question:hover{background:var(--bg-2)}
.fb-question-meta{font-size:11px;color:var(--tx-3);margin-bottom:4px;display:flex;align-items:center;gap:6px}
.fb-question-prompt{font-size:14.5px;font-weight:500;color:var(--tx-0);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.fb-question-type{font-size:11px;color:var(--tx-2);font-family:var(--mono);padding:2px 8px;background:var(--bg-3);border-radius:3px}
.fb-question-actions{position:absolute;top:14px;right:16px;display:flex;gap:2px;opacity:0;transition:opacity .15s}
.fb-question:hover .fb-question-actions{opacity:1}

/* ── Answers ── */
.fb-answer-list{margin-top:12px;display:flex;flex-direction:column;gap:6px}
.fb-answer{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:6px;transition:all .12s;cursor:pointer;border:1px solid transparent}
.fb-answer:hover{background:var(--bg-3);border-color:var(--border-0)}
.fb-answer-radio{width:16px;height:16px;border-radius:50%;border:1.5px solid var(--border-2);flex-shrink:0}
.fb-answer-check{width:16px;height:16px;border-radius:3px;border:1.5px solid var(--border-2);flex-shrink:0}
.fb-answer-label{font-size:13px;color:var(--tx-0);flex:1}
.fb-answer-dots{display:flex;gap:3px;align-items:center;flex-shrink:0}
.fb-prov-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:all .15s}
.fb-prov-dot.bound{background:var(--green)}
.fb-prov-dot.unbound{background:var(--border-2);border:1.5px solid var(--tx-3);box-sizing:border-box}
.fb-prov-dot.conflict{background:var(--gold);box-shadow:0 0 4px var(--gold)}
.fb-source-tag{font-size:11px;color:var(--tx-2);margin-top:8px;display:flex;align-items:center;gap:6px}

/* ── Form name ── */
.fb-form-name{font-size:22px;font-weight:700;font-family:var(--serif);letter-spacing:-.02em;color:var(--tx-0);
  border:none;background:transparent;outline:none;width:100%;max-width:100%;border-bottom:2px solid transparent;transition:border-color .2s;padding:2px 0;overflow:hidden;text-overflow:ellipsis}
.fb-form-name:focus{border-bottom-color:var(--teal)}
.fb-wire-btn{font-size:12px;color:var(--teal);cursor:pointer;padding:4px 10px;border:1px solid rgba(62,201,176,.2);
  border-radius:var(--r);background:var(--teal-dim);transition:all .15s;font-family:inherit;font-weight:500}
.fb-wire-btn:hover{border-color:var(--teal);background:rgba(62,201,176,.12)}
.fb-add-btn{display:flex;align-items:center;gap:6px;padding:10px 16px;color:var(--tx-2);font-size:13px;
  cursor:pointer;transition:color .15s;border:none;background:none;font-family:inherit;width:100%}
.fb-add-btn:hover{color:var(--tx-0)}
.fb-nudge{padding:12px 16px;border-radius:var(--r);border:1px solid rgba(91,156,245,.2);
  background:var(--blue-dim);font-size:13px;color:var(--tx-1);line-height:1.6;margin-top:8px}
.fb-nudge-title{color:var(--blue);font-weight:600;font-size:12px;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.fb-nudge-suggestion{padding:6px 10px;margin-top:6px;border:1px solid var(--border-1);border-radius:var(--r);
  cursor:pointer;font-size:13px;color:var(--tx-1);transition:all .12s}
.fb-nudge-suggestion:hover{border-color:var(--blue);color:var(--blue);background:rgba(91,156,245,.06)}

/* Wiring Panel */
.fb-wire-panel{position:fixed;top:0;right:0;bottom:0;width:520px;min-width:340px;max-width:90vw;background:var(--bg-1);
  border-left:1px solid var(--border-0);z-index:40;display:flex;flex-direction:column;
  animation:slideInRight .2s ease both;box-shadow:-8px 0 32px rgba(0,0,0,.3)}
@keyframes slideInRight{from{transform:translateX(100%)}to{transform:translateX(0)}}
.fb-wire-panel-header{padding:18px 20px;border-bottom:1px solid var(--border-0);background:var(--bg-2)}
.fb-wire-panel-body{flex:1;overflow:auto;padding:16px 20px}
.fb-wire-fw-card{border:1px solid var(--border-0);border-radius:var(--r-lg);margin-bottom:10px;overflow:hidden;
  background:var(--bg-2);transition:border-color .15s}
.fb-wire-fw-card:hover{border-color:var(--border-2)}
.fb-wire-fw-card-header{padding:12px 16px;display:flex;align-items:center;gap:10px;cursor:pointer}
.fb-wire-fw-card-body{padding:10px 16px;border-top:1px solid var(--border-0)}
.fb-wire-code-option{padding:8px 12px;border-radius:6px;cursor:pointer;transition:all .12s;
  display:flex;align-items:center;gap:8px;border:1px solid transparent;margin-bottom:4px}
.fb-wire-code-option:hover{border-color:var(--border-2);background:var(--bg-3)}
.fb-wire-code-option.selected{border-color:var(--green);background:var(--green-dim)}
.fb-wire-ground-truth{padding:14px 16px;border-radius:var(--r);border:1px solid var(--border-0);
  background:var(--bg-2);font-size:12.5px;color:var(--tx-2);line-height:1.6;margin-top:16px}
.fb-wire-conflict{padding:10px 14px;border-radius:var(--r);border:1px solid rgba(201,163,82,.25);
  background:rgba(201,163,82,.06);margin-top:6px;font-size:12.5px;color:var(--tx-1);line-height:1.6}

/* Inheritance markers */
.fb-inherit-lock{display:inline-flex;align-items:center;gap:3px;font-size:10px;color:var(--blue);
  font-family:var(--mono);font-weight:600;padding:1px 6px;border-radius:3px;background:var(--blue-dim)}
.fb-inherit-local{display:inline-flex;align-items:center;gap:3px;font-size:10px;color:var(--green);
  font-family:var(--mono);font-weight:600;padding:1px 6px;border-radius:3px;background:var(--green-dim)}

/* Framework adoption modal */
.fb-adopt-modal{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;z-index:50}
.fb-adopt-panel{width:600px;max-height:85vh;overflow:auto;background:var(--bg-1);
  border:1px solid var(--border-0);border-radius:var(--r-lg);padding:24px}

/* Form preview mode */
.fb-preview{max-width:640px;margin:0 auto;padding:24px}
.fb-preview-question{margin-bottom:24px}
.fb-preview-prompt{font-size:16px;font-weight:500;color:var(--tx-0);margin-bottom:10px}
.fb-preview-option{padding:10px 14px;border:1px solid var(--border-0);border-radius:var(--r);
  margin-bottom:6px;cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:10px}
.fb-preview-option:hover{border-color:var(--teal);background:var(--teal-dim)}

/* ═══ Storage Transparency Badge ═══ */
.stb-wrap{margin-bottom:14px}
.stb-toggle{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:14px;
  font-size:11px;font-family:var(--mono);font-weight:500;color:var(--tx-2);background:var(--bg-2);
  border:1px solid var(--border-0);cursor:pointer;transition:all .18s;letter-spacing:.02em;user-select:none}
.stb-toggle:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-dim)}
.stb-toggle.open{border-color:var(--teal);color:var(--teal);background:var(--teal-dim)}
.stb-panel{margin-top:8px;padding:14px 16px;background:var(--bg-2);border:1px solid var(--border-0);
  border-radius:var(--r-lg);animation:fadeUp .2s ease both;font-size:12.5px;line-height:1.65}
.stb-row{display:flex;align-items:flex-start;gap:8px;margin-bottom:8px}
.stb-row:last-child{margin-bottom:0}
.stb-icon{flex-shrink:0;width:18px;height:18px;display:flex;align-items:center;justify-content:center;
  border-radius:4px;margin-top:1px}
.stb-label{font-family:var(--mono);font-size:10.5px;font-weight:600;letter-spacing:.05em;color:var(--tx-2);
  text-transform:uppercase;margin-bottom:2px}
.stb-value{color:var(--tx-0);font-size:12.5px;word-break:break-all}
.stb-value-mono{color:var(--tx-1);font-family:var(--mono);font-size:11px;word-break:break-all}
.stb-enc{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:10px;font-size:10px;
  font-weight:600;font-family:var(--mono)}
.stb-enc-on{background:var(--green-dim);color:var(--green)}
.stb-enc-off{background:var(--red-dim);color:var(--red)}
.stb-member{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;
  background:var(--bg-3);font-family:var(--mono);font-size:10.5px;color:var(--tx-1);margin:2px 2px 2px 0}
.stb-divider{height:1px;background:var(--border-0);margin:8px 0}

/* ═══ Schema Builder Layout ═══ */
@keyframes siPulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes notifSlide{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.si-wrap{display:flex;gap:0;height:calc(100vh - 104px);overflow:hidden;margin:-24px;border-radius:var(--r-lg);border:1px solid var(--border-0)}
.si-sidebar{width:280px;min-width:280px;border-right:1px solid var(--border-0);display:flex;flex-direction:column;background:var(--bg-2);overflow:hidden;flex-shrink:0}
.si-sidebar-scroll{flex:1;overflow-y:auto;overflow-x:hidden}
.si-canvas{flex:1;min-width:0;overflow-y:auto;overflow-x:hidden;padding:24px 28px}
.si-context{width:260px;min-width:260px;border-left:1px solid var(--border-0);display:flex;flex-direction:column;background:var(--bg-2);overflow-y:auto;flex-shrink:0;transition:width 200ms ease-out,min-width 200ms ease-out,opacity 150ms}
.si-context.collapsed{width:36px;min-width:36px;overflow:hidden}
.si-header{padding:14px 16px 10px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;justify-content:space-between}
.si-search{margin:8px 12px;position:relative}
.si-search input{width:100%;padding:8px 12px 8px 30px;border-radius:6px;border:1px solid var(--border-0);background:var(--bg-0);color:var(--tx-0);font-size:12px;font-family:var(--sans);outline:none;transition:border .2s}
.si-search input:focus{border-color:var(--border-2)}
.si-search input::placeholder{color:var(--tx-3)}
.si-search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);pointer-events:none}
.si-group-header{padding:10px 16px 6px;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border-0);transition:background 150ms}
.si-group-header:hover{background:var(--bg-3)}
.si-group-label{font-size:10.5px;font-family:var(--mono);font-weight:600;color:var(--tx-1);letter-spacing:.08em;display:flex;align-items:center;gap:6px}
.si-group-count{font-size:10px;font-family:var(--mono);color:var(--tx-2)}
.si-group-count.alert{color:var(--teal);background:rgba(62,201,176,.12);padding:1px 6px;border-radius:8px;animation:siPulse 2s infinite}
.si-form-item{padding:8px 16px 8px 12px;cursor:pointer;border-left:3px solid transparent;border-bottom:1px solid var(--border-0);transition:all 150ms;display:flex;gap:6px;align-items:flex-start}
.si-form-item:hover{background:var(--bg-3)}
.si-form-item.active{background:var(--bg-4);border-left-color:var(--teal)}
.si-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:5px}
.si-dot.unread{background:var(--teal);animation:siPulse 2s infinite}
.si-dot.current{background:var(--tx-0);border-radius:2px}
.si-dot.read{background:var(--tx-3);opacity:.4}
.si-form-name{font-size:12.5px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--tx-0)}
.si-form-item.active .si-form-name{font-weight:600}
.si-form-meta{font-size:10px;font-family:var(--mono);color:var(--tx-2);margin-top:2px;display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.si-form-status{font-size:9px;font-weight:600;letter-spacing:.03em;padding:1px 6px;border-radius:3px;text-transform:uppercase;display:inline-block}
.si-form-status.normative{background:var(--green-dim);color:var(--green)}
.si-form-status.trial{background:rgba(224,148,58,.12);color:var(--orange)}
.si-form-status.draft{background:var(--bg-3);color:var(--tx-3)}
.si-form-status.de_facto{background:rgba(167,139,250,.12);color:var(--purple)}
.si-form-status.deprecated{background:var(--red-dim);color:var(--red)}
.si-form-update{font-size:9px;font-family:var(--mono);font-weight:600;color:var(--gold);background:rgba(201,163,82,.10);padding:1px 5px;border-radius:3px;margin-top:2px;display:inline-block}
.si-ctx-section{padding:12px 14px;border-bottom:1px solid var(--border-0)}
.si-ctx-label{font-size:10px;font-family:var(--mono);font-weight:600;color:var(--tx-1);letter-spacing:.07em;margin-bottom:8px;display:block}
.si-vt{position:relative;padding-left:20px}
.si-vt::before{content:'';position:absolute;left:16px;top:0;bottom:0;width:1px;background:var(--border-0)}
.si-vt-node{position:relative;padding:6px 0 12px 16px}
.si-vt-dot{position:absolute;left:-8px;top:8px;width:9px;height:9px;border-radius:50%}
.si-vt-dot.current{background:var(--teal);box-shadow:0 0 6px rgba(62,201,176,.3)}
.si-vt-dot.past{background:transparent;border:2px solid var(--tx-3);cursor:pointer}
.si-vt-dot.past:hover{border-color:var(--tx-1)}
.si-lineage-node{padding:8px 12px;border-radius:6px;margin-bottom:0}
.si-lineage-connector{display:flex;align-items:center;gap:6px;padding:2px 0 2px 20px}
.si-lineage-connector::before{content:'';width:1px;height:14px;background:var(--border-1);flex-shrink:0}
.si-adopt-bar{height:4px;border-radius:2px;background:var(--border-0);overflow:hidden;margin:6px 0 10px}
.si-adopt-fill{height:100%;background:var(--teal);border-radius:2px;transition:width 300ms ease-out}
.si-breadcrumb{display:flex;align-items:center;gap:0;font-size:12px;color:var(--tx-2);font-family:var(--sans);overflow:hidden;min-width:0;flex:1}
.si-breadcrumb span.sep{color:var(--tx-3);padding:0 6px;font-size:10px;flex-shrink:0}
.si-breadcrumb span.current{color:var(--tx-0);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.si-empty{padding:20px 16px;text-align:center}
.si-empty-icon{margin-bottom:6px;opacity:.5}
.si-empty-title{font-size:12px;font-weight:600;color:var(--tx-1);margin-bottom:4px}
.si-empty-desc{font-size:11px;color:var(--tx-3);line-height:1.5}
.si-ctx-strip{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px 0}
.si-ctx-strip button{background:none;border:none;color:var(--tx-3);cursor:pointer;padding:4px;transition:color .15s}
.si-ctx-strip button:hover{color:var(--tx-1)}
@media(max-width:1100px){
  .si-sidebar{width:240px;min-width:240px}
  .si-context:not(.collapsed){width:36px;min-width:36px}
  .si-canvas{padding:20px 22px}
}
@media(max-width:900px){
  .si-sidebar{position:fixed;left:-300px;top:56px;bottom:0;width:300px;min-width:300px;z-index:40;transition:left 250ms ease-out;box-shadow:8px 0 32px rgba(0,0,0,.4)}
  .si-sidebar.open{left:0}
  .si-context{display:none}
  .si-canvas{padding:16px 18px}
  .si-mobile-menu{display:inline-flex!important}
  .fb-wire-panel{min-width:280px;width:90vw}
}
@media(max-width:768px){
  .fb-progress{flex-wrap:wrap;gap:2px}
  .fb-step-label{font-size:10px}
  .fb-step-line{width:16px}
  .fb-question{padding:12px 14px}
  .fb-answer{padding:6px 10px}
}

/* ═══ Create Field / Merge / Evolve Modals ═══ */
.cf-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);z-index:50;display:flex;align-items:center;justify-content:center}
.cf-modal{background:var(--bg-1);border:1px solid var(--border-1);border-radius:var(--r-lg);width:580px;max-width:92vw;max-height:88vh;overflow-y:auto;box-shadow:0 16px 48px rgba(0,0,0,.5);animation:fadeUp .2s ease both}
.cf-header{padding:18px 22px 14px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;justify-content:space-between}
.cf-header h3{font-size:16px;font-weight:700;font-family:var(--serif);color:var(--tx-0)}
.cf-body{padding:18px 22px;display:flex;flex-direction:column;gap:14px}
.cf-row{display:flex;flex-direction:column;gap:4px}
.cf-row-pair{display:flex;gap:12px}
.cf-row-pair>.cf-row{flex:1}
.cf-label{font-size:11px;font-weight:600;color:var(--tx-2);letter-spacing:.03em;display:flex;align-items:center;gap:4px}
.cf-label .required{color:var(--red);font-size:13px}
.cf-help{font-size:10px;color:var(--tx-3);margin-top:2px;line-height:1.4}
.cf-char-count{font-size:9px;font-family:var(--mono);color:var(--tx-3);text-align:right;margin-top:2px}
.cf-char-count.warn{color:var(--orange)}
.cf-char-count.ok{color:var(--green)}
.cf-preview{margin-top:8px;padding:12px 14px;background:var(--bg-2);border:1px solid var(--border-0);border-radius:var(--r);font-size:11px}
.cf-preview-uri{font-family:var(--mono);font-size:10px;color:var(--teal);margin-top:4px}
.cf-footer{padding:14px 22px;border-top:1px solid var(--border-0);display:flex;align-items:center;justify-content:flex-end;gap:8px}
.cf-gov-notice{padding:8px 12px;background:var(--orange-dim);border:1px solid rgba(224,148,58,.25);border-radius:var(--r);font-size:11px;color:var(--orange);display:flex;align-items:center;gap:6px}
.cf-toggle{display:flex;align-items:center;gap:8px;cursor:pointer}
.cf-toggle-track{width:32px;height:18px;border-radius:9px;background:var(--border-1);position:relative;transition:background .2s}
.cf-toggle-track.on{background:var(--teal)}
.cf-toggle-knob{position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:#fff;transition:left .2s}
.cf-toggle-track.on .cf-toggle-knob{left:16px}

/* ── Merge modal extras ── */
.cf-merge-fields{display:flex;flex-direction:column;gap:8px;margin:8px 0}
.cf-merge-card{padding:10px 14px;border:1px solid var(--border-0);border-radius:var(--r);background:var(--bg-2);display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .15s}
.cf-merge-card:hover{border-color:var(--border-2)}
.cf-merge-card.canonical{border-color:var(--teal);background:var(--teal-dim)}
.cf-merge-arrow{display:flex;align-items:center;justify-content:center;padding:4px 0;color:var(--tx-3);font-size:16px}
.cf-migrate-badge{font-size:9px;font-family:var(--mono);padding:2px 6px;border-radius:3px;display:inline-flex;align-items:center;gap:3px}
.cf-migrate-badge.outdated{background:var(--orange-dim);color:var(--orange)}
.cf-migrate-badge.current{background:var(--green-dim);color:var(--green)}
/* ── Database Merge (auditable SYN) ── */
.db-merge-sources{display:flex;gap:12px;margin:10px 0}
.db-merge-source{flex:1;padding:12px;border:1px solid var(--border-0);border-radius:var(--r);background:var(--bg-2);cursor:pointer;transition:all .15s}
.db-merge-source:hover{border-color:var(--border-2)}
.db-merge-source.primary{border-color:var(--purple);background:rgba(167,139,250,0.08)}
.db-merge-field-row{display:flex;align-items:stretch;gap:0;margin:2px 0;border:1px solid var(--border-0);border-radius:var(--r);overflow:hidden;transition:border-color .15s}
.db-merge-field-row:hover{border-color:var(--border-2)}
.db-merge-field-label{width:120px;min-width:120px;padding:8px 10px;background:var(--bg-3);font-size:11px;font-weight:600;color:var(--tx-2);display:flex;align-items:center;border-right:1px solid var(--border-0)}
.db-merge-field-val{flex:1;padding:8px 10px;font-size:12px;color:var(--tx-0);cursor:pointer;transition:background .12s;display:flex;align-items:center;gap:6px;border-right:1px solid var(--border-0)}
.db-merge-field-val:last-child{border-right:none}
.db-merge-field-val:hover{background:var(--bg-3)}
.db-merge-field-val.selected{background:rgba(167,139,250,0.12);color:var(--purple)}
.db-merge-field-val.conflict{background:rgba(232,93,93,0.06)}
.db-merge-syn-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;font-family:var(--mono);background:rgba(167,139,250,0.12);color:var(--purple)}
.db-merge-audit-row{padding:8px 12px;border-left:2px solid var(--purple);margin:4px 0;background:var(--bg-2);border-radius:0 var(--r) var(--r) 0;font-size:11px;display:flex;flex-direction:column;gap:2px}
.db-merge-date-pick{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-2);border:1px solid var(--border-0);border-radius:var(--r);margin:8px 0}
.db-merge-date-pick input[type="date"]{max-width:180px;font-family:var(--mono);font-size:12px}
.db-merge-summary{padding:12px 14px;background:var(--bg-2);border:1px solid var(--border-0);border-radius:var(--r);font-size:11px;color:var(--tx-2);line-height:1.6}

/* ═══ Schema Workbench (Redesigned) ═══ */
.sw-wrap{display:flex;flex-direction:column;height:calc(100vh - 104px);margin:-24px;border-radius:var(--r-lg);border:1px solid var(--border-0);overflow:hidden;background:var(--bg-1)}
.sw-header{display:flex;align-items:center;justify-content:space-between;padding:14px 24px 0;flex-shrink:0}
.sw-title{font-size:16px;font-weight:700;font-family:var(--serif);color:var(--tx-0);display:flex;align-items:center;gap:8px}
.sw-tabs{display:flex;gap:0;border-bottom:1px solid var(--border-0);padding:0 24px;flex-shrink:0;margin-top:10px}
.sw-tab{padding:10px 20px;font-size:12.5px;font-weight:500;font-family:var(--sans);color:var(--tx-2);cursor:pointer;
  border:none;background:none;border-bottom:2px solid transparent;transition:all .15s;display:flex;align-items:center;gap:6px}
.sw-tab:hover{color:var(--tx-0)}
.sw-tab.active{color:var(--teal);border-bottom-color:var(--teal);font-weight:600}
.sw-tab .sw-tab-count{font-size:10px;font-family:var(--mono);padding:1px 6px;border-radius:8px;background:var(--bg-3);color:var(--tx-3)}
.sw-tab.active .sw-tab-count{background:var(--teal-dim);color:var(--teal)}
.sw-canvas{flex:1;overflow:hidden;position:relative}
.sw-canvas-inner{height:100%;overflow-y:auto;overflow-x:hidden;padding:20px 24px}

/* ── Dictionary Tab ── */
.sw-dict-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.sw-dict-search{flex:1;min-width:200px;position:relative}
.sw-dict-search input{width:100%;padding:9px 14px 9px 34px;border-radius:8px;border:1px solid var(--border-0);
  background:var(--bg-2);color:var(--tx-0);font-size:13px;font-family:var(--sans);outline:none;transition:border .2s}
.sw-dict-search input:focus{border-color:var(--teal)}
.sw-dict-search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);pointer-events:none}
.sw-dict-filters{display:flex;gap:4px;flex-wrap:wrap}
.sw-dict-filter{padding:5px 12px;border-radius:14px;font-size:11px;font-weight:500;cursor:pointer;
  border:1px solid var(--border-0);background:var(--bg-2);color:var(--tx-2);transition:all .15s;font-family:var(--sans)}
.sw-dict-filter:hover{border-color:var(--border-2);color:var(--tx-0)}
.sw-dict-filter.active{border-color:var(--teal);background:var(--teal-dim);color:var(--teal)}
.sw-dict-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:10px}
.sw-dict-card{border:1px solid var(--border-0);border-radius:var(--r-lg);background:var(--bg-2);
  padding:14px 18px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden}
.sw-dict-card:hover{border-color:var(--border-2);background:var(--bg-3)}
.sw-dict-card.expanded{border-color:var(--teal);background:var(--bg-2)}
.sw-dict-card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.sw-dict-card-name{font-size:14px;font-weight:600;color:var(--tx-0)}
.sw-dict-card-uri{font-size:10px;font-family:var(--mono);color:var(--teal);margin-top:2px;opacity:.7}
.sw-dict-card-badges{display:flex;gap:4px;flex-shrink:0;align-items:center}
.sw-dict-card-def{font-size:12px;color:var(--tx-2);margin-top:8px;line-height:1.5;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.sw-dict-card.expanded .sw-dict-card-def{-webkit-line-clamp:unset}
.sw-dict-card-scope{font-size:11px;color:var(--tx-3);margin-top:6px;line-height:1.5;font-style:italic;
  padding:8px 12px;background:var(--bg-0);border-radius:6px;border:1px solid var(--border-0)}
.sw-dict-card-usage{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap}
.sw-dict-card-form-tag{font-size:10px;font-family:var(--mono);padding:2px 8px;border-radius:4px;
  background:var(--bg-3);color:var(--tx-2);border:1px solid var(--border-0)}
.sw-dict-card-editor{margin-top:12px;padding-top:12px;border-top:1px solid var(--border-0);display:flex;flex-direction:column;gap:8px}
.sw-dict-card-editor label{font-size:10px;font-weight:600;color:var(--tx-2);letter-spacing:.03em;text-transform:uppercase}
.sw-dict-card-editor input,.sw-dict-card-editor textarea{padding:8px 12px;border-radius:6px;
  border:1px solid var(--border-0);background:var(--bg-0);color:var(--tx-0);font-size:12px;font-family:var(--sans);outline:none;resize:vertical}
.sw-dict-card-editor textarea{min-height:60px}
.sw-dict-card-editor input:focus,.sw-dict-card-editor textarea:focus{border-color:var(--teal)}
.sw-dict-empty{padding:40px 20px;text-align:center;border:1px dashed var(--border-1);border-radius:var(--r-lg);color:var(--tx-3)}
.sw-dict-stats{display:flex;gap:16px;margin-bottom:16px;flex-wrap:wrap}
.sw-dict-stat{font-size:12px;color:var(--tx-2);display:flex;align-items:center;gap:4px}
.sw-dict-stat strong{color:var(--tx-0);font-family:var(--mono)}

/* ── URI Library Browser ── */
.uri-browser-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:310;display:flex;align-items:center;justify-content:center;animation:fadeIn .15s ease both;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}
.uri-browser{width:760px;max-width:94vw;max-height:85vh;background:var(--bg-1);border:1px solid var(--border-0);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.4);display:flex;flex-direction:column;overflow:hidden;animation:fadeUp .2s ease both}
.uri-browser-header{padding:18px 22px 0;flex-shrink:0}
.uri-browser-header-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.uri-browser-title{font-size:16px;font-weight:700;font-family:var(--serif);color:var(--tx-0);display:flex;align-items:center;gap:8px}
.uri-browser-close{background:none;border:none;cursor:pointer;color:var(--tx-2);font-size:18px;padding:4px 8px;border-radius:4px;transition:all .15s}
.uri-browser-close:hover{background:var(--bg-3);color:var(--tx-0)}
.uri-browser-search{position:relative;margin-bottom:12px}
.uri-browser-search input{width:100%;padding:11px 16px 11px 38px;border-radius:8px;border:1px solid var(--border-1);background:var(--bg-2);color:var(--tx-0);font-size:14px;font-family:var(--sans);outline:none;transition:border .2s,box-shadow .2s}
.uri-browser-search input:focus{border-color:var(--teal);box-shadow:0 0 0 3px var(--teal-dim)}
.uri-browser-search-icon{position:absolute;left:13px;top:50%;transform:translateY(-50%);pointer-events:none}
.uri-browser-filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--border-0)}
.uri-browser-lib-chip{padding:5px 12px;border-radius:14px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border-0);background:var(--bg-2);color:var(--tx-2);transition:all .15s;font-family:var(--sans);display:flex;align-items:center;gap:5px}
.uri-browser-lib-chip:hover{border-color:var(--border-2);color:var(--tx-0)}
.uri-browser-lib-chip.active{border-color:var(--teal);background:var(--teal-dim);color:var(--teal)}
.uri-browser-lib-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.uri-browser-cat-chips{display:flex;gap:4px;flex-wrap:wrap}
.uri-browser-cat-chip{padding:3px 10px;border-radius:10px;font-size:10px;font-weight:500;cursor:pointer;border:1px solid var(--border-0);background:var(--bg-2);color:var(--tx-3);transition:all .15s}
.uri-browser-cat-chip:hover{color:var(--tx-1);border-color:var(--border-1)}
.uri-browser-cat-chip.active{border-color:var(--teal);background:var(--teal-dim);color:var(--teal)}
.uri-browser-body{flex:1;overflow-y:auto;padding:0 22px 14px}
.uri-browser-results-count{font-size:11px;color:var(--tx-3);font-family:var(--mono);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.uri-browser-grid{display:flex;flex-direction:column;gap:6px}
.uri-browser-entry{padding:12px 16px;border:1px solid var(--border-0);border-radius:var(--r-lg);background:var(--bg-2);cursor:pointer;transition:all .15s;display:flex;gap:12px;align-items:flex-start}
.uri-browser-entry:hover{border-color:var(--teal);background:var(--bg-3);transform:translateY(-1px)}
.uri-browser-entry.selected{border-color:var(--teal);background:var(--teal-dim)}
.uri-browser-entry-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;font-weight:700}
.uri-browser-entry-body{flex:1;min-width:0}
.uri-browser-entry-label{font-size:13.5px;font-weight:600;color:var(--tx-0);margin-bottom:2px}
.uri-browser-entry-uri{font-size:10px;font-family:var(--mono);color:var(--teal);opacity:.8;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.uri-browser-entry-def{font-size:12px;color:var(--tx-2);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.uri-browser-entry-tags{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.uri-browser-entry-tag{font-size:9px;padding:1px 7px;border-radius:8px;background:var(--bg-3);color:var(--tx-3);font-family:var(--mono)}
.uri-browser-entry-lib{font-size:9px;padding:1px 7px;border-radius:8px;font-family:var(--mono);font-weight:600}
.uri-browser-entry-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.uri-browser-entry-type{font-size:9px;padding:2px 8px;border-radius:4px;font-family:var(--mono);font-weight:600;text-transform:uppercase}
.uri-browser-entry-select{padding:5px 14px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid var(--teal);background:var(--teal-dim);color:var(--teal);cursor:pointer;transition:all .15s;opacity:0;white-space:nowrap}
.uri-browser-entry:hover .uri-browser-entry-select{opacity:1}
.uri-browser-entry-select:hover{background:var(--teal);color:var(--bg-0)}
.uri-browser-footer{padding:12px 22px;border-top:1px solid var(--border-0);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--bg-2)}
.uri-browser-footer-info{font-size:11px;color:var(--tx-3);display:flex;align-items:center;gap:6px}
.uri-browser-footer-actions{display:flex;gap:8px}
.uri-browser-empty{padding:40px 20px;text-align:center;color:var(--tx-3);font-size:13px}
.uri-browser-empty-icon{font-size:28px;margin-bottom:8px;opacity:.4}
.uri-browser-lib-info{padding:10px 14px;border-radius:var(--r);background:var(--bg-0);border:1px solid var(--border-0);margin-bottom:12px;font-size:11px;color:var(--tx-2);line-height:1.5;display:flex;align-items:flex-start;gap:8px}
.uri-browser-lib-info-name{font-weight:700;color:var(--tx-0);font-size:12px;margin-bottom:2px}
.uri-browser-selected-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;font-size:10px;font-weight:600;font-family:var(--mono);background:var(--teal-dim);color:var(--teal);margin-top:6px}
@media(max-width:700px){
  .uri-browser{max-width:100vw;max-height:100vh;height:100vh;border-radius:0}
  .uri-browser-grid{gap:4px}
  .uri-browser-entry{padding:10px 12px}
}

/* ── Forms Tab (split panel) ── */
.sw-forms-split{display:flex;height:100%;overflow:hidden}
.sw-forms-list{width:300px;min-width:300px;border-right:1px solid var(--border-0);display:flex;flex-direction:column;
  background:var(--bg-2);flex-shrink:0;overflow:hidden}
.sw-forms-list-header{padding:14px 16px 10px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;justify-content:space-between}
.sw-forms-list-search{margin:6px 12px 8px;position:relative}
.sw-forms-list-search input{width:100%;padding:8px 12px 8px 30px;border-radius:6px;border:1px solid var(--border-0);
  background:var(--bg-0);color:var(--tx-0);font-size:12px;font-family:var(--sans);outline:none}
.sw-forms-list-search input:focus{border-color:var(--teal)}
.sw-forms-list-search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);pointer-events:none}
.sw-forms-list-scroll{flex:1;overflow-y:auto}
.sw-forms-group-header{padding:8px 16px;cursor:pointer;user-select:none;display:flex;align-items:center;
  justify-content:space-between;border-bottom:1px solid var(--border-0);transition:background .15s}
.sw-forms-group-header:hover{background:var(--bg-3)}
.sw-forms-group-label{font-size:10px;font-family:var(--mono);font-weight:600;color:var(--tx-2);
  letter-spacing:.08em;display:flex;align-items:center;gap:6px}
.sw-forms-group-count{font-size:10px;font-family:var(--mono);color:var(--tx-3)}
.sw-forms-item{padding:8px 16px 8px 14px;cursor:pointer;border-left:3px solid transparent;
  border-bottom:1px solid var(--border-0);transition:all .12s;display:flex;gap:8px;align-items:flex-start}
.sw-forms-item:hover{background:var(--bg-3)}
.sw-forms-item.active{background:var(--bg-3);border-left-color:var(--teal)}
.sw-forms-item-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:5px;background:var(--tx-3);opacity:.4}
.sw-forms-item-dot.active{background:var(--teal);opacity:1;border-radius:2px}
.sw-forms-item-name{font-size:12.5px;font-weight:500;color:var(--tx-0);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sw-forms-item.active .sw-forms-item-name{font-weight:600}
.sw-forms-item-meta{font-size:10px;font-family:var(--mono);color:var(--tx-3);margin-top:2px;display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.sw-forms-item-status{font-size:9px;font-weight:600;letter-spacing:.03em;padding:1px 6px;border-radius:3px;text-transform:uppercase}
.sw-forms-item-status.draft{background:var(--bg-3);color:var(--tx-3)}
.sw-forms-item-status.trial{background:rgba(224,148,58,.12);color:var(--orange)}
.sw-forms-item-status.normative{background:var(--green-dim);color:var(--green)}
.sw-forms-item-status.deprecated{background:var(--red-dim);color:var(--red)}
.sw-forms-item-status.de_facto{background:rgba(167,139,250,.12);color:var(--purple)}
.sw-forms-editor{flex:1;overflow-y:auto;padding:20px 28px}
.sw-forms-editor-header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:20px}
.sw-forms-editor-name{font-size:22px;font-weight:700;font-family:var(--serif);letter-spacing:-.02em;color:var(--tx-0);
  border:none;background:transparent;outline:none;width:100%;padding:2px 0;border-bottom:2px solid transparent;transition:border-color .2s}
.sw-forms-editor-name:focus{border-bottom-color:var(--teal)}
.sw-forms-editor-badges{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:6px}
.sw-forms-editor-actions{display:flex;gap:6px;flex-shrink:0;align-items:flex-start}
.sw-forms-editor-desc{width:100%;padding:6px 10px;border-radius:6px;border:1px solid var(--border-0);
  background:var(--bg-2);color:var(--tx-1);font-size:12px;font-family:var(--sans);outline:none;margin-bottom:16px;resize:none}
.sw-forms-editor-desc:focus{border-color:var(--teal)}

/* ── Form stats summary bar ── */
.sw-f-stats{display:flex;gap:16px;padding:10px 16px;margin-bottom:16px;border:1px solid var(--border-0);
  border-radius:var(--r-lg);background:var(--bg-2);flex-wrap:wrap;align-items:center}
.sw-f-stat{font-size:11px;color:var(--tx-2);display:flex;align-items:center;gap:5px}
.sw-f-stat strong{font-family:var(--mono);color:var(--tx-0);font-size:13px}
.sw-f-stat-icon{opacity:.6}
.sw-f-stats-divider{width:1px;height:18px;background:var(--border-0)}

/* ── Expand/collapse all toggle ── */
.sw-f-expand-all{font-size:10px;font-family:var(--mono);color:var(--tx-3);cursor:pointer;padding:3px 10px;
  border-radius:4px;border:1px solid var(--border-0);background:var(--bg-2);transition:all .15s;
  display:flex;align-items:center;gap:4px;white-space:nowrap}
.sw-f-expand-all:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-dim)}

/* ── Required toggle ── */
.sw-f-q-required{display:inline-flex;align-items:center;gap:4px;font-size:9px;font-weight:600;
  letter-spacing:.03em;text-transform:uppercase;padding:2px 7px;border-radius:3px;cursor:pointer;transition:all .15s;
  border:1px solid transparent;user-select:none}
.sw-f-q-required.on{color:var(--red);background:var(--red-dim);border-color:rgba(232,93,93,.15)}
.sw-f-q-required.off{color:var(--tx-3);background:var(--bg-3);border-color:var(--border-0)}
.sw-f-q-required:hover{opacity:.85}

/* ── Reorder buttons ── */
.sw-f-reorder{display:flex;flex-direction:column;gap:1px;margin-right:4px;flex-shrink:0}
.sw-f-reorder-btn{background:none;border:1px solid var(--border-0);color:var(--tx-3);cursor:pointer;
  padding:1px 4px;border-radius:3px;font-size:9px;line-height:1;transition:all .12s;display:flex;align-items:center;justify-content:center}
.sw-f-reorder-btn:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-dim)}
.sw-f-reorder-btn:disabled{opacity:.2;cursor:default;border-color:var(--border-0);color:var(--tx-3);background:none}
.sw-f-sec-reorder{display:flex;gap:2px;align-items:center}
.sw-f-sec-reorder-btn{background:none;border:1px solid var(--border-0);color:var(--tx-3);cursor:pointer;
  padding:2px 5px;border-radius:3px;font-size:10px;line-height:1;transition:all .12s}
.sw-f-sec-reorder-btn:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-dim)}
.sw-f-sec-reorder-btn:disabled{opacity:.2;cursor:default;border-color:var(--border-0);color:var(--tx-3);background:none}

/* ── Form section & question (reuses some .fb-* patterns) ── */
.sw-f-section{border:1px solid var(--border-0);border-radius:var(--r-lg);margin-bottom:14px;overflow:hidden;background:var(--bg-2)}
.sw-f-section-header{padding:10px 18px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;
  justify-content:space-between;cursor:pointer;transition:background .15s}
.sw-f-section-header:hover{background:var(--bg-3)}
.sw-f-section-title{font-size:11px;font-weight:600;color:var(--tx-2);display:flex;align-items:center;gap:8px;
  letter-spacing:.04em;text-transform:uppercase;font-family:var(--mono)}
.sw-f-section-count{font-size:10px;color:var(--tx-3);font-family:var(--mono)}
.sw-f-q{padding:14px 18px;border-bottom:1px solid var(--border-0);transition:background .12s;position:relative}
.sw-f-q:last-child{border-bottom:none}
.sw-f-q:hover{background:var(--bg-3)}
.sw-f-q-meta{font-size:10px;color:var(--tx-3);margin-bottom:3px;display:flex;align-items:center;gap:6px}
.sw-f-q-prompt{font-size:14px;font-weight:500;color:var(--tx-0);margin-bottom:8px;display:flex;align-items:center;gap:8px}
.sw-f-q-actions{position:absolute;top:12px;right:14px;display:flex;gap:2px;opacity:0;transition:opacity .12s}
.sw-f-q:hover .sw-f-q-actions{opacity:1}
.sw-f-q-field-link{font-size:9px;font-family:var(--mono);color:var(--teal);padding:1px 6px;border-radius:3px;
  background:var(--teal-dim);cursor:pointer;display:inline-flex;align-items:center;gap:3px}
.sw-f-q-field-link:hover{background:rgba(62,201,176,.15)}

/* ── Answer options with inline binding ── */
.sw-f-opt{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;
  transition:all .1s;cursor:default;border:1px solid transparent;margin-bottom:2px}
.sw-f-opt:hover{background:var(--bg-3);border-color:var(--border-0)}
.sw-f-opt-radio{width:14px;height:14px;border-radius:50%;border:1.5px solid var(--border-2);flex-shrink:0}
.sw-f-opt-check{width:14px;height:14px;border-radius:3px;border:1.5px solid var(--border-2);flex-shrink:0}
.sw-f-opt-label{font-size:13px;color:var(--tx-0);flex:1;min-width:0}
.sw-f-opt-bindings{display:flex;gap:3px;align-items:center;flex-shrink:0}
.sw-f-opt-dot{width:8px;height:8px;border-radius:50%;cursor:pointer;transition:all .15s;position:relative}
.sw-f-opt-dot.bound{box-shadow:0 0 3px currentColor}
.sw-f-opt-dot.unbound{background:var(--border-2);border:1.5px solid var(--tx-3);box-sizing:border-box}
.sw-f-opt-dot:hover{transform:scale(1.4)}
.sw-f-opt-rm{background:none;border:none;color:var(--tx-3);cursor:pointer;font-size:13px;padding:2px 4px;opacity:0;transition:opacity .12s}
.sw-f-opt:hover .sw-f-opt-rm{opacity:.6}
.sw-f-opt-rm:hover{opacity:1!important;color:var(--red)}

/* ── Inline binding dropdown ── */
.sw-f-bind-drop{position:absolute;right:0;top:100%;z-index:30;min-width:220px;background:var(--bg-1);
  border:1px solid var(--border-1);border-radius:var(--r-lg);box-shadow:0 8px 24px rgba(0,0,0,.4);
  padding:8px;animation:fadeUp .15s ease both}
.sw-f-bind-drop-item{padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;
  font-size:12px;color:var(--tx-1);transition:background .1s}
.sw-f-bind-drop-item:hover{background:var(--bg-3)}
.sw-f-bind-drop-item.selected{background:var(--green-dim);border:1px solid rgba(62,201,176,.2)}

/* ── Add question/section/answer buttons ── */
.sw-f-add{display:flex;align-items:center;gap:6px;padding:10px 16px;color:var(--tx-3);font-size:12px;
  cursor:pointer;transition:color .12s;border:none;background:none;font-family:var(--sans);width:100%}
.sw-f-add:hover{color:var(--teal)}
.sw-f-add-section{border:1px dashed var(--border-1);border-radius:var(--r-lg);justify-content:center;padding:12px;margin-bottom:14px}
.sw-f-add-section:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-dim)}

/* ── Framework bar (bottom of form) ── */
.sw-f-fw-bar{margin-top:20px;padding:14px 18px;border:1px solid var(--border-0);border-radius:var(--r-lg);background:var(--bg-2)}
.sw-f-fw-bar-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.sw-f-fw-bar-label{font-size:11px;font-weight:600;color:var(--tx-2);letter-spacing:.04em;text-transform:uppercase;font-family:var(--mono);display:flex;align-items:center;gap:6px}
.sw-f-fw-list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
.sw-f-fw-card{padding:10px 14px;border:1px solid var(--border-0);border-radius:8px;background:var(--bg-0)}
.sw-f-fw-card-header{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.sw-f-fw-card-name{font-size:13px;font-weight:600}
.sw-f-fw-card-codes{display:flex;flex-direction:column;gap:3px}
.sw-f-fw-code{display:flex;align-items:center;gap:6px;padding:4px 8px;font-size:12px}

/* ── Preview overlay ── */
.sw-f-preview-overlay{position:absolute;inset:0;background:var(--bg-1);z-index:20;overflow-y:auto;padding:24px;animation:fadeUp .2s ease both}
.sw-f-preview-close{position:sticky;top:0;display:flex;justify-content:flex-end;padding-bottom:12px;z-index:21}
.sw-f-preview-q{margin-bottom:22px}
.sw-f-preview-prompt{font-size:16px;font-weight:500;color:var(--tx-0);margin-bottom:10px}
.sw-f-preview-opt{padding:10px 14px;border:1px solid var(--border-0);border-radius:var(--r);margin-bottom:6px;
  cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:10px}
.sw-f-preview-opt:hover{border-color:var(--teal);background:var(--teal-dim)}

/* ── Columns Tab ── */
.sw-cols-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.sw-cols-stats{display:flex;gap:16px;margin-bottom:12px}
.sw-cols-stat{font-size:12px;color:var(--tx-2);display:flex;align-items:center;gap:4px}
.sw-cols-stat strong{color:var(--tx-0);font-family:var(--mono)}
.sw-cols-table-wrap{overflow-x:auto;border:1px solid var(--border-0);border-radius:var(--r-lg);background:var(--bg-2)}
.sw-cols-table{width:100%;border-collapse:collapse;font-size:12px}
.sw-cols-table th{padding:10px 14px;text-align:left;font-size:10px;font-weight:600;font-family:var(--mono);
  color:var(--tx-2);letter-spacing:.04em;text-transform:uppercase;border-bottom:1px solid var(--border-0);
  background:var(--bg-3);position:sticky;top:0;z-index:2}
.sw-cols-table th.sw-cols-form-th{text-align:center;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
  writing-mode:vertical-lr;text-orientation:mixed;padding:14px 6px;font-size:9px;min-width:36px}
.sw-cols-table td{padding:8px 14px;border-bottom:1px solid var(--border-0);color:var(--tx-1);vertical-align:middle}
.sw-cols-table tr:hover td{background:var(--bg-3)}
.sw-cols-table td.sw-cols-cell{text-align:center;cursor:pointer;transition:background .1s}
.sw-cols-cell-present{color:var(--teal);font-size:14px}
.sw-cols-cell-bound{color:var(--green);font-size:14px}
.sw-cols-cell-absent{color:var(--tx-3);font-size:14px;opacity:.3}
.sw-cols-field-name{font-weight:500;color:var(--tx-0)}
.sw-cols-field-cat{font-size:9px;font-family:var(--mono);padding:1px 6px;border-radius:3px;margin-left:6px}
.sw-cols-usage-bar{width:40px;height:4px;border-radius:2px;background:var(--border-0);overflow:hidden;display:inline-block;vertical-align:middle;margin-left:6px}
.sw-cols-usage-fill{height:100%;border-radius:2px;background:var(--teal);transition:width .3s}

/* ── Add Column Modal ── */
.acm-gov-banner{display:flex;align-items:flex-start;gap:10px;padding:12px 18px;background:var(--bg-3);border-bottom:1px solid var(--border-0);font-size:12px}
.acm-mode-tabs{display:flex;border-bottom:1px solid var(--border-0)}
.acm-mode-tab{flex:1;padding:10px 14px;background:none;border:none;border-bottom:2px solid transparent;font-size:12px;font-family:var(--sans);
  color:var(--tx-2);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .15s}
.acm-mode-tab:hover{color:var(--tx-0);background:var(--bg-3)}
.acm-mode-tab.active{color:var(--purple);border-bottom-color:var(--purple);font-weight:600}
.acm-existing-list{display:flex;flex-direction:column;gap:6px;max-height:280px;overflow-y:auto;padding:2px 0}
.acm-existing-item{padding:10px 12px;border:1px solid var(--border-0);border-radius:var(--r);cursor:pointer;transition:all .15s;background:var(--bg-2)}
.acm-existing-item:hover{border-color:var(--border-2);background:var(--bg-3)}
.acm-existing-item.selected{border-color:var(--purple);background:rgba(139,92,246,.06)}
.acm-existing-radio{width:14px;height:14px;border-radius:50%;border:2px solid var(--border-1);flex-shrink:0;transition:all .15s}
.acm-existing-radio.checked{border-color:var(--purple);background:var(--purple);box-shadow:inset 0 0 0 2.5px var(--bg-1)}

/* ── Governance Tab ── */
.sw-gov-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
@media(max-width:900px){.sw-gov-grid{grid-template-columns:1fr}}
.sw-gov-card{border:1px solid var(--border-0);border-radius:var(--r-lg);background:var(--bg-2);padding:16px 20px;overflow:hidden}
.sw-gov-card-title{font-size:11px;font-weight:600;font-family:var(--mono);color:var(--tx-2);letter-spacing:.06em;
  text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.sw-gov-pipeline{display:flex;gap:12px;flex-wrap:wrap}
.sw-gov-lane{flex:1;min-width:140px;border:1px solid var(--border-0);border-radius:8px;background:var(--bg-0);padding:10px;overflow:hidden}
.sw-gov-lane-header{font-size:10px;font-weight:600;font-family:var(--mono);letter-spacing:.04em;text-transform:uppercase;
  margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.sw-gov-lane-items{display:flex;flex-direction:column;gap:4px;min-height:40px}
.sw-gov-lane-item{padding:6px 10px;border-radius:6px;border:1px solid var(--border-0);background:var(--bg-2);
  font-size:11px;color:var(--tx-1);cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:6px}
.sw-gov-lane-item:hover{border-color:var(--border-2);background:var(--bg-3)}
.sw-gov-propagation{display:flex;flex-direction:column;gap:6px}
.sw-gov-prop-row{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;
  border:1px solid var(--border-0);background:var(--bg-0);font-size:11px}
.sw-gov-prop-arrow{color:var(--tx-3);font-size:10px;padding:0 4px}
.sw-gov-adopt-row{display:flex;align-items:center;gap:8px;padding:6px 10px;font-size:11px;color:var(--tx-1)}
.sw-gov-adopt-bar{flex:1;height:4px;border-radius:2px;background:var(--border-0);overflow:hidden}
.sw-gov-adopt-fill{height:100%;border-radius:2px;background:var(--teal);transition:width .3s}
.sw-gov-timeline{position:relative;padding-left:20px}
.sw-gov-timeline::before{content:'';position:absolute;left:14px;top:0;bottom:0;width:1px;background:var(--border-0)}
.sw-gov-tl-node{position:relative;padding:6px 0 14px 16px}
.sw-gov-tl-dot{position:absolute;left:-8px;top:8px;width:9px;height:9px;border-radius:50%}
.sw-gov-tl-dot.current{background:var(--teal);box-shadow:0 0 6px rgba(62,201,176,.3)}
.sw-gov-tl-dot.past{background:transparent;border:2px solid var(--tx-3)}
.sw-gov-activity{display:flex;flex-direction:column;gap:6px}
.sw-gov-activity-item{display:flex;align-items:flex-start;gap:10px;padding:6px 10px;border-radius:6px;
  font-size:11px;color:var(--tx-1);transition:background .1s}
.sw-gov-activity-item:hover{background:var(--bg-3)}
.sw-gov-activity-time{font-size:10px;font-family:var(--mono);color:var(--tx-3);flex-shrink:0;min-width:60px}
.sw-gov-empty{padding:20px;text-align:center;font-size:12px;color:var(--tx-3);border:1px dashed var(--border-1);border-radius:8px}

/* ── Schema Workbench Responsive ── */
@media(max-width:900px){
  .sw-forms-split{flex-direction:column}
  .sw-forms-list{width:100%;min-width:100%;max-height:240px;border-right:none;border-bottom:1px solid var(--border-0)}
  .sw-dict-grid{grid-template-columns:1fr}
  .sw-tabs{overflow-x:auto;gap:0}
  .sw-tab{padding:10px 14px;font-size:11px;white-space:nowrap}
}
@media(max-width:600px){
  .sw-header{padding:10px 16px 0}
  .sw-canvas-inner{padding:14px 16px}
  .sw-tabs{padding:0 16px}
  .sw-forms-editor{padding:14px 16px}
  .sw-cols-table-wrap{font-size:10px}
}

/* ── Field picker for FormBuilder ── */
.fp-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:45;display:flex;align-items:center;justify-content:center}
.fp-modal{background:var(--bg-1);border:1px solid var(--border-1);border-radius:var(--r-lg);width:500px;max-width:90vw;max-height:80vh;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,.5);display:flex;flex-direction:column;animation:fadeUp .2s ease both}
.fp-header{padding:14px 18px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;justify-content:space-between}
.fp-search{padding:8px 14px;border-bottom:1px solid var(--border-0)}
.fp-search input{width:100%;padding:8px 12px;border-radius:var(--r);border:1px solid var(--border-0);background:var(--bg-2);color:var(--tx-0);font-size:12px;outline:none}
.fp-search input:focus{border-color:var(--teal)}
.fp-list{flex:1;overflow-y:auto;padding:6px 0}
.fp-item{padding:10px 18px;cursor:pointer;border-bottom:1px solid var(--border-0);transition:background .12s;display:flex;align-items:center;gap:10px}
.fp-item:hover{background:var(--bg-3)}
.fp-item-info{flex:1;min-width:0}
.fp-item-label{font-size:13px;font-weight:500;color:var(--tx-0)}
.fp-item-def{font-size:10.5px;color:var(--tx-2);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fp-item-meta{display:flex;gap:4px;flex-shrink:0}

/* ═══ Notification System ═══ */
.notif-bell{position:relative;background:none;border:none;color:var(--tx-1);cursor:pointer;padding:4px;border-radius:6px;transition:all .15s;display:flex;align-items:center;justify-content:center}
.notif-bell:hover{background:var(--bg-3);color:var(--tx-0)}
.notif-badge{position:absolute;top:-2px;right:-2px;min-width:14px;height:14px;border-radius:7px;background:var(--teal);color:var(--bg-0);font-size:8px;font-weight:700;font-family:var(--mono);display:flex;align-items:center;justify-content:center;padding:0 3px;line-height:1;pointer-events:none}
.notif-dropdown{position:absolute;top:100%;right:0;margin-top:6px;width:340px;max-height:420px;background:var(--bg-1);border:1px solid var(--border-1);border-radius:var(--r-lg);box-shadow:0 12px 40px rgba(0,0,0,.4);z-index:100;overflow:hidden;animation:notifSlide .15s ease-out}
.notif-dropdown-hdr{padding:12px 14px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;justify-content:space-between}
.notif-dropdown-list{overflow-y:auto;max-height:340px}
.notif-item{padding:10px 14px;border-bottom:1px solid var(--border-0);cursor:pointer;transition:background .12s;display:flex;gap:10px;align-items:flex-start}
.notif-item:hover{background:var(--bg-3)}
.notif-item.unread{background:rgba(62,201,176,.04)}
.notif-item .notif-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.notif-item .notif-body{flex:1;min-width:0}
.notif-item .notif-title{font-size:12px;font-weight:500;color:var(--tx-0);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.notif-item .notif-desc{font-size:10.5px;color:var(--tx-2);margin-top:2px;line-height:1.4;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.notif-item .notif-time{font-size:9px;font-family:var(--mono);color:var(--tx-3);margin-top:3px}
.notif-empty{padding:32px 16px;text-align:center;color:var(--tx-3);font-size:12px}
.si-filter-bar{display:flex;gap:4px;padding:6px 12px;border-bottom:1px solid var(--border-0)}
.si-filter-btn{padding:4px 10px;border-radius:12px;border:1px solid var(--border-0);background:transparent;color:var(--tx-2);font-size:10px;font-family:var(--mono);font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap}
.si-filter-btn:hover{border-color:var(--border-2);color:var(--tx-1)}
.si-filter-btn.active{background:var(--teal-dim);border-color:var(--teal);color:var(--teal)}
.nav-badge{margin-left:auto;min-width:16px;height:16px;border-radius:8px;font-size:9px;font-weight:700;font-family:var(--mono);display:flex;align-items:center;justify-content:center;padding:0 4px;line-height:1}
.nav-badge-gold{background:var(--gold);color:var(--bg-0)}
.nav-badge-teal{background:rgba(62,201,176,.15);color:var(--teal)}
.nav-badge-blue{background:rgba(91,156,245,.15);color:var(--blue)}
.nav-badge-purple{background:rgba(167,139,250,.15);color:var(--purple)}
/* ═══ Action Log ═══ */
.choreo-op-row:hover{border-color:var(--border-1)!important}
@media(max-width:900px){
  .choreo-triad-card{padding:10px!important}
}
@media(max-width:700px){
  .choreo-op-row [style*="gridTemplateColumns: 100px"]{grid-template-columns:1fr!important}
}

/* ═══ Data Table (dt-*) ═══ */
.dt-wrap{border-radius:var(--r-lg);overflow:hidden;border:1px solid var(--border-0);background:var(--bg-1)}
.dt-scroll{overflow-x:auto}
table.dt{width:100%;border-collapse:collapse;font-size:13px}
table.dt thead tr{background:var(--bg-2);border-bottom:2px solid var(--border-0)}
table.dt th{padding:10px 12px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--tx-2);cursor:pointer;user-select:none;white-space:nowrap;border-right:1px solid var(--border-0)}
table.dt th:hover{color:var(--tx-0)}
table.dt td{padding:10px 12px;border-bottom:1px solid var(--border-0);border-right:1px solid var(--bg-2);vertical-align:middle}
table.dt tr.dt-row:hover{background:var(--bg-2)}
table.dt tr.dt-row.selected{background:var(--green-dim)}
table.dt tr.dt-row.revoked{opacity:.55}
table.dt tr.dt-grp{background:var(--bg-3);cursor:pointer}
table.dt tr.dt-grp td{padding:9px 12px;font-size:12px;font-weight:700;color:var(--tx-0);border-bottom:1px solid var(--border-0)}
.dt-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.dt-search{padding:8px 14px;border-radius:var(--r);border:1px solid var(--border-1);background:var(--bg-1);font-size:13px;color:var(--tx-0);outline:none;font-family:var(--sans);width:240px}
.dt-search:focus{border-color:var(--gold)}
.dt-search::placeholder{color:var(--tx-3)}
.dt-toolbar-right{margin-left:auto;font-size:12px;color:var(--tx-2)}
.dt-dd-wrap{position:relative}
.dt-dd{position:absolute;top:calc(100% + 4px);left:0;z-index:200;background:var(--bg-1);border:1px solid var(--border-0);border-radius:var(--r-lg);box-shadow:0 8px 32px rgba(0,0,0,.25);padding:6px;min-width:200px;max-height:340px;overflow-y:auto}
.dt-dd-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--tx-2);padding:4px 8px 6px}
.dt-dd-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:var(--r);cursor:pointer;font-size:13px;color:var(--tx-0)}
.dt-dd-item:hover{background:var(--bg-3)}
.dt-dd-item.sel{background:var(--green-dim);color:var(--green);font-weight:600}
.dt-check{width:15px;height:15px;border-radius:4px;border:1.5px solid var(--border-2);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:10px;color:#fff}
.dt-check.on{background:var(--green);border-color:var(--green)}
.dt-disc{display:flex;gap:2px;align-items:center}
.dt-disc .seg{width:5px;height:12px;border-radius:2px;background:var(--border-1)}
.dt-disc .seg.on{background:var(--green)}
.dt-disc .pct{font-size:10px;color:var(--tx-2);margin-left:4px;font-variant-numeric:tabular-nums}
.dt-util{display:flex;align-items:center;gap:6px}
.dt-util-track{width:48px;height:6px;border-radius:3px;background:var(--border-1);overflow:hidden}
.dt-util-fill{height:100%;border-radius:3px;transition:width .3s}
.dt-util-label{font-size:11px;font-weight:600;font-variant-numeric:tabular-nums}
.dt-locked{display:inline-flex;align-items:center;gap:4px;color:var(--tx-3);font-size:11px;font-style:italic}
.dt-editable{border-bottom:1px dashed var(--border-2);padding-bottom:1px;cursor:pointer}
.dt-editable:hover{border-color:var(--green)}
.dt-edit-input{width:100%;padding:2px 5px;font-size:13px;border:1.5px solid var(--green);border-radius:4px;background:var(--bg-1);outline:none;font-family:var(--sans);color:var(--tx-0)}
.dt-eo{font-family:var(--mono);font-size:10px;font-weight:500;padding:1px 5px;border-radius:4px;background:var(--bg-3);color:var(--tx-1);letter-spacing:.04em;display:inline-flex;align-items:center}
.dt-room{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:5px;background:var(--bg-3);font-size:10px;font-family:var(--mono);color:var(--tx-2)}
/* Panel */
.dt-panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:290}
.dt-panel{position:fixed;top:0;right:0;bottom:0;width:520px;max-width:90vw;background:var(--bg-1);border-left:1px solid var(--border-0);box-shadow:-6px 0 30px rgba(0,0,0,.15);z-index:300;display:flex;flex-direction:column;overflow:hidden;animation:slideInRight .2s ease both}
.dt-panel-head{padding:18px 22px;border-bottom:1px solid var(--border-0);display:flex;justify-content:space-between;align-items:flex-start;background:var(--bg-2)}
.dt-panel-head h2{font-size:18px;font-weight:700;margin:0}
.dt-panel-tabs{display:flex;border-bottom:1px solid var(--border-0);background:var(--bg-1)}
.dt-panel-tab{padding:9px 16px;font-size:12px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--tx-2);border-bottom:2px solid transparent;margin-bottom:-1px;font-family:var(--sans)}
.dt-panel-tab.active{color:var(--green);border-bottom-color:var(--green)}
.dt-panel-tab:hover:not(.active){color:var(--tx-0)}
.dt-panel-body{flex:1;overflow-y:auto;padding:18px 22px}
.dt-field-grid{display:grid;grid-template-columns:95px 1fr;gap:7px 10px;font-size:13px;margin-bottom:16px}
.dt-field-key{color:var(--tx-2);font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.05em;padding-top:2px}
.dt-gm{padding:11px 14px;border-radius:var(--r);background:var(--bg-3);border:1px solid var(--border-0);margin-bottom:14px;font-size:12px;color:var(--tx-1);line-height:1.5}
.dt-gm .g{color:var(--teal);font-weight:600}.dt-gm .m{color:var(--gold);font-weight:600}
.dt-note{padding:12px 14px;border-radius:var(--r);border:1px solid var(--border-0);margin-bottom:8px;position:relative}
.dt-note.shared{background:var(--bg-1);border-left:3px solid var(--green)}
.dt-note.internal{background:var(--bg-2);border-left:3px solid var(--gold)}
.dt-note-meta{display:flex;gap:8px;align-items:center;font-size:11px;color:var(--tx-2);margin-bottom:6px;flex-wrap:wrap}
.dt-note-text{font-size:13px;color:var(--tx-0);line-height:1.5}
.dt-note-tags{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.dt-note-tag{font-size:10px;padding:1px 6px;border-radius:6px;background:var(--bg-3);color:var(--tx-2)}
.dt-alloc{padding:14px;border-radius:var(--r);border:1px solid var(--border-0);background:var(--bg-1);margin-bottom:8px}
.dt-alloc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.dt-alloc-title{font-size:14px;font-weight:600}
.dt-alloc-detail{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;color:var(--tx-1)}
.dt-alloc-events{margin-top:10px;padding-top:10px;border-top:1px solid var(--border-0)}
/* ═══ Definition Popup Panel (slide from right) ═══ */
.def-popup-overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:290;animation:fadeIn .15s ease both}
.def-popup{position:fixed;top:0;right:0;bottom:0;width:440px;max-width:92vw;background:var(--bg-1);border-left:1px solid var(--border-0);box-shadow:-8px 0 32px rgba(0,0,0,.2);z-index:300;display:flex;flex-direction:column;overflow:hidden;animation:slideInRight .2s ease both}
.def-popup-head{padding:18px 22px 14px;border-bottom:1px solid var(--border-0);background:var(--bg-2);display:flex;justify-content:space-between;align-items:flex-start}
.def-popup-head h3{font-size:17px;font-weight:700;margin:0;font-family:var(--serif)}
.def-popup-close{background:none;border:none;cursor:pointer;color:var(--tx-2);font-size:18px;padding:2px 6px;border-radius:4px;transition:all .15s}
.def-popup-close:hover{background:var(--bg-3);color:var(--tx-0)}
.def-popup-body{flex:1;overflow-y:auto;padding:18px 22px}
.def-popup-section{margin-bottom:16px}
.def-popup-section-label{font-size:10px;font-family:var(--mono);color:var(--tx-1);letter-spacing:.07em;font-weight:600;margin-bottom:6px;display:block;text-transform:uppercase}
.def-popup-wiki{padding:12px 14px;border-radius:var(--r);background:var(--bg-2);border:1px solid var(--border-0);font-size:12.5px;line-height:1.6;color:var(--tx-1)}
.def-popup-wiki-label{font-size:10px;font-family:var(--mono);font-weight:600;color:var(--purple);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.def-popup-wiki-desc{margin-bottom:8px}
.def-popup-wiki-link{font-size:11px;color:var(--blue);text-decoration:none}
.def-popup-wiki-link:hover{text-decoration:underline}
.def-popup-loading{display:flex;align-items:center;gap:8px;color:var(--tx-2);font-size:12px;padding:10px 0}
.def-popup-loading::before{content:'';width:14px;height:14px;border:2px solid var(--border-1);border-top-color:var(--purple);border-radius:50%;animation:spin .6s linear infinite}
.dt-alloc-event{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--tx-1);padding:3px 0}
.dt-alloc-event .dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.dt-prov{display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--border-0);font-size:12px}
.dt-prov:last-child{border-bottom:none}
.dt-prov-icon{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.dt-cap{display:flex;gap:20px;margin-bottom:16px}
.dt-cap-box{padding:10px 14px;border-radius:var(--r);background:var(--bg-3);border:1px solid var(--border-0);flex:1;text-align:center}
.dt-cap-box .num{font-size:22px;font-weight:700}
.dt-cap-box .lbl{font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--tx-2)}.dt-hint{margin-top:8px;padding:10px 12px;border-radius:var(--r);background:var(--gold-dim);border:1px solid var(--gold-mid);font-size:12px;color:var(--tx-1);line-height:1.5}
/* ═══ Collapsible Sidebar ═══ */
.app-sidebar{transition:width .25s ease,min-width .25s ease,opacity .2s ease}
.app-sidebar.collapsed{width:0!important;min-width:0!important;overflow:hidden;opacity:0;border-right:none!important;padding:0!important}
.sidebar-toggle-btn{position:absolute;top:12px;left:12px;z-index:10;width:32px;height:32px;border-radius:var(--r);background:var(--bg-2);border:1px solid var(--border-1);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--tx-1);transition:all .18s;opacity:0;pointer-events:none}
.sidebar-toggle-btn:hover{background:var(--bg-3);border-color:var(--gold);color:var(--gold)}
.sidebar-collapsed-show .sidebar-toggle-btn{opacity:1;pointer-events:auto}
.sidebar-collapse-btn{width:28px;height:28px;border-radius:var(--r);background:transparent;border:1px solid var(--border-0);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--tx-2);transition:all .15s;flex-shrink:0}
.sidebar-collapse-btn:hover{background:var(--bg-3);border-color:var(--gold);color:var(--gold)}
/* ═══ Linked Records ═══ */
.linked-rec-chip{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:12px;font-size:10.5px;font-weight:600;font-family:var(--mono);cursor:pointer;transition:all .15s;border:1px solid var(--border-1);background:var(--bg-2);color:var(--tx-1);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.linked-rec-chip:hover{border-color:var(--purple);color:var(--purple);background:var(--purple-dim)}
.linked-rec-chip .lr-type{font-size:8px;padding:1px 4px;border-radius:6px;background:var(--purple-dim);color:var(--purple);font-weight:700;text-transform:uppercase;flex-shrink:0}
.linked-rec-add{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:12px;font-size:10px;cursor:pointer;border:1px dashed var(--border-2);background:transparent;color:var(--tx-2);transition:all .15s;font-family:var(--sans);font-weight:600}
.linked-rec-add:hover{border-color:var(--purple);color:var(--purple);background:var(--purple-dim)}
.linked-panel{border:1px solid var(--border-0);border-radius:var(--r-lg);background:var(--bg-2);padding:14px;margin-top:12px}
.linked-panel-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.lr-record-card{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border-0);border-radius:var(--r);background:var(--bg-1);cursor:pointer;transition:all .15s;margin-bottom:6px}
.lr-record-card:hover{border-color:var(--purple);transform:translateX(2px)}
.lr-record-card .lr-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}
.lr-record-card .lr-info{flex:1;min-width:0}
.lr-record-card .lr-name{font-size:12.5px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lr-record-card .lr-meta{font-size:10px;color:var(--tx-2)}
.lr-record-card .lr-type-badge{font-size:8.5px;padding:2px 6px;border-radius:8px;font-weight:700;font-family:var(--mono);text-transform:uppercase;flex-shrink:0}
/* ═══ Database View ═══ */
.db-view{max-width:1300px;margin:0 auto}
.db-view.db-full-width{max-width:none}
.db-tabs{display:flex;gap:0;border-bottom:2px solid var(--border-0);margin-bottom:18px}
.db-tab{padding:10px 20px;font-size:13px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--tx-2);border-bottom:2px solid transparent;margin-bottom:-2px;font-family:var(--sans);transition:all .15s;display:flex;align-items:center;gap:6px}
.db-tab.active{color:var(--gold);border-bottom-color:var(--gold)}
.db-tab:hover:not(.active){color:var(--tx-0);background:var(--bg-2);border-radius:var(--r) var(--r) 0 0}
.db-tab .db-tab-count{font-size:10px;padding:1px 6px;border-radius:8px;background:var(--bg-3);color:var(--tx-2);font-family:var(--mono)}
.db-tab.active .db-tab-count{background:var(--gold-dim);color:var(--gold)}
/* ═══ Enhanced DataTable: multi-select, drag ═══ */
table.dt th.dt-sel-col,table.dt td.dt-sel-col{width:32px;min-width:32px;max-width:32px;padding:6px 4px;text-align:center;border-right:1px solid var(--border-0)}
.dt-cb{width:15px;height:15px;border-radius:4px;border:1.5px solid var(--border-2);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .12s}
.dt-cb.checked{background:var(--gold);border-color:var(--gold);color:#fff}
.dt-cb.partial{background:var(--gold-dim);border-color:var(--gold)}
.dt-cb:hover{border-color:var(--gold)}
.dt-bulk-bar{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:var(--r-lg);background:var(--gold-dim);border:1px solid rgba(201,163,82,.2);margin-bottom:10px;animation:fadeIn .15s ease}
.dt-bulk-bar .dt-bulk-count{font-size:12px;font-weight:700;color:var(--gold);font-family:var(--mono)}
.dt-bulk-bar .dt-bulk-actions{display:flex;gap:4px;margin-left:auto}
table.dt tr.dt-row.dragging{opacity:.4;background:var(--bg-3)}
table.dt tr.dt-row.drag-over{border-top:2px solid var(--gold);background:var(--gold-dim)}
table.dt td.dt-drag-handle{width:24px;min-width:24px;max-width:24px;padding:0 4px;cursor:grab;color:var(--tx-3);text-align:center;user-select:none}
table.dt td.dt-drag-handle:active{cursor:grabbing}
/* ═══ Editable cells ═══ */
.dt-ecell{cursor:pointer;border-bottom:1px dashed transparent;padding-bottom:1px;transition:all .12s;min-height:20px}
.dt-ecell:hover{border-bottom-color:var(--gold-dim)}
.dt-ecell.editing{border-bottom-color:var(--gold)}
.dt-ecell-input{width:100%;padding:2px 4px;font-size:13px;border:1.5px solid var(--gold);border-radius:3px;background:var(--bg-1);outline:none;font-family:var(--sans);color:var(--tx-0)}
.dt-ecell-input:focus{box-shadow:0 0 0 2px var(--gold-dim)}
/* ═══ Inline add row ═══ */
.dt-add-row{padding:8px 12px;color:var(--tx-3);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px;border-top:1px dashed var(--border-0);transition:all .15s}
.dt-add-row:hover{background:var(--gold-dim);color:var(--gold)}
/* ═══ Notes ═══ */
.note-card{padding:14px 16px;border-radius:var(--r-lg);border:1px solid var(--border-0);background:var(--bg-1);margin-bottom:8px;transition:border-color .15s;cursor:pointer}
.note-card:hover{border-color:var(--gold)}
.note-card.attached{border-left:3px solid var(--green)}
.note-card.standalone{border-left:3px solid var(--blue)}
.note-card.tombstoned{opacity:.5;border-left-color:var(--red);background:var(--red-dim)}
.note-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
.note-title{font-size:14px;font-weight:600;color:var(--tx-0)}
.note-meta{font-size:10px;color:var(--tx-2);font-family:var(--mono)}
.note-body{font-size:12.5px;color:var(--tx-1);line-height:1.55;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}
.note-tags{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
.note-tag-chip{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--purple-dim);color:var(--purple);font-weight:600;display:flex;align-items:center;gap:3px}
.note-attached-to{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--green-dim);color:var(--green);font-weight:600}
/* ═══ Note Edit & Diff ═══ */
.note-diff{margin:6px 0;font-size:12.5px;line-height:1.7;white-space:pre-wrap}
.note-diff-del{text-decoration:line-through;color:var(--red);background:var(--red-dim);padding:1px 4px;border-radius:3px}
.note-diff-ins{color:var(--green);background:var(--green-dim);padding:1px 4px;border-radius:3px}
.note-edit-history{margin-top:16px;border-top:1px solid var(--border-0);padding-top:12px}
.note-edit-entry{margin-bottom:10px;padding:10px 14px;border-radius:var(--r);background:var(--bg-2);border:1px solid var(--border-0)}
.note-edit-entry-meta{font-size:10px;color:var(--tx-2);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.note-edit-entry-field{font-size:10px;font-weight:600;color:var(--tx-3);margin-bottom:3px;text-transform:uppercase;letter-spacing:.4px}
/* ═══ Profile pages ═══ */
.profile-page{max-width:1000px;margin:0 auto}
.profile-header{display:flex;align-items:flex-start;gap:16px;margin-bottom:24px}
.profile-avatar{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:#fff;flex-shrink:0}
.profile-info{flex:1;min-width:0}
.profile-name{font-family:var(--serif);font-size:22px;font-weight:700;margin-bottom:4px}
.profile-badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
/* ═══ Connection / Identity Badges ═══ */
.conn-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:10px;font-size:9px;font-weight:600;font-family:var(--mono);letter-spacing:.02em;white-space:nowrap;line-height:1.4}
.conn-badge-client{background:var(--teal-dim);color:var(--teal)}
.conn-badge-provider{background:var(--gold-dim);color:var(--gold)}
.conn-badge-org{background:var(--blue-dim);color:var(--blue)}
.conn-badge-team{background:var(--purple-dim);color:var(--purple)}
.conn-badge-network{background:var(--green-dim);color:var(--green)}
.conn-badge-admin{background:var(--orange-dim);color:var(--orange)}
.conn-badges{display:inline-flex;gap:4px;flex-wrap:wrap;align-items:center}
.profile-tabs{display:flex;border-bottom:2px solid var(--border-0);margin-bottom:20px}
.profile-tab{padding:9px 18px;font-size:12.5px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--tx-2);border-bottom:2px solid transparent;margin-bottom:-2px;font-family:var(--sans);transition:all .15s}
.profile-tab.active{color:var(--green);border-bottom-color:var(--green)}
.profile-tab:hover:not(.active){color:var(--tx-0)}
.profile-section{margin-bottom:24px}
.profile-section-title{font-size:11px;font-family:var(--mono);color:var(--tx-2);letter-spacing:.07em;font-weight:600;margin-bottom:10px;text-transform:uppercase}
.profile-fields-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.profile-field-card{padding:12px 14px;border-radius:var(--r);border:1px solid var(--border-0);background:var(--bg-2)}
.profile-field-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--tx-2);margin-bottom:4px}
.profile-field-value{font-size:14px;font-weight:500;color:var(--tx-0)}
/* ═══ Tombstone display ═══ */
.tombstone-notice{padding:14px 16px;border-radius:var(--r);background:var(--red-dim);border:1px solid rgba(232,93,93,.15);display:flex;align-items:center;gap:10px;font-size:12px;color:var(--red)}
/* ═══ Personal Dashboard ═══ */
.pd-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:24px}
.pd-stat{padding:14px;cursor:default}
.pd-stat .num{font-size:22px;font-weight:700}.pd-stat .lbl{font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--tx-2);margin-top:2px}
.pd-section{margin-bottom:28px}
.pd-section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.pd-section-hdr h3{font-family:var(--serif);font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
.pd-event{display:flex;gap:12px;padding:12px 14px;border-radius:var(--r);border:1px solid var(--border-0);background:var(--bg-2);transition:border-color .15s}
.pd-event:hover{border-color:var(--gold)}
.pd-event-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.pd-event-body{flex:1;min-width:0}
.pd-event-title{font-size:12.5px;font-weight:600;margin-bottom:2px}
.pd-event-desc{font-size:11px;color:var(--tx-2);line-height:1.4;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.pd-event-meta{display:flex;align-items:center;gap:8px;margin-top:4px}
.pd-event-time{font-size:9px;color:var(--tx-3);font-family:var(--mono)}
.pd-content-card{padding:14px 18px;border-radius:var(--r);border:1px solid var(--border-0);background:var(--bg-2);transition:border-color .15s}
.pd-content-card:hover{border-color:var(--teal)}
.pd-res-card{padding:12px 16px;border-radius:var(--r);border:1px solid var(--border-0);background:var(--bg-2);display:flex;align-items:center;justify-content:space-between;transition:border-color .15s}
.pd-res-card:hover{border-color:var(--green)}
.pd-empty{text-align:center;padding:30px 20px;border:1px dashed var(--border-1);border-radius:var(--r);color:var(--tx-3)}
/* ═══ Personal Dashboard — enhanced ═══ */
.pd-two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:28px}
.pd-vault-snap{padding:16px 18px;border-radius:var(--r);border:1px solid var(--border-0);background:var(--bg-2)}
.pd-vault-snap .vault-progress-bar{height:5px;border-radius:3px;background:var(--bg-4);margin:10px 0 14px}
.pd-vault-snap .vault-progress-fill{height:100%;border-radius:3px;background:var(--teal);transition:width .4s ease}
.pd-vault-field-row{display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border-0)}
.pd-vault-field-row:last-child{border-bottom:none}
.pd-vault-field-key{font-size:11px;color:var(--tx-2);font-family:var(--mono);min-width:90px}
.pd-vault-field-val{font-size:12px;font-weight:500;color:var(--tx-0);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:160px}
.pd-vault-field-empty{font-size:11px;color:var(--tx-3);font-style:italic;text-align:right}
.pd-team-card{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--r);border:1px solid var(--border-0);background:var(--bg-2);cursor:pointer;transition:border-color .15s,background .15s;margin-bottom:6px}
.pd-team-card:hover{border-color:var(--purple);background:var(--bg-3)}
.pd-team-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.pd-team-name{font-size:12.5px;font-weight:600;flex:1}
.pd-team-meta{font-size:10px;color:var(--tx-3);font-family:var(--mono)}
.pd-msg-row{display:flex;gap:10px;padding:10px 14px;border-radius:var(--r);border:1px solid var(--border-0);background:var(--bg-2);cursor:pointer;transition:border-color .15s;margin-bottom:6px}
.pd-msg-row:hover{border-color:var(--blue)}
.pd-msg-sender{font-size:12px;font-weight:600;margin-bottom:2px}
.pd-msg-preview{font-size:11px;color:var(--tx-2);overflow:hidden;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical}
.pd-msg-time{font-size:9px;color:var(--tx-3);font-family:var(--mono);margin-top:2px}
@media(max-width:700px){.pd-two-col{grid-template-columns:1fr}}
/* ═══ EO Graph View ═══ */
.eo-graph-wrap{height:100%;display:flex;flex-direction:column;overflow:hidden}
.eo-graph-header{padding:14px 20px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;gap:12px;flex-shrink:0}
.eo-graph-breadcrumb{display:flex;align-items:center;gap:4px;font-size:12px;font-family:var(--mono)}
.eo-graph-breadcrumb .bc-seg{cursor:pointer;color:var(--teal);padding:2px 6px;border-radius:var(--r);transition:background .15s}
.eo-graph-breadcrumb .bc-seg:hover{background:var(--bg-4)}
.eo-graph-breadcrumb .bc-sep{color:var(--tx-3)}
.eo-graph-breadcrumb .bc-cur{color:var(--tx-0);font-weight:700;padding:2px 6px}
.eo-graph-canvas{flex:1;overflow:auto;position:relative}
.eo-graph-svg{width:100%;height:100%;min-height:500px}
.eo-node{cursor:pointer;transition:transform .2s}
.eo-node:hover .eo-node-bg{filter:brightness(1.2)}
.eo-node-bg{rx:12;ry:12;transition:filter .2s}
.eo-edge{stroke:var(--border-1);stroke-width:1.5;fill:none;opacity:.6;transition:opacity .2s}
.eo-edge:hover{opacity:1;stroke-width:2}
.eo-edge-arrow{fill:var(--border-1);opacity:.6}
.eo-graph-detail{position:absolute;top:16px;right:16px;width:320px;max-height:calc(100% - 32px);overflow:auto;background:var(--bg-1);border:1px solid var(--border-1);border-radius:var(--r-lg);box-shadow:0 8px 32px rgba(0,0,0,.3);z-index:10}
.eo-graph-detail .detail-head{padding:14px 16px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;gap:10px}
.eo-graph-detail .detail-body{padding:14px 16px;font-size:12px;line-height:1.7;color:var(--tx-1)}
.eo-graph-detail .detail-ops{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
.eo-graph-detail .detail-children{margin-top:10px}
.eo-graph-detail .detail-child{padding:8px 10px;margin-bottom:4px;border:1px solid var(--border-0);border-radius:var(--r);cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .15s}
.eo-graph-detail .detail-child:hover{background:var(--bg-3)}
.eo-graph-legend{padding:10px 20px;border-top:1px solid var(--border-0);display:flex;align-items:center;gap:16px;flex-shrink:0;font-size:11px;color:var(--tx-2)}
.eo-graph-legend .leg-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
@media(max-width:700px){
  .eo-graph-detail{width:100%;right:0;top:auto;bottom:0;max-height:50%;border-radius:var(--r-lg) var(--r-lg) 0 0}
}

/* ═══ Transparency Page ═══ */
@media(max-width:700px){
  .tp-source-split{flex-direction:column!important;height:auto!important;min-height:auto!important}
  .tp-source-nav{width:100%!important;min-width:100%!important;max-height:200px;border-right:none!important;border-bottom:1px solid var(--border-0)}
}
</style>
</head>
<body>
<div class="beta-banner"><svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Beta — All data should be backed up independently. Export your data from the Database tab. This software is under active development.</div>
<div id="root" style="margin-top:32px">
<!-- Canvas splash: rotating dodecahedron, replaced when React mounts -->
<div id="splash" style="height:100%;display:flex;align-items:center;justify-content:center;background:#08090b;flex-direction:column;gap:18px">
<style>
#splash .sp-title{font-family:'Manrope',system-ui,sans-serif;font-size:18px;font-weight:700;color:#e6e9f0;letter-spacing:.02em}
#splash .sp-sub{font-family:'IBM Plex Mono',monospace;font-size:12px;color:#6b7385;letter-spacing:.04em}
</style>
<canvas id="sp-dodeca" width="140" height="140"></canvas>
<div class="sp-title">Khora</div>
<div class="sp-sub">Loading&hellip;</div>
<script>
(function(){
  var c=document.getElementById('sp-dodeca');
  if(!c)return;
  var ctx=c.getContext('2d'),W=140,H=140,phi=(1+Math.sqrt(5))/2,ip=1/phi;
  var V=[
    [-1,-1,-1],[-1,-1,1],[-1,1,-1],[-1,1,1],[1,-1,-1],[1,-1,1],[1,1,-1],[1,1,1],
    [0,-ip,-phi],[0,-ip,phi],[0,ip,-phi],[0,ip,phi],
    [-ip,-phi,0],[-ip,phi,0],[ip,-phi,0],[ip,phi,0],
    [-phi,0,-ip],[-phi,0,ip],[phi,0,-ip],[phi,0,ip]
  ];
  var edges=[];
  var thr=2/phi+0.01;
  for(var i=0;i<20;i++)for(var j=i+1;j<20;j++){
    var dx=V[i][0]-V[j][0],dy=V[i][1]-V[j][1],dz=V[i][2]-V[j][2];
    if(Math.sqrt(dx*dx+dy*dy+dz*dz)<thr)edges.push([i,j]);
  }
  var ax=0.3,ay=0.5;
  function draw(){
    if(!document.getElementById('sp-dodeca'))return;
    ctx.clearRect(0,0,W,H);
    ax+=0.003;ay+=0.005;
    var sa=Math.sin(ax),ca=Math.cos(ax),sb=Math.sin(ay),cb=Math.cos(ay);
    var P=V.map(function(v){
      var y1=v[1]*ca-v[2]*sa,z1=v[1]*sa+v[2]*ca;
      var x2=v[0]*cb-z1*sb,z2=v[0]*sb+z1*cb;
      var s=38;
      return[W/2+x2*s,H/2+y1*s,z2];
    });
    edges.forEach(function(e){
      var a=P[e[0]],b=P[e[1]];
      var dz=(a[2]+b[2])/2;
      var op=0.25+0.55*((dz+2)/4);
      ctx.beginPath();ctx.moveTo(a[0],a[1]);ctx.lineTo(b[0],b[1]);
      ctx.strokeStyle='rgba(176,144,212,'+op+')';ctx.lineWidth=1;ctx.stroke();
    });
    P.forEach(function(p){
      var op=0.3+0.5*((p[2]+2)/4);
      ctx.beginPath();ctx.arc(p[0],p[1],1.5,0,6.283);
      ctx.fillStyle='rgba(212,184,240,'+op+')';ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
})();
</script>
</div>
</div>
<script>
const {
  useState,
  useEffect,
  useRef,
  useCallback,
  useMemo
} = React;

/* ═══════════════════ ICONS ═══════════════════ */
const I = ({
  n,
  s = 17,
  c
}) => {
  const p = {
    width: s,
    height: s,
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: c || "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  };
  const d = {
    lock: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("rect", {
      x: "3",
      y: "11",
      width: "18",
      height: "11",
      rx: "2"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M7 11V7a5 5 0 0 1 10 0v4"
    })),
    unlock: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("rect", {
      x: "3",
      y: "11",
      width: "18",
      height: "11",
      rx: "2"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M7 11V7a5 5 0 0 1 9.9-1"
    })),
    shield: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
    })),
    shieldCheck: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M9 12l2 2 4-4"
    })),
    users: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "9",
      cy: "7",
      r: "4"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M23 21v-2a4 4 0 0 0-3-3.87"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M16 3.13a4 4 0 0 1 0 7.75"
    })),
    user: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "12",
      cy: "7",
      r: "4"
    })),
    briefcase: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("rect", {
      x: "2",
      y: "7",
      width: "20",
      height: "14",
      rx: "2"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"
    })),
    plus: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("line", {
      x1: "12",
      y1: "5",
      x2: "12",
      y2: "19"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "5",
      y1: "12",
      x2: "19",
      y2: "12"
    })),
    x: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("line", {
      x1: "18",
      y1: "6",
      x2: "6",
      y2: "18"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "6",
      y1: "6",
      x2: "18",
      y2: "18"
    })),
    check: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", {
      points: "20 6 9 17 4 12"
    })),
    search: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("circle", {
      cx: "11",
      cy: "11",
      r: "8"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "21",
      y1: "21",
      x2: "16.65",
      y2: "16.65"
    })),
    share: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("circle", {
      cx: "18",
      cy: "5",
      r: "3"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "6",
      cy: "12",
      r: "3"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "18",
      cy: "19",
      r: "3"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "8.59",
      y1: "13.51",
      x2: "15.42",
      y2: "17.49"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "15.41",
      y1: "6.51",
      x2: "8.59",
      y2: "10.49"
    })),
    key: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"
    })),
    eye: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "12",
      cy: "12",
      r: "3"
    })),
    eyeOff: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "1",
      y1: "1",
      x2: "23",
      y2: "23"
    })),
    send: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("line", {
      x1: "22",
      y1: "2",
      x2: "11",
      y2: "13"
    }), /*#__PURE__*/React.createElement("polygon", {
      points: "22 2 15 22 11 13 2 9 22 2"
    })),
    trash: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", {
      points: "3 6 5 6 21 6"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
    })),
    file: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
    }), /*#__PURE__*/React.createElement("polyline", {
      points: "14 2 14 8 20 8"
    })),
    folder: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
    })),
    home: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"
    }), /*#__PURE__*/React.createElement("polyline", {
      points: "9 22 9 12 15 12 15 22"
    })),
    back: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", {
      points: "15 18 9 12 15 6"
    })),
    chevR: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", {
      points: "9 18 15 12 9 6"
    })),
    logout: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"
    }), /*#__PURE__*/React.createElement("polyline", {
      points: "16 17 21 12 16 7"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "21",
      y1: "12",
      x2: "9",
      y2: "12"
    })),
    settings: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("circle", {
      cx: "12",
      cy: "12",
      r: "3"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"
    })),
    alert: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "12",
      y1: "9",
      x2: "12",
      y2: "13"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "12",
      y1: "17",
      x2: "12.01",
      y2: "17"
    })),
    clock: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("circle", {
      cx: "12",
      cy: "12",
      r: "10"
    }), /*#__PURE__*/React.createElement("polyline", {
      points: "12 6 12 12 16 14"
    })),
    msg: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
    })),
    inbox: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", {
      points: "22 12 16 12 14 15 10 15 8 12 2 12"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"
    })),
    zap: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polygon", {
      points: "13 2 3 14 12 14 11 22 21 10 12 10 13 2"
    })),
    grid: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("rect", {
      x: "3",
      y: "3",
      width: "7",
      height: "7"
    }), /*#__PURE__*/React.createElement("rect", {
      x: "14",
      y: "3",
      width: "7",
      height: "7"
    }), /*#__PURE__*/React.createElement("rect", {
      x: "14",
      y: "14",
      width: "7",
      height: "7"
    }), /*#__PURE__*/React.createElement("rect", {
      x: "3",
      y: "14",
      width: "7",
      height: "7"
    })),
    globe: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("circle", {
      cx: "12",
      cy: "12",
      r: "10"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "2",
      y1: "12",
      x2: "22",
      y2: "12"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
    })),
    bar: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("line", {
      x1: "18",
      y1: "20",
      x2: "18",
      y2: "10"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "12",
      y1: "20",
      x2: "12",
      y2: "4"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "6",
      y1: "20",
      x2: "6",
      y2: "14"
    })),
    clipboard: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"
    }), /*#__PURE__*/React.createElement("rect", {
      x: "8",
      y: "2",
      width: "8",
      height: "4",
      rx: "1"
    })),
    link: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
    })),
    copy: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("rect", {
      x: "9",
      y: "9",
      width: "13",
      height: "13",
      rx: "2"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
    })),
    userPlus: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "8.5",
      cy: "7",
      r: "4"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "20",
      y1: "8",
      x2: "20",
      y2: "14"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "23",
      y1: "11",
      x2: "17",
      y2: "11"
    })),
    upload: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
    }), /*#__PURE__*/React.createElement("polyline", {
      points: "17 8 12 3 7 8"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "12",
      y1: "3",
      x2: "12",
      y2: "15"
    })),
    download: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
    }), /*#__PURE__*/React.createElement("polyline", {
      points: "7 10 12 15 17 10"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "12",
      y1: "15",
      x2: "12",
      y2: "3"
    })),
    sun: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("circle", {
      cx: "12",
      cy: "12",
      r: "5"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "12",
      y1: "1",
      x2: "12",
      y2: "3"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "12",
      y1: "21",
      x2: "12",
      y2: "23"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "4.22",
      y1: "4.22",
      x2: "5.64",
      y2: "5.64"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "18.36",
      y1: "18.36",
      x2: "19.78",
      y2: "19.78"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "1",
      y1: "12",
      x2: "3",
      y2: "12"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "21",
      y1: "12",
      x2: "23",
      y2: "12"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "4.22",
      y1: "19.78",
      x2: "5.64",
      y2: "18.36"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "18.36",
      y1: "5.64",
      x2: "19.78",
      y2: "4.22"
    })),
    moon: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
    })),
    'alert-triangle': /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "12",
      y1: "9",
      x2: "12",
      y2: "13"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "12",
      y1: "17",
      x2: "12.01",
      y2: "17"
    })),
    'refresh-cw': /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", {
      points: "23 4 23 10 17 10"
    }), /*#__PURE__*/React.createElement("polyline", {
      points: "1 20 1 14 7 14"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
    })),
    layers: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polygon", {
      points: "12 2 2 7 12 12 22 7 12 2"
    }), /*#__PURE__*/React.createElement("polyline", {
      points: "2 17 12 22 22 17"
    }), /*#__PURE__*/React.createElement("polyline", {
      points: "2 12 12 17 22 12"
    })),
    chevronDown: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", {
      points: "6 9 12 15 18 9"
    })),
    chevronRight: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", {
      points: "9 18 15 12 9 6"
    })),
    chevronLeft: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", {
      points: "15 18 9 12 15 6"
    })),
    gitBranch: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("line", {
      x1: "6",
      y1: "3",
      x2: "6",
      y2: "15"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "18",
      cy: "6",
      r: "3"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "6",
      cy: "18",
      r: "3"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M18 9a9 9 0 0 1-9 9"
    })),
    activity: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", {
      points: "22 12 18 12 15 21 9 3 6 12 2 12"
    })),
    menu: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("line", {
      x1: "3",
      y1: "12",
      x2: "21",
      y2: "12"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "3",
      y1: "6",
      x2: "21",
      y2: "6"
    }), /*#__PURE__*/React.createElement("line", {
      x1: "3",
      y1: "18",
      x2: "21",
      y2: "18"
    })),
    'more-v': /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("circle", {
      cx: "12",
      cy: "12",
      r: "1"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "12",
      cy: "5",
      r: "1"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "12",
      cy: "19",
      r: "1"
    })),
    bell: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"
    }), /*#__PURE__*/React.createElement("path", {
      d: "M13.73 21a2 2 0 0 1-3.46 0"
    })),
    filter: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polygon", {
      points: "22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"
    })),
    dice: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("rect", {
      x: "2",
      y: "2",
      width: "20",
      height: "20",
      rx: "4"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "8",
      cy: "8",
      r: "1.5",
      fill: "currentColor",
      stroke: "none"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "12",
      cy: "12",
      r: "1.5",
      fill: "currentColor",
      stroke: "none"
    }), /*#__PURE__*/React.createElement("circle", {
      cx: "16",
      cy: "16",
      r: "1.5",
      fill: "currentColor",
      stroke: "none"
    })),
    phone: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
    })),
    mail: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
    }), /*#__PURE__*/React.createElement("polyline", {
      points: "22,6 12,13 2,6"
    })),
    messageSquare: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
    })),
    dodeca: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", {
      d: "M12 1L22.46 8.6L18.47 20.9L5.53 20.9L1.54 8.6Z M14.94 7.95L16.76 13.55L12 17L7.24 13.55L9.06 7.95Z M12 1L14.94 7.95 M22.46 8.6L16.76 13.55 M18.47 20.9L12 17 M5.53 20.9L7.24 13.55 M1.54 8.6L9.06 7.95"
    })),
    graphNodes: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("circle", { cx: "12", cy: "5", r: "3" }), /*#__PURE__*/React.createElement("circle", { cx: "5", cy: "19", r: "3" }), /*#__PURE__*/React.createElement("circle", { cx: "19", cy: "19", r: "3" }), /*#__PURE__*/React.createElement("line", { x1: "12", y1: "8", x2: "5", y2: "16" }), /*#__PURE__*/React.createElement("line", { x1: "12", y1: "8", x2: "19", y2: "16" }), /*#__PURE__*/React.createElement("line", { x1: "8", y1: "19", x2: "16", y2: "19" })),
    'git-merge': /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("circle", { cx: "18", cy: "18", r: "3" }), /*#__PURE__*/React.createElement("circle", { cx: "6", cy: "6", r: "3" }), /*#__PURE__*/React.createElement("path", { d: "M6 21V9a9 9 0 0 0 9 9" })),
    edit: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("path", { d: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" }), /*#__PURE__*/React.createElement("path", { d: "M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" })),
    database: /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("ellipse", { cx: "12", cy: "5", rx: "9", ry: "3" }), /*#__PURE__*/React.createElement("path", { d: "M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" }), /*#__PURE__*/React.createElement("path", { d: "M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" })),
    'arr-l': /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", { points: "15 18 9 12 15 6" })),
    'arr-r': /*#__PURE__*/React.createElement("svg", p, /*#__PURE__*/React.createElement("polyline", { points: "9 18 15 12 9 6" }))
  };
  return /*#__PURE__*/React.createElement("span", {
    style: {
      display: 'inline-flex',
      alignItems: 'center',
      flexShrink: 0
    }
  }, d[n]);
};

/* ═══════════════════ SPINNING DODECA ICON ═══════════════════ */
const SpinningDodeca = ({ size = 32 }) => {
  const canvasRef = useRef(null);
  const animRef = useRef(null);
  const anglesRef = useRef({ ax: 0.3, ay: 0.5 });

  useEffect(() => {
    const c = canvasRef.current;
    if (!c) return;
    const ctx = c.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    c.width = size * dpr;
    c.height = size * dpr;
    ctx.scale(dpr, dpr);

    const phi = (1 + Math.sqrt(5)) / 2, ip = 1 / phi;
    const V = [
      [-1,-1,-1],[-1,-1,1],[-1,1,-1],[-1,1,1],[1,-1,-1],[1,-1,1],[1,1,-1],[1,1,1],
      [0,-ip,-phi],[0,-ip,phi],[0,ip,-phi],[0,ip,phi],
      [-ip,-phi,0],[-ip,phi,0],[ip,-phi,0],[ip,phi,0],
      [-phi,0,-ip],[-phi,0,ip],[phi,0,-ip],[phi,0,ip]
    ];
    const edges = [];
    const thr = 2 / phi + 0.01;
    for (let i = 0; i < 20; i++) for (let j = i + 1; j < 20; j++) {
      const dx = V[i][0]-V[j][0], dy = V[i][1]-V[j][1], dz = V[i][2]-V[j][2];
      if (Math.sqrt(dx*dx + dy*dy + dz*dz) < thr) edges.push([i, j]);
    }

    const draw = () => {
      const a = anglesRef.current;
      ctx.clearRect(0, 0, size, size);
      a.ax += 0.004; a.ay += 0.006;
      const light = document.documentElement.classList.contains('light');
      const edgeRgb = light ? '105,56,192' : '176,144,212';
      const vertRgb = light ? '130,80,200' : '212,184,240';
      const sa = Math.sin(a.ax), ca = Math.cos(a.ax), sb = Math.sin(a.ay), cb = Math.cos(a.ay);
      const P = V.map(v => {
        const y1 = v[1]*ca - v[2]*sa, z1 = v[1]*sa + v[2]*ca;
        const x2 = v[0]*cb - z1*sb, z2 = v[0]*sb + z1*cb;
        const s = size * 0.27;
        return [size/2 + x2*s, size/2 + y1*s, z2];
      });
      edges.forEach(e => {
        const ea = P[e[0]], eb = P[e[1]];
        const dz = (ea[2] + eb[2]) / 2;
        const op = 0.2 + 0.5 * ((dz + 2) / 4);
        ctx.beginPath(); ctx.moveTo(ea[0], ea[1]); ctx.lineTo(eb[0], eb[1]);
        ctx.strokeStyle = 'rgba(' + edgeRgb + ',' + op + ')'; ctx.lineWidth = 0.8; ctx.stroke();
      });
      P.forEach(p => {
        const op = 0.25 + 0.5 * ((p[2] + 2) / 4);
        ctx.beginPath(); ctx.arc(p[0], p[1], 1, 0, 6.283);
        ctx.fillStyle = 'rgba(' + vertRgb + ',' + op + ')'; ctx.fill();
      });
      animRef.current = requestAnimationFrame(draw);
    };
    draw();
    return () => { if (animRef.current) cancelAnimationFrame(animRef.current); };
  }, [size]);

  return React.createElement('canvas', {
    ref: canvasRef,
    style: { width: size, height: size, display: 'block' }
  });
};

/* ═══════════════════ THEME SYSTEM ═══════════════════ */
const getInitialTheme = () => {
  const stored = localStorage.getItem('khora-theme');
  if (stored === 'light' || stored === 'dark') return stored;
  return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
};

// Apply theme immediately to avoid flash
(() => {
  const t = getInitialTheme();
  if (t === 'light') document.documentElement.classList.add('light');
})();
const ThemeContext = React.createContext({
  theme: 'dark',
  toggle: () => {}
});
const ThemeProvider = ({
  children
}) => {
  const [theme, setTheme] = useState(getInitialTheme);
  useEffect(() => {
    document.documentElement.classList.toggle('light', theme === 'light');
    localStorage.setItem('khora-theme', theme);
  }, [theme]);
  useEffect(() => {
    const mq = window.matchMedia('(prefers-color-scheme: light)');
    const handler = e => {
      if (!localStorage.getItem('khora-theme')) setTheme(e.matches ? 'light' : 'dark');
    };
    mq.addEventListener('change', handler);
    return () => mq.removeEventListener('change', handler);
  }, []);
  const toggle = useCallback(() => setTheme(t => t === 'dark' ? 'light' : 'dark'), []);
  return /*#__PURE__*/React.createElement(ThemeContext.Provider, {
    value: {
      theme,
      toggle
    }
  }, children);
};
const useTheme = () => React.useContext(ThemeContext);
const ThemeToggle = ({
  style: sx
}) => {
  const {
    theme,
    toggle
  } = useTheme();
  const isDark = theme === 'dark';
  return /*#__PURE__*/React.createElement("button", {
    onClick: toggle,
    "aria-label": isDark ? 'Switch to light mode' : 'Switch to dark mode',
    title: isDark ? 'Switch to light mode' : 'Switch to dark mode',
    style: {
      background: 'var(--bg-3)',
      border: '1px solid var(--border-1)',
      borderRadius: 'var(--r)',
      padding: '6px 8px',
      cursor: 'pointer',
      display: 'inline-flex',
      alignItems: 'center',
      gap: 6,
      color: 'var(--tx-1)',
      fontSize: 11,
      fontFamily: 'var(--sans)',
      fontWeight: 500,
      transition: 'all .18s',
      ...sx
    },
    onMouseEnter: e => {
      e.currentTarget.style.borderColor = 'var(--gold)';
      e.currentTarget.style.color = 'var(--tx-0)';
    },
    onMouseLeave: e => {
      e.currentTarget.style.borderColor = 'var(--border-1)';
      e.currentTarget.style.color = 'var(--tx-1)';
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: isDark ? 'moon' : 'sun',
    s: 14
  }), isDark ? 'Dark' : 'Light');
};

/* ═══════════════════ PER-FIELD CRYPTO (AES-256-GCM) ═══════════════════
 * Operator Manifest:
 *   INS(crypto.aes_key, {via: crypto.subtle}) — field_encryption
 *   ALT(crypto.plaintext, {transform: ciphertext, key: aes_gcm}) — field_confidentiality
 *   ALT(crypto.ciphertext, {transform: plaintext, key: aes_gcm}) — field_confidentiality
 *
 * Triad Summary:
 *   Existence:       INS (key creation)
 *   Structure:       —
 *   Interpretation:  ALT (bidirectional value transform, encrypt/decrypt)
 *   No REC — frame is stable. Encryption changes representation, not meaning.
 * ═══════════════════════════════════════════════════════════════════════ */
const FieldCrypto = {
  // INS(crypto.aes_key, {via: crypto.subtle}) — field_encryption — create new 256-bit symmetric key
  async generateKey() {
    const key = await crypto.subtle.generateKey({
      name: 'AES-GCM',
      length: 256
    }, true, ['encrypt', 'decrypt']);
    const raw = await crypto.subtle.exportKey('raw', key);
    return btoa(String.fromCharCode(...new Uint8Array(raw)));
  },
  // ALT(crypto.plaintext, {transform: ciphertext, key: aes_gcm}) — field_confidentiality
  async encrypt(plaintext, keyB64) {
    const keyBuf = Uint8Array.from(atob(keyB64), c => c.charCodeAt(0));
    const key = await crypto.subtle.importKey('raw', keyBuf, 'AES-GCM', false, ['encrypt']);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const enc = await crypto.subtle.encrypt({
      name: 'AES-GCM',
      iv
    }, key, new TextEncoder().encode(plaintext));
    return {
      ciphertext: btoa(String.fromCharCode(...new Uint8Array(enc))),
      iv: btoa(String.fromCharCode(...iv))
    };
  },
  // ALT(crypto.ciphertext, {transform: plaintext, key: aes_gcm}) — field_confidentiality
  async decrypt(cipherB64, ivB64, keyB64) {
    try {
      const keyBuf = Uint8Array.from(atob(keyB64), c => c.charCodeAt(0));
      const key = await crypto.subtle.importKey('raw', keyBuf, 'AES-GCM', false, ['decrypt']);
      const iv = Uint8Array.from(atob(ivB64), c => c.charCodeAt(0));
      const ct = Uint8Array.from(atob(cipherB64), c => c.charCodeAt(0));
      const dec = await crypto.subtle.decrypt({
        name: 'AES-GCM',
        iv
      }, key, ct);
      return new TextDecoder().decode(dec);
    } catch {
      return null;
    }
  }
};

/* ═══════════════════ LOCAL VAULT CRYPTO (IndexedDB at-rest encryption) ═══════════════════
 * Operator Manifest:
 *   INS(crypto.vault_key, {via: hkdf, inputs: token+userId+deviceId}) — at_rest_encryption
 *   ALT(crypto.plaintext, {transform: ciphertext, key: vault_key}) — local_persistence
 *   ALT(crypto.ciphertext, {transform: plaintext, key: vault_key}) — local_retrieval
 *   NUL(crypto.vault_key, {reason: logout|tab_close}) — key_destruction
 *
 * Triad Summary:
 *   Existence:       INS (derive key), NUL (destroy key on logout)
 *   Structure:       —
 *   Interpretation:  ALT (encrypt/decrypt at rest)
 *   No REC — at-rest encryption frame is stable; never reinterprets data.
 *
 * Derives a per-user AES-256-GCM key from the Matrix session using HKDF.
 * All local IndexedDB data is encrypted with this key so that only the
 * authenticated user who synced the data can read it at rest. The key is
 * held in memory only — destroyed on logout or tab close.
 * ═══════════════════════════════════════════════════════════════════════ */
const LocalVaultCrypto = {
  _key: null,
  _userId: null,
  // INS(crypto.vault_key, {via: hkdf, inputs: token+userId+deviceId}) — at_rest_encryption
  async deriveKey(userId, accessToken, deviceId) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(accessToken), 'HKDF', false, ['deriveKey']);
    this._key = await crypto.subtle.deriveKey({
      name: 'HKDF',
      hash: 'SHA-256',
      salt: enc.encode(`${userId}|${deviceId}`),
      info: enc.encode('khora-local-vault-v1')
    }, keyMaterial, {
      name: 'AES-GCM',
      length: 256
    }, false, ['encrypt', 'decrypt']);
    this._userId = userId;
    return this._key;
  },
  get ready() {
    return !!this._key;
  },
  // ALT(crypto.data, {transform: encrypted_envelope, key: vault_key}) — local_persistence
  async encrypt(data) {
    if (!this._key) throw new Error('LocalVaultCrypto not initialized');
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const ct = await crypto.subtle.encrypt({
      name: 'AES-GCM',
      iv
    }, this._key, new TextEncoder().encode(JSON.stringify(data)));
    return {
      __enc: 1,
      ct: btoa(String.fromCharCode(...new Uint8Array(ct))),
      iv: btoa(String.fromCharCode(...iv))
    };
  },
  // ALT(crypto.encrypted_envelope, {transform: data, key: vault_key}) — local_retrieval
  async decrypt(envelope) {
    if (!this._key) throw new Error('LocalVaultCrypto not initialized');
    if (!envelope?.__enc) return envelope;
    try {
      const ct = Uint8Array.from(atob(envelope.ct), c => c.charCodeAt(0));
      const iv = Uint8Array.from(atob(envelope.iv), c => c.charCodeAt(0));
      const dec = await crypto.subtle.decrypt({
        name: 'AES-GCM',
        iv
      }, this._key, ct);
      return JSON.parse(new TextDecoder().decode(dec));
    } catch {
      return null;
    }
  },
  // NUL(crypto.vault_key, {reason: logout}) — key_destruction — local data becomes unreadable
  clear() {
    this._key = null;
    this._userId = null;
  }
};

/* ═══════════════════ ENCRYPTED LOCAL CACHE ═══════════════════
 * Operator Manifest:
 *   INS(cache.encrypted_blob, {store: idb}) — local_persistence — put
 *   ALT(cache.encrypted_blob, {transform: data, key: vault_key}) — cache_read — get (decrypt on read)
 *   NUL(cache.all_stores, {reason: wipe}) — cache_destruction — clear
 *
 * Triad Summary:
 *   Existence:       INS (write blobs), NUL (wipe on logout)
 *   Structure:       —
 *   Interpretation:  ALT (decrypt on read)
 *   No REC — cache never reinterprets; it stores and retrieves.
 *
 * All values written to IndexedDB go through LocalVaultCrypto.encrypt().
 * Keys (primary keys) remain plaintext for lookups; values are AES-256-GCM
 * ciphertext. An attacker inspecting IndexedDB sees only opaque blobs.
 * ═══════════════════════════════════════════════════════════════════════ */
const KhoraEncryptedCache = {
  DB_NAME: 'khora-encrypted-vault',
  DB_VERSION: 1,
  STORES: ['session', 'rooms', 'state'],
  _db: null,
  async open() {
    if (this._db) return this._db;
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.DB_NAME, this.DB_VERSION);
      req.onupgradeneeded = e => {
        const db = e.target.result;
        for (const s of this.STORES) {
          if (!db.objectStoreNames.contains(s)) db.createObjectStore(s);
        }
      };
      req.onsuccess = e => {
        this._db = e.target.result;
        resolve(this._db);
      };
      req.onerror = () => reject(req.error);
    });
  },
  // INS(cache.encrypted_blob, {store: idb}) — local_persistence — encrypt-then-write
  async put(storeName, key, value) {
    if (!LocalVaultCrypto.ready) return;
    const db = await this.open();
    const encrypted = await LocalVaultCrypto.encrypt(value);
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      tx.objectStore(storeName).put(encrypted, key);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },
  // ALT(cache.encrypted_blob, {transform: data, key: vault_key}) — cache_read — read-then-decrypt
  async get(storeName, key) {
    if (!LocalVaultCrypto.ready) return null;
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const req = tx.objectStore(storeName).get(key);
      req.onsuccess = async () => {
        if (!req.result) return resolve(null);
        try {
          resolve(await LocalVaultCrypto.decrypt(req.result));
        } catch {
          resolve(null);
        }
      };
      req.onerror = () => reject(req.error);
    });
  },
  // ALT(cache.encrypted_blob[], {transform: data[], key: vault_key}) — bulk_cache_read — cursor-based decrypt
  async getAll(storeName) {
    if (!LocalVaultCrypto.ready) return {};
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const results = {};
      const pending = [];
      const req = tx.objectStore(storeName).openCursor();
      req.onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
          pending.push(LocalVaultCrypto.decrypt(cursor.value).then(v => {
            if (v !== null) results[cursor.key] = v;
          }).catch(() => {}));
          cursor.continue();
        } else {
          Promise.all(pending).then(() => resolve(results));
        }
      };
      req.onerror = () => reject(req.error);
    });
  },
  // NUL(cache.all_stores, {reason: wipe}) — cache_destruction — purge all encrypted data
  async clear() {
    try {
      const db = await this.open();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(this.STORES, 'readwrite');
        for (const s of this.STORES) tx.objectStore(s).clear();
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    } catch {}
  },
  close() {
    if (this._db) {
      this._db.close();
      this._db = null;
    }
  }
};

/* ═══════════════════ EO OPERATION LAYER ═══════════════════
 * Operator Manifest (meta — this IS the EO engine):
 *   DES(eo.operator_vocabulary, {nine_canonical_ops}) — ontological_foundation
 *   CON(eo.provenance.current_op, {predecessor, key: entity_key}) — provenance_chain
 *   DES(eo.dom_event, {type: khora:eo, dispatch: custom_event}) — ui_notification
 *   ALT(eo.userId, {transform: sha256_hash, salt}) — anonymization
 *
 * projectCurrentState replays: INS, ALT, NUL, SUP, DES
 *
 * Triad Summary:
 *   Existence:       INS (instantiation), DES (operator vocabulary)
 *   Structure:       CON (provenance chains)
 *   Interpretation:  ALT (cohort hashing), SUP (superposition replay)
 *   All three triads active. This is the EO engine itself —
 *   meta-operators operating on operators.
 * ═══════════════════════════════════════════════════════════ */
// DES(eo.operator_vocabulary, {nine_canonical_ops}) — ontological_foundation
const OPERATORS = ['NUL', 'DES', 'INS', 'SEG', 'CON', 'SYN', 'ALT', 'SUP', 'REC'];


// dot(segments...) — builds dot-notation target paths, filtering out falsy segments
function dot(...segments) {
  return segments.filter(Boolean).join('.');
}
// targetField(t) — extracts the last segment of a dot-notation target
function targetField(t) {
  if (!t) return null;
  const parts = t.split('.');
  return parts[parts.length - 1];
}

// Per-entity operation history (session-local)
const entityOpHist = {};
function eKey(roomId, target) {
  return `${roomId}::${target || '_root'}`;
}
let opSeq = 0;
function genOpId() {
  return `op_${Date.now().toString(36)}${(opSeq++).toString(36)}${Math.random().toString(36).slice(2, 5)}`;
}

// Extract homeserver from a Matrix user ID (@user:server.org) or room ID (!room:server.org)
function extractHomeserver(matrixId) {
  if (!matrixId) return 'unknown';
  const idx = matrixId.indexOf(':');
  return idx >= 0 ? matrixId.slice(idx + 1) : 'unknown';
}

// Validate Matrix user ID format: @localpart:server
function isValidMatrixId(id) {
  return /^@[^:]+:[^:]+$/.test(id?.trim());
}

// Emit an EO operation
// Enriches every event with provenance metadata (created_by, origin_server)
// and builds provenance chains linking each op to its predecessor on the same entity.
// Resilient: catches sendEvent failures and retries once, logs all failures visibly.
//
// Format: OPERATOR(target [dot notation], operand)
//   CON(eo.provenance.chain, {current → predecessor}) — links to prior op
//   DES(eo.dom_event, {khora:eo, ui_notification}) — dispatches to DOM listeners
async function emitOp(roomId, op, target, operand, frame, provenance = []) {
  if (!roomId) {
    console.error('emitOp: no roomId provided for', op, target);
    return null;
  }
  try {
    const ek = eKey(roomId, target);
    // CON(eo.provenance.chain, {current → predecessor})
    const prevEntry = entityOpHist[ek];
    const chainedProvenance = [...provenance, ...(prevEntry?.id ? [prevEntry.id] : [])];
    const event = {
      id: genOpId(),
      op,
      target,
      operand,
      frame,
      provenance: chainedProvenance,
      created_by: svc.userId,
      origin_server: extractHomeserver(svc.userId),
      ts: Date.now()
    };
    await svc.sendEvent(roomId, EVT.OP, event);
    entityOpHist[ek] = {
      op,
      id: event.id
    };
    // DES(eo.dom_event, {khora:eo, ui_notification})
    // Dispatch custom DOM event so listeners (ActionLog, notifications) can react immediately
    window.dispatchEvent(new CustomEvent('khora:eo', {
      detail: {
        roomId,
        event
      }
    }));
    return event;
  } catch (e) {
    console.error('emitOp FAILED:', op, target, '→', e.message, {
      roomId,
      op,
      target,
      operand
    });
    // Still update local history so subsequent ops maintain provenance tracking
    const ek = eKey(roomId, target);
    entityOpHist[ek] = {
      op,
      id: 'failed_' + Date.now()
    };
    return null;
  }
}

// Compute current state from operation history (§9.1)
// Replays five operator types to reconstruct current entity state:
//   INS(target, {value}) → creates field with value (existence)
//   ALT(target, {from, to}) → overwrites value within stable frame (interpretation)
//   NUL(target, {reason}) → nullifies field, marks source (existence removal)
//   SUP(target, {states}) → holds multiple valid values simultaneously (interpretation)
//   DES(target, {designation}) → sets entity designation/type (existence naming)
function projectCurrentState(operations, frameType) {
  const state = {};
  const relevant = operations.filter(o => o.frame?.type === frameType).sort((a, b) => a.ts - b.ts);
  for (const op of relevant) {
    const field = targetField(op.target);
    switch (op.op) {
      case 'INS':
        // INS(target, {value}) — instantiate field with value
        if (field) state[field] = {
          value: op.operand?.value,
          source_op: op.id,
          epistemic: op.frame?.epistemic,
          ts: op.ts
        };
        break;
      case 'ALT':
        // ALT(target, {from, to}) — value change within existing frame
        if (field && state[field]) {
          state[field].value = op.operand?.to;
          state[field].source_op = op.id;
          state[field].ts = op.ts;
        }
        break;
      case 'NUL':
        // NUL(target, {reason}) — existence removal
        if (field) state[field] = {
          value: null,
          nullified_by: op.id,
          ts: op.ts
        };
        break;
      case 'SUP':
        // SUP(target, {states}) — multiple valid values coexist
        if (field) state[field] = {
          values: op.operand?.states,
          superposition: true,
          source_op: op.id,
          ts: op.ts
        };
        break;
      case 'DES':
        // DES(target, {designation}) — type/name assignment
        if (field) state[`${field}.designation`] = {
          value: op.operand?.designation,
          source_op: op.id,
          ts: op.ts
        };
        break;
    }
  }
  return state;
}

// ALT(metrics.userId, {transform: sha256_hash, salt}) — anonymization — one-way lossy transform for metrics
async function cohortHash(userId, salt) {
  const data = new TextEncoder().encode(userId + (salt || 'khora_default_salt'));
  const hash = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(hash)));
}

/* ═══════════════════ EMAIL VERIFICATION UTILITIES (§10.5) ═══════════════════
 * Operator Manifest:
 *   INS(email.verification_code, {via: crypto.getRandomValues}) — challenge_creation
 *   ALT(email.plaintext_code, {transform: sha256_hash, via: web_crypto}) — one_way_transform
 *   CON(email.hashed_code, {dest: org_room_state, via: webhook_delivery}) — out_of_band_challenge
 *   DES(email.identity, {attestation: code_match}) — verified_attestation
 *   NUL(email.challenge, {reason: max_attempts|expiry}) — lockout
 *
 * Triad Summary:
 *   Existence:       INS (code generation), NUL (expiry/lockout)
 *   Structure:       CON (webhook delivery to out-of-band channel)
 *   Interpretation:  ALT (one-way hash), DES (verified identity attestation)
 *   No REC, no SUP — verification either succeeds or fails, never reinterprets.
 *
 * Generates time-limited 6-digit codes, hashes them with SHA-256, and validates
 * email addresses against organization-approved domains. Codes are stored hashed
 * in Matrix room state — the plaintext code is delivered out-of-band (email/webhook).
 * ════════════════════════════════════════════════════════════════════════════════ */
const EmailVerification = {
  // INS(email.verification_code, {via: crypto.getRandomValues}) — challenge_creation
  generateCode() {
    const arr = crypto.getRandomValues(new Uint8Array(4));
    const num = (arr[0] << 24 | arr[1] << 16 | arr[2] << 8 | arr[3]) >>> 0;
    return String(num % 1000000).padStart(6, '0');
  },
  // ALT(email.plaintext_code, {transform: sha256_hash, via: web_crypto}) — one_way_transform
  async hashCode(code) {
    const data = new TextEncoder().encode(code + ':khora_email_verify_v1');
    const hash = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(hash)));
  },
  /** Extract domain from an email address */
  extractDomain(email) {
    const match = (email || '').trim().toLowerCase().match(/@([a-z0-9.-]+)$/);
    return match ? match[1] : null;
  },
  /** Validate email format */
  isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((email || '').trim());
  },
  /** Check if an email's domain matches any of the org's required domains */
  domainMatches(email, requiredDomains) {
    if (!requiredDomains || requiredDomains.length === 0) return true;
    const domain = this.extractDomain(email);
    return domain && requiredDomains.some(d => d.toLowerCase() === domain);
  },
  // INS(email.challenge, {data: userId+email+hash}) — verification_initiation
  // CON(email.challenge, {dest: org_room_state, key: state_key}) — persistence
  async createChallenge(userId, email) {
    const code = this.generateCode();
    const codeHash = await this.hashCode(code);
    return {
      challenge: {
        user_id: userId,
        email: email.trim().toLowerCase(),
        domain: this.extractDomain(email),
        code_hash: codeHash,
        created: Date.now(),
        expires: Date.now() + 15 * 60 * 1000,
        // 15 minutes
        attempts: 0,
        max_attempts: 3,
        status: 'pending'
      },
      plainCode: code // returned for delivery — never stored in state
    };
  },
  // DES(email.identity, {attestation: code_match}) — verified_attestation on success
  // NUL(email.challenge, {reason: expired|max_attempts}) — lockout on failure
  async validateChallenge(challenge, submittedCode) {
    if (!challenge || challenge.status !== 'pending') return {
      valid: false,
      reason: 'no_active_challenge'
    };
    if (Date.now() > challenge.expires) return {
      valid: false,
      reason: 'expired'
    };
    if (challenge.attempts >= challenge.max_attempts) return {
      valid: false,
      reason: 'max_attempts'
    };
    const submittedHash = await this.hashCode(submittedCode);
    if (submittedHash !== challenge.code_hash) return {
      valid: false,
      reason: 'incorrect_code'
    };
    return {
      valid: true
    };
  },
  /** Default email verification config for an organization */
  defaultConfig() {
    return {
      enabled: false,
      required_domains: [],
      require_for_roles: ['admin', 'case_manager', 'field_worker', 'intake_coordinator'],
      grace_period_hours: 72
    };
  },
  /** Check if a staff member needs verification given org config */
  needsVerification(config, staffEntry) {
    if (!config?.enabled) return false;
    if (!config.require_for_roles?.includes(staffEntry.role)) return false;
    const ev = staffEntry.email_verification;
    if (ev?.status === 'verified') return false;
    return true;
  },
  // CON(email.plaintext_code, {dest: email_inbox, via: webhook_relay}) — out_of_band_delivery
  async sendCodeViaWebhook(email, code, orgName) {
    try {
      const resp = await fetch(`${WEBHOOK_BASE}/email-verify`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          to: email,
          code: code,
          org_name: orgName,
          subject: `Your verification code for ${orgName}`,
          expires_minutes: 15
        })
      });
      return resp.ok;
    } catch {
      return false;
    }
  }
};

/* ═══════════════════ EVENT TYPES (§11) ═══════════════════
 * Operator Manifest:
 *   DES(protocol.event_types, {namespace: io.khora.*}) — protocol_vocabulary
 *
 * This entire section is pure DES — it designates the vocabulary of
 * event types, maturity levels, propagation levels, governance constants,
 * and resource tracking constants. No data is mutated, structured, or
 * reinterpretted here. All actual transformations happen elsewhere
 * using these designations as their frame.
 *
 * Triad Summary:
 *   Existence:       DES only (naming, not creating)
 *   Structure:       —
 *   Interpretation:  —
 *   No INS, no ALT, no REC — vocabulary definition is frame-setting, not frame-changing.
 * ═══════════════════════════════════════════════════════════ */
const NS = 'io.khora';
const EVT = {
  IDENTITY: `${NS}.identity`,
  OP: `${NS}.op`,
  // Vault
  VAULT_SNAPSHOT: `${NS}.vault.snapshot`,
  VAULT_PROVIDERS: `${NS}.vault.providers`,
  // Bridge
  BRIDGE_META: `${NS}.bridge.meta`,
  BRIDGE_REFS: `${NS}.bridge.refs`,
  // Roster
  ROSTER_INDEX: `${NS}.roster.index`,
  ROSTER_ASSIGN: `${NS}.roster.assignment`,
  // Organization
  ORG_ROSTER: `${NS}.org.roster`,
  ORG_METADATA: `${NS}.org.metadata`,
  ORG_INVITE: `${NS}.org.invite`,
  ORG_OPACITY: `${NS}.org.opacity`,
  ORG_MSG_ACCESS: `${NS}.org.msg_access`,
  // Inter-org messaging
  ORG_MSG_CHANNEL: `${NS}.org.msg.channel`,
  ORG_MSG_ENVELOPE: `${NS}.org.msg.envelope`,
  // Schema — Forms (GIVEN data collection)
  SCHEMA_FORM: `${NS}.schema.form`,
  SCHEMA_PROMPT: `${NS}.schema.prompt`,
  // individual form field (backward compat)
  // Schema — Interpretations (MEANT frameworks)
  SCHEMA_ASSESSMENT: `${NS}.schema.assessment`,
  // provider-side MEANT instruments
  SCHEMA_DEF: `${NS}.schema.definition`,
  SCHEMA_TRANSFORM: `${NS}.schema.transform`,
  SCHEMA_SUB: `${NS}.schema.subscription`,
  SCHEMA_AUTHORITY: `${NS}.schema.authority`,
  SCHEMA_PROP: `${NS}.schema.propagation`,
  // Provider observations
  OBSERVATION: `${NS}.observation`,
  // Metrics
  METRIC: `${NS}.metric`,
  METRIC_AGG: `${NS}.metric.aggregate`,
  METRIC_SUPPRESS: `${NS}.metric.suppression`,
  // Network
  NET_MEMBERS: `${NS}.network.members`,
  NET_HASH_SALT: `${NS}.network.hash_salt`,
  // Discovery
  INVITE_TOKEN: `${NS}.invite.token`,
  ENCOUNTER_PROV: `${NS}.encounter.provisional`,
  // Email verification
  ORG_EMAIL_CONFIG: `${NS}.org.email_verification`,
  ORG_VERIFY_CHALLENGE: `${NS}.org.verification_challenge`,
  // Organization terminology customization
  ORG_TERMINOLOGY: `${NS}.org.terminology`,
  // Organization custom roles
  ORG_ROLES: `${NS}.org.roles`,
  // Teams (flexible groups of people, not tied to a single org)
  TEAM_META: `${NS}.team.metadata`,
  TEAM_MEMBERS: `${NS}.team.members`,
  TEAM_SCHEMA: `${NS}.team.schema`,
  TEAM_SCHEMA_RULE: `${NS}.team.schema_rule`,
  // Team hierarchy and custom tables
  TEAM_HIERARCHY: `${NS}.team.hierarchy`,         // parent/child nesting + rollup policy
  TEAM_TABLE_DEF: `${NS}.team.table.definition`,  // custom table definition (state_key = table.id)
  TEAM_TABLE_RECORD: `${NS}.team.table.record`,   // record in custom table (state_key = tableId+':'+recordId)
  // Field definitions & crosswalks
  FIELD_DEF: `${NS}.field.definition`,
  FIELD_CROSSWALK: `${NS}.field.crosswalk`,
  FIELD_GOV_CONFIG: `${NS}.field.governance_config`,
  // Matching / dedup
  MATCH_TOKEN: `${NS}.match.token`,
  MATCH_HIT: `${NS}.match.hit`,
  MATCH_RESOLVE: `${NS}.match.resolve`,
  // Notes (standalone or attached to individuals)
  NOTE: `${NS}.note`,
  NOTE_REF: `${NS}.note.ref`,
  // org-side reference pointing to bridge note
  NOTE_EDIT: `${NS}.note.edit`,
  // auditable note edit (ALT operation)
  // Client records (provider-created rooms representing clients)
  CLIENT_RECORD: `${NS}.client.record`,
  // Import
  IMPORT_MANIFEST: `${NS}.import.manifest`,
  // Provider profile (self-reported identity & credentials)
  PROVIDER_PROFILE: `${NS}.provider.profile`,
  // Governance (MVP §Screen 5)
  GOV_PROPOSAL: `${NS}.governance.proposal`,
  GOV_RHYTHM: `${NS}.governance.rhythm`,
  // Schema field & binding (MVP event schema)
  SCHEMA_FIELD: `${NS}.schema.field`,
  SCHEMA_BINDING: `${NS}.schema.binding`,
  // Resource tracking (§Resource Build)
  RESOURCE_TYPE: `${NS}.resource.type`,
  // catalog entry (network or org)
  RESOURCE_INVENTORY: `${NS}.resource.inventory`,
  // org stock levels per relation
  RESOURCE_RELATION: `${NS}.resource.relation`,
  // relational position between holder and resource
  RESOURCE_ALLOC: `${NS}.resource.allocation`,
  // individual allocation (bridge room)
  RESOURCE_EVENT: `${NS}.resource.event`,
  // lifecycle event (timeline, not state)
  RESOURCE_POLICY: `${NS}.resource.policy`,
  // allocation rules / constraints
  RESOURCE_OPACITY: `${NS}.resource.opacity`,
  // per-relation visibility controls
  RESOURCE_VAULT: `${NS}.resource.vault_record`,
  // client vault shadow record
  RESOURCE_PERM: `${NS}.resource.permissions`, // per-type permission grants
  // Direct messaging between connected users
  DM_META: `${NS}.dm.meta`,
  // Database merge (auditable SYN-based record merging)
  MERGE_RECORD: `${NS}.merge.record`,
  MERGE_AUDIT: `${NS}.merge.audit`,
  // Linked records (sub-records linked across record types, Airtable-style)
  LINKED_RECORD: `${NS}.linked.record`,
  LINKED_RECORD_INDEX: `${NS}.linked.record.index`,
  // Trash bin — soft-deleted individuals pending permanent removal
  ORG_TRASH: `${NS}.org.trash`
};

/* ═══════════════════ MATURITY LEVELS (MVP §Screen 4) ═══════════════════ */
// DES(schema.lifecycle_states, {values: [draft, trial, normative, de_facto, deprecated]}) — schema_governance
const MATURITY_LEVELS = {
  draft: {
    id: 'draft',
    label: 'Draft',
    color: 'blue',
    icon: '🔵',
    desc: 'This question is proposed \u2014 it hasn\u2019t been formally reviewed yet and may change'
  },
  trial: {
    id: 'trial',
    label: 'Trial',
    color: 'gold',
    icon: '🟡',
    desc: 'This question is approved for use but still being tested \u2014 it could be updated'
  },
  normative: {
    id: 'normative',
    label: 'Normative',
    color: 'green',
    icon: '🟢',
    desc: 'This question is finalized \u2014 it\u2019s the agreed-upon standard across the network'
  },
  de_facto: {
    id: 'de_facto',
    label: 'De facto',
    color: 'purple',
    icon: '⚪',
    desc: 'Widely used, never formally proposed'
  },
  deprecated: {
    id: 'deprecated',
    label: 'Deprecated',
    color: 'red',
    icon: '🔴',
    desc: 'Being phased out'
  }
};

/* ═══════════════════ UX HELPERS ═══════════════════ */
const aOrAn = (word) => /^[aeiou]/i.test(word) ? 'an' : 'a';
const hueToColorName = (hue) => {
  if (hue < 15) return 'Red';
  if (hue < 45) return 'Orange';
  if (hue < 70) return 'Yellow';
  if (hue < 150) return 'Green';
  if (hue < 190) return 'Cyan';
  if (hue < 260) return 'Blue';
  if (hue < 310) return 'Purple';
  if (hue < 345) return 'Pink';
  return 'Red';
};

/* ═══════════════════ TEAM COLOR UTILITIES ═══════════════════ */
const randomTeamHue = () => Math.floor(Math.random() * 360);
// Golden-angle spacing ensures team colors are meaningfully distinct per user account
const distinctTeamHue = (index) => Math.round((index * 137.508) % 360);
// Per-user localStorage helpers — colors are local, not synced to Matrix
const _tcKey = (userId, roomId) => `khora_tc_${userId}_${roomId}`;
const getLocalTeamColor = (userId, roomId, fallback) => {
  try { const v = localStorage.getItem(_tcKey(userId, roomId)); if (v !== null) return parseInt(v); } catch {}
  return fallback;
};
const setLocalTeamColor = (userId, roomId, hue) => {
  try { localStorage.setItem(_tcKey(userId, roomId), String(hue)); } catch {}
};
const teamColorThemed = (hue, isLight) => {
  if (hue == null) hue = 260;
  const l = isLight ? 38 : 55;
  const s = isLight ? 55 : 65;
  return {
    primary: `hsl(${hue}, ${s}%, ${l}%)`,
    dim: `hsla(${hue}, ${s}%, ${l}%, 0.10)`,
    border: `hsla(${hue}, ${s}%, ${l}%, 0.15)`,
    mid: `hsla(${hue}, ${s}%, ${l}%, 0.22)`
  };
};

/* ═══════════════════ PROPAGATION LEVELS (MVP §CON Semantics) ═══════════════════ */
// DES(schema.coupling_strengths, {values: [required, standard, recommended, optional]}) — network_governance
const PROPAGATION_LEVELS = {
  required: {
    id: 'required',
    label: 'Required',
    color: 'red',
    desc: 'All organizations in the network must use this form \u2014 it can\u2019t be changed locally'
  },
  standard: {
    id: 'standard',
    label: 'Standard',
    color: 'gold',
    desc: 'Used by default across the network \u2014 organizations are notified if they diverge'
  },
  recommended: {
    id: 'recommended',
    label: 'Recommended',
    color: 'blue',
    desc: 'Suggested by the network \u2014 each organization decides whether to adopt it'
  },
  optional: {
    id: 'optional',
    label: 'Optional',
    color: 'teal',
    desc: 'Loose coupling — available, no expectation'
  }
};

/* ═══════════════════ GOVERNANCE CONSTANTS (MVP §Screen 5) ═══════════════════ */
// DES(governance.vocabulary, {consent, proposals, rhythms}) — polycentric_governance
const CONSENT_POSITIONS = {
  adopt_as_is: {
    id: 'adopt_as_is',
    label: 'Adopt as-is',
    icon: '✅',
    color: 'green'
  },
  adopt_with_extension: {
    id: 'adopt_with_extension',
    label: 'Adopt with extension',
    icon: '🔄',
    color: 'blue'
  },
  needs_modification: {
    id: 'needs_modification',
    label: 'Needs modification',
    icon: '⚠️',
    color: 'gold'
  },
  cannot_adopt: {
    id: 'cannot_adopt',
    label: 'Cannot adopt (block)',
    icon: '🚫',
    color: 'red'
  }
};
const PROPOSAL_STATUSES = {
  submitted: {
    id: 'submitted',
    label: 'Submitted',
    color: 'blue'
  },
  discussion: {
    id: 'discussion',
    label: 'Discussion',
    color: 'gold'
  },
  consent_round: {
    id: 'consent_round',
    label: 'Consent Round',
    color: 'orange'
  },
  resolved: {
    id: 'resolved',
    label: 'Resolved',
    color: 'green'
  },
  adopted: {
    id: 'adopted',
    label: 'Adopted',
    color: 'green'
  },
  blocked: {
    id: 'blocked',
    label: 'Blocked',
    color: 'red'
  }
};
const GOV_RHYTHMS = {
  monthly_review: {
    id: 'monthly_review',
    name: 'Monthly Schema Review',
    frequency: 'monthly',
    anchor_day: 'first_monday',
    duration_days: 5,
    participants: 'org_admins'
  },
  quarterly_alignment: {
    id: 'quarterly_alignment',
    name: 'Quarterly Framework Alignment',
    frequency: 'quarterly',
    anchor_day: 'first_monday',
    duration_days: 5,
    participants: 'network_steward_plus_affected'
  },
  annual_constitutional: {
    id: 'annual_constitutional',
    name: 'Annual Constitutional Review',
    frequency: 'annual',
    anchor_day: 'first_monday',
    duration_days: 14,
    participants: 'all_members_supermajority'
  }
};

/* ═══════════════════ TEAM CONSENT MODES (§Team Schema Governance) ═══════════════════ */
const TEAM_CONSENT_MODES = {
  lead_decides: {
    id: 'lead_decides',
    label: 'Lead Decides',
    icon: 'briefcase',
    color: 'gold',
    desc: 'Team lead can change the schema directly. Members are notified.'
  },
  majority: {
    id: 'majority',
    label: 'Majority',
    icon: 'users',
    color: 'blue',
    desc: 'Schema changes require approval from more than half of team members.'
  },
  unanimous: {
    id: 'unanimous',
    label: 'Unanimous',
    icon: 'shieldCheck',
    color: 'green',
    desc: 'All team members must approve schema changes. Any member can block.'
  }
};

/* ═══════════════════ CROSSWALK RELATIONSHIP TYPES (§Field Definitions) ═══════════════════ */
const CROSSWALK_TYPES = {
  equivalent: {
    id: 'equivalent',
    label: 'Equivalent',
    symbol: '\u2261',
    color: 'green',
    desc: 'Same concept, different name'
  },
  narrower: {
    id: 'narrower',
    label: 'Narrower',
    symbol: '\u2282',
    color: 'blue',
    desc: 'Target is a subset of source'
  },
  broader: {
    id: 'broader',
    label: 'Broader',
    symbol: '\u2283',
    color: 'teal',
    desc: 'Target is a superset of source'
  },
  related: {
    id: 'related',
    label: 'Related',
    symbol: '~',
    color: 'gold',
    desc: 'Conceptually linked but distinct'
  },
  conflicting: {
    id: 'conflicting',
    label: 'Conflicting',
    symbol: '\u2260',
    color: 'red',
    desc: 'Same name, different meaning'
  }
};

/* ═══════════════════ URI LIBRARIES (§Searchable Definitions) ═══════════════════
 * DES(uri_libraries, {standard_vocabularies}) — semantic_interoperability
 *
 * Curated libraries of standard URIs from established vocabularies.
 * Used throughout the app to let users attach well-known definitions to
 * their fields, forms, and observations. Each library entry provides:
 *   - uri: the canonical URI for the concept
 *   - label: human-readable name
 *   - definition: what this concept means
 *   - data_type: expected data type (text, date, select, etc.)
 *   - category: grouping within the library
 *   - tags: searchable keywords
 * ════════════════════════════════════════════════════════════════════════ */
const URI_LIBRARIES = [
  {
    id: 'schema_org',
    name: 'Schema.org',
    prefix: 'https://schema.org/',
    description: 'Structured data vocabulary maintained by Google, Microsoft, Yahoo, and Yandex. Widely used for web-standard person, organization, and event descriptions.',
    color: 'blue',
    icon: 'globe',
    entries: [
      { uri: 'https://schema.org/givenName', label: 'Given Name', definition: 'The given (first) name of a person.', data_type: 'text', category: 'identity', tags: ['name', 'first name', 'person'] },
      { uri: 'https://schema.org/familyName', label: 'Family Name', definition: 'The family (last) name of a person.', data_type: 'text', category: 'identity', tags: ['name', 'last name', 'surname', 'person'] },
      { uri: 'https://schema.org/name', label: 'Name', definition: 'The full name of the thing (person, org, place, etc.).', data_type: 'text', category: 'identity', tags: ['name', 'full name'] },
      { uri: 'https://schema.org/email', label: 'Email', definition: 'An email address.', data_type: 'email', category: 'contact', tags: ['email', 'address', 'electronic'] },
      { uri: 'https://schema.org/telephone', label: 'Telephone', definition: 'A telephone number.', data_type: 'phone', category: 'contact', tags: ['phone', 'telephone', 'mobile', 'cell'] },
      { uri: 'https://schema.org/birthDate', label: 'Birth Date', definition: 'Date of birth.', data_type: 'date', category: 'identity', tags: ['dob', 'birthday', 'born', 'age'] },
      { uri: 'https://schema.org/gender', label: 'Gender', definition: 'Gender of the person.', data_type: 'single_select', category: 'identity', tags: ['gender', 'sex', 'identity'] },
      { uri: 'https://schema.org/address', label: 'Postal Address', definition: 'Physical address of the item.', data_type: 'address', category: 'contact', tags: ['address', 'street', 'postal', 'mailing'] },
      { uri: 'https://schema.org/nationality', label: 'Nationality', definition: 'Nationality of the person.', data_type: 'text', category: 'identity', tags: ['nationality', 'country', 'citizen'] },
      { uri: 'https://schema.org/knows', label: 'Knows', definition: 'The most generic bi-directional social relationship.', data_type: 'text', category: 'social', tags: ['relationship', 'contact', 'knows'] },
      { uri: 'https://schema.org/memberOf', label: 'Member Of', definition: 'An organization to which the person belongs.', data_type: 'text', category: 'social', tags: ['member', 'organization', 'affiliation'] },
      { uri: 'https://schema.org/jobTitle', label: 'Job Title', definition: 'The job title of the person.', data_type: 'text', category: 'employment', tags: ['job', 'title', 'role', 'position'] },
      { uri: 'https://schema.org/worksFor', label: 'Works For', definition: 'Organizations the person works for.', data_type: 'text', category: 'employment', tags: ['employer', 'organization', 'work'] },
      { uri: 'https://schema.org/healthCondition', label: 'Health Condition', definition: 'A health condition relevant to the person.', data_type: 'text', category: 'health', tags: ['health', 'condition', 'medical', 'diagnosis'] },
      { uri: 'https://schema.org/identifier', label: 'Identifier', definition: 'A unique identifier for the thing.', data_type: 'text', category: 'identity', tags: ['id', 'identifier', 'number', 'code'] },
      { uri: 'https://schema.org/description', label: 'Description', definition: 'A free-text description of the item.', data_type: 'text_long', category: 'general', tags: ['description', 'notes', 'text'] },
      { uri: 'https://schema.org/image', label: 'Image', definition: 'An image of the item.', data_type: 'document', category: 'general', tags: ['image', 'photo', 'picture'] },
      { uri: 'https://schema.org/Organization', label: 'Organization', definition: 'An organization such as a school, NGO, corporation, club, etc.', data_type: 'text', category: 'social', tags: ['organization', 'org', 'company', 'institution'] },
      { uri: 'https://schema.org/Place', label: 'Place', definition: 'Entities that have a somewhat fixed, physical extension.', data_type: 'text', category: 'location', tags: ['place', 'location', 'address', 'geo'] },
      { uri: 'https://schema.org/Event', label: 'Event', definition: 'An event happening at a certain time and location.', data_type: 'text', category: 'general', tags: ['event', 'appointment', 'meeting', 'occurrence'] }
    ]
  },
  {
    id: 'dublin_core',
    name: 'Dublin Core',
    prefix: 'http://purl.org/dc/terms/',
    description: 'ISO 15836 metadata standard for describing resources. Foundational vocabulary for document and record metadata across libraries, archives, and information systems.',
    color: 'teal',
    icon: 'book',
    entries: [
      { uri: 'http://purl.org/dc/terms/title', label: 'Title', definition: 'A name given to the resource.', data_type: 'text', category: 'general', tags: ['title', 'name', 'label'] },
      { uri: 'http://purl.org/dc/terms/description', label: 'Description', definition: 'An account of the resource content.', data_type: 'text_long', category: 'general', tags: ['description', 'summary', 'abstract'] },
      { uri: 'http://purl.org/dc/terms/subject', label: 'Subject', definition: 'The topic or subject matter of the resource.', data_type: 'text', category: 'general', tags: ['subject', 'topic', 'keyword', 'tag'] },
      { uri: 'http://purl.org/dc/terms/creator', label: 'Creator', definition: 'An entity primarily responsible for making the resource.', data_type: 'text', category: 'provenance', tags: ['creator', 'author', 'made by'] },
      { uri: 'http://purl.org/dc/terms/date', label: 'Date', definition: 'A point or period of time associated with an event in the lifecycle of the resource.', data_type: 'date', category: 'provenance', tags: ['date', 'when', 'time'] },
      { uri: 'http://purl.org/dc/terms/created', label: 'Date Created', definition: 'Date of creation of the resource.', data_type: 'date', category: 'provenance', tags: ['created', 'creation date', 'started'] },
      { uri: 'http://purl.org/dc/terms/modified', label: 'Date Modified', definition: 'Date on which the resource was changed.', data_type: 'date', category: 'provenance', tags: ['modified', 'updated', 'changed'] },
      { uri: 'http://purl.org/dc/terms/identifier', label: 'Identifier', definition: 'An unambiguous reference to the resource within a given context.', data_type: 'text', category: 'identity', tags: ['id', 'identifier', 'reference'] },
      { uri: 'http://purl.org/dc/terms/language', label: 'Language', definition: 'A language of the resource.', data_type: 'text', category: 'general', tags: ['language', 'locale', 'lang'] },
      { uri: 'http://purl.org/dc/terms/type', label: 'Type', definition: 'The nature or genre of the resource.', data_type: 'single_select', category: 'general', tags: ['type', 'kind', 'genre', 'category'] },
      { uri: 'http://purl.org/dc/terms/format', label: 'Format', definition: 'The file format, physical medium, or dimensions of the resource.', data_type: 'text', category: 'general', tags: ['format', 'file type', 'mime'] },
      { uri: 'http://purl.org/dc/terms/rights', label: 'Rights', definition: 'Information about rights held in and over the resource.', data_type: 'text', category: 'governance', tags: ['rights', 'license', 'permission', 'copyright'] },
      { uri: 'http://purl.org/dc/terms/source', label: 'Source', definition: 'A related resource from which the described resource is derived.', data_type: 'text', category: 'provenance', tags: ['source', 'origin', 'derived from'] },
      { uri: 'http://purl.org/dc/terms/coverage', label: 'Coverage', definition: 'The spatial or temporal topic of the resource.', data_type: 'text', category: 'general', tags: ['coverage', 'scope', 'jurisdiction', 'geography'] },
      { uri: 'http://purl.org/dc/terms/relation', label: 'Relation', definition: 'A related resource.', data_type: 'text', category: 'general', tags: ['relation', 'related to', 'see also'] }
    ]
  },
  {
    id: 'foaf',
    name: 'FOAF',
    prefix: 'http://xmlns.com/foaf/0.1/',
    description: 'Friend of a Friend — RDF vocabulary for describing persons, social networks, and online accounts. Standard in linked data and social web applications.',
    color: 'purple',
    icon: 'users',
    entries: [
      { uri: 'http://xmlns.com/foaf/0.1/name', label: 'Name', definition: 'A name for some thing (person, org, etc.).', data_type: 'text', category: 'identity', tags: ['name', 'full name'] },
      { uri: 'http://xmlns.com/foaf/0.1/firstName', label: 'First Name', definition: 'The first name of a person.', data_type: 'text', category: 'identity', tags: ['first name', 'given name'] },
      { uri: 'http://xmlns.com/foaf/0.1/lastName', label: 'Last Name', definition: 'The last name of a person.', data_type: 'text', category: 'identity', tags: ['last name', 'family name', 'surname'] },
      { uri: 'http://xmlns.com/foaf/0.1/mbox', label: 'Email (Mailbox)', definition: 'A personal mailbox, i.e., an Internet mailbox associated with exactly one owner.', data_type: 'email', category: 'contact', tags: ['email', 'mailbox'] },
      { uri: 'http://xmlns.com/foaf/0.1/phone', label: 'Phone', definition: 'A phone number associated with the person.', data_type: 'phone', category: 'contact', tags: ['phone', 'telephone'] },
      { uri: 'http://xmlns.com/foaf/0.1/age', label: 'Age', definition: 'The age of the agent.', data_type: 'number', category: 'identity', tags: ['age', 'years old'] },
      { uri: 'http://xmlns.com/foaf/0.1/gender', label: 'Gender', definition: 'The gender of this Agent (typically but not necessarily \'male\' or \'female\').', data_type: 'single_select', category: 'identity', tags: ['gender', 'sex'] },
      { uri: 'http://xmlns.com/foaf/0.1/knows', label: 'Knows', definition: 'A person known by this person (indicates some level of reciprocated interaction).', data_type: 'text', category: 'social', tags: ['knows', 'relationship', 'contact'] },
      { uri: 'http://xmlns.com/foaf/0.1/based_near', label: 'Based Near', definition: 'A location that something is based near, for loose geographic associations.', data_type: 'text', category: 'location', tags: ['location', 'near', 'based', 'geography'] },
      { uri: 'http://xmlns.com/foaf/0.1/Organization', label: 'Organization', definition: 'An organization.', data_type: 'text', category: 'social', tags: ['organization', 'org', 'company'] },
      { uri: 'http://xmlns.com/foaf/0.1/Group', label: 'Group', definition: 'A class of Agents representing a collection of individuals.', data_type: 'text', category: 'social', tags: ['group', 'team', 'collection'] },
      { uri: 'http://xmlns.com/foaf/0.1/homepage', label: 'Homepage', definition: 'A homepage for some thing.', data_type: 'text', category: 'contact', tags: ['homepage', 'website', 'url'] },
      { uri: 'http://xmlns.com/foaf/0.1/depiction', label: 'Depiction', definition: 'An image that depicts some thing.', data_type: 'document', category: 'general', tags: ['image', 'photo', 'depiction'] }
    ]
  },
  {
    id: 'hmis',
    name: 'HMIS',
    prefix: 'https://hudhdx.info/Resources/Vendors/HMIS/',
    description: 'HUD Homeless Management Information System data standards. Mandatory for federally funded homeless services, CoC reporting, and PIT counts.',
    color: 'gold',
    icon: 'home',
    entries: [
      { uri: 'hmis:PersonalID', label: 'Personal ID', definition: 'A unique system-generated identifier for the client within HMIS.', data_type: 'text', category: 'identity', tags: ['id', 'personal id', 'hmis id', 'client id'] },
      { uri: 'hmis:FirstName', label: 'First Name', definition: 'First name of the client as reported during intake.', data_type: 'text', category: 'identity', tags: ['first name', 'given name'] },
      { uri: 'hmis:LastName', label: 'Last Name', definition: 'Last name of the client as reported during intake.', data_type: 'text', category: 'identity', tags: ['last name', 'family name', 'surname'] },
      { uri: 'hmis:SSN', label: 'SSN (Last 4)', definition: 'Last four digits of Social Security Number for identification.', data_type: 'text', category: 'identity', tags: ['ssn', 'social security', 'id number'] },
      { uri: 'hmis:DOB', label: 'Date of Birth', definition: 'Client date of birth.', data_type: 'date', category: 'identity', tags: ['dob', 'birthday', 'birth date'] },
      { uri: 'hmis:Race', label: 'Race', definition: 'Race of the client per HUD standards (may select multiple).', data_type: 'multi_select', category: 'demographics', tags: ['race', 'ethnicity', 'demographic'] },
      { uri: 'hmis:Ethnicity', label: 'Ethnicity', definition: 'Hispanic/Latino ethnicity of the client per HUD categories.', data_type: 'single_select', category: 'demographics', tags: ['ethnicity', 'hispanic', 'latino'] },
      { uri: 'hmis:Gender', label: 'Gender', definition: 'Gender identity of the client per HUD data standards.', data_type: 'multi_select', category: 'demographics', tags: ['gender', 'identity', 'sex'] },
      { uri: 'hmis:VeteranStatus', label: 'Veteran Status', definition: 'Whether the client has served in the U.S. Armed Forces.', data_type: 'single_select', category: 'demographics', tags: ['veteran', 'military', 'armed forces'] },
      { uri: 'hmis:DisablingCondition', label: 'Disabling Condition', definition: 'Whether the client has a disabling condition as defined by HUD.', data_type: 'single_select', category: 'health', tags: ['disability', 'disabling', 'condition'] },
      { uri: 'hmis:ProjectEntryDate', label: 'Project Entry Date', definition: 'Date the client entered the project/program.', data_type: 'date', category: 'enrollment', tags: ['entry date', 'enrollment', 'start date', 'intake'] },
      { uri: 'hmis:ProjectExitDate', label: 'Project Exit Date', definition: 'Date the client exited the project/program.', data_type: 'date', category: 'enrollment', tags: ['exit date', 'discharge', 'end date'] },
      { uri: 'hmis:Destination', label: 'Destination', definition: 'Living situation the client moved to upon exit.', data_type: 'single_select', category: 'enrollment', tags: ['destination', 'exit', 'housing', 'living situation'] },
      { uri: 'hmis:LivingSituation', label: 'Living Situation', definition: 'Client\'s living situation at time of project entry.', data_type: 'single_select', category: 'enrollment', tags: ['living situation', 'housing status', 'prior living'] },
      { uri: 'hmis:LengthOfStay', label: 'Length of Stay', definition: 'Length of stay in prior living situation.', data_type: 'single_select', category: 'enrollment', tags: ['length of stay', 'duration', 'time'] },
      { uri: 'hmis:DateOfEngagement', label: 'Date of Engagement', definition: 'Date the client was first engaged by street outreach.', data_type: 'date', category: 'enrollment', tags: ['engagement', 'outreach', 'contact date'] },
      { uri: 'hmis:TimesHomelessPastThreeYears', label: 'Times Homeless (3yr)', definition: 'Number of times the client has been homeless in the past three years.', data_type: 'single_select', category: 'history', tags: ['homeless', 'chronic', 'history', 'episodes'] },
      { uri: 'hmis:MonthsHomelessPastThreeYears', label: 'Months Homeless (3yr)', definition: 'Total months homeless in the past three years.', data_type: 'single_select', category: 'history', tags: ['months', 'chronic', 'duration', 'homeless'] },
      { uri: 'hmis:IncomeFromAnySource', label: 'Income from Any Source', definition: 'Whether the client has income from any source.', data_type: 'single_select', category: 'income', tags: ['income', 'earnings', 'money'] },
      { uri: 'hmis:TotalMonthlyIncome', label: 'Total Monthly Income', definition: 'Total monthly income from all sources in dollars.', data_type: 'number', category: 'income', tags: ['income', 'monthly', 'total', 'dollars'] },
      { uri: 'hmis:InsuranceFromAnySource', label: 'Insurance from Any Source', definition: 'Whether the client has health insurance from any source.', data_type: 'single_select', category: 'health', tags: ['insurance', 'health insurance', 'coverage'] },
      { uri: 'hmis:DomesticViolenceVictim', label: 'Domestic Violence Victim', definition: 'Whether the client is a victim/survivor of domestic violence.', data_type: 'single_select', category: 'safety', tags: ['domestic violence', 'dv', 'victim', 'safety'] },
      { uri: 'hmis:CurrentlyFleeing', label: 'Currently Fleeing DV', definition: 'Whether the client is currently fleeing a DV situation.', data_type: 'single_select', category: 'safety', tags: ['fleeing', 'domestic violence', 'safety', 'crisis'] },
      { uri: 'hmis:ConnectionWithSOAR', label: 'Connection with SOAR', definition: 'Whether the client is connected with SSI/SSDI Outreach, Access, and Recovery.', data_type: 'single_select', category: 'benefits', tags: ['soar', 'ssi', 'ssdi', 'benefits'] }
    ]
  },
  {
    id: 'vcard',
    name: 'vCard',
    prefix: 'http://www.w3.org/2006/vcard/ns#',
    description: 'W3C vCard ontology for contact and address information. Maps to the widely-deployed vCard standard (RFC 6350) used in phone contacts and email clients.',
    color: 'green',
    icon: 'contact',
    entries: [
      { uri: 'http://www.w3.org/2006/vcard/ns#fn', label: 'Formatted Name', definition: 'The formatted name string associated with the vCard object.', data_type: 'text', category: 'identity', tags: ['name', 'full name', 'formatted'] },
      { uri: 'http://www.w3.org/2006/vcard/ns#hasEmail', label: 'Email', definition: 'An email address associated with the object.', data_type: 'email', category: 'contact', tags: ['email', 'address'] },
      { uri: 'http://www.w3.org/2006/vcard/ns#hasTelephone', label: 'Telephone', definition: 'A telephone number associated with the object.', data_type: 'phone', category: 'contact', tags: ['phone', 'telephone'] },
      { uri: 'http://www.w3.org/2006/vcard/ns#hasAddress', label: 'Address', definition: 'A postal address associated with the object.', data_type: 'address', category: 'contact', tags: ['address', 'postal', 'mailing'] },
      { uri: 'http://www.w3.org/2006/vcard/ns#bday', label: 'Birthday', definition: 'Date of birth of the individual.', data_type: 'date', category: 'identity', tags: ['birthday', 'dob', 'birth date'] },
      { uri: 'http://www.w3.org/2006/vcard/ns#hasGeo', label: 'Geographic Location', definition: 'Geographic coordinates associated with the object.', data_type: 'text', category: 'location', tags: ['geo', 'coordinates', 'location', 'lat', 'lng'] },
      { uri: 'http://www.w3.org/2006/vcard/ns#role', label: 'Role', definition: 'The role associated with the individual within an organization.', data_type: 'text', category: 'employment', tags: ['role', 'job', 'position', 'title'] },
      { uri: 'http://www.w3.org/2006/vcard/ns#org', label: 'Organization Name', definition: 'The organization name associated with the object.', data_type: 'text', category: 'social', tags: ['organization', 'org', 'company'] },
      { uri: 'http://www.w3.org/2006/vcard/ns#note', label: 'Note', definition: 'A note associated with the object.', data_type: 'text_long', category: 'general', tags: ['note', 'comment', 'text'] },
      { uri: 'http://www.w3.org/2006/vcard/ns#hasLanguage', label: 'Language', definition: 'Language(s) associated with the object.', data_type: 'text', category: 'general', tags: ['language', 'spoken', 'preferred'] }
    ]
  },
  {
    id: 'hl7_fhir',
    name: 'HL7 FHIR',
    prefix: 'http://hl7.org/fhir/',
    description: 'Fast Healthcare Interoperability Resources — the modern standard for exchanging healthcare information electronically. Used in clinical systems, EHRs, and health information exchanges.',
    color: 'orange',
    icon: 'heart',
    entries: [
      { uri: 'http://hl7.org/fhir/Patient', label: 'Patient', definition: 'Demographics and administrative information about an individual receiving care.', data_type: 'text', category: 'identity', tags: ['patient', 'client', 'individual'] },
      { uri: 'http://hl7.org/fhir/Patient.name', label: 'Patient Name', definition: 'A name associated with the patient.', data_type: 'text', category: 'identity', tags: ['name', 'patient name'] },
      { uri: 'http://hl7.org/fhir/Patient.birthDate', label: 'Birth Date', definition: 'The date of birth for the individual.', data_type: 'date', category: 'identity', tags: ['birth date', 'dob'] },
      { uri: 'http://hl7.org/fhir/Patient.gender', label: 'Administrative Gender', definition: 'Administrative gender — the gender the patient is considered to have for administration purposes.', data_type: 'single_select', category: 'demographics', tags: ['gender', 'sex', 'administrative'] },
      { uri: 'http://hl7.org/fhir/Patient.address', label: 'Patient Address', definition: 'An address for the individual.', data_type: 'address', category: 'contact', tags: ['address', 'home', 'postal'] },
      { uri: 'http://hl7.org/fhir/Patient.telecom', label: 'Contact Point', definition: 'A contact detail (phone, email, etc.) for the individual.', data_type: 'text', category: 'contact', tags: ['phone', 'email', 'contact', 'telecom'] },
      { uri: 'http://hl7.org/fhir/Patient.maritalStatus', label: 'Marital Status', definition: 'The patient\'s most recent marital (civil) status.', data_type: 'single_select', category: 'demographics', tags: ['marital', 'married', 'single', 'status'] },
      { uri: 'http://hl7.org/fhir/Patient.communication', label: 'Communication Language', definition: 'A language which may be used to communicate with the patient about their health.', data_type: 'text', category: 'demographics', tags: ['language', 'communication', 'spoken'] },
      { uri: 'http://hl7.org/fhir/Condition', label: 'Condition', definition: 'A clinical condition, problem, diagnosis, or other event/situation.', data_type: 'text', category: 'health', tags: ['condition', 'diagnosis', 'problem', 'health'] },
      { uri: 'http://hl7.org/fhir/Observation', label: 'Observation', definition: 'Measurements and simple assertions made about a patient or other subject.', data_type: 'text', category: 'health', tags: ['observation', 'measurement', 'vital sign', 'lab'] },
      { uri: 'http://hl7.org/fhir/Encounter', label: 'Encounter', definition: 'An interaction between a patient and healthcare provider for the purpose of providing services.', data_type: 'text', category: 'service', tags: ['encounter', 'visit', 'appointment', 'session'] },
      { uri: 'http://hl7.org/fhir/ServiceRequest', label: 'Service Request', definition: 'A record of a request for a procedure or diagnostic or other service to be planned, proposed, or performed.', data_type: 'text', category: 'service', tags: ['service', 'request', 'referral', 'order'] },
      { uri: 'http://hl7.org/fhir/Consent', label: 'Consent', definition: 'A record of a healthcare consumer\'s choices regarding sharing of information.', data_type: 'text', category: 'governance', tags: ['consent', 'permission', 'authorization', 'sharing'] },
      { uri: 'http://hl7.org/fhir/RelatedPerson', label: 'Related Person', definition: 'Information about a person that is involved in the care for a patient but is not the target of healthcare.', data_type: 'text', category: 'social', tags: ['related', 'family', 'caregiver', 'emergency contact'] },
      { uri: 'http://hl7.org/fhir/MedicationStatement', label: 'Medication Statement', definition: 'A record of a medication being taken by a patient.', data_type: 'text', category: 'health', tags: ['medication', 'prescription', 'drug', 'medicine'] }
    ]
  }
];

/* Helper: flatten all URI library entries into a searchable index */
const URI_LIBRARY_INDEX = (() => {
  const index = [];
  URI_LIBRARIES.forEach(lib => {
    (lib.entries || []).forEach(entry => {
      index.push({
        ...entry,
        library_id: lib.id,
        library_name: lib.name,
        library_color: lib.color,
        library_prefix: lib.prefix,
        _searchText: [entry.label, entry.definition, entry.uri, ...(entry.tags || [])].join(' ').toLowerCase()
      });
    });
  });
  return index;
})();

/* Search across all URI libraries */
const searchUriLibraries = (query, options = {}) => {
  const { libraryId, category, limit = 50 } = options;
  if (!query || query.length < 2) {
    let pool = URI_LIBRARY_INDEX;
    if (libraryId) pool = pool.filter(e => e.library_id === libraryId);
    if (category && category !== 'all') pool = pool.filter(e => e.category === category);
    return pool.slice(0, limit);
  }
  const q = query.toLowerCase();
  const terms = q.split(/\s+/).filter(t => t.length >= 2);
  let pool = URI_LIBRARY_INDEX;
  if (libraryId) pool = pool.filter(e => e.library_id === libraryId);
  if (category && category !== 'all') pool = pool.filter(e => e.category === category);
  const scored = pool.map(entry => {
    let score = 0;
    const st = entry._searchText;
    // Exact URI match
    if (st.includes(q)) score += 10;
    // All terms present
    const allHit = terms.every(t => st.includes(t));
    if (allHit) score += 5;
    // Individual term hits
    terms.forEach(t => { if (st.includes(t)) score += 2; });
    // Label starts with query
    if (entry.label.toLowerCase().startsWith(q)) score += 8;
    // Tag exact match
    if ((entry.tags || []).some(t => t === q)) score += 6;
    return { ...entry, _score: score };
  }).filter(e => e._score > 0);
  scored.sort((a, b) => b._score - a._score);
  return scored.slice(0, limit);
};

/* ═══════════════════ RESOURCE TRACKING CONSTANTS (§Resource Build) ═══════════════════ */
// DES(resources.vocabulary, {categories, opacity, relations, permissions}) — resource_tracking

/** Resource categories — the top-level classification for resource types */
const RESOURCE_CATEGORIES = ['housing',
// beds, units, vouchers, rental assistance
'financial',
// emergency funds, deposits, stipends
'transportation',
// bus passes, ride vouchers, gas cards
'food',
// meals, pantry bags, grocery cards
'health',
// medical supplies, prescriptions, hygiene kits
'employment',
// job training slots, interview clothing, tools
'legal',
// legal aid hours, document preparation
'education',
// tutoring hours, school supplies, enrollment slots
'general' // catch-all for org-specific items
];
const RESOURCE_CATEGORY_LABELS = {
  housing: 'Housing',
  financial: 'Financial',
  transportation: 'Transportation',
  food: 'Food',
  health: 'Health',
  employment: 'Employment',
  legal: 'Legal',
  education: 'Education',
  general: 'General'
};
const RESOURCE_CATEGORY_COLORS = {
  housing: 'blue',
  financial: 'green',
  transportation: 'teal',
  food: 'orange',
  health: 'red',
  employment: 'gold',
  legal: 'purple',
  education: 'blue',
  general: 'teal'
};

/**
 * Opacity levels control resource visibility. Defaults to SOVEREIGN (holder-only).
 * The holder controls disclosure — not the network admin.
 */
const RESOURCE_OPACITY = {
  SOVEREIGN: 0,
  // holder-only, no one else sees it
  ATTESTED: 1,
  // shared with specific partners via bridge
  CONTRIBUTED: 2,
  // visible in network resource commons
  PUBLISHED: 3 // externally visible (API, 211 feed, directory)
};
const RESOURCE_OPACITY_LABELS = {
  0: 'Sovereign',
  1: 'Attested',
  2: 'Contributed',
  3: 'Published'
};
const RESOURCE_OPACITY_DESCRIPTIONS = {
  0: 'Only visible to the holding org',
  1: 'Shared with specific partners via bridge',
  2: 'Visible in network resource commons',
  3: 'Externally visible (API, directory)'
};

/** Relation types describe how a holder relates to a resource */
const RESOURCE_RELATION_TYPES = ['operates',
// org runs/owns the resource directly
'funds',
// org provides funding for the resource
'refers_to',
// org can refer clients to this resource
'contributes_to',
// org contributes inventory to a shared pool
'transfers' // one-time transfer between orgs
];
const RESOURCE_RELATION_LABELS = {
  operates: 'Operates',
  funds: 'Funds',
  refers_to: 'Refers to',
  contributes_to: 'Contributes to',
  transfers: 'Transfers'
};

/** Allocation statuses */
const RESOURCE_ALLOC_STATUSES = ['active', 'consumed', 'expired', 'revoked'];

/** Lifecycle event types */
const RESOURCE_LIFECYCLE_EVENTS = ['allocated', 'consumed', 'expired', 'revoked', 'returned'];

/** Dedup link statuses */
const RESOURCE_DEDUP_STATUSES = ['confirmed', 'attested_non_additive', 'unresolved'];

/** Dedup link types */
const RESOURCE_DEDUP_LINK_TYPES = ['subset', 'same', 'overlaps'];

/**
 * Resource permission abilities. Each resource type carries a `permissions` object
 * mapping these abilities to arrays of grants (role-based or user-specific).
 *
 * Grant shape: { type: 'role'|'user', id: string }
 *   type:'role'  → id is an ORG_ROLE (e.g. 'admin', 'case_manager')
 *   type:'user'  → id is a Matrix user ID (e.g. '@alice:matrix.org')
 *
 * Abilities:
 *   controllers — can edit, delete, and configure the resource type
 *   allocators  — can allocate this resource to clients
 *   viewers     — can see this resource in the catalog (empty array = everyone)
 */
const RESOURCE_PERMISSION_ABILITIES = ['controllers', 'allocators', 'viewers'];
const RESOURCE_PERMISSION_LABELS = {
  controllers: 'Controllers',
  allocators: 'Allocators',
  viewers: 'Viewers'
};
const RESOURCE_PERMISSION_DESCRIPTIONS = {
  controllers: 'Can edit, configure, and delete this resource type',
  allocators: 'Can allocate this resource to clients',
  viewers: 'Can see this resource in the catalog (empty = everyone)'
};
const RESOURCE_PERMISSION_ICONS = {
  controllers: 'settings',
  allocators: 'send',
  viewers: 'eye'
};
const RESOURCE_PERMISSION_COLORS = {
  controllers: 'gold',
  allocators: 'blue',
  viewers: 'teal'
};

/** Default permissions for a newly created resource type (creator is admin → full control) */
function buildDefaultResourcePermissions() {
  return {
    controllers: [{
      type: 'role',
      id: 'admin'
    }],
    allocators: [{
      type: 'role',
      id: 'admin'
    }, {
      type: 'role',
      id: 'case_manager'
    }, {
      type: 'role',
      id: 'provider'
    }],
    viewers: [] // empty = everyone in the org
  };
}

/* ═══════════════════ ROLE INFERENCE (MVP §Screen 1) ═══════════════════
 * Operator Manifest:
 *   DES(identity.user_roles, {via: room_membership_scan}) — identity_classification
 *
 * Triad Summary:
 *   Existence:       DES (classify user into roles)
 *   Structure:       —
 *   Interpretation:  —
 *   No mutations — read-only scan. No REC — role frame is stable.
 *
 * Roles are detected from room memberships — no account-type selector.
 * A user can have multiple roles simultaneously.
 * ═══════════════════════════════════════════════════════════ */
const ROLES = {
  client: {
    id: 'client',
    label: 'Personal',
    icon: 'shield',
    color: 'teal',
    desc: 'Data owner with a Personal account and vault'
  },
  provider: {
    id: 'provider',
    label: 'Team Member',
    icon: 'briefcase',
    color: 'gold',
    desc: 'Case manager or outreach worker'
  },
  org_admin: {
    id: 'org_admin',
    label: 'Org Admin',
    icon: 'users',
    color: 'blue',
    desc: 'Organization administrator'
  },
  network: {
    id: 'network',
    label: 'Network Coordinator',
    icon: 'globe',
    color: 'green',
    desc: 'Network governance steward'
  }
};

// DES(identity.user_roles, {via: room_membership_scan}) — identity_classification
// Scans all rooms to determine user's active roles via structural evidence
function inferRolesFromRooms(scannedState, userId) {
  const roles = new Set();
  for (const [roomId, state] of Object.entries(scannedState)) {
    const id = state[EVT.IDENTITY];
    if (!id) continue;
    // Client vault owned by this user → client role
    if (id.account_type === 'client' && id.owner === userId) roles.add('client');
    // Provider roster owned by this user → provider role
    if (id.account_type === 'provider' && id.owner === userId) roles.add('provider');
    // Org room where user is in staff roster → provider role
    if (id.account_type === 'organization') roles.add('provider');
    // Network room → network coordinator role (checked via power levels separately)
    if (id.account_type === 'network') roles.add('provider');
    // Bridge room where user is the provider side → provider role
    const bridge = state[EVT.BRIDGE_META];
    if (bridge && bridge.provider === userId) roles.add('provider');
    // Bridge room where user is the client side → client role
    if (bridge && bridge.client === userId) roles.add('client');
  }
  // Check for org admin role by examining org rosters
  for (const [roomId, state] of Object.entries(scannedState)) {
    const id = state[EVT.IDENTITY];
    const roster = state[EVT.ORG_ROSTER];
    if (id?.account_type === 'organization' && roster?.staff) {
      const staffEntry = roster.staff.find(s => s.userId === userId);
      if (staffEntry?.role === 'admin') roles.add('org_admin');
    }
  }
  return [...roles];
}

/* ═══════════════════ MATRIX SERVICE ═══════════════════
 * Operator Manifest:
 *   INS(matrix.session, {credentials}) — authentication                — login
 *   INS(crypto.vault_key, {via: hkdf}) — at_rest_encryption           — login key derivation
 *   NUL(matrix.legacy_stores, {reason: purge}) — security_cleanup     — login cleanup
 *   DES(matrix.session, {check: whoami}) — token_validation           — restoreSession
 *   INS(matrix.room, {e2ee, state}) — room_creation                   — createRoom
 *   INS(matrix.bridge_room, {power_levels}) — client_sovereign_creation — createClientRoom
 *   ALT(matrix.room_state, {state_event}) — protocol_mutation         — setState
 *   INS(matrix.timeline_event, {room}) — event_emission               — sendEvent
 *   DES(matrix.room_topology, {via: sync_state}) — room_classification — scanRooms
 *   NUL(matrix.session+keys+cache, {reason: logout}) — full_teardown  — logout
 *
 * Triad Summary:
 *   Existence:       INS (sessions, rooms, events), NUL (logout, purge)
 *   Structure:       CON (bridge creation links client ↔ provider)
 *   Interpretation:  ALT (state events), DES (room classification)
 *   No REC — KhoraService is a transport layer; it never reinterprets data.
 * ═══════════════════════════════════════════════════════════ */
class KhoraService {
  constructor() {
    this.client = null;
    this._baseUrl = null;
    this._token = null;
    this._userId = null;
    this._timelineListenerAttached = false;
  }

  // Register real-time timeline event listener on the Matrix client.
  // Dispatches DOM CustomEvents so React components can react instantly
  // to new Khora events without polling.
  _setupTimelineListener() {
    if (!this.client || this._timelineListenerAttached) return;
    this._timelineListenerAttached = true;
    const khoraPrefix = NS + '.';
    this.client.on('Room.timeline', (event, room, toStartOfTimeline) => {
      if (toStartOfTimeline) return; // ignore historical pagination
      const type = event.getType();
      // Only fire for Khora-namespaced events (io.khora.*)
      if (!type.startsWith(khoraPrefix)) return;
      const detail = {
        eventId: event.getId(),
        roomId: room?.roomId,
        type,
        content: event.getContent(),
        sender: event.getSender(),
        ts: event.getTs(),
        isOwn: event.getSender() === this._userId
      };
      window.dispatchEvent(new CustomEvent('khora:timeline', {
        detail
      }));
    });
    // Also listen for state events to catch schema/org/roster changes
    this.client.on('RoomState.events', (event, roomState) => {
      const type = event.getType();
      if (!type.startsWith(khoraPrefix)) return;
      const detail = {
        eventId: event.getId(),
        roomId: roomState?.roomId,
        type,
        content: event.getContent(),
        sender: event.getSender(),
        ts: event.getTs(),
        isState: true,
        isOwn: event.getSender() === this._userId
      };
      window.dispatchEvent(new CustomEvent('khora:state', {
        detail
      }));
    });
  }
  async _withRetry(fn, maxAttempts = 5) {
    for (let attempt = 0; attempt < maxAttempts; attempt++) {
      try {
        return await fn();
      } catch (e) {
        const msg = (e?.data?.error || e?.message || '').toLowerCase();
        const retryMs = e?.data?.retry_after_ms;
        if (msg.includes('too many') || msg.includes('rate') || msg.includes('limit') || retryMs) {
          const wait = Math.min(retryMs || 1000 * Math.pow(2, attempt), 16000);
          await new Promise(r => setTimeout(r, wait));
          continue;
        }
        throw e;
      }
    }
    throw new Error('Rate limited — too many requests. Please try again.');
  }

  // INS(matrix.session, {credentials}) — authentication → INS(crypto.vault_key, {via: hkdf}) — at_rest_encryption → NUL(matrix.legacy_stores, {reason: purge}) — cleanup
  async login(homeserver, user, pass) {
    const baseUrl = homeserver.startsWith('http') ? homeserver : `https://${homeserver}`;
    this._baseUrl = baseUrl;
    if (typeof matrixcs !== 'undefined') {
      this.client = matrixcs.createClient({
        baseUrl
      });
      const res = await this.client.login('m.login.password', {
        user,
        password: pass
      });
      // Derive per-user at-rest encryption key (AES-256-GCM via HKDF from access token)
      // Only this user's session can decrypt local IndexedDB data
      await LocalVaultCrypto.deriveKey(res.user_id, res.access_token, res.device_id);
      // Purge any legacy unencrypted IndexedDB databases (preserves Matrix crypto store for E2EE)
      await this._purgeUnencryptedStores();
      this.client = matrixcs.createClient({
        baseUrl,
        accessToken: res.access_token,
        userId: res.user_id,
        deviceId: res.device_id
      });
      try {
        await this.client.initCrypto();
      } catch (e) {
        console.warn('Crypto:', e.message);
      }
      await this.client.startClient({
        initialSyncLimit: 30
      });
      await new Promise((resolve, reject) => {
        if (this.client.isInitialSyncComplete()) return resolve();
        const timeout = setTimeout(() => reject(new Error('Sync timed out — the server may be overloaded. Please try again.')), 60000);
        this.client.on('sync', (state, prev, data) => {
          if (state === 'PREPARED') {
            clearTimeout(timeout);
            resolve();
          } else if (state === 'ERROR') {
            clearTimeout(timeout);
            reject(new Error(data?.error?.message || 'Sync failed — please try again.'));
          }
        });
      });
      this._userId = res.user_id;
      this._token = res.access_token;
      // Attach real-time timeline event listener
      this._setupTimelineListener();
      // Persist session to localStorage so it survives page refresh, tab close, and browser restart
      try {
        localStorage.setItem('khora_session', JSON.stringify({
          homeserver: baseUrl,
          accessToken: res.access_token,
          userId: res.user_id,
          deviceId: res.device_id
        }));
      } catch {}
      // Cache encrypted session metadata in the encrypted vault
      try {
        await KhoraEncryptedCache.put('session', 'current', {
          userId: res.user_id,
          homeserver: baseUrl,
          deviceId: res.device_id,
          ts: Date.now()
        });
      } catch {}
      return {
        userId: res.user_id
      };
    } else {
      const baseUrlFallback = homeserver.startsWith('http') ? homeserver : `https://${homeserver}`;
      const resp = await this._api('POST', '/login', {
        type: 'm.login.password',
        user,
        password: pass
      }, true);
      this._token = resp.access_token;
      this._userId = resp.user_id;
      // Persist session to localStorage so it survives page refresh (non-SDK path)
      try {
        localStorage.setItem('khora_session', JSON.stringify({
          homeserver: baseUrlFallback,
          accessToken: resp.access_token,
          userId: resp.user_id,
          deviceId: resp.device_id || 'fallback'
        }));
      } catch {}
      return {
        userId: resp.user_id
      };
    }
  }

  // DES(matrix.session, {check: whoami}) — token_validation → INS(matrix.client, {valid_token}) — reconnection | NUL(matrix.session, {reason: expired}) — destruction
  async restoreSession() {
    const raw = localStorage.getItem('khora_session');
    if (!raw) return null;
    let saved;
    try {
      saved = JSON.parse(raw);
    } catch {
      localStorage.removeItem('khora_session');
      return null;
    }
    const {
      homeserver,
      accessToken,
      userId,
      deviceId
    } = saved;
    if (!homeserver || !accessToken || !userId || !deviceId) return null;

    // Step 1: Validate token with the homeserver (lightweight /whoami check)
    // Retry transient network failures with exponential backoff before giving up
    let tokenValid = false;
    for (let attempt = 0; attempt < 4; attempt++) {
      try {
        const resp = await fetch(`${homeserver}/_matrix/client/v3/account/whoami`, {
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });
        if (resp.ok) {
          tokenValid = true;
          break;
        }
        if (resp.status === 401 || resp.status === 403) {
          // Token expired or revoked — clear saved session, require fresh login
          console.warn('Session token expired or revoked (HTTP ' + resp.status + ')');
          localStorage.removeItem('khora_session');
          return {
            expired: true
          };
        }
        // Server error (5xx) — treat as transient, retry
        if (resp.status >= 500) {
          await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
          continue;
        }
        // Other client error — don't retry
        break;
      } catch (e) {
        // Network error (offline, DNS failure, etc.) — retry with backoff
        console.warn('Session restore network error (attempt ' + (attempt + 1) + '):', e.message);
        if (attempt < 3) {
          await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
          continue;
        }
        // All retries exhausted — keep the saved session intact for next app load
        // but return a network error so the UI can offer retry
        return {
          networkError: true,
          message: e.message
        };
      }
    }
    if (!tokenValid) {
      // Retries exhausted on server errors — preserve session for next load
      return {
        networkError: true,
        message: 'Server unavailable'
      };
    }

    // Step 2: Token is valid — initialize the Matrix client and sync
    try {
      this._baseUrl = homeserver;
      await LocalVaultCrypto.deriveKey(userId, accessToken, deviceId);
      if (typeof matrixcs !== 'undefined') {
        this.client = matrixcs.createClient({
          baseUrl: homeserver,
          accessToken,
          userId,
          deviceId
        });
        try {
          await this.client.initCrypto();
        } catch (e) {
          console.warn('Crypto:', e.message);
        }
        await this.client.startClient({
          initialSyncLimit: 30
        });
        await new Promise((resolve, reject) => {
          if (this.client.isInitialSyncComplete()) return resolve();
          const timeout = setTimeout(() => reject(new Error('Sync timed out')), 90000);
          this.client.on('sync', (state, prev, data) => {
            if (state === 'PREPARED') {
              clearTimeout(timeout);
              resolve();
            } else if (state === 'ERROR') {
              clearTimeout(timeout);
              reject(new Error(data?.error?.message || 'Sync failed'));
            }
          });
        });
      }
      this._userId = userId;
      this._token = accessToken;
      // Attach real-time timeline event listener
      this._setupTimelineListener();
      return {
        userId
      };
    } catch (e) {
      console.warn('Session restore sync failed:', e.message);
      // Sync failure after valid token — keep session, allow retry
      // Clean up partial client state but preserve localStorage
      if (this.client) {
        try {
          this.client.stopClient();
        } catch {}
      }
      this.client = null;
      this._token = null;
      this._userId = null;
      LocalVaultCrypto.clear();
      return {
        networkError: true,
        message: e.message
      };
    }
  }
  get userId() {
    return this._userId;
  }
  get hasCrypto() {
    return this.client && typeof this.client.isCryptoEnabled === 'function' && this.client.isCryptoEnabled();
  }
  async _api(method, path, body, noAuth) {
    const url = `${this._baseUrl}/_matrix/client/v3${path}`;
    const h = {
      'Content-Type': 'application/json'
    };
    if (!noAuth) h['Authorization'] = `Bearer ${this._token}`;
    const opts = {
      method,
      headers: h
    };
    if (body) opts.body = JSON.stringify(body);
    for (let attempt = 0; attempt < 5; attempt++) {
      const r = await fetch(url, opts);
      if (r.status === 429) {
        const err = await r.json().catch(() => ({}));
        const wait = Math.min(err.retry_after_ms || 1000 * Math.pow(2, attempt), 16000);
        await new Promise(res => setTimeout(res, wait));
        continue;
      }
      if (!r.ok) {
        const e = await r.json().catch(() => ({}));
        throw new Error(e.error || `API ${r.status}`);
      }
      return r.json();
    }
    throw new Error('Rate limited — too many requests. Please try again.');
  }

  // INS(matrix.room, {e2ee, state}) — room_creation — Megolm encryption enabled by default
  async createRoom(name, topic, extraState = []) {
    const initial_state = [{
      type: 'm.room.encryption',
      state_key: '',
      content: {
        algorithm: 'm.megolm.v1.aes-sha2'
      }
    }, ...extraState];
    if (this.client) {
      const r = await this._withRetry(() => this.client.createRoom({
        name,
        topic,
        visibility: 'private',
        preset: 'private_chat',
        initial_state
      }));
      return r.room_id;
    } else {
      const r = await this._api('POST', '/createRoom', {
        name,
        topic,
        visibility: 'private',
        preset: 'private_chat',
        initial_state
      });
      return r.room_id;
    }
  }

  // INS(matrix.bridge_room, {power_levels}) — client_sovereign_creation — client PL 100, provider PL 50
  async createClientRoom(name, topic, extraState = [], clientMatrixId = null) {
    const initial_state = [{
      type: 'm.room.encryption',
      state_key: '',
      content: {
        algorithm: 'm.megolm.v1.aes-sha2'
      }
    }, ...extraState];
    const opts = {
      name,
      topic,
      visibility: 'private',
      preset: 'private_chat',
      initial_state
    };
    // If we know the client's Matrix ID, pre-set them as room admin (PL 100)
    // Provider gets PL 50 — client can kick provider but not vice versa.
    // We must explicitly set `events` to override the preset defaults (which require
    // PL 100 for m.room.encryption etc.) — otherwise initial_state events fail
    // because the provider only has PL 50.
    if (clientMatrixId) {
      opts.power_level_content_override = {
        users: {
          [this._userId]: 50,
          [clientMatrixId]: 100
        },
        events_default: 0,
        state_default: 50,
        events: {
          'm.room.power_levels': 100,
          'm.room.tombstone': 100,
          'm.room.server_acl': 100
        },
        kick: 50,
        ban: 50,
        invite: 50,
        redact: 50
      };
    }
    if (this.client) {
      const r = await this._withRetry(() => this.client.createRoom(opts));
      return r.room_id;
    } else {
      const r = await this._api('POST', '/createRoom', opts);
      return r.room_id;
    }
  }
  async setPowerLevel(roomId, userId, level) {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      if (room) {
        const plEvent = room.currentState.getStateEvents('m.room.power_levels', '');
        const content = plEvent ? {
          ...plEvent.getContent()
        } : {};
        content.users = {
          ...(content.users || {}),
          [userId]: level
        };
        await this._withRetry(() => this.client.sendStateEvent(roomId, 'm.room.power_levels', content, ''));
      }
    } else {
      let current;
      try {
        current = await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/state/m.room.power_levels/`);
      } catch {
        current = {};
      }
      current.users = {
        ...(current.users || {}),
        [userId]: level
      };
      await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/state/m.room.power_levels/`, current);
    }
  }
  async getState(roomId, type, sk = '') {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      if (!room) return null;
      const ev = room.currentState.getStateEvents(type, sk);
      return ev ? ev.getContent() : null;
    }
    try {
      return await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/state/${type}/${sk}`);
    } catch {
      return null;
    }
  }

  // ALT(matrix.room_state, {state_event}) — protocol_mutation — write state to Matrix room
  async setState(roomId, type, content, sk = '') {
    if (this.client) {
      await this._withRetry(() => this.client.sendStateEvent(roomId, type, content, sk));
    } else {
      await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/state/${type}/${sk}`, content);
    }
  }

  // INS(matrix.timeline_event, {room}) — event_emission — with crypto fallback for E2EE errors
  async sendEvent(roomId, type, content) {
    if (this.client) {
      try {
        await this._withRetry(() => this.client.sendEvent(roomId, type, content));
      } catch (e) {
        // Fallback to REST API if SDK sendEvent fails (e.g. crypto/encryption errors)
        const msg = (e?.message || '').toLowerCase();
        if (msg.includes('encrypt') || msg.includes('olm') || msg.includes('megolm') || msg.includes('crypto') || msg.includes('unknown devices') || msg.includes('no olm')) {
          console.warn('sendEvent crypto fallback for', type, ':', e.message);
          const txn = 'txn_' + Date.now() + Math.random().toString(36).slice(2);
          await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/send/${encodeURIComponent(type)}/${txn}`, content);
        } else {
          throw e;
        }
      }
    } else {
      const txn = 'txn_' + Date.now() + Math.random().toString(36).slice(2);
      await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/send/${encodeURIComponent(type)}/${txn}`, content);
    }
  }
  async sendMessage(roomId, body, extra = {}) {
    const content = {
      msgtype: 'm.text',
      body,
      ...extra,
      timestamp: Date.now()
    };
    if (this.client) {
      await this._withRetry(() => this.client.sendMessage(roomId, content));
    } else {
      const txn = 'txn_' + Date.now() + Math.random().toString(36).slice(2);
      await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/send/m.room.message/${txn}`, content);
    }
  }
  async getMessages(roomId, limit = 40) {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      if (!room) return [];
      // Paginate backwards to capture historical messages beyond the live sync window
      try {
        for (let i = 0; i < 3; i++) {
          const canPaginate = room.getLiveTimeline().getPaginationToken('b');
          if (!canPaginate) break;
          await this.client.scrollback(room, limit);
        }
      } catch (e) {/* pagination may fail — continue with available events */}
      const seenIds = new Set();
      const allMsgs = [];
      const timelineSets = room.getTimelineSets ? room.getTimelineSets() : [];
      if (timelineSets.length > 0) {
        for (const ts of timelineSets) {
          for (const tl of ts.getTimelines()) {
            for (const ev of tl.getEvents()) {
              if (ev.getType() === 'm.room.message' && !seenIds.has(ev.getId())) {
                seenIds.add(ev.getId());
                allMsgs.push({
                  id: ev.getId(),
                  sender: ev.getSender(),
                  content: ev.getContent(),
                  ts: ev.getTs()
                });
              }
            }
          }
        }
      } else {
        for (const ev of room.getLiveTimeline().getEvents()) {
          if (ev.getType() === 'm.room.message') {
            allMsgs.push({
              id: ev.getId(),
              sender: ev.getSender(),
              content: ev.getContent(),
              ts: ev.getTs()
            });
          }
        }
      }
      return allMsgs.sort((a, b) => a.ts - b.ts).slice(-limit).reverse();
    }
    const d = await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/messages?dir=b&limit=${limit}`);
    return (d.chunk || []).filter(e => e.type === 'm.room.message').map(e => ({
      id: e.event_id,
      sender: e.sender,
      content: e.content,
      ts: e.origin_server_ts
    }));
  }
  async invite(roomId, userId) {
    if (this.client) {
      await this.client.invite(roomId, userId);
    } else {
      await this._api('POST', `/rooms/${encodeURIComponent(roomId)}/invite`, {
        user_id: userId
      });
    }
  }
  async kick(roomId, userId, reason = 'Removed') {
    if (this.client) {
      await this.client.kick(roomId, userId, reason);
    } else {
      await this._api('POST', `/rooms/${encodeURIComponent(roomId)}/kick`, {
        user_id: userId,
        reason
      });
    }
  }
  async tombstone(roomId, newRoomId) {
    await this.setState(roomId, 'm.room.tombstone', {
      body: 'This room has been replaced',
      replacement_room: newRoomId
    });
  }
  async getJoinedRooms() {
    if (this.client) return this.client.getRooms().map(r => r.roomId);
    const d = await this._api('GET', '/joined_rooms');
    return d.joined_rooms || [];
  }
  async getRoomMembers(roomId) {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      return room ? room.getJoinedMembers().map(m => ({
        userId: m.userId,
        name: m.name
      })) : [];
    }
    try {
      const d = await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/joined_members`);
      return Object.keys(d.joined || {}).map(id => ({
        userId: id,
        name: d.joined[id]?.display_name || id
      }));
    } catch {
      return [];
    }
  }

  // DES(matrix.room_topology, {via: sync_state}) — room_classification — read-only scan, caches to encrypted IDB
  // Batch-fetch all Khora state across joined rooms in a single request.
  // When the SDK is available, reads local sync state (no HTTP calls).
  // When using the API fallback, uses /sync with a tight filter — one request
  // instead of 2*N individual getState calls that produce 404s for non-Khora rooms.
  // Returns: { [roomId]: { [eventType]: content } }
  // Results are cached in the encrypted local vault (KhoraEncryptedCache).
  async scanRooms(extraTypes = []) {
    const types = [EVT.IDENTITY, EVT.BRIDGE_META, EVT.BRIDGE_REFS, ...extraTypes];
    if (this.client) {
      const result = {};
      for (const room of this.client.getRooms()) {
        const state = {};
        for (const type of types) {
          const ev = room.currentState.getStateEvents(type, '');
          if (ev) state[type] = ev.getContent();
        }
        if (Object.keys(state).length > 0) result[room.roomId] = state;
      }
      // Persist room state to encrypted local cache
      try {
        await KhoraEncryptedCache.put('rooms', 'scan_result', {
          data: result,
          ts: Date.now()
        });
      } catch {}
      return result;
    }
    // Fallback: single /sync with filter — avoids per-room 404 spam
    const filter = JSON.stringify({
      room: {
        state: {
          types
        },
        timeline: {
          limit: 0
        },
        ephemeral: {
          types: []
        }
      },
      presence: {
        types: []
      },
      account_data: {
        types: []
      }
    });
    try {
      const data = await this._api('GET', `/sync?filter=${encodeURIComponent(filter)}&timeout=0`);
      const result = {};
      const joined = data?.rooms?.join || {};
      for (const [roomId, roomData] of Object.entries(joined)) {
        const events = roomData?.state?.events || [];
        const state = {};
        for (const ev of events) {
          if (ev.state_key === '') state[ev.type] = ev.content;
        }
        if (Object.keys(state).length > 0) result[roomId] = state;
      }
      return result;
    } catch (e) {
      console.warn('scanRooms sync fallback failed, falling back to per-room scan:', e.message);
      // Last resort: per-room scan (original behavior)
      const rooms = await this.getJoinedRooms();
      const result = {};
      for (const rid of rooms) {
        try {
          const allState = await this._api('GET', `/rooms/${encodeURIComponent(rid)}/state`);
          const state = {};
          for (const ev of allState) {
            if (ev.state_key === '' && types.includes(ev.type)) state[ev.type] = ev.content;
          }
          if (Object.keys(state).length > 0) result[rid] = state;
        } catch {/* skip rooms we can't read */}
      }
      return result;
    }
  }

  // NUL(matrix.legacy_idb, {targets: store_names}) — security_cleanup
  // Purge unencrypted IndexedDB databases created by the Matrix SDK sync layer
  // or legacy application caches. Preserves crypto stores (Olm/Megolm key material
  // needed for E2EE continuity) and our own encrypted vault.
  async _purgeUnencryptedStores() {
    if (typeof indexedDB?.databases === 'function') {
      try {
        const dbs = await indexedDB.databases();
        for (const db of dbs) {
          // Keep our encrypted vault and any crypto key stores
          if (db.name && db.name !== KhoraEncryptedCache.DB_NAME && !db.name.includes('crypto')) {
            try {
              indexedDB.deleteDatabase(db.name);
            } catch {}
          }
        }
      } catch (e) {
        console.warn('IndexedDB purge:', e.message);
      }
    }
    // Explicitly target known unencrypted sync/state databases by name
    for (const name of ['amino', 'matrix-js-sdk:default', 'matrix-js-sdk:riot-web-sync', 'matrix-js-sdk:web-sync']) {
      try {
        indexedDB.deleteDatabase(name);
      } catch {}
    }
  }

  // NUL(matrix.session+keys+cache, {reason: logout}) — full_teardown — destroys all local state
  async logout() {
    if (this.client) {
      this.client.stopClient();
      try {
        await this.client.logout();
      } catch {}
    }
    this.client = null;
    this._token = null;
    this._userId = null;
    // NUL(crypto.vault_key, {reason: logout}) — key_destruction — local encrypted data becomes unreadable
    LocalVaultCrypto.clear();
    // Wipe encrypted local cache and close database connection
    try {
      await KhoraEncryptedCache.clear();
      KhoraEncryptedCache.close();
    } catch {}
    // Purge any remaining unencrypted databases
    try {
      await this._purgeUnencryptedStores();
    } catch {}
  }

  // Scan invited rooms — returns rooms the user has been invited to but hasn't joined.
  // Uses invite state from /sync (SDK) or invite section of sync response (API).
  async scanInvitedRooms(types = [EVT.IDENTITY]) {
    if (this.client) {
      const result = {};
      for (const room of this.client.getRooms()) {
        const membership = room.getMyMembership();
        if (membership !== 'invite') continue;
        const state = {};
        for (const type of types) {
          const ev = room.currentState.getStateEvents(type, '');
          if (ev) state[type] = ev.getContent();
        }
        if (Object.keys(state).length > 0) result[room.roomId] = state;
      }
      return result;
    }
    // API fallback: /sync includes invite section with stripped state
    const filter = JSON.stringify({
      room: {
        state: {
          types
        },
        timeline: {
          limit: 0
        },
        ephemeral: {
          types: []
        }
      },
      presence: {
        types: []
      },
      account_data: {
        types: []
      }
    });
    try {
      const data = await this._api('GET', `/sync?filter=${encodeURIComponent(filter)}&timeout=0`);
      const result = {};
      const invited = data?.rooms?.invite || {};
      for (const [roomId, roomData] of Object.entries(invited)) {
        const events = roomData?.invite_state?.events || [];
        const state = {};
        for (const ev of events) {
          if (ev.state_key === '' && types.includes(ev.type)) state[ev.type] = ev.content;
        }
        if (Object.keys(state).length > 0) result[roomId] = state;
      }
      return result;
    } catch {
      return {};
    }
  }
  async joinRoom(roomId) {
    if (this.client) {
      await this._withRetry(() => this.client.joinRoom(roomId));
    } else {
      await this._api('POST', `/join/${encodeURIComponent(roomId)}`, {});
    }
  }
}
const svc = new KhoraService();
const WEBHOOK_BASE = 'https://n8n.intelechia.com/webhook';

/* ═══════════════════ DOMAIN CONFIG (§C.0) ═══════════════════
 * Operator Manifest:
 *   DES — pure designation. Forms, interpretations, transforms, vault fields,
 *         roles, relationship types, terminology. All are vocabulary definitions.
 *
 * Triad Summary:
 *   Existence:       DES (naming forms, fields, authorities, roles)
 *   Structure:       —
 *   Interpretation:  —
 *   No mutations here. DOMAIN_CONFIG is the interpretive frame that other modules
 *   reference. All actual INS/ALT/CON/REC operations happen elsewhere using
 *   these designations. Changing DOMAIN_CONFIG changes the vocabulary itself —
 *   which is a meta-level REC, but not one performed by code at runtime.
 *
 * All domain-specific content is consolidated here. To adapt Tessera for a
 * different sector, replace the contents of DOMAIN_CONFIG — the application
 * logic, encryption model, bridge topology, and EO operator layer are all
 * domain-agnostic.
 * ═══════════════════════════════════════════════════════════════════════════ */
const DOMAIN_CONFIG = {
  /* ═══════════════════════════════════════════════════════════════════════════
   * FORMS — Structured GIVEN Data Collection
   *
   * Forms are the primary artifact of the schema system. A form is a versioned
   * collection of fields that collects structured data at the GIVEN level —
   * what actually happened, observed by or about the client.
   *
   * Forms are authored at the network or org level and propagate downward:
   *   Network → Organization → Provider → Client
   *
   * Propagation levels control how member orgs interact with network forms:
   *   required  — Auto-applied, immutable at org level
   *   standard  — Auto-applied, orgs may extend (additive only)
   *   recommended — Org reviews, decides whether to adopt
   *   optional  — Available in catalog, no adoption expectation
   *
   * Each form groups related fields into a coherent data collection instrument
   * that can be versioned, governed, and propagated as a unit.
   * ═══════════════════════════════════════════════════════════════════════════ */
  forms: [{
    id: 'form_status_engagement',
    name: 'Status & Engagement',
    version: 1,
    description: 'Track your current status and any meetings or contacts with your providers',
    maturity: 'normative',
    source: {
      level: 'network',
      propagation: 'required'
    },
    eo: {
      chain: [{
        op: 'DES',
        target: {
          entity: 'form_status_engagement',
          designation: 'Status & Engagement Form'
        },
        frame: {
          type: 'schema',
          epistemic: 'GIVEN',
          role: 'network'
        }
      }],
      trace: 'form_status_engagement = DES (network-authored, required propagation)'
    },
    fields: [{
      id: 'prompt_current_status',
      key: 'current_status',
      question: 'What is your current status?',
      type: 'single_select',
      version: 1,
      maturity: 'normative',
      section: 'status',
      eo: {
        chain: [{
          op: 'DES',
          target: {
            entity: 'current_status',
            designation: 'Current Status Field'
          },
          frame: {
            type: 'schema',
            epistemic: 'GIVEN',
            role: 'network'
          }
        }, {
          op: 'CON',
          target: {
            source: 'current_status',
            destination: 'ext:standard_1.01'
          },
          context: {
            authority_id: 'auth_ext_standard',
            element: 'ext_1',
            authority_name: 'External Reporting Standard'
          }
        }, {
          op: 'SEG',
          target: {
            field: 'response_options',
            entity: 'current_status'
          },
          context: {
            rationale: 'Simplified from full reporting standard for field use',
            excluded: ['administrative_hold', 'archived']
          }
        }],
        trace: 'current_status = DES → CON(ext:standard_1.01) → SEG({field simplified})'
      },
      options: [{
        v: 'active',
        l: 'Active — currently receiving services',
        eo: {
          op: 'SYN',
          target: {
            local: 'active',
            external: 'ext:standard_1.01:a'
          }
        }
      }, {
        v: 'on_hold',
        l: 'On hold — temporarily paused',
        eo: {
          op: 'SYN',
          target: {
            local: 'on_hold',
            external: 'ext:standard_1.01:b'
          }
        }
      }, {
        v: 'pending_review',
        l: 'Pending review',
        eo: {
          op: 'SYN',
          target: {
            local: 'pending_review',
            external: 'ext:standard_1.01:c'
          }
        }
      }, {
        v: 'resolved',
        l: 'Resolved — services completed',
        eo: {
          op: 'SYN',
          target: {
            local: 'resolved',
            external: 'ext:standard_1.01:d'
          }
        }
      }, {
        v: 'other',
        l: 'Other',
        eo: {
          op: 'INS',
          target: {
            local: 'other'
          },
          context: {
            note: 'Catch-all not in reporting taxonomy'
          }
        }
      }],
      category: 'status',
      sensitive: false,
      metrics: true
    }, {
      id: 'prompt_engagement',
      key: 'engagement_type',
      question: 'What engagement occurred?',
      type: 'single_select',
      version: 1,
      maturity: 'normative',
      section: 'engagement',
      eo: {
        chain: [{
          op: 'DES',
          target: {
            entity: 'engagement_type',
            designation: 'Engagement Type Field'
          },
          frame: {
            type: 'schema',
            epistemic: 'GIVEN',
            role: 'network'
          }
        }, {
          op: 'CON',
          target: {
            source: 'engagement_type',
            destination: 'svc:direct_services'
          },
          context: {
            authority_id: 'auth_service_taxonomy',
            authority_name: 'Service Taxonomy'
          }
        }],
        trace: 'engagement_type = DES → CON(svc:direct_services)'
      },
      options: [{
        v: 'in_person',
        l: 'In-person meeting'
      }, {
        v: 'phone_call',
        l: 'Phone call'
      }, {
        v: 'referral_contact',
        l: 'Referral or linkage',
        eo: {
          op: 'CON',
          target: {
            local: 'referral_contact',
            external: 'svc:svc_cat_2'
          }
        }
      }, {
        v: 'intake',
        l: 'Intake or enrollment'
      }, {
        v: 'follow_up',
        l: 'Follow-up contact'
      }, {
        v: 'other',
        l: 'Other'
      }],
      category: 'engagement',
      sensitive: false,
      metrics: true
    }]
  }, {
    id: 'form_intake',
    name: 'Intake',
    version: 1,
    description: 'Record intake steps like applications, documents, and enrollment',
    maturity: 'trial',
    source: {
      level: 'network',
      propagation: 'standard'
    },
    eo: {
      chain: [{
        op: 'DES',
        target: {
          entity: 'form_intake',
          designation: 'Intake Form'
        },
        frame: {
          type: 'schema',
          epistemic: 'GIVEN',
          role: 'network'
        }
      }],
      trace: 'form_intake = DES (network-authored, standard propagation)'
    },
    fields: [{
      id: 'prompt_intake_event',
      key: 'intake_event',
      question: 'What intake event occurred?',
      type: 'single_select',
      version: 1,
      maturity: 'trial',
      section: 'intake',
      eo: {
        chain: [{
          op: 'DES',
          target: {
            entity: 'intake_event',
            designation: 'Intake Event Field'
          },
          frame: {
            type: 'schema',
            epistemic: 'GIVEN',
            role: 'network'
          }
        }],
        trace: 'intake_event = DES'
      },
      options: [{
        v: 'application_submitted',
        l: 'Application submitted'
      }, {
        v: 'documents_provided',
        l: 'Documents provided'
      }, {
        v: 'eligibility_confirmed',
        l: 'Eligibility confirmed'
      }, {
        v: 'enrolled',
        l: 'Enrolled in program'
      }, {
        v: 'waitlisted',
        l: 'Placed on waitlist'
      }, {
        v: 'other',
        l: 'Other'
      }],
      category: 'intake',
      sensitive: false,
      metrics: true
    }]
  }, {
    id: 'form_context',
    name: 'Additional Context',
    version: 1,
    description: 'Note any changes in your situation or new needs that come up',
    maturity: 'draft',
    source: {
      level: 'local'
    },
    eo: {
      chain: [{
        op: 'DES',
        target: {
          entity: 'form_context',
          designation: 'Context Form'
        },
        frame: {
          type: 'schema',
          epistemic: 'GIVEN',
          role: 'local'
        }
      }],
      trace: 'form_context = DES (local, no propagation)'
    },
    fields: [{
      id: 'prompt_additional_context',
      key: 'additional_context',
      question: 'Any additional context to record?',
      type: 'single_select',
      version: 1,
      maturity: 'draft',
      section: 'general',
      eo: {
        chain: [{
          op: 'DES',
          target: {
            entity: 'additional_context',
            designation: 'Additional Context Field'
          },
          frame: {
            type: 'schema',
            epistemic: 'GIVEN',
            role: 'local'
          }
        }],
        trace: 'additional_context = DES'
      },
      options: [{
        v: 'situation_change',
        l: 'Situation changed'
      }, {
        v: 'new_need',
        l: 'New need identified'
      }, {
        v: 'barrier_encountered',
        l: 'Barrier encountered'
      }, {
        v: 'milestone_reached',
        l: 'Milestone reached'
      }, {
        v: 'other',
        l: 'Other'
      }],
      category: 'general',
      sensitive: true,
      metrics: true
    }]
  }],
  /* ═══════════════════════════════════════════════════════════════════════════
   * INTERPRETATIONS — Frameworks That Create MEANT From GIVEN
   *
   * Interpretations are the structures that derive institutional meaning from
   * the raw GIVEN data collected by forms. They include:
   *
   *   authorities  — External standards/frameworks (HUD, CoC, etc.)
   *   assessments  — Provider-side structured observations (MEANT frame)
   *   definitions  — Classification rules that derive categories from GIVEN values
   *
   * The GIVEN/MEANT divide is the core epistemic boundary:
   *   GIVEN = what was observed (collected via forms)
   *   MEANT = what an institution classifies that observation as
   *
   * Interpretations are also authored at network/org level and propagate
   * alongside forms, but they operate on a different epistemic plane.
   * ═══════════════════════════════════════════════════════════════════════════ */
  interpretations: {
    /* ── Authorities: External institutional standards ── */
    authorities: [{
      id: 'auth_org_policy',
      name: 'Organization Policy v1',
      uri: 'local://org/policy',
      authority_type: 'organizational_policy',
      authority_org: 'Organization',
      version: 'v1',
      terms: [{
        id: 'policy_1',
        label: 'Eligibility Criteria',
        definition: 'Conditions under which an individual qualifies for services'
      }, {
        id: 'policy_2',
        label: 'Service Standards',
        definition: 'Required standards for service delivery'
      }, {
        id: 'policy_3',
        label: 'Data Collection Requirements',
        definition: 'Mandatory data elements for intake and ongoing engagement'
      }]
    }, {
      id: 'auth_ext_standard',
      name: 'External Reporting Standard',
      uri: 'local://ext/standard',
      authority_type: 'external_standard',
      authority_org: 'Regulatory Body',
      version: 'v1',
      terms: [{
        id: 'ext_1',
        label: 'Status Classification (1.01)',
        definition: 'Current status at point of engagement'
      }, {
        id: 'ext_2',
        label: 'Engagement Type (1.02)',
        definition: 'Nature of service engagement'
      }, {
        id: 'ext_3',
        label: 'Identity Elements (2.01)'
      }, {
        id: 'ext_4',
        label: 'Contact Elements (2.02)'
      }]
    }, {
      id: 'auth_service_taxonomy',
      name: 'Service Taxonomy',
      uri: 'local://service/taxonomy',
      authority_type: 'industry_standard',
      authority_org: 'Standards Body',
      version: 'v1',
      terms: [{
        id: 'svc_cat_1',
        label: 'Direct Services',
        definition: 'Services delivered to individuals'
      }, {
        id: 'svc_cat_2',
        label: 'Coordination Services',
        definition: 'Referral and linkage services'
      }]
    }, {
      id: 'auth_local_policy',
      name: 'Local Policy',
      uri: 'local://local/policy',
      authority_type: 'local_policy',
      authority_org: 'Local Authority',
      terms: []
    }],
    /* ── Assessments: Provider-side structured observations (MEANT frame) ──
     * These are NOT forms — they are interpretation instruments. Providers use
     * them to record professional assessments that classify or evaluate the
     * GIVEN data collected from clients. Each assessment produces a MEANT event.
     */
    assessments: [{
      id: 'pprompt_assessment_score',
      key: 'assessment_score',
      question: 'Assessment Score',
      type: 'numeric',
      version: 1,
      audience: 'provider',
      maturity: 'normative',
      section: 'assessment',
      source: {
        level: 'network',
        propagation: 'standard'
      },
      eo: {
        chain: [{
          op: 'DES',
          target: {
            entity: 'assessment_score',
            designation: 'Assessment Score'
          },
          frame: {
            type: 'schema',
            epistemic: 'MEANT',
            role: 'provider'
          }
        }, {
          op: 'CON',
          target: {
            source: 'assessment_score',
            destination: 'org:assessment-v1'
          },
          context: {
            authority_name: 'Organization Policy',
            note: 'Standard assessment instrument'
          }
        }],
        trace: 'assessment_score = DES → CON(org:assessment-v1)'
      },
      range: {
        min: 0,
        max: 10
      },
      thresholds: [{
        v: 0,
        l: 'Low'
      }, {
        v: 4,
        l: 'Medium'
      }, {
        v: 7,
        l: 'High'
      }],
      category: 'assessment',
      sensitive: true,
      metrics: true
    }, {
      id: 'pprompt_case_stage',
      key: 'case_stage',
      question: 'Case stage?',
      type: 'single_select',
      version: 1,
      audience: 'provider',
      maturity: 'normative',
      section: 'case_management',
      source: {
        level: 'network',
        propagation: 'required'
      },
      eo: {
        chain: [{
          op: 'DES',
          target: {
            entity: 'case_stage',
            designation: 'Case Stage'
          },
          frame: {
            type: 'schema',
            epistemic: 'MEANT',
            role: 'provider'
          }
        }],
        trace: 'case_stage = DES'
      },
      options: [{
        v: 'intake',
        l: 'Intake'
      }, {
        v: 'active',
        l: 'Active'
      }, {
        v: 'monitoring',
        l: 'Monitoring'
      }, {
        v: 'closed_complete',
        l: 'Closed — completed'
      }, {
        v: 'closed_withdrawn',
        l: 'Closed — withdrawn'
      }, {
        v: 'closed_lost',
        l: 'Closed — lost contact'
      }],
      category: 'case_management',
      sensitive: false,
      metrics: true
    }, {
      id: 'pprompt_referral',
      key: 'referral_status',
      question: 'Referral status?',
      type: 'single_select',
      version: 1,
      audience: 'provider',
      maturity: 'trial',
      section: 'coordination',
      source: {
        level: 'network',
        propagation: 'recommended'
      },
      eo: {
        chain: [{
          op: 'DES',
          target: {
            entity: 'referral_status',
            designation: 'Referral Status'
          },
          frame: {
            type: 'schema',
            epistemic: 'MEANT',
            role: 'provider'
          }
        }, {
          op: 'CON',
          target: {
            source: 'referral_status',
            destination: 'svc:coordination'
          },
          context: {
            authority_id: 'auth_service_taxonomy'
          }
        }],
        trace: 'referral_status = DES → CON(svc:coordination)'
      },
      options: [{
        v: 'identified',
        l: 'Need identified'
      }, {
        v: 'referred',
        l: 'Referred'
      }, {
        v: 'scheduled',
        l: 'Appointment scheduled'
      }, {
        v: 'completed',
        l: 'Service completed'
      }, {
        v: 'declined',
        l: 'Declined'
      }, {
        v: 'no_capacity',
        l: 'Receiving org at capacity'
      }],
      category: 'coordination',
      sensitive: false,
      metrics: true
    }],
    /* ── Definitions: Classification rules that derive MEANT from GIVEN ──
     * These rules operate on GIVEN observation values (collected via forms)
     * and produce MEANT classifications. The epistemic crossing is explicit:
     * each rule documents which GIVEN fields it reads and which MEANT
     * category it produces.
     */
    definitions: [{
      id: 'def_priority_level',
      key: 'priority_level',
      name: 'Priority Level',
      type: 'classification_rule',
      version: 1,
      maturity: 'normative',
      source: {
        level: 'network',
        propagation: 'required'
      },
      eo: {
        chain: [{
          op: 'DES',
          target: {
            entity: 'priority_level',
            designation: 'Priority Level Classification'
          },
          frame: {
            type: 'schema',
            epistemic: 'MEANT',
            role: 'network'
          }
        }, {
          op: 'CON',
          target: {
            source: 'priority_level',
            destination: 'org:policy_1'
          },
          context: {
            authority_id: 'auth_org_policy',
            authority_name: 'Organization Policy v1',
            version: 'v1'
          }
        }, {
          op: 'SEG',
          target: {
            field: 'categories',
            entity: 'priority_level'
          },
          context: {
            included: ['priority_a', 'priority_b'],
            excluded: ['priority_d'],
            rationale: 'Network prioritizes highest-need categories'
          }
        }],
        trace: 'priority_level = DES → CON(org:policy_1) → SEG({Categories A-B})'
      },
      rules: [{
        category: 'priority_a',
        criteria: 'current_status IN (active) AND assessment_score >= 7',
        authority_code: 'A',
        eo: {
          chain: [{
            op: 'SYN',
            target: {
              local: 'priority_a',
              external: 'org:policy_1(a)'
            }
          }, {
            op: 'CON',
            target: {
              source: 'priority_a',
              destination: 'current_status'
            },
            context: {
              derivation: 'Classification derived from observation',
              epistemic_crossing: 'GIVEN → MEANT',
              note: 'Observation (current status) is GIVEN; classification (priority A) is MEANT'
            }
          }]
        }
      }, {
        category: 'priority_b',
        criteria: 'intake_event=eligibility_confirmed AND engagement_type != none',
        authority_code: 'B',
        eo: {
          chain: [{
            op: 'SYN',
            target: {
              local: 'priority_b',
              external: 'org:policy_1(b)'
            }
          }, {
            op: 'CON',
            target: {
              source: 'priority_b',
              destination: 'intake_event'
            },
            context: {
              derivation: 'Classification derived from intake observation + engagement',
              epistemic_crossing: 'GIVEN → MEANT'
            }
          }]
        }
      }, {
        category: 'stable',
        criteria: 'current_status=resolved for 30+ days',
        authority_code: null,
        eo: {
          chain: [{
            op: 'DES',
            target: {
              entity: 'stable',
              designation: 'Stable'
            },
            context: {
              note: 'Local definition — no direct external equivalent'
            }
          }, {
            op: 'CON',
            target: {
              source: 'stable',
              destination: 'current_status'
            },
            context: {
              derivation: 'Classification from sustained observation pattern',
              epistemic_crossing: 'GIVEN → MEANT'
            }
          }]
        }
      }]
    }, {
      id: 'def_extended_engagement',
      key: 'extended_engagement',
      name: 'Extended Engagement',
      type: 'classification_rule',
      version: 1,
      maturity: 'trial',
      source: {
        level: 'network',
        propagation: 'standard'
      },
      eo: {
        chain: [{
          op: 'DES',
          target: {
            entity: 'extended_engagement',
            designation: 'Extended Engagement Definition'
          },
          frame: {
            type: 'schema',
            epistemic: 'MEANT',
            role: 'network'
          }
        }, {
          op: 'CON',
          target: {
            source: 'extended_engagement',
            destination: 'org:policy_1'
          },
          context: {
            authority_id: 'auth_org_policy',
            authority_name: 'Organization Policy v1',
            version: 'v1'
          }
        }, {
          op: 'SUP',
          target: {
            entity: 'extended_engagement',
            field: 'definition'
          },
          context: {
            states: [{
              source: 'org:policy_1',
              definition: '12 months continuous OR 4 engagement episodes in 3 years',
              frame: 'organization_standard'
            }, {
              source: 'local_policy',
              definition: '6 months continuous OR 3 episodes in 2 years',
              frame: 'local_practice'
            }],
            resolution: null,
            note: 'Organization definition used for reporting; local definition used for prioritization'
          }
        }],
        trace: 'extended_engagement = DES → CON(org:policy_1) → SUP({org vs local})'
      },
      rules: [{
        category: 'extended_org',
        criteria: 'active engagement for 12+ months continuous OR 4+ episodes in 3 years',
        authority_code: 'ext',
        eo: {
          chain: [{
            op: 'SYN',
            target: {
              local: 'extended_org',
              external: 'org:policy_1'
            }
          }]
        }
      }, {
        category: 'extended_local',
        criteria: 'active engagement for 6+ months continuous OR 3+ episodes in 2 years',
        authority_code: null,
        eo: {
          chain: [{
            op: 'DES',
            target: {
              entity: 'extended_local'
            },
            context: {
              note: 'Local threshold — lower bar for outreach'
            }
          }]
        }
      }]
    }]
  },
  /* ── Anonymization Transforms ── */
  transforms: {
    dob: {
      method: 'age_range',
      buckets: ['0-17', '18-24', '25-34', '35-44', '45-54', '55-64', '65+']
    },
    address: {
      method: 'area_hash'
    },
    full_name: {
      method: 'block'
    },
    id_number: {
      method: 'block'
    },
    phone: {
      method: 'block'
    },
    email: {
      method: 'block'
    }
  },
  /* ── Vault Fields (with definitions & URIs) ── */
  vaultFields: [{
    key: 'full_name',
    label: 'Full Name',
    category: 'identity',
    sensitive: false,
    uri: 'khora:vault/full_name',
    data_type: 'text',
    definition: 'The full legal name of the individual as it appears on government-issued identification, or as preferred by the individual if no ID is available.',
    scope: 'Legal or preferred name for identification within service contexts. Not aliases or nicknames unless no legal name is known.'
  }, {
    key: 'dob',
    label: 'Date of Birth',
    category: 'identity',
    sensitive: true,
    uri: 'khora:vault/dob',
    data_type: 'date',
    definition: 'The date on which the individual was born, used for age calculation and eligibility determination.',
    scope: 'Calendar date of birth. If exact date is unknown, use best estimate with a note.'
  }, {
    key: 'id_number',
    label: 'ID Number',
    category: 'identity',
    sensitive: true,
    uri: 'khora:vault/id_number',
    data_type: 'text',
    definition: 'A government-issued identification number such as SSN (last 4), state ID, or other official identifier.',
    scope: 'Any official ID number used for verification. Partial numbers (e.g., last 4 of SSN) preferred for security. Not internal case numbers.'
  }, {
    key: 'email',
    label: 'Email',
    category: 'contact',
    sensitive: false,
    uri: 'khora:vault/email',
    data_type: 'email',
    definition: 'The primary email address for electronic communication with the individual.',
    scope: 'Email used for service coordination. Not organizational or employer email unless individual has no personal email.'
  }, {
    key: 'phone',
    label: 'Phone',
    category: 'contact',
    sensitive: false,
    uri: 'khora:vault/phone',
    data_type: 'phone',
    definition: 'The primary phone number for reaching the individual, including mobile.',
    scope: 'Personal or most reliable phone number. Mobile preferred. Include area code.'
  }, {
    key: 'address',
    label: 'Address',
    category: 'contact',
    sensitive: true,
    uri: 'khora:vault/address',
    data_type: 'address',
    definition: 'The current physical or mailing address of the individual, if known.',
    scope: 'Last known address or place of stay. For unhoused individuals, may be a shelter address, encampment location, or "no fixed address."'
  }, {
    key: 'affiliation',
    label: 'Organization / Affiliation',
    category: 'details',
    sensitive: false,
    uri: 'khora:vault/affiliation',
    data_type: 'text',
    definition: 'The organization, employer, or institutional affiliation of the individual, if any.',
    scope: 'Primary organizational connection relevant to services. May be employer, school, faith community, or community organization.'
  }, {
    key: 'case_notes',
    label: 'Case Notes',
    category: 'case',
    sensitive: false,
    uri: 'khora:vault/case_notes',
    data_type: 'text_long',
    definition: 'Free-text notes documenting interactions, observations, and service activities related to the individual.',
    scope: 'Ongoing case documentation. Not restricted clinical notes or legally privileged information.'
  }, {
    key: 'documents',
    label: 'Documents',
    category: 'case',
    sensitive: true,
    uri: 'khora:vault/documents',
    data_type: 'document',
    definition: 'Uploaded files or document references associated with the individual, such as ID scans, intake forms, or release authorizations.',
    scope: 'Any document relevant to the individual\'s case. May include scanned IDs, signed forms, referral letters. Not case notes.'
  }, {
    key: 'history',
    label: 'Case History',
    category: 'case',
    sensitive: false,
    uri: 'khora:vault/history',
    data_type: 'text_long',
    definition: 'A chronological record of key events, status changes, and milestones in the individual\'s case.',
    scope: 'High-level timeline of case progression. Not detailed session notes — those go in Case Notes.'
  }, {
    key: 'restricted_notes',
    label: 'Restricted Notes',
    category: 'sensitive',
    sensitive: true,
    uri: 'khora:vault/restricted_notes',
    data_type: 'text_long',
    definition: 'Sensitive notes with restricted access, such as clinical observations, safety concerns, or legally protected information.',
    scope: 'Information requiring additional access controls beyond standard case notes. May include mental health observations, substance use details, or safety planning notes.'
  }],
  /* ── Field Categories ── */
  fieldCategories: ['identity', 'contact', 'details', 'case', 'sensitive'],
  fieldCatLabels: {
    identity: 'Identity',
    contact: 'Contact',
    details: 'Details',
    case: 'Case',
    sensitive: 'Sensitive'
  },
  fieldCatIcons: {
    identity: 'user',
    contact: 'msg',
    details: 'briefcase',
    case: 'folder',
    sensitive: 'shieldCheck'
  },
  fieldCatColors: {
    identity: 'blue',
    contact: 'teal',
    details: 'gold',
    case: 'orange',
    sensitive: 'green'
  },
  /* ── Observation Categories ── */
  obsCatLabels: {
    status: 'Status',
    engagement: 'Engagement',
    intake: 'Intake',
    general: 'General',
    assessment: 'Assessment',
    case_management: 'Case Mgmt',
    coordination: 'Coordination'
  },
  obsCatColors: {
    status: 'teal',
    engagement: 'blue',
    intake: 'orange',
    general: 'gold',
    assessment: 'purple',
    case_management: 'gold',
    coordination: 'blue'
  },
  /* ── Org Roles ── */
  orgRoles: ['admin', 'provider', 'case_manager', 'field_worker', 'intake_coordinator', 'read_only'],
  orgRoleLabels: {
    admin: 'Admin',
    provider: 'Provider (Team Member)',
    case_manager: 'Case Manager',
    field_worker: 'Field Worker',
    intake_coordinator: 'Intake Coordinator',
    read_only: 'Read Only'
  },
  /* ── Default Org Roles (editable by admin, stored in org state) ── */
  defaultOrgRoles: [
    { key: 'admin', label: 'Admin', description: 'Full access. Manage team, see all cases, configure schema.', protected: true },
    { key: 'provider', label: 'Provider (Team Member)', description: 'View aggregate dashboards only. No PII access.' },
    { key: 'case_manager', label: 'Case Manager', description: 'Assigned cases only. Full read/write on assigned bridges.' },
    { key: 'field_worker', label: 'Field Worker', description: 'Assigned cases. Record encounters. Limited to own observations.' },
    { key: 'intake_coordinator', label: 'Intake Coordinator', description: 'Create new bridges. Run intake assessments. Route to case managers.' },
    { key: 'read_only', label: 'Read Only', description: 'View aggregate dashboards only. No PII access.' }
  ],
  /* ── Relationship Types ── */
  // Accounts can be connected through multiple relationship kinds.
  // client_provider is the default service relationship in MVP bridge flows.
  relationshipTypes: {
    client_provider: {
      id: 'client_provider',
      label: 'Individual ↔ Team Member',
      legacyLabel: 'Client ↔ Provider',
      description: 'Service relationship between an individual and a team member.'
    },
    teammate: {
      id: 'teammate',
      label: 'Team Member ↔ Team Member',
      description: 'Collaboration relationship between two team members.'
    },
    org_membership: {
      id: 'org_membership',
      label: 'Team Member ↔ Organization',
      description: 'Membership relationship connecting a person to an organization.'
    },
    network_membership: {
      id: 'network_membership',
      label: 'Organization ↔ Network',
      description: 'Membership relationship connecting an organization to a network.'
    }
  },
  /* ── Org Types ── */
  orgTypes: ['direct_service', 'administrative', 'clinical', 'legal', 'coordinating_body', 'advocacy', 'other'],
  orgTypeLabels: {
    direct_service: 'Direct Service',
    administrative: 'Administrative',
    clinical: 'Clinical',
    legal: 'Legal',
    coordinating_body: 'Coordinating Body',
    advocacy: 'Advocacy',
    other: 'Other'
  },
  /* ── Org Opacity Levels ── */
  // Controls how much of the org's internal structure is visible to external orgs during messaging
  opacityLevels: ['transparent', 'translucent', 'opaque'],
  opacityLabels: {
    transparent: 'Transparent',
    // sender name & org visible
    translucent: 'Translucent',
    // org name visible, individual sender hidden
    opaque: 'Opaque' // only "an organization" — no name, no members
  },
  opacityDescriptions: {
    transparent: 'External orgs see which staff member sent each message and your org name.',
    translucent: 'External orgs see your org name but individual sender identities are hidden.',
    opaque: 'External orgs see only that a response came from an organization. Org name and all member identities are hidden.'
  },
  /* ── Org Message Access Roles ── */
  // Which org roles can access inter-org messages by default
  msgAccessDefaults: {
    read: ['admin', 'case_manager'],
    respond: ['admin']
  },
  /* ── Org Terminology Defaults ── */
  // Admins can override these terms at the org level to match their sector vocabulary
  terminologyDefaults: {
    client_term: 'Individual',
    client_term_plural: 'Individuals',
    provider_term: 'Team Member',
    provider_term_plural: 'Team Members',
    staff_term: 'Team Member',
    staff_term_plural: 'Team Members'
  }
};

/* ── Derived constants ──
 * Forms → flat field arrays for backward compatibility with seeding & UI.
 * DEFAULT_PROMPTS = all GIVEN fields (client-facing) extracted from forms.
 * DEFAULT_PROVIDER_PROMPTS = all MEANT assessments (provider-facing).
 */
const DEFAULT_FORMS = DOMAIN_CONFIG.forms;
const DEFAULT_PROMPTS = DOMAIN_CONFIG.forms.flatMap(f => f.fields.map(field => ({
  ...field,
  audience: 'client',
  source: field.source || f.source,
  form_id: f.id,
  form_name: f.name
})));
const DEFAULT_PROVIDER_PROMPTS = DOMAIN_CONFIG.interpretations.assessments;
const DEFAULT_AUTHORITIES = DOMAIN_CONFIG.interpretations.authorities;
const DEFAULT_DEFINITIONS = DOMAIN_CONFIG.interpretations.definitions;
const DEFAULT_TRANSFORMS = DOMAIN_CONFIG.transforms;

/* ═══════════════════ VAULT FIELD DEFINITIONS (§10) ═══════════════════ */
const VAULT_FIELDS = DOMAIN_CONFIG.vaultFields;
const FIELD_CATEGORIES = DOMAIN_CONFIG.fieldCategories;
const CAT_LABELS = DOMAIN_CONFIG.fieldCatLabels;
const CAT_ICONS = DOMAIN_CONFIG.fieldCatIcons;
const CAT_COLORS = DOMAIN_CONFIG.fieldCatColors;
const OBS_CAT_LABELS = DOMAIN_CONFIG.obsCatLabels;
const OBS_CAT_COLORS = DOMAIN_CONFIG.obsCatColors;

/* ═══════════════════ IN-BROWSER EMBEDDINGS HELPERS (§Field Fuzzy Match) ═══════════════════ */
const getFieldEmbedding = async text => {
  try {
    if (!window.initEmbeddings) return null;
    const pipe = await window.initEmbeddings();
    if (!pipe) return null;
    const output = await pipe(text, {
      pooling: 'mean',
      normalize: true
    });
    return Array.from(output.data);
  } catch (e) {
    console.debug('Embedding generation skipped');
    return null;
  }
};
const cosineSim = (a, b) => {
  if (!a || !b || a.length !== b.length) return 0;
  let dot = 0,
    na = 0,
    nb = 0;
  for (let i = 0; i < a.length; i++) {
    dot += a[i] * b[i];
    na += a[i] * a[i];
    nb += b[i] * b[i];
  }
  return na && nb ? dot / (Math.sqrt(na) * Math.sqrt(nb)) : 0;
};
const findSimilarFields = async (text, fieldDefs, excludeUris = []) => {
  try {
    const embedding = await getFieldEmbedding(text);
    if (!embedding) return [];
    const results = [];
    for (const [uri, def] of Object.entries(fieldDefs)) {
      if (excludeUris.includes(uri)) continue;
      const defText = `${def.label}. ${def.definition || ''}. ${def.scope || ''}`;
      const defEmb = await getFieldEmbedding(defText);
      if (!defEmb) continue;
      const sim = cosineSim(embedding, defEmb);
      if (sim > 0.6) results.push({
        uri,
        def,
        similarity: sim
      });
    }
    return results.sort((a, b) => b.similarity - a.similarity).slice(0, 3);
  } catch (e) {
    console.debug('Similarity search skipped');
    return [];
  }
};

/* ═══════════════════ ORG ROLES & TYPES ═══════════════════ */
const ORG_ROLES = DOMAIN_CONFIG.orgRoles;
const ORG_ROLE_LABELS = DOMAIN_CONFIG.orgRoleLabels;
const ORG_TYPES = DOMAIN_CONFIG.orgTypes;
const ORG_TYPE_LABELS = DOMAIN_CONFIG.orgTypeLabels;
const OPACITY_LEVELS = DOMAIN_CONFIG.opacityLevels;
const OPACITY_LABELS = DOMAIN_CONFIG.opacityLabels;
const OPACITY_DESCRIPTIONS = DOMAIN_CONFIG.opacityDescriptions;
const MSG_ACCESS_DEFAULTS = DOMAIN_CONFIG.msgAccessDefaults;
const TERMINOLOGY_DEFAULTS = DOMAIN_CONFIG.terminologyDefaults;
const RELATIONSHIP_TYPES = DOMAIN_CONFIG.relationshipTypes;

/* ═══════════════════ DEFAULT RESOURCE TYPES (§Resource Build §11) ═══════════════════
 * Seed data for initial deployment. Created as draft maturity, optional propagation,
 * so networks can adopt and promote them through governance rather than having them imposed.
 * Loaded when a network is created. Network coordinator sees these in the catalog.
 * ════════════════════════════════════════════════════════════════════════════════════════ */
const DEFAULT_RESOURCE_TYPES = [{
  id: 'rtype_bus_voucher',
  name: 'Bus Voucher',
  category: 'transportation',
  unit: 'voucher',
  fungible: true,
  perishable: true,
  ttl_days: 90,
  tags: ['transit']
}, {
  id: 'rtype_gas_card',
  name: 'Gas Card',
  category: 'transportation',
  unit: 'card',
  fungible: true,
  perishable: false,
  tags: ['transit', 'fuel']
}, {
  id: 'rtype_ride_voucher',
  name: 'Ride Voucher',
  category: 'transportation',
  unit: 'ride',
  fungible: true,
  perishable: true,
  ttl_days: 30,
  tags: ['transit', 'rideshare']
}, {
  id: 'rtype_emergency_fund',
  name: 'Emergency Fund',
  category: 'financial',
  unit: 'dollars',
  fungible: true,
  perishable: false,
  tags: ['emergency', 'cash']
}, {
  id: 'rtype_rental_assist',
  name: 'Rental Assistance',
  category: 'financial',
  unit: 'dollars',
  fungible: true,
  perishable: false,
  tags: ['rent', 'housing']
}, {
  id: 'rtype_deposit_assist',
  name: 'Deposit Assistance',
  category: 'financial',
  unit: 'dollars',
  fungible: true,
  perishable: false,
  tags: ['deposit', 'housing']
}, {
  id: 'rtype_shelter_bed',
  name: 'Shelter Bed Night',
  category: 'housing',
  unit: 'night',
  fungible: true,
  perishable: true,
  ttl_days: 1,
  tags: ['shelter', 'emergency']
}, {
  id: 'rtype_housing_voucher',
  name: 'Housing Voucher',
  category: 'housing',
  unit: 'voucher',
  fungible: false,
  perishable: true,
  ttl_days: 120,
  tags: ['voucher', 'permanent']
}, {
  id: 'rtype_transitional_bed',
  name: 'Transitional Bed',
  category: 'housing',
  unit: 'night',
  fungible: true,
  perishable: true,
  ttl_days: 1,
  tags: ['transitional']
}, {
  id: 'rtype_hygiene_kit',
  name: 'Hygiene Kit',
  category: 'health',
  unit: 'kit',
  fungible: true,
  perishable: false,
  tags: ['hygiene', 'supplies']
}, {
  id: 'rtype_prescription',
  name: 'Prescription Assist',
  category: 'health',
  unit: 'fill',
  fungible: false,
  perishable: false,
  tags: ['rx', 'medical']
}, {
  id: 'rtype_meal',
  name: 'Meal',
  category: 'food',
  unit: 'meal',
  fungible: true,
  perishable: true,
  ttl_days: 1,
  tags: ['meal', 'hot']
}, {
  id: 'rtype_grocery_card',
  name: 'Grocery Card',
  category: 'food',
  unit: 'card',
  fungible: true,
  perishable: false,
  tags: ['grocery', 'card']
}, {
  id: 'rtype_pantry_bag',
  name: 'Pantry Bag',
  category: 'food',
  unit: 'bag',
  fungible: true,
  perishable: true,
  ttl_days: 7,
  tags: ['pantry', 'dry goods']
}, {
  id: 'rtype_legal_consult',
  name: 'Legal Consultation',
  category: 'legal',
  unit: 'hour',
  fungible: true,
  perishable: false,
  tags: ['legal', 'consultation']
}, {
  id: 'rtype_doc_prep',
  name: 'Document Preparation',
  category: 'legal',
  unit: 'session',
  fungible: true,
  perishable: false,
  tags: ['legal', 'documents']
}, {
  id: 'rtype_job_training',
  name: 'Job Training Slot',
  category: 'employment',
  unit: 'slot',
  fungible: false,
  perishable: true,
  ttl_days: 30,
  tags: ['training', 'job']
}, {
  id: 'rtype_interview_clothes',
  name: 'Interview Clothing',
  category: 'employment',
  unit: 'set',
  fungible: true,
  perishable: false,
  tags: ['clothing', 'interview']
}, {
  id: 'rtype_school_supplies',
  name: 'School Supplies',
  category: 'education',
  unit: 'kit',
  fungible: true,
  perishable: false,
  tags: ['school', 'supplies']
}, {
  id: 'rtype_tutoring',
  name: 'Tutoring Session',
  category: 'education',
  unit: 'hour',
  fungible: true,
  perishable: false,
  tags: ['tutoring', 'education']
}];

/* ═══════════════════ FRAMEWORK BINDINGS (§C.2) ═══════════════════ */
// Multi-framework value mappings: same observation value → different classifications
// under different institutional frameworks. This is the GIVEN → MEANT crossing made explicit.
const FRAMEWORK_BINDINGS = {
  sleep_location: {
    prompt_id: 'prompt_sleep_location',
    prompt_key: 'sleep_location',
    question: 'Where did you sleep last night?',
    bindings: {
      vehicle: {
        local_label: 'Car, van, or RV',
        frameworks: [{
          id: 'fb_vehicle_hud',
          authority_id: 'auth_hud_578_3',
          authority_name: '24 CFR 578.3 — Homeless Definition',
          authority_org: 'HUD',
          authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
          provision: '§578.3(b)(1)',
          classification: 'Literally Homeless (Category 1)',
          classification_code: 'cat_1',
          implication: 'Eligible for CoC-funded services',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → hud:hmis_3.12'
          }, {
            op: 'SYN',
            desc: 'vehicle → code_7'
          }, {
            op: 'CON',
            desc: 'code_7 → 24cfr578.3(b)(1)'
          }],
          eo_compact: 'CON(sleep_location → hud:hmis_3.12) → SYN(vehicle → code_7)'
        }, {
          id: 'fb_vehicle_coc',
          authority_id: 'auth_local_coc',
          authority_name: 'Local CoC Outreach Priority',
          authority_org: 'CoC',
          authority_uri: 'local://coc/outreach-policy-2025',
          provision: '§3.2 Unsheltered prioritization',
          classification: 'Priority 1 — Immediate outreach',
          classification_code: 'priority_1',
          implication: 'Assigned to next available outreach team',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → coc:outreach_priority'
          }, {
            op: 'SYN',
            desc: 'vehicle → priority_1'
          }],
          eo_compact: 'CON(sleep_location → coc:outreach_priority) → SYN(vehicle → priority_1)'
        }, {
          id: 'fb_vehicle_pit',
          authority_id: 'auth_hud_hmis_ds',
          authority_name: 'PIT Count Methodology',
          authority_org: 'HUD Exchange',
          authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
          provision: 'PIT Unsheltered Definition',
          classification: 'Unsheltered',
          classification_code: 'unsheltered',
          implication: 'Counted in unsheltered PIT total',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → pit:shelter_status'
          }, {
            op: 'SYN',
            desc: 'vehicle → unsheltered'
          }],
          eo_compact: 'CON(sleep_location → pit:shelter_status) → SYN(vehicle → unsheltered)'
        }]
      },
      encampment: {
        local_label: 'Tent or encampment',
        frameworks: [{
          id: 'fb_encampment_hud',
          authority_id: 'auth_hud_578_3',
          authority_name: '24 CFR 578.3 — Homeless Definition',
          authority_org: 'HUD',
          authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
          provision: '§578.3(b)(1)',
          classification: 'Literally Homeless (Category 1)',
          classification_code: 'cat_1',
          implication: 'Eligible for CoC-funded services',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → hud:hmis_3.12'
          }, {
            op: 'SYN',
            desc: 'encampment → code_16'
          }],
          eo_compact: 'CON → SYN(encampment → code_16)'
        }, {
          id: 'fb_encampment_coc',
          authority_id: 'auth_local_coc',
          authority_name: 'Local CoC Outreach Priority',
          authority_org: 'CoC',
          authority_uri: 'local://coc/outreach-policy-2025',
          provision: '§3.2',
          classification: 'Priority 1 — Immediate outreach',
          classification_code: 'priority_1',
          implication: 'Assigned to next available outreach team',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → coc:outreach_priority'
          }, {
            op: 'SYN',
            desc: 'encampment → priority_1'
          }],
          eo_compact: 'CON → SYN(encampment → priority_1)'
        }, {
          id: 'fb_encampment_pit',
          authority_id: 'auth_hud_hmis_ds',
          authority_name: 'PIT Count Methodology',
          authority_org: 'HUD Exchange',
          authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
          provision: 'PIT Unsheltered Definition',
          classification: 'Unsheltered',
          classification_code: 'unsheltered',
          implication: 'Counted in unsheltered PIT total',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → pit:shelter_status'
          }, {
            op: 'SYN',
            desc: 'encampment → unsheltered'
          }],
          eo_compact: 'CON → SYN(encampment → unsheltered)'
        }]
      },
      unsheltered: {
        local_label: 'Street, park, or unsheltered',
        frameworks: [{
          id: 'fb_unsheltered_hud',
          authority_id: 'auth_hud_578_3',
          authority_name: '24 CFR 578.3 — Homeless Definition',
          authority_org: 'HUD',
          authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
          provision: '§578.3(b)(1)',
          classification: 'Literally Homeless (Category 1)',
          classification_code: 'cat_1',
          implication: 'Eligible for CoC-funded services',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → hud:hmis_3.12'
          }, {
            op: 'SYN',
            desc: 'unsheltered → code_16'
          }, {
            op: 'SEG',
            desc: 'collapsed with encampment'
          }],
          eo_compact: 'CON → SYN(unsheltered → code_16) → SEG(collapsed)'
        }, {
          id: 'fb_unsheltered_coc',
          authority_id: 'auth_local_coc',
          authority_name: 'Local CoC Outreach Priority',
          authority_org: 'CoC',
          authority_uri: 'local://coc/outreach-policy-2025',
          provision: '§3.1 Street prioritization',
          classification: 'Priority 1 — Immediate outreach',
          classification_code: 'priority_1',
          implication: 'Highest priority — immediate deployment',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → coc:outreach_priority'
          }, {
            op: 'SYN',
            desc: 'unsheltered → priority_1'
          }],
          eo_compact: 'CON → SYN(unsheltered → priority_1)'
        }]
      },
      shelter: {
        local_label: 'Emergency shelter',
        frameworks: [{
          id: 'fb_shelter_hud',
          authority_id: 'auth_hud_578_3',
          authority_name: '24 CFR 578.3 — Homeless Definition',
          authority_org: 'HUD',
          authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
          provision: '§578.3(b)(1)',
          classification: 'Literally Homeless (Category 1)',
          classification_code: 'cat_1',
          implication: 'Eligible for CoC-funded services',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → hud:hmis_3.12'
          }, {
            op: 'SYN',
            desc: 'shelter → code_3'
          }],
          eo_compact: 'CON → SYN(shelter → code_3)'
        }, {
          id: 'fb_shelter_coc',
          authority_id: 'auth_local_coc',
          authority_name: 'Local CoC Outreach Priority',
          authority_org: 'CoC',
          authority_uri: 'local://coc/outreach-policy-2025',
          provision: '§4.1 Sheltered services',
          classification: 'Priority 3 — Sheltered, active case',
          classification_code: 'priority_3',
          implication: 'Maintain current case management',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → coc:outreach_priority'
          }, {
            op: 'SYN',
            desc: 'shelter → priority_3'
          }],
          eo_compact: 'CON → SYN(shelter → priority_3)'
        }, {
          id: 'fb_shelter_pit',
          authority_id: 'auth_hud_hmis_ds',
          authority_name: 'PIT Count Methodology',
          authority_org: 'HUD Exchange',
          authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
          provision: 'PIT Sheltered Definition',
          classification: 'Sheltered — Emergency Shelter',
          classification_code: 'sheltered_es',
          implication: 'Counted in sheltered PIT total',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → pit:shelter_status'
          }, {
            op: 'SYN',
            desc: 'shelter → sheltered_es'
          }],
          eo_compact: 'CON → SYN(shelter → sheltered_es)'
        }]
      },
      own_housing: {
        local_label: 'Own apartment or house (with lease)',
        frameworks: [{
          id: 'fb_own_hud',
          authority_id: 'auth_hud_578_3',
          authority_name: '24 CFR 578.3 — Homeless Definition',
          authority_org: 'HUD',
          authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
          provision: 'N/A — Not homeless',
          classification: 'Not Homeless (Housed)',
          classification_code: 'housed',
          implication: 'Not eligible for CoC homeless services',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → hud:hmis_3.12'
          }, {
            op: 'SYN',
            desc: 'own_housing → code_1'
          }],
          eo_compact: 'CON → SYN(own_housing → code_1)'
        }, {
          id: 'fb_own_coc',
          authority_id: 'auth_local_coc',
          authority_name: 'Local CoC Outreach Priority',
          authority_org: 'CoC',
          authority_uri: 'local://coc/outreach-policy-2025',
          provision: '§5.1 Housed monitoring',
          classification: 'No Priority — Housed',
          classification_code: 'no_priority',
          implication: 'No outreach needed',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → coc:outreach_priority'
          }, {
            op: 'SYN',
            desc: 'own_housing → no_priority'
          }],
          eo_compact: 'CON → SYN(own_housing → no_priority)'
        }]
      },
      transitional: {
        local_label: 'Transitional housing',
        frameworks: [{
          id: 'fb_trans_hud',
          authority_id: 'auth_hud_578_3',
          authority_name: '24 CFR 578.3 — Homeless Definition',
          authority_org: 'HUD',
          authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
          provision: '§578.3(b)(1)',
          classification: 'Literally Homeless (Category 1)',
          classification_code: 'cat_1',
          implication: 'Eligible for CoC-funded services (in TH program)',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → hud:hmis_3.12'
          }, {
            op: 'SYN',
            desc: 'transitional → code_4'
          }],
          eo_compact: 'CON → SYN(transitional → code_4)'
        }, {
          id: 'fb_trans_pit',
          authority_id: 'auth_hud_hmis_ds',
          authority_name: 'PIT Count Methodology',
          authority_org: 'HUD Exchange',
          authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
          provision: 'PIT Sheltered Definition',
          classification: 'Sheltered — Transitional Housing',
          classification_code: 'sheltered_th',
          implication: 'Counted in sheltered PIT total (TH)',
          eo_chain: [{
            op: 'CON',
            desc: 'sleep_location → pit:shelter_status'
          }, {
            op: 'SYN',
            desc: 'transitional → sheltered_th'
          }],
          eo_compact: 'CON → SYN(transitional → sheltered_th)'
        }]
      }
    }
  }
};

// Framework accent colors — secondary per-framework color for visual distinction
const FRAMEWORK_COLORS = {
  'auth_hud_578_3': {
    accent: 'blue',
    label: 'HUD'
  },
  'auth_hud_hmis_ds': {
    accent: 'teal',
    label: 'HMIS'
  },
  'auth_local_coc': {
    accent: 'orange',
    label: 'CoC'
  },
  'auth_211_airs': {
    accent: 'green',
    label: 'AIRS'
  },
  'auth_org_policy': {
    accent: 'purple',
    label: 'Org Policy'
  }
};

/* ═══════════════════ FRAMEWORK FIELD STANDARDS (§C.3) ═══════════════════
 * Built-in data field frameworks from established standards. Each framework
 * defines a set of vault fields tagged to authoritative URIs. Users toggle
 * frameworks on/off — enabled framework fields appear in the vault alongside
 * built-in and custom fields. The URI linkage gives every field an objective,
 * externally-verifiable semantic meaning (the MEANT side of the GIVEN/MEANT
 * divide). The observation value is GIVEN; the framework tag is what it MEANS.
 * ═══════════════════════════════════════════════════════════════════════════ */
const FRAMEWORK_FIELD_STANDARDS = [
// 1. vCard (RFC 6350) — Core identity & contact interchange
{
  id: 'ffs_vcard',
  name: 'vCard',
  spec: 'RFC 6350',
  uri: 'https://datatracker.ietf.org/doc/html/rfc6350',
  description: 'Contact & identity interchange format',
  domain: 'Person / Identity',
  accent: 'blue',
  fields: [{
    key: 'vcard_nickname',
    label: 'Nickname',
    category: 'identity',
    sensitive: false,
    property: 'NICKNAME',
    uri: 'https://datatracker.ietf.org/doc/html/rfc6350#section-6.2.3'
  }, {
    key: 'vcard_prefix',
    label: 'Name Prefix',
    category: 'identity',
    sensitive: false,
    property: 'N.prefix',
    uri: 'https://datatracker.ietf.org/doc/html/rfc6350#section-6.2.2'
  }, {
    key: 'vcard_suffix',
    label: 'Name Suffix',
    category: 'identity',
    sensitive: false,
    property: 'N.suffix',
    uri: 'https://datatracker.ietf.org/doc/html/rfc6350#section-6.2.2'
  }, {
    key: 'vcard_gender',
    label: 'Gender',
    category: 'identity',
    sensitive: false,
    property: 'GENDER',
    uri: 'https://datatracker.ietf.org/doc/html/rfc6350#section-6.2.7'
  }, {
    key: 'vcard_language',
    label: 'Preferred Language',
    category: 'details',
    sensitive: false,
    property: 'LANG',
    uri: 'https://datatracker.ietf.org/doc/html/rfc6350#section-6.4.4'
  }, {
    key: 'vcard_bday',
    label: 'Birthday',
    category: 'identity',
    sensitive: true,
    property: 'BDAY',
    uri: 'https://datatracker.ietf.org/doc/html/rfc6350#section-6.2.5'
  }]
},
// 2. Schema.org Person — Structured linked-data person
{
  id: 'ffs_schema_person',
  name: 'Schema.org Person',
  spec: 'Schema.org',
  uri: 'https://schema.org/Person',
  description: 'Linked-data person identification',
  domain: 'Person / Identity',
  accent: 'teal',
  fields: [{
    key: 'schema_given_name',
    label: 'Given Name',
    category: 'identity',
    sensitive: false,
    property: 'givenName',
    uri: 'https://schema.org/givenName'
  }, {
    key: 'schema_family_name',
    label: 'Family Name',
    category: 'identity',
    sensitive: false,
    property: 'familyName',
    uri: 'https://schema.org/familyName'
  }, {
    key: 'schema_additional_name',
    label: 'Middle / Additional Name',
    category: 'identity',
    sensitive: false,
    property: 'additionalName',
    uri: 'https://schema.org/additionalName'
  }, {
    key: 'schema_nationality',
    label: 'Nationality',
    category: 'details',
    sensitive: false,
    property: 'nationality',
    uri: 'https://schema.org/nationality'
  }, {
    key: 'schema_job_title',
    label: 'Job Title',
    category: 'details',
    sensitive: false,
    property: 'jobTitle',
    uri: 'https://schema.org/jobTitle'
  }, {
    key: 'schema_works_for',
    label: 'Works For',
    category: 'details',
    sensitive: false,
    property: 'worksFor',
    uri: 'https://schema.org/worksFor'
  }]
},
// 3. HL7 FHIR Patient — Healthcare interoperability
{
  id: 'ffs_fhir_patient',
  name: 'FHIR Patient',
  spec: 'HL7 FHIR R4',
  uri: 'https://www.hl7.org/fhir/patient.html',
  description: 'Healthcare patient resource',
  domain: 'Healthcare',
  accent: 'green',
  fields: [{
    key: 'fhir_marital_status',
    label: 'Marital Status',
    category: 'details',
    sensitive: false,
    property: 'maritalStatus',
    uri: 'https://www.hl7.org/fhir/patient-definitions.html#Patient.maritalStatus'
  }, {
    key: 'fhir_communication_lang',
    label: 'Communication Language',
    category: 'details',
    sensitive: false,
    property: 'communication.language',
    uri: 'https://www.hl7.org/fhir/patient-definitions.html#Patient.communication.language'
  }, {
    key: 'fhir_general_practitioner',
    label: 'General Practitioner',
    category: 'case',
    sensitive: false,
    property: 'generalPractitioner',
    uri: 'https://www.hl7.org/fhir/patient-definitions.html#Patient.generalPractitioner'
  }, {
    key: 'fhir_emergency_contact',
    label: 'Emergency Contact',
    category: 'contact',
    sensitive: true,
    property: 'contact',
    uri: 'https://www.hl7.org/fhir/patient-definitions.html#Patient.contact'
  }, {
    key: 'fhir_medical_record_num',
    label: 'Medical Record Number',
    category: 'sensitive',
    sensitive: true,
    property: 'identifier',
    uri: 'https://www.hl7.org/fhir/patient-definitions.html#Patient.identifier'
  }]
},
// 4. NIEM Person — Government demographics
{
  id: 'ffs_niem_person',
  name: 'NIEM Person',
  spec: 'NIEM 6.0',
  uri: 'https://niem.github.io/niem-releases/',
  description: 'National information exchange demographics',
  domain: 'Government',
  accent: 'purple',
  fields: [{
    key: 'niem_race',
    label: 'Race',
    category: 'identity',
    sensitive: true,
    property: 'PersonRaceCode',
    uri: 'https://niem.github.io/niem-releases/'
  }, {
    key: 'niem_ethnicity',
    label: 'Ethnicity',
    category: 'identity',
    sensitive: true,
    property: 'PersonEthnicityCode',
    uri: 'https://niem.github.io/niem-releases/'
  }, {
    key: 'niem_sex',
    label: 'Sex',
    category: 'identity',
    sensitive: false,
    property: 'PersonSexCode',
    uri: 'https://niem.github.io/niem-releases/'
  }, {
    key: 'niem_height',
    label: 'Height',
    category: 'details',
    sensitive: false,
    property: 'PersonHeightMeasure',
    uri: 'https://niem.github.io/niem-releases/'
  }, {
    key: 'niem_weight',
    label: 'Weight',
    category: 'details',
    sensitive: false,
    property: 'PersonWeightMeasure',
    uri: 'https://niem.github.io/niem-releases/'
  }, {
    key: 'niem_eye_color',
    label: 'Eye Color',
    category: 'details',
    sensitive: false,
    property: 'PersonEyeColorCode',
    uri: 'https://niem.github.io/niem-releases/'
  }, {
    key: 'niem_hair_color',
    label: 'Hair Color',
    category: 'details',
    sensitive: false,
    property: 'PersonHairColorCode',
    uri: 'https://niem.github.io/niem-releases/'
  }]
},
// 5. Schema.org PostalAddress — Structured address
{
  id: 'ffs_postal_address',
  name: 'PostalAddress',
  spec: 'Schema.org',
  uri: 'https://schema.org/PostalAddress',
  description: 'Structured postal address fields',
  domain: 'Address / Location',
  accent: 'orange',
  fields: [{
    key: 'addr_street',
    label: 'Street Address',
    category: 'contact',
    sensitive: true,
    property: 'streetAddress',
    uri: 'https://schema.org/streetAddress'
  }, {
    key: 'addr_locality',
    label: 'City / Locality',
    category: 'contact',
    sensitive: false,
    property: 'addressLocality',
    uri: 'https://schema.org/addressLocality'
  }, {
    key: 'addr_region',
    label: 'State / Region',
    category: 'contact',
    sensitive: false,
    property: 'addressRegion',
    uri: 'https://schema.org/addressRegion'
  }, {
    key: 'addr_postal_code',
    label: 'Postal Code',
    category: 'contact',
    sensitive: false,
    property: 'postalCode',
    uri: 'https://schema.org/postalCode'
  }, {
    key: 'addr_country',
    label: 'Country',
    category: 'contact',
    sensitive: false,
    property: 'addressCountry',
    uri: 'https://schema.org/addressCountry'
  }]
},
// 6. HR Open Standards — Employment & candidate data
{
  id: 'ffs_hr_open',
  name: 'HR Open',
  spec: 'HR Open Standards',
  uri: 'https://hropenstandards.org/',
  description: 'Employment history & credentials',
  domain: 'Employment / HR',
  accent: 'gold',
  fields: [{
    key: 'hr_employer',
    label: 'Employer Name',
    category: 'details',
    sensitive: false,
    property: 'EmployerName',
    uri: 'https://hropenstandards.org/'
  }, {
    key: 'hr_title',
    label: 'Employment Title',
    category: 'details',
    sensitive: false,
    property: 'Title',
    uri: 'https://hropenstandards.org/'
  }, {
    key: 'hr_start_date',
    label: 'Employment Start',
    category: 'details',
    sensitive: false,
    property: 'StartDate',
    uri: 'https://hropenstandards.org/'
  }, {
    key: 'hr_end_date',
    label: 'Employment End',
    category: 'details',
    sensitive: false,
    property: 'EndDate',
    uri: 'https://hropenstandards.org/'
  }, {
    key: 'hr_certifications',
    label: 'Certifications',
    category: 'details',
    sensitive: false,
    property: 'Certifications',
    uri: 'https://hropenstandards.org/'
  }, {
    key: 'hr_degree',
    label: 'Degree',
    category: 'details',
    sensitive: false,
    property: 'Degree',
    uri: 'https://hropenstandards.org/'
  }]
},
// 7. CEDS — Education data
{
  id: 'ffs_ceds',
  name: 'CEDS',
  spec: 'Common Education Data Standards',
  uri: 'https://ceds.ed.gov/',
  description: 'Education enrollment & assessment',
  domain: 'Education',
  accent: 'blue',
  fields: [{
    key: 'ceds_school',
    label: 'School Name',
    category: 'details',
    sensitive: false,
    property: 'SchoolId',
    uri: 'https://ceds.ed.gov/'
  }, {
    key: 'ceds_grade',
    label: 'Grade Level',
    category: 'details',
    sensitive: false,
    property: 'GradeLevel',
    uri: 'https://ceds.ed.gov/'
  }, {
    key: 'ceds_enrollment_date',
    label: 'Enrollment Date',
    category: 'details',
    sensitive: false,
    property: 'EntryDate',
    uri: 'https://ceds.ed.gov/'
  }, {
    key: 'ceds_english_learner',
    label: 'English Learner Status',
    category: 'details',
    sensitive: false,
    property: 'EnglishLearnerStatus',
    uri: 'https://ceds.ed.gov/'
  }, {
    key: 'ceds_disability',
    label: 'Disability Status',
    category: 'sensitive',
    sensitive: true,
    property: 'DisabilityStatus',
    uri: 'https://ceds.ed.gov/'
  }]
},
// 8. RESO Data Dictionary — Housing & property
{
  id: 'ffs_reso',
  name: 'RESO',
  spec: 'RESO Data Dictionary',
  uri: 'https://www.reso.org/data-dictionary/',
  description: 'Real estate & housing data',
  domain: 'Real Estate / Property',
  accent: 'orange',
  fields: [{
    key: 'reso_property_type',
    label: 'Property Type',
    category: 'details',
    sensitive: false,
    property: 'PropertyType',
    uri: 'https://ddwiki.reso.org/'
  }, {
    key: 'reso_bedrooms',
    label: 'Bedrooms',
    category: 'details',
    sensitive: false,
    property: 'BedroomsTotal',
    uri: 'https://ddwiki.reso.org/'
  }, {
    key: 'reso_rent',
    label: 'Monthly Rent',
    category: 'sensitive',
    sensitive: true,
    property: 'ListPrice',
    uri: 'https://ddwiki.reso.org/'
  }, {
    key: 'reso_lease_start',
    label: 'Lease Start',
    category: 'details',
    sensitive: false,
    property: 'ListingContractDate',
    uri: 'https://ddwiki.reso.org/'
  }, {
    key: 'reso_lease_end',
    label: 'Lease End',
    category: 'details',
    sensitive: false,
    property: 'CloseDate',
    uri: 'https://ddwiki.reso.org/'
  }, {
    key: 'reso_landlord',
    label: 'Landlord / Manager',
    category: 'contact',
    sensitive: true,
    property: 'ListAgentKey',
    uri: 'https://ddwiki.reso.org/'
  }]
},
// 9. ISO 20022 — Financial data
{
  id: 'ffs_iso20022',
  name: 'ISO 20022',
  spec: 'ISO 20022',
  uri: 'https://www.iso20022.org/',
  description: 'Financial messaging & account data',
  domain: 'Finance',
  accent: 'green',
  fields: [{
    key: 'fin_income_source',
    label: 'Income Source',
    category: 'sensitive',
    sensitive: true,
    property: 'Debtor',
    uri: 'https://www.iso20022.org/'
  }, {
    key: 'fin_monthly_income',
    label: 'Monthly Income',
    category: 'sensitive',
    sensitive: true,
    property: 'InstructedAmount',
    uri: 'https://www.iso20022.org/'
  }, {
    key: 'fin_bank_name',
    label: 'Bank Name',
    category: 'sensitive',
    sensitive: true,
    property: 'DebtorAgent',
    uri: 'https://www.iso20022.org/'
  }, {
    key: 'fin_benefits',
    label: 'Benefits Received',
    category: 'details',
    sensitive: false,
    property: 'RemittanceInformation',
    uri: 'https://www.iso20022.org/'
  }]
},
// 10. NIEM Justice — Court & legal records
{
  id: 'ffs_niem_justice',
  name: 'NIEM Justice',
  spec: 'NIEM Justice Domain',
  uri: 'https://release.niem.gov/niem/domains/justice/',
  description: 'Court cases, charges & sentencing',
  domain: 'Legal / Court',
  accent: 'purple',
  fields: [{
    key: 'justice_case_number',
    label: 'Case Number',
    category: 'case',
    sensitive: true,
    property: 'CaseNumberText',
    uri: 'https://release.niem.gov/niem/domains/justice/'
  }, {
    key: 'justice_case_status',
    label: 'Court Case Status',
    category: 'case',
    sensitive: false,
    property: 'CaseStatusText',
    uri: 'https://release.niem.gov/niem/domains/justice/'
  }, {
    key: 'justice_court',
    label: 'Court Name',
    category: 'case',
    sensitive: false,
    property: 'CourtName',
    uri: 'https://release.niem.gov/niem/domains/justice/'
  }, {
    key: 'justice_charge',
    label: 'Charge Description',
    category: 'sensitive',
    sensitive: true,
    property: 'ChargeDescriptionText',
    uri: 'https://release.niem.gov/niem/domains/justice/'
  }, {
    key: 'justice_probation_officer',
    label: 'Probation / Parole Officer',
    category: 'case',
    sensitive: false,
    property: 'SupervisionPerson',
    uri: 'https://release.niem.gov/niem/domains/justice/'
  }]
},
// 11. Dublin Core — Record & document metadata
{
  id: 'ffs_dublin_core',
  name: 'Dublin Core',
  spec: 'ISO 15836',
  uri: 'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/',
  description: 'Document & record metadata',
  domain: 'Bibliographic / Metadata',
  accent: 'gold',
  fields: [{
    key: 'dc_title',
    label: 'Case Title',
    category: 'case',
    sensitive: false,
    property: 'title',
    uri: 'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/#title'
  }, {
    key: 'dc_description',
    label: 'Case Description',
    category: 'case',
    sensitive: false,
    property: 'description',
    uri: 'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/#description'
  }, {
    key: 'dc_creator',
    label: 'Record Creator',
    category: 'case',
    sensitive: false,
    property: 'creator',
    uri: 'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/#creator'
  }, {
    key: 'dc_date',
    label: 'Date Created',
    category: 'case',
    sensitive: false,
    property: 'date',
    uri: 'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/#date'
  }, {
    key: 'dc_rights',
    label: 'Rights / Consent Scope',
    category: 'case',
    sensitive: false,
    property: 'rights',
    uri: 'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/#rights'
  }]
},
// 12. GeoJSON (RFC 7946) — Geographic coordinates
{
  id: 'ffs_geojson',
  name: 'GeoJSON',
  spec: 'RFC 7946',
  uri: 'https://datatracker.ietf.org/doc/html/rfc7946',
  description: 'Geographic coordinates & geometry',
  domain: 'Geospatial',
  accent: 'teal',
  fields: [{
    key: 'geo_latitude',
    label: 'Latitude',
    category: 'contact',
    sensitive: true,
    property: 'coordinates[1]',
    uri: 'https://datatracker.ietf.org/doc/html/rfc7946#section-3.1.1'
  }, {
    key: 'geo_longitude',
    label: 'Longitude',
    category: 'contact',
    sensitive: true,
    property: 'coordinates[0]',
    uri: 'https://datatracker.ietf.org/doc/html/rfc7946#section-3.1.1'
  }, {
    key: 'geo_service_area',
    label: 'Service Area',
    category: 'details',
    sensitive: false,
    property: 'Polygon',
    uri: 'https://datatracker.ietf.org/doc/html/rfc7946#section-3.1.6'
  }]
}];

// Lookup: framework id → framework object (for fast field tagging)
const FRAMEWORK_BY_ID = {};
FRAMEWORK_FIELD_STANDARDS.forEach(fw => {
  FRAMEWORK_BY_ID[fw.id] = fw;
});

// Build framework fields for a set of enabled framework ids
function getFrameworkFields(enabledIds) {
  const fields = [];
  const seen = new Set();
  for (const fwId of enabledIds) {
    const fw = FRAMEWORK_BY_ID[fwId];
    if (!fw) continue;
    for (const f of fw.fields) {
      if (seen.has(f.key)) continue;
      seen.add(f.key);
      fields.push({
        ...f,
        framework: fw.id,
        frameworkName: fw.name,
        frameworkUri: fw.uri
      });
    }
  }
  return fields;
}

/* ═══════════════════ ANONYMIZATION (§B.2) ═══════════════════
 * Operator Manifest:
 *   NUL(metrics.pii_field, {policy: block}) — data_suppression         — block method
 *   SEG(metrics.dob, {transform: age_bucket, boundaries: range}) — k_anonymity   — age_range method
 *   SEG(metrics.numeric, {transform: bracket, rules: range}) — statistical_binning — bracket method
 *   ALT(metrics.address, {transform: geohash, via: hashing}) — location_anonymization — area_hash method
 *   SYN(metrics.observation+anon_demographics, {via: cohort_hash}) — metric_emission — emitMetric
 *
 * Triad Summary:
 *   Existence:       NUL (PII suppression)
 *   Structure:       SEG (bucketing, range partitioning)
 *   Interpretation:  ALT (lossy hash transform)
 *   ⚠️ No REC — frame is deliberately stable. Anonymization is lossy by design;
 *   reinterpretation would violate the irreversibility guarantee.
 * ═══════════════════════════════════════════════════════════ */
// Transforms a single field according to DEFAULT_TRANSFORMS rules:
//   block    → NUL(metrics.pii_field, {policy: privacy}) — data_suppression — returns null
//   age_range→ SEG(metrics.dob, {transform: age_bucket, boundaries: range}) — k_anonymity
//   bracket  → SEG(metrics.numeric, {transform: bracket, rules: range}) — statistical_binning
//   area_hash→ ALT(metrics.address, {transform: geohash, via: hashing}) — location_anonymization
function anonymizeField(key, value) {
  const t = DEFAULT_TRANSFORMS[key];
  if (!t) return {
    key,
    value
  };
  if (t.method === 'block') return null; // NUL — suppress PII entirely
  if (t.method === 'age_range' && value) {
    // SEG — partition into age buckets
    const age = Math.floor((Date.now() - new Date(value).getTime()) / (365.25 * 24 * 60 * 60 * 1000));
    const bucket = t.buckets.find(b => {
      const [lo, hi] = b.split('-').map(Number);
      return age >= lo && (!hi || age <= hi);
    });
    return {
      key: 'age_range',
      value: bucket || 'unknown'
    };
  }
  if (t.method === 'bracket' && value) {
    const num = parseFloat(String(value).replace(/[^0-9.]/g, ''));
    const bucket = t.buckets.find(b => {
      const p = b.replace(/k/g, '000').split('-');
      return num >= parseFloat(p[0]) && (!p[1] || num < parseFloat(p[1]));
    });
    return {
      key: 'bracket',
      value: bucket || t.buckets[t.buckets.length - 1]
    };
  }
  if (t.method === 'area_hash') return {
    key: 'geo',
    value: value ? `area_${Math.abs([...value].reduce((h, c) => (h << 5) - h + c.charCodeAt(0) | 0, 0)).toString(36).slice(0, 6)}` : null
  };
  return {
    key,
    value
  };
}

// SYN(metrics.observation+anon_demographics, {via: cohort_hash}) — metric_emission
// Anonymizes identity, then synthesizes observation + demographics into a single metric event
async function emitMetric(metricsRoom, clientId, observation, demographics, program) {
  const hash = await cohortHash(clientId);
  const anonDemo = {};
  for (const [k, v] of Object.entries(demographics || {})) {
    const a = anonymizeField(k, v);
    if (a) anonDemo[a.key] = a.value;
  }
  const metric = {
    cohort_hash: hash,
    observation,
    demographics: anonDemo,
    program: program || 'general',
    ts: Date.now()
  };
  await svc.sendEvent(metricsRoom, EVT.METRIC, metric);
  return metric;
}

/* ═══════════════════ RESOURCE PERMISSION UTILITIES ═══════════════════ */
// DES(resources.permission_check, {grants, role}) — access_control — read-only classification, no mutations

/**
 * Check whether a user matches a permission grant.
 * @param {string} userId  – Matrix user ID (e.g. '@alice:matrix.org')
 * @param {string} userRole – org role (e.g. 'admin', 'case_manager')
 * @param {Array} grants   – array of {type:'role'|'user', id:string}
 * @returns {boolean}
 */
function matchesPermissionGrant(userId, userRole, grants) {
  if (!grants || grants.length === 0) return false;
  return grants.some(g => {
    if (g.type === 'user') return g.id === userId;
    if (g.type === 'role') return g.id === userRole;
    return false;
  });
}

/**
 * Check whether a user has a specific permission ability on a resource type.
 * @param {string} ability – one of RESOURCE_PERMISSION_ABILITIES
 * @param {object} permissions – the resource type's permissions object
 * @param {string} userId
 * @param {string} userRole
 * @returns {boolean}
 */
function hasResourcePermission(ability, permissions, userId, userRole) {
  if (!permissions) return true; // no permissions set → unrestricted
  const grants = permissions[ability];
  // viewers: empty array means everyone can see
  if (ability === 'viewers' && (!grants || grants.length === 0)) return true;
  // controllers/allocators: empty means only admin
  if (!grants || grants.length === 0) return userRole === 'admin';
  return matchesPermissionGrant(userId, userRole, grants);
}

/**
 * Check if user can view a resource type.
 */
function canViewResource(resourceType, userId, userRole) {
  return hasResourcePermission('viewers', resourceType.permissions, userId, userRole);
}

/**
 * Check if user can control (edit/delete/configure) a resource type.
 */
function canControlResource(resourceType, userId, userRole) {
  return hasResourcePermission('controllers', resourceType.permissions, userId, userRole);
}

/**
 * Check if user can allocate a resource type.
 */
function canAllocateResource(resourceType, userId, userRole) {
  return hasResourcePermission('allocators', resourceType.permissions, userId, userRole);
}

/**
 * Format a permission grant for display.
 */
function formatPermissionGrant(grant) {
  if (grant.type === 'role') return ORG_ROLE_LABELS[grant.id] || grant.id;
  if (grant.type === 'user') return grant.id;
  return grant.id;
}

/* ═══════════════════ RESOURCE TRACKING SERVICE (§Resource Build) ═══════════════════
 * Operator Manifest:
 *   DES(resources.types.{id}, {category, unit, constraints}) — resource_catalog     — createResourceType
 *   INS(resources.permissions, {default_grants}) — access_control                  — createResourceType
 *   ALT(resources.types.{id}.{field}, {updated_values}) — catalog_mutation         — updateResourceType
 *   ALT(resources.permissions, {grant_changes}) — access_control_mutation          — updateResourcePermissions
 *   CON(resources.propagation.{typeId}, {propagation_level}) — schema_cascade      — propagateResourceType
 *   CON(resources.relations.{id}, {relation_type}) — capacity_link                 — establishRelation
 *   INS(resources.inventory, {initial_stock}) — supply_initialization              — establishRelation
 *   ALT(resources.inventory.available, {adjustment}) — stock_adjustment            — restock/adjust
 *   INS(bridge.allocations.{id}, {allocation_data}) — individual_grant             — allocateResource
 *   INS(vault.allocations.{id}, {shadow_record}) — sovereign_record                — allocateResource
 *   SYN(metrics.allocation+anon_demographics, {via: cohort_hash}) — resource_metric — emitResourceMetric
 *
 * Triad Summary:
 *   Existence:       DES (type creation), INS (inventory, allocations, vault shadows)
 *   Structure:       CON (propagation, org↔type relations)
 *   Interpretation:  ALT (stock changes, type updates), SYN (metrics)
 *   ⚠️ No REC — resource frame is stable. Changing what "allocation" means
 *   would be a governance action (GOV_PROPOSAL), not a runtime operation.
 *
 * Core resource tracking infrastructure. Resources (beds, vouchers, funds, services) are
 * tracked across three levels — network, org, individual — using the existing room topology.
 *
 * Design principles:
 * 1. A resource is a relational configuration, not a fixed entity.
 * 2. Client sovereignty: vault shadow records are the client's inviolable record.
 * 3. Every resource has an opacity level (default SOVEREIGN) controlled by the holder.
 * 4. Governance hooks carry provenance metadata for every policy and constraint.
 * 5. All mutations emit EO operations — no silent state changes.
 * ════════════════════════════════════════════════════════════════════════════════════════ */

/** Generate unique resource IDs */
function genResourceId(prefix) {
  return `${prefix}_${Date.now().toString(36)}${Math.random().toString(36).slice(2, 8)}`;
}

/** Build a default source/provenance block for a resource type */
function buildResourceSource(level, propagation, adoptedVia, proposedBy, originOrg) {
  const src = {
    level
  };
  if (level === 'network' && propagation) src.propagation = propagation;
  if (adoptedVia) src.adopted_via = adoptedVia;
  if (proposedBy) src.proposed_by = proposedBy;
  if (originOrg) src.origin_org = originOrg;
  src.adopted_at = Date.now();
  return src;
}

/** Build a governance metadata block for a constraint */
function buildConstraintGovernance(sourceLevel, propagation, adoptedVia, divergenceAllowed) {
  return {
    propagation: propagation || 'optional',
    adopted_via: adoptedVia || null,
    source_level: sourceLevel || 'org',
    divergence_allowed: divergenceAllowed !== false
  };
}

/* ─── Constraint Validation (§10) ─── */

/**
 * Validate a proposed allocation against resource type constraints, policies,
 * and existing allocations. Returns { valid, violations[] } where each violation
 * includes governance provenance for contestability.
 */
function validateAllocation(allocationData, resourceType, policies, existingAllocations, callerRole) {
  const violations = [];

  // Merge constraints: resource type constraints + standalone policies
  const constraints = {
    ...(resourceType.constraints || {})
  };
  for (const policy of policies || []) {
    if (policy.resource_type_id === resourceType.id) {
      Object.assign(constraints, policy.constraints || {});
    }
  }

  // CHECK 1: eligible_roles
  if (constraints.eligible_roles && constraints.eligible_roles.length > 0) {
    if (!constraints.eligible_roles.includes(callerRole)) {
      violations.push({
        check: 'eligible_roles',
        message: `Role '${callerRole}' is not authorized to allocate this resource. Authorized roles: ${constraints.eligible_roles.join(', ')}`,
        governance: constraints.governance || null
      });
    }
  }

  // CHECK 2: max_per_client
  if (constraints.max_per_client != null) {
    const periodMs = (constraints.period_days || 365) * 24 * 60 * 60 * 1000;
    const cutoff = Date.now() - periodMs;
    const activeCount = (existingAllocations || []).filter(a => a.resource_type_id === resourceType.id && a.allocated_to === allocationData.allocated_to && a.status === 'active' && a.allocated_at >= cutoff).length;
    if (activeCount + 1 > constraints.max_per_client) {
      violations.push({
        check: 'max_per_client',
        message: `Client already has ${activeCount} active allocation(s) of ${resourceType.name} within the ${constraints.period_days || 365}-day period (max: ${constraints.max_per_client})${constraints.governance?.adopted_via ? `, adopted via ${constraints.governance.adopted_via}` : ''}`,
        governance: constraints.governance || null
      });
    }
  }

  // CHECK 3: requires_approval
  if (constraints.requires_approval) {
    const needsApproval = constraints.approval_threshold ? allocationData.quantity * 1 > constraints.approval_threshold : true;
    if (needsApproval && !allocationData.approval) {
      violations.push({
        check: 'requires_approval',
        message: `This allocation requires approval${constraints.approval_threshold ? ` (amount exceeds threshold of ${constraints.approval_threshold})` : ''}. Approver roles: ${(constraints.approver_roles || ['admin']).join(', ')}`,
        governance: constraints.governance || null
      });
    }
  }

  // CHECK 4: inventory availability (advisory, not blocking)
  // Logged but does not prevent allocation in emergency situations

  // CHECK 5: perishable TTL (informational)
  // Computed at allocation time, not a blocking constraint

  return {
    valid: violations.length === 0,
    violations
  };
}

/* ─── Resource Service ─── */

const ResourceService = {
  /* ═══ 5.1 Resource Type Management ═══ */

  /**
   * Create a resource type in the catalog (network or org room).
   * Emits DES operation. Returns event ID.
   */
  // DES(resources.types.{id}, {designation, category, unit, permissions}) — resource_catalog + INS(resources.permissions, {default_grants}) — access_control
  async createResourceType(roomId, typeData, roomType) {
    const level = roomType === 'network' ? 'network' : roomType === 'individual' ? 'individual' : 'org';
    if (level === 'network' && !typeData.source?.propagation) {
      throw new Error('Network-level resource types require a propagation level');
    }

    // Build permissions — merge caller-provided with defaults, add creator as explicit controller
    let permissions;
    if (level === 'individual') {
      // Individual resources: owner is sole controller and allocator
      permissions = {
        controllers: [{
          type: 'user',
          id: svc.userId
        }],
        allocators: [{
          type: 'user',
          id: svc.userId
        }],
        viewers: []
      };
    } else {
      const defaultPerms = buildDefaultResourcePermissions();
      permissions = typeData.permissions ? {
        controllers: typeData.permissions.controllers || defaultPerms.controllers,
        allocators: typeData.permissions.allocators || defaultPerms.allocators,
        viewers: typeData.permissions.viewers || defaultPerms.viewers
      } : defaultPerms;
      // Ensure creator is always a controller
      if (svc.userId && !permissions.controllers.some(g => g.type === 'user' && g.id === svc.userId)) {
        permissions.controllers.push({
          type: 'user',
          id: svc.userId
        });
      }
    }
    const resourceType = {
      id: typeData.id || genResourceId('rtype'),
      name: typeData.name,
      category: typeData.category,
      unit: typeData.unit,
      fungible: typeData.fungible !== false,
      perishable: typeData.perishable || false,
      ttl_days: typeData.ttl_days || null,
      infinite: typeData.infinite || false,
      replenishes: typeData.replenishes || false,
      replenish_cycle: typeData.replenish_cycle || null,
      tags: typeData.tags || [],
      source: typeData.source || buildResourceSource(level, typeData.propagation),
      maturity: typeData.maturity || 'draft',
      constraints: typeData.constraints || null,
      permissions
    };

    // Validate category
    if (!RESOURCE_CATEGORIES.includes(resourceType.category)) {
      throw new Error(`Invalid resource category: ${resourceType.category}. Must be one of: ${RESOURCE_CATEGORIES.join(', ')}`);
    }

    // Write state event
    await svc.setState(roomId, EVT.RESOURCE_TYPE, resourceType, resourceType.id);

    // Write permissions as separate state event for efficient lookups
    await svc.setState(roomId, EVT.RESOURCE_PERM, {
      resource_type_id: resourceType.id,
      ...permissions,
      updated_by: svc.userId,
      updated_at: Date.now()
    }, resourceType.id);

    // Emit DES operation
    await emitOp(roomId, 'DES', dot('resources', 'types', resourceType.id), {
      designation: resourceType.name,
      category: resourceType.category,
      unit: resourceType.unit,
      source_level: level,
      permissions
    }, {
      type: roomType === 'network' ? 'network' : roomType === 'individual' ? 'individual' : 'org',
      room: roomId,
      epistemic: 'GIVEN'
    });
    return resourceType;
  },
  /**
   * Update an existing resource type. Emits ALT for each changed field.
   * If propagation level changes, requires adopted_via reference (governance action).
   * Caller must have controller permission.
   */
  // ALT(resources.types.{id}.{field}, {updated_values}) — catalog_mutation
  async updateResourceType(roomId, typeId, changes, roomType, callerRole) {
    const existing = await svc.getState(roomId, EVT.RESOURCE_TYPE, typeId);
    if (!existing) throw new Error(`Resource type ${typeId} not found`);

    // Check controller permission
    if (!callerRole || !canControlResource(existing, svc.userId, callerRole)) {
      throw new Error('You do not have controller permission on this resource type');
    }

    // Check if propagation is changing (governance action)
    if (changes.source?.propagation && changes.source.propagation !== existing.source?.propagation) {
      if (!changes.source.adopted_via) {
        throw new Error('Changing propagation level is a governance action — adopted_via reference required');
      }
    }
    const updated = {
      ...existing,
      ...changes
    };
    await svc.setState(roomId, EVT.RESOURCE_TYPE, updated, typeId);

    // Emit ALT for each changed field
    for (const [key, val] of Object.entries(changes)) {
      if (JSON.stringify(existing[key]) !== JSON.stringify(val)) {
        await emitOp(roomId, 'ALT', dot('resources', 'types', typeId, key), {
          from: existing[key],
          to: val
        }, {
          type: roomType === 'network' ? 'network' : 'org',
          room: roomId,
          epistemic: 'GIVEN'
        });
      }
    }
    return updated;
  },
  /**
   * Update permissions on a resource type. Caller must be a current controller.
   * Writes to both the resource type state and a dedicated RESOURCE_PERM state event.
   */
  // ALT(resources.types.{id}.permissions, {grant_changes}) — access_control_mutation
  async updateResourcePermissions(roomId, typeId, newPermissions, callerRole) {
    const existing = await svc.getState(roomId, EVT.RESOURCE_TYPE, typeId);
    if (!existing) throw new Error(`Resource type ${typeId} not found`);

    // Only controllers can change permissions
    if (!callerRole || !canControlResource(existing, svc.userId, callerRole)) {
      throw new Error('You do not have controller permission on this resource type');
    }

    // Merge with existing, validate structure
    const permissions = {
      controllers: newPermissions.controllers || existing.permissions?.controllers || [],
      allocators: newPermissions.allocators || existing.permissions?.allocators || [],
      viewers: newPermissions.viewers || existing.permissions?.viewers || []
    };

    // Safety: ensure at least one controller exists
    if (permissions.controllers.length === 0) {
      permissions.controllers = [{
        type: 'role',
        id: 'admin'
      }];
    }

    // Update the resource type
    existing.permissions = permissions;
    await svc.setState(roomId, EVT.RESOURCE_TYPE, existing, typeId);

    // Update the dedicated permissions event
    await svc.setState(roomId, EVT.RESOURCE_PERM, {
      resource_type_id: typeId,
      ...permissions,
      updated_by: svc.userId,
      updated_at: Date.now()
    }, typeId);

    // Emit ALT for permissions change
    await emitOp(roomId, 'ALT', dot('resources', 'types', typeId, 'permissions'), {
      permissions
    }, {
      type: 'org',
      room: roomId,
      epistemic: 'MEANT'
    });
    return existing;
  },
  /**
   * Propagate a resource type from network room to org room.
   * Respects propagation levels: required (immutable), standard (extendable),
   * recommended (visible), optional (catalog only).
   */
  // CON(resources.propagation.{typeId}, {propagation_level}) — schema_cascade
  async propagateResourceType(networkRoomId, orgRoomId, typeId) {
    const networkType = await svc.getState(networkRoomId, EVT.RESOURCE_TYPE, typeId);
    if (!networkType) throw new Error(`Resource type ${typeId} not found in network room`);
    const orgType = {
      ...networkType,
      source: {
        ...networkType.source,
        level: 'network',
        origin_org: null // came from network, not from an org
      }
    };
    const propagation = networkType.source?.propagation || 'optional';
    if (propagation === 'required' || propagation === 'standard') {
      await svc.setState(orgRoomId, EVT.RESOURCE_TYPE, orgType, typeId);
    } else if (propagation === 'recommended') {
      // Write to org as draft — visible but not active until adopted
      orgType.maturity = orgType.maturity === 'normative' ? orgType.maturity : 'draft';
      await svc.setState(orgRoomId, EVT.RESOURCE_TYPE, orgType, typeId);
    }
    // 'optional': do nothing — org browses network catalog manually

    // Emit CON operation for the propagation relationship
    await emitOp(orgRoomId, 'CON', dot('resources', 'propagation', typeId), {
      source: networkRoomId,
      dest: orgRoomId,
      relation: 'propagates',
      type_id: typeId,
      propagation
    }, {
      type: 'org',
      room: orgRoomId,
      epistemic: 'GIVEN'
    });
    return orgType;
  },
  /* ═══ 5.2 Resource Relations ═══ */

  /**
   * Establish a relation between an org and a resource type.
   * Defaults opacity to SOVEREIGN (0). Emits CON operation.
   */
  // CON(resources.relations.{id}, {relation_type, source, dest}) — capacity_link + INS(resources.inventory, {initial_stock}) — supply_initialization
  async establishRelation(orgRoomId, relationData) {
    if (!RESOURCE_RELATION_TYPES.includes(relationData.relation_type)) {
      throw new Error(`Invalid relation type: ${relationData.relation_type}. Must be one of: ${RESOURCE_RELATION_TYPES.join(', ')}`);
    }
    const relation = {
      id: relationData.id || genResourceId('rrel'),
      resource_type_id: relationData.resource_type_id,
      holder: orgRoomId,
      relation_type: relationData.relation_type,
      target: relationData.target || null,
      capacity: relationData.capacity || 0,
      available: relationData.available ?? relationData.capacity ?? 0,
      constraints_override: relationData.constraints_override || null,
      // Opacity defaults to SOVEREIGN
      opacity: relationData.opacity ?? RESOURCE_OPACITY.SOVEREIGN,
      disclosed_fields: relationData.disclosed_fields || null,
      attested_to: relationData.attested_to || null,
      // Provenance
      established_at: Date.now(),
      established_by: svc.userId,
      funding_source: relationData.funding_source || null,
      notes: relationData.notes || null,
      // Dedup starts null
      dedup: null
    };
    await svc.setState(orgRoomId, EVT.RESOURCE_RELATION, relation, relation.id);

    // Emit CON operation
    await emitOp(orgRoomId, 'CON', dot('resources', 'relations', relation.id), {
      source: orgRoomId,
      dest: relation.resource_type_id,
      relation_type: relation.relation_type,
      relation_id: relation.id,
      capacity: relation.capacity
    }, {
      type: 'org',
      room: orgRoomId,
      epistemic: 'GIVEN'
    });

    // Initialize inventory for this relation
    if (relation.capacity > 0) {
      await this.restockInventory(orgRoomId, relation.id, relation.capacity, {
        initial: true
      });
    }
    return relation;
  },
  /**
   * Update opacity level on a resource relation.
   * Validates caller is org admin. Emits SEG operation.
   */
  async updateRelationOpacity(orgRoomId, relationId, newOpacity, disclosedFields, attestedTo) {
    const relation = await svc.getState(orgRoomId, EVT.RESOURCE_RELATION, relationId);
    if (!relation) throw new Error(`Relation ${relationId} not found`);
    const oldOpacity = relation.opacity;
    relation.opacity = newOpacity;

    // Validate opacity-specific requirements
    if (newOpacity === RESOURCE_OPACITY.ATTESTED) {
      if (!attestedTo || attestedTo.length === 0) {
        throw new Error('ATTESTED opacity requires attestedTo list of bridge room IDs');
      }
      relation.attested_to = attestedTo;
    }
    if (newOpacity >= RESOURCE_OPACITY.CONTRIBUTED) {
      relation.disclosed_fields = disclosedFields || ['resource_type_id', 'capacity', 'available', 'relation_type'];
    }
    await svc.setState(orgRoomId, EVT.RESOURCE_RELATION, relation, relationId);

    // Write opacity state event
    await svc.setState(orgRoomId, EVT.RESOURCE_OPACITY, {
      relation_id: relationId,
      opacity: newOpacity,
      previous_opacity: oldOpacity,
      disclosed_fields: relation.disclosed_fields,
      attested_to: relation.attested_to,
      changed_by: svc.userId,
      changed_at: Date.now()
    }, relationId);

    // Emit SEG operation
    await emitOp(orgRoomId, 'SEG', dot('resources', 'relations', relationId, 'opacity'), {
      relation: relationId,
      opacity: newOpacity,
      disclosed_fields: relation.disclosed_fields,
      from_opacity: oldOpacity,
      to_opacity: newOpacity,
      direction: newOpacity > oldOpacity ? 'disclosure' : 'withdrawal'
    }, {
      type: 'org',
      room: orgRoomId,
      epistemic: 'MEANT'
    });
    return relation;
  },
  /* ═══ 5.3 Inventory Management ═══ */

  /**
   * Restock inventory for a resource relation.
   * Adds quantity to total_capacity and available. Emits INS operation.
   */
  // INS(resources.inventory.{relationId}, {quantity}) — supply_replenishment
  async restockInventory(orgRoomId, relationId, quantity, metadata) {
    const existing = await svc.getState(orgRoomId, EVT.RESOURCE_INVENTORY, relationId);
    const now = Date.now();
    const inventory = existing ? {
      ...existing,
      total_capacity: existing.total_capacity + quantity,
      available: existing.available + quantity,
      last_restocked: now,
      last_updated: now
    } : {
      resource_type_id: null,
      // will be filled from relation
      relation_id: relationId,
      total_capacity: quantity,
      available: quantity,
      allocated: 0,
      reserved: 0,
      last_restocked: now,
      last_updated: now
    };

    // Fill resource_type_id from relation if not set
    if (!inventory.resource_type_id) {
      const relation = await svc.getState(orgRoomId, EVT.RESOURCE_RELATION, relationId);
      if (relation) inventory.resource_type_id = relation.resource_type_id;
    }
    await svc.setState(orgRoomId, EVT.RESOURCE_INVENTORY, inventory, relationId);

    // Emit INS operation
    await emitOp(orgRoomId, 'INS', dot('resources', 'inventory', relationId), {
      quantity,
      total_capacity: inventory.total_capacity,
      available: inventory.available,
      metadata
    }, {
      type: 'org',
      room: orgRoomId,
      epistemic: 'GIVEN'
    });
    return inventory;
  },
  /**
   * Adjust inventory for write-offs, corrections, or manual adjustments.
   * Emits ALT operation with reason.
   */
  // ALT(resources.inventory.{relationId}, {adjustment, reason}) — correction
  async adjustInventory(orgRoomId, relationId, adjustment, reason) {
    const inventory = await svc.getState(orgRoomId, EVT.RESOURCE_INVENTORY, relationId);
    if (!inventory) throw new Error(`No inventory found for relation ${relationId}`);
    inventory.total_capacity += adjustment;
    inventory.available += adjustment;
    inventory.last_updated = Date.now();

    // Prevent negatives
    if (inventory.available < 0) inventory.available = 0;
    if (inventory.total_capacity < 0) inventory.total_capacity = 0;
    await svc.setState(orgRoomId, EVT.RESOURCE_INVENTORY, inventory, relationId);
    await emitOp(orgRoomId, 'ALT', dot('resources', 'inventory', relationId), {
      adjustment,
      reason,
      available: inventory.available,
      total_capacity: inventory.total_capacity
    }, {
      type: 'org',
      room: orgRoomId,
      epistemic: 'GIVEN'
    });
    return inventory;
  },
  /* ═══ 5.4 Resource Allocation (Critical Path) ═══ */

  /**
   * Allocate a resource to a client. Writes to THREE places:
   * 1. Bridge room (allocation state event)
   * 2. Client vault (shadow record)
   * 3. Org room (inventory decrement)
   *
   * Returns { allocation, bridgeEventId, vaultEventId, inventoryEventId }
   */
  // INS(bridge.allocations.{id}, {allocation_data}) — individual_grant + ALT(resources.inventory.{relation_id}.available, {-quantity}) — stock_decrement + INS(vault.allocations.{id}, {shadow_record}) — sovereign_record
  // ⚠️ Three-part write: bridge allocation + inventory decrement + vault shadow. Partial failure = inconsistency.
  async allocateResource(bridgeRoomId, allocationData, orgRoomId, vaultRoomId) {
    // STEP 1: Validate constraints
    const resourceType = await svc.getState(orgRoomId, EVT.RESOURCE_TYPE, allocationData.resource_type_id);
    if (!resourceType) throw new Error(`Resource type ${allocationData.resource_type_id} not found`);

    // Load applicable policies from org room
    const policies = [];
    if (svc.client) {
      const room = svc.client.getRoom(orgRoomId);
      if (room) {
        const stateEvents = room.currentState.getStateEvents(EVT.RESOURCE_POLICY);
        if (stateEvents) {
          for (const ev of Array.isArray(stateEvents) ? stateEvents : [stateEvents]) {
            if (ev && ev.getContent) policies.push(ev.getContent());
          }
        }
      }
    }

    // Load existing allocations for this client from bridge room
    const existingAllocations = [];
    if (svc.client) {
      const room = svc.client.getRoom(bridgeRoomId);
      if (room) {
        const allocEvents = room.currentState.getStateEvents(EVT.RESOURCE_ALLOC);
        if (allocEvents) {
          for (const ev of Array.isArray(allocEvents) ? allocEvents : [allocEvents]) {
            if (ev && ev.getContent) existingAllocations.push(ev.getContent());
          }
        }
      }
    }

    // Determine caller's org role
    const orgRoster = await svc.getState(orgRoomId, EVT.ORG_ROSTER);
    const staffEntry = orgRoster?.staff?.find(s => s.userId === svc.userId);
    const callerRole = staffEntry?.role || 'provider';

    // Check allocator permission from resource type permissions
    if (!canAllocateResource(resourceType, svc.userId, callerRole)) {
      return {
        valid: false,
        violations: [{
          check: 'allocator_permission',
          message: `Your role (${ORG_ROLE_LABELS[callerRole] || callerRole}) does not have allocator permission for "${resourceType.name}".`
        }]
      };
    }
    const validation = validateAllocation(allocationData, resourceType, policies, existingAllocations, callerRole);
    if (!validation.valid) {
      return {
        valid: false,
        violations: validation.violations
      };
    }

    // STEP 2: Write allocation to bridge room
    const allocation = {
      id: allocationData.id || genResourceId('ralloc'),
      resource_type_id: allocationData.resource_type_id,
      relation_id: allocationData.relation_id,
      quantity: allocationData.quantity,
      unit: resourceType.unit,
      allocated_by: svc.userId,
      allocated_to: allocationData.allocated_to,
      org_id: orgRoomId,
      status: 'active',
      allocated_at: Date.now(),
      expires_at: resourceType.perishable && resourceType.ttl_days ? Date.now() + resourceType.ttl_days * 24 * 60 * 60 * 1000 : null,
      notes: allocationData.notes || null,
      approval: allocationData.approval || null,
      created_by: svc.userId,
      origin_server: extractHomeserver(svc.userId)
    };
    await svc.setState(bridgeRoomId, EVT.RESOURCE_ALLOC, allocation, allocation.id);

    // Emit INS operation for bridge allocation
    await emitOp(bridgeRoomId, 'INS', dot('bridge', 'allocations', allocation.id), {
      resource_type: resourceType.name,
      quantity: allocation.quantity,
      unit: allocation.unit
    }, {
      type: 'bridge',
      room: bridgeRoomId,
      epistemic: 'GIVEN'
    });

    // STEP 3: Write shadow record to client vault
    // Denormalized intentionally — vault must be readable even if bridge is severed
    const orgMeta = await svc.getState(orgRoomId, EVT.ORG_METADATA);
    const vaultRecord = {
      allocation_id: allocation.id,
      resource_type_id: allocation.resource_type_id,
      resource_name: resourceType.name,
      quantity: allocation.quantity,
      unit: allocation.unit,
      provider_display_name: svc.userId,
      // Matrix user ID as fallback display
      org_display_name: orgMeta?.name || orgRoomId,
      allocated_at: allocation.allocated_at,
      status: 'active',
      notes: allocationData.notes || null,
      bridge_room_id: bridgeRoomId,
      source_event_id: allocation.id
    };
    try {
      await svc.setState(vaultRoomId, EVT.RESOURCE_VAULT, vaultRecord, allocation.id);

      // Emit INS operation for vault shadow
      await emitOp(vaultRoomId, 'INS', dot('vault', 'allocations', allocation.id), {
        resource_name: resourceType.name,
        quantity: allocation.quantity
      }, {
        type: 'vault',
        room: vaultRoomId,
        epistemic: 'GIVEN'
      });
    } catch (e) {
      // If vault write fails, log error — bridge allocation is source of truth.
      // Background reconciliation can fix missing vault shadows.
      console.error(`[ResourceService] Vault shadow write failed for allocation ${allocation.id}:`, e.message);
    }

    // STEP 4: Decrement inventory
    try {
      const inventory = await svc.getState(orgRoomId, EVT.RESOURCE_INVENTORY, allocation.relation_id);
      if (inventory) {
        inventory.available = Math.max(0, inventory.available - allocation.quantity);
        inventory.allocated = (inventory.allocated || 0) + allocation.quantity;
        inventory.last_updated = Date.now();
        await svc.setState(orgRoomId, EVT.RESOURCE_INVENTORY, inventory, allocation.relation_id);
        await emitOp(orgRoomId, 'ALT', dot('resources', 'inventory', allocation.relation_id, 'available'), {
          decremented_by: allocation.quantity,
          available: inventory.available,
          allocated: inventory.allocated
        }, {
          type: 'org',
          room: orgRoomId,
          epistemic: 'GIVEN'
        });
      }
    } catch (e) {
      // Inventory sync failure should never block allocation.
      console.error(`[ResourceService] Inventory decrement failed for relation ${allocation.relation_id}:`, e.message);
    }
    return {
      valid: true,
      allocation
    };
  },
  /* ═══ 5.5 Resource Lifecycle Events ═══ */

  /**
   * Record a lifecycle event (consumed, expired, revoked, returned).
   * Updates allocation state, vault shadow, and inventory.
   */
  async recordResourceEvent(bridgeRoomId, eventData, orgRoomId, vaultRoomId) {
    const event = {
      allocation_id: eventData.allocation_id,
      event: eventData.event,
      quantity: eventData.quantity,
      recorded_by: svc.userId,
      recorded_at: Date.now(),
      notes: eventData.notes || null
    };

    // Validate event type
    if (!RESOURCE_LIFECYCLE_EVENTS.includes(event.event)) {
      throw new Error(`Invalid lifecycle event: ${event.event}`);
    }

    // Send timeline event to bridge room (NOT state — lifecycle events are append-only)
    await svc.sendEvent(bridgeRoomId, EVT.RESOURCE_EVENT, event);

    // Update allocation state event
    const allocation = await svc.getState(bridgeRoomId, EVT.RESOURCE_ALLOC, event.allocation_id);
    if (allocation) {
      const newStatus = event.event === 'consumed' ? 'consumed' : event.event === 'expired' ? 'expired' : event.event === 'revoked' ? 'revoked' : allocation.status;
      allocation.status = newStatus;
      await svc.setState(bridgeRoomId, EVT.RESOURCE_ALLOC, allocation, event.allocation_id);
    }

    // Update vault shadow record status
    if (vaultRoomId) {
      try {
        const vaultRecord = await svc.getState(vaultRoomId, EVT.RESOURCE_VAULT, event.allocation_id);
        if (vaultRecord) {
          vaultRecord.status = allocation?.status || event.event;
          await svc.setState(vaultRoomId, EVT.RESOURCE_VAULT, vaultRecord, event.allocation_id);
        }
      } catch (e) {
        console.error(`[ResourceService] Vault shadow update failed for ${event.allocation_id}:`, e.message);
      }
    }

    // Adjust inventory based on event type
    if (orgRoomId && allocation?.relation_id) {
      try {
        const inventory = await svc.getState(orgRoomId, EVT.RESOURCE_INVENTORY, allocation.relation_id);
        if (inventory) {
          switch (event.event) {
            case 'consumed':
              // Partial consumption: decrement allocated
              inventory.allocated = Math.max(0, inventory.allocated - event.quantity);
              break;
            case 'expired':
              // Expired: decrement allocated, do NOT increment available (resource is gone)
              inventory.allocated = Math.max(0, inventory.allocated - event.quantity);
              break;
            case 'revoked':
              // Revoked: decrement allocated, increment available (resource reclaimed)
              inventory.allocated = Math.max(0, inventory.allocated - event.quantity);
              inventory.available += event.quantity;
              break;
            case 'returned':
              // Returned: decrement allocated, increment available
              inventory.allocated = Math.max(0, inventory.allocated - event.quantity);
              inventory.available += event.quantity;
              break;
          }
          inventory.last_updated = Date.now();
          await svc.setState(orgRoomId, EVT.RESOURCE_INVENTORY, inventory, allocation.relation_id);
        }
      } catch (e) {
        console.error(`[ResourceService] Inventory adjustment failed for lifecycle event:`, e.message);
      }
    }

    // Emit appropriate EO operation
    const eoOp = event.event === 'revoked' ? 'NUL' : 'ALT';
    await emitOp(bridgeRoomId, eoOp, dot('bridge', 'allocations', event.allocation_id, 'lifecycle'), {
      event: event.event,
      quantity: event.quantity
    }, {
      type: 'bridge',
      room: bridgeRoomId,
      epistemic: 'GIVEN'
    });
    return event;
  },
  /* ═══ 5.6 Automated Expiry ═══ */

  /**
   * Check for expired allocations across bridge rooms.
   * For each expired allocation: emit lifecycle event, update status, adjust inventory.
   */
  async checkExpiredAllocations(bridgeRoomIds, orgRoomId, vaultRoomId) {
    const now = Date.now();
    const expired = [];
    for (const bridgeRoomId of bridgeRoomIds) {
      if (!svc.client) continue;
      const room = svc.client.getRoom(bridgeRoomId);
      if (!room) continue;
      const allocEvents = room.currentState.getStateEvents(EVT.RESOURCE_ALLOC);
      if (!allocEvents) continue;
      const allocs = Array.isArray(allocEvents) ? allocEvents : [allocEvents];
      for (const ev of allocs) {
        const alloc = ev.getContent ? ev.getContent() : ev;
        if (alloc.status === 'active' && alloc.expires_at && alloc.expires_at < now) {
          try {
            await this.recordResourceEvent(bridgeRoomId, {
              allocation_id: alloc.id,
              event: 'expired',
              quantity: alloc.quantity,
              notes: 'Automatic expiry'
            }, orgRoomId, vaultRoomId);
            expired.push(alloc.id);
          } catch (e) {
            console.error(`[ResourceService] Auto-expiry failed for ${alloc.id}:`, e.message);
          }
        }
      }
    }
    return expired;
  },
  /* ═══ 5.7 Deduplication Detection ═══ */

  /**
   * Detect potential overlaps among CONTRIBUTED resource relations.
   * Groups by resource_type_id + capacity range overlap.
   * Does NOT auto-merge — surfaces candidates for human review.
   */
  async detectPotentialOverlaps(networkRoomId) {
    const netMembers = await svc.getState(networkRoomId, EVT.NET_MEMBERS);
    if (!netMembers?.organizations) return [];
    const contributedRelations = [];
    for (const org of netMembers.organizations) {
      const orgRoomId = org.roomId;
      if (!svc.client) continue;
      const room = svc.client.getRoom(orgRoomId);
      if (!room) continue;
      const relEvents = room.currentState.getStateEvents(EVT.RESOURCE_RELATION);
      if (!relEvents) continue;
      const rels = Array.isArray(relEvents) ? relEvents : [relEvents];
      for (const ev of rels) {
        const rel = ev.getContent ? ev.getContent() : ev;
        // Only consider CONTRIBUTED or PUBLISHED relations
        if (rel.opacity >= RESOURCE_OPACITY.CONTRIBUTED) {
          contributedRelations.push({
            ...rel,
            _org_room: orgRoomId,
            _org_name: org.name || orgRoomId
          });
        }
      }
    }

    // Group by resource_type_id
    const groups = {};
    for (const rel of contributedRelations) {
      const key = rel.resource_type_id;
      if (!groups[key]) groups[key] = [];
      groups[key].push(rel);
    }

    // Find clusters with 2+ relations (potential overlaps)
    const candidates = [];
    for (const [typeId, rels] of Object.entries(groups)) {
      if (rels.length < 2) continue;

      // Check if already resolved
      const unresolvedPairs = [];
      for (let i = 0; i < rels.length; i++) {
        for (let j = i + 1; j < rels.length; j++) {
          const a = rels[i],
            b = rels[j];
          const aResolved = a.dedup?.linked_to === b.id && a.dedup?.link_status !== 'unresolved';
          const bResolved = b.dedup?.linked_to === a.id && b.dedup?.link_status !== 'unresolved';
          if (!aResolved && !bResolved) {
            unresolvedPairs.push({
              a,
              b
            });
          }
        }
      }
      if (unresolvedPairs.length > 0) {
        candidates.push({
          resource_type_id: typeId,
          relations: rels,
          unresolved_pairs: unresolvedPairs,
          total_capacity_range: {
            min: Math.min(...rels.map(r => r.capacity || 0)),
            max: rels.reduce((sum, r) => sum + (r.capacity || 0), 0)
          }
        });
      }
    }
    return candidates;
  },
  /**
   * Record a dedup resolution between two resource relations.
   * Emits CON (confirmed), DES (attested_non_additive), or SUP (unresolved).
   */
  async resolveDedup(orgRoomId, relationId, resolution) {
    const relation = await svc.getState(orgRoomId, EVT.RESOURCE_RELATION, relationId);
    if (!relation) throw new Error(`Relation ${relationId} not found`);
    relation.dedup = {
      linked_to: resolution.linked_to || null,
      link_type: resolution.link_type || null,
      link_status: resolution.link_status,
      link_resolved_by: svc.userId,
      link_resolved_at: Date.now()
    };
    await svc.setState(orgRoomId, EVT.RESOURCE_RELATION, relation, relationId);

    // Emit appropriate EO operation
    switch (resolution.link_status) {
      case 'confirmed':
        await emitOp(orgRoomId, 'CON', dot('org', 'dedup', relationId), {
          source: relationId,
          dest: resolution.linked_to,
          link_type: resolution.link_type,
          resolution: 'confirmed_overlap'
        }, {
          type: 'org',
          room: orgRoomId,
          epistemic: 'MEANT'
        });
        break;
      case 'attested_non_additive':
        await emitOp(orgRoomId, 'DES', dot('org', 'dedup', relationId), {
          designation: 'non_additive',
          resolution: 'attested_non_additive'
        }, {
          type: 'org',
          room: orgRoomId,
          epistemic: 'MEANT'
        });
        break;
      case 'unresolved':
        await emitOp(orgRoomId, 'SUP', dot('org', 'dedup', relationId), {
          entities: [relationId, resolution.linked_to],
          superposition: 'potential_overlap',
          resolution: 'unresolved'
        }, {
          type: 'org',
          room: orgRoomId,
          epistemic: 'MEANT'
        });
        break;
    }
    return relation;
  },
  /* ═══ 5.8 Upward Promotion (Org → Network) ═══ */

  /**
   * Propose promoting an org-level resource type to network level.
   * Creates a governance proposal event (same format as schema proposals).
   */
  async proposeResourceTypePromotion(networkRoomId, orgRoomId, typeId, proposedPropagation) {
    const orgType = await svc.getState(orgRoomId, EVT.RESOURCE_TYPE, typeId);
    if (!orgType) throw new Error(`Resource type ${typeId} not found in org room`);
    const proposal = {
      id: genResourceId('prop'),
      type: 'resource_type_promotion',
      summary: `Promote "${orgType.name}" (${orgType.category}) from org to network catalog`,
      resource_type: orgType,
      target_propagation: proposedPropagation || 'optional',
      origin_org: orgRoomId,
      proposed_by: svc.userId,
      proposed_at: Date.now(),
      status: 'submitted',
      positions: {}
    };
    await svc.setState(networkRoomId, EVT.GOV_PROPOSAL, proposal, proposal.id);

    // Emit REC operation (recentering from org to network)
    await emitOp(networkRoomId, 'REC', dot('network', 'resources', typeId), {
      recentered_from: 'org',
      to: 'network',
      proposal_id: proposal.id,
      org_room: orgRoomId,
      propagation: proposedPropagation
    }, {
      type: 'network',
      room: networkRoomId,
      epistemic: 'MEANT'
    });
    return proposal;
  },
  /* ═══ §6 Propagation Service Extensions ═══ */

  /**
   * Handle resource type propagation from network to member orgs.
   * Called by the propagation service when a RESOURCE_TYPE event is received.
   */
  async handleResourceTypePropagation(networkRoomId, event) {
    const netMembers = await svc.getState(networkRoomId, EVT.NET_MEMBERS);
    if (!netMembers?.organizations) return;
    const typeData = event;
    const propagation = typeData.source?.propagation || 'optional';
    for (const org of netMembers.organizations) {
      const orgRoomId = org.roomId;
      try {
        if (propagation === 'required') {
          // Auto-apply, immutable
          await this.propagateResourceType(networkRoomId, orgRoomId, typeData.id);
        } else if (propagation === 'standard') {
          // Auto-apply, notify org admin
          await this.propagateResourceType(networkRoomId, orgRoomId, typeData.id);
          // Notification would be sent here (via existing notification system)
        } else if (propagation === 'recommended') {
          // Write to org catalog as visible but not active
          await this.propagateResourceType(networkRoomId, orgRoomId, typeData.id);
        }
        // 'optional': do nothing
      } catch (e) {
        console.error(`[ResourceService] Propagation to ${orgRoomId} failed for ${typeData.id}:`, e.message);
      }
    }
  },
  /**
   * Handle resource policy propagation from network to member orgs.
   * Policies propagate alongside the resource types they govern.
   */
  async handleResourcePolicyPropagation(networkRoomId, policyData) {
    const netMembers = await svc.getState(networkRoomId, EVT.NET_MEMBERS);
    if (!netMembers?.organizations) return;
    const propagation = policyData.governance?.propagation || 'optional';
    for (const org of netMembers.organizations) {
      const orgRoomId = org.roomId;
      try {
        if (propagation === 'required' || propagation === 'standard') {
          const stateKey = `${policyData.resource_type_id}:${policyData.rule_type || 'default'}`;
          await svc.setState(orgRoomId, EVT.RESOURCE_POLICY, policyData, stateKey);
        }
      } catch (e) {
        console.error(`[ResourceService] Policy propagation to ${orgRoomId} failed:`, e.message);
      }
    }
  },
  /* ═══ §7 Opacity Propagation Logic ═══ */

  /**
   * Handle opacity change events. Propagates visibility to appropriate rooms.
   * SOVEREIGN → ATTESTED: write projection to listed bridge rooms
   * → CONTRIBUTED: write projection to network resource commons
   * → PUBLISHED: requires governance approval
   * Downgrade: remove projections from appropriate rooms
   */
  async handleOpacityChange(orgRoomId, relationId, newOpacity, oldOpacity, relation) {
    // Build projection (only disclosed fields)
    const disclosedFields = relation.disclosed_fields || ['resource_type_id', 'capacity', 'available', 'relation_type'];
    const projection = {};
    for (const field of disclosedFields) {
      if (relation[field] !== undefined) projection[field] = relation[field];
    }
    projection._source_org = orgRoomId;
    projection._source_relation = relationId;
    projection._projected_at = Date.now();
    if (newOpacity > oldOpacity) {
      // Upgrading opacity — disclosing more

      if (newOpacity >= RESOURCE_OPACITY.ATTESTED && relation.attested_to) {
        // Write projection to listed bridge rooms
        for (const bridgeRoomId of relation.attested_to) {
          try {
            await svc.setState(bridgeRoomId, EVT.RESOURCE_RELATION, projection, `proj_${relationId}`);
          } catch (e) {
            console.error(`[ResourceService] Bridge projection failed for ${bridgeRoomId}:`, e.message);
          }
        }
      }
      if (newOpacity >= RESOURCE_OPACITY.CONTRIBUTED) {
        // Contributed to network — trigger dedup detection
        // The projection is already on the org room; network reads from org rooms
      }
      if (newOpacity >= RESOURCE_OPACITY.PUBLISHED) {
        // Published — would require governance approval check
        // Deferred to governance integration phase
      }
    } else if (newOpacity < oldOpacity) {
      // Downgrading opacity — withdrawing disclosure

      if (oldOpacity >= RESOURCE_OPACITY.ATTESTED && newOpacity < RESOURCE_OPACITY.ATTESTED) {
        // Remove projections from bridge rooms
        if (relation.attested_to) {
          for (const bridgeRoomId of relation.attested_to) {
            try {
              await svc.setState(bridgeRoomId, EVT.RESOURCE_RELATION, {
                _withdrawn: true,
                _source_relation: relationId
              }, `proj_${relationId}`);
            } catch (e) {
              console.error(`[ResourceService] Bridge projection withdrawal failed:`, e.message);
            }
          }
        }
      }

      // Emit NUL on withdrawn projections
      await emitOp(orgRoomId, 'NUL', dot('resources', 'projection', relationId), {
        from_opacity: oldOpacity,
        to_opacity: newOpacity,
        withdrawn: true
      }, {
        type: 'org',
        room: orgRoomId,
        epistemic: 'MEANT'
      });
    }
  },
  /* ═══ §9 Anonymized Resource Metrics ═══ */

  /**
   * Emit an anonymized resource metric from an allocation.
   * Follows the existing metrics anonymization pipeline.
   * Strips PII, buckets amounts, hashes cohort.
   */
  // SYN(metrics.allocation+anon_demographics, {via: cohort_hash}) — resource_metric + NUL(metrics.raw_identity, {via: pipeline}) — pii_strip
  async emitResourceMetric(metricsRoomId, allocation, resourceType, clientId) {
    const hash = await cohortHash(clientId);

    // Bucket quantity for anonymization
    const qty = allocation.quantity;
    let quantityBucket;
    if (qty <= 1) quantityBucket = '1';else if (qty <= 5) quantityBucket = '2-5';else if (qty <= 10) quantityBucket = '6-10';else if (qty <= 25) quantityBucket = '11-25';else if (qty <= 50) quantityBucket = '26-50';else if (qty <= 100) quantityBucket = '51-100';else quantityBucket = '100+';
    const now = new Date();
    const period = `${now.getFullYear()}-Q${Math.floor(now.getMonth() / 3) + 1}`;
    const metric = {
      cohort_hash: hash,
      resource_category: resourceType.category,
      // category, not specific type
      quantity_bucket: quantityBucket,
      period,
      ts: Date.now(),
      type: 'resource' // distinguishes from observation metrics
    };
    await svc.sendEvent(metricsRoomId, EVT.METRIC, metric);
    return metric;
  },
  /**
   * Emit a network aggregate resource metric.
   * k-anonymity: suppress if fewer than 5 clients in a bucket.
   */
  async emitResourceAggregate(networkMetricsRoomId, orgMetrics) {
    // Group by category + period
    const aggregates = {};
    for (const m of orgMetrics) {
      const key = `${m.resource_category}:${m.period}`;
      if (!aggregates[key]) {
        aggregates[key] = {
          resource_category: m.resource_category,
          period: m.period,
          cohorts: new Set(),
          total: 0,
          org_count: 0
        };
      }
      aggregates[key].cohorts.add(m.cohort_hash);
      aggregates[key].total++;
    }
    const emitted = [];
    for (const [, agg] of Object.entries(aggregates)) {
      // k-anonymity: suppress if fewer than 5 distinct cohorts
      if (agg.cohorts.size < 5) continue;

      // Bucket total
      const total = agg.total;
      let totalBucket;
      if (total <= 10) totalBucket = '1-10';else if (total <= 50) totalBucket = '11-50';else if (total <= 100) totalBucket = '51-100';else if (total <= 500) totalBucket = '101-500';else totalBucket = '500+';
      const aggregate = {
        resource_category: agg.resource_category,
        total_bucket: totalBucket,
        period: agg.period,
        org_count: agg.org_count,
        type: 'resource',
        ts: Date.now()
      };
      await svc.sendEvent(networkMetricsRoomId, EVT.METRIC_AGG, aggregate);
      emitted.push(aggregate);
    }
    return emitted;
  },
  /* ═══ Seed Data Loader ═══ */

  /**
   * Load default resource types into a network room.
   * All seed types are created as draft maturity, optional propagation.
   */
  // INS(resources.seed_types[], {source: DEFAULT_RESOURCE_TYPES}) — initial_catalog — batch DES for each type
  async loadSeedResourceTypes(networkRoomId) {
    const loaded = [];
    for (const seed of DEFAULT_RESOURCE_TYPES) {
      try {
        const existing = await svc.getState(networkRoomId, EVT.RESOURCE_TYPE, seed.id);
        if (existing) continue; // Already loaded

        const typeData = {
          ...seed,
          source: buildResourceSource('network', 'optional', null, svc.userId),
          maturity: 'draft',
          constraints: null
        };
        const created = await this.createResourceType(networkRoomId, typeData, 'network');
        loaded.push(created);
      } catch (e) {
        console.error(`[ResourceService] Failed to load seed type ${seed.id}:`, e.message);
      }
    }
    return loaded;
  }
};

/* ═══════════════════ CLIENT DATA IMPORT ENGINE ═══════════════════
 * Operator Manifest (per-record pipeline):
 *   INS(crypto.encryption_key, {via: crypto.subtle}) — per_record_isolation
 *   ALT(import.fields, {transform: ciphertext, key: per_record_key}) — field_encryption
 *   SEG(import.demographics, {rules: transform_rules}) — anonymization
 *   INS(import.client_record_room, {identity, record_state}) — room_creation
 *   SYN(import.record+anon_demographics, {via: cohort_hash}) — metric_emission
 *   INS(import.manifest, {batch_metadata}) — audit_trail
 *
 * Triad Summary:
 *   Existence:       INS (keys, rooms, manifest)
 *   Structure:       SEG (anonymization bucketing)
 *   Interpretation:  ALT (encryption)
 *   No REC, no SUP — batch pipeline, same pattern per record. Frame is stable.
 *
 * Parses CSV/JSON files, maps columns to vault fields, encrypts each
 * record with its own AES-256-GCM key, creates a client_record room
 * per row, and emits only anonymized demographic metrics.
 *
 * PII GUARANTEE: Reports only ever contain demographic ranges
 * (age buckets, area hashes, counts). Raw PII (names, DOBs, SSNs,
 * addresses, emails, phones) are either blocked or bucketed before
 * any metric is emitted. The per-record encryption key is stored in
 * the E2EE room state — only room members can access it.
 * ═══════════════════════════════════════════════════════════════════ */

// ── CSV Parser ──
// Handles quoted fields, embedded commas, and multi-line values.
function parseCSV(text) {
  const lines = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') {
      inQuotes = !inQuotes;
      current += ch;
    } else if (ch === '\n' && !inQuotes) {
      lines.push(current);
      current = '';
    } else if (ch === '\r' && !inQuotes) {/* skip CR */} else {
      current += ch;
    }
  }
  if (current.trim()) lines.push(current);
  if (lines.length < 2) throw new Error('CSV must have a header row and at least one data row');
  function parseLine(line) {
    const fields = [];
    let field = '';
    let q = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (q && line[i + 1] === '"') {
          field += '"';
          i++;
        } else {
          q = !q;
        }
      } else if (ch === ',' && !q) {
        fields.push(field.trim());
        field = '';
      } else {
        field += ch;
      }
    }
    fields.push(field.trim());
    return fields;
  }
  const headers = parseLine(lines[0]);
  const records = [];
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const vals = parseLine(lines[i]);
    const record = {};
    headers.forEach((h, j) => {
      if (vals[j] !== undefined && vals[j] !== '') record[h] = vals[j];
    });
    records.push(record);
  }
  return {
    headers,
    records
  };
}

// ── JSON Parser ──
// Accepts an array of objects or { records: [...] } / { data: [...] }
function parseJSONImport(text) {
  const data = JSON.parse(text);
  const records = Array.isArray(data) ? data : data.records || data.data || [];
  if (!Array.isArray(records) || records.length === 0) throw new Error('JSON must contain an array of record objects');
  const headers = [...new Set(records.flatMap(r => Object.keys(r)))];
  return {
    headers,
    records
  };
}

// ── Column auto-mapping ──
// Maps common CSV/JSON header names to VAULT_FIELDS keys.
const IMPORT_COLUMN_ALIASES = {
  'name': 'full_name',
  'full_name': 'full_name',
  'fullname': 'full_name',
  'client_name': 'full_name',
  'client name': 'full_name',
  'first_name': '_first_name',
  'last_name': '_last_name',
  'firstname': '_first_name',
  'lastname': '_last_name',
  'dob': 'dob',
  'date_of_birth': 'dob',
  'birthdate': 'dob',
  'birth_date': 'dob',
  'birthday': 'dob',
  'date of birth': 'dob',
  'ssn': 'id_number',
  'id': 'id_number',
  'id_number': 'id_number',
  'social_security': 'id_number',
  'social': 'id_number',
  'email': 'email',
  'email_address': 'email',
  'e-mail': 'email',
  'phone': 'phone',
  'phone_number': 'phone',
  'mobile': 'phone',
  'telephone': 'phone',
  'cell': 'phone',
  'address': 'address',
  'street_address': 'address',
  'home_address': 'address',
  'street': 'address',
  'mailing_address': 'address',
  'organization': 'affiliation',
  'affiliation': 'affiliation',
  'org': 'affiliation',
  'agency': 'affiliation',
  'employer': 'affiliation',
  'notes': 'case_notes',
  'case_notes': 'case_notes',
  'comments': 'case_notes',
  'case notes': 'case_notes',
  'history': 'history',
  'case_history': 'history',
  'case history': 'history'
};
function autoMapColumns(sourceHeaders) {
  const mapping = {};
  for (const h of sourceHeaders) {
    const normalized = h.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
    const alias = IMPORT_COLUMN_ALIASES[normalized] || IMPORT_COLUMN_ALIASES[h.toLowerCase().trim()];
    if (alias && !alias.startsWith('_')) mapping[h] = alias;
  }
  return mapping;
}

// ── Per-record encryption + room creation ──
// Pipeline per row: INS(crypto.key, {}) → ALT(import.fields, {encrypt}) → SEG(import.demographics, {anonymize}) → INS(import.room, {}) → SYN(import.metric, {})
// Creates one client_record room per row. Each record gets a unique
// AES-256-GCM key. Only anonymized demographics are emitted as metrics.
async function importClientRecords(records, mapping, metricsRoom, onProgress) {
  const results = {
    created: [],
    errors: [],
    demographics: {},
    totalFields: 0
  };
  const batchId = `batch_${Date.now().toString(36)}${Math.random().toString(36).slice(2, 6)}`;
  const total = records.length;

  // Check for first_name + last_name concatenation
  const firstNameCol = Object.entries(mapping).find(([, v]) => v === '_first_name')?.[0];
  const lastNameCol = Object.entries(mapping).find(([, v]) => v === '_last_name')?.[0];
  for (let i = 0; i < total; i++) {
    try {
      const row = records[i];

      // Map source fields to vault fields
      const fields = {};
      for (const [sourceCol, vaultKey] of Object.entries(mapping)) {
        if (vaultKey.startsWith('_')) continue; // skip internal markers
        if (vaultKey && row[sourceCol] != null && String(row[sourceCol]).trim() !== '') {
          fields[vaultKey] = String(row[sourceCol]).trim();
        }
      }

      // Concatenate first + last name if mapped separately
      if (firstNameCol && lastNameCol) {
        const first = (row[firstNameCol] || '').trim();
        const last = (row[lastNameCol] || '').trim();
        if (first || last) fields['full_name'] = [first, last].filter(Boolean).join(' ');
      }
      if (Object.keys(fields).length === 0) {
        results.errors.push({
          row: i + 1,
          error: 'No mapped fields with values'
        });
        onProgress({
          current: i + 1,
          total
        });
        continue;
      }

      // Generate unique per-record AES-256-GCM key
      const recordKey = await FieldCrypto.generateKey();

      // Encrypt each field value individually
      const encryptedFields = {};
      for (const [key, value] of Object.entries(fields)) {
        const {
          ciphertext,
          iv
        } = await FieldCrypto.encrypt(value, recordKey);
        encryptedFields[key] = {
          ciphertext,
          iv
        };
      }

      // Generate anonymized demographics — this is the ONLY data that
      // ever appears in reports. Raw PII is blocked or bucketed.
      const anonDemo = {};
      for (const [key, value] of Object.entries(fields)) {
        const anon = anonymizeField(key, value);
        if (anon) anonDemo[anon.key] = anon.value;
      }

      // Non-PII label for room name (never store raw name in room metadata)
      const recordLabel = `Import ${batchId.slice(-4)} #${i + 1}`;

      // Create the client_record room with encrypted data
      const roomId = await svc.createRoom(`[Client] ${recordLabel}`, 'Imported client record — encrypted at rest', [{
        type: EVT.IDENTITY,
        state_key: '',
        content: {
          account_type: 'client_record',
          owner: svc.userId,
          created: Date.now(),
          imported: true,
          import_batch: batchId,
          import_index: i,
          client_name: recordLabel,
          status: 'created'
        }
      }, {
        type: EVT.CLIENT_RECORD,
        state_key: '',
        content: {
          record_key: recordKey,
          encrypted_fields: encryptedFields,
          demographics: anonDemo,
          imported_at: Date.now(),
          field_count: Object.keys(fields).length,
          import_batch: batchId
        }
      }]);

      // Emit anonymized metric — NEVER contains PII
      if (metricsRoom) {
        const hash = await cohortHash(`import_${roomId}_${batchId}`);
        await svc.sendEvent(metricsRoom, EVT.METRIC, {
          cohort_hash: hash,
          observation: {
            category: 'intake',
            value: 'imported',
            date_bucket: new Date().toISOString().slice(0, 7)
          },
          demographics: anonDemo,
          program: 'import',
          ts: Date.now()
        });
      }

      // Accumulate demographic summary (anonymized only)
      for (const [k, v] of Object.entries(anonDemo)) {
        if (!results.demographics[k]) results.demographics[k] = {};
        results.demographics[k][v] = (results.demographics[k][v] || 0) + 1;
      }
      results.created.push({
        roomId,
        displayName: recordLabel,
        fieldCount: Object.keys(fields).length
      });
      results.totalFields += Object.keys(fields).length;
      onProgress({
        current: i + 1,
        total
      });

      // Rate-limit: pause every 2 records to avoid homeserver rate limits
      if (i % 2 === 1) await new Promise(r => setTimeout(r, 400));
    } catch (e) {
      results.errors.push({
        row: i + 1,
        error: e.message
      });
      onProgress({
        current: i + 1,
        total
      });
    }
  }

  // Emit import manifest to metrics room (aggregate only, no PII)
  if (metricsRoom) {
    try {
      await svc.sendEvent(metricsRoom, EVT.IMPORT_MANIFEST, {
        batch_id: batchId,
        total_records: total,
        successful: results.created.length,
        failed: results.errors.length,
        demographics_summary: results.demographics,
        ts: Date.now()
      });
    } catch {}
  }
  return results;
}

// ── PII masking for preview display ──
// Shows first/last char with dots in between. Sensitive fields fully masked.
function maskPII(key, value) {
  if (!value || typeof value !== 'string') return '—';
  const t = DEFAULT_TRANSFORMS[key];
  if (t?.method === 'block') return '\u25CF\u25CF\u25CF\u25CF\u25CF\u25CF';
  if (t?.method === 'age_range') {
    const anon = anonymizeField(key, value);
    return anon ? `[${anon.value}]` : '\u25CF\u25CF\u25CF\u25CF';
  }
  if (t?.method === 'area_hash') {
    const anon = anonymizeField(key, value);
    return anon ? `[${anon.value}]` : '\u25CF\u25CF\u25CF\u25CF';
  }
  // Non-sensitive fields: show as-is
  const vf = VAULT_FIELDS.find(f => f.key === key);
  if (vf?.sensitive) return value.length > 2 ? value[0] + '\u25CF'.repeat(Math.min(value.length - 2, 6)) + value[value.length - 1] : '\u25CF\u25CF';
  return value;
}

/* ═══════════════════ IMPORT DATA MODAL ═══════════════════ */
const ImportDataModal = ({
  open,
  onClose,
  showToast,
  metricsRoom,
  onComplete
}) => {
  const [step, setStep] = useState('upload');
  const [fileData, setFileData] = useState(null);
  const [mapping, setMapping] = useState({});
  const [progress, setProgress] = useState({
    current: 0,
    total: 0
  });
  const [results, setResults] = useState(null);
  const [dragOver, setDragOver] = useState(false);
  const fileRef = useRef(null);

  // Reset state when modal closes
  useEffect(() => {
    if (!open) {
      setStep('upload');
      setFileData(null);
      setMapping({});
      setProgress({
        current: 0,
        total: 0
      });
      setResults(null);
    }
  }, [open]);
  const handleFile = async file => {
    try {
      const text = await file.text();
      const isJSON = file.name.endsWith('.json') || file.type === 'application/json';
      const parsed = isJSON ? parseJSONImport(text) : parseCSV(text);
      if (parsed.records.length === 0) throw new Error('No records found in file');
      setFileData({
        ...parsed,
        fileName: file.name,
        fileType: isJSON ? 'JSON' : 'CSV'
      });
      // Auto-map columns
      const autoMap = autoMapColumns(parsed.headers);
      setMapping(autoMap);
      setStep('map');
    } catch (e) {
      showToast('Parse error: ' + e.message, 'error');
    }
  };
  const handleDrop = e => {
    e.preventDefault();
    setDragOver(false);
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  };
  const mappedFieldCount = Object.values(mapping).filter(v => v && !v.startsWith('_')).length;
  const hasMappedFields = mappedFieldCount > 0;

  // Count how many columns map to each vault field (detect duplicates)
  const vaultFieldUsage = {};
  for (const v of Object.values(mapping)) {
    if (v && !v.startsWith('_')) vaultFieldUsage[v] = (vaultFieldUsage[v] || 0) + 1;
  }
  const handleImport = async () => {
    if (!fileData || !hasMappedFields) return;
    setStep('importing');
    setProgress({
      current: 0,
      total: fileData.records.length
    });
    try {
      const res = await importClientRecords(fileData.records, mapping, metricsRoom, p => setProgress(p));
      setResults(res);
      setStep('done');
      if (onComplete) onComplete(res);
    } catch (e) {
      showToast('Import failed: ' + e.message, 'error');
      setStep('preview');
    }
  };
  if (!open) return null;
  return /*#__PURE__*/React.createElement(Modal, {
    open: open,
    onClose: step === 'importing' ? undefined : onClose,
    title: "Import Client Data",
    w: 720
  }, step === 'upload' && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Upload a CSV or JSON file containing client records. Each row becomes an encrypted client room with its own AES-256-GCM key. PII is never stored in any reportable format."), /*#__PURE__*/React.createElement("div", {
    onDragOver: e => {
      e.preventDefault();
      setDragOver(true);
    },
    onDragLeave: () => setDragOver(false),
    onDrop: handleDrop,
    onClick: () => fileRef.current?.click(),
    style: {
      border: `2px dashed ${dragOver ? 'var(--gold)' : 'var(--border-1)'}`,
      borderRadius: 'var(--r-lg)',
      padding: '48px 24px',
      textAlign: 'center',
      cursor: 'pointer',
      transition: 'all .2s',
      background: dragOver ? 'var(--gold-dim)' : 'var(--bg-1)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 48,
      height: 48,
      borderRadius: 'var(--r-lg)',
      background: 'var(--gold-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--gold)',
      margin: '0 auto 14px'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "upload",
    s: 24
  })), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 14,
      fontWeight: 600,
      marginBottom: 4
    }
  }, "Drop CSV or JSON file here"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-2)'
    }
  }, "or click to browse"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6,
      justifyContent: 'center',
      marginTop: 12
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tag tag-blue"
  }, ".csv"), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-teal"
  }, ".json"))), /*#__PURE__*/React.createElement("input", {
    ref: fileRef,
    type: "file",
    accept: ".csv,.json,application/json,text/csv",
    style: {
      display: 'none'
    },
    onChange: e => {
      if (e.target.files[0]) handleFile(e.target.files[0]);
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '12px 16px',
      marginTop: 16,
      display: 'flex',
      gap: 10,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 16,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--teal)'
    }
  }, "Encryption guarantee:"), " Each record gets a unique AES-256-GCM encryption key. PII fields (name, DOB, SSN, address, phone, email) are encrypted before storage. Reports only contain demographic ranges \u2014 never raw PII."))), step === 'map' && fileData && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12.5,
      fontWeight: 600
    }
  }, fileData.fileName), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, fileData.fileType, " \xB7 ", fileData.records.length, " records \xB7 ", fileData.headers.length, " columns")), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setStep('upload');
      setFileData(null);
      setMapping({});
    },
    className: "b-gho b-xs"
  }, "Change File")), /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "MAP COLUMNS TO VAULT FIELDS"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginBottom: 10
    }
  }, "Assign each source column to a vault field. Unmapped columns are skipped. Fields marked with a lock are encrypted at rest."), /*#__PURE__*/React.createElement("div", {
    style: {
      maxHeight: 340,
      overflow: 'auto',
      marginBottom: 16
    }
  }, fileData.headers.map(h => {
    const currentMapping = mapping[h] || '';
    const vf = VAULT_FIELDS.find(f => f.key === currentMapping);
    const transform = DEFAULT_TRANSFORMS[currentMapping];
    const sampleVal = fileData.records.slice(0, 3).map(r => r[h]).filter(Boolean)[0];
    return /*#__PURE__*/React.createElement("div", {
      key: h,
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 10,
        padding: '8px 0',
        borderBottom: '1px solid var(--border-0)'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        minWidth: 0
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        fontWeight: 500,
        display: 'block'
      }
    }, h), sampleVal && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)',
        display: 'block',
        marginTop: 2,
        overflow: 'hidden',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap'
      }
    }, "e.g. ", String(sampleVal).slice(0, 40), String(sampleVal).length > 40 ? '…' : '')), /*#__PURE__*/React.createElement(I, {
      n: "chevR",
      s: 12,
      c: "var(--tx-3)"
    }), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        minWidth: 0
      }
    }, /*#__PURE__*/React.createElement("select", {
      value: currentMapping,
      onChange: e => setMapping(prev => ({
        ...prev,
        [h]: e.target.value
      })),
      style: {
        width: '100%',
        fontSize: 12,
        padding: '7px 10px'
      }
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "\u2014 skip \u2014"), VAULT_FIELDS.map(f => /*#__PURE__*/React.createElement("option", {
      key: f.key,
      value: f.key
    }, f.label, f.sensitive ? ' 🔒' : '', transform?.method === 'block' ? ' (blocked in reports)' : '')), /*#__PURE__*/React.createElement("option", {
      value: "_first_name"
    }, "First Name (will combine)"), /*#__PURE__*/React.createElement("option", {
      value: "_last_name"
    }, "Last Name (will combine)"))), /*#__PURE__*/React.createElement("div", {
      style: {
        width: 60,
        textAlign: 'center'
      }
    }, currentMapping && !currentMapping.startsWith('_') && transform?.method === 'block' && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-red",
      style: {
        fontSize: 8
      }
    }, "BLOCKED"), currentMapping && !currentMapping.startsWith('_') && transform?.method === 'age_range' && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-blue",
      style: {
        fontSize: 8
      }
    }, "RANGED"), currentMapping && !currentMapping.startsWith('_') && vf?.sensitive && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-green",
      style: {
        fontSize: 8
      }
    }, "ENCRYPT"), currentMapping && !currentMapping.startsWith('_') && !transform && !vf?.sensitive && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-teal",
      style: {
        fontSize: 8
      }
    }, "STORED")));
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 8,
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 12
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "MAPPED"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      color: 'var(--gold)'
    }
  }, mappedFieldCount), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, " of ", fileData.headers.length, " columns")), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 12
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "REPORT VISIBILITY"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 3,
      flexWrap: 'wrap',
      marginTop: 4
    }
  }, Object.values(mapping).filter(v => v && !v.startsWith('_')).map(v => {
    const t = DEFAULT_TRANSFORMS[v];
    const vf = VAULT_FIELDS.find(f => f.key === v);
    return /*#__PURE__*/React.createElement("span", {
      key: v,
      className: `tag ${t?.method === 'block' ? 'tag-red' : t?.method === 'age_range' ? 'tag-blue' : 'tag-teal'}`,
      style: {
        fontSize: 8
      }
    }, vf?.label || v, ": ", t?.method === 'block' ? 'NEVER' : t?.method === 'age_range' ? 'RANGE ONLY' : 'visible');
  })))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setStep('upload'),
    className: "b-gho",
    style: {
      flex: 1
    }
  }, "Back"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setStep('preview'),
    className: "b-pri",
    disabled: !hasMappedFields,
    style: {
      flex: 2
    }
  }, "Preview ", fileData.records.length, " Records"))), step === 'preview' && fileData && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Review how records will be stored. PII fields are masked below as they will be in reports. The actual data is encrypted per-record and only accessible to room members."), /*#__PURE__*/React.createElement("div", {
    style: {
      overflowX: 'auto',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("table", {
    style: {
      width: '100%',
      borderCollapse: 'collapse',
      fontSize: 11.5
    }
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    style: {
      borderBottom: '2px solid var(--border-1)'
    }
  }, /*#__PURE__*/React.createElement("th", {
    style: {
      padding: '8px 10px',
      textAlign: 'left',
      fontFamily: 'var(--mono)',
      fontSize: 10,
      color: 'var(--tx-2)',
      letterSpacing: '.05em'
    }
  }, "#"), Object.entries(mapping).filter(([, v]) => v && !v.startsWith('_')).map(([src, vk]) => {
    const vf = VAULT_FIELDS.find(f => f.key === vk);
    const t = DEFAULT_TRANSFORMS[vk];
    return /*#__PURE__*/React.createElement("th", {
      key: src,
      style: {
        padding: '8px 10px',
        textAlign: 'left',
        whiteSpace: 'nowrap'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        fontFamily: 'var(--mono)',
        color: 'var(--tx-2)',
        letterSpacing: '.05em'
      }
    }, vf?.label || vk), t?.method === 'block' && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-red",
      style: {
        fontSize: 7,
        marginLeft: 4
      }
    }, "BLOCKED"), vf?.sensitive && !t && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-green",
      style: {
        fontSize: 7,
        marginLeft: 4
      }
    }, "ENC"));
  }), /*#__PURE__*/React.createElement("th", {
    style: {
      padding: '8px 10px',
      textAlign: 'left',
      fontFamily: 'var(--mono)',
      fontSize: 10,
      color: 'var(--tx-2)'
    }
  }, "DEMOGRAPHICS"))), /*#__PURE__*/React.createElement("tbody", null, fileData.records.slice(0, 5).map((row, i) => {
    // Build mapped fields for this row
    const fields = {};
    for (const [src, vk] of Object.entries(mapping)) {
      if (vk && !vk.startsWith('_') && row[src] != null) fields[vk] = String(row[src]);
    }
    // Handle first+last name
    const fnCol = Object.entries(mapping).find(([, v]) => v === '_first_name')?.[0];
    const lnCol = Object.entries(mapping).find(([, v]) => v === '_last_name')?.[0];
    if (fnCol && lnCol) {
      const combined = [(row[fnCol] || '').trim(), (row[lnCol] || '').trim()].filter(Boolean).join(' ');
      if (combined) fields['full_name'] = combined;
    }
    // Anonymize for demographic preview
    const anonDemo = {};
    for (const [k, v] of Object.entries(fields)) {
      const anon = anonymizeField(k, v);
      if (anon) anonDemo[anon.key] = anon.value;
    }
    return /*#__PURE__*/React.createElement("tr", {
      key: i,
      style: {
        borderBottom: '1px solid var(--border-0)'
      }
    }, /*#__PURE__*/React.createElement("td", {
      style: {
        padding: '6px 10px',
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)',
        fontSize: 10
      }
    }, i + 1), Object.entries(mapping).filter(([, v]) => v && !v.startsWith('_')).map(([src, vk]) => {
      const val = vk === 'full_name' && fields['full_name'] ? fields['full_name'] : row[src];
      return /*#__PURE__*/React.createElement("td", {
        key: src,
        style: {
          padding: '6px 10px',
          fontSize: 11,
          maxWidth: 160,
          overflow: 'hidden',
          textOverflow: 'ellipsis',
          whiteSpace: 'nowrap'
        }
      }, maskPII(vk, val ? String(val) : ''));
    }), /*#__PURE__*/React.createElement("td", {
      style: {
        padding: '6px 10px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 3,
        flexWrap: 'wrap'
      }
    }, Object.entries(anonDemo).map(([k, v]) => /*#__PURE__*/React.createElement("span", {
      key: k,
      className: "tag tag-blue",
      style: {
        fontSize: 8
      }
    }, k, ": ", v || '—')), Object.keys(anonDemo).length === 0 && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-3)'
      }
    }, "\u2014"))));
  }))), fileData.records.length > 5 && /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-3)',
      textAlign: 'center',
      padding: 8
    }
  }, "\u2026and ", fileData.records.length - 5, " more records")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr 1fr',
      gap: 8,
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 10,
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "RECORDS"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      display: 'block'
    }
  }, fileData.records.length)), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 10,
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ENCRYPTED FIELDS"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      color: 'var(--green)',
      display: 'block'
    }
  }, mappedFieldCount)), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 10,
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ROOMS TO CREATE"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      color: 'var(--gold)',
      display: 'block'
    }
  }, fileData.records.length))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--red-dim)',
      border: '1px solid rgba(232,93,93,.15)',
      borderRadius: 'var(--r)',
      padding: '12px 16px',
      marginBottom: 16,
      display: 'flex',
      gap: 10,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "eyeOff",
    s: 16,
    c: "var(--red)"
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--red)'
    }
  }, "PII will NEVER appear in reports."), " Names, DOBs, SSNs, addresses, phones, and emails are either blocked entirely or converted to demographic ranges (age buckets, area hashes). Only anonymized aggregates flow to the metrics system.")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setStep('map'),
    className: "b-gho",
    style: {
      flex: 1
    }
  }, "Back"), /*#__PURE__*/React.createElement("button", {
    onClick: handleImport,
    className: "b-pri",
    style: {
      flex: 2,
      padding: 12,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 15
  }), " Encrypt & Import ", fileData.records.length, " Records"))), step === 'importing' && /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '20px 0'
    }
  }, /*#__PURE__*/React.createElement(Spin, {
    s: 32
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 15,
      fontWeight: 600,
      marginTop: 16
    }
  }, "Encrypting & creating rooms..."), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-2)',
      marginTop: 6
    }
  }, "Record ", progress.current, " of ", progress.total), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--bg-3)',
      borderRadius: 8,
      height: 8,
      overflow: 'hidden',
      marginTop: 16,
      maxWidth: 400,
      margin: '16px auto 0'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      height: '100%',
      background: 'var(--gold)',
      borderRadius: 8,
      transition: 'width .3s',
      width: `${progress.total ? progress.current / progress.total * 100 : 0}%`
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 12,
      justifyContent: 'center',
      marginTop: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 12,
    c: "var(--green)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, "AES-256-GCM per record")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 12,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, "E2EE rooms")))), step === 'done' && results && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 48,
      height: 48,
      borderRadius: '50%',
      background: 'var(--green-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--green)',
      margin: '0 auto 12px'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "check",
    s: 24
  })), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 18,
      fontWeight: 700
    }
  }, "Import Complete"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-2)',
      marginTop: 4
    }
  }, results.created.length, " records encrypted & stored \xB7 ", results.errors.length, " errors")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr 1fr',
      gap: 8,
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 10,
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "IMPORTED"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 20,
      fontWeight: 700,
      color: 'var(--green)',
      display: 'block'
    }
  }, results.created.length)), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 10,
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ENCRYPTED FIELDS"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 20,
      fontWeight: 700,
      color: 'var(--gold)',
      display: 'block'
    }
  }, results.totalFields)), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 10,
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ERRORS"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 20,
      fontWeight: 700,
      color: results.errors.length ? 'var(--red)' : 'var(--tx-2)',
      display: 'block'
    }
  }, results.errors.length))), Object.keys(results.demographics).length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0
    }
  }, "DEMOGRAPHIC SUMMARY (ANONYMIZED)"), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-teal",
    style: {
      fontSize: 8
    }
  }, "REPORT-SAFE")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginBottom: 10
    }
  }, "This is the only data available for reporting. No PII is present \u2014 only demographic ranges and hashed areas."), Object.entries(results.demographics).map(([category, values]) => /*#__PURE__*/React.createElement("div", {
    key: category,
    style: {
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontWeight: 600,
      color: 'var(--tx-1)',
      textTransform: 'uppercase',
      fontFamily: 'var(--mono)',
      letterSpacing: '.05em',
      display: 'block',
      marginBottom: 4
    }
  }, category), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 3
    }
  }, Object.entries(values).sort((a, b) => b[1] - a[1]).map(([val, count]) => {
    const max = Math.max(...Object.values(values));
    return /*#__PURE__*/React.createElement("div", {
      key: val,
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11,
        width: 140,
        overflow: 'hidden',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap',
        color: 'var(--tx-1)'
      }
    }, val || '—'), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        height: 14,
        background: 'var(--bg-3)',
        borderRadius: 3,
        overflow: 'hidden'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        width: `${count / max * 100}%`,
        height: '100%',
        background: 'var(--teal)',
        borderRadius: 3,
        transition: 'width .3s'
      }
    })), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        fontFamily: 'var(--mono)',
        color: 'var(--tx-1)',
        minWidth: 24,
        textAlign: 'right'
      }
    }, count));
  }))))), results.errors.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ERRORS"), /*#__PURE__*/React.createElement("div", {
    style: {
      maxHeight: 120,
      overflow: 'auto',
      marginTop: 4
    }
  }, results.errors.map((e, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    style: {
      fontSize: 11,
      color: 'var(--red)',
      padding: '4px 0',
      borderBottom: '1px solid var(--border-0)'
    }
  }, "Row ", e.row, ": ", e.error)))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--green-dim)',
      border: '1px solid rgba(61,214,140,.15)',
      borderRadius: 'var(--r)',
      padding: '12px 16px',
      marginBottom: 16,
      display: 'flex',
      gap: 10,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 16,
    c: "var(--green)"
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--green)'
    }
  }, "No PII in reports."), " All ", results.created.length, " records are individually encrypted with unique AES-256-GCM keys. The demographic summary above shows only anonymized ranges \u2014 this is the maximum granularity available for any report. Names, dates of birth, SSNs, addresses, phones, and emails are cryptographically blocked from reporting.")), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "b-pri",
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "check",
    s: 15
  }), " Done \u2014 View Clients")));
};

/* ═══════════════════ DATABASE MERGE SERVICE (Auditable SYN) ═══════════════════
 * Operator Manifest:
 *   SYN(merge.fields.{key}, {source_a, source_b, resolved_value, effective_date}) — field_synchronization
 *   DES(merge.record, {sources, strategy, effective_date}) — merge_designation
 *   CON(merge.audit, {merge_id, sources, field_resolutions}) — audit_linkage
 *   ALT(merge.target.{key}, {from, to, merge_id}) — target_record_update
 *   NUL(merge.source, {reason: merged_into, target}) — source_deprecation
 *
 * Triad Summary:
 *   Existence:       DES (merge record creation), NUL (source deprecation)
 *   Structure:       SYN (field synchronization), CON (audit linkage)
 *   Interpretation:  ALT (target value updates)
 *
 * The merge act is a SYN operation that takes place at a specific effective date.
 * Every field resolution is individually traced through the EO operation chain,
 * producing a complete audit trail of what was merged, from where, and why.
 * ═══════════════════════════════════════════════════════════════════════════════ */

const MERGE_STRATEGIES = {
  manual: { id: 'manual', label: 'Manual Selection', desc: 'Pick the canonical value for each field' },
  newest: { id: 'newest', label: 'Newest Wins', desc: 'Use the most recently updated value for each field' },
  source_a: { id: 'source_a', label: 'Primary Source', desc: 'Prefer all values from the primary record' },
  source_b: { id: 'source_b', label: 'Secondary Source', desc: 'Prefer all values from the secondary record' }
};

const DatabaseMergeService = {
  /**
   * Compare two records and identify field-level conflicts.
   * Returns { fields: [{key, label, value_a, value_b, conflict, ts_a, ts_b}], summary }
   */
  compareRecords(recordA, recordB, fieldDefs) {
    const allKeys = new Set([
      ...Object.keys(recordA.fields || {}),
      ...Object.keys(recordB.fields || {})
    ]);
    const fields = [];
    let conflicts = 0;
    let matches = 0;
    let onlyA = 0;
    let onlyB = 0;

    for (const key of allKeys) {
      const valA = recordA.fields?.[key] ?? null;
      const valB = recordB.fields?.[key] ?? null;
      const tsA = recordA.timestamps?.[key] ?? recordA.ts ?? 0;
      const tsB = recordB.timestamps?.[key] ?? recordB.ts ?? 0;
      const vfDef = (fieldDefs || VAULT_FIELDS).find(f => f.key === key);
      const label = vfDef?.label || key;
      const hasA = valA !== null && valA !== '';
      const hasB = valB !== null && valB !== '';
      const conflict = hasA && hasB && valA !== valB;

      if (conflict) conflicts++;
      else if (hasA && hasB && valA === valB) matches++;
      else if (hasA && !hasB) onlyA++;
      else if (!hasA && hasB) onlyB++;

      fields.push({ key, label, value_a: valA, value_b: valB, conflict, ts_a: tsA, ts_b: tsB });
    }

    return {
      fields: fields.sort((a, b) => (b.conflict ? 1 : 0) - (a.conflict ? 1 : 0) || a.label.localeCompare(b.label)),
      summary: { total: allKeys.size, conflicts, matches, onlyA, onlyB }
    };
  },

  /**
   * Auto-resolve field values based on strategy.
   * Returns { [key]: { value, source } } — source is 'a', 'b', or 'manual'
   */
  autoResolve(comparison, strategy) {
    const resolutions = {};
    for (const field of comparison.fields) {
      const hasA = field.value_a !== null && field.value_a !== '';
      const hasB = field.value_b !== null && field.value_b !== '';

      if (!hasA && !hasB) {
        resolutions[field.key] = { value: null, source: 'none' };
      } else if (hasA && !hasB) {
        resolutions[field.key] = { value: field.value_a, source: 'a' };
      } else if (!hasA && hasB) {
        resolutions[field.key] = { value: field.value_b, source: 'b' };
      } else if (field.value_a === field.value_b) {
        resolutions[field.key] = { value: field.value_a, source: 'both' };
      } else {
        // Conflict — apply strategy
        switch (strategy) {
          case 'newest':
            resolutions[field.key] = field.ts_a >= field.ts_b
              ? { value: field.value_a, source: 'a' }
              : { value: field.value_b, source: 'b' };
            break;
          case 'source_a':
            resolutions[field.key] = { value: field.value_a, source: 'a' };
            break;
          case 'source_b':
            resolutions[field.key] = { value: field.value_b, source: 'b' };
            break;
          default: // manual — leave unresolved
            resolutions[field.key] = { value: null, source: 'unresolved' };
        }
      }
    }
    return resolutions;
  },

  /**
   * Execute the merge: emits SYN operations for each field, creates an audit
   * record, and updates the target record. The merge is anchored to an
   * effective_date — the date the synchronization is considered to have occurred.
   *
   * @param {string} targetRoomId  — room to write merged data into
   * @param {object} recordA       — { roomId, fields, name, ts }
   * @param {object} recordB       — { roomId, fields, name, ts }
   * @param {object} resolutions   — { [key]: { value, source } }
   * @param {string} effectiveDate — ISO date string (YYYY-MM-DD)
   * @param {string} strategy      — merge strategy used
   * @param {string} [frameType]   — 'org' or 'vault'
   * @returns {object} — { merge_id, ops_emitted, merged_fields }
   */
  async executeMerge(targetRoomId, recordA, recordB, resolutions, effectiveDate, strategy, frameType) {
    const mergeId = 'merge_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    const effective_ts = new Date(effectiveDate + 'T00:00:00Z').getTime();
    const ops = [];
    const mergedFields = {};
    const fieldResolutions = [];
    const frame = { type: frameType || 'org', room: targetRoomId, epistemic: 'MEANT' };

    // DES(merge.record, {sources, strategy, effective_date}) — merge_designation
    const desOp = await emitOp(targetRoomId, 'DES', dot('merge', 'record', mergeId), {
      designation: 'database_merge',
      merge_id: mergeId,
      source_a: { roomId: recordA.roomId, name: recordA.name },
      source_b: { roomId: recordB.roomId, name: recordB.name },
      strategy,
      effective_date: effectiveDate,
      effective_ts,
      field_count: Object.keys(resolutions).length
    }, frame);
    if (desOp) ops.push(desOp);

    // SYN each field resolution — the core auditable synchronization act
    for (const [key, resolution] of Object.entries(resolutions)) {
      if (resolution.source === 'none') continue;
      const valA = recordA.fields?.[key] ?? null;
      const valB = recordB.fields?.[key] ?? null;

      // SYN(merge.fields.{key}, {source_a, source_b, resolved, effective_date})
      const synOp = await emitOp(targetRoomId, 'SYN', dot('merge', 'fields', key), {
        merge_id: mergeId,
        source_a_value: valA,
        source_b_value: valB,
        resolved_value: resolution.value,
        resolved_source: resolution.source,
        effective_date: effectiveDate,
        effective_ts
      }, frame);
      if (synOp) ops.push(synOp);

      mergedFields[key] = resolution.value;
      fieldResolutions.push({
        key,
        from_a: valA,
        from_b: valB,
        resolved: resolution.value,
        source: resolution.source
      });
    }

    // ALT target record fields with merged values
    for (const [key, value] of Object.entries(mergedFields)) {
      if (value === null) continue;
      const currentVal = recordA.fields?.[key];
      if (currentVal !== value) {
        const altOp = await emitOp(targetRoomId, 'ALT', dot('merge', 'target', key), {
          from: currentVal ?? null,
          to: value,
          merge_id: mergeId,
          effective_date: effectiveDate
        }, frame);
        if (altOp) ops.push(altOp);
      }
    }

    // CON(merge.audit, {merge_id, full_resolution_chain}) — audit linkage
    const conOp = await emitOp(targetRoomId, 'CON', dot('merge', 'audit', mergeId), {
      merge_id: mergeId,
      sources: [recordA.roomId, recordB.roomId],
      target: targetRoomId,
      strategy,
      effective_date: effectiveDate,
      effective_ts,
      field_resolutions: fieldResolutions,
      ops_count: ops.length,
      completed_at: Date.now(),
      completed_by: svc.userId
    }, frame);
    if (conOp) ops.push(conOp);

    // Persist the merge audit record as state in the target room
    try {
      await svc.setState(targetRoomId, EVT.MERGE_AUDIT, {
        merge_id: mergeId,
        source_a: { roomId: recordA.roomId, name: recordA.name },
        source_b: { roomId: recordB.roomId, name: recordB.name },
        strategy,
        effective_date: effectiveDate,
        effective_ts,
        field_resolutions: fieldResolutions,
        completed_at: Date.now(),
        completed_by: svc.userId
      }, mergeId);
    } catch (e) {
      console.error('[DatabaseMerge] Failed to persist audit state:', e.message);
    }

    return { merge_id: mergeId, ops_emitted: ops.length, merged_fields: mergedFields, field_resolutions: fieldResolutions };
  },

  /**
   * Retrieve merge audit records from a room.
   */
  async getMergeHistory(roomId) {
    try {
      if (!svc.client) return [];
      const room = svc.client.getRoom(roomId);
      if (!room) return [];
      const events = room.currentState.getStateEvents(EVT.MERGE_AUDIT);
      if (!events) return [];
      const evts = Array.isArray(events) ? events : [events];
      return evts.map(e => e.getContent ? e.getContent() : e).filter(e => e.merge_id).sort((a, b) => (b.completed_at || 0) - (a.completed_at || 0));
    } catch (e) {
      console.error('[DatabaseMerge] getMergeHistory error:', e.message);
      return [];
    }
  }
};

/* ─── DatabaseMergeModal — auditable SYN-based record merge UI ─── */
const DatabaseMergeModal = ({ open, onClose, recordA, recordB, allRecords, targetRoomId, showToast, onComplete }) => {
  const [step, setStep] = useState('select');    // select | compare | resolve | confirm | done
  const [sourceA, setSourceA] = useState(null);
  const [sourceB, setSourceB] = useState(null);
  const [strategy, setStrategy] = useState('manual');
  const [effectiveDate, setEffectiveDate] = useState(() => new Date().toISOString().slice(0, 10));
  const [comparison, setComparison] = useState(null);
  const [resolutions, setResolutions] = useState({});
  const [saving, setSaving] = useState(false);
  const [result, setResult] = useState(null);

  // Reset on open
  React.useEffect(() => {
    if (open) {
      if (recordA && recordB) {
        setSourceA(recordA);
        setSourceB(recordB);
        setStep('compare');
      } else if (recordA) {
        setSourceA(recordA);
        setSourceB(null);
        setStep('select');
      } else {
        setSourceA(null);
        setSourceB(null);
        setStep('select');
      }
      setStrategy('manual');
      setEffectiveDate(new Date().toISOString().slice(0, 10));
      setComparison(null);
      setResolutions({});
      setResult(null);
    }
  }, [open, recordA, recordB]);

  // Run comparison when both sources are set
  React.useEffect(() => {
    if (sourceA && sourceB && step === 'compare') {
      const comp = DatabaseMergeService.compareRecords(sourceA, sourceB);
      setComparison(comp);
      setResolutions(DatabaseMergeService.autoResolve(comp, strategy));
    }
  }, [sourceA, sourceB, step, strategy]);

  const hasUnresolved = Object.values(resolutions).some(r => r.source === 'unresolved');

  const handleExecuteMerge = async () => {
    if (hasUnresolved) return;
    setSaving(true);
    try {
      const target = targetRoomId || sourceA.roomId;
      const res = await DatabaseMergeService.executeMerge(
        target, sourceA, sourceB, resolutions, effectiveDate, strategy
      );
      setResult(res);
      setStep('done');
      if (showToast) showToast(`Merge complete: ${res.ops_emitted} EO operations recorded`);
      if (onComplete) onComplete(res);
    } catch (e) {
      console.error('[DatabaseMerge] executeMerge failed:', e);
      if (showToast) showToast('Merge failed: ' + e.message);
    }
    setSaving(false);
  };

  if (!open) return null;

  const renderSelect = () => React.createElement('div', { className: 'cf-body' },
    React.createElement('div', { style: { fontSize: 12, color: 'var(--tx-2)', lineHeight: 1.6, marginBottom: 8 } },
      'Select two records to merge. The merge will synchronize their data fields and produce a full EO audit trail.'),
    React.createElement('div', { className: 'db-merge-sources' },
      // Source A
      React.createElement('div', { className: 'db-merge-source' + (sourceA ? ' primary' : '') },
        React.createElement('div', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginBottom: 4 } }, 'PRIMARY RECORD'),
        sourceA
          ? React.createElement('div', null,
              React.createElement('div', { style: { fontWeight: 600, fontSize: 13 } }, sourceA.name || 'Record A'),
              React.createElement('div', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginTop: 2 } },
                Object.keys(sourceA.fields || {}).length, ' fields'))
          : React.createElement('div', { style: { color: 'var(--tx-3)', fontSize: 12 } }, 'Select from list below')),
      // Source B
      React.createElement('div', { className: 'db-merge-source' },
        React.createElement('div', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginBottom: 4 } }, 'SECONDARY RECORD'),
        sourceB
          ? React.createElement('div', null,
              React.createElement('div', { style: { fontWeight: 600, fontSize: 13 } }, sourceB.name || 'Record B'),
              React.createElement('div', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginTop: 2 } },
                Object.keys(sourceB.fields || {}).length, ' fields'))
          : React.createElement('div', { style: { color: 'var(--tx-3)', fontSize: 12 } }, 'Select from list below'))
    ),
    (allRecords || []).length > 0 && React.createElement('div', { style: { maxHeight: 200, overflowY: 'auto', margin: '8px 0' } },
      (allRecords || []).filter(r => r.roomId !== sourceA?.roomId).map(r =>
        React.createElement('div', {
          key: r.roomId,
          onClick: () => !sourceA ? setSourceA(r) : setSourceB(r),
          className: 'cf-merge-card' + (r.roomId === sourceB?.roomId ? ' canonical' : ''),
          style: { marginBottom: 4 }
        },
          React.createElement('input', { type: 'radio', checked: r.roomId === sourceB?.roomId, readOnly: true, style: { accentColor: 'var(--purple)' } }),
          React.createElement('div', { style: { flex: 1 } },
            React.createElement('div', { style: { fontWeight: 600, fontSize: 13 } }, r.name || r.client_name || 'Record'),
            React.createElement('div', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginTop: 2 } },
              Object.keys(r.fields || {}).length, ' fields')))))
  );

  const renderCompare = () => {
    if (!comparison) return React.createElement(Spin, null);
    return React.createElement('div', { className: 'cf-body' },
      // Summary badges
      React.createElement('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap', marginBottom: 8 } },
        React.createElement('span', { className: 'tag tag-purple' }, comparison.summary.total, ' fields'),
        comparison.summary.conflicts > 0 && React.createElement('span', { className: 'tag tag-red' }, comparison.summary.conflicts, ' conflicts'),
        React.createElement('span', { className: 'tag tag-green' }, comparison.summary.matches, ' matching'),
        comparison.summary.onlyA > 0 && React.createElement('span', { className: 'tag tag-blue' }, comparison.summary.onlyA, ' only in A'),
        comparison.summary.onlyB > 0 && React.createElement('span', { className: 'tag tag-orange' }, comparison.summary.onlyB, ' only in B')),
      // Strategy selector
      React.createElement('div', { style: { marginBottom: 10 } },
        React.createElement('span', { className: 'cf-label' }, 'MERGE STRATEGY'),
        React.createElement('div', { style: { display: 'flex', gap: 6, marginTop: 4, flexWrap: 'wrap' } },
          Object.values(MERGE_STRATEGIES).map(s =>
            React.createElement('button', {
              key: s.id,
              className: strategy === s.id ? 'b-pri b-xs' : 'b-gho b-xs',
              onClick: () => setStrategy(s.id),
              title: s.desc
            }, s.label)))),
      // Effective date
      React.createElement('div', { className: 'db-merge-date-pick' },
        React.createElement('span', { style: { fontSize: 11, fontWeight: 600, color: 'var(--tx-2)' } }, 'EFFECTIVE DATE'),
        React.createElement('input', {
          type: 'date',
          value: effectiveDate,
          onChange: e => setEffectiveDate(e.target.value)
        }),
        React.createElement('span', { className: 'db-merge-syn-badge' }, 'SYN @ ', effectiveDate)),
      // Field comparison table
      React.createElement('div', { style: { maxHeight: 340, overflowY: 'auto' } },
        React.createElement('div', { style: { display: 'flex', gap: 0, marginBottom: 4, padding: '0 0 4px' } },
          React.createElement('div', { style: { width: 120, minWidth: 120, fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)' } }, 'FIELD'),
          React.createElement('div', { style: { flex: 1, fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--purple)' } }, sourceA?.name || 'Source A'),
          React.createElement('div', { style: { flex: 1, fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--teal)' } }, sourceB?.name || 'Source B')),
        comparison.fields.map(f => {
          const res = resolutions[f.key];
          return React.createElement('div', { key: f.key, className: 'db-merge-field-row' },
            React.createElement('div', { className: 'db-merge-field-label' },
              f.label,
              f.conflict && React.createElement('span', { style: { color: 'var(--red)', fontSize: 9, marginLeft: 4 } }, '\u26A0')),
            React.createElement('div', {
              className: 'db-merge-field-val' + (res?.source === 'a' || res?.source === 'both' ? ' selected' : '') + (f.conflict ? ' conflict' : ''),
              onClick: () => f.conflict && setResolutions(prev => ({ ...prev, [f.key]: { value: f.value_a, source: 'a' } }))
            },
              f.value_a !== null && f.value_a !== '' ? String(f.value_a) : React.createElement('span', { style: { color: 'var(--tx-3)', fontStyle: 'italic' } }, '\u2014'),
              res?.source === 'a' && React.createElement('span', { className: 'db-merge-syn-badge', style: { fontSize: 8, padding: '1px 5px' } }, '\u2713')),
            React.createElement('div', {
              className: 'db-merge-field-val' + (res?.source === 'b' ? ' selected' : '') + (f.conflict ? ' conflict' : ''),
              onClick: () => f.conflict && setResolutions(prev => ({ ...prev, [f.key]: { value: f.value_b, source: 'b' } }))
            },
              f.value_b !== null && f.value_b !== '' ? String(f.value_b) : React.createElement('span', { style: { color: 'var(--tx-3)', fontStyle: 'italic' } }, '\u2014'),
              res?.source === 'b' && React.createElement('span', { className: 'db-merge-syn-badge', style: { fontSize: 8, padding: '1px 5px' } }, '\u2713')));
        })));
  };

  const renderConfirm = () => {
    const resolved = Object.entries(resolutions).filter(([, r]) => r.source !== 'none');
    return React.createElement('div', { className: 'cf-body' },
      React.createElement('div', { className: 'db-merge-summary' },
        React.createElement('strong', null, 'Merge Summary'), React.createElement('br', null),
        '\u2022 Merging "', sourceA?.name, '" + "', sourceB?.name, '"', React.createElement('br', null),
        '\u2022 Strategy: ', MERGE_STRATEGIES[strategy]?.label, React.createElement('br', null),
        '\u2022 Effective Date: ', effectiveDate, React.createElement('br', null),
        '\u2022 Fields to synchronize: ', resolved.length, React.createElement('br', null),
        '\u2022 EO operations that will be emitted: ~', resolved.length + 2, ' (DES + SYN\u00D7', resolved.length, ' + CON)'),
      React.createElement('div', { style: { marginTop: 12, padding: '10px 14px', background: 'rgba(167,139,250,0.08)', border: '1px solid rgba(167,139,250,0.2)', borderRadius: 'var(--r)', fontSize: 11, display: 'flex', alignItems: 'center', gap: 8 } },
        React.createElement('span', { className: 'db-merge-syn-badge' }, 'SYN'),
        React.createElement('span', { style: { color: 'var(--tx-1)' } },
          'Each field merge is recorded as an auditable SYN operation anchored to ', effectiveDate, '. The full provenance chain is traceable in the Activity Stream.')),
      React.createElement('div', { style: { marginTop: 12, maxHeight: 200, overflowY: 'auto' } },
        resolved.map(([key, res]) =>
          React.createElement('div', { key, className: 'db-merge-audit-row' },
            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
              React.createElement('span', { style: { fontWeight: 600 } }, key),
              React.createElement('span', { className: 'db-merge-syn-badge', style: { fontSize: 8 } }, 'SYN \u2190 ', res.source)),
            React.createElement('div', { style: { fontFamily: 'var(--mono)', fontSize: 10, color: 'var(--tx-1)', marginTop: 2 } },
              '\u2192 ', res.value !== null ? String(res.value) : '(null)')))));
  };

  const renderDone = () => React.createElement('div', { className: 'cf-body', style: { textAlign: 'center', padding: '30px 20px' } },
    React.createElement('div', { style: { fontSize: 36, marginBottom: 12 } }, '\u2713'),
    React.createElement('div', { style: { fontSize: 16, fontWeight: 700, fontFamily: 'var(--serif)', marginBottom: 8 } }, 'Merge Complete'),
    React.createElement('div', { style: { fontSize: 12, color: 'var(--tx-2)', lineHeight: 1.6, marginBottom: 16 } },
      result?.ops_emitted, ' EO operations emitted. ', result?.field_resolutions?.length, ' fields synchronized.',
      React.createElement('br', null), 'Merge ID: ', React.createElement('span', { style: { fontFamily: 'var(--mono)', fontSize: 10 } }, result?.merge_id)),
    React.createElement('div', { style: { display: 'flex', gap: 8, justifyContent: 'center' } },
      React.createElement('button', { className: 'b-pri', onClick: onClose }, 'Done')));

  const stepTitles = { select: 'Select Records', compare: 'Compare & Resolve', confirm: 'Confirm Merge', done: 'Complete' };

  return React.createElement('div', { className: 'cf-overlay', onClick: e => { if (e.target === e.currentTarget) onClose(); } },
    React.createElement('div', { className: 'cf-modal', style: { width: 680 } },
      React.createElement('div', { className: 'cf-header' },
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
          React.createElement('h3', null, 'Database Merge'),
          React.createElement('span', { className: 'db-merge-syn-badge' }, 'SYN'),
          React.createElement('span', { style: { fontSize: 11, color: 'var(--tx-2)' } }, '\u2014 ', stepTitles[step])),
        React.createElement('button', { className: 'b-gho b-xs', onClick: onClose, style: { fontSize: 16, lineHeight: 1, padding: '2px 8px' } }, '\u2715')),
      step === 'select' && renderSelect(),
      step === 'compare' && renderCompare(),
      step === 'confirm' && renderConfirm(),
      step === 'done' && renderDone(),
      step !== 'done' && React.createElement('div', { className: 'cf-footer' },
        React.createElement('button', { className: 'b-gho', onClick: () => {
          if (step === 'confirm') setStep('compare');
          else if (step === 'compare') setStep('select');
          else onClose();
        } }, step === 'select' ? 'Cancel' : 'Back'),
        step === 'select' && sourceA && sourceB && React.createElement('button', { className: 'b-pri', onClick: () => setStep('compare') }, 'Compare Records'),
        step === 'compare' && React.createElement('button', { className: 'b-pri', disabled: hasUnresolved, onClick: () => setStep('confirm'), title: hasUnresolved ? 'Resolve all conflicts first' : '' },
          hasUnresolved ? 'Resolve Conflicts First' : 'Review & Confirm'),
        step === 'confirm' && React.createElement('button', { className: 'b-pri', disabled: saving, onClick: handleExecuteMerge },
          saving ? 'Executing SYN...' : 'Execute Merge'))));
};

/* ═══════════════════ SMALL COMPONENTS ═══════════════════ */
const Spin = ({
  s = 18
}) => /*#__PURE__*/React.createElement("div", {
  style: {
    width: s,
    height: s,
    border: '2px solid var(--border-1)',
    borderTopColor: 'var(--gold)',
    borderRadius: '50%',
    animation: 'spin .6s linear infinite'
  }
});
/* ─── useIsMobile — responsive hook for mobile breakpoint ─── */
const useIsMobile = () => {
  const [m, setM] = useState(() => typeof window !== 'undefined' && window.matchMedia('(max-width:700px)').matches);
  useEffect(() => {
    const mq = window.matchMedia('(max-width:700px)');
    const h = e => setM(e.matches);
    mq.addEventListener('change', h);
    return () => mq.removeEventListener('change', h);
  }, []);
  return m;
};

/* ─── MobileMoreDrawer — slide-up drawer for overflow nav items ─── */
const MobileMoreDrawer = ({ open, onClose, items, onNavigate, children }) => {
  if (!open) return null;
  return /*#__PURE__*/React.createElement(React.Fragment, null,
    /*#__PURE__*/React.createElement("div", {
      className: "mobile-more-overlay",
      onClick: onClose
    }),
    /*#__PURE__*/React.createElement("div", {
      className: "mobile-more-drawer"
    },
      /*#__PURE__*/React.createElement("div", { className: "mobile-more-handle" }),
      (items || []).map(item => /*#__PURE__*/React.createElement("div", {
        key: item.id,
        className: "mobile-more-item",
        onClick: () => { onNavigate(item.id); onClose(); }
      },
        /*#__PURE__*/React.createElement(I, { n: item.icon, s: 18 }),
        /*#__PURE__*/React.createElement("span", null, item.label),
        item.badge > 0 && /*#__PURE__*/React.createElement("span", {
          className: `nav-badge ${item.badgeClass || 'nav-badge-gold'}`,
          style: { marginLeft: 'auto' }
        }, item.badge)
      )),
      children
    )
  );
};

/* ─── MobileBottomNav — bottom tab bar for mobile ─── */
const MobileBottomNav = ({ tabs, activeView, onNavigate, moreItems, onMoreNavigate, children }) => {
  const [moreOpen, setMoreOpen] = useState(false);
  return /*#__PURE__*/React.createElement(React.Fragment, null,
    /*#__PURE__*/React.createElement("nav", { className: "mobile-bottom-nav" },
      /*#__PURE__*/React.createElement("div", { className: "mobile-bottom-nav-items" },
        tabs.map(tab => /*#__PURE__*/React.createElement("button", {
          key: tab.id,
          className: 'mobile-bottom-nav-item' + (activeView === tab.id ? ' active' : ''),
          onClick: () => onNavigate(tab.id)
        },
          /*#__PURE__*/React.createElement("div", { style: { position: 'relative' } },
            /*#__PURE__*/React.createElement(I, { n: tab.icon, s: 20 }),
            tab.badge > 0 && /*#__PURE__*/React.createElement("span", {
              className: `nav-badge ${tab.badgeClass || 'nav-badge-gold'}`,
              style: { position: 'absolute', top: -4, right: -8, fontSize: 8, minWidth: 14, height: 14, padding: '0 3px' }
            }, tab.badge)
          ),
          /*#__PURE__*/React.createElement("span", null, tab.label)
        )),
        /*#__PURE__*/React.createElement("button", {
          className: 'mobile-bottom-nav-item' + (moreOpen ? ' active' : ''),
          onClick: () => setMoreOpen(!moreOpen)
        },
          /*#__PURE__*/React.createElement(I, { n: "grid", s: 20 }),
          /*#__PURE__*/React.createElement("span", null, "More")
        )
      )
    ),
    /*#__PURE__*/React.createElement(MobileMoreDrawer, {
      open: moreOpen,
      onClose: () => setMoreOpen(false),
      items: moreItems,
      onNavigate: id => { onMoreNavigate(id); setMoreOpen(false); }
    }, children)
  );
};

const Modal = ({
  open,
  onClose,
  title,
  w = 480,
  children
}) => {
  if (!open) return null;
  return /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'fixed',
      inset: 0,
      zIndex: 1000,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      background: 'rgba(0,0,0,.75)',
      backdropFilter: 'blur(6px)'
    },
    onClick: onClose
  }, /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    onClick: e => e.stopPropagation(),
    style: {
      background: 'var(--bg-2)',
      border: '1px solid var(--border-1)',
      borderRadius: 'var(--r-lg)',
      width: '92%',
      maxWidth: w,
      maxHeight: '88vh',
      overflow: 'auto',
      padding: 28
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("h3", {
    style: {
      fontSize: 16,
      fontWeight: 700
    }
  }, title), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    "aria-label": "Close",
    style: {
      background: 'transparent',
      color: 'var(--tx-2)',
      padding: 8,
      minWidth: 32,
      minHeight: 32,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      borderRadius: 'var(--r)',
      cursor: 'pointer'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "x",
    s: 17
  }))), children));
};
const Toggle = ({
  on,
  onChange,
  disabled
}) => /*#__PURE__*/React.createElement("div", {
  className: `toggle-track ${on ? 'on' : 'off'}`,
  onClick: disabled ? undefined : onChange,
  style: disabled ? {
    opacity: .4,
    cursor: 'default'
  } : {}
}, /*#__PURE__*/React.createElement("div", {
  className: "toggle-knob"
}));
const Toast = ({
  msg,
  type = 'info',
  onClose
}) => {
  useEffect(() => {
    const t = setTimeout(onClose, 3500);
    return () => clearTimeout(t);
  }, []);
  const c = {
    info: 'var(--blue)',
    success: 'var(--green)',
    error: 'var(--red)',
    warn: 'var(--gold)'
  }[type];
  return /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      position: 'fixed',
      bottom: 20,
      right: 20,
      zIndex: 9999,
      background: 'var(--bg-2)',
      border: `1px solid ${c}30`,
      borderLeft: `3px solid ${c}`,
      borderRadius: 'var(--r)',
      padding: '11px 18px',
      fontSize: 12.5,
      boxShadow: '0 8px 32px rgba(0,0,0,.5)',
      maxWidth: 400
    }
  }, msg);
};
/* ═══════════════════ CONNECTION BADGES ═══════════════════
 * Shows user type, org affiliation, and team membership badges.
 * Used in messaging views to clarify who you're talking to.
 * ═══════════════════════════════════════════════════════════ */
const ConnectionBadges = ({ userType, orgName, orgType, teamName, teamNames, teamColors, role, verified, size = 'sm' }) => {
  const badges = [];
  const sz = size === 'xs' ? 8 : 9;
  const iconSz = size === 'xs' ? 7 : 9;
  // User type badge
  if (userType) {
    const typeMap = {
      client: { cls: 'conn-badge-client', icon: 'shield', label: ROLES.client.label },
      provider: { cls: 'conn-badge-provider', icon: 'briefcase', label: ROLES.provider.label },
      org_admin: { cls: 'conn-badge-admin', icon: 'users', label: 'Org Admin' },
      network: { cls: 'conn-badge-network', icon: 'globe', label: 'Network Coordinator' }
    };
    const t = typeMap[userType] || typeMap.provider;
    badges.push(React.createElement("span", { key: "type", className: `conn-badge ${t.cls}`, style: { fontSize: sz } },
      React.createElement(I, { n: t.icon, s: iconSz }), t.label));
  }
  // Org badge
  if (orgName) {
    badges.push(React.createElement("span", { key: "org", className: `conn-badge conn-badge-org`, style: { fontSize: sz } },
      verified ? React.createElement(I, { n: "shieldCheck", s: iconSz }) : React.createElement(I, { n: "users", s: iconSz }),
      orgName, orgType ? ` \u00B7 ${ORG_TYPE_LABELS[orgType] || orgType}` : ''));
  }
  // Team badge(s) — use dynamic team color if available
  const allTeams = teamNames || (teamName ? [teamName] : []);
  allTeams.forEach((tn, i) => {
    const tc = teamColors?.find(c => c.name === tn);
    const dynamicStyle = tc?.color_hue != null ? {
      background: `hsla(${tc.color_hue}, 65%, 55%, 0.10)`,
      color: `hsl(${tc.color_hue}, 65%, 55%)`
    } : {};
    badges.push(React.createElement("span", {
      key: `team-${i}`,
      className: `conn-badge ${tc?.color_hue != null ? '' : 'conn-badge-team'}`,
      style: { fontSize: sz, ...dynamicStyle }
    }, React.createElement(I, { n: "users", s: iconSz }), tn));
  });
  // Role badge (if within an org)
  if (role && orgName) {
    badges.push(React.createElement("span", { key: "role", className: `conn-badge conn-badge-provider`, style: { fontSize: sz } }, role));
  }
  if (badges.length === 0) return null;
  return React.createElement("span", { className: "conn-badges" }, ...badges);
};

/* ═══════════════════ STORAGE TRANSPARENCY BADGE ═══════════════════
 * Shows users exactly where their data is stored, encryption status,
 * which Matrix server hosts it, and who has access.
 *
 * Props:
 *   storageType  — 'matrix' | 'local' | 'indexeddb' | 'webhook'
 *   roomId       — Matrix room ID (for matrix type)
 *   server       — homeserver domain (auto-extracted from roomId if omitted)
 *   encrypted    — boolean, whether data is encrypted
 *   encLabel     — custom encryption label (e.g. 'AES-256-GCM' or 'Megolm E2EE')
 *   members      — array of {userId, name?, role?} with access
 *   label        — short description (e.g. 'Vault Data', 'Case Messages')
 *   extra        — array of {label, value} for additional info rows
 *   compact      — show inline compact badge (no expandable panel)
 * ═══════════════════════════════════════════════════════════════════ */
const StorageTransparencyBadge = ({
  storageType = 'matrix',
  roomId,
  server,
  encrypted,
  encLabel,
  members,
  label,
  extra,
  compact
}) => {
  const [open, setOpen] = useState(false);
  const resolvedServer = server || (roomId ? extractHomeserver(roomId) : null) || (svc._baseUrl ? new URL(svc._baseUrl).hostname : null) || 'unknown';
  const storageLabels = {
    matrix: 'Matrix Room',
    local: 'Browser localStorage',
    indexeddb: 'Browser IndexedDB',
    webhook: 'External Webhook'
  };
  const storageIcons = {
    matrix: 'server',
    local: 'lock',
    indexeddb: 'lock',
    webhook: 'globe'
  };
  if (compact) {
    return React.createElement("div", {
      style: { display: 'inline-flex', alignItems: 'center', gap: 4, padding: '2px 8px', borderRadius: 10,
        background: 'var(--bg-2)', border: '1px solid var(--border-0)', fontSize: 10, fontFamily: 'var(--mono)',
        color: 'var(--tx-2)', cursor: 'help' },
      title: `Stored in: ${storageLabels[storageType] || storageType}${roomId ? '\nRoom: ' + roomId : ''}\nServer: ${resolvedServer}${encrypted ? '\nEncrypted: ' + (encLabel || 'Yes') : ''}`
    }, React.createElement(I, { n: storageIcons[storageType] || 'server', s: 10, c: 'var(--teal)' }),
      resolvedServer,
      encrypted && React.createElement("span", { style: { color: 'var(--green)', marginLeft: 2 } }, '\u2022 encrypted'));
  }
  return React.createElement("div", { className: "stb-wrap" },
    React.createElement("div", {
      className: `stb-toggle${open ? ' open' : ''}`,
      onClick: () => setOpen(o => !o)
    },
      React.createElement(I, { n: 'database', s: 11, c: open ? 'var(--teal)' : 'var(--tx-2)' }),
      label ? `${label} — storage info` : 'Where is this stored?',
      React.createElement(I, { n: open ? 'chevron-up' : 'chevron-down', s: 10 })
    ),
    open && React.createElement("div", { className: "stb-panel" },
      // Storage type
      React.createElement("div", { className: "stb-row" },
        React.createElement("div", { className: "stb-icon", style: { background: 'var(--teal-dim)', color: 'var(--teal)' } },
          React.createElement(I, { n: storageIcons[storageType] || 'server', s: 12 })),
        React.createElement("div", null,
          React.createElement("div", { className: "stb-label" }, "Storage type"),
          React.createElement("div", { className: "stb-value" }, storageLabels[storageType] || storageType))
      ),
      // Server
      resolvedServer && React.createElement("div", { className: "stb-row" },
        React.createElement("div", { className: "stb-icon", style: { background: 'var(--blue-dim)', color: 'var(--blue)' } },
          React.createElement(I, { n: 'globe', s: 12 })),
        React.createElement("div", null,
          React.createElement("div", { className: "stb-label" }, "Server"),
          React.createElement("div", { className: "stb-value-mono" }, resolvedServer))
      ),
      // Room ID
      roomId && React.createElement("div", { className: "stb-row" },
        React.createElement("div", { className: "stb-icon", style: { background: 'var(--purple-dim)', color: 'var(--purple)' } },
          React.createElement(I, { n: 'hash', s: 12 })),
        React.createElement("div", null,
          React.createElement("div", { className: "stb-label" }, "Room ID"),
          React.createElement("div", { className: "stb-value-mono" }, roomId))
      ),
      // Encryption
      React.createElement("div", { className: "stb-row" },
        React.createElement("div", { className: "stb-icon", style: { background: encrypted ? 'var(--green-dim)' : 'var(--red-dim)', color: encrypted ? 'var(--green)' : 'var(--red)' } },
          React.createElement(I, { n: encrypted ? 'lock' : 'unlock', s: 12 })),
        React.createElement("div", null,
          React.createElement("div", { className: "stb-label" }, "Encryption"),
          React.createElement("span", { className: `stb-enc ${encrypted ? 'stb-enc-on' : 'stb-enc-off'}` },
            encrypted ? (encLabel || 'Encrypted') : 'Not encrypted'))
      ),
      // Access / Members
      members && members.length > 0 && React.createElement(React.Fragment, null,
        React.createElement("div", { className: "stb-divider" }),
        React.createElement("div", { className: "stb-row" },
          React.createElement("div", { className: "stb-icon", style: { background: 'var(--gold-dim)', color: 'var(--gold)' } },
            React.createElement(I, { n: 'users', s: 12 })),
          React.createElement("div", null,
            React.createElement("div", { className: "stb-label" }, "Who has access (" + members.length + ")"),
            React.createElement("div", { style: { display: 'flex', flexWrap: 'wrap', gap: 2, marginTop: 4 } },
              members.map((m, i) => React.createElement("span", { key: i, className: "stb-member" },
                m.name || m.userId,
                m.role && React.createElement("span", { style: { color: 'var(--tx-3)', marginLeft: 2 } }, '\u00b7 ' + m.role)
              ))
            )
          )
        )
      ),
      // Extra info
      extra && extra.length > 0 && React.createElement(React.Fragment, null,
        React.createElement("div", { className: "stb-divider" }),
        extra.map((row, i) => React.createElement("div", { key: i, className: "stb-row" },
          React.createElement("div", { className: "stb-icon", style: { background: 'var(--bg-3)', color: 'var(--tx-2)' } },
            React.createElement(I, { n: 'info', s: 12 })),
          React.createElement("div", null,
            React.createElement("div", { className: "stb-label" }, row.label),
            React.createElement("div", { className: "stb-value" }, row.value))
        ))
      )
    )
  );
};

const OP_COLORS = {
  INS: 'green',
  ALT: 'blue',
  DES: 'gold',
  SEG: 'teal',
  NUL: 'red',
  REC: 'orange',
  CON: 'blue',
  SYN: 'purple',
  SUP: 'gold'
};

/* ═══════════════════ MVP BADGE COMPONENTS (§Screen 4) ═══════════════════ */

// Maturity badge: Draft / Trial / Normative / De facto / Deprecated
const MaturityBadge = ({
  maturity,
  size = 'sm'
}) => {
  const level = MATURITY_LEVELS[maturity];
  if (!level) return null;
  const pad = size === 'lg' ? '3px 10px' : '2px 7px';
  const fs = size === 'lg' ? 11 : 9.5;
  return /*#__PURE__*/React.createElement("span", {
    className: `tag tag-${level.color}`,
    style: {
      fontSize: fs,
      padding: pad
    },
    title: level.desc
  }, level.label);
};

// Source badge: Network (with propagation level) or Local
const SourceBadge = ({
  source
}) => {
  if (!source) return /*#__PURE__*/React.createElement("span", {
    className: "tag tag-purple",
    style: {
      fontSize: 9
    }
  }, "Local");
  if (source.level === 'local') return /*#__PURE__*/React.createElement("span", {
    className: "tag tag-purple",
    style: {
      fontSize: 9
    }
  }, "Local");
  const prop = PROPAGATION_LEVELS[source.propagation];
  return /*#__PURE__*/React.createElement("span", {
    className: `tag tag-${prop?.color || 'blue'}`,
    style: {
      fontSize: 9
    },
    title: `${source.propagation}: ${prop?.desc || ''}`
  }, "Shared \xB7 ", prop?.label || source.propagation);
};

// Consent gradient — not a vote count, a distribution of positions
const ConsentGradient = ({
  positions = {},
  totalOrgs = 0
}) => {
  const counts = {};
  let responded = 0;
  for (const [orgId, pos] of Object.entries(positions)) {
    if (pos) {
      const p = pos.position || 'pending';
      counts[p] = (counts[p] || 0) + 1;
      responded++;
    }
  }
  const pending = totalOrgs - responded;
  const segments = [{
    key: 'adopt_as_is',
    count: counts.adopt_as_is || 0,
    ...CONSENT_POSITIONS.adopt_as_is
  }, {
    key: 'adopt_with_extension',
    count: counts.adopt_with_extension || 0,
    ...CONSENT_POSITIONS.adopt_with_extension
  }, {
    key: 'needs_modification',
    count: counts.needs_modification || 0,
    ...CONSENT_POSITIONS.needs_modification
  }, {
    key: 'cannot_adopt',
    count: counts.cannot_adopt || 0,
    ...CONSENT_POSITIONS.cannot_adopt
  }];
  const hasBlock = (counts.cannot_adopt || 0) > 0;
  return /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 8
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      height: 8,
      borderRadius: 4,
      overflow: 'hidden',
      background: 'var(--bg-3)',
      gap: 1
    }
  }, segments.map(seg => seg.count > 0 ? /*#__PURE__*/React.createElement("div", {
    key: seg.key,
    style: {
      flex: seg.count,
      background: `var(--${seg.color})`,
      transition: 'flex .3s'
    },
    title: `${seg.label}: ${seg.count}`
  }) : null), pending > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      flex: pending,
      background: 'var(--border-1)'
    },
    title: `Pending: ${pending}`
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 10,
      marginTop: 6,
      flexWrap: 'wrap'
    }
  }, segments.filter(s => s.count > 0).map(s => /*#__PURE__*/React.createElement("div", {
    key: s.key,
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 8,
      height: 8,
      borderRadius: 2,
      background: `var(--${s.color})`
    }
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-1)'
    }
  }, s.icon, " ", s.label, " (", s.count, ")"))), pending > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 8,
      height: 8,
      borderRadius: 2,
      background: 'var(--border-1)'
    }
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)'
    }
  }, "Pending (", pending, ")"))), hasBlock && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 6,
      padding: '6px 10px',
      background: 'var(--red-dim)',
      border: '1px solid rgba(232,93,93,.2)',
      borderRadius: 'var(--r)',
      fontSize: 11,
      color: 'var(--red)'
    }
  }, "Block registered \u2014 structured objection required before proceeding"));
};

// De facto field detection alert
const DeFactoAlert = ({
  fieldName,
  orgCount,
  totalOrgs,
  onFormalize,
  onDismiss
}) => /*#__PURE__*/React.createElement("div", {
  className: "card anim-up",
  style: {
    padding: '14px 18px',
    borderColor: 'var(--gold)',
    borderLeft: '3px solid var(--gold)'
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    display: 'flex',
    alignItems: 'flex-start',
    gap: 10
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    width: 32,
    height: 32,
    borderRadius: 'var(--r)',
    background: 'var(--gold-dim)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    color: 'var(--gold)',
    flexShrink: 0
  }
}, /*#__PURE__*/React.createElement(I, {
  n: "zap",
  s: 16
})), /*#__PURE__*/React.createElement("div", {
  style: {
    flex: 1
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 13,
    fontWeight: 600,
    marginBottom: 2
  }
}, "De facto standard detected"), /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 12,
    color: 'var(--tx-1)',
    lineHeight: 1.5
  }
}, orgCount, " of ", totalOrgs, " orgs have a \"", fieldName, "\" field. Formalize as network standard?"), /*#__PURE__*/React.createElement("div", {
  style: {
    display: 'flex',
    gap: 8,
    marginTop: 10
  }
}, /*#__PURE__*/React.createElement("button", {
  onClick: onFormalize,
  className: "b-pri b-sm"
}, "Propose Formalization"), /*#__PURE__*/React.createElement("button", {
  onClick: onDismiss,
  className: "b-gho b-sm"
}, "Dismiss")))));

// Adoption metrics bar (ambient monitoring)
const AdoptionMetrics = ({
  adopted,
  total,
  extensions,
  divergences
}) => /*#__PURE__*/React.createElement("div", {
  className: "card",
  style: {
    padding: 14
  }
}, /*#__PURE__*/React.createElement("span", {
  className: "section-label"
}, "SCHEMA ADOPTION"), /*#__PURE__*/React.createElement("div", {
  style: {
    display: 'flex',
    alignItems: 'baseline',
    gap: 6,
    marginTop: 4
  }
}, /*#__PURE__*/React.createElement("span", {
  style: {
    fontSize: 22,
    fontWeight: 700,
    color: 'var(--green)'
  }
}, adopted), /*#__PURE__*/React.createElement("span", {
  style: {
    fontSize: 13,
    color: 'var(--tx-2)'
  }
}, "of ", total, " network fields adopted")), /*#__PURE__*/React.createElement("div", {
  style: {
    display: 'flex',
    height: 6,
    borderRadius: 3,
    overflow: 'hidden',
    background: 'var(--bg-3)',
    marginTop: 8,
    gap: 1
  }
}, adopted > 0 && /*#__PURE__*/React.createElement("div", {
  style: {
    flex: adopted,
    background: 'var(--green)'
  }
}), extensions > 0 && /*#__PURE__*/React.createElement("div", {
  style: {
    flex: extensions,
    background: 'var(--blue)'
  }
}), divergences > 0 && /*#__PURE__*/React.createElement("div", {
  style: {
    flex: divergences,
    background: 'var(--gold)'
  }
}), total - adopted - (extensions || 0) - (divergences || 0) > 0 && /*#__PURE__*/React.createElement("div", {
  style: {
    flex: total - adopted - (extensions || 0) - (divergences || 0),
    background: 'var(--border-1)'
  }
})), /*#__PURE__*/React.createElement("div", {
  style: {
    display: 'flex',
    gap: 12,
    marginTop: 6,
    fontSize: 10,
    color: 'var(--tx-2)'
  }
}, extensions > 0 && /*#__PURE__*/React.createElement("span", {
  style: {
    color: 'var(--blue)'
  }
}, extensions, " with extensions"), divergences > 0 && /*#__PURE__*/React.createElement("span", {
  style: {
    color: 'var(--gold)'
  }
}, divergences, " diverged")));

// Governance proposal card (MVP §Screen 5)
const ProposalCard = ({
  proposal,
  onRespond
}) => {
  const status = PROPOSAL_STATUSES[proposal.status] || PROPOSAL_STATUSES.submitted;
  const targetProp = PROPAGATION_LEVELS[proposal.target_propagation];
  const targetMat = MATURITY_LEVELS[proposal.target_maturity];
  const positionEntries = Object.entries(proposal.positions || {});
  const totalOrgs = positionEntries.length;
  return /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 0,
      overflow: 'hidden',
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '14px 18px',
      borderBottom: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 6,
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tag tag-${status.color}`
  }, status.label), targetProp && /*#__PURE__*/React.createElement(SourceBadge, {
    source: {
      level: 'network',
      propagation: proposal.target_propagation
    }
  }), targetMat && /*#__PURE__*/React.createElement(MaturityBadge, {
    maturity: proposal.target_maturity
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 14,
      fontWeight: 600,
      marginBottom: 4
    }
  }, proposal.summary), proposal.detail && /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.5
    }
  }, proposal.detail), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 12,
      marginTop: 8,
      fontSize: 10,
      color: 'var(--tx-2)',
      fontFamily: 'var(--mono)'
    }
  }, /*#__PURE__*/React.createElement("span", null, "By: ", proposal.proposed_by), proposal.governance_rhythm && /*#__PURE__*/React.createElement("span", null, proposal.governance_rhythm), proposal.deadline && /*#__PURE__*/React.createElement("span", null, "Due: ", new Date(proposal.deadline).toLocaleDateString()))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 18px'
    }
  }, /*#__PURE__*/React.createElement(ConsentGradient, {
    positions: proposal.positions,
    totalOrgs: totalOrgs
  }), onRespond && proposal.status === 'consent_round' && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 10
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onRespond,
    className: "b-pri b-sm"
  }, "Review & Respond"))));
};

// Governance calendar display
const GovernanceCalendar = ({
  rhythms = Object.values(GOV_RHYTHMS)
}) => /*#__PURE__*/React.createElement("div", {
  className: "card",
  style: {
    padding: 16
  }
}, /*#__PURE__*/React.createElement("span", {
  className: "section-label"
}, "GOVERNANCE CALENDAR"), /*#__PURE__*/React.createElement("div", {
  style: {
    display: 'flex',
    flexDirection: 'column',
    gap: 8,
    marginTop: 8
  }
}, rhythms.map(r => /*#__PURE__*/React.createElement("div", {
  key: r.id,
  style: {
    display: 'flex',
    alignItems: 'center',
    gap: 12,
    padding: '8px 12px',
    background: 'var(--bg-3)',
    borderRadius: 'var(--r)'
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    width: 36,
    height: 36,
    borderRadius: 'var(--r)',
    background: 'var(--gold-dim)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    color: 'var(--gold)',
    flexShrink: 0
  }
}, /*#__PURE__*/React.createElement(I, {
  n: "clock",
  s: 16
})), /*#__PURE__*/React.createElement("div", {
  style: {
    flex: 1
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 13,
    fontWeight: 600
  }
}, r.name), /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 10.5,
    color: 'var(--tx-2)',
    marginTop: 2
  }
}, r.frequency, " \xB7 ", r.duration_days, " day window \xB7 ", r.participants))))));

/* ═══════════════════ GIVEN/MEANT DIVIDE VISUALIZATION ═══════════════════ */

// Core visualization: observation on the left, crossing in the middle, frameworks on the right
const GivenMeantDivide = ({
  observation,
  compact = false
}) => {
  // observation: {prompt, value, valueLabel, reporter, timestamp, eoTrace, frameworks}
  const [expandedChains, setExpandedChains] = useState(new Set());
  const toggleChain = id => setExpandedChains(p => {
    const n = new Set(p);
    n.has(id) ? n.delete(id) : n.add(id);
    return n;
  });
  if (!observation) return null;
  const {
    prompt,
    value,
    valueLabel,
    reporter,
    timestamp,
    eoTrace,
    frameworks
  } = observation;

  // Detect divergence: do frameworks classify differently?
  const classifications = frameworks?.map(f => f.classification) || [];
  const uniqueClassifications = [...new Set(classifications)];
  const hasDivergence = uniqueClassifications.length > 1;

  // Collect all unique EO ops used in the crossing
  const crossingOps = new Set();
  (frameworks || []).forEach(f => (f.eo_chain || []).forEach(s => crossingOps.add(s.op)));
  return /*#__PURE__*/React.createElement("div", {
    className: "gm-container anim-up",
    style: compact ? {
      minHeight: 'auto'
    } : {}
  }, /*#__PURE__*/React.createElement("div", {
    className: "gm-given",
    style: compact ? {
      flex: '0 0 280px',
      padding: 14
    } : {}
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tag tag-teal",
    style: {
      fontSize: 9
    }
  }, "GIVEN"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)'
    }
  }, "OBSERVATION")), prompt && /*#__PURE__*/React.createElement("div", {
    className: "gm-obs-field"
  }, prompt), /*#__PURE__*/React.createElement("div", {
    className: "gm-obs-value"
  }, valueLabel || value), /*#__PURE__*/React.createElement("div", {
    className: "gm-meta-row"
  }, reporter && /*#__PURE__*/React.createElement("span", null, reporter), timestamp && /*#__PURE__*/React.createElement("span", null, new Date(timestamp).toLocaleDateString())), eoTrace && /*#__PURE__*/React.createElement("div", {
    className: "gm-eo-trace"
  }, eoTrace), !compact && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 12,
      padding: '8px 10px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      fontSize: 10.5,
      color: 'var(--tx-2)',
      lineHeight: 1.5
    }
  }, "This is ground truth. The observation just ", /*#__PURE__*/React.createElement("em", null, "is"), ". Everything to the right is what it ", /*#__PURE__*/React.createElement("em", null, "means"), ", according to whom.")), /*#__PURE__*/React.createElement("div", {
    className: "gm-crossing"
  }, /*#__PURE__*/React.createElement("div", {
    className: "gm-crossing-arrow",
    title: "Epistemic crossing: observation becomes interpretation"
  }, "\u2192"), /*#__PURE__*/React.createElement("div", {
    className: "gm-crossing-label"
  }, "GIVEN \u2192 MEANT"), [...crossingOps].map(op => /*#__PURE__*/React.createElement("div", {
    key: op,
    className: "gm-crossing-op",
    style: {
      background: `var(--${OP_COLORS[op] || 'blue'}-dim)`,
      color: `var(--${OP_COLORS[op] || 'blue'})`,
      borderColor: `var(--${OP_COLORS[op] || 'blue'})20`
    }
  }, op))), /*#__PURE__*/React.createElement("div", {
    className: "gm-meant",
    style: compact ? {
      padding: 14
    } : {}
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 9
    }
  }, "MEANT"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)'
    }
  }, "FRAMEWORK INTERPRETATIONS (", frameworks?.length || 0, ")")), hasDivergence && /*#__PURE__*/React.createElement("div", {
    className: "gm-divergence"
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--gold)',
      fontWeight: 700,
      fontSize: 13,
      lineHeight: 1
    }
  }, "\u25C6"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--gold)',
      fontSize: 11
    }
  }, "Frameworks diverge"), /*#__PURE__*/React.createElement("span", {
    style: {
      display: 'block',
      fontSize: 10,
      color: 'var(--tx-2)',
      marginTop: 2
    }
  }, uniqueClassifications.length, " distinct classifications from the same observation. This is SUP made visible \u2014 the value exists in superposition across frameworks."))), (frameworks || []).map((fw, i) => {
    const fwColor = FRAMEWORK_COLORS[fw.authority_id] || {
      accent: 'purple',
      label: '?'
    };
    const isExpanded = expandedChains.has(fw.id);
    return /*#__PURE__*/React.createElement("div", {
      key: fw.id || i,
      className: "gm-fw-card",
      "data-accent": fwColor.accent
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'flex-start',
        justifyContent: 'space-between',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        minWidth: 0
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginBottom: 4,
        flexWrap: 'wrap'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${fwColor.accent}`,
      style: {
        fontSize: 8.5
      }
    }, fw.authority_org), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        fontWeight: 600
      }
    }, fw.authority_name)), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 14,
        fontWeight: 700,
        color: 'var(--gold)',
        marginBottom: 4
      }
    }, fw.classification), fw.provision && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 10,
        fontFamily: 'var(--mono)',
        color: 'var(--tx-2)',
        marginBottom: 4
      }
    }, fw.provision), fw.authority_uri && /*#__PURE__*/React.createElement("a", {
      href: fw.authority_uri,
      target: "_blank",
      rel: "noopener",
      style: {
        fontSize: 9.5,
        fontFamily: 'var(--mono)',
        color: 'var(--blue)',
        display: 'block',
        marginBottom: 4,
        overflow: 'hidden',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap',
        textDecoration: 'none',
        maxWidth: '100%'
      }
    }, fw.authority_uri), fw.implication && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 11,
        color: 'var(--tx-1)',
        padding: '4px 8px',
        background: 'var(--bg-3)',
        borderRadius: 'var(--r)',
        display: 'inline-block',
        marginTop: 2
      }
    }, fw.implication))), /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 8,
        borderTop: '1px solid var(--border-0)',
        paddingTop: 8
      }
    }, /*#__PURE__*/React.createElement("div", {
      onClick: () => toggleChain(fw.id),
      style: {
        cursor: 'pointer',
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        fontFamily: 'var(--mono)',
        color: 'var(--tx-3)'
      }
    }, "EO CHAIN"), /*#__PURE__*/React.createElement(I, {
      n: isExpanded ? 'x' : 'chevR',
      s: 9,
      c: "var(--tx-3)"
    })), !isExpanded && fw.eo_compact && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 9,
        fontFamily: 'var(--mono)',
        color: 'var(--purple)',
        marginTop: 3
      }
    }, fw.eo_compact), isExpanded && /*#__PURE__*/React.createElement("div", {
      className: "gm-chain"
    }, (fw.eo_chain || []).map((step, si) => /*#__PURE__*/React.createElement(React.Fragment, {
      key: si
    }, si > 0 && /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 10
      }
    }, "\u2192"), /*#__PURE__*/React.createElement("span", {
      className: "gm-chain-step",
      style: {
        background: `var(--${OP_COLORS[step.op] || 'blue'}-dim)`,
        color: `var(--${OP_COLORS[step.op] || 'blue'})`
      }
    }, step.op, "(", step.desc, ")"))))));
  }), (!frameworks || frameworks.length === 0) && /*#__PURE__*/React.createElement("div", {
    className: "gm-wb-empty"
  }, /*#__PURE__*/React.createElement(I, {
    n: "grid",
    s: 24
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      marginTop: 8,
      fontSize: 12
    }
  }, "No frameworks bound"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-3)',
      marginTop: 4
    }
  }, "This observation is recorded but not yet interpreted."))));
};

// Record-level GIVEN/MEANT display for a specific client observation
const RecordGivenMeant = ({
  promptKey,
  value,
  reporter,
  timestamp
}) => {
  const prompt = DEFAULT_PROMPTS.find(p => p.key === promptKey);
  if (!prompt) return null;
  const option = prompt.options?.find(o => o.v === value);
  const binding = FRAMEWORK_BINDINGS[promptKey]?.bindings?.[value];
  const observation = {
    prompt: prompt.question,
    value: value,
    valueLabel: option?.l || value,
    reporter: reporter || `${ROLES.client.label} self-report`,
    timestamp: timestamp,
    eoTrace: prompt.eo?.trace,
    frameworks: binding?.frameworks || []
  };
  return /*#__PURE__*/React.createElement(GivenMeantDivide, {
    observation: observation,
    compact: true
  });
};

/* ═══════════════════ FRAMEWORK TOGGLE PANEL ═══════════════════
 * Lets users toggle data-field frameworks on/off. Each framework
 * injects a set of vault fields tagged to authoritative URIs,
 * giving local field values an objective semantic anchor.
 * ═══════════════════════════════════════════════════════════════ */
const FrameworkTogglePanel = ({
  enabledFrameworks,
  onToggle
}) => {
  const [expandedFw, setExpandedFw] = useState(null);
  const handleToggle = fwId => {
    const next = enabledFrameworks.includes(fwId) ? enabledFrameworks.filter(id => id !== fwId) : [...enabledFrameworks, fwId];
    onToggle(next);
  };
  const domainGroups = useMemo(() => {
    const groups = {};
    FRAMEWORK_FIELD_STANDARDS.forEach(fw => {
      if (!groups[fw.domain]) groups[fw.domain] = [];
      groups[fw.domain].push(fw);
    });
    return groups;
  }, []);
  return /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, "Toggle frameworks to add their standardized fields to your vault. Each field is tagged to an authoritative URI \u2014 turning local data into semantically anchored, interoperable records."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      flexWrap: 'wrap',
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      alignSelf: 'center'
    }
  }, "Active:"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 700,
      color: 'var(--green)'
    }
  }, enabledFrameworks.length), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-3)'
    }
  }, "of ", FRAMEWORK_FIELD_STANDARDS.length, " frameworks"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-3)',
      marginLeft: 4
    }
  }, "\xB7"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, getFrameworkFields(enabledFrameworks).length, " fields added")), Object.entries(domainGroups).map(([domain, frameworks]) => /*#__PURE__*/React.createElement("div", {
    key: domain
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      fontSize: 10,
      marginBottom: 6,
      display: 'block'
    }
  }, domain.toUpperCase()), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 6
    }
  }, frameworks.map(fw => {
    const isEnabled = enabledFrameworks.includes(fw.id);
    const isExpanded = expandedFw === fw.id;
    return /*#__PURE__*/React.createElement("div", {
      key: fw.id,
      className: "card",
      style: {
        padding: 0,
        overflow: 'hidden',
        borderColor: isEnabled ? `var(--${fw.accent})` : 'var(--border-0)',
        transition: 'border-color .2s'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '12px 16px',
        display: 'flex',
        alignItems: 'center',
        gap: 12
      }
    }, /*#__PURE__*/React.createElement(Toggle, {
      on: isEnabled,
      onChange: () => handleToggle(fw.id)
    }), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        minWidth: 0
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        flexWrap: 'wrap'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13.5,
        fontWeight: 600
      }
    }, fw.name), /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${fw.accent}`,
      style: {
        fontSize: 8.5
      }
    }, fw.spec), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        color: 'var(--tx-2)'
      }
    }, fw.fields.length, " fields")), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 11,
        color: 'var(--tx-2)',
        marginTop: 2
      }
    }, fw.description)), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("a", {
      href: fw.uri,
      target: "_blank",
      rel: "noopener",
      style: {
        fontSize: 9,
        fontFamily: 'var(--mono)',
        color: `var(--${fw.accent})`,
        textDecoration: 'none'
      },
      title: fw.uri
    }, "spec"), /*#__PURE__*/React.createElement("span", {
      onClick: () => setExpandedFw(isExpanded ? null : fw.id),
      style: {
        cursor: 'pointer',
        color: 'var(--tx-3)',
        transition: 'color .15s'
      },
      onMouseEnter: e => e.currentTarget.style.color = 'var(--tx-0)',
      onMouseLeave: e => e.currentTarget.style.color = 'var(--tx-3)'
    }, /*#__PURE__*/React.createElement(I, {
      n: isExpanded ? 'x' : 'chevR',
      s: 12
    })))), isExpanded && /*#__PURE__*/React.createElement("div", {
      style: {
        borderTop: '1px solid var(--border-0)',
        padding: '10px 16px',
        background: 'var(--bg-1)'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fill,minmax(200px,1fr))',
        gap: 6
      }
    }, fw.fields.map(f => /*#__PURE__*/React.createElement("div", {
      key: f.key,
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        padding: '5px 8px',
        borderRadius: 'var(--r)',
        background: 'var(--bg-2)',
        border: '1px solid var(--border-0)',
        fontSize: 11.5
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        flex: 1,
        fontWeight: 500
      }
    }, f.label), f.sensitive && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-red",
      style: {
        fontSize: 7.5,
        padding: '1px 5px'
      }
    }, "SENSITIVE"), /*#__PURE__*/React.createElement("a", {
      href: f.uri,
      target: "_blank",
      rel: "noopener",
      style: {
        color: `var(--${fw.accent})`,
        textDecoration: 'none',
        fontSize: 9,
        fontFamily: 'var(--mono)'
      }
    }, f.property)))), /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 8,
        fontSize: 10,
        fontFamily: 'var(--mono)',
        color: 'var(--tx-3)',
        overflow: 'hidden',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap'
      }
    }, fw.uri)));
  })))));
};

/* ═══════════════════ SCHEMA WORKBENCH ═══════════════════ */
const SWC_DARK = {
  bg: "#07090d",
  surface: "#0e1218",
  raised: "#151b23",
  hover: "#1b2330",
  border: "#1d2735",
  borderLit: "#2c3d52",
  text: "#c0c9d4",
  muted: "#7a8da0",
  dim: "#4a5d72",
  white: "#edf0f5",
  given: "#2dd4a0",
  givenBorder: "#18694e",
  meant: "#a78bfa",
  meantBorder: "#4a2d8a",
  fw: ["#60a5fa", "#f0abfc", "#fbbf24", "#34d399", "#fb7185"],
  fwBg: i => `${["#60a5fa", "#f0abfc", "#fbbf24", "#34d399", "#fb7185"][i % 5]}12`,
  fwBorder: i => `${["#60a5fa", "#f0abfc", "#fbbf24", "#34d399", "#fb7185"][i % 5]}40`,
  sup: "#fbbf24",
  supBg: "rgba(251,191,36,0.06)",
  red: "#f87171"
};
const SWC_LIGHT = {
  bg: "#f5f5f7",
  surface: "#ebedf0",
  raised: "#e0e2e7",
  hover: "#d4d7dd",
  border: "#b8bcc6",
  borderLit: "#a0a5b2",
  text: "#2e3340",
  muted: "#4a5168",
  dim: "#8890a0",
  white: "#111318",
  given: "#137a6a",
  givenBorder: "#0a5c4d",
  meant: "#6938c0",
  meantBorder: "#4a2d8a",
  fw: ["#2563b0", "#9333b0", "#8a6d1e", "#177a4a", "#c03050"],
  fwBg: i => `${["#2563b0", "#9333b0", "#8a6d1e", "#177a4a", "#c03050"][i % 5]}14`,
  fwBorder: i => `${["#2563b0", "#9333b0", "#8a6d1e", "#177a4a", "#c03050"][i % 5]}40`,
  sup: "#8a6d1e",
  supBg: "rgba(138,109,30,0.08)",
  red: "#c03030"
};
const useSWC = () => {
  const {
    theme
  } = useTheme();
  return theme === 'light' ? SWC_LIGHT : SWC_DARK;
};
/* Legacy alias — components that haven't migrated yet still read SWC */
let SWC = SWC_DARK;
const SwTag = ({
  color = SWC.muted,
  children,
  sm,
  mono,
  onClick,
  style: sx
}) => /*#__PURE__*/React.createElement("span", {
  onClick: onClick,
  style: {
    display: "inline-flex",
    alignItems: "center",
    padding: sm ? "1px 7px" : "2px 9px",
    fontSize: sm ? 11 : 12,
    fontWeight: 600,
    fontFamily: mono ? "var(--mono)" : "inherit",
    background: `${color}10`,
    border: `1px solid ${color}28`,
    borderRadius: 3,
    color,
    cursor: onClick ? "pointer" : "default",
    letterSpacing: "0.01em",
    lineHeight: "20px",
    whiteSpace: "nowrap",
    ...sx
  }
}, children);
const SwDot = ({
  color,
  size = 6
}) => /*#__PURE__*/React.createElement("span", {
  style: {
    width: size,
    height: size,
    borderRadius: "50%",
    background: color,
    display: "inline-block",
    flexShrink: 0
  }
});
const SwBtn = ({
  children,
  accent = SWC.given,
  ghost,
  disabled,
  onClick,
  style: sx
}) => /*#__PURE__*/React.createElement("button", {
  disabled: disabled,
  onClick: onClick,
  style: {
    padding: "8px 18px",
    borderRadius: 6,
    fontSize: 13,
    fontWeight: 600,
    fontFamily: "inherit",
    cursor: disabled ? "default" : "pointer",
    transition: "all 0.15s",
    opacity: disabled ? 0.4 : 1,
    border: ghost ? `1px solid ${accent}40` : `1px solid ${accent}`,
    background: ghost ? "transparent" : accent,
    color: ghost ? accent : SWC.bg,
    ...sx
  }
}, children);
const SwInput = ({
  value,
  onChange,
  placeholder,
  autoFocus,
  onKeyDown,
  style: sx
}) => /*#__PURE__*/React.createElement("input", {
  autoFocus: autoFocus,
  value: value,
  onChange: e => onChange(e.target.value),
  onKeyDown: onKeyDown,
  placeholder: placeholder,
  style: {
    width: "100%",
    padding: "10px 14px",
    borderRadius: 6,
    border: `1px solid ${SWC.border}`,
    background: SWC.surface,
    color: SWC.white,
    fontSize: 14,
    fontFamily: "inherit",
    outline: "none",
    boxSizing: "border-box",
    ...sx
  },
  onFocus: e => e.target.style.borderColor = SWC.borderLit,
  onBlur: e => e.target.style.borderColor = SWC.border
});
function SwMRow({
  opt,
  frameworks,
  getBindingCode,
  setBind,
  clearBind,
  hasConflict,
  isLast
}) {
  const [openCell, setOpenCell] = useState(null);
  return /*#__PURE__*/React.createElement("div", {
    style: {
      borderBottom: !isLast ? `1px solid ${SWC.border}` : "none"
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: "grid",
      gridTemplateColumns: `minmax(140px,180px) repeat(${frameworks.length}, 1fr)`
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: "10px 14px",
      fontSize: 14,
      color: SWC.white,
      fontWeight: 500,
      display: "flex",
      alignItems: "center",
      gap: 5
    }
  }, opt.label, hasConflict(opt) && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11
    }
  }, "\u26A1")), frameworks.map((fw, fi) => {
    const code = getBindingCode(opt.id, fw.id);
    const isOpen = openCell === fw.id;
    const hasCodes = fw.codes.length > 0;
    return /*#__PURE__*/React.createElement("div", {
      key: fw.id,
      onClick: () => {
        if (hasCodes) setOpenCell(isOpen ? null : fw.id);
      },
      style: {
        padding: "9px 10px",
        textAlign: "center",
        borderLeft: `1px solid ${SWC.border}`,
        cursor: hasCodes ? "pointer" : "default",
        transition: "background 0.1s",
        background: isOpen ? SWC.fwBg(fi) : "transparent"
      },
      onMouseEnter: e => {
        if (hasCodes && !isOpen) e.currentTarget.style.background = SWC.hover;
      },
      onMouseLeave: e => {
        if (!isOpen) e.currentTarget.style.background = isOpen ? SWC.fwBg(fi) : "transparent";
      }
    }, code ? /*#__PURE__*/React.createElement(SwTag, {
      color: SWC.fw[fi % 5],
      mono: true,
      style: {
        fontSize: 13
      }
    }, code.code) : hasCodes ? /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        color: SWC.dim
      }
    }, "\u2014") : /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11.5,
        color: SWC.dim
      }
    }, "no codes"));
  })), openCell && (() => {
    const fi = frameworks.findIndex(f => f.id === openCell);
    const fw = frameworks[fi];
    if (!fw) return null;
    const cur = getBindingCode(opt.id, fw.id);
    return /*#__PURE__*/React.createElement("div", {
      style: {
        padding: "8px 12px 10px",
        background: SWC.fwBg(fi),
        borderTop: `1px solid ${SWC.fwBorder(fi)}`
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 12,
        color: SWC.muted,
        marginBottom: 8,
        fontWeight: 600
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        color: SWC.fw[fi % 5]
      }
    }, fw.name), " reading for \"", opt.label, "\":"), /*#__PURE__*/React.createElement("div", {
      style: {
        display: "flex",
        flexWrap: "wrap",
        gap: 6
      }
    }, fw.codes.map(c => {
      const a = cur?.id === c.id;
      return /*#__PURE__*/React.createElement("div", {
        key: c.id,
        onClick: e => {
          e.stopPropagation();
          if (a) clearBind(opt.id, fw.id);else setBind(opt.id, c.id, fw.id);
          setOpenCell(null);
        },
        style: {
          padding: "6px 10px",
          borderRadius: 6,
          cursor: "pointer",
          transition: "all 0.12s",
          display: "flex",
          alignItems: "center",
          gap: 6,
          border: `1px solid ${a ? SWC.fw[fi % 5] : SWC.border}`,
          background: a ? `${SWC.fw[fi % 5]}18` : "transparent"
        },
        onMouseEnter: e => {
          e.currentTarget.style.borderColor = SWC.fw[fi % 5];
          if (!a) e.currentTarget.style.background = SWC.hover;
        },
        onMouseLeave: e => {
          e.currentTarget.style.borderColor = a ? SWC.fw[fi % 5] : SWC.border;
          e.currentTarget.style.background = a ? `${SWC.fw[fi % 5]}18` : "transparent";
        }
      }, /*#__PURE__*/React.createElement(SwTag, {
        color: SWC.fw[fi % 5],
        mono: true,
        sm: true
      }, c.code), /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 13,
          color: a ? SWC.white : SWC.text
        }
      }, c.label), a && /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 11.5,
          color: SWC.fw[fi % 5]
        }
      }, "\u2713"));
    })), cur && /*#__PURE__*/React.createElement("div", {
      onClick: e => {
        e.stopPropagation();
        clearBind(opt.id, fw.id);
        setOpenCell(null);
      },
      style: {
        fontSize: 12.5,
        color: SWC.dim,
        cursor: "pointer",
        marginTop: 8
      }
    }, "Clear"));
  })());
}

/* ═══════════════════ FORM BUILDER — Schema Builder UX ═══════════════════
 * The FormBuilder implements the ideated Schema Builder UX with two modes:
 *
 *   Compose mode — Google-Forms-like drag-and-drop question building.
 *     Questions are GIVEN (observations). Answer options describe observable things.
 *     The GIVEN test nudge guides users toward observation-quality questions.
 *
 *   Wire mode — Connect answer options to framework codes (GIVEN → MEANT).
 *     A wiring panel shows framework bindings with full provenance.
 *     Provenance dots (●/○/⚡) encode binding status at a glance.
 *
 * The five primitives: QUESTION → VALUE → CODE → FRAMEWORK → BINDING + CROSSWALK
 * ═══════════════════════════════════════════════════════════════════════════════ */

// GIVEN test: words that suggest interpretation rather than observation
const MEANT_SIGNAL_WORDS = ['category', 'classification', 'level', 'status', 'type', 'code', 'score', 'rating', 'rank', 'tier', 'class', 'grade', 'priority', 'eligibility', 'determination', 'assessment'];
const checkGivenTest = text => {
  const lower = text.toLowerCase();
  const found = MEANT_SIGNAL_WORDS.filter(w => lower.includes(w));
  return found.length > 0 ? found : null;
};
const suggestGivenRephrasing = text => {
  const lower = text.toLowerCase();
  if (lower.includes('homeless') && lower.includes('category')) return ['Where did you sleep last night?', 'Describe your current living situation.'];
  if (lower.includes('status')) return ['What is happening right now?', 'Describe the current situation.'];
  if (lower.includes('priority') || lower.includes('level')) return ['What did you observe?', 'Describe what you see.'];
  if (lower.includes('eligibility') || lower.includes('determination')) return ['What information was provided?', 'What was reported?'];
  if (lower.includes('assessment') || lower.includes('score')) return ['What did you observe during the interaction?', 'Describe the person\'s current condition.'];
  return ['Rephrase as something a person could answer from their own experience.'];
};
let _fbId = 5000;
const fbUid = () => `fb_${_fbId++}`;

/* ── Form key generation — creates a stable snake_case key from a name ── */
const formNameToKey = name => name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '').slice(0, 48) || 'unnamed_form';

/* ── Version diff — compares two form versions and returns structural changes ── */
const diffFormVersions = (oldForm, newForm) => {
  const changes = {
    added: [],
    removed: [],
    renamed: [],
    typeChanged: []
  };
  const oldQs = (oldForm?.sections || []).flatMap(s => s.questions || []);
  const newQs = (newForm?.sections || []).flatMap(s => s.questions || []);
  const oldById = Object.fromEntries(oldQs.map(q => [q.id, q]));
  const newById = Object.fromEntries(newQs.map(q => [q.id, q]));
  // Removed questions
  oldQs.forEach(oq => {
    if (!newById[oq.id]) changes.removed.push(oq);
  });
  // Added questions
  newQs.forEach(nq => {
    if (!oldById[nq.id]) changes.added.push(nq);
  });
  // Modified questions
  newQs.forEach(nq => {
    const oq = oldById[nq.id];
    if (!oq) return;
    if (oq.prompt !== nq.prompt) changes.renamed.push({
      old: oq,
      new: nq
    });
    if (oq.type !== nq.type) changes.typeChanged.push({
      old: oq,
      new: nq
    });
  });
  // Option-level changes
  const oldOpts = oldQs.flatMap(q => (q.options || []).map(o => ({
    ...o,
    questionId: q.id,
    questionPrompt: q.prompt
  })));
  const newOpts = newQs.flatMap(q => (q.options || []).map(o => ({
    ...o,
    questionId: q.id,
    questionPrompt: q.prompt
  })));
  const oldOptIds = new Set(oldOpts.map(o => o.id));
  const newOptIds = new Set(newOpts.map(o => o.id));
  changes.addedOptions = newOpts.filter(o => !oldOptIds.has(o.id));
  changes.removedOptions = oldOpts.filter(o => !newOptIds.has(o.id));
  return changes;
};

/* ── Progress Steps — visual workflow indicator ── */
const FB_STEPS = [
  { num: 1, label: 'Add questions', key: 'compose' },
  { num: 2, label: 'Wire to frameworks', key: 'wire' },
  { num: 3, label: 'Publish', key: 'preview' },
];
const ProgressSteps = ({ activeStep }) => /*#__PURE__*/React.createElement("div", {
  className: "fb-progress"
}, FB_STEPS.map((step, i) => /*#__PURE__*/React.createElement(React.Fragment, { key: step.key },
  /*#__PURE__*/React.createElement("div", {
    className: `fb-step${activeStep === step.key ? ' active' : ''}`
  }, /*#__PURE__*/React.createElement("span", { className: "fb-step-num" }, step.num),
  /*#__PURE__*/React.createElement("span", { className: "fb-step-label" }, step.label)),
  i < FB_STEPS.length - 1 && /*#__PURE__*/React.createElement("div", { className: "fb-step-line" })
)));

const FormBuilder = ({
  isOrg = false,
  fieldDefs: fbFieldDefs,
  catLabels: fbCatLabels,
  catColors: fbCatColors,
  onSaveFieldDef: fbOnSaveFieldDef,
  activeForm: fbActiveForm
}) => {
  SWC = useSWC();
  const [mode, setMode] = useState('compose'); // compose | wire | preview
  const [fieldPickerOpen, setFieldPickerOpen] = useState(false);
  const [fieldPickerSection, setFieldPickerSection] = useState(null); // section ID to add to
  const [forms, setForms] = useState([{
    id: fbUid(),
    name: 'New Form',
    key: 'new_form',
    description: '',
    status: 'draft',
    version: 1,
    versionHistory: [],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    maturity: 'draft',
    source: {
      level: isOrg ? 'org' : 'local',
      propagation: 'optional'
    },
    sections: [{
      id: fbUid(),
      title: 'General',
      questions: []
    }]
  }]);
  const [activeFormIdx, setActiveFormIdx] = useState(0);
  const [frameworks, setFrameworks] = useState([]);
  const [bindings, setBindings] = useState({}); // `${valueId}__${codeId}` → {t, method, confidence, notes}
  const [crosswalks, setCrosswalks] = useState([]);

  // ── Saved forms library ──
  const [savedForms, setSavedForms] = useState([]); // [{id, name, key, version, maturity, savedAt, form, frameworks, bindings, crosswalks}]
  const [showFormList, setShowFormList] = useState(false);
  const [saving, setSaving] = useState(false);

  // ── Versioning state ──
  const [showVersionHistory, setShowVersionHistory] = useState(false);
  const [showVersionBump, setShowVersionBump] = useState(false);
  const [versionNotes, setVersionNotes] = useState('');

  // ── Answer crosswalk state ──
  const [showAnswerCrosswalk, setShowAnswerCrosswalk] = useState(false);
  const [crosswalkSource, setCrosswalkSource] = useState(null); // saved form (old version) to map from
  const [answerMappings, setAnswerMappings] = useState({}); // oldOptionId → newOptionId

  // UI state
  const [editingFormName, setEditingFormName] = useState(false);
  const [addingSection, setAddingSection] = useState(false);
  const [addingQuestion, setAddingQuestion] = useState(null); // sectionId
  const [addingAnswer, setAddingAnswer] = useState(null); // questionId
  const [addingFw, setAddingFw] = useState(false);
  const [addingCode, setAddingCode] = useState(null); // frameworkId
  const [wiringValue, setWiringValue] = useState(null); // {question, value, sectionIdx}
  const [adoptingFw, setAdoptingFw] = useState(false);
  const [addingXW, setAddingXW] = useState(false);
  const [givenNudge, setGivenNudge] = useState(null); // {questionId, signals, suggestions}
  const [draft, setDraft] = useState('');
  const [draft2, setDraft2] = useState('');
  const [draft3, setDraft3] = useState('');
  const [expandedSections, setExpandedSections] = useState(new Set(['all']));
  const [xwFrom, setXwFrom] = useState('');
  const [xwTo, setXwTo] = useState('');
  const [xwType, setXwType] = useState('equivalent');
  const [xwNotes, setXwNotes] = useState('');
  const form = forms[activeFormIdx];

  // ── Derived data ──
  const allQuestions = form.sections.flatMap(s => s.questions);
  const allValues = allQuestions.flatMap(q => (q.options || []).map(o => ({
    ...o,
    questionId: q.id,
    questionPrompt: q.prompt
  })));
  const allCodes = frameworks.flatMap((f, fi) => f.codes.map(c => ({
    ...c,
    frameworkId: f.id,
    frameworkName: f.name,
    fwIdx: fi
  })));

  // ── Binding helpers ──
  const getBindingCode = (valId, fwId) => {
    const fw = frameworks.find(f => f.id === fwId);
    if (!fw) return null;
    for (const c of fw.codes) if (bindings[`${valId}__${c.id}`]) return c;
    return null;
  };
  const getBindingsForValue = valId => frameworks.map((f, fi) => {
    const c = getBindingCode(valId, f.id);
    return c ? {
      ...c,
      fwIdx: fi,
      frameworkName: f.name,
      frameworkId: f.id
    } : null;
  }).filter(Boolean);
  const getUnboundFrameworks = valId => frameworks.filter(f => !getBindingCode(valId, f.id));
  const hasConflict = valId => {
    const cs = getBindingsForValue(valId);
    return cs.length >= 2 && new Set(cs.map(c => c.label)).size > 1;
  };
  const getProvDotState = valId => {
    if (frameworks.length === 0) return 'none';
    const bound = getBindingsForValue(valId);
    if (bound.length === 0) return 'unbound';
    if (hasConflict(valId)) return 'conflict';
    return 'bound';
  };
  const doSetBind = (valId, codeId, fwId) => {
    const nb = {
      ...bindings
    };
    const fw = frameworks.find(f => f.id === fwId);
    if (fw) fw.codes.forEach(c => {
      delete nb[`${valId}__${c.id}`];
    });
    nb[`${valId}__${codeId}`] = {
      t: Date.now(),
      method: 'manual',
      confidence: 1.0
    };
    setBindings(nb);
  };
  const doClearBind = (valId, fwId) => {
    const nb = {
      ...bindings
    };
    const fw = frameworks.find(f => f.id === fwId);
    if (fw) fw.codes.forEach(c => {
      delete nb[`${valId}__${c.id}`];
    });
    setBindings(nb);
  };

  // ── Form mutation helpers ──
  const updateForm = fn => setForms(fs => fs.map((f, i) => i === activeFormIdx ? fn(f) : f));
  const updateSection = (secId, fn) => updateForm(f => ({
    ...f,
    sections: f.sections.map(s => s.id === secId ? fn(s) : s)
  }));
  const updateQuestion = (secId, qId, fn) => updateSection(secId, s => ({
    ...s,
    questions: s.questions.map(q => q.id === qId ? fn(q) : q)
  }));
  const doAddSection = () => {
    if (!draft.trim()) return;
    updateForm(f => ({
      ...f,
      sections: [...f.sections, {
        id: fbUid(),
        title: draft.trim(),
        questions: []
      }]
    }));
    setDraft('');
    setAddingSection(false);
  };
  const doAddQuestion = secId => {
    if (!draft.trim()) return;
    const prompt = draft.trim();
    const qId = fbUid();
    const signals = checkGivenTest(prompt);
    if (signals) {
      setGivenNudge({
        questionId: qId,
        signals,
        suggestions: suggestGivenRephrasing(prompt),
        originalPrompt: prompt,
        sectionId: secId
      });
    }
    updateSection(secId, s => ({
      ...s,
      questions: [...s.questions, {
        id: qId,
        prompt,
        type: draft2 || 'single_select',
        options: [],
        origin: isOrg ? 'org' : 'local',
        givenTestPassed: !signals,
        helpText: ''
      }]
    }));
    setDraft('');
    setDraft2('');
    setAddingQuestion(null);
  };

  // Insert a question from the field dictionary
  const doInsertFromDictionary = (fieldDef, secId) => {
    const qId = fbUid();
    const typeMap = { text: 'text', text_long: 'text', date: 'text', email: 'text', phone: 'text', address: 'text', number: 'numeric', single_select: 'single_select', multi_select: 'multi_select', boolean: 'single_select', document: 'text' };
    const qType = typeMap[fieldDef.data_type] || 'single_select';
    const options = qType === 'single_select' && fieldDef.data_type === 'boolean'
      ? [{ id: fbUid(), label: 'Yes' }, { id: fbUid(), label: 'No' }]
      : [];
    updateSection(secId, s => ({
      ...s,
      questions: [...s.questions, {
        id: qId,
        key: fieldDef.key,
        prompt: fieldDef.label,
        type: qType,
        options,
        origin: isOrg ? 'org' : 'local',
        givenTestPassed: true,
        helpText: fieldDef.definition || '',
        field_uri: fieldDef.uri
      }]
    }));
    setFieldPickerOpen(false);
    setFieldPickerSection(null);
  };
  const doAddAnswer = (secId, qId) => {
    if (!draft.trim()) return;
    updateQuestion(secId, qId, q => ({
      ...q,
      options: [...q.options, {
        id: fbUid(),
        label: draft.trim(),
        origin: isOrg ? 'org' : 'local'
      }]
    }));
    setDraft('');
  };
  const doRemoveQuestion = (secId, qId) => {
    updateSection(secId, s => ({
      ...s,
      questions: s.questions.filter(q => q.id !== qId)
    }));
  };
  const doRemoveAnswer = (secId, qId, valId) => {
    updateQuestion(secId, qId, q => ({
      ...q,
      options: q.options.filter(o => o.id !== valId)
    }));
    // Clean up bindings for removed value
    const nb = {
      ...bindings
    };
    Object.keys(nb).forEach(k => {
      if (k.startsWith(`${valId}__`)) delete nb[k];
    });
    setBindings(nb);
  };
  const doMoveQuestion = (secId, qIdx, dir) => {
    updateSection(secId, s => {
      const qs = [...s.questions];
      const newIdx = qIdx + dir;
      if (newIdx < 0 || newIdx >= qs.length) return s;
      [qs[qIdx], qs[newIdx]] = [qs[newIdx], qs[qIdx]];
      return {
        ...s,
        questions: qs
      };
    });
  };

  // ── Framework helpers ──
  const doAddFramework = () => {
    if (!draft.trim()) return;
    setFrameworks(fs => [...fs, {
      id: fbUid(),
      name: draft.trim(),
      fullName: draft2.trim() || null,
      authority: draft3.trim() || null,
      type: 'local',
      codes: [],
      adoptedAt: new Date().toISOString()
    }]);
    setDraft('');
    setDraft2('');
    setDraft3('');
    setAddingFw(false);
  };
  const doAddCode = fwId => {
    if (!draft.trim() || !draft2.trim()) return;
    setFrameworks(fs => fs.map(f => f.id === fwId ? {
      ...f,
      codes: [...f.codes, {
        id: fbUid(),
        code: draft.trim(),
        label: draft2.trim(),
        definition: draft3.trim() || null
      }]
    } : f));
    setDraft('');
    setDraft2('');
    setDraft3('');
  };

  // ── Auto-suggest bindings ──
  const autoSuggestBindings = fwId => {
    const fw = frameworks.find(f => f.id === fwId);
    if (!fw || fw.codes.length === 0) return [];
    const suggestions = [];
    allValues.forEach(val => {
      const valLower = val.label.toLowerCase();
      fw.codes.forEach(code => {
        const codeLower = code.label.toLowerCase();
        // Simple label similarity: check if they share significant words
        const valWords = valLower.split(/\s+/).filter(w => w.length > 2);
        const codeWords = codeLower.split(/\s+/).filter(w => w.length > 2);
        const shared = valWords.filter(w => codeWords.some(cw => cw.includes(w) || w.includes(cw)));
        if (shared.length > 0 || valLower.includes(codeLower) || codeLower.includes(valLower)) {
          const confidence = Math.min(0.95, 0.5 + shared.length * 0.15);
          if (!bindings[`${val.id}__${code.id}`]) {
            suggestions.push({
              valueId: val.id,
              valueLabel: val.label,
              codeId: code.id,
              codeLabel: code.label,
              codeValue: code.code,
              fwId,
              confidence
            });
          }
        }
      });
    });
    return suggestions;
  };
  const doAcceptSuggestion = suggestion => {
    const nb = {
      ...bindings
    };
    const fw = frameworks.find(f => f.id === suggestion.fwId);
    if (fw) fw.codes.forEach(c => {
      delete nb[`${suggestion.valueId}__${c.id}`];
    });
    nb[`${suggestion.valueId}__${suggestion.codeId}`] = {
      t: Date.now(),
      method: 'auto_suggested',
      confidence: suggestion.confidence
    };
    setBindings(nb);
  };
  const doAcceptAllSuggestions = suggestions => {
    const nb = {
      ...bindings
    };
    suggestions.forEach(s => {
      const fw = frameworks.find(f => f.id === s.fwId);
      if (fw) fw.codes.forEach(c => {
        delete nb[`${s.valueId}__${c.id}`];
      });
      nb[`${s.valueId}__${s.codeId}`] = {
        t: Date.now(),
        method: 'auto_suggested',
        confidence: s.confidence
      };
    });
    setBindings(nb);
  };

  // ── Crosswalk helpers ──
  const doAddXW = () => {
    if (!xwFrom || !xwTo) return;
    setCrosswalks(xws => [...xws, {
      id: fbUid(),
      fromCodeId: xwFrom,
      toCodeId: xwTo,
      type: xwType,
      notes: xwNotes
    }]);
    setAddingXW(false);
    setXwFrom('');
    setXwTo('');
    setXwType('equivalent');
    setXwNotes('');
  };

  // ── Form naming helpers ──
  const doRenameForm = newName => {
    const key = formNameToKey(newName);
    updateForm(f => ({
      ...f,
      name: newName.trim(),
      key,
      updatedAt: new Date().toISOString()
    }));
    setEditingFormName(false);
    setDraft('');
  };
  const doSetDescription = desc => {
    updateForm(f => ({
      ...f,
      description: desc,
      updatedAt: new Date().toISOString()
    }));
  };
  const doSetMaturity = maturity => {
    updateForm(f => ({
      ...f,
      maturity,
      updatedAt: new Date().toISOString()
    }));
  };
  const doSetPropagation = propagation => {
    updateForm(f => ({
      ...f,
      source: {
        ...(f.source || {}),
        propagation
      },
      updatedAt: new Date().toISOString()
    }));
  };

  // ── Save form to library ──
  const doSaveForm = () => {
    setSaving(true);
    const snapshot = {
      id: form.key + '_v' + form.version,
      formId: form.id,
      name: form.name,
      key: form.key,
      version: form.version,
      maturity: form.maturity,
      description: form.description,
      source: form.source,
      savedAt: new Date().toISOString(),
      form: JSON.parse(JSON.stringify(form)),
      frameworks: JSON.parse(JSON.stringify(frameworks)),
      bindings: JSON.parse(JSON.stringify(bindings)),
      crosswalks: JSON.parse(JSON.stringify(crosswalks))
    };
    // Replace existing save for same key+version, or append
    setSavedForms(prev => {
      const idx = prev.findIndex(s => s.key === snapshot.key && s.version === snapshot.version);
      if (idx >= 0) {
        const next = [...prev];
        next[idx] = snapshot;
        return next;
      }
      return [...prev, snapshot];
    });
    updateForm(f => ({
      ...f,
      updatedAt: new Date().toISOString(),
      status: 'saved'
    }));
    // Auto-register form fields into field dictionary
    if (fbOnSaveFieldDef && fbFieldDefs) {
      const allQs = form.sections.flatMap(s => s.questions || []);
      for (const q of allQs) {
        const fieldKey = q.key || formNameToKey(q.prompt);
        const uri = q.field_uri || `khora:form/${form.key}/${fieldKey}`;
        if (!fbFieldDefs[uri]) {
          const typeMap = { single_select: 'single_select', multi_select: 'multi_select', numeric: 'number', text: 'text' };
          const def = {
            uri,
            key: fieldKey,
            label: q.prompt,
            category: 'case',
            data_type: typeMap[q.type] || 'text',
            definition: q.helpText || `Data collected via form "${form.name}" — ${q.prompt}`,
            scope: null,
            sensitive: false,
            authority: null,
            version: 1,
            version_history: [],
            migration_rules: [],
            supersedes: null,
            superseded_by: null,
            created_by: 'form_builder',
            created_at: Date.now()
          };
          try { fbOnSaveFieldDef(def); } catch (e) { console.debug('Auto-register field:', e.message); }
        }
      }
    }
    setTimeout(() => setSaving(false), 600);
  };

  // ── Load form from library ──
  const doLoadForm = saved => {
    // Restore form into active slot
    setForms(fs => fs.map((f, i) => i === activeFormIdx ? {
      ...saved.form
    } : f));
    setFrameworks(saved.frameworks || []);
    setBindings(saved.bindings || {});
    setCrosswalks(saved.crosswalks || []);
    setShowFormList(false);
  };

  // ── New blank form ──
  const doNewForm = () => {
    const newForm = {
      id: fbUid(),
      name: 'Untitled Form',
      key: 'untitled_form',
      description: '',
      status: 'draft',
      version: 1,
      versionHistory: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      maturity: 'draft',
      source: {
        level: isOrg ? 'org' : 'local',
        propagation: 'optional'
      },
      sections: [{
        id: fbUid(),
        title: 'General',
        questions: []
      }]
    };
    setForms(fs => [...fs, newForm]);
    setActiveFormIdx(forms.length);
    setFrameworks([]);
    setBindings({});
    setCrosswalks([]);
    setShowFormList(false);
  };

  // ── Delete saved form ──
  const doDeleteSaved = savedId => {
    setSavedForms(prev => prev.filter(s => s.id !== savedId));
  };

  // ── Version bump ──
  const doVersionBump = bumpType => {
    // Save current as history entry before bumping
    const historyEntry = {
      version: form.version,
      name: form.name,
      snapshot: JSON.parse(JSON.stringify(form)),
      frameworks: JSON.parse(JSON.stringify(frameworks)),
      bindings: JSON.parse(JSON.stringify(bindings)),
      crosswalks: JSON.parse(JSON.stringify(crosswalks)),
      bumpedAt: new Date().toISOString(),
      notes: versionNotes || 'Version ' + form.version + ' snapshot'
    };
    const nextVersion = bumpType === 'major' ? Math.floor(form.version) + 1 : +(form.version + 0.1).toFixed(1);
    updateForm(f => ({
      ...f,
      version: nextVersion,
      versionHistory: [...(f.versionHistory || []), historyEntry],
      updatedAt: new Date().toISOString(),
      status: 'draft'
    }));
    setShowVersionBump(false);
    setVersionNotes('');
  };

  // ── Answer crosswalk — build mappings from old version to current ──
  const doStartAnswerCrosswalk = sourceVersion => {
    // sourceVersion is a history entry or a saved form
    const sourceForm = sourceVersion.snapshot || sourceVersion.form;
    setCrosswalkSource({
      ...sourceVersion,
      form: sourceForm
    });
    setAnswerMappings({});
    setShowAnswerCrosswalk(true);
  };
  const doSetAnswerMapping = (oldOptId, newOptId) => {
    setAnswerMappings(prev => {
      if (!newOptId) {
        const next = {
          ...prev
        };
        delete next[oldOptId];
        return next;
      }
      return {
        ...prev,
        [oldOptId]: newOptId
      };
    });
  };
  const doSaveAnswerCrosswalk = () => {
    // Save the mapping as a form-level crosswalk record
    const xwRecord = {
      id: fbUid(),
      type: 'answer_version_crosswalk',
      fromFormKey: form.key,
      fromVersion: crosswalkSource.version,
      toVersion: form.version,
      mappings: {
        ...answerMappings
      },
      createdAt: new Date().toISOString()
    };
    updateForm(f => ({
      ...f,
      answerCrosswalks: [...(f.answerCrosswalks || []), xwRecord],
      updatedAt: new Date().toISOString()
    }));
    setShowAnswerCrosswalk(false);
    setCrosswalkSource(null);
    setAnswerMappings({});
  };

  // ── Persist to Matrix schema room (if svc is available) ──
  const doPersistToSchema = async () => {
    if (!svc || !svc.userId) return;
    setSaving(true);
    try {
      // Find schema room from scanned rooms
      const rooms = svc._client?.getRooms?.() || [];
      let schemaRoomId = null;
      for (const r of rooms) {
        try {
          const idEvt = r.currentState?.getStateEvents?.(EVT.IDENTITY, '');
          if (idEvt && idEvt.getContent?.()?.account_type === 'schema') {
            schemaRoomId = r.roomId;
            break;
          }
        } catch (e) {/* skip */}
      }
      if (!schemaRoomId) {
        setSaving(false);
        return;
      }
      // Build the schema-compatible form object
      const schemaForm = {
        id: form.key || form.id,
        name: form.name,
        version: form.version,
        description: form.description || '',
        maturity: form.maturity || 'draft',
        source: form.source || {
          level: isOrg ? 'org' : 'local',
          propagation: 'optional'
        },
        versionHistory: (form.versionHistory || []).map(h => ({
          version: h.version,
          bumpedAt: h.bumpedAt,
          notes: h.notes
        })),
        answerCrosswalks: form.answerCrosswalks || [],
        fields: form.sections.flatMap(sec => sec.questions.map(q => ({
          id: q.id,
          key: formNameToKey(q.prompt),
          question: q.prompt,
          type: q.type,
          version: form.version,
          maturity: form.maturity || 'draft',
          section: sec.title,
          options: (q.options || []).map(o => ({
            v: formNameToKey(o.label),
            l: o.label,
            id: o.id
          })),
          category: formNameToKey(sec.title),
          sensitive: false,
          metrics: true
        }))),
        eo: {
          chain: [{
            op: 'DES',
            target: {
              entity: form.key,
              designation: form.name + ' Form'
            },
            frame: {
              type: 'schema',
              epistemic: 'GIVEN',
              role: isOrg ? 'org' : 'local'
            }
          }],
          trace: `${form.key} = DES (${isOrg ? 'org' : 'local'}-authored, ${form.source?.propagation || 'optional'} propagation)`
        },
        savedAt: new Date().toISOString()
      };
      await svc.setState(schemaRoomId, EVT.SCHEMA_FORM, schemaForm, schemaForm.id);
      updateForm(f => ({
        ...f,
        status: 'persisted',
        updatedAt: new Date().toISOString()
      }));
    } catch (e) {
      console.error('Failed to persist form to schema room:', e);
    }
    setSaving(false);
  };

  // ── Stats ──
  const totalBindings = Object.keys(bindings).length;
  const totalPossible = allValues.length * frameworks.length;
  const boundCount = allValues.filter(v => getBindingsForValue(v.id).length > 0).length;
  const conflictCount = allValues.filter(v => hasConflict(v.id)).length;
  const toggleSection = secId => {
    const next = new Set(expandedSections);
    if (next.has(secId) || next.has('all')) {
      next.delete(secId);
      next.delete('all');
    } else next.add(secId);
    setExpandedSections(next);
  };
  const isSectionExpanded = secId => expandedSections.has('all') || expandedSections.has(secId);
  return /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 960,
      margin: '0 auto'
    }
  },

  /* ── Row 1: Form name + badges + actions ── */
  /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 12,
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: { flex: 1, minWidth: 0 }
  }, editingFormName ? /*#__PURE__*/React.createElement("input", {
    className: "fb-form-name",
    autoFocus: true,
    value: draft,
    onChange: e => setDraft(e.target.value),
    placeholder: "Form name...",
    onKeyDown: e => {
      if (e.key === 'Enter' && draft.trim()) doRenameForm(draft);
      if (e.key === 'Escape') { setEditingFormName(false); setDraft(''); }
    },
    onBlur: () => { if (draft.trim()) doRenameForm(draft); else { setEditingFormName(false); setDraft(''); } }
  }) : /*#__PURE__*/React.createElement("span", {
    className: "fb-form-name",
    style: { cursor: 'pointer', display: 'inline-block' },
    onClick: () => { setDraft(form.name); setEditingFormName(true); },
    title: "Click to rename"
  }, form.name),
  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 8, marginTop: 4, flexWrap: 'wrap' }
  }, /*#__PURE__*/React.createElement(SwTag, {
    color: MATURITY_LEVELS[form.maturity]?.color === 'green' ? SWC.given : MATURITY_LEVELS[form.maturity]?.color === 'red' ? SWC.red : SWC.meant,
    sm: true
  }, MATURITY_LEVELS[form.maturity]?.label || 'Draft'), /*#__PURE__*/React.createElement("span", {
    style: { fontSize: 11, color: SWC.dim, fontFamily: 'var(--mono)', cursor: 'pointer', borderBottom: `1px dashed ${SWC.dim}` },
    onClick: () => setShowVersionBump(true),
    title: "Click to bump version"
  }, "v", form.version), form.status === 'persisted' && /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.given, sm: true
  }, "Saved"), /*#__PURE__*/React.createElement("span", {
    style: { fontSize: 11, color: SWC.dim, fontFamily: 'var(--mono)' }
  }, allQuestions.length, " question", allQuestions.length !== 1 ? 's' : '', " \xB7 ", allValues.length, " option", allValues.length !== 1 ? 's' : '', frameworks.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, " \xB7 ", frameworks.length, " fw"), totalBindings > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, " \xB7 ", totalBindings, " binding", totalBindings !== 1 ? 's' : ''), conflictCount > 0 && /*#__PURE__*/React.createElement("span", { style: { color: SWC.sup } }, " \xB7 ", conflictCount, " conflict", conflictCount !== 1 ? 's' : '')))),

  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 5, alignItems: 'center', flexShrink: 0 }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true, accent: SWC.muted, onClick: () => setShowFormList(true),
    style: { padding: '5px 10px', fontSize: 11 }
  }, /*#__PURE__*/React.createElement(I, { n: "folder", s: 11 }), " Library", savedForms.length > 0 && /*#__PURE__*/React.createElement("span", {
    style: { marginLeft: 4, fontFamily: 'var(--mono)', fontSize: 10 }
  }, savedForms.length)), /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true, accent: SWC.given, onClick: doSaveForm, disabled: saving,
    style: { padding: '5px 10px', fontSize: 11 }
  }, saving ? '...' : 'Save draft'), (form.versionHistory || []).length > 0 && /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true, accent: SWC.dim, onClick: () => setShowVersionHistory(true),
    style: { padding: '5px 10px', fontSize: 11 }
  }, "History"), /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true, accent: SWC.sup, onClick: doPersistToSchema, disabled: saving,
    style: { padding: '5px 10px', fontSize: 11 }, title: "Save to Matrix schema room"
  }, "Publish"))),

  /* ── Row 2: Progress steps + mode toggle ── */
  /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 16,
      padding: '10px 0',
      borderBottom: `1px solid ${SWC.border}`
    }
  }, /*#__PURE__*/React.createElement(ProgressSteps, { activeStep: mode }),
  /*#__PURE__*/React.createElement("div", {
    className: "fb-mode-toggle"
  }, /*#__PURE__*/React.createElement("button", {
    className: `fb-mode-btn ${mode === 'compose' ? 'active' : ''}`,
    onClick: () => setMode('compose')
  }, "\u270E Compose"), /*#__PURE__*/React.createElement("button", {
    className: `fb-mode-btn ${mode === 'wire' ? 'active' : ''}`,
    onClick: () => setMode('wire')
  }, "\u26A1 Wire", frameworks.length > 0 && totalPossible > 0 && /*#__PURE__*/React.createElement("span", {
    style: { fontSize: 10, color: totalBindings === totalPossible ? SWC.given : SWC.dim, fontFamily: 'var(--mono)' }
  }, totalBindings, "/", totalPossible)), /*#__PURE__*/React.createElement("button", {
    className: `fb-mode-btn ${mode === 'preview' ? 'active' : ''}`,
    onClick: () => setMode('preview')
  }, "\u25CE Preview"))), mode === 'compose' && /*#__PURE__*/React.createElement("div", {
    style: { maxWidth: 640, margin: '0 auto' }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      alignItems: 'center',
      marginBottom: 14,
      fontSize: 12
    }
  }, /*#__PURE__*/React.createElement("select", {
    value: form.maturity || 'draft',
    onChange: e => doSetMaturity(e.target.value),
    style: {
      padding: '5px 10px',
      borderRadius: 5,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      color: SWC.white,
      fontSize: 11,
      fontFamily: 'inherit'
    }
  }, Object.entries(MATURITY_LEVELS).map(([k, v]) => /*#__PURE__*/React.createElement("option", {
    key: k,
    value: k
  }, v.label))), /*#__PURE__*/React.createElement("select", {
    value: form.source?.propagation || 'optional',
    onChange: e => doSetPropagation(e.target.value),
    style: {
      padding: '5px 10px',
      borderRadius: 5,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      color: SWC.white,
      fontSize: 11,
      fontFamily: 'inherit'
    }
  }, Object.entries(PROPAGATION_LEVELS).map(([k, v]) => /*#__PURE__*/React.createElement("option", {
    key: k,
    value: k
  }, v.label))), /*#__PURE__*/React.createElement("input", {
    value: form.description || '',
    onChange: e => doSetDescription(e.target.value),
    placeholder: "Form description...",
    style: {
      flex: 1,
      padding: '5px 10px',
      borderRadius: 5,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      color: SWC.white,
      fontSize: 11,
      fontFamily: 'inherit'
    }
  })), form.sections.map((sec, secIdx) => /*#__PURE__*/React.createElement("div", {
    key: sec.id,
    className: "fb-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-section-header",
    onClick: () => toggleSection(sec.id)
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-section-title"
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: SWC.dim,
      transform: isSectionExpanded(sec.id) ? 'rotate(90deg)' : 'rotate(0)',
      transition: 'transform .15s',
      display: 'inline-block'
    }
  }, "\u25B6"), sec.title, /*#__PURE__*/React.createElement("span", {
    className: "fb-section-count"
  }, sec.questions.length, " question", sec.questions.length !== 1 ? 's' : '')), sec.origin === 'network' && /*#__PURE__*/React.createElement("span", {
    className: "fb-inherit-lock"
  }, "\uD83D\uDD12 Network"), sec.origin === 'local' && sec.questions.some(q => q.origin === 'local') && /*#__PURE__*/React.createElement("span", {
    className: "fb-inherit-local"
  }, "\uD83C\uDFE0 Local")), isSectionExpanded(sec.id) && /*#__PURE__*/React.createElement("div", null, sec.questions.map((q, qIdx) => /*#__PURE__*/React.createElement("div", {
    key: q.id,
    className: "fb-question"
  },
  /* ── Meta line: section · type · origin ── */
  /*#__PURE__*/React.createElement("div", {
    className: "fb-question-meta"
  }, /*#__PURE__*/React.createElement("span", null, sec.title), " \xB7 ", /*#__PURE__*/React.createElement("span", null,
    q.type === 'single_select' ? 'Single choice' : q.type === 'multi_select' ? 'Multi choice' : q.type === 'text' ? 'Free text' : q.type),
    q.origin === 'network' && /*#__PURE__*/React.createElement(SwTag, {
      color: SWC.given, sm: true,
      style: { marginLeft: 4, padding: '0 5px', fontSize: 9 }
    }, "Network"),
    q.origin === 'org' && /*#__PURE__*/React.createElement(SwTag, {
      color: SWC.meant, sm: true,
      style: { marginLeft: 4, padding: '0 5px', fontSize: 9 }
    }, "Org"),
    !q.givenTestPassed && /*#__PURE__*/React.createElement("span", {
      style: { fontSize: 11, color: SWC.sup, marginLeft: 4 },
      title: "This question may embed institutional interpretation"
    }, "\u26A0")),

  /* ── Question prompt ── */
  /*#__PURE__*/React.createElement("div", {
    className: "fb-question-prompt"
  }, /*#__PURE__*/React.createElement("span", null, q.prompt),
    q.field_uri && React.createElement("span", {
      className: "tag tag-teal", style: { fontSize: 8, marginLeft: 4 }, title: q.field_uri
    }, React.createElement(I, { n: 'grid', s: 8 }), ' Linked'),
    q.options?.some(o => hasConflict(o.id)) && /*#__PURE__*/React.createElement("span", {
      style: { fontSize: 11 }, title: "Framework conflict"
    }, "\u26A1")),

  /* ── Hover actions (move/delete) ── */
  /*#__PURE__*/React.createElement("div", {
    className: "fb-question-actions"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => doMoveQuestion(sec.id, qIdx, -1),
    disabled: qIdx === 0,
    style: { background: 'none', border: '1px solid ' + SWC.border, borderRadius: 4, color: SWC.dim,
      cursor: qIdx === 0 ? 'default' : 'pointer', padding: '2px 6px', fontSize: 11, opacity: qIdx === 0 ? 0.3 : 1 }
  }, "\u2191"), /*#__PURE__*/React.createElement("button", {
    onClick: () => doMoveQuestion(sec.id, qIdx, 1),
    disabled: qIdx === sec.questions.length - 1,
    style: { background: 'none', border: '1px solid ' + SWC.border, borderRadius: 4, color: SWC.dim,
      cursor: qIdx === sec.questions.length - 1 ? 'default' : 'pointer', padding: '2px 6px', fontSize: 11, opacity: qIdx === sec.questions.length - 1 ? 0.3 : 1 }
  }, "\u2193"), /*#__PURE__*/React.createElement("button", {
    onClick: () => doRemoveQuestion(sec.id, q.id),
    style: { background: 'none', border: '1px solid ' + SWC.border, borderRadius: 4, color: SWC.dim, cursor: 'pointer', padding: '2px 6px', fontSize: 11 },
    onMouseEnter: e => e.currentTarget.style.color = SWC.red,
    onMouseLeave: e => e.currentTarget.style.color = SWC.dim
  }, "\xD7")),

  /* ── Answer options ── */
  (q.type === 'single_select' || q.type === 'multi_select') && /*#__PURE__*/React.createElement("div", {
    className: "fb-answer-list"
  }, (q.options || []).map(opt => {
    const dotState = getProvDotState(opt.id);
    return /*#__PURE__*/React.createElement("div", {
      key: opt.id,
      className: "fb-answer",
      onClick: () => {
        if (frameworks.length > 0) {
          setWiringValue({ question: q, value: opt, sectionIdx: secIdx });
          setMode('wire');
        }
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: q.type === 'single_select' ? 'fb-answer-radio' : 'fb-answer-check'
    }), /*#__PURE__*/React.createElement("span", {
      className: "fb-answer-label"
    }, opt.label), /*#__PURE__*/React.createElement("div", {
      className: "fb-answer-dots"
    }, frameworks.map((fw, fi) => {
      const code = getBindingCode(opt.id, fw.id);
      const isConflict = hasConflict(opt.id);
      return /*#__PURE__*/React.createElement("span", {
        key: fw.id,
        className: `fb-prov-dot ${code ? isConflict ? 'conflict' : 'bound' : 'unbound'}`,
        title: code ? `${fw.name}: ${code.code} — ${code.label}${isConflict ? ' (conflict)' : ''}` : `${fw.name}: not bound`,
        style: code ? { background: SWC.fw[fi % 5] } : {}
      });
    })), /*#__PURE__*/React.createElement("button", {
      onClick: e => { e.stopPropagation(); doRemoveAnswer(sec.id, q.id, opt.id); },
      style: { background: 'none', border: 'none', color: SWC.dim, cursor: 'pointer', fontSize: 14, padding: '2px 4px', opacity: 0.5, transition: 'opacity .15s' },
      onMouseEnter: e => e.currentTarget.style.opacity = '1',
      onMouseLeave: e => e.currentTarget.style.opacity = '0.5'
    }, "\xD7"));
  }), addingAnswer === q.id ? /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 6, padding: '4px 10px', alignItems: 'center' }
  }, /*#__PURE__*/React.createElement(SwInput, {
    autoFocus: true, value: draft, onChange: setDraft,
    placeholder: "Answer option...",
    onKeyDown: e => {
      if (e.key === 'Enter') doAddAnswer(sec.id, q.id);
      if (e.key === 'Escape') { setAddingAnswer(null); setDraft(''); }
    },
    style: { padding: '6px 10px', fontSize: 13 }
  }), /*#__PURE__*/React.createElement(SwBtn, {
    onClick: () => doAddAnswer(sec.id, q.id), disabled: !draft.trim(),
    style: { padding: '5px 12px', fontSize: 11 }
  }, "Add"), /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true, accent: SWC.muted,
    onClick: () => { setAddingAnswer(null); setDraft(''); },
    style: { padding: '5px 8px', fontSize: 11 }
  }, "\xD7")) : /*#__PURE__*/React.createElement("button", {
    className: "fb-add-btn",
    onClick: () => { setAddingAnswer(q.id); setDraft(''); }
  }, "+ Add answer option")),

  /* ── Bottom bar: source + wire link ── */
  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginTop: 8 }
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-source-tag"
  }, q.origin === 'network' ? 'Source: Network (required)' : q.origin === 'org' ? 'Source: Organization' : 'Source: Local', !q.givenTestPassed && /*#__PURE__*/React.createElement("span", {
    style: { color: SWC.sup, fontSize: 10 }
  }, "MEANT-origin")), frameworks.length > 0 && q.options?.length > 0 && /*#__PURE__*/React.createElement("button", {
    className: "fb-wire-btn",
    onClick: () => { setWiringValue({ question: q, value: q.options[0], sectionIdx: secIdx }); setMode('wire'); }
  }, "Wire to frameworks \u2192"))))), addingQuestion === sec.id ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '14px 18px',
      borderTop: sec.questions.length > 0 ? `1px solid ${SWC.border}` : 'none'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      fontWeight: 600,
      color: SWC.given,
      marginBottom: 8
    }
  }, "New Question"), /*#__PURE__*/React.createElement(SwInput, {
    autoFocus: true,
    value: draft,
    onChange: v => {
      setDraft(v);
      setGivenNudge(null);
    },
    placeholder: "Type your question...",
    onKeyDown: e => {
      if (e.key === 'Enter' && draft.trim()) {
        doAddQuestion(sec.id);
      }
      if (e.key === 'Escape') {
        setAddingQuestion(null);
        setDraft('');
        setDraft2('');
        setGivenNudge(null);
      }
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      marginTop: 8,
      alignItems: 'center'
    }
  }, /*#__PURE__*/React.createElement("select", {
    value: draft2 || 'single_select',
    onChange: e => setDraft2(e.target.value),
    style: {
      padding: '7px 10px',
      borderRadius: 6,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      color: SWC.white,
      fontSize: 12,
      fontFamily: 'inherit'
    }
  }, /*#__PURE__*/React.createElement("option", {
    value: "single_select"
  }, "Single select"), /*#__PURE__*/React.createElement("option", {
    value: "multi_select"
  }, "Multi select"), /*#__PURE__*/React.createElement("option", {
    value: "text"
  }, "Text"), /*#__PURE__*/React.createElement("option", {
    value: "number"
  }, "Number"), /*#__PURE__*/React.createElement("option", {
    value: "date"
  }, "Date"), /*#__PURE__*/React.createElement("option", {
    value: "duration"
  }, "Duration"), /*#__PURE__*/React.createElement("option", {
    value: "boolean"
  }, "Yes/No"), /*#__PURE__*/React.createElement("option", {
    value: "scale"
  }, "Scale")), /*#__PURE__*/React.createElement(SwBtn, {
    onClick: () => doAddQuestion(sec.id),
    disabled: !draft.trim()
  }, "Create"), /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => {
      setAddingQuestion(null);
      setDraft('');
      setDraft2('');
      setGivenNudge(null);
    }
  }, "Cancel")), draft.trim() && checkGivenTest(draft) && /*#__PURE__*/React.createElement("div", {
    className: "fb-nudge"
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-nudge-title"
  }, /*#__PURE__*/React.createElement(I, {
    n: "alert",
    s: 12,
    c: SWC.fw[0]
  }), "This question may embed institutional interpretation"), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 6
    }
  }, "Detected signal words: ", checkGivenTest(draft).map(w => /*#__PURE__*/React.createElement(SwTag, {
    key: w,
    color: SWC.sup,
    sm: true,
    style: {
      marginRight: 4
    }
  }, w))), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12.5,
      color: SWC.dim,
      marginBottom: 6
    }
  }, "Consider rephrasing as something a person could answer without institutional knowledge:"), suggestGivenRephrasing(draft).map((sug, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "fb-nudge-suggestion",
    onClick: () => setDraft(sug)
  }, sug)), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 8,
      fontSize: 12,
      color: SWC.dim
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      cursor: 'pointer',
      textDecoration: 'underline'
    },
    onClick: () => setGivenNudge(null)
  }, "Keep as-is"), " \u2014 the question will be tagged as MEANT-origin."))) : /*#__PURE__*/React.createElement("button", {
    className: "fb-add-btn",
    style: {
      borderTop: sec.questions.length > 0 ? `1px solid ${SWC.border}` : 'none'
    },
    onClick: () => {
      setAddingQuestion(sec.id);
      setDraft('');
      setDraft2('');
    }
  }, "+ Add question"),
    fbFieldDefs && Object.keys(fbFieldDefs).length > 0 && React.createElement('button', {
      className: 'fb-add-btn',
      style: { color: 'var(--teal)', fontSize: 12, borderTop: 'none', paddingTop: 0 },
      onClick: () => { setFieldPickerSection(sec.id); setFieldPickerOpen(true); }
    }, React.createElement(I, { n: 'grid', s: 11, c: 'var(--teal)' }), ' Insert from field dictionary'),
    fieldPickerOpen && fieldPickerSection === sec.id && React.createElement(FieldPicker, {
      open: true,
      onClose: () => { setFieldPickerOpen(false); setFieldPickerSection(null); },
      onSelect: fd => doInsertFromDictionary(fd, sec.id),
      fieldDefs: fbFieldDefs,
      catLabels: fbCatLabels,
      catColors: fbCatColors
    })
  ))), addingSection ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: 16,
      border: `1px solid ${SWC.border}`,
      borderRadius: 8,
      background: SWC.surface,
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      fontWeight: 600,
      color: SWC.white,
      marginBottom: 8
    }
  }, "New Section"), /*#__PURE__*/React.createElement(SwInput, {
    autoFocus: true,
    value: draft,
    onChange: setDraft,
    placeholder: "Section title...",
    onKeyDown: e => {
      if (e.key === 'Enter') doAddSection();
      if (e.key === 'Escape') {
        setAddingSection(false);
        setDraft('');
      }
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      marginTop: 8
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    onClick: doAddSection,
    disabled: !draft.trim()
  }, "Create"), /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => {
      setAddingSection(false);
      setDraft('');
    }
  }, "Cancel"))) : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("button", {
    className: "fb-add-btn",
    style: {
      border: `1px dashed ${SWC.border}`,
      borderRadius: 8,
      justifyContent: 'center'
    },
    onClick: () => {
      setAddingSection(true);
      setDraft('');
    }
  }, "+ Add section")), frameworks.length > 0 && allValues.length > 0 && (() => {
    const unboundCount = allValues.filter(v => getBindingsForValue(v.id).length === 0).length;
    return unboundCount > 0 ? /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '12px 16px',
        borderRadius: 8,
        border: `1px solid ${SWC.meantBorder}`,
        background: 'rgba(167,139,250,0.04)',
        fontSize: 13,
        color: SWC.muted,
        lineHeight: 1.6,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between'
      }
    }, /*#__PURE__*/React.createElement("span", null, unboundCount, " answer option", unboundCount !== 1 ? 's aren\'t' : ' isn\'t', " connected to any framework yet."), /*#__PURE__*/React.createElement("button", {
      className: "fb-wire-btn",
      onClick: () => setMode('wire')
    }, "Wire them \u2192")) : null;
  })(), frameworks.length === 0 && allValues.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '14px 18px',
      borderRadius: 8,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      fontSize: 13,
      color: SWC.muted,
      lineHeight: 1.6
    }
  }, "This form collects observations without connecting them to any reporting framework. You can add framework bindings anytime.", /*#__PURE__*/React.createElement("button", {
    className: "fb-wire-btn",
    style: {
      marginLeft: 8
    },
    onClick: () => {
      setMode('wire');
      setAddingFw(true);
      setDraft('');
      setDraft2('');
      setDraft3('');
    }
  }, "+ Add a framework"))), givenNudge && mode === 'compose' && /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'fixed',
      bottom: 24,
      right: 24,
      zIndex: 45,
      width: 380,
      background: SWC.surface,
      border: `1px solid ${SWC.fw[0]}40`,
      borderRadius: 10,
      padding: 16,
      boxShadow: '0 8px 32px rgba(0,0,0,0.4)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      fontWeight: 600,
      color: SWC.fw[0],
      marginBottom: 6
    }
  }, "GIVEN Test Result"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      color: SWC.text,
      marginBottom: 8
    }
  }, "\"", givenNudge.originalPrompt, "\" contains interpretation-language: ", givenNudge.signals.join(', ')), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12,
      color: SWC.dim,
      marginBottom: 8
    }
  }, "The question was created but tagged as MEANT-origin. You can rephrase it anytime."), /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => setGivenNudge(null),
    style: {
      fontSize: 12,
      padding: '5px 12px'
    }
  }, "Dismiss")), mode === 'wire' && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6,
      alignItems: 'center',
      flexWrap: 'wrap'
    }
  }, frameworks.map((fw, fi) => /*#__PURE__*/React.createElement("div", {
    key: fw.id,
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4,
      padding: '4px 10px',
      borderRadius: 5,
      border: `1px solid ${SWC.fw[fi % 5]}40`,
      background: `${SWC.fw[fi % 5]}10`,
      fontSize: 12,
      fontWeight: 600,
      color: SWC.fw[fi % 5]
    }
  }, /*#__PURE__*/React.createElement(SwDot, {
    color: SWC.fw[fi % 5],
    size: 6
  }), " ", fw.name, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: SWC.dim,
      marginLeft: 4
    }
  }, fw.codes.length, "c"))), frameworks.length === 0 && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      color: SWC.dim
    }
  }, "No frameworks adopted yet.")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.meant,
    onClick: () => {
      setAddingFw(true);
      setDraft('');
      setDraft2('');
      setDraft3('');
    }
  }, "+ Add framework"), allValues.length > 0 && frameworks.length > 0 && /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.given,
    onClick: () => setAdoptingFw(true)
  }, "Auto-suggest bindings"))), addingFw && /*#__PURE__*/React.createElement("div", {
    style: {
      border: `1px solid ${SWC.meantBorder}`,
      borderRadius: 10,
      background: SWC.surface,
      padding: 16,
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 15,
      fontWeight: 600,
      color: SWC.meant,
      marginBottom: 12
    }
  }, "Adopt a Reporting Framework"), /*#__PURE__*/React.createElement(SwInput, {
    autoFocus: true,
    value: draft,
    onChange: setDraft,
    placeholder: "Short name (e.g. HUD HMIS, CoC Priority)",
    onKeyDown: e => {
      if (e.key === 'Enter' && draft.trim()) doAddFramework();
      if (e.key === 'Escape') {
        setAddingFw(false);
        setDraft('');
        setDraft2('');
        setDraft3('');
      }
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 8
    }
  }, /*#__PURE__*/React.createElement(SwInput, {
    value: draft2,
    onChange: setDraft2,
    placeholder: "Full name (optional)",
    onKeyDown: e => {
      if (e.key === 'Enter' && draft.trim()) doAddFramework();
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 8
    }
  }, /*#__PURE__*/React.createElement(SwInput, {
    value: draft3,
    onChange: setDraft3,
    placeholder: "Governing authority (optional)",
    onKeyDown: e => {
      if (e.key === 'Enter' && draft.trim()) doAddFramework();
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      color: SWC.dim,
      marginTop: 8,
      lineHeight: 1.55
    }
  }, "A framework defines institutional categories (MEANT). Add its codes after creation."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      marginTop: 12
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    accent: SWC.meant,
    onClick: doAddFramework,
    disabled: !draft.trim()
  }, "Adopt"), /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => {
      setAddingFw(false);
      setDraft('');
      setDraft2('');
      setDraft3('');
    }
  }, "Cancel"))), allValues.length > 0 && frameworks.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.08em',
      color: SWC.muted
    }
  }, "Binding Matrix"), /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.meant,
    sm: true
  }, "GIVEN \u2192 MEANT")), form.sections.map(sec => sec.questions.filter(q => q.options && q.options.length > 0).map(q => /*#__PURE__*/React.createElement("div", {
    key: q.id,
    style: {
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 14,
      fontWeight: 600,
      color: SWC.white,
      marginBottom: 6,
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, q.prompt, q.options.some(o => hasConflict(o.id)) && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11
    }
  }, "\u26A1")), /*#__PURE__*/React.createElement("div", {
    style: {
      border: `1px solid ${SWC.border}`,
      borderRadius: 8,
      overflow: 'hidden',
      background: SWC.surface
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: `minmax(140px,200px) repeat(${frameworks.length}, 1fr)`,
      borderBottom: `1px solid ${SWC.border}`,
      background: SWC.raised
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 12px',
      fontSize: 11,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.06em',
      color: SWC.dim
    }
  }, "Value"), frameworks.map((fw, fi) => /*#__PURE__*/React.createElement("div", {
    key: fw.id,
    style: {
      padding: '8px 10px',
      fontSize: 11,
      fontWeight: 600,
      color: SWC.fw[fi % 5],
      textAlign: 'center',
      borderLeft: `1px solid ${SWC.border}`,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(SwDot, {
    color: SWC.fw[fi % 5],
    size: 5
  }), fw.name))), q.options.map((opt, oi) => /*#__PURE__*/React.createElement(SwMRow, {
    key: opt.id,
    opt: opt,
    frameworks: frameworks,
    getBindingCode: getBindingCode,
    setBind: doSetBind,
    clearBind: doClearBind,
    hasConflict: o => hasConflict(o.id),
    isLast: oi === q.options.length - 1
  }))))))), frameworks.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.08em',
      color: SWC.muted,
      marginBottom: 10
    }
  }, "Framework Codes"), frameworks.map((fw, fi) => /*#__PURE__*/React.createElement("div", {
    key: fw.id,
    style: {
      border: `1px solid ${SWC.border}`,
      borderRadius: 8,
      background: SWC.surface,
      marginBottom: 8,
      overflow: 'hidden'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 14px',
      borderBottom: `1px solid ${SWC.border}`,
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(SwDot, {
    color: SWC.fw[fi % 5],
    size: 8
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 14,
      fontWeight: 600,
      color: SWC.fw[fi % 5]
    }
  }, fw.name), fw.fullName && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: SWC.dim
    }
  }, "\u2014 ", fw.fullName), fw.authority && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: SWC.dim,
      marginLeft: 'auto'
    }
  }, "Authority: ", fw.authority), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: SWC.dim,
      marginLeft: fw.authority ? 8 : 'auto'
    }
  }, fw.codes.length, " code", fw.codes.length !== 1 ? 's' : '')), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '4px 6px'
    }
  }, fw.codes.map(c => /*#__PURE__*/React.createElement("div", {
    key: c.id,
    style: {
      padding: '5px 10px',
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.fw[fi % 5],
    sm: true,
    mono: true
  }, c.code), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      color: SWC.text
    }
  }, c.label), c.definition && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: SWC.dim,
      marginLeft: 'auto'
    }
  }, c.definition))), addingCode === fw.id ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '4px 8px'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6,
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement(SwInput, {
    autoFocus: true,
    value: draft,
    onChange: setDraft,
    placeholder: "Code (e.g. Cat-1)",
    onKeyDown: e => {
      if (e.key === 'Escape') {
        setAddingCode(null);
        setDraft('');
        setDraft2('');
        setDraft3('');
      }
    },
    style: {
      padding: '5px 10px',
      fontSize: 12,
      width: 100,
      flex: 'none'
    }
  }), /*#__PURE__*/React.createElement(SwInput, {
    value: draft2,
    onChange: setDraft2,
    placeholder: "Label",
    onKeyDown: e => {
      if (e.key === 'Enter' && draft.trim() && draft2.trim()) {
        doAddCode(fw.id);
      } else if (e.key === 'Escape') {
        setAddingCode(null);
        setDraft('');
        setDraft2('');
        setDraft3('');
      }
    },
    style: {
      padding: '5px 10px',
      fontSize: 12
    }
  })), /*#__PURE__*/React.createElement(SwInput, {
    value: draft3,
    onChange: setDraft3,
    placeholder: "Definition (optional)",
    style: {
      padding: '5px 10px',
      fontSize: 12,
      marginBottom: 6
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    accent: SWC.meant,
    onClick: () => doAddCode(fw.id),
    disabled: !draft.trim() || !draft2.trim(),
    style: {
      padding: '5px 12px',
      fontSize: 11
    }
  }, "Add"), /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => {
      setAddingCode(null);
      setDraft('');
      setDraft2('');
      setDraft3('');
    },
    style: {
      padding: '5px 8px',
      fontSize: 11
    }
  }, "\xD7"))) : /*#__PURE__*/React.createElement("div", {
    onClick: () => {
      setAddingCode(fw.id);
      setDraft('');
      setDraft2('');
      setDraft3('');
    },
    style: {
      padding: '8px 12px',
      fontSize: 13,
      color: SWC.fw[fi % 5],
      cursor: 'pointer'
    }
  }, "+ Add code"))))), frameworks.length >= 2 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.08em',
      color: SWC.muted
    }
  }, "Crosswalks"), /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.meant,
    sm: true
  }, "MEANT \u2194 MEANT")), allCodes.length >= 2 && /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.meant,
    onClick: () => setAddingXW(true)
  }, "+ Add crosswalk")), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      color: SWC.dim,
      marginBottom: 10,
      lineHeight: 1.55
    }
  }, "Crosswalks translate between frameworks \u2014 how one institution's codes map to another's."), addingXW && /*#__PURE__*/React.createElement("div", {
    style: {
      border: `1px solid ${SWC.meantBorder}`,
      borderRadius: 10,
      background: SWC.surface,
      padding: 16,
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 15,
      fontWeight: 600,
      color: SWC.meant,
      marginBottom: 12
    }
  }, "New Crosswalk"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      marginBottom: 8
    }
  }, /*#__PURE__*/React.createElement("select", {
    value: xwFrom,
    onChange: e => setXwFrom(e.target.value),
    style: {
      flex: 1,
      padding: '7px 10px',
      borderRadius: 6,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      color: SWC.white,
      fontSize: 12,
      fontFamily: 'inherit'
    }
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "From code..."), allCodes.map(c => /*#__PURE__*/React.createElement("option", {
    key: c.id,
    value: c.id
  }, c.frameworkName, ": ", c.code, " \u2014 ", c.label))), /*#__PURE__*/React.createElement("select", {
    value: xwTo,
    onChange: e => setXwTo(e.target.value),
    style: {
      flex: 1,
      padding: '7px 10px',
      borderRadius: 6,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      color: SWC.white,
      fontSize: 12,
      fontFamily: 'inherit'
    }
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "To code..."), allCodes.filter(c => c.id !== xwFrom).map(c => /*#__PURE__*/React.createElement("option", {
    key: c.id,
    value: c.id
  }, c.frameworkName, ": ", c.code, " \u2014 ", c.label)))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6,
      marginBottom: 8
    }
  }, ['equivalent', 'implies', 'overlaps', 'conflicts'].map(t => /*#__PURE__*/React.createElement(SwTag, {
    key: t,
    color: xwType === t ? t === 'conflicts' ? SWC.sup : t === 'equivalent' ? SWC.given : SWC.meant : SWC.dim,
    onClick: () => setXwType(t),
    sm: true,
    style: {
      cursor: 'pointer',
      padding: '3px 8px',
      fontSize: 11
    }
  }, t))), /*#__PURE__*/React.createElement(SwInput, {
    value: xwNotes,
    onChange: setXwNotes,
    placeholder: "Notes (optional)",
    style: {
      marginBottom: 10
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    accent: SWC.meant,
    onClick: doAddXW,
    disabled: !xwFrom || !xwTo
  }, "Create"), /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => {
      setAddingXW(false);
      setXwFrom('');
      setXwTo('');
      setXwNotes('');
    }
  }, "Cancel"))), crosswalks.length === 0 && !addingXW ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: 20,
      border: `1px dashed ${SWC.border}`,
      borderRadius: 8,
      textAlign: 'center',
      color: SWC.dim,
      fontSize: 13
    }
  }, allCodes.length < 2 ? 'Need codes in at least two frameworks.' : 'No crosswalks yet.') : crosswalks.map(xw => {
    const from = allCodes.find(c => c.id === xw.fromCodeId);
    const to = allCodes.find(c => c.id === xw.toCodeId);
    if (!from || !to) return null;
    return /*#__PURE__*/React.createElement("div", {
      key: xw.id,
      style: {
        border: `1px solid ${SWC.border}`,
        borderRadius: 8,
        background: SWC.surface,
        padding: '10px 14px',
        marginBottom: 6
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        flexWrap: 'wrap',
        marginBottom: xw.notes ? 6 : 0
      }
    }, /*#__PURE__*/React.createElement(SwDot, {
      color: SWC.fw[from.fwIdx % 5],
      size: 6
    }), /*#__PURE__*/React.createElement(SwTag, {
      color: SWC.fw[from.fwIdx % 5],
      sm: true
    }, from.frameworkName, ": ", from.code), /*#__PURE__*/React.createElement("span", {
      style: {
        color: SWC.dim,
        fontSize: 13
      }
    }, xw.type === 'equivalent' ? '=' : xw.type === 'implies' ? '→' : xw.type === 'overlaps' ? '↔' : '⚡'), /*#__PURE__*/React.createElement(SwDot, {
      color: SWC.fw[to.fwIdx % 5],
      size: 6
    }), /*#__PURE__*/React.createElement(SwTag, {
      color: SWC.fw[to.fwIdx % 5],
      sm: true
    }, to.frameworkName, ": ", to.code), /*#__PURE__*/React.createElement(SwTag, {
      color: xw.type === 'conflicts' ? SWC.sup : xw.type === 'equivalent' ? SWC.given : SWC.meant,
      sm: true
    }, xw.type)), xw.notes && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 13,
        color: SWC.text,
        lineHeight: 1.55
      }
    }, xw.notes));
  })), allValues.length === 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: 32,
      border: `1px dashed ${SWC.border}`,
      borderRadius: 8,
      textAlign: 'center',
      color: SWC.dim,
      fontSize: 14
    }
  }, "Add questions with answer options first, then wire them to frameworks here.", /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 12
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.given,
    onClick: () => setMode('compose')
  }, "\u2190 Back to Compose")))), wiringValue && /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'fixed',
      inset: 0,
      zIndex: 39
    },
    onClick: () => setWiringValue(null)
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-wire-panel",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-wire-panel-header"
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.given,
    sm: true
  }, "GIVEN"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      color: SWC.muted,
      marginTop: 6
    }
  }, wiringValue.question.prompt), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 20,
      fontWeight: 700,
      color: SWC.white,
      marginTop: 3
    }
  }, wiringValue.value.label)), /*#__PURE__*/React.createElement("button", {
    onClick: () => setWiringValue(null),
    style: {
      background: 'none',
      border: 'none',
      color: SWC.muted,
      cursor: 'pointer',
      fontSize: 20,
      padding: 4
    }
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 8,
      fontSize: 12,
      color: SWC.dim
    }
  }, "This is an observation (GIVEN). Below are its interpretations across active frameworks (MEANT).")), /*#__PURE__*/React.createElement("div", {
    className: "fb-wire-panel-body"
  }, frameworks.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: 24,
      textAlign: 'center',
      color: SWC.dim,
      fontSize: 13
    }
  }, "No frameworks adopted yet.", /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 10
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    accent: SWC.meant,
    onClick: () => {
      setAddingFw(true);
      setDraft('');
      setDraft2('');
      setDraft3('');
    }
  }, "+ Adopt a framework"))) : /*#__PURE__*/React.createElement(React.Fragment, null, frameworks.map((fw, fi) => {
    const code = getBindingCode(wiringValue.value.id, fw.id);
    const binding = code ? bindings[`${wiringValue.value.id}__${code.id}`] : null;
    return /*#__PURE__*/React.createElement("div", {
      key: fw.id,
      className: "fb-wire-fw-card",
      style: {
        borderColor: code ? `${SWC.fw[fi % 5]}40` : undefined
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "fb-wire-fw-card-header"
    }, /*#__PURE__*/React.createElement(SwDot, {
      color: SWC.fw[fi % 5],
      size: 10
    }), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 14,
        fontWeight: 600,
        color: SWC.fw[fi % 5]
      }
    }, fw.name), fw.fullName && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 11,
        color: SWC.dim
      }
    }, fw.fullName)), code ? /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement(SwTag, {
      color: SWC.fw[fi % 5],
      mono: true
    }, code.code), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        fontWeight: 500,
        color: SWC.white
      }
    }, code.label), /*#__PURE__*/React.createElement("span", {
      className: `fb-prov-dot ${hasConflict(wiringValue.value.id) ? 'conflict' : 'bound'}`,
      style: {
        background: hasConflict(wiringValue.value.id) ? undefined : SWC.fw[fi % 5]
      }
    })) : /*#__PURE__*/React.createElement("span", {
      className: "fb-prov-dot unbound"
    })), /*#__PURE__*/React.createElement("div", {
      className: "fb-wire-fw-card-body"
    }, code && binding && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 12,
        color: SWC.dim,
        marginBottom: 8
      }
    }, "Bound via: ", binding.method === 'auto_suggested' ? 'auto-suggested' : 'manual', " \xB7 Confidence: ", Math.round((binding.confidence || 1) * 100), "% \xB7 ", new Date(binding.t).toLocaleDateString()), code && code.definition && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 12,
        color: SWC.text,
        marginBottom: 8,
        padding: '6px 10px',
        background: SWC.raised,
        borderRadius: 4
      }
    }, code.definition), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 12,
        color: SWC.muted,
        marginBottom: 6,
        fontWeight: 600
      }
    }, "Select a code:"), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        flexDirection: 'column',
        gap: 4
      }
    }, fw.codes.map(c => {
      const isActive = code?.id === c.id;
      return /*#__PURE__*/React.createElement("div", {
        key: c.id,
        className: `fb-wire-code-option ${isActive ? 'selected' : ''}`,
        onClick: () => {
          if (isActive) doClearBind(wiringValue.value.id, fw.id);else doSetBind(wiringValue.value.id, c.id, fw.id);
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          width: 16,
          height: 16,
          borderRadius: 8,
          border: `2px solid ${isActive ? SWC.fw[fi % 5] : SWC.border}`,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          flexShrink: 0
        }
      }, isActive && /*#__PURE__*/React.createElement("div", {
        style: {
          width: 8,
          height: 8,
          borderRadius: 4,
          background: SWC.fw[fi % 5]
        }
      })), /*#__PURE__*/React.createElement(SwTag, {
        color: SWC.fw[fi % 5],
        mono: true,
        sm: true
      }, c.code), /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 13,
          color: isActive ? SWC.white : SWC.text
        }
      }, c.label), isActive && /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 11,
          color: SWC.fw[fi % 5],
          marginLeft: 'auto'
        }
      }, "\u2713 bound"));
    })), fw.codes.length === 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 12,
        color: SWC.dim,
        padding: '8px 0'
      }
    }, "No codes yet."), code && /*#__PURE__*/React.createElement("div", {
      onClick: () => doClearBind(wiringValue.value.id, fw.id),
      style: {
        fontSize: 12,
        color: SWC.dim,
        cursor: 'pointer',
        marginTop: 8
      },
      onMouseEnter: e => e.currentTarget.style.color = SWC.red,
      onMouseLeave: e => e.currentTarget.style.color = SWC.dim
    }, "Clear binding")));
  }), hasConflict(wiringValue.value.id) && /*#__PURE__*/React.createElement("div", {
    className: "fb-wire-conflict"
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      color: SWC.sup,
      fontWeight: 600
    }
  }, "\u26A1 Superposition \u2014 "), "Frameworks disagree about what \"", wiringValue.value.label, "\" means. This isn't an error \u2014 it's data about how institutions see differently.", /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 8,
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: SWC.muted,
      cursor: 'pointer'
    },
    onClick: () => {
      setWiringValue(null);
      setAddingXW(true);
    }
  }, "Document in crosswalks \u2192"))), /*#__PURE__*/React.createElement("div", {
    className: "fb-wire-ground-truth"
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: SWC.given
    }
  }, "Ground truth reminder:"), /*#__PURE__*/React.createElement("br", null), "\"", wiringValue.value.label, "\" is what the person said. Everything above is what institutions decided it means. The observation stands regardless."))))), adoptingFw && /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-modal",
    onClick: () => setAdoptingFw(false)
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-panel",
    onClick: e => e.stopPropagation()
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      color: SWC.white
    }
  }, "Auto-Suggest Bindings"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      color: SWC.muted,
      marginTop: 4
    }
  }, "The system proposes matches based on label similarity. Review and confirm.")), /*#__PURE__*/React.createElement("button", {
    onClick: () => setAdoptingFw(false),
    style: {
      background: 'none',
      border: 'none',
      color: SWC.muted,
      cursor: 'pointer',
      fontSize: 20
    }
  }, "\xD7")), frameworks.map((fw, fi) => {
    const suggestions = autoSuggestBindings(fw.id);
    if (suggestions.length === 0) return /*#__PURE__*/React.createElement("div", {
      key: fw.id,
      style: {
        padding: '10px 14px',
        border: `1px solid ${SWC.border}`,
        borderRadius: 8,
        marginBottom: 8,
        color: SWC.dim,
        fontSize: 13
      }
    }, /*#__PURE__*/React.createElement(SwDot, {
      color: SWC.fw[fi % 5],
      size: 6
    }), " ", /*#__PURE__*/React.createElement("span", {
      style: {
        color: SWC.fw[fi % 5],
        fontWeight: 600
      }
    }, fw.name), " \u2014 no suggestions (all bound or no matches)");
    return /*#__PURE__*/React.createElement("div", {
      key: fw.id,
      style: {
        border: `1px solid ${SWC.fw[fi % 5]}40`,
        borderRadius: 8,
        marginBottom: 12,
        overflow: 'hidden'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '10px 14px',
        background: `${SWC.fw[fi % 5]}10`,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement(SwDot, {
      color: SWC.fw[fi % 5],
      size: 8
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 14,
        fontWeight: 600,
        color: SWC.fw[fi % 5]
      }
    }, fw.name), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        color: SWC.dim
      }
    }, suggestions.length, " suggestion", suggestions.length !== 1 ? 's' : '')), /*#__PURE__*/React.createElement(SwBtn, {
      accent: SWC.fw[fi % 5],
      onClick: () => doAcceptAllSuggestions(suggestions),
      style: {
        padding: '5px 12px',
        fontSize: 11
      }
    }, "Accept all")), /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '6px 8px'
      }
    }, suggestions.map(s => /*#__PURE__*/React.createElement("div", {
      key: `${s.valueId}_${s.codeId}`,
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8,
        padding: '6px 10px',
        borderBottom: `1px solid ${SWC.border}`
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        color: SWC.white,
        flex: 1
      }
    }, s.valueLabel), /*#__PURE__*/React.createElement("span", {
      style: {
        color: SWC.dim,
        fontSize: 12
      }
    }, "\u2192"), /*#__PURE__*/React.createElement(SwTag, {
      color: SWC.fw[fi % 5],
      mono: true,
      sm: true
    }, s.codeValue), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        color: SWC.text,
        flex: 1
      }
    }, s.codeLabel), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11,
        color: SWC.dim,
        fontFamily: 'var(--mono)'
      }
    }, Math.round(s.confidence * 100), "%"), /*#__PURE__*/React.createElement(SwBtn, {
      accent: SWC.fw[fi % 5],
      onClick: () => doAcceptSuggestion(s),
      style: {
        padding: '3px 10px',
        fontSize: 10
      }
    }, "Accept")))));
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 12,
      textAlign: 'right'
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => setAdoptingFw(false)
  }, "Done")))), mode === 'preview' && /*#__PURE__*/React.createElement("div", {
    className: "fb-preview"
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20,
      padding: '12px 16px',
      borderRadius: 8,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      fontSize: 13,
      color: SWC.muted,
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: SWC.white
    }
  }, "Preview:"), " This is how the form appears to a person filling it out. No framework information is visible \u2014 only the questions and answer options."), form.sections.map(sec => /*#__PURE__*/React.createElement("div", {
    key: sec.id,
    style: {
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 16,
      fontWeight: 600,
      color: SWC.white,
      marginBottom: 12,
      padding: '8px 0',
      borderBottom: `1px solid ${SWC.border}`
    }
  }, sec.title), sec.questions.map(q => /*#__PURE__*/React.createElement("div", {
    key: q.id,
    className: "fb-preview-question"
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-preview-prompt"
  }, q.prompt), (q.type === 'single_select' || q.type === 'multi_select') && (q.options || []).map(opt => /*#__PURE__*/React.createElement("div", {
    key: opt.id,
    className: "fb-preview-option"
  }, /*#__PURE__*/React.createElement("div", {
    className: q.type === 'single_select' ? 'fb-answer-radio' : 'fb-answer-check'
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 14
    }
  }, opt.label))), q.type === 'text' && /*#__PURE__*/React.createElement("input", {
    placeholder: "Type your answer...",
    style: {
      width: '100%',
      padding: '10px 14px',
      borderRadius: 6,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      color: SWC.white,
      fontSize: 14,
      fontFamily: 'inherit'
    },
    readOnly: true
  }), q.type === 'number' && /*#__PURE__*/React.createElement("input", {
    type: "number",
    placeholder: "0",
    style: {
      width: 120,
      padding: '10px 14px',
      borderRadius: 6,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      color: SWC.white,
      fontSize: 14,
      fontFamily: 'inherit'
    },
    readOnly: true
  }), q.type === 'date' && /*#__PURE__*/React.createElement("input", {
    type: "date",
    style: {
      width: 200,
      padding: '10px 14px',
      borderRadius: 6,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      color: SWC.white,
      fontSize: 14,
      fontFamily: 'inherit'
    },
    readOnly: true
  }), q.type === 'boolean' && /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-preview-option",
    style: {
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-answer-radio"
  }), /*#__PURE__*/React.createElement("span", null, "Yes")), /*#__PURE__*/React.createElement("div", {
    className: "fb-preview-option",
    style: {
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-answer-radio"
  }), /*#__PURE__*/React.createElement("span", null, "No"))), q.type === 'duration' && /*#__PURE__*/React.createElement("input", {
    placeholder: "e.g. 3 months",
    style: {
      width: 200,
      padding: '10px 14px',
      borderRadius: 6,
      border: `1px solid ${SWC.border}`,
      background: SWC.surface,
      color: SWC.white,
      fontSize: 14,
      fontFamily: 'inherit'
    },
    readOnly: true
  }))), sec.questions.length === 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      color: SWC.dim,
      fontSize: 13,
      fontStyle: 'italic'
    }
  }, "No questions in this section yet.")))), showFormList && /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-modal",
    onClick: () => setShowFormList(false)
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-panel",
    onClick: e => e.stopPropagation(),
    style: {
      maxWidth: 560
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      fontFamily: 'var(--serif)',
      color: SWC.white
    }
  }, "Form Library"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      color: SWC.dim,
      marginTop: 4
    }
  }, "Saved forms and their versions.")), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowFormList(false),
    style: {
      background: 'none',
      border: 'none',
      color: SWC.muted,
      cursor: 'pointer',
      fontSize: 18,
      padding: '2px 6px',
      lineHeight: 1
    }
  }, "\xD7")), /*#__PURE__*/React.createElement(SwBtn, {
    accent: SWC.given,
    onClick: doNewForm,
    style: {
      marginBottom: 20,
      width: '100%'
    }
  }, "+ New blank form"), savedForms.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: 32,
      textAlign: 'center',
      color: SWC.dim,
      fontSize: 13,
      border: `1px dashed ${SWC.border}`,
      borderRadius: 8
    }
  }, "No saved forms yet. Use \"Save\" to save the current form to your library.") : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 10
    }
  }, Object.entries(savedForms.reduce((acc, sf) => {
    (acc[sf.key] = acc[sf.key] || []).push(sf);
    return acc;
  }, {})).map(([key, versions]) => /*#__PURE__*/React.createElement("div", {
    key: key,
    style: {
      border: `1px solid ${SWC.border}`,
      borderRadius: 8,
      background: SWC.surface,
      overflow: 'hidden'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px',
      borderBottom: `1px solid ${SWC.border}`,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 14,
      fontWeight: 600,
      color: SWC.white
    }
  }, versions[0].name), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: SWC.dim,
      fontFamily: 'var(--mono)'
    }
  }, versions.length, " version", versions.length !== 1 ? 's' : '')), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '6px 0'
    }
  }, versions.sort((a, b) => b.version - a.version).map(sv => /*#__PURE__*/React.createElement("div", {
    key: sv.id,
    style: {
      padding: '8px 16px',
      display: 'flex',
      alignItems: 'center',
      gap: 10,
      transition: 'background 0.1s',
      cursor: 'pointer'
    },
    onClick: () => doLoadForm(sv),
    onMouseEnter: e => e.currentTarget.style.background = SWC.hover || SWC.raised,
    onMouseLeave: e => e.currentTarget.style.background = 'transparent'
  }, /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.meant,
    sm: true,
    mono: true
  }, "v", sv.version), /*#__PURE__*/React.createElement(SwTag, {
    color: MATURITY_LEVELS[sv.maturity]?.color === 'green' ? SWC.given : SWC.dim,
    sm: true
  }, sv.maturity), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: SWC.muted,
      flex: 1,
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap'
    }
  }, sv.description || '—'), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: SWC.dim,
      fontFamily: 'var(--mono)',
      flexShrink: 0
    }
  }, new Date(sv.savedAt).toLocaleDateString()), /*#__PURE__*/React.createElement("button", {
    onClick: e => {
      e.stopPropagation();
      doDeleteSaved(sv.id);
    },
    style: {
      background: 'none',
      border: 'none',
      color: SWC.dim,
      cursor: 'pointer',
      fontSize: 14,
      padding: '2px 4px',
      flexShrink: 0
    },
    onMouseEnter: e => e.currentTarget.style.color = SWC.red,
    onMouseLeave: e => e.currentTarget.style.color = SWC.dim
  }, "\xD7"))))))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 16,
      textAlign: 'right'
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => setShowFormList(false)
  }, "Done")))), showVersionBump && /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-modal",
    onClick: () => setShowVersionBump(false)
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-panel",
    onClick: e => e.stopPropagation(),
    style: {
      maxWidth: 480
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      color: SWC.white
    }
  }, "Bump Version"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      color: SWC.muted,
      marginTop: 4
    }
  }, "Create a new version of ", /*#__PURE__*/React.createElement("strong", {
    style: {
      color: SWC.white
    }
  }, form.name), ". Current version: ", /*#__PURE__*/React.createElement("strong", {
    style: {
      color: SWC.meant
    }
  }, "v", form.version))), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowVersionBump(false),
    style: {
      background: 'none',
      border: 'none',
      color: SWC.muted,
      cursor: 'pointer',
      fontSize: 20
    }
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12,
      color: SWC.dim,
      marginBottom: 6
    }
  }, "Version notes (what changed):"), /*#__PURE__*/React.createElement(SwInput, {
    value: versionNotes,
    onChange: setVersionNotes,
    placeholder: "Describe what changed in this version...",
    onKeyDown: e => {
      if (e.key === 'Escape') setShowVersionBump(false);
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12,
      color: SWC.dim,
      marginBottom: 12,
      lineHeight: 1.6
    }
  }, "The current form state will be saved as v", form.version, " in the version history before bumping. Prior answers remain linked to the version they were recorded against."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    accent: SWC.meant,
    onClick: () => doVersionBump('minor'),
    style: {
      flex: 1
    }
  }, "Minor bump \u2192 v", +(form.version + 0.1).toFixed(1), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10,
      fontWeight: 400,
      marginTop: 2
    }
  }, "Additive changes, compatible")), /*#__PURE__*/React.createElement(SwBtn, {
    accent: SWC.sup,
    onClick: () => doVersionBump('major'),
    style: {
      flex: 1
    }
  }, "Major bump \u2192 v", Math.floor(form.version) + 1, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10,
      fontWeight: 400,
      marginTop: 2
    }
  }, "Breaking changes, crosswalk needed"))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 12,
      textAlign: 'right'
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => setShowVersionBump(false)
  }, "Cancel")))), showVersionHistory && /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-modal",
    onClick: () => setShowVersionHistory(false)
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-panel",
    onClick: e => e.stopPropagation(),
    style: {
      maxWidth: 640
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      color: SWC.white
    }
  }, "Version History \u2014 ", form.name), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      color: SWC.muted,
      marginTop: 4
    }
  }, "Current: v", form.version, " \xB7 ", (form.versionHistory || []).length, " prior version", (form.versionHistory || []).length !== 1 ? 's' : '')), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowVersionHistory(false),
    style: {
      background: 'none',
      border: 'none',
      color: SWC.muted,
      cursor: 'pointer',
      fontSize: 20
    }
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    style: {
      border: `1px solid ${SWC.givenBorder}`,
      borderRadius: 8,
      background: 'rgba(45,212,160,0.04)',
      padding: '10px 14px',
      marginBottom: 8
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.given,
    sm: true,
    mono: true
  }, "v", form.version), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 600,
      color: SWC.white
    }
  }, "Current (working)"), /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.given,
    sm: true
  }, form.maturity), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: SWC.dim,
      marginLeft: 'auto'
    }
  }, allQuestions.length, " questions \xB7 ", allValues.length, " options"))), (form.versionHistory || []).slice().reverse().map((h, i) => {
    const hQuestions = (h.snapshot?.sections || []).flatMap(s => s.questions || []);
    const hValues = hQuestions.flatMap(q => (q.options || []).map(o => o));
    const diff = diffFormVersions(h.snapshot, form);
    return /*#__PURE__*/React.createElement("div", {
      key: i,
      style: {
        border: `1px solid ${SWC.border}`,
        borderRadius: 8,
        background: SWC.surface,
        padding: '10px 14px',
        marginBottom: 6
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8,
        marginBottom: h.notes ? 6 : 0
      }
    }, /*#__PURE__*/React.createElement(SwTag, {
      color: SWC.meant,
      sm: true,
      mono: true
    }, "v", h.version), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        color: SWC.text,
        flex: 1
      }
    }, h.notes || 'No notes'), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11,
        color: SWC.dim,
        fontFamily: 'var(--mono)'
      }
    }, new Date(h.bumpedAt).toLocaleDateString()), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11,
        color: SWC.dim
      }
    }, hQuestions.length, "q \xB7 ", hValues.length, "o")), (diff.added.length > 0 || diff.removed.length > 0 || diff.addedOptions.length > 0 || diff.removedOptions.length > 0) && /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 11,
        color: SWC.dim,
        marginTop: 4,
        display: 'flex',
        gap: 8,
        flexWrap: 'wrap'
      }
    }, diff.added.length > 0 && /*#__PURE__*/React.createElement("span", {
      style: {
        color: SWC.given
      }
    }, "+", diff.added.length, " question", diff.added.length !== 1 ? 's' : ''), diff.removed.length > 0 && /*#__PURE__*/React.createElement("span", {
      style: {
        color: SWC.red
      }
    }, "-", diff.removed.length, " question", diff.removed.length !== 1 ? 's' : ''), diff.addedOptions.length > 0 && /*#__PURE__*/React.createElement("span", {
      style: {
        color: SWC.given
      }
    }, "+", diff.addedOptions.length, " option", diff.addedOptions.length !== 1 ? 's' : ''), diff.removedOptions.length > 0 && /*#__PURE__*/React.createElement("span", {
      style: {
        color: SWC.red
      }
    }, "-", diff.removedOptions.length, " option", diff.removedOptions.length !== 1 ? 's' : ''), diff.renamed.length > 0 && /*#__PURE__*/React.createElement("span", {
      style: {
        color: SWC.sup
      }
    }, diff.renamed.length, " renamed")), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 6,
        marginTop: 8
      }
    }, /*#__PURE__*/React.createElement(SwBtn, {
      ghost: true,
      accent: SWC.meant,
      onClick: () => {
        setShowVersionHistory(false);
        doStartAnswerCrosswalk(h);
      },
      style: {
        padding: '3px 10px',
        fontSize: 10
      }
    }, "Crosswalk answers from v", h.version)));
  }), (form.versionHistory || []).length === 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: 24,
      textAlign: 'center',
      color: SWC.dim,
      fontSize: 13,
      border: `1px dashed ${SWC.border}`,
      borderRadius: 8
    }
  }, "No prior versions. Use \"Version\" to create a version snapshot."), (form.answerCrosswalks || []).length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.08em',
      color: SWC.muted,
      marginBottom: 8
    }
  }, "Answer Crosswalks"), form.answerCrosswalks.map(xw => /*#__PURE__*/React.createElement("div", {
    key: xw.id,
    style: {
      border: `1px solid ${SWC.border}`,
      borderRadius: 6,
      background: SWC.surface,
      padding: '8px 12px',
      marginBottom: 4,
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.meant,
    sm: true,
    mono: true
  }, "v", xw.fromVersion), /*#__PURE__*/React.createElement("span", {
    style: {
      color: SWC.dim,
      fontSize: 12
    }
  }, "\u2192"), /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.given,
    sm: true,
    mono: true
  }, "v", xw.toVersion), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: SWC.text
    }
  }, Object.keys(xw.mappings).length, " mapping", Object.keys(xw.mappings).length !== 1 ? 's' : ''), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: SWC.dim,
      marginLeft: 'auto',
      fontFamily: 'var(--mono)'
    }
  }, new Date(xw.createdAt).toLocaleDateString())))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 12,
      textAlign: 'right'
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => setShowVersionHistory(false)
  }, "Done")))), showAnswerCrosswalk && crosswalkSource && /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-modal",
    onClick: () => {
      setShowAnswerCrosswalk(false);
      setCrosswalkSource(null);
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-panel",
    onClick: e => e.stopPropagation(),
    style: {
      maxWidth: 760
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      color: SWC.white
    }
  }, "Answer Crosswalk"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 13,
      color: SWC.muted,
      marginTop: 4
    }
  }, "Map answers from ", /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.meant,
    sm: true,
    mono: true
  }, "v", crosswalkSource.version), " to the current form ", /*#__PURE__*/React.createElement(SwTag, {
    color: SWC.given,
    sm: true,
    mono: true
  }, "v", form.version), ". Past answers recorded against v", crosswalkSource.version, " will be translated using these mappings.")), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowAnswerCrosswalk(false);
      setCrosswalkSource(null);
    },
    style: {
      background: 'none',
      border: 'none',
      color: SWC.muted,
      cursor: 'pointer',
      fontSize: 20
    }
  }, "\xD7")), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12,
      color: SWC.dim,
      marginBottom: 12,
      padding: '8px 12px',
      background: SWC.raised,
      borderRadius: 6,
      lineHeight: 1.6
    }
  }, "For each old answer option on the left, select the equivalent current answer option on the right. Unmapped answers will be preserved as-is with their original value."), (() => {
    const oldSections = crosswalkSource.form?.sections || [];
    const newAllQs = form.sections.flatMap(s => s.questions);
    const newAllOpts = newAllQs.flatMap(q => (q.options || []).map(o => ({
      ...o,
      questionPrompt: q.prompt,
      questionId: q.id
    })));
    return oldSections.map(oldSec => /*#__PURE__*/React.createElement("div", {
      key: oldSec.id,
      style: {
        marginBottom: 12
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 13,
        fontWeight: 600,
        color: SWC.muted,
        marginBottom: 6,
        borderBottom: `1px solid ${SWC.border}`,
        paddingBottom: 4
      }
    }, oldSec.title), (oldSec.questions || []).filter(q => q.options && q.options.length > 0).map(oldQ => {
      // Try to find matching new question by id or prompt similarity
      const matchingNewQ = newAllQs.find(nq => nq.id === oldQ.id) || newAllQs.find(nq => nq.prompt === oldQ.prompt);
      const targetOpts = matchingNewQ ? matchingNewQ.options || [] : newAllOpts;
      return /*#__PURE__*/React.createElement("div", {
        key: oldQ.id,
        style: {
          marginBottom: 8
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          fontSize: 13,
          color: SWC.white,
          marginBottom: 4,
          display: 'flex',
          alignItems: 'center',
          gap: 6
        }
      }, /*#__PURE__*/React.createElement("span", {
        style: {
          color: SWC.meant
        }
      }, "OLD:"), " ", oldQ.prompt, matchingNewQ && /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 11,
          color: SWC.given
        }
      }, "\u2192 matched"), !matchingNewQ && /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 11,
          color: SWC.sup
        }
      }, "\u2192 no exact match (showing all options)")), /*#__PURE__*/React.createElement("div", {
        style: {
          border: `1px solid ${SWC.border}`,
          borderRadius: 8,
          overflow: 'hidden',
          background: SWC.surface
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'grid',
          gridTemplateColumns: '1fr 40px 1fr',
          borderBottom: `1px solid ${SWC.border}`,
          background: SWC.raised
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          padding: '6px 10px',
          fontSize: 11,
          fontWeight: 700,
          textTransform: 'uppercase',
          color: SWC.meant
        }
      }, "Old answer (v", crosswalkSource.version, ")"), /*#__PURE__*/React.createElement("div", {
        style: {
          padding: '6px 4px',
          fontSize: 11,
          color: SWC.dim,
          textAlign: 'center'
        }
      }, "\u2192"), /*#__PURE__*/React.createElement("div", {
        style: {
          padding: '6px 10px',
          fontSize: 11,
          fontWeight: 700,
          textTransform: 'uppercase',
          color: SWC.given
        }
      }, "Current answer (v", form.version, ")")), oldQ.options.map(oldOpt => /*#__PURE__*/React.createElement("div", {
        key: oldOpt.id,
        style: {
          display: 'grid',
          gridTemplateColumns: '1fr 40px 1fr',
          borderBottom: `1px solid ${SWC.border}`,
          alignItems: 'center'
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          padding: '6px 10px',
          fontSize: 13,
          color: SWC.text
        }
      }, oldOpt.label), /*#__PURE__*/React.createElement("div", {
        style: {
          padding: '6px 4px',
          fontSize: 11,
          color: SWC.dim,
          textAlign: 'center'
        }
      }, "\u2192"), /*#__PURE__*/React.createElement("div", {
        style: {
          padding: '4px 6px'
        }
      }, /*#__PURE__*/React.createElement("select", {
        value: answerMappings[oldOpt.id] || '',
        onChange: e => doSetAnswerMapping(oldOpt.id, e.target.value || null),
        style: {
          width: '100%',
          padding: '5px 8px',
          borderRadius: 4,
          border: `1px solid ${answerMappings[oldOpt.id] ? SWC.givenBorder : SWC.border}`,
          background: answerMappings[oldOpt.id] ? 'rgba(45,212,160,0.06)' : SWC.surface,
          color: SWC.white,
          fontSize: 12,
          fontFamily: 'inherit'
        }
      }, /*#__PURE__*/React.createElement("option", {
        value: ""
      }, "\u2014 unmapped (keep original) \u2014"), targetOpts.map(nOpt => /*#__PURE__*/React.createElement("option", {
        key: nOpt.id,
        value: nOpt.id
      }, nOpt.label))))))));
    })));
  })(), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginTop: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12,
      color: SWC.dim
    }
  }, Object.keys(answerMappings).length, " mapping", Object.keys(answerMappings).length !== 1 ? 's' : '', " defined"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(SwBtn, {
    ghost: true,
    accent: SWC.muted,
    onClick: () => {
      setShowAnswerCrosswalk(false);
      setCrosswalkSource(null);
    }
  }, "Cancel"), /*#__PURE__*/React.createElement(SwBtn, {
    accent: SWC.given,
    onClick: doSaveAnswerCrosswalk,
    disabled: Object.keys(answerMappings).length === 0
  }, "Save Answer Crosswalk")))));
};

/* ═══════════════════ NOTIFICATION CENTER ═══════════════════ */

/* Notification types: schema_update, schema_new, message, data_change, org_event */
const NotificationBell = ({
  notifications,
  onNotifClick,
  onDismiss,
  onDismissAll
}) => {
  const [open, setOpen] = useState(false);
  const ref = useRef(null);
  const unreadCount = notifications.filter(n => !n.read).length;

  // Close on outside click
  useEffect(() => {
    if (!open) return;
    const handleClick = e => {
      if (ref.current && !ref.current.contains(e.target)) setOpen(false);
    };
    document.addEventListener('mousedown', handleClick);
    return () => document.removeEventListener('mousedown', handleClick);
  }, [open]);
  const iconForType = type => {
    switch (type) {
      case 'schema_update':
        return {
          icon: 'layers',
          color: 'var(--gold)',
          bg: 'rgba(201,163,82,.12)'
        };
      case 'schema_new':
        return {
          icon: 'layers',
          color: 'var(--teal)',
          bg: 'rgba(62,201,176,.12)'
        };
      case 'message':
        return {
          icon: 'msg',
          color: 'var(--blue)',
          bg: 'rgba(91,156,245,.12)'
        };
      case 'data_change':
        return {
          icon: 'zap',
          color: 'var(--orange)',
          bg: 'rgba(224,150,72,.12)'
        };
      case 'org_event':
        return {
          icon: 'shieldCheck',
          color: 'var(--blue)',
          bg: 'rgba(91,156,245,.12)'
        };
      default:
        return {
          icon: 'bell',
          color: 'var(--tx-2)',
          bg: 'var(--bg-3)'
        };
    }
  };
  const timeAgo = ts => {
    const diff = Date.now() - ts;
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
    return `${Math.floor(diff / 86400000)}d ago`;
  };
  return /*#__PURE__*/React.createElement("div", {
    ref: ref,
    style: {
      position: 'relative'
    }
  }, /*#__PURE__*/React.createElement("button", {
    className: "notif-bell",
    onClick: () => setOpen(prev => !prev),
    title: "Notifications"
  }, /*#__PURE__*/React.createElement(I, {
    n: "bell",
    s: 16
  }), unreadCount > 0 && /*#__PURE__*/React.createElement("span", {
    className: "notif-badge"
  }, unreadCount > 9 ? '9+' : unreadCount)), open && /*#__PURE__*/React.createElement("div", {
    className: "notif-dropdown"
  }, /*#__PURE__*/React.createElement("div", {
    className: "notif-dropdown-hdr"
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 600,
      color: 'var(--tx-0)'
    }
  }, "Notifications"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6,
      alignItems: 'center'
    }
  }, unreadCount > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      onDismissAll();
    },
    style: {
      fontSize: 10,
      color: 'var(--teal)',
      background: 'none',
      border: 'none',
      cursor: 'pointer',
      fontFamily: 'var(--mono)'
    }
  }, "Mark all read"))), /*#__PURE__*/React.createElement("div", {
    className: "notif-dropdown-list"
  }, notifications.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "notif-empty"
  }, /*#__PURE__*/React.createElement(I, {
    n: "check",
    s: 18,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 6
    }
  }, "No notifications")) : notifications.map((n, i) => {
    const {
      icon,
      color,
      bg
    } = iconForType(n.type);
    return /*#__PURE__*/React.createElement("div", {
      key: n.id || i,
      className: `notif-item${!n.read ? ' unread' : ''}`,
      onClick: () => {
        onNotifClick(n);
        setOpen(false);
      }
    }, /*#__PURE__*/React.createElement("div", {
      className: "notif-icon",
      style: {
        background: bg
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: icon,
      s: 14,
      c: color
    })), /*#__PURE__*/React.createElement("div", {
      className: "notif-body"
    }, /*#__PURE__*/React.createElement("div", {
      className: "notif-title"
    }, n.title), n.description && /*#__PURE__*/React.createElement("div", {
      className: "notif-desc"
    }, n.description), /*#__PURE__*/React.createElement("div", {
      className: "notif-time"
    }, timeAgo(n.timestamp))), !n.read && /*#__PURE__*/React.createElement("div", {
      style: {
        width: 6,
        height: 6,
        borderRadius: 3,
        background: 'var(--teal)',
        flexShrink: 0,
        marginTop: 6
      }
    }));
  }))));
};

/* ═══════════════════ SCHEMA BUILDER ═══════════════════ */

/* ── Sidebar form list item ── */
const SiFormItem = ({
  form,
  isActive,
  onClick,
  sourceType
}) => {
  const dotClass = isActive ? 'current' : form._unread ? 'unread' : 'read';
  const maturity = form.maturity || 'draft';
  const matLabel = { draft: 'Draft', trial: 'Trial', normative: 'Adopted', de_facto: 'De facto', deprecated: 'Deprecated' }[maturity] || maturity;
  return /*#__PURE__*/React.createElement("div", {
    className: `si-form-item${isActive ? ' active' : ''}`,
    onClick: onClick
  }, /*#__PURE__*/React.createElement("div", {
    className: `si-dot ${dotClass}`
  }), /*#__PURE__*/React.createElement("div", {
    style: { flex: 1, minWidth: 0 }
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-form-name"
  }, form.name), /*#__PURE__*/React.createElement("div", {
    className: "si-form-meta"
  }, /*#__PURE__*/React.createElement("span", {
    className: `si-form-status ${maturity}`,
    title: MATURITY_LEVELS[maturity]?.desc || ''
  }, matLabel), /*#__PURE__*/React.createElement("span", null, "v", form.version)), form._hasUpdate && /*#__PURE__*/React.createElement("div", {
    className: "si-form-update"
  }, "\u25B2 new")));
};

/* ── Sidebar group header ── */
const SiGroupHeader = ({
  label,
  icon,
  count,
  expanded,
  onToggle,
  alert
}) => /*#__PURE__*/React.createElement("div", {
  className: "si-group-header",
  onClick: onToggle
}, /*#__PURE__*/React.createElement("span", {
  className: "si-group-label"
}, /*#__PURE__*/React.createElement(I, {
  n: expanded ? "chevronDown" : "chevronRight",
  s: 10
}), /*#__PURE__*/React.createElement(I, {
  n: icon,
  s: 11
}), label), /*#__PURE__*/React.createElement("span", {
  className: `si-group-count${alert ? ' alert' : ''}`
}, count));

/* ── Context panel: version timeline ── */
const SiVersionTimeline = ({
  form,
  onClickVersion
}) => {
  const history = (form.versionHistory || []).slice().reverse();
  return /*#__PURE__*/React.createElement("div", {
    className: "si-vt"
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-vt-node"
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-vt-dot current"
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontFamily: 'var(--mono)',
      fontWeight: 600,
      color: 'var(--tx-0)'
    }
  }, "v", form.version), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)'
    }
  }, "current")), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      marginTop: 2,
      fontFamily: 'var(--mono)'
    }
  }, form.sections?.length || 0, " sections \xB7 ", (form.sections || []).flatMap(s => s.questions || []).length, " questions")), history.map((h, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "si-vt-node",
    onClick: () => onClickVersion && onClickVersion(h),
    style: {
      cursor: 'pointer'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-vt-dot past"
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontFamily: 'var(--mono)',
      fontWeight: 600,
      color: 'var(--tx-1)'
    }
  }, "v", h.version), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)'
    }
  }, h.bumpedAt ? new Date(h.bumpedAt).toLocaleDateString() : '')), h.notes && /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-2)',
      marginTop: 1,
      lineHeight: 1.4,
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap'
    }
  }, h.notes))), history.length === 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-3)',
      padding: '4px 0 0 16px'
    }
  }, "No prior versions"));
};

/* ── Context panel: lineage ── */
const SiLineage = ({
  form,
  orgMeta,
  networkMembers,
  isOrg
}) => {
  const isNetwork = form.source?.level === 'network' || form._sourceType === 'network';
  const isOrgForm = form.source?.level === 'org' || form._sourceType === 'org';
  return /*#__PURE__*/React.createElement("div", null, isNetwork && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "si-lineage-node",
    style: {
      background: 'rgba(62,201,176,.06)',
      border: '1px solid rgba(62,201,176,.15)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "globe",
    s: 12,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 600,
      color: 'var(--teal)'
    }
  }, "Network")), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      fontFamily: 'var(--mono)',
      marginTop: 2
    }
  }, form.source?.propagation || 'standard')), /*#__PURE__*/React.createElement("div", {
    className: "si-lineage-connector"
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)'
    }
  }, form.source?.propagation || 'standard'))), (isNetwork || isOrgForm) && orgMeta?.name && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "si-lineage-node",
    style: {
      background: 'rgba(91,156,245,.06)',
      border: '1px solid rgba(91,156,245,.15)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 12,
    c: "var(--blue)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 600,
      color: 'var(--blue)'
    }
  }, orgMeta.name))), /*#__PURE__*/React.createElement("div", {
    className: "si-lineage-connector"
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)'
    }
  }, "active"))), /*#__PURE__*/React.createElement("div", {
    className: "si-lineage-node",
    style: {
      background: 'rgba(230,233,240,.06)',
      border: '1px solid var(--border-1)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "user",
    s: 12,
    c: "var(--tx-0)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 600,
      color: 'var(--tx-0)'
    }
  }, "You ", isOrg ? '(provider)' : '(local)'))));
};

/* ── Context panel: related forms ── */
const SiRelatedForms = ({
  currentForm,
  allForms,
  onNavigate
}) => {
  const currentFieldKeys = new Set((currentForm.sections || []).flatMap(s => (s.questions || []).map(q => q.key || q.id)));
  const related = allForms.filter(f => {
    if (f.id === currentForm.id || f.key === currentForm.key) return false;
    const fKeys = new Set((f.sections || []).flatMap(s => (s.questions || []).map(q => q.key || q.id)));
    let shared = 0;
    for (const k of currentFieldKeys) if (fKeys.has(k)) shared++;
    return shared > 0;
  }).map(f => {
    const fKeys = new Set((f.sections || []).flatMap(s => (s.questions || []).map(q => q.key || q.id)));
    let shared = 0;
    for (const k of currentFieldKeys) if (fKeys.has(k)) shared++;
    return {
      ...f,
      _sharedCount: shared
    };
  });
  if (related.length === 0) return /*#__PURE__*/React.createElement("div", {
    style: {
      padding: 12,
      border: '1px dashed var(--border-1)',
      borderRadius: 6,
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11,
      color: 'var(--tx-3)',
      lineHeight: 1.5
    }
  }, "No related forms detected. Forms sharing field keys will appear here."));
  return /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 6
    }
  }, related.map(f => /*#__PURE__*/React.createElement("div", {
    key: f.id,
    onClick: () => onNavigate && onNavigate(f),
    style: {
      padding: '8px 12px',
      borderRadius: 6,
      border: '1px solid var(--border-0)',
      background: 'var(--bg-0)',
      cursor: 'pointer',
      transition: 'all 150ms'
    },
    onMouseEnter: e => e.currentTarget.style.borderColor = 'var(--border-2)',
    onMouseLeave: e => e.currentTarget.style.borderColor = 'var(--border-0)'
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "link",
    s: 11,
    c: "var(--tx-3)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 600,
      color: 'var(--tx-0)'
    }
  }, f.name)), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-2)',
      marginTop: 2
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--teal)'
    }
  }, f._sharedCount), " shared field", f._sharedCount !== 1 ? 's' : ''))));
};

/* ── Context panel (right side) ── */
const SiContextPanel = ({
  form,
  collapsed,
  onToggle,
  orgMeta,
  networkMembers,
  isOrg,
  allForms,
  onNavigateForm,
  onClickVersion
}) => {
  if (collapsed) return /*#__PURE__*/React.createElement("div", {
    className: "si-context collapsed"
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-ctx-strip"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onToggle,
    title: "Expand context"
  }, /*#__PURE__*/React.createElement(I, {
    n: "chevronLeft",
    s: 13
  })), /*#__PURE__*/React.createElement("button", {
    onClick: onToggle,
    title: "Lineage"
  }, /*#__PURE__*/React.createElement(I, {
    n: "gitBranch",
    s: 14
  })), /*#__PURE__*/React.createElement("button", {
    onClick: onToggle,
    title: "Versions"
  }, /*#__PURE__*/React.createElement(I, {
    n: "clock",
    s: 14
  })), /*#__PURE__*/React.createElement("button", {
    onClick: onToggle,
    title: "Related"
  }, /*#__PURE__*/React.createElement(I, {
    n: "link",
    s: 14
  })), /*#__PURE__*/React.createElement("button", {
    onClick: onToggle,
    title: "Activity"
  }, /*#__PURE__*/React.createElement(I, {
    n: "activity",
    s: 14
  }))));
  if (!form) return /*#__PURE__*/React.createElement("div", {
    className: "si-context"
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-ctx-section"
  }, /*#__PURE__*/React.createElement("span", {
    className: "si-ctx-label"
  }, "No form selected")));
  return /*#__PURE__*/React.createElement("div", {
    className: "si-context"
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 14px 8px',
      borderBottom: '1px solid var(--border-0)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "si-ctx-label",
    style: {
      marginBottom: 0
    }
  }, "CONTEXT"), /*#__PURE__*/React.createElement("button", {
    onClick: onToggle,
    style: {
      background: 'none',
      border: 'none',
      color: 'var(--tx-3)',
      cursor: 'pointer',
      padding: 2
    },
    title: "Collapse"
  }, /*#__PURE__*/React.createElement(I, {
    n: "chevronRight",
    s: 12
  }))), /*#__PURE__*/React.createElement("div", {
    className: "si-ctx-section"
  }, /*#__PURE__*/React.createElement("span", {
    className: "si-ctx-label"
  }, "LINEAGE"), /*#__PURE__*/React.createElement(SiLineage, {
    form: form,
    orgMeta: orgMeta,
    networkMembers: networkMembers,
    isOrg: isOrg
  })), /*#__PURE__*/React.createElement("div", {
    className: "si-ctx-section"
  }, /*#__PURE__*/React.createElement("span", {
    className: "si-ctx-label"
  }, "VERSION TIMELINE"), /*#__PURE__*/React.createElement(SiVersionTimeline, {
    form: form,
    onClickVersion: onClickVersion
  })), /*#__PURE__*/React.createElement("div", {
    className: "si-ctx-section"
  }, /*#__PURE__*/React.createElement("span", {
    className: "si-ctx-label"
  }, "RELATED FORMS"), /*#__PURE__*/React.createElement(SiRelatedForms, {
    currentForm: form,
    allForms: allForms,
    onNavigate: onNavigateForm
  })), /*#__PURE__*/React.createElement("div", {
    className: "si-ctx-section"
  }, /*#__PURE__*/React.createElement("span", {
    className: "si-ctx-label"
  }, "ACTIVITY"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-3)'
    }
  }, form.updatedAt && /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 5,
      height: 5,
      borderRadius: '50%',
      background: 'var(--teal)',
      flexShrink: 0
    }
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)'
    }
  }, new Date(form.updatedAt).toLocaleDateString()), /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--tx-2)'
    }
  }, "Last edited")), form.createdAt && /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 5,
      height: 5,
      borderRadius: '50%',
      background: 'var(--tx-3)',
      flexShrink: 0
    }
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)'
    }
  }, new Date(form.createdAt).toLocaleDateString()), /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--tx-2)'
    }
  }, "Created")), !form.updatedAt && !form.createdAt && /*#__PURE__*/React.createElement("span", null, "No activity recorded"))));
};

/* ── Forms sidebar (left side) ── */
const SiFormsSidebar = ({
  myForms,
  networkForms,
  orgForms,
  activeFormId,
  onSelectForm,
  onNewForm,
  searchQuery,
  onSearchChange,
  sidebarOpen,
  onToggleSidebar
}) => {
  const [expanded, setExpanded] = useState({
    my: true,
    org: false,
    network: true
  });
  const [filterMode, setFilterMode] = useState('all'); // 'all' | 'attention'
  const toggle = g => setExpanded(prev => ({
    ...prev,
    [g]: !prev[g]
  }));
  const filterForms = forms => {
    let result = forms;
    if (searchQuery && searchQuery.length >= 2) {
      const q = searchQuery.toLowerCase();
      result = result.filter(f => f.name.toLowerCase().includes(q) || (f.key || '').toLowerCase().includes(q) || (f.description || '').toLowerCase().includes(q) || (f.sections || []).some(s => s.title.toLowerCase().includes(q) || (s.questions || []).some(qn => (qn.prompt || '').toLowerCase().includes(q))));
    }
    if (filterMode === 'attention') {
      result = result.filter(f => f._unread || f._hasUpdate);
    }
    return result;
  };
  const filtMy = filterForms(myForms);
  const filtOrg = filterForms(orgForms);
  const filtNet = filterForms(networkForms);

  // Count items needing attention across all groups
  const attentionCount = [...myForms, ...orgForms, ...networkForms].filter(f => f._unread || f._hasUpdate).length;
  return /*#__PURE__*/React.createElement("div", {
    className: `si-sidebar${sidebarOpen ? ' open' : ''}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-header"
  }, /*#__PURE__*/React.createElement("span", {
    className: "si-group-label",
    style: {
      fontSize: 11
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "layers",
    s: 13,
    c: "var(--teal)"
  }), " SCHEMA"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onNewForm,
    style: {
      width: 24,
      height: 24,
      borderRadius: 6,
      background: 'transparent',
      border: '1px solid var(--border-0)',
      color: 'var(--tx-1)',
      cursor: 'pointer',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      transition: 'all .15s'
    },
    onMouseEnter: e => {
      e.currentTarget.style.background = 'var(--bg-3)';
      e.currentTarget.style.color = 'var(--tx-0)';
    },
    onMouseLeave: e => {
      e.currentTarget.style.background = 'transparent';
      e.currentTarget.style.color = 'var(--tx-1)';
    },
    title: "New form"
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 12
  })))), /*#__PURE__*/React.createElement("div", {
    className: "si-search"
  }, /*#__PURE__*/React.createElement("span", {
    className: "si-search-icon"
  }, /*#__PURE__*/React.createElement(I, {
    n: "search",
    s: 12,
    c: "var(--tx-3)"
  })), /*#__PURE__*/React.createElement("input", {
    value: searchQuery,
    onChange: e => onSearchChange(e.target.value),
    placeholder: "Search forms..."
  })), /*#__PURE__*/React.createElement("div", {
    className: "si-filter-bar"
  }, /*#__PURE__*/React.createElement("button", {
    className: `si-filter-btn${filterMode === 'all' ? ' active' : ''}`,
    onClick: () => setFilterMode('all')
  }, "All"), /*#__PURE__*/React.createElement("button", {
    className: `si-filter-btn${filterMode === 'attention' ? ' active' : ''}`,
    onClick: () => setFilterMode('attention')
  }, "Needs attention", attentionCount > 0 ? ` (${attentionCount})` : '')), /*#__PURE__*/React.createElement("div", {
    className: "si-sidebar-scroll"
  }, /*#__PURE__*/React.createElement(SiGroupHeader, {
    label: "MY FORMS",
    icon: "folder",
    count: filtMy.length,
    expanded: expanded.my,
    onToggle: () => toggle('my')
  }), expanded.my && (filtMy.length > 0 ? filtMy.map(f => /*#__PURE__*/React.createElement(SiFormItem, {
    key: f.id,
    form: f,
    isActive: f.id === activeFormId,
    onClick: () => onSelectForm(f),
    sourceType: "local"
  })) : /*#__PURE__*/React.createElement("div", {
    className: "si-empty"
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-empty-title"
  }, filterMode === 'attention' ? 'Nothing needs attention' : 'No saved forms'), /*#__PURE__*/React.createElement("div", {
    className: "si-empty-desc"
  }, filterMode === 'attention' ? 'All local forms are up to date.' : 'Use "Save" to save a form here.'))), /*#__PURE__*/React.createElement(SiGroupHeader, {
    label: "ORG FORMS",
    icon: "shieldCheck",
    count: filtOrg.length,
    expanded: expanded.org,
    onToggle: () => toggle('org'),
    alert: filtOrg.some(f => f._unread || f._hasUpdate)
  }), expanded.org && (filtOrg.length > 0 ? filtOrg.map(f => /*#__PURE__*/React.createElement(SiFormItem, {
    key: f.id,
    form: f,
    isActive: f.id === activeFormId,
    onClick: () => onSelectForm(f),
    sourceType: "org"
  })) : /*#__PURE__*/React.createElement("div", {
    className: "si-empty"
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-empty-desc"
  }, filterMode === 'attention' ? 'No org form updates.' : 'No org forms available.'))), /*#__PURE__*/React.createElement(SiGroupHeader, {
    label: "NETWORK",
    icon: "globe",
    count: filtNet.length,
    expanded: expanded.network,
    onToggle: () => toggle('network'),
    alert: filtNet.some(f => f._unread || f._hasUpdate)
  }), expanded.network && (filtNet.length > 0 ? filtNet.map(f => /*#__PURE__*/React.createElement(SiFormItem, {
    key: f.id,
    form: f,
    isActive: f.id === activeFormId,
    onClick: () => onSelectForm(f),
    sourceType: "network"
  })) : /*#__PURE__*/React.createElement("div", {
    className: "si-empty"
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-empty-desc"
  }, filterMode === 'attention' ? 'No network updates.' : 'No network schema available.'))), filterMode === 'attention' && filtMy.length === 0 && filtOrg.length === 0 && filtNet.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "si-empty",
    style: {
      paddingTop: 40
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-empty-icon"
  }, /*#__PURE__*/React.createElement(I, {
    n: "check",
    s: 22,
    c: "var(--teal)"
  })), /*#__PURE__*/React.createElement("div", {
    className: "si-empty-title"
  }, "All caught up"), /*#__PURE__*/React.createElement("div", {
    className: "si-empty-desc"
  }, "No forms need your attention right now."))));
};

/* ── SchemaView — Three-zone layout wrapping FormBuilder ── */
const SchemaView = ({
  isOrg,
  orgMeta,
  networkMembers,
  fieldDefs,
  catLabels,
  catColors,
  onSaveFieldDef
}) => {
  SWC = useSWC();
  const [contextOpen, setContextOpen] = useState(true);
  const [sidebarOpen, setSidebarOpen] = useState(false); // for mobile overlay
  const [searchQuery, setSearchQuery] = useState('');
  const [sidebarSelectedId, setSidebarSelectedId] = useState(null);
  const [sidebarForms, setSidebarForms] = useState([]); // all forms in sidebar across all groups

  // Build sidebar form lists from DEFAULT_FORMS (network commons)
  const networkForms = useMemo(() => DEFAULT_FORMS.map(f => ({
    ...f,
    _sourceType: 'network',
    _unread: false,
    _hasUpdate: false,
    sections: [{
      id: 'sec_' + f.id,
      title: f.name,
      questions: f.fields.map(fld => ({
        id: fld.id || fld.key,
        key: fld.key,
        prompt: fld.question,
        type: fld.type,
        options: (fld.options || []).map((o, oi) => ({
          id: `${fld.key}_opt_${oi}`,
          label: o
        }))
      }))
    }]
  })), []);

  // Currently active form from FormBuilder (read from formBuilder's own state)
  // We track which form is selected; FormBuilder manages its own full state
  const activeForm = useMemo(() => {
    if (sidebarSelectedId) {
      const found = [...networkForms, ...sidebarForms].find(f => f.id === sidebarSelectedId);
      if (found) return found;
    }
    return null;
  }, [sidebarSelectedId, networkForms, sidebarForms]);
  const allKnownForms = useMemo(() => [...networkForms, ...sidebarForms], [networkForms, sidebarForms]);

  // Breadcrumb
  const breadcrumbGroup = activeForm?._sourceType === 'network' ? 'Network' : activeForm?._sourceType === 'org' ? 'Org Forms' : 'My Forms';
  return /*#__PURE__*/React.createElement("div", {
    className: "si-wrap anim-up"
  }, /*#__PURE__*/React.createElement(SiFormsSidebar, {
    myForms: sidebarForms.filter(f => f._sourceType === 'local'),
    networkForms: networkForms,
    orgForms: sidebarForms.filter(f => f._sourceType === 'org'),
    activeFormId: sidebarSelectedId,
    onSelectForm: f => setSidebarSelectedId(f.id),
    onNewForm: () => setSidebarSelectedId(null),
    searchQuery: searchQuery,
    onSearchChange: setSearchQuery,
    sidebarOpen: sidebarOpen,
    onToggleSidebar: () => setSidebarOpen(prev => !prev)
  }), /*#__PURE__*/React.createElement("div", {
    className: "si-canvas"
  }, /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Schema",
    extra: [{ label: 'Storage', value: 'Schema definitions (forms, assessments, field definitions, crosswalks) are stored as state events in your personal Schema room. Network-level schemas are shared via the network room.' }]
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "si-breadcrumb"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setSidebarOpen(true),
    style: {
      background: 'none',
      border: 'none',
      color: 'var(--tx-1)',
      cursor: 'pointer',
      padding: '2px 8px 2px 0',
      display: 'none'
    },
    className: "si-mobile-menu"
  }, /*#__PURE__*/React.createElement(I, {
    n: "menu",
    s: 16
  })), /*#__PURE__*/React.createElement(I, {
    n: "layers",
    s: 13,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    className: "sep"
  }, "/"), /*#__PURE__*/React.createElement("span", null, breadcrumbGroup), activeForm && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "sep"
  }, "/"), /*#__PURE__*/React.createElement("span", {
    className: "current"
  }, activeForm.name), /*#__PURE__*/React.createElement("span", {
    className: "sep"
  }, "/"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10
    }
  }, "v", activeForm.version)))), /*#__PURE__*/React.createElement(FormBuilder, {
    isOrg: isOrg,
    fieldDefs: fieldDefs,
    catLabels: catLabels,
    catColors: catColors,
    onSaveFieldDef: onSaveFieldDef,
    activeForm: activeForm
  })), /*#__PURE__*/React.createElement(SiContextPanel, {
    form: activeForm,
    collapsed: !contextOpen,
    onToggle: () => setContextOpen(prev => !prev),
    orgMeta: orgMeta,
    networkMembers: networkMembers,
    isOrg: isOrg,
    allForms: allKnownForms,
    onNavigateForm: f => setSidebarSelectedId(f.id)
  }), sidebarOpen && /*#__PURE__*/React.createElement("div", {
    onClick: () => setSidebarOpen(false),
    style: {
      position: 'fixed',
      inset: 0,
      background: 'rgba(0,0,0,.5)',
      zIndex: 39
    }
  }));
};

/* ═══════════════════ SCHEMA WORKBENCH (Redesigned) ═══════════════════ */

/* ── DictionaryTab — unified field catalog ── */
const DictionaryTab = ({ fieldDefs, allForms, catLabels, catColors, catIcons, onSaveFieldDef }) => {
  const [search, setSearch] = useState('');
  const [filterCat, setFilterCat] = useState('all');
  const [expandedUri, setExpandedUri] = useState(null);
  const [editDraft, setEditDraft] = useState({});
  const [uriBrowserOpen, setUriBrowserOpen] = useState(false);
  const [uriBrowserMode, setUriBrowserMode] = useState('import'); // 'import' or 'link'
  const [linkTargetUri, setLinkTargetUri] = useState(null);

  // Collect ALL field definitions: vault fields + fieldDefs dictionary + form-generated
  const allFieldEntries = useMemo(() => {
    const map = {};
    // Start with vault fields
    VAULT_FIELDS.forEach(vf => {
      map[vf.uri] = { ...vf, source: 'vault' };
    });
    // Merge fieldDefs (may override/extend vault)
    if (fieldDefs) {
      Object.entries(fieldDefs).forEach(([uri, def]) => {
        if (map[uri]) {
          map[uri] = { ...map[uri], ...def, source: map[uri].source || 'custom' };
        } else {
          map[uri] = { ...def, uri, source: 'custom' };
        }
      });
    }
    // Auto-register fields from forms
    (allForms || []).forEach(f => {
      (f.fields || []).forEach(field => {
        const uri = field.field_uri || `khora:form/${f.id}/${field.key}`;
        if (!map[uri]) {
          map[uri] = {
            uri,
            key: field.key,
            label: field.question || field.key,
            category: field.category || 'case',
            data_type: field.type === 'single_select' ? 'select' : field.type || 'text',
            definition: field.helpText || '',
            scope: '',
            sensitive: field.sensitive || false,
            source: 'form',
            form_name: f.name,
            form_id: f.id
          };
        }
      });
    });
    return Object.values(map);
  }, [fieldDefs, allForms]);

  // Which forms use each field
  const fieldUsage = useMemo(() => {
    const usage = {};
    (allForms || []).forEach(f => {
      (f.fields || []).forEach(field => {
        const uri = field.field_uri || `khora:form/${f.id}/${field.key}`;
        if (!usage[uri]) usage[uri] = [];
        usage[uri].push({ id: f.id, name: f.name });
      });
    });
    return usage;
  }, [allForms]);

  const categories = useMemo(() => [...new Set(allFieldEntries.map(f => f.category).filter(Boolean))], [allFieldEntries]);

  const filtered = useMemo(() => {
    let list = allFieldEntries;
    if (filterCat !== 'all') list = list.filter(f => f.category === filterCat);
    if (search.length >= 2) {
      const q = search.toLowerCase();
      list = list.filter(f =>
        (f.label || '').toLowerCase().includes(q) ||
        (f.key || '').toLowerCase().includes(q) ||
        (f.definition || '').toLowerCase().includes(q) ||
        (f.uri || '').toLowerCase().includes(q)
      );
    }
    return list.sort((a, b) => (a.label || '').localeCompare(b.label || ''));
  }, [allFieldEntries, filterCat, search]);

  const toggleExpand = (uri) => {
    if (expandedUri === uri) {
      setExpandedUri(null);
      setEditDraft({});
    } else {
      const f = allFieldEntries.find(x => x.uri === uri);
      setExpandedUri(uri);
      setEditDraft(f ? { definition: f.definition || '', scope: f.scope || '' } : {});
    }
  };

  const doSave = () => {
    if (!expandedUri || !onSaveFieldDef) return;
    const f = allFieldEntries.find(x => x.uri === expandedUri);
    if (f) {
      onSaveFieldDef({ ...f, ...editDraft });
    }
    setExpandedUri(null);
  };

  // Import a URI library entry as a new field definition
  const doImportFromUri = entry => {
    if (!onSaveFieldDef) return;
    onSaveFieldDef({
      uri: entry.uri,
      key: entry.key,
      label: entry.label,
      definition: entry.definition,
      data_type: entry.data_type || 'text',
      category: entry.category || 'general',
      sensitive: false,
      scope: null,
      authority: entry.source_library || null,
      source_library: entry.source_library,
      source_library_id: entry.source_library_id,
      version: 1,
      version_history: [],
      migration_rules: [],
      supersedes: null,
      superseded_by: null,
      created_by: 'uri_library',
      created_at: Date.now()
    });
    setUriBrowserOpen(false);
  };

  // Link an existing field to a standard URI
  const doLinkToUri = entry => {
    if (!onSaveFieldDef || !linkTargetUri) return;
    const existing = allFieldEntries.find(f => f.uri === linkTargetUri);
    if (existing) {
      onSaveFieldDef({
        ...existing,
        standard_uri: entry.uri,
        standard_label: entry.label,
        standard_library: entry.source_library,
        standard_library_id: entry.source_library_id
      });
    }
    setUriBrowserOpen(false);
    setLinkTargetUri(null);
  };

  const typeColor = (dt) => {
    const m = { text: 'blue', select: 'teal', date: 'gold', number: 'orange', boolean: 'green',
      email: 'blue', phone: 'blue', address: 'gold', text_long: 'purple', document: 'orange',
      single_select: 'teal', multi_select: 'teal', duration: 'gold' };
    return m[dt] || 'blue';
  };

  return React.createElement('div', null,
    // Stats row + import button
    React.createElement('div', { className: 'sw-dict-stats', style: { justifyContent: 'space-between', alignItems: 'center' } },
      React.createElement('div', { style: { display: 'flex', gap: 16, flexWrap: 'wrap' } },
        React.createElement('span', { className: 'sw-dict-stat' }, React.createElement('strong', null, allFieldEntries.length), ' total fields'),
        React.createElement('span', { className: 'sw-dict-stat' }, React.createElement('strong', null, allFieldEntries.filter(f => f.source === 'vault').length), ' vault'),
        React.createElement('span', { className: 'sw-dict-stat' }, React.createElement('strong', null, allFieldEntries.filter(f => f.sensitive).length), ' sensitive')
      ),
      onSaveFieldDef && React.createElement('button', {
        className: 'b-gho b-sm',
        style: { display: 'flex', alignItems: 'center', gap: 6, color: 'var(--teal)', borderColor: 'var(--teal)' },
        onClick: () => { setUriBrowserMode('import'); setUriBrowserOpen(true); }
      },
        React.createElement(I, { n: 'globe', s: 12, c: 'var(--teal)' }),
        'Import from URI Library'
      )
    ),
    // Toolbar
    React.createElement('div', { className: 'sw-dict-toolbar' },
      React.createElement('div', { className: 'sw-dict-search' },
        React.createElement('span', { className: 'sw-dict-search-icon' }, React.createElement(I, { n: 'search', s: 13, c: 'var(--tx-3)' })),
        React.createElement('input', { value: search, onChange: e => setSearch(e.target.value), placeholder: 'Search fields by name, key, or definition...' })
      ),
      React.createElement('div', { className: 'sw-dict-filters' },
        React.createElement('button', { className: `sw-dict-filter${filterCat === 'all' ? ' active' : ''}`, onClick: () => setFilterCat('all') }, 'All'),
        categories.map(c => React.createElement('button', {
          key: c,
          className: `sw-dict-filter${filterCat === c ? ' active' : ''}`,
          onClick: () => setFilterCat(c)
        }, (catLabels || {})[c] || c))
      )
    ),
    // Grid
    filtered.length === 0
      ? React.createElement('div', { className: 'sw-dict-empty' }, search ? `No fields matching "${search}"` : 'No fields in this category.')
      : React.createElement('div', { className: 'sw-dict-grid' },
          filtered.map(f => {
            const isExpanded = expandedUri === f.uri;
            const uses = fieldUsage[f.uri] || [];
            const catColor = (catColors || {})[f.category] || 'blue';
            return React.createElement('div', {
              key: f.uri,
              className: `sw-dict-card${isExpanded ? ' expanded' : ''}`,
              onClick: () => toggleExpand(f.uri)
            },
              React.createElement('div', { className: 'sw-dict-card-header' },
                React.createElement('div', null,
                  React.createElement('div', { className: 'sw-dict-card-name' }, f.label || f.key),
                  React.createElement('div', { className: 'sw-dict-card-uri' }, f.uri)
                ),
                React.createElement('div', { className: 'sw-dict-card-badges' },
                  f.sensitive && React.createElement('span', { className: 'tag tag-orange', style: { fontSize: 8 } }, 'SENSITIVE'),
                  React.createElement('span', { className: `tag tag-${catColor}`, style: { fontSize: 8 } }, (catLabels || {})[f.category] || f.category),
                  React.createElement('span', { className: `tag tag-${typeColor(f.data_type)}`, style: { fontSize: 8 } }, (f.data_type || 'text').toUpperCase())
                )
              ),
              React.createElement('div', { className: 'sw-dict-card-def' }, f.definition || 'No definition yet.'),
              // Usage tags
              uses.length > 0 && React.createElement('div', { className: 'sw-dict-card-usage' },
                React.createElement('span', { style: { fontSize: 10, color: 'var(--tx-3)', fontFamily: 'var(--mono)' } }, 'Used in:'),
                uses.map(u => React.createElement('span', { key: u.id, className: 'sw-dict-card-form-tag' }, u.name))
              ),
              // Expanded: scope + editor
              isExpanded && React.createElement('div', null,
                f.scope && React.createElement('div', { className: 'sw-dict-card-scope' },
                  React.createElement('strong', { style: { color: 'var(--tx-2)', fontSize: 10 } }, 'SCOPE: '), f.scope
                ),
                // Standard URI link display
                f.standard_uri && React.createElement('div', {
                  className: 'uri-browser-selected-badge',
                  style: { marginBottom: 8 }
                },
                  React.createElement(I, { n: 'globe', s: 10, c: 'var(--teal)' }),
                  'Linked: ', f.standard_uri,
                  f.standard_library && React.createElement('span', {
                    style: { opacity: .7, marginLeft: 4 }
                  }, '(', f.standard_library, ')')
                ),
                onSaveFieldDef && React.createElement('div', { className: 'sw-dict-card-editor', onClick: e => e.stopPropagation() },
                  React.createElement('label', null, 'Definition'),
                  React.createElement('textarea', {
                    value: editDraft.definition || '',
                    onChange: e => setEditDraft(d => ({ ...d, definition: e.target.value })),
                    placeholder: 'What this field means...'
                  }),
                  React.createElement('label', null, 'Scope'),
                  React.createElement('textarea', {
                    value: editDraft.scope || '',
                    onChange: e => setEditDraft(d => ({ ...d, scope: e.target.value })),
                    placeholder: 'What is included and excluded...'
                  }),
                  // Link to Standard URI button
                  React.createElement('button', {
                    className: 'b-gho b-xs',
                    style: { display: 'flex', alignItems: 'center', gap: 5, color: 'var(--teal)', borderColor: 'var(--teal)', alignSelf: 'flex-start', fontSize: 11 },
                    onClick: e => { e.stopPropagation(); setLinkTargetUri(f.uri); setUriBrowserMode('link'); setUriBrowserOpen(true); }
                  },
                    React.createElement(I, { n: 'globe', s: 10, c: 'var(--teal)' }),
                    f.standard_uri ? 'Change Linked URI' : 'Link to Standard URI'
                  ),
                  React.createElement('div', { style: { display: 'flex', gap: 6, justifyContent: 'flex-end' } },
                    React.createElement(SwBtn, { ghost: true, onClick: (e) => { e.stopPropagation(); setExpandedUri(null); } }, 'Cancel'),
                    React.createElement(SwBtn, { accent: SWC.given, onClick: (e) => { e.stopPropagation(); doSave(); } }, 'Save')
                  )
                )
              )
            );
          })
        ),
    // URI Library Browser modal
    uriBrowserOpen && React.createElement(UriLibraryBrowser, {
      open: true,
      onClose: () => { setUriBrowserOpen(false); setLinkTargetUri(null); },
      onSelect: uriBrowserMode === 'link' ? doLinkToUri : doImportFromUri,
      mode: uriBrowserMode === 'link' ? 'link' : 'select'
    })
  );
};

/* ── ColumnsTab — field × form matrix ── */
const ColumnsTab = ({ allForms, fieldDefs, onNavigateToForm }) => {
  const [filterCat, setFilterCat] = useState('all');
  const [sortBy, setSortBy] = useState('name'); // name | usage | category

  // Build the matrix data
  const matrixData = useMemo(() => {
    const fieldMap = {};
    // Collect all unique fields across all forms
    (allForms || []).forEach(f => {
      (f.fields || []).forEach(field => {
        const key = field.key;
        if (!fieldMap[key]) {
          fieldMap[key] = {
            key,
            label: field.question || field.key,
            category: field.category || field.section || 'general',
            uri: field.field_uri || `khora:form/${f.id}/${key}`,
            forms: {},
            usageCount: 0
          };
        }
        fieldMap[key].forms[f.id] = {
          present: true,
          bound: !!(field.eo && field.eo.chain && field.eo.chain.some(c => c.op === 'CON')),
          type: field.type
        };
        fieldMap[key].usageCount++;
      });
    });
    return Object.values(fieldMap);
  }, [allForms]);

  const categories = useMemo(() => [...new Set(matrixData.map(f => f.category).filter(Boolean))], [matrixData]);
  const forms = allForms || [];

  const filtered = useMemo(() => {
    let list = matrixData;
    if (filterCat !== 'all') list = list.filter(f => f.category === filterCat);
    if (sortBy === 'usage') list = [...list].sort((a, b) => b.usageCount - a.usageCount);
    else if (sortBy === 'category') list = [...list].sort((a, b) => (a.category || '').localeCompare(b.category || ''));
    else list = [...list].sort((a, b) => (a.label || '').localeCompare(b.label || ''));
    return list;
  }, [matrixData, filterCat, sortBy]);

  const totalFields = matrixData.length;
  const multiFormFields = matrixData.filter(f => f.usageCount >= 2).length;
  const singleFormFields = matrixData.filter(f => f.usageCount === 1).length;

  return React.createElement('div', null,
    // Stats
    React.createElement('div', { className: 'sw-cols-stats' },
      React.createElement('span', { className: 'sw-cols-stat' }, React.createElement('strong', null, totalFields), ' total fields'),
      React.createElement('span', { className: 'sw-cols-stat' }, React.createElement('strong', null, multiFormFields), ' shared across forms'),
      React.createElement('span', { className: 'sw-cols-stat' }, React.createElement('strong', null, singleFormFields), ' unique to one form')
    ),
    // Toolbar
    React.createElement('div', { className: 'sw-cols-toolbar' },
      React.createElement('div', { className: 'sw-dict-filters' },
        React.createElement('button', { className: `sw-dict-filter${filterCat === 'all' ? ' active' : ''}`, onClick: () => setFilterCat('all') }, 'All'),
        categories.map(c => React.createElement('button', {
          key: c,
          className: `sw-dict-filter${filterCat === c ? ' active' : ''}`,
          onClick: () => setFilterCat(c)
        }, c))
      ),
      React.createElement('div', { style: { display: 'flex', gap: 4, marginLeft: 'auto' } },
        ['name', 'usage', 'category'].map(s => React.createElement('button', {
          key: s,
          className: `sw-dict-filter${sortBy === s ? ' active' : ''}`,
          onClick: () => setSortBy(s)
        }, s === 'name' ? 'A-Z' : s === 'usage' ? 'Usage' : 'Category'))
      )
    ),
    // Table
    forms.length === 0 || filtered.length === 0
      ? React.createElement('div', { className: 'sw-dict-empty' }, 'No fields to show. Create forms with fields to see the column mapping.')
      : React.createElement('div', { className: 'sw-cols-table-wrap' },
          React.createElement('table', { className: 'sw-cols-table' },
            React.createElement('thead', null,
              React.createElement('tr', null,
                React.createElement('th', { style: { minWidth: 180 } }, 'Field'),
                React.createElement('th', { style: { width: 70 } }, 'Category'),
                React.createElement('th', { style: { width: 50 } }, 'Usage'),
                forms.map(f => React.createElement('th', { key: f.id, className: 'sw-cols-form-th', title: f.name }, f.name))
              )
            ),
            React.createElement('tbody', null,
              filtered.map(field => React.createElement('tr', { key: field.key },
                React.createElement('td', null,
                  React.createElement('span', { className: 'sw-cols-field-name' }, field.label),
                  React.createElement('div', { style: { fontSize: 9, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginTop: 1 } }, field.key)
                ),
                React.createElement('td', null,
                  React.createElement('span', {
                    className: 'sw-cols-field-cat',
                    style: { background: `var(--${OBS_CAT_COLORS[field.category] || 'blue'}-dim)`, color: `var(--${OBS_CAT_COLORS[field.category] || 'blue'})` }
                  }, field.category)
                ),
                React.createElement('td', null,
                  React.createElement('span', { style: { fontFamily: 'var(--mono)', fontSize: 11 } }, field.usageCount),
                  React.createElement('span', { className: 'sw-cols-usage-bar' },
                    React.createElement('span', { className: 'sw-cols-usage-fill', style: { width: `${Math.min(100, (field.usageCount / Math.max(forms.length, 1)) * 100)}%` } })
                  )
                ),
                forms.map(f => {
                  const cell = field.forms[f.id];
                  return React.createElement('td', {
                    key: f.id,
                    className: 'sw-cols-cell',
                    onClick: () => cell && onNavigateToForm && onNavigateToForm(f.id, field.key),
                    title: cell ? (cell.bound ? 'Present + bound to framework' : 'Present') : 'Not in this form'
                  },
                    cell
                      ? React.createElement('span', { className: cell.bound ? 'sw-cols-cell-bound' : 'sw-cols-cell-present' }, cell.bound ? '\u25CF' : '\u2713')
                      : React.createElement('span', { className: 'sw-cols-cell-absent' }, '\u2013')
                  );
                })
              ))
            )
          )
        )
  );
};

/* ── GovernanceTab — maturity pipeline, propagation, adoption, activity ── */
const GovernanceTab = ({ allForms, onNavigateToForm }) => {
  // Group forms by maturity for the pipeline
  const pipeline = useMemo(() => {
    const lanes = { draft: [], trial: [], normative: [], de_facto: [], deprecated: [] };
    (allForms || []).forEach(f => {
      const m = f.maturity || 'draft';
      if (lanes[m]) lanes[m].push(f);
    });
    return lanes;
  }, [allForms]);

  // Propagation data
  const propagationData = useMemo(() => {
    return (allForms || []).filter(f => f.source && f.source.level === 'network').map(f => ({
      id: f.id,
      name: f.name,
      propagation: f.source.propagation || 'optional',
      maturity: f.maturity || 'draft'
    }));
  }, [allForms]);

  // Version timeline — combine all forms' versions
  const timeline = useMemo(() => {
    const entries = [];
    (allForms || []).forEach(f => {
      entries.push({
        form_id: f.id,
        form_name: f.name,
        version: f.version || 1,
        maturity: f.maturity || 'draft',
        date: f.savedAt || Date.now(),
        type: 'version'
      });
    });
    return entries.sort((a, b) => b.date - a.date).slice(0, 20);
  }, [allForms]);

  const laneConfig = {
    draft: { label: 'Draft', color: 'var(--blue)', bg: 'var(--blue-dim)' },
    trial: { label: 'Trial', color: 'var(--orange)', bg: 'rgba(224,148,58,.1)' },
    normative: { label: 'Normative', color: 'var(--green)', bg: 'var(--green-dim)' },
    de_facto: { label: 'De facto', color: 'var(--purple)', bg: 'rgba(167,139,250,.1)' },
    deprecated: { label: 'Deprecated', color: 'var(--red)', bg: 'var(--red-dim)' }
  };

  const propConfig = {
    required: { label: 'Required', color: 'var(--red)' },
    standard: { label: 'Standard', color: 'var(--gold)' },
    recommended: { label: 'Recommended', color: 'var(--blue)' },
    optional: { label: 'Optional', color: 'var(--tx-3)' }
  };

  return React.createElement('div', null,
    // Top grid: pipeline + propagation
    React.createElement('div', { className: 'sw-gov-grid' },
      // Maturity Pipeline
      React.createElement('div', { className: 'sw-gov-card', style: { gridColumn: '1 / -1' } },
        React.createElement('div', { className: 'sw-gov-card-title' },
          React.createElement(I, { n: 'layers', s: 13 }), 'Maturity Pipeline'
        ),
        React.createElement('div', { className: 'sw-gov-pipeline' },
          ['draft', 'trial', 'normative', 'de_facto', 'deprecated'].map(stage => {
            const cfg = laneConfig[stage];
            const items = pipeline[stage] || [];
            return React.createElement('div', { key: stage, className: 'sw-gov-lane' },
              React.createElement('div', { className: 'sw-gov-lane-header', style: { color: cfg.color } },
                React.createElement('span', null, cfg.label),
                React.createElement('span', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)' } }, items.length)
              ),
              React.createElement('div', { className: 'sw-gov-lane-items' },
                items.length === 0
                  ? React.createElement('div', { style: { fontSize: 10, color: 'var(--tx-3)', fontStyle: 'italic', padding: 8 } }, 'None')
                  : items.map(f => React.createElement('div', {
                      key: f.id,
                      className: 'sw-gov-lane-item',
                      onClick: () => onNavigateToForm && onNavigateToForm(f.id)
                    },
                    React.createElement('span', { style: { width: 6, height: 6, borderRadius: '50%', background: cfg.color, flexShrink: 0 } }),
                    React.createElement('span', { style: { overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, f.name),
                    React.createElement('span', { style: { fontSize: 9, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginLeft: 'auto' } }, `v${f.version || 1}`)
                  ))
              )
            );
          })
        )
      ),

      // Propagation Map
      React.createElement('div', { className: 'sw-gov-card' },
        React.createElement('div', { className: 'sw-gov-card-title' },
          React.createElement(I, { n: 'globe', s: 13 }), 'Network Propagation'
        ),
        propagationData.length === 0
          ? React.createElement('div', { className: 'sw-gov-empty' }, 'No network forms. Forms authored at the network level will show their propagation rules here.')
          : React.createElement('div', { className: 'sw-gov-propagation' },
              propagationData.map(f => {
                const pcfg = propConfig[f.propagation] || propConfig.optional;
                return React.createElement('div', { key: f.id, className: 'sw-gov-prop-row' },
                  React.createElement('span', { style: { flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', color: 'var(--tx-0)' } }, f.name),
                  React.createElement('span', { className: 'sw-gov-prop-arrow' }, '\u2192'),
                  React.createElement('span', {
                    className: 'tag',
                    style: { fontSize: 8, color: pcfg.color, background: `${pcfg.color}18`, border: `1px solid ${pcfg.color}30` }
                  }, pcfg.label)
                );
              })
            )
      ),

      // Version Timeline
      React.createElement('div', { className: 'sw-gov-card' },
        React.createElement('div', { className: 'sw-gov-card-title' },
          React.createElement(I, { n: 'clock', s: 13 }), 'Recent Versions'
        ),
        timeline.length === 0
          ? React.createElement('div', { className: 'sw-gov-empty' }, 'No version history yet.')
          : React.createElement('div', { className: 'sw-gov-timeline' },
              timeline.slice(0, 10).map((entry, i) => {
                const mcfg = laneConfig[entry.maturity] || laneConfig.draft;
                return React.createElement('div', { key: `${entry.form_id}-${i}`, className: 'sw-gov-tl-node' },
                  React.createElement('div', { className: `sw-gov-tl-dot ${i === 0 ? 'current' : 'past'}` }),
                  React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 6 } },
                    React.createElement('span', { style: { fontSize: 11, fontFamily: 'var(--mono)', fontWeight: 600, color: mcfg.color } }, `v${entry.version}`),
                    React.createElement('span', { style: { fontSize: 11, color: 'var(--tx-0)', fontWeight: 500 } }, entry.form_name)
                  ),
                  React.createElement('div', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginTop: 2 } },
                    new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                  )
                );
              })
            )
      )
    ),

    // Activity Feed
    React.createElement('div', { className: 'sw-gov-card' },
      React.createElement('div', { className: 'sw-gov-card-title' },
        React.createElement(I, { n: 'activity', s: 13 }), 'Schema Activity'
      ),
      React.createElement('div', { className: 'sw-gov-activity' },
        (allForms || []).length === 0
          ? React.createElement('div', { className: 'sw-gov-empty' }, 'No schema activity yet. Create and save forms to see activity here.')
          : (allForms || []).slice(0, 8).map((f, i) => React.createElement('div', { key: f.id, className: 'sw-gov-activity-item' },
              React.createElement('span', { className: 'sw-gov-activity-time' }, f.savedAt ? new Date(f.savedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'Recent'),
              React.createElement('span', { style: { width: 5, height: 5, borderRadius: '50%', background: i === 0 ? 'var(--teal)' : 'var(--tx-3)', flexShrink: 0, marginTop: 4 } }),
              React.createElement('span', null,
                React.createElement('span', { style: { color: 'var(--tx-0)', fontWeight: 500 } }, f.name),
                React.createElement('span', { style: { color: 'var(--tx-3)' } }, ` \u2014 v${f.version || 1} \u00B7 ${(MATURITY_LEVELS[f.maturity] || MATURITY_LEVELS.draft).label}`)
              )
            ))
      )
    )
  );
};

/* ── FormsTab — restructured form builder with split panel ── */
const FormsTab = ({
  allForms,
  savedForms,
  form, setForm,
  frameworks, bindings, crosswalks,
  setFrameworks, setBindings, setCrosswalks,
  fieldDefs, catLabels, catColors,
  onSaveFieldDef,
  onSave, onLoad, onNewForm, onVersionBump,
  showToast,
  isOrg, orgMeta, networkMembers
}) => {
  const [selectedFormId, setSelectedFormId] = useState(null);
  const [formSearch, setFormSearch] = useState('');
  const [expandedGroups, setExpandedGroups] = useState(new Set(['my', 'network']));
  const [showPreview, setShowPreview] = useState(false);
  const [expandedSections, setExpandedSections] = useState(new Set());
  const [showFwBar, setShowFwBar] = useState(false);
  const [editingQuestion, setEditingQuestion] = useState(null);
  const [fieldPickerOpen, setFieldPickerOpen] = useState(false);
  const [fieldPickerSection, setFieldPickerSection] = useState(null);

  // Categorize forms
  const myForms = useMemo(() => (savedForms || []).filter(f => !f.sourceType || f.sourceType === 'local'), [savedForms]);
  const orgForms = useMemo(() => (savedForms || []).filter(f => f.sourceType === 'org'), [savedForms]);
  const networkForms = useMemo(() => {
    const saved = (savedForms || []).filter(f => f.sourceType === 'network');
    // Also include DEFAULT_FORMS that aren't in savedForms
    const savedIds = new Set(saved.map(f => f.id));
    const defaults = (DEFAULT_FORMS || []).filter(f => !savedIds.has(f.id)).map(f => ({
      id: f.id,
      name: f.name,
      version: f.version,
      maturity: f.maturity,
      sourceType: 'network',
      source: f.source,
      form: f
    }));
    return [...saved, ...defaults];
  }, [savedForms]);

  const toggleGroup = g => {
    setExpandedGroups(prev => {
      const next = new Set(prev);
      next.has(g) ? next.delete(g) : next.add(g);
      return next;
    });
  };

  const doLoadForm = (formData) => {
    if (onLoad && formData) {
      onLoad(formData);
      setSelectedFormId(formData.id);
    }
  };

  const doLoadNetworkForm = (nf) => {
    // For network forms that haven't been saved locally, load from DEFAULT_FORMS
    if (nf.form) {
      // Build form structure compatible with FormBuilder
      const loaded = {
        name: nf.form.name || nf.name,
        key: nf.form.key || formNameToKey(nf.name),
        version: nf.form.version || nf.version || 1,
        maturity: nf.form.maturity || nf.maturity || 'draft',
        description: nf.form.description || '',
        source: nf.form.source || nf.source,
        sections: []
      };
      // Convert fields to sections/questions format
      if (nf.form.fields) {
        const sectionMap = {};
        nf.form.fields.forEach(field => {
          const secKey = field.section || 'general';
          if (!sectionMap[secKey]) {
            sectionMap[secKey] = {
              id: `sec_${secKey}`,
              title: (OBS_CAT_LABELS[secKey] || secKey).charAt(0).toUpperCase() + (OBS_CAT_LABELS[secKey] || secKey).slice(1),
              questions: []
            };
          }
          sectionMap[secKey].questions.push({
            id: field.id,
            key: field.key,
            prompt: field.question,
            type: field.type || 'single_select',
            options: (field.options || []).map((opt, oi) => ({
              id: `${field.id}_opt_${oi}`,
              value: opt.v,
              label: opt.l
            })),
            helpText: field.helpText || '',
            field_uri: field.field_uri || `khora:form/${nf.id}/${field.key}`,
            maturity: field.maturity,
            sensitive: field.sensitive,
            eo: field.eo
          });
        });
        loaded.sections = Object.values(sectionMap);
      }
      if (setForm) setForm(loaded);
      setSelectedFormId(nf.id);
    }
  };

  // Filter forms by search
  const filterForms = (list) => {
    if (!formSearch || formSearch.length < 2) return list;
    const q = formSearch.toLowerCase();
    return list.filter(f => (f.name || '').toLowerCase().includes(q));
  };

  // Toggle section collapse
  const toggleSection = (secId) => {
    setExpandedSections(prev => {
      const next = new Set(prev);
      next.has(secId) ? next.delete(secId) : next.add(secId);
      return next;
    });
  };

  // Form mutations (delegated to parent FormBuilder logic)
  const updateFormName = (name) => {
    if (setForm) setForm(prev => ({ ...prev, name }));
  };

  const updateFormDescription = (description) => {
    if (setForm) setForm(prev => ({ ...prev, description }));
  };

  const updateFormMaturity = (maturity) => {
    if (setForm) setForm(prev => ({ ...prev, maturity }));
  };

  const addSection = () => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: [...(prev.sections || []), {
        id: `sec_${Date.now()}`,
        title: 'New Section',
        questions: []
      }]
    }));
  };

  const addQuestion = (secId) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => s.id === secId ? {
        ...s,
        questions: [...s.questions, {
          id: `q_${Date.now()}`,
          prompt: 'New question',
          type: 'single_select',
          options: [],
          key: `field_${Date.now()}`
        }]
      } : s)
    }));
  };

  const addOption = (secId, qId) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => s.id === secId ? {
        ...s,
        questions: s.questions.map(q => q.id === qId ? {
          ...q,
          options: [...(q.options || []), {
            id: `opt_${Date.now()}`,
            value: `option_${(q.options || []).length + 1}`,
            label: 'New option'
          }]
        } : q)
      } : s)
    }));
  };

  const updateQuestion = (secId, qId, updates) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => s.id === secId ? {
        ...s,
        questions: s.questions.map(q => q.id === qId ? { ...q, ...updates } : q)
      } : s)
    }));
  };

  const updateOption = (secId, qId, optId, updates) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => s.id === secId ? {
        ...s,
        questions: s.questions.map(q => q.id === qId ? {
          ...q,
          options: (q.options || []).map(o => o.id === optId ? { ...o, ...updates } : o)
        } : q)
      } : s)
    }));
  };

  const removeQuestion = (secId, qId) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => s.id === secId ? {
        ...s,
        questions: s.questions.filter(q => q.id !== qId)
      } : s)
    }));
  };

  const removeOption = (secId, qId, optId) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => s.id === secId ? {
        ...s,
        questions: s.questions.map(q => q.id === qId ? {
          ...q,
          options: (q.options || []).filter(o => o.id !== optId)
        } : q)
      } : s)
    }));
  };

  const removeSection = (secId) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).filter(s => s.id !== secId)
    }));
  };

  const updateSectionTitle = (secId, title) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => s.id === secId ? { ...s, title } : s)
    }));
  };

  // Duplicate a question within a section
  const duplicateQuestion = (secId, qId) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => {
        if (s.id !== secId) return s;
        const srcIdx = s.questions.findIndex(q => q.id === qId);
        if (srcIdx < 0) return s;
        const src = s.questions[srcIdx];
        const clone = {
          ...src,
          id: `q_${Date.now()}`,
          key: `${src.key || 'field'}_copy_${Date.now()}`,
          prompt: src.prompt + ' (copy)',
          options: (src.options || []).map((o, i) => ({ ...o, id: `opt_${Date.now()}_${i}` }))
        };
        const qs = [...s.questions];
        qs.splice(srcIdx + 1, 0, clone);
        return { ...s, questions: qs };
      })
    }));
  };

  // Toggle required flag on a question
  const toggleRequired = (secId, qId) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => s.id === secId ? {
        ...s,
        questions: s.questions.map(q => q.id === qId ? { ...q, required: !q.required } : q)
      } : s)
    }));
  };

  // Move section up or down
  const moveSection = (secId, dir) => {
    if (!setForm) return;
    setForm(prev => {
      const secs = [...(prev.sections || [])];
      const idx = secs.findIndex(s => s.id === secId);
      if (idx < 0) return prev;
      const newIdx = idx + dir;
      if (newIdx < 0 || newIdx >= secs.length) return prev;
      [secs[idx], secs[newIdx]] = [secs[newIdx], secs[idx]];
      return { ...prev, sections: secs };
    });
  };

  // Move question up or down within a section
  const moveQuestion = (secId, qId, dir) => {
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => {
        if (s.id !== secId) return s;
        const qs = [...s.questions];
        const idx = qs.findIndex(q => q.id === qId);
        if (idx < 0) return s;
        const newIdx = idx + dir;
        if (newIdx < 0 || newIdx >= qs.length) return s;
        [qs[idx], qs[newIdx]] = [qs[newIdx], qs[idx]];
        return { ...s, questions: qs };
      })
    }));
  };

  // Expand all / Collapse all sections
  const toggleAllSections = () => {
    const allIds = sections.map(s => s.id);
    const allCollapsed = allIds.every(id => expandedSections.has(id));
    if (allCollapsed) {
      setExpandedSections(new Set());
    } else {
      setExpandedSections(new Set(allIds));
    }
  };

  // Insert from dictionary
  const doInsertFromDictionary = (fieldDef, secId) => {
    const typeMap = { text: 'text', text_long: 'text', number: 'number', date: 'date', boolean: 'boolean', email: 'text', phone: 'text', address: 'text', document: 'text', select: 'single_select' };
    const qType = typeMap[fieldDef.data_type] || 'single_select';
    const options = qType === 'single_select' && fieldDef.data_type === 'boolean'
      ? [{ id: `opt_y_${Date.now()}`, value: 'yes', label: 'Yes' }, { id: `opt_n_${Date.now()}`, value: 'no', label: 'No' }]
      : [];
    if (!setForm) return;
    setForm(prev => ({
      ...prev,
      sections: (prev.sections || []).map(s => s.id === secId ? {
        ...s,
        questions: [...s.questions, {
          id: `q_${Date.now()}`,
          key: fieldDef.key,
          prompt: fieldDef.label,
          type: qType,
          options,
          helpText: fieldDef.definition || '',
          field_uri: fieldDef.uri
        }]
      } : s)
    }));
    setFieldPickerOpen(false);
    setFieldPickerSection(null);
  };

  // Render form list group
  const renderFormGroup = (label, items, groupKey, icon) => {
    const isOpen = expandedGroups.has(groupKey);
    const filteredItems = filterForms(items);
    return React.createElement('div', { key: groupKey },
      React.createElement('div', {
        className: 'sw-forms-group-header',
        onClick: () => toggleGroup(groupKey)
      },
        React.createElement('span', { className: 'sw-forms-group-label' },
          React.createElement(I, { n: isOpen ? 'chevronDown' : 'chevronRight', s: 10 }),
          React.createElement(I, { n: icon, s: 11 }),
          label
        ),
        React.createElement('span', { className: 'sw-forms-group-count' }, items.length)
      ),
      isOpen && filteredItems.map(f => React.createElement('div', {
        key: f.id,
        className: `sw-forms-item${selectedFormId === f.id ? ' active' : ''}`,
        onClick: () => f.form ? doLoadNetworkForm(f) : doLoadForm(f)
      },
        React.createElement('div', { className: `sw-forms-item-dot${selectedFormId === f.id ? ' active' : ''}` }),
        React.createElement('div', { style: { flex: 1, minWidth: 0 } },
          React.createElement('div', { className: 'sw-forms-item-name' }, f.name),
          React.createElement('div', { className: 'sw-forms-item-meta' },
            React.createElement('span', null, `v${f.version || 1}`),
            React.createElement('span', null, '\u00B7'),
            React.createElement('span', {
              className: `sw-forms-item-status ${f.maturity || 'draft'}`,
              title: (MATURITY_LEVELS[f.maturity] || MATURITY_LEVELS.draft).desc
            }, (MATURITY_LEVELS[f.maturity] || MATURITY_LEVELS.draft).label)
          )
        )
      )),
      isOpen && filteredItems.length === 0 && React.createElement('div', {
        style: { padding: '12px 16px', fontSize: 11, color: 'var(--tx-3)', fontStyle: 'italic' }
      }, formSearch ? 'No matches' : 'No forms yet')
    );
  };

  // Maturity color
  const matColor = (m) => {
    const mc = { draft: 'blue', trial: 'orange', normative: 'green', de_facto: 'purple', deprecated: 'red' };
    return mc[m] || 'blue';
  };

  const sections = (form && form.sections) || [];

  return React.createElement('div', { className: 'sw-forms-split' },
    // LEFT: Form list
    React.createElement('div', { className: 'sw-forms-list' },
      React.createElement('div', { className: 'sw-forms-list-header' },
        React.createElement('span', { style: { fontSize: 11, fontWeight: 600, fontFamily: 'var(--mono)', color: 'var(--tx-2)', letterSpacing: '.06em' } }, 'FORMS'),
        React.createElement('button', {
          className: 'b-gho b-xs',
          onClick: onNewForm,
          style: { fontSize: 12, padding: '3px 10px' }
        }, '+ New')
      ),
      React.createElement('div', { className: 'sw-forms-list-search' },
        React.createElement('span', { className: 'sw-forms-list-search-icon' }, React.createElement(I, { n: 'search', s: 12, c: 'var(--tx-3)' })),
        React.createElement('input', { value: formSearch, onChange: e => setFormSearch(e.target.value), placeholder: 'Search forms...' })
      ),
      React.createElement('div', { className: 'sw-forms-list-scroll' },
        renderFormGroup('MY FORMS', myForms, 'my', 'folder'),
        renderFormGroup('ORG FORMS', orgForms, 'org', 'shieldCheck'),
        renderFormGroup('NETWORK', networkForms, 'network', 'globe')
      )
    ),

    // RIGHT: Form editor
    React.createElement('div', { className: 'sw-forms-editor', style: { position: 'relative' } },
      !form
        ? React.createElement('div', { style: { padding: 40, textAlign: 'center' } },
            React.createElement('div', { style: { fontSize: 40, opacity: .3, marginBottom: 12 } }, '\u25C7'),
            React.createElement('div', { style: { fontSize: 14, color: 'var(--tx-2)', marginBottom: 8 } }, 'Select a form from the list or create a new one'),
            React.createElement(SwBtn, { accent: SWC.given, onClick: onNewForm }, '+ New form')
          )
        : React.createElement('div', null,
            // Form header
            React.createElement('div', { className: 'sw-forms-editor-header' },
              React.createElement('div', { style: { flex: 1 } },
                React.createElement('input', {
                  className: 'sw-forms-editor-name',
                  value: form.name || '',
                  onChange: e => updateFormName(e.target.value),
                  placeholder: 'Form name...'
                }),
                React.createElement('div', { className: 'sw-forms-editor-badges' },
                  React.createElement('span', {
                    className: `tag tag-${matColor(form.maturity)}`,
                    style: { fontSize: 9, cursor: 'pointer' },
                    onClick: () => {
                      const mats = Object.keys(MATURITY_LEVELS);
                      const idx = mats.indexOf(form.maturity || 'draft');
                      updateFormMaturity(mats[(idx + 1) % mats.length]);
                    },
                    title: 'Click to cycle maturity'
                  }, (MATURITY_LEVELS[form.maturity] || MATURITY_LEVELS.draft).label),
                  React.createElement('span', {
                    className: 'tag tag-blue',
                    style: { fontSize: 9 }
                  }, `v${form.version || 1}`),
                  form.key && React.createElement('span', {
                    style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)' }
                  }, form.key),
                  form.source && form.source.propagation && React.createElement('span', {
                    className: `tag tag-${form.source.propagation === 'required' ? 'red' : form.source.propagation === 'standard' ? 'gold' : 'blue'}`,
                    style: { fontSize: 8 }
                  }, (PROPAGATION_LEVELS[form.source.propagation] || {}).label || form.source.propagation)
                )
              ),
              React.createElement('div', { className: 'sw-forms-editor-actions' },
                React.createElement(SwBtn, { ghost: true, onClick: () => setShowPreview(!showPreview) },
                  React.createElement(I, { n: showPreview ? 'x' : 'eye', s: 13 }),
                  showPreview ? 'Edit' : 'Preview'
                ),
                onSave && React.createElement(SwBtn, { accent: SWC.given, onClick: onSave },
                  React.createElement(I, { n: 'save', s: 13 }),
                  'Save'
                )
              )
            ),

            // Description
            React.createElement('textarea', {
              className: 'sw-forms-editor-desc',
              value: form.description || '',
              onChange: e => updateFormDescription(e.target.value),
              placeholder: 'Form description...',
              rows: 2
            }),

            // Stats summary bar
            !showPreview && sections.length > 0 && (() => {
              const totalQ = sections.reduce((sum, s) => sum + (s.questions || []).length, 0);
              const linkedQ = sections.reduce((sum, s) => sum + (s.questions || []).filter(q => q.field_uri).length, 0);
              const reqQ = sections.reduce((sum, s) => sum + (s.questions || []).filter(q => q.required).length, 0);
              const allCollapsed = sections.every(s => expandedSections.has(s.id));
              return React.createElement('div', { className: 'sw-f-stats' },
                React.createElement('div', { className: 'sw-f-stat' },
                  React.createElement(I, { n: 'layers', s: 12, c: 'var(--teal)' }),
                  React.createElement('strong', null, sections.length),
                  sections.length === 1 ? 'section' : 'sections'
                ),
                React.createElement('div', { className: 'sw-f-stats-divider' }),
                React.createElement('div', { className: 'sw-f-stat' },
                  React.createElement(I, { n: 'messageSquare', s: 12, c: 'var(--blue)' }),
                  React.createElement('strong', null, totalQ),
                  totalQ === 1 ? 'question' : 'questions'
                ),
                React.createElement('div', { className: 'sw-f-stats-divider' }),
                React.createElement('div', { className: 'sw-f-stat' },
                  React.createElement(I, { n: 'link', s: 12, c: 'var(--purple)' }),
                  React.createElement('strong', null, linkedQ),
                  'linked'
                ),
                reqQ > 0 && React.createElement('div', { className: 'sw-f-stats-divider' }),
                reqQ > 0 && React.createElement('div', { className: 'sw-f-stat' },
                  React.createElement(I, { n: 'shieldCheck', s: 12, c: 'var(--red)' }),
                  React.createElement('strong', null, reqQ),
                  'required'
                ),
                React.createElement('div', { style: { marginLeft: 'auto' } }),
                React.createElement('button', {
                  className: 'sw-f-expand-all',
                  onClick: toggleAllSections
                },
                  React.createElement(I, { n: allCollapsed ? 'chevronDown' : 'chevronRight', s: 10 }),
                  allCollapsed ? 'Expand all' : 'Collapse all'
                )
              );
            })(),

            // Preview overlay
            showPreview && React.createElement('div', { className: 'sw-f-preview-overlay' },
              React.createElement('div', { className: 'sw-f-preview-close' },
                React.createElement(SwBtn, { ghost: true, onClick: () => setShowPreview(false) }, '\u2715 Close preview')
              ),
              React.createElement('div', { style: { maxWidth: 640, margin: '0 auto' } },
                React.createElement('div', {
                  style: { marginBottom: 16, padding: 12, borderRadius: 8, border: '1px solid var(--border-0)', background: 'var(--bg-2)', fontSize: 12, color: 'var(--tx-2)' }
                }, React.createElement('strong', { style: { color: 'var(--tx-0)' } }, 'Preview:'), ' This is how the form appears to a person filling it out.'),
                sections.map(sec => React.createElement('div', { key: sec.id, style: { marginBottom: 20 } },
                  React.createElement('div', { style: { fontSize: 15, fontWeight: 600, color: 'var(--tx-0)', marginBottom: 10, paddingBottom: 8, borderBottom: '1px solid var(--border-0)' } }, sec.title),
                  sec.questions.map(q => React.createElement('div', { key: q.id, className: 'sw-f-preview-q' },
                    React.createElement('div', { className: 'sw-f-preview-prompt' },
                      q.prompt,
                      q.required && React.createElement('span', { style: { color: 'var(--red)', marginLeft: 4, fontSize: 14 } }, '*')
                    ),
                    (q.type === 'single_select' || q.type === 'multi_select') && (q.options || []).map(opt => React.createElement('div', {
                      key: opt.id, className: 'sw-f-preview-opt'
                    },
                      React.createElement('div', { className: q.type === 'single_select' ? 'sw-f-opt-radio' : 'sw-f-opt-check' }),
                      React.createElement('span', { style: { fontSize: 13 } }, opt.label)
                    )),
                    q.type === 'text' && React.createElement('input', {
                      placeholder: 'Type your answer...', readOnly: true,
                      style: { width: '100%', padding: '10px 14px', borderRadius: 6, border: '1px solid var(--border-0)', background: 'var(--bg-2)', color: 'var(--tx-0)', fontSize: 13, fontFamily: 'inherit' }
                    }),
                    (q.type === 'number' || q.type === 'date' || q.type === 'boolean' || q.type === 'duration') && React.createElement('input', {
                      placeholder: q.type === 'number' ? '0' : q.type === 'date' ? 'yyyy-mm-dd' : q.type === 'boolean' ? 'Yes / No' : 'e.g. 3 months',
                      readOnly: true,
                      style: { width: q.type === 'number' ? 120 : 200, padding: '10px 14px', borderRadius: 6, border: '1px solid var(--border-0)', background: 'var(--bg-2)', color: 'var(--tx-0)', fontSize: 13, fontFamily: 'inherit' }
                    })
                  ))
                ))
              )
            ),

            // Sections + Questions (compose view)
            !showPreview && sections.map((sec, secIdx) => {
              const isSecOpen = !expandedSections.has(sec.id); // open by default
              return React.createElement('div', { key: sec.id, className: 'sw-f-section' },
                React.createElement('div', {
                  className: 'sw-f-section-header',
                  onClick: () => toggleSection(sec.id)
                },
                  React.createElement('span', { className: 'sw-f-section-title' },
                    React.createElement(I, { n: isSecOpen ? 'chevronDown' : 'chevronRight', s: 10 }),
                    React.createElement('input', {
                      value: sec.title,
                      onChange: e => { e.stopPropagation(); updateSectionTitle(sec.id, e.target.value); },
                      onClick: e => e.stopPropagation(),
                      style: { background: 'transparent', border: 'none', color: 'var(--tx-2)', fontSize: 11, fontWeight: 600, fontFamily: 'var(--mono)', letterSpacing: '.04em', textTransform: 'uppercase', outline: 'none', width: '100%' }
                    })
                  ),
                  React.createElement('div', { style: { display: 'flex', gap: 4, alignItems: 'center' } },
                    React.createElement('span', { className: 'sw-f-section-count' }, `${sec.questions.length}q`),
                    React.createElement('div', { className: 'sw-f-sec-reorder' },
                      React.createElement('button', {
                        className: 'sw-f-sec-reorder-btn',
                        disabled: secIdx === 0,
                        onClick: e => { e.stopPropagation(); moveSection(sec.id, -1); },
                        title: 'Move section up'
                      }, '\u25B2'),
                      React.createElement('button', {
                        className: 'sw-f-sec-reorder-btn',
                        disabled: secIdx === sections.length - 1,
                        onClick: e => { e.stopPropagation(); moveSection(sec.id, 1); },
                        title: 'Move section down'
                      }, '\u25BC')
                    ),
                    React.createElement('button', {
                      className: 'b-gho b-xs',
                      onClick: e => { e.stopPropagation(); removeSection(sec.id); },
                      style: { fontSize: 11, padding: '1px 6px', color: 'var(--tx-3)' }
                    }, '\u2715')
                  )
                ),
                isSecOpen && React.createElement('div', null,
                  sec.questions.map((q, qi) => React.createElement('div', { key: q.id, className: 'sw-f-q', style: { display: 'flex', gap: 0 } },
                    // Reorder buttons (left gutter)
                    React.createElement('div', { className: 'sw-f-reorder', style: { paddingTop: 14 } },
                      React.createElement('button', {
                        className: 'sw-f-reorder-btn',
                        disabled: qi === 0,
                        onClick: () => moveQuestion(sec.id, q.id, -1),
                        title: 'Move up'
                      }, '\u25B2'),
                      React.createElement('button', {
                        className: 'sw-f-reorder-btn',
                        disabled: qi === sec.questions.length - 1,
                        onClick: () => moveQuestion(sec.id, q.id, 1),
                        title: 'Move down'
                      }, '\u25BC')
                    ),
                    // Question content
                    React.createElement('div', { style: { flex: 1, minWidth: 0 } },
                    // Meta line
                    React.createElement('div', { className: 'sw-f-q-meta' },
                      React.createElement('span', null, `Q${qi + 1}`),
                      React.createElement('span', {
                        style: { padding: '1px 6px', borderRadius: 3, background: 'var(--bg-3)', fontFamily: 'var(--mono)', fontSize: 10 }
                      }, q.type),
                      React.createElement('span', {
                        className: `sw-f-q-required ${q.required ? 'on' : 'off'}`,
                        onClick: () => toggleRequired(sec.id, q.id),
                        title: q.required ? 'Click to make optional' : 'Click to make required'
                      }, q.required ? 'Required' : 'Optional'),
                      q.field_uri && React.createElement('span', {
                        className: 'sw-f-q-field-link',
                        title: q.field_uri
                      }, React.createElement(I, { n: 'link', s: 9 }), q.field_uri.split('/').pop()),
                      q.maturity && React.createElement('span', {
                        className: `tag tag-${matColor(q.maturity)}`,
                        style: { fontSize: 7 }
                      }, q.maturity)
                    ),
                    // Prompt (editable)
                    React.createElement('div', { className: 'sw-f-q-prompt' },
                      editingQuestion === q.id
                        ? React.createElement('input', {
                            value: q.prompt,
                            onChange: e => updateQuestion(sec.id, q.id, { prompt: e.target.value }),
                            onBlur: () => setEditingQuestion(null),
                            onKeyDown: e => e.key === 'Enter' && setEditingQuestion(null),
                            autoFocus: true,
                            style: { flex: 1, fontSize: 14, fontWeight: 500, background: 'transparent', border: 'none', borderBottom: '1px solid var(--teal)', color: 'var(--tx-0)', outline: 'none', fontFamily: 'inherit' }
                          })
                        : React.createElement('span', {
                            onClick: () => setEditingQuestion(q.id),
                            style: { cursor: 'text', flex: 1 }
                          }, q.prompt)
                    ),
                    // Actions (hover)
                    React.createElement('div', { className: 'sw-f-q-actions' },
                      React.createElement('button', {
                        className: 'b-gho b-xs',
                        onClick: () => setEditingQuestion(q.id),
                        style: { fontSize: 10, padding: '2px 6px' },
                        title: 'Edit question'
                      }, React.createElement(I, { n: 'edit', s: 10 })),
                      React.createElement('button', {
                        className: 'b-gho b-xs',
                        onClick: () => duplicateQuestion(sec.id, q.id),
                        style: { fontSize: 10, padding: '2px 6px' },
                        title: 'Duplicate question'
                      }, React.createElement(I, { n: 'copy', s: 10 })),
                      React.createElement('button', {
                        className: 'b-gho b-xs',
                        onClick: () => removeQuestion(sec.id, q.id),
                        style: { fontSize: 10, padding: '2px 6px', color: 'var(--red)' },
                        title: 'Delete question'
                      }, React.createElement(I, { n: 'trash', s: 10 }))
                    ),
                    // Type selector
                    React.createElement('select', {
                      value: q.type,
                      onChange: e => updateQuestion(sec.id, q.id, { type: e.target.value }),
                      style: { fontSize: 10, padding: '3px 8px', borderRadius: 4, border: '1px solid var(--border-0)', background: 'var(--bg-2)', color: 'var(--tx-2)', outline: 'none', marginBottom: 6, fontFamily: 'var(--mono)' }
                    },
                      ['single_select', 'multi_select', 'text', 'number', 'date', 'boolean', 'duration'].map(t =>
                        React.createElement('option', { key: t, value: t }, t)
                      )
                    ),
                    // Answer options (with inline binding dots)
                    (q.type === 'single_select' || q.type === 'multi_select') && React.createElement('div', { style: { marginTop: 4 } },
                      (q.options || []).map(opt => React.createElement('div', { key: opt.id, className: 'sw-f-opt' },
                        React.createElement('div', { className: q.type === 'single_select' ? 'sw-f-opt-radio' : 'sw-f-opt-check' }),
                        React.createElement('input', {
                          className: 'sw-f-opt-label',
                          value: opt.label,
                          onChange: e => updateOption(sec.id, q.id, opt.id, { label: e.target.value }),
                          style: { background: 'transparent', border: 'none', color: 'var(--tx-0)', fontSize: 13, outline: 'none', fontFamily: 'inherit', flex: 1, minWidth: 0 }
                        }),
                        // Inline binding dots (show framework connection status)
                        React.createElement('div', { className: 'sw-f-opt-bindings' },
                          (frameworks || []).map(fw => {
                            const isBound = (bindings || []).some(b => b.optionId === opt.id && b.frameworkId === fw.id);
                            return React.createElement('div', {
                              key: fw.id,
                              className: `sw-f-opt-dot ${isBound ? 'bound' : 'unbound'}`,
                              style: isBound ? { background: fw.color || 'var(--green)' } : {},
                              title: `${fw.name}: ${isBound ? 'Bound' : 'Unbound'}`
                            });
                          })
                        ),
                        React.createElement('button', {
                          className: 'sw-f-opt-rm',
                          onClick: () => removeOption(sec.id, q.id, opt.id)
                        }, '\u2715')
                      )),
                      React.createElement('button', {
                        className: 'sw-f-add',
                        onClick: () => addOption(sec.id, q.id)
                      }, React.createElement(I, { n: 'plus', s: 11 }), 'Add option')
                    ),
                    // Help text
                    q.helpText && React.createElement('div', {
                      style: { fontSize: 11, color: 'var(--tx-3)', marginTop: 4, fontStyle: 'italic' }
                    }, q.helpText)
                  ) /* close question content wrapper div */
                  )),
                  // Add question / insert from dictionary
                  React.createElement('div', { style: { display: 'flex', gap: 4 } },
                    React.createElement('button', {
                      className: 'sw-f-add',
                      onClick: () => addQuestion(sec.id)
                    }, React.createElement(I, { n: 'plus', s: 11 }), 'Add question'),
                    fieldDefs && Object.keys(fieldDefs).length > 0 && React.createElement('button', {
                      className: 'sw-f-add',
                      onClick: () => { setFieldPickerSection(sec.id); setFieldPickerOpen(true); },
                      style: { color: 'var(--teal)' }
                    }, React.createElement(I, { n: 'book', s: 11 }), 'From dictionary')
                  ),
                  fieldPickerOpen && fieldPickerSection === sec.id && React.createElement(FieldPicker, {
                    open: true,
                    onClose: () => { setFieldPickerOpen(false); setFieldPickerSection(null); },
                    onSelect: def => doInsertFromDictionary(def, sec.id),
                    fieldDefs: fieldDefs,
                    catLabels: catLabels,
                    catColors: catColors
                  })
                )
              );
            }),

            // Add section button
            !showPreview && React.createElement('button', {
              className: 'sw-f-add sw-f-add-section',
              onClick: addSection
            }, React.createElement(I, { n: 'plus', s: 13 }), 'Add section'),

            // Framework bar (collapsed by default)
            !showPreview && (frameworks || []).length > 0 && React.createElement('div', { className: 'sw-f-fw-bar' },
              React.createElement('div', {
                className: 'sw-f-fw-bar-header',
                onClick: () => setShowFwBar(!showFwBar)
              },
                React.createElement('span', { className: 'sw-f-fw-bar-label' },
                  React.createElement(I, { n: showFwBar ? 'chevronDown' : 'chevronRight', s: 10 }),
                  `Frameworks (${(frameworks || []).length})`
                )
              ),
              showFwBar && React.createElement('div', { className: 'sw-f-fw-list' },
                (frameworks || []).map(fw => React.createElement('div', { key: fw.id, className: 'sw-f-fw-card' },
                  React.createElement('div', { className: 'sw-f-fw-card-header' },
                    React.createElement('span', { style: { width: 8, height: 8, borderRadius: '50%', background: fw.color || 'var(--teal)', flexShrink: 0 } }),
                    React.createElement('span', { className: 'sw-f-fw-card-name', style: { color: 'var(--tx-0)' } }, fw.name)
                  ),
                  fw.codes && React.createElement('div', { className: 'sw-f-fw-card-codes' },
                    fw.codes.slice(0, 5).map((code, ci) => React.createElement('div', {
                      key: ci, className: 'sw-f-fw-code', style: { color: 'var(--tx-2)' }
                    },
                      React.createElement('span', { style: { fontFamily: 'var(--mono)', fontSize: 10, color: fw.color || 'var(--teal)' } }, code.code || code.id),
                      React.createElement('span', null, code.label || code.name)
                    ))
                  )
                ))
              )
            )
          )
    )
  );
};

/* ── UriLibrariesTab — inline browsable view of all URI libraries ── */
const UriLibrariesTab = ({ onImport, fieldDefs }) => {
  const [search, setSearch] = useState('');
  const [selectedLib, setSelectedLib] = useState('all');
  const [selectedCat, setSelectedCat] = useState('all');
  const [expandedUri, setExpandedUri] = useState(null);

  const results = searchUriLibraries(search, {
    libraryId: selectedLib !== 'all' ? selectedLib : undefined,
    category: selectedCat !== 'all' ? selectedCat : undefined,
    limit: 100
  });

  const pool = selectedLib !== 'all'
    ? URI_LIBRARY_INDEX.filter(e => e.library_id === selectedLib)
    : URI_LIBRARY_INDEX;
  const categories = [...new Set(pool.map(e => e.category).filter(Boolean))].sort();

  const activeLib = selectedLib !== 'all' ? URI_LIBRARIES.find(l => l.id === selectedLib) : null;
  const existingUris = new Set(Object.keys(fieldDefs || {}));

  const typeColor = dt => {
    const m = { text: 'blue', select: 'teal', date: 'gold', number: 'orange', boolean: 'green',
      email: 'blue', phone: 'blue', address: 'gold', text_long: 'purple', document: 'orange',
      single_select: 'teal', multi_select: 'teal', duration: 'gold' };
    return m[dt] || 'blue';
  };

  return React.createElement('div', null,
    // Stats
    React.createElement('div', { className: 'sw-dict-stats' },
      React.createElement('span', { className: 'sw-dict-stat' },
        React.createElement('strong', null, URI_LIBRARIES.length), ' libraries'
      ),
      React.createElement('span', { className: 'sw-dict-stat' },
        React.createElement('strong', null, URI_LIBRARY_INDEX.length), ' total definitions'
      ),
      React.createElement('span', { className: 'sw-dict-stat' },
        React.createElement('strong', null, URI_LIBRARY_INDEX.filter(e => existingUris.has(e.uri)).length), ' already imported'
      )
    ),
    // Library cards row
    React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))', gap: 8, marginBottom: 16 } },
      URI_LIBRARIES.map(lib => React.createElement('div', {
        key: lib.id,
        className: `card-h`,
        style: {
          padding: '12px 16px',
          cursor: 'pointer',
          borderColor: selectedLib === lib.id ? `var(--${lib.color})` : undefined,
          background: selectedLib === lib.id ? `var(--${lib.color}-dim)` : undefined
        },
        onClick: () => { setSelectedLib(selectedLib === lib.id ? 'all' : lib.id); setSelectedCat('all'); }
      },
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 } },
          React.createElement('span', { style: { width: 8, height: 8, borderRadius: '50%', background: `var(--${lib.color})` } }),
          React.createElement('span', { style: { fontSize: 13, fontWeight: 700 } }, lib.name),
          React.createElement('span', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginLeft: 'auto' } }, lib.entries.length)
        ),
        React.createElement('div', { style: { fontSize: 11, color: 'var(--tx-2)', lineHeight: 1.4, display: '-webkit-box', WebkitLineClamp: 2, WebkitBoxOrient: 'vertical', overflow: 'hidden' } },
          lib.description
        )
      ))
    ),
    // Search + filters
    React.createElement('div', { className: 'sw-dict-toolbar' },
      React.createElement('div', { className: 'sw-dict-search' },
        React.createElement('span', { className: 'sw-dict-search-icon' }, React.createElement(I, { n: 'search', s: 13, c: 'var(--tx-3)' })),
        React.createElement('input', {
          value: search,
          onChange: e => setSearch(e.target.value),
          placeholder: 'Search URI definitions by name, keyword, or URI\u2026'
        })
      ),
      categories.length > 1 && React.createElement('div', { className: 'sw-dict-filters' },
        React.createElement('button', { className: `sw-dict-filter${selectedCat === 'all' ? ' active' : ''}`, onClick: () => setSelectedCat('all') }, 'All'),
        categories.map(c => React.createElement('button', {
          key: c,
          className: `sw-dict-filter${selectedCat === c ? ' active' : ''}`,
          onClick: () => setSelectedCat(c)
        }, c))
      )
    ),
    // Active library description
    activeLib && React.createElement('div', { className: 'uri-browser-lib-info', style: { marginBottom: 14 } },
      React.createElement('div', null,
        React.createElement('div', { className: 'uri-browser-lib-info-name' }, activeLib.name),
        React.createElement('div', null, activeLib.description),
        React.createElement('div', { style: { marginTop: 4, fontFamily: 'var(--mono)', fontSize: 10, color: 'var(--teal)' } }, 'Prefix: ', activeLib.prefix)
      )
    ),
    // Results count
    React.createElement('div', { style: { fontSize: 11, color: 'var(--tx-3)', fontFamily: 'var(--mono)', marginBottom: 10 } },
      results.length, ' ', results.length === 1 ? 'definition' : 'definitions',
      search && React.createElement('span', null, ' matching "', search, '"')
    ),
    // Results grid
    results.length === 0
      ? React.createElement('div', { className: 'sw-dict-empty' },
          search ? `No URI definitions matching "${search}"` : 'No definitions in this category.'
        )
      : React.createElement('div', { className: 'sw-dict-grid' },
          results.map(entry => {
            const isExpanded = expandedUri === entry.uri;
            const alreadyImported = existingUris.has(entry.uri);
            return React.createElement('div', {
              key: entry.uri,
              className: `sw-dict-card${isExpanded ? ' expanded' : ''}`,
              onClick: () => setExpandedUri(isExpanded ? null : entry.uri)
            },
              React.createElement('div', { className: 'sw-dict-card-header' },
                React.createElement('div', null,
                  React.createElement('div', { className: 'sw-dict-card-name' }, entry.label),
                  React.createElement('div', { className: 'sw-dict-card-uri' }, entry.uri)
                ),
                React.createElement('div', { className: 'sw-dict-card-badges' },
                  alreadyImported && React.createElement('span', { className: 'tag tag-green', style: { fontSize: 8 } }, 'IMPORTED'),
                  React.createElement('span', {
                    className: `tag tag-${entry.library_color}`,
                    style: { fontSize: 8 }
                  }, entry.library_name),
                  React.createElement('span', {
                    className: `tag tag-${typeColor(entry.data_type)}`,
                    style: { fontSize: 8 }
                  }, (entry.data_type || 'text').toUpperCase())
                )
              ),
              React.createElement('div', { className: 'sw-dict-card-def' }, entry.definition),
              // Tags
              (entry.tags || []).length > 0 && React.createElement('div', { className: 'sw-dict-card-usage', style: { marginTop: 6 } },
                (entry.tags || []).map(t => React.createElement('span', {
                  key: t,
                  className: 'sw-dict-card-form-tag'
                }, t))
              ),
              // Expanded: full details + import button
              isExpanded && React.createElement('div', { style: { marginTop: 10, paddingTop: 10, borderTop: '1px solid var(--border-0)' } },
                React.createElement('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, marginBottom: 10 } },
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: 10, fontWeight: 600, color: 'var(--tx-2)', marginBottom: 2 } }, 'LIBRARY'),
                    React.createElement('div', { style: { fontSize: 12 } }, entry.library_name)
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: 10, fontWeight: 600, color: 'var(--tx-2)', marginBottom: 2 } }, 'CATEGORY'),
                    React.createElement('div', { style: { fontSize: 12 } }, entry.category)
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: 10, fontWeight: 600, color: 'var(--tx-2)', marginBottom: 2 } }, 'DATA TYPE'),
                    React.createElement('div', { style: { fontSize: 12 } }, entry.data_type || 'text')
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: 10, fontWeight: 600, color: 'var(--tx-2)', marginBottom: 2 } }, 'FULL URI'),
                    React.createElement('div', { style: { fontSize: 11, fontFamily: 'var(--mono)', color: 'var(--teal)', wordBreak: 'break-all' } }, entry.uri)
                  )
                ),
                onImport && React.createElement('div', { style: { display: 'flex', gap: 6, justifyContent: 'flex-end' }, onClick: e => e.stopPropagation() },
                  alreadyImported
                    ? React.createElement('span', { style: { fontSize: 11, color: 'var(--green)', display: 'flex', alignItems: 'center', gap: 4 } },
                        React.createElement(I, { n: 'check', s: 12, c: 'var(--green)' }), 'Already in dictionary'
                      )
                    : React.createElement('button', {
                        className: 'b-pri b-sm',
                        onClick: e => {
                          e.stopPropagation();
                          onImport({
                            uri: entry.uri,
                            key: entry.label.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/(^_|_$)/g, ''),
                            label: entry.label,
                            definition: entry.definition,
                            data_type: entry.data_type || 'text',
                            category: entry.category || 'general',
                            tags: entry.tags || [],
                            source_library: entry.library_name,
                            source_library_id: entry.library_id
                          });
                        }
                      }, 'Import to Dictionary')
                )
              )
            );
          })
        )
  );
};

/* ── SchemaWorkbench — top-level tab orchestrator ── */
const SchemaWorkbench = ({
  isOrg,
  orgMeta,
  networkMembers,
  fieldDefs,
  catLabels,
  catColors,
  onSaveFieldDef
}) => {
  const [activeTab, setActiveTab] = useState('forms');
  const [form, setForm] = useState(null);
  const [savedForms, setSavedForms] = useState([]);
  const [frameworks, setFrameworks] = useState([]);
  const [bindings, setBindings] = useState([]);
  const [crosswalks, setCrosswalks] = useState([]);
  const [toastMsg, setToastMsg] = useState(null);

  const showToast = msg => { setToastMsg(msg); setTimeout(() => setToastMsg(null), 3000); };

  // All forms: savedForms + DEFAULT_FORMS (network)
  const allForms = useMemo(() => {
    const savedIds = new Set((savedForms || []).map(f => f.id));
    const networkDefaults = (DEFAULT_FORMS || []).filter(f => !savedIds.has(f.id));
    return [...(savedForms || []).map(sf => sf.form || sf), ...networkDefaults];
  }, [savedForms]);

  const handleNewForm = () => {
    const newForm = {
      name: 'Untitled Form',
      key: 'untitled_form',
      version: 1,
      maturity: 'draft',
      description: '',
      sections: [{
        id: `sec_${Date.now()}`,
        title: 'General',
        questions: []
      }]
    };
    setForm(newForm);
  };

  const handleSave = () => {
    if (!form) return;
    const saveEntry = {
      id: form.id || `form_${Date.now()}`,
      name: form.name,
      version: form.version || 1,
      maturity: form.maturity || 'draft',
      savedAt: Date.now(),
      sourceType: 'local',
      form: form
    };
    setSavedForms(prev => {
      const idx = prev.findIndex(f => f.id === saveEntry.id);
      if (idx >= 0) {
        const next = [...prev];
        next[idx] = saveEntry;
        return next;
      }
      return [...prev, saveEntry];
    });
    if (!form.id) setForm(prev => ({ ...prev, id: saveEntry.id }));
    showToast('Form saved');
  };

  const handleLoad = (formData) => {
    setForm(formData.form || formData);
  };

  const navigateToForm = (formId, fieldKey) => {
    setActiveTab('forms');
    // Find and load the form
    const found = allForms.find(f => f.id === formId);
    if (found) setForm(found);
  };

  const tabs = [
    { id: 'dictionary', label: 'Dictionary', icon: 'book', count: Object.keys(fieldDefs || {}).length + VAULT_FIELDS.length },
    { id: 'uri_libraries', label: 'URI Libraries', icon: 'globe', count: URI_LIBRARIES.length },
    { id: 'forms', label: 'Forms', icon: 'layers', count: allForms.length },
    { id: 'columns', label: 'Columns', icon: 'grid', count: null },
    { id: 'governance', label: 'Governance', icon: 'shieldCheck', count: null }
  ];

  return React.createElement('div', { className: 'sw-wrap' },
    // Header
    React.createElement('div', { className: 'sw-header' },
      React.createElement('div', { className: 'sw-title' },
        React.createElement(I, { n: 'layers', s: 18, c: SWC.given }),
        'Schema Workbench'
      )
    ),
    // Tabs
    React.createElement('div', { className: 'sw-tabs' },
      tabs.map(tab => React.createElement('button', {
        key: tab.id,
        className: `sw-tab${activeTab === tab.id ? ' active' : ''}`,
        onClick: () => setActiveTab(tab.id)
      },
        React.createElement(I, { n: tab.icon, s: 13 }),
        tab.label,
        tab.count != null && React.createElement('span', { className: 'sw-tab-count' }, tab.count)
      ))
    ),
    // Canvas
    React.createElement('div', { className: 'sw-canvas' },
      activeTab === 'dictionary' && React.createElement('div', { className: 'sw-canvas-inner' },
        React.createElement(DictionaryTab, {
          fieldDefs: fieldDefs,
          allForms: allForms,
          catLabels: catLabels || CAT_LABELS,
          catColors: catColors || CAT_COLORS,
          catIcons: CAT_ICONS,
          onSaveFieldDef: onSaveFieldDef
        })
      ),
      activeTab === 'uri_libraries' && React.createElement('div', { className: 'sw-canvas-inner' },
        React.createElement(UriLibrariesTab, {
          onImport: onSaveFieldDef ? entry => {
            onSaveFieldDef({
              uri: entry.uri,
              key: entry.key,
              label: entry.label,
              definition: entry.definition,
              data_type: entry.data_type || 'text',
              category: entry.category || 'general',
              sensitive: false,
              scope: null,
              authority: entry.source_library || null,
              source_library: entry.source_library,
              source_library_id: entry.source_library_id,
              version: 1,
              version_history: [],
              migration_rules: [],
              supersedes: null,
              superseded_by: null,
              created_by: 'uri_library',
              created_at: Date.now()
            });
            showToast('Imported: ' + entry.label);
          } : null,
          fieldDefs: fieldDefs
        })
      ),
      activeTab === 'forms' && React.createElement('div', { className: 'sw-canvas-inner', style: { padding: 0 } },
        React.createElement(FormsTab, {
          allForms: allForms,
          savedForms: savedForms,
          form: form,
          setForm: setForm,
          frameworks: frameworks,
          bindings: bindings,
          crosswalks: crosswalks,
          setFrameworks: setFrameworks,
          setBindings: setBindings,
          setCrosswalks: setCrosswalks,
          fieldDefs: fieldDefs,
          catLabels: catLabels || CAT_LABELS,
          catColors: catColors || CAT_COLORS,
          onSaveFieldDef: onSaveFieldDef,
          onSave: handleSave,
          onLoad: handleLoad,
          onNewForm: handleNewForm,
          showToast: showToast,
          isOrg: isOrg,
          orgMeta: orgMeta,
          networkMembers: networkMembers
        })
      ),
      activeTab === 'columns' && React.createElement('div', { className: 'sw-canvas-inner' },
        React.createElement(ColumnsTab, {
          allForms: allForms,
          fieldDefs: fieldDefs,
          onNavigateToForm: navigateToForm
        })
      ),
      activeTab === 'governance' && React.createElement('div', { className: 'sw-canvas-inner' },
        React.createElement(GovernanceTab, {
          allForms: allForms,
          onNavigateToForm: navigateToForm
        })
      )
    ),
    // Toast
    toastMsg && React.createElement('div', {
      style: {
        position: 'fixed', bottom: 20, right: 20, background: SWC.given, color: SWC.bg,
        padding: '10px 20px', borderRadius: 8, fontSize: 13, fontWeight: 600,
        boxShadow: '0 4px 16px rgba(0,0,0,.3)', zIndex: 100, animation: 'fadeUp .2s ease both'
      }
    }, toastMsg)
  );
};

/* ═══════════════════ ACTION LOG + HELPERS ═══════════════════ */
const ROOM_COLORS = {
  vault: 'teal',
  bridge: 'blue',
  roster: 'gold',
  org: 'blue',
  schema: 'purple',
  metrics: 'orange',
  network: 'green',
  client_record: 'teal',
  team: 'purple',
  unknown: 'orange'
};

// Classify a room from pre-scanned state (no HTTP calls) or fallback to getState
const classifyRoom = async (roomId, scannedState) => {
  const state = scannedState || {};
  const id = state[EVT.IDENTITY] || (await svc.getState(roomId, EVT.IDENTITY));
  if (id) {
    if (id.account_type === 'client') return {
      type: 'vault',
      label: 'Personal Vault',
      color: 'teal'
    };
    if (id.account_type === 'client_record') return {
      type: 'client_record',
      label: 'Personal Record',
      color: 'teal'
    };
    if (id.account_type === 'provider') return {
      type: 'roster',
      label: 'Team Member Roster',
      color: 'gold'
    };
    if (id.account_type === 'organization') return {
      type: 'org',
      label: 'Organization',
      color: 'blue'
    };
    if (id.account_type === 'schema') return {
      type: 'schema',
      label: 'Schema Room',
      color: 'purple'
    };
    if (id.account_type === 'metrics') return {
      type: 'metrics',
      label: 'Metrics Room',
      color: 'orange'
    };
    if (id.account_type === 'network') return {
      type: 'network',
      label: 'Network Room',
      color: 'green'
    };
    if (id.account_type === 'team') return {
      type: 'team',
      label: 'Team Room',
      color: 'purple'
    };
  }
  const meta = state[EVT.BRIDGE_META] || (await svc.getState(roomId, EVT.BRIDGE_META));
  if (meta) return {
    type: 'bridge',
    label: 'Bridge Room',
    color: 'blue'
  };
  return {
    type: 'unknown',
    label: 'Unknown',
    color: 'orange'
  };
};

// Meta-DES: the EO decoder ring — maps every domain event type to its canonical operator.
// This function is the Rosetta Stone between Matrix events and the nine-operator vocabulary.
// Each case below designates which EO operator a given event type represents.
//
// ⚠️ REC mappings: SCHEMA_PROP, SCHEMA_TRANSFORM, GOV_RHYTHM, MATCH_RESOLVE, m.room.encryption
//    — these are frame-changing operations. Presence of REC = elevated review attention.
// SUP mapping: MATCH_HIT — multiple identities may refer to same person (superposition).
const classifyEvent = (ev, roomInfo) => {
  const type = ev.getType();
  const content = ev.getContent();
  // Native EO operations
  if (type === EVT.OP) return {
    op: content.op || 'INS',
    epistemic: content.frame?.epistemic || 'GIVEN',
    label: `${content.op} Operation`,
    desc: content.target || ''
  };
  if (ev.isState && ev.isState()) {
    switch (type) {
      case EVT.IDENTITY:
        return {
          op: 'INS',
          epistemic: 'GIVEN',
          label: 'Identity Declaration',
          desc: `Type: ${content.account_type}`
        };
      case EVT.VAULT_SNAPSHOT:
        return {
          op: 'ALT',
          epistemic: 'GIVEN',
          label: 'Vault Snapshot',
          desc: `${Object.keys(content.fields || {}).length} fields`
        };
      case EVT.VAULT_PROVIDERS:
        return {
          op: 'SEG',
          epistemic: 'GIVEN',
          label: 'Provider Index',
          desc: `${(content.providers || []).length} providers`
        };
      case EVT.BRIDGE_META:
        {
          const rel = RELATIONSHIP_TYPES[content.relationship_type] || RELATIONSHIP_TYPES.client_provider;
          return {
            op: 'CON',
            epistemic: 'MEANT',
            label: 'Bridge Connection',
            desc: `${content.status} — ${rel.label} — ${content.client?.slice(0, 16)} ↔ ${content.provider?.slice(0, 16)}`
          };
        }
      case EVT.BRIDGE_REFS:
        return {
          op: 'SEG',
          epistemic: 'MEANT',
          label: 'Field Refs Update',
          desc: `${Object.keys(content.fields || {}).length} encrypted refs${content.revoked ? ' (REVOKED)' : ''}`
        };
      case EVT.ROSTER_INDEX:
        return {
          op: 'ALT',
          epistemic: 'MEANT',
          label: 'Roster Update',
          desc: `${(content.cases || []).length} cases`
        };
      case EVT.ROSTER_ASSIGN:
        return {
          op: 'SEG',
          epistemic: 'MEANT',
          label: 'Case Assignment',
          desc: `${Object.keys(content.assignments || content).length} case${Object.keys(content.assignments || content).length !== 1 ? 's' : ''} assigned`
        };
      case EVT.ORG_ROSTER:
        return {
          op: 'ALT',
          epistemic: 'MEANT',
          label: 'Org Roster',
          desc: `${(content.staff || []).length} staff`
        };
      case EVT.ORG_METADATA:
        return {
          op: 'DES',
          epistemic: 'MEANT',
          label: 'Org Metadata',
          desc: content.name || 'org'
        };
      case EVT.ORG_INVITE:
        return {
          op: 'CON',
          epistemic: 'MEANT',
          label: 'Org Invite',
          desc: content.userId
        };
      case EVT.SCHEMA_AUTHORITY:
        return {
          op: 'CON',
          epistemic: 'MEANT',
          label: 'Authority Binding',
          desc: content.name?.slice(0, 40)
        };
      case EVT.SCHEMA_PROP:
        return {
          op: 'REC',
          epistemic: 'MEANT',
          label: 'Schema Propagation',
          desc: `${content.level}: ${content.prompt_key}`
        };
      case EVT.SCHEMA_FORM:
        return {
          op: 'DES',
          epistemic: 'GIVEN',
          label: 'Form Definition',
          desc: content.name?.slice(0, 40)
        };
      case EVT.SCHEMA_ASSESSMENT:
        return {
          op: 'DES',
          epistemic: 'MEANT',
          label: 'Assessment Instrument',
          desc: content.question?.slice(0, 40)
        };
      case EVT.OBSERVATION:
        return {
          op: 'INS',
          epistemic: 'MEANT',
          label: 'Provider Observation',
          desc: `${content.prompt_id}: ${content.value}`
        };
      case EVT.INVITE_TOKEN:
        return {
          op: 'CON',
          epistemic: 'MEANT',
          label: 'Invite Token',
          desc: 'QR/link token'
        };
      case EVT.ENCOUNTER_PROV:
        return {
          op: 'INS',
          epistemic: 'MEANT',
          label: 'Provisional Encounter',
          desc: content.description?.slice(0, 40)
        };
      case EVT.MATCH_TOKEN:
        return {
          op: 'CON',
          epistemic: 'MEANT',
          label: 'Match Token',
          desc: 'Blind matching token'
        };
      case EVT.MATCH_HIT:
        return {
          op: 'SUP',
          epistemic: 'MEANT',
          label: 'Match Hit',
          desc: 'Potential duplicate'
        };
      case EVT.MATCH_RESOLVE:
        return {
          op: 'REC',
          epistemic: 'MEANT',
          label: 'Match Resolved',
          desc: content.resolution
        };
      case EVT.SCHEMA_PROMPT:
        return {
          op: 'DES',
          epistemic: 'GIVEN',
          label: 'Form Field',
          desc: content.question?.slice(0, 40)
        };
      case EVT.SCHEMA_DEF:
        return {
          op: 'DES',
          epistemic: 'MEANT',
          label: 'Classification Rule',
          desc: content.name?.slice(0, 40)
        };
      case EVT.SCHEMA_TRANSFORM:
        return {
          op: 'REC',
          epistemic: 'MEANT',
          label: 'Transform Rule',
          desc: `${Object.keys(content.transforms || {}).length} transforms`
        };
      case EVT.TEAM_META:
        return {
          op: 'DES',
          epistemic: 'MEANT',
          label: 'Team Metadata',
          desc: content.name || 'team'
        };
      case EVT.TEAM_MEMBERS:
        return {
          op: 'CON',
          epistemic: 'MEANT',
          label: 'Team Members',
          desc: `${(content.members || []).length} member${(content.members || []).length !== 1 ? 's' : ''}`
        };
      case EVT.TEAM_SCHEMA:
        return {
          op: 'DES',
          epistemic: 'MEANT',
          label: 'Team Schema',
          desc: `v${content.version || 1} — ${(content.fields || []).length} fields`
        };
      case EVT.TEAM_SCHEMA_RULE:
        return {
          op: 'REC',
          epistemic: 'MEANT',
          label: 'Consent Rule',
          desc: TEAM_CONSENT_MODES[content.mode]?.label || content.mode
        };
      case EVT.FIELD_DEF:
        return {
          op: 'DES',
          epistemic: 'MEANT',
          label: 'Field Definitions',
          desc: `${Object.keys(content.definitions || {}).length} definitions`
        };
      case EVT.FIELD_CROSSWALK:
        return {
          op: 'SYN',
          epistemic: 'MEANT',
          label: 'Field Crosswalks',
          desc: `${(content.crosswalks || []).length} crosswalks`
        };
      case EVT.NET_MEMBERS:
        return {
          op: 'CON',
          epistemic: 'MEANT',
          label: 'Network Members',
          desc: `${(content.organizations || []).length} orgs`
        };
      case EVT.GOV_PROPOSAL:
        return {
          op: 'INS',
          epistemic: 'MEANT',
          label: 'Governance Proposal',
          desc: content.summary?.slice(0, 50)
        };
      case EVT.GOV_RHYTHM:
        return {
          op: 'REC',
          epistemic: 'MEANT',
          label: 'Governance Rhythm',
          desc: content.name
        };
      case EVT.SCHEMA_FIELD:
        return {
          op: 'DES',
          epistemic: 'GIVEN',
          label: 'Form Field',
          desc: content.question_text?.slice(0, 40)
        };
      case EVT.SCHEMA_BINDING:
        return {
          op: 'DES',
          epistemic: 'MEANT',
          label: 'Framework Binding',
          desc: `${content.field_id} → ${content.framework?.name?.slice(0, 25)}`
        };
      // Resource tracking events
      case EVT.RESOURCE_TYPE:
        return {
          op: 'DES',
          epistemic: 'GIVEN',
          label: 'Resource Type',
          desc: `${content.name || content.id} (${content.category})`
        };
      case EVT.RESOURCE_RELATION:
        return {
          op: 'CON',
          epistemic: 'GIVEN',
          label: 'Resource Relation',
          desc: `${content.relation_type}: ${content.resource_type_id}`
        };
      case EVT.RESOURCE_INVENTORY:
        return {
          op: 'ALT',
          epistemic: 'GIVEN',
          label: 'Resource Inventory',
          desc: `${content.available}/${content.total_capacity} available`
        };
      case EVT.RESOURCE_ALLOC:
        return {
          op: 'INS',
          epistemic: 'GIVEN',
          label: 'Resource Allocation',
          desc: `${content.quantity} ${content.unit} → ${content.allocated_to?.slice(0, 16)}`
        };
      case EVT.RESOURCE_POLICY:
        return {
          op: 'SEG',
          epistemic: 'MEANT',
          label: 'Resource Policy',
          desc: ev.getStateKey()
        };
      case EVT.RESOURCE_OPACITY:
        return {
          op: 'SEG',
          epistemic: 'MEANT',
          label: 'Resource Opacity',
          desc: `${RESOURCE_OPACITY_LABELS[content.opacity] || content.opacity}`
        };
      case EVT.RESOURCE_VAULT:
        return {
          op: 'INS',
          epistemic: 'GIVEN',
          label: 'Vault Resource Record',
          desc: `${content.resource_name}: ${content.quantity} ${content.unit}`
        };
      case EVT.RESOURCE_PERM:
        return {
          op: 'ALT',
          epistemic: 'MEANT',
          label: 'Resource Permission',
          desc: `${content.resource_type_id}: updated by ${content.updated_by?.slice(0, 16)}`
        };
      case 'm.room.encryption':
        return {
          op: 'REC',
          epistemic: 'GIVEN',
          label: 'Encryption Policy',
          desc: content.algorithm
        };
      case 'm.room.tombstone':
        return {
          op: 'NUL',
          epistemic: 'MEANT',
          label: 'Room Tombstoned',
          desc: `→ ${content.replacement_room?.slice(0, 24)}…`
        };
      case 'm.room.create':
        return {
          op: 'INS',
          epistemic: 'GIVEN',
          label: 'Room Created',
          desc: 'New room initialized'
        };
      case 'm.room.member':
        {
          const ms = content.membership;
          if (ms === 'join') return {
            op: 'CON',
            epistemic: 'MEANT',
            label: 'Member Joined',
            desc: ev.getStateKey()
          };
          if (ms === 'invite') return {
            op: 'CON',
            epistemic: 'MEANT',
            label: 'Member Invited',
            desc: ev.getStateKey()
          };
          if (ms === 'leave') return {
            op: 'NUL',
            epistemic: 'MEANT',
            label: 'Member Left/Kicked',
            desc: ev.getStateKey()
          };
          return {
            op: 'ALT',
            epistemic: 'MEANT',
            label: `Membership: ${ms}`,
            desc: ev.getStateKey()
          };
        }
      default:
        return {
          op: 'INS',
          epistemic: 'GIVEN',
          label: type,
          desc: 'State event'
        };
    }
  }
  if (type === EVT.RESOURCE_EVENT) return {
    op: content.event === 'revoked' ? 'NUL' : 'ALT',
    epistemic: 'GIVEN',
    label: 'Resource Lifecycle',
    desc: `${content.event}: ${content.quantity} (${content.allocation_id?.slice(0, 12)})`
  };
  if (type === EVT.METRIC) return {
    op: 'INS',
    epistemic: 'MEANT',
    label: 'Metric Event',
    desc: `${content.observation?.category}: ${content.observation?.value}`
  };
  if (type === EVT.NOTE) return {
    op: 'INS',
    epistemic: 'MEANT',
    label: 'Note Created',
    desc: content.title?.slice(0, 50) || 'Untitled'
  };
  if (type === EVT.NOTE_EDIT) return {
    op: 'ALT',
    epistemic: 'MEANT',
    label: 'Note Edited',
    desc: (content.title?.slice(0, 50) || 'Untitled') + ' (edited by ' + ((content.edited_by || '').split(':')[0]?.replace('@', '') || 'unknown') + ')'
  };
  if (type === EVT.NOTE_REF) return {
    op: 'SEG',
    epistemic: 'MEANT',
    label: 'Note Reference',
    desc: content.title?.slice(0, 50) || content.note_id
  };
  if (type === 'm.room.message') {
    const cvType = content[`${NS}.type`];
    if (cvType === 'request') return {
      op: 'DES',
      epistemic: 'MEANT',
      label: 'Info Request',
      desc: content.body?.slice(0, 60)
    };
    if (cvType === 'note') return {
      op: 'INS',
      epistemic: roomInfo.type === 'vault' ? 'GIVEN' : 'MEANT',
      label: 'Bridge Note',
      desc: content.body?.slice(0, 60)
    };
    return {
      op: 'INS',
      epistemic: 'GIVEN',
      label: 'Message',
      desc: content.body?.slice(0, 60)
    };
  }
  // Encrypted events that haven't been decrypted yet — show as pending
  if (type === 'm.room.encrypted') return {
    op: 'INS',
    epistemic: 'GIVEN',
    label: 'Encrypted Event',
    desc: 'Awaiting decryption...'
  };
  return {
    op: 'INS',
    epistemic: 'GIVEN',
    label: type,
    desc: 'Timeline event'
  };
};

/* ─── EO constants (used by RecordProvenance and ActionLog) ─── */

const OPERATOR_TRIADS = {
  identity: {
    label: 'Identity',
    desc: 'What exists?',
    ops: ['NUL', 'DES', 'INS'],
    color: 'teal'
  },
  structure: {
    label: 'Structure',
    desc: 'How do things relate?',
    ops: ['SEG', 'CON', 'SYN'],
    color: 'blue'
  },
  time: {
    label: 'Time',
    desc: 'How do things change?',
    ops: ['ALT', 'SUP', 'REC'],
    color: 'purple'
  }
};
const OP_DESCRIPTIONS = {
  NUL: {
    verb: 'Destroy',
    desc: 'Destruction / Absence'
  },
  DES: {
    verb: 'Designate',
    desc: 'Designation / Naming'
  },
  INS: {
    verb: 'Instantiate',
    desc: 'Instantiation / First observation'
  },
  SEG: {
    verb: 'Segment',
    desc: 'Segmentation / Boundary'
  },
  CON: {
    verb: 'Connect',
    desc: 'Connection / Joining'
  },
  SYN: {
    verb: 'Synthesize',
    desc: 'Synthesis / Merging'
  },
  ALT: {
    verb: 'Alternate',
    desc: 'Alternation / Transition'
  },
  SUP: {
    verb: 'Superpose',
    desc: 'Superposition / Layering'
  },
  REC: {
    verb: 'Reconfigure',
    desc: 'Reconfiguration / Recursion'
  }
};

/* ═══════════════════ RECORD PROVENANCE PANEL ═══════════════════
 * Inline expandable panel showing provenance for any record/entity:
 * - Origin server (extracted from Matrix IDs)
 * - Who created / last modified the record
 * - When created
 * - Full EO operation history filtered to that specific entity
 * ═══════════════════════════════════════════════════════════════ */

const PROV_OP_COLORS = {
  NUL: 'red',
  DES: 'teal',
  INS: 'green',
  SEG: 'orange',
  CON: 'blue',
  SYN: 'purple',
  ALT: 'gold',
  SUP: 'pink',
  REC: 'teal'
};
const RecordProvenance = ({
  roomId,
  entityKey,
  label,
  session,
  onRestore
}) => {
  const [ops, setOps] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const loadProvenance = useCallback(async () => {
    if (ops !== null) return; // already loaded
    setLoading(true);
    setError(null);
    try {
      const allOps = [];
      if (svc.client) {
        const room = svc.client.getRoom(roomId);
        if (room) {
          // Paginate backwards to capture historical EO operations
          try {
            for (let i = 0; i < 5; i++) {
              const canPaginate = room.getLiveTimeline().getPaginationToken('b');
              if (!canPaginate) break;
              await svc.client.scrollback(room, 100);
            }
          } catch (e) {/* pagination may fail — continue with available events */}
          // Collect from all timelines (not just live)
          const seenIds = new Set();
          const timelineSets = room.getTimelineSets ? room.getTimelineSets() : [];
          const collectFromEvent = ev => {
            if (seenIds.has(ev.getId()) || ev.getType() !== EVT.OP) return;
            seenIds.add(ev.getId());
            const c = ev.getContent();
            if (c.target === entityKey || typeof c.target === 'string' && c.target.includes(entityKey)) {
              allOps.push({
                ...c,
                _sender: ev.getSender(),
                _eventTs: ev.getTs()
              });
            }
          };
          if (timelineSets.length > 0) {
            for (const ts of timelineSets) {
              for (const tl of ts.getTimelines()) {
                for (const ev of tl.getEvents()) collectFromEvent(ev);
              }
            }
          } else {
            for (const ev of room.getLiveTimeline().getEvents()) collectFromEvent(ev);
          }
          // Also collect from state events
          for (const ev of room.currentState.getStateEvents()) {
            if (ev.getType() === EVT.OP) {
              const c = ev.getContent();
              if (c.target === entityKey || typeof c.target === 'string' && c.target.includes(entityKey)) {
                if (!allOps.find(o => o.id === c.id)) {
                  allOps.push({
                    ...c,
                    _sender: ev.getSender(),
                    _eventTs: ev.getTs()
                  });
                }
              }
            }
          }
        }
      }
      allOps.sort((a, b) => (a.ts || a._eventTs || 0) - (b.ts || b._eventTs || 0));
      setOps(allOps);
    } catch (e) {
      setError(e.message);
    }
    setLoading(false);
  }, [roomId, entityKey, ops]);
  useEffect(() => {
    loadProvenance();
  }, [loadProvenance]);

  // React to new EO events that affect this entity
  useEffect(() => {
    const handleEo = e => {
      const d = e.detail;
      if (d && d.roomId === roomId) {
        const t = d.event?.target;
        if (t && (t === entityKey || typeof t === 'string' && t.includes(entityKey))) {
          setOps(null); // force reload
        }
      }
    };
    window.addEventListener('khora:eo', handleEo);
    return () => window.removeEventListener('khora:eo', handleEo);
  }, [roomId, entityKey]);
  if (loading) return /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      marginTop: 4
    }
  }, /*#__PURE__*/React.createElement(Spin, {
    s: 14
  }), " ", /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginLeft: 6
    }
  }, "Loading provenance..."));
  if (error) return /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      marginTop: 4,
      fontSize: 11,
      color: 'var(--red)'
    }
  }, "Error loading provenance: ", error);
  if (!ops || ops.length === 0) return /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 16px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      marginTop: 4
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "git-commit",
    s: 12,
    c: "var(--tx-2)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontWeight: 600,
      color: 'var(--tx-1)'
    }
  }, "Provenance: ", label || entityKey)), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-3)'
    }
  }, "No EO operations recorded for this entity yet."));
  const firstOp = ops[0];
  const lastOp = ops[ops.length - 1];
  const creator = firstOp.created_by || firstOp._sender || 'Unknown';
  const creatorServer = firstOp.origin_server || extractHomeserver(creator);
  const createdAt = firstOp.ts || firstOp._eventTs;
  const roomServer = extractHomeserver(roomId);
  const modifierCount = new Set(ops.map(o => o.created_by || o._sender).filter(Boolean)).size;
  const fmtDate = ts => {
    if (!ts) return '—';
    const d = new Date(ts);
    return d.toLocaleDateString(undefined, {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    }) + ' ' + d.toLocaleTimeString(undefined, {
      hour: '2-digit',
      minute: '2-digit'
    });
  };
  const fmtUserId = uid => {
    if (!uid) return 'Unknown';
    return uid.startsWith('@') ? uid.split(':')[0].slice(1) : uid;
  };
  const getTriad = opName => {
    for (const [k, v] of Object.entries(OPERATOR_TRIADS)) {
      if (v.ops.includes(opName)) return v;
    }
    return {
      color: 'blue'
    };
  };
  return /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '14px 16px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      marginTop: 4,
      border: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "git-commit",
    s: 13,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 700,
      color: 'var(--tx-0)'
    }
  }, "Provenance"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-2)',
      fontFamily: 'var(--mono)'
    }
  }, label || entityKey), /*#__PURE__*/React.createElement("span", {
    style: {
      marginLeft: 'auto',
      fontSize: 9.5,
      color: 'var(--tx-3)'
    }
  }, ops.length, " operation", ops.length !== 1 ? 's' : '')), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 8,
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 10px',
      background: 'var(--bg-2)',
      borderRadius: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 9,
      textTransform: 'uppercase',
      color: 'var(--tx-3)',
      letterSpacing: '.04em',
      marginBottom: 2
    }
  }, "Server"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11.5,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-1)',
      wordBreak: 'break-all'
    }
  }, roomServer)), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 10px',
      background: 'var(--bg-2)',
      borderRadius: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 9,
      textTransform: 'uppercase',
      color: 'var(--tx-3)',
      letterSpacing: '.04em',
      marginBottom: 2
    }
  }, "Created by"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)'
    },
    title: creator
  }, fmtUserId(creator)), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 9.5,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)'
    }
  }, creatorServer)), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 10px',
      background: 'var(--bg-2)',
      borderRadius: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 9,
      textTransform: 'uppercase',
      color: 'var(--tx-3)',
      letterSpacing: '.04em',
      marginBottom: 2
    }
  }, "Created"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)'
    }
  }, fmtDate(createdAt))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 10px',
      background: 'var(--bg-2)',
      borderRadius: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 9,
      textTransform: 'uppercase',
      color: 'var(--tx-3)',
      letterSpacing: '.04em',
      marginBottom: 2
    }
  }, "Last modified"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)'
    }
  }, fmtDate(lastOp.ts || lastOp._eventTs)), modifierCount > 1 && /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 9.5,
      color: 'var(--tx-3)'
    }
  }, modifierCount, " contributors"))), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 9.5,
      textTransform: 'uppercase',
      color: 'var(--tx-3)',
      letterSpacing: '.04em',
      marginBottom: 6,
      fontWeight: 600
    }
  }, "EO Log History"), /*#__PURE__*/React.createElement("div", {
    style: {
      maxHeight: 200,
      overflowY: 'auto',
      display: 'flex',
      flexDirection: 'column',
      gap: 3
    }
  }, ops.map((o, i) => {
    const triad = getTriad(o.op);
    const opDesc = OP_DESCRIPTIONS[o.op] || {
      verb: o.op,
      desc: ''
    };
    const opColor = PROV_OP_COLORS[o.op] || 'blue';
    const sender = o.created_by || o._sender;
    return /*#__PURE__*/React.createElement("div", {
      key: o.id || i,
      style: {
        display: 'flex',
        alignItems: 'flex-start',
        gap: 8,
        padding: '6px 8px',
        background: 'var(--bg-2)',
        borderRadius: 5,
        fontSize: 11
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        minWidth: 16,
        paddingTop: 2
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        width: 8,
        height: 8,
        borderRadius: '50%',
        background: `var(--${opColor})`,
        flexShrink: 0
      }
    }), i < ops.length - 1 && /*#__PURE__*/React.createElement("div", {
      style: {
        width: 1,
        height: 16,
        background: 'var(--border-0)',
        marginTop: 2
      }
    })), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        minWidth: 0
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 5,
        flexWrap: 'wrap'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${opColor}`,
      style: {
        fontSize: 8.5,
        fontFamily: 'var(--mono)',
        fontWeight: 700
      }
    }, o.op), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        fontWeight: 600,
        color: 'var(--tx-1)'
      }
    }, opDesc.verb), o.frame?.epistemic && /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${o.frame.epistemic === 'GIVEN' ? 'teal' : 'gold'}`,
      style: {
        fontSize: 7.5
      }
    }, o.frame.epistemic)), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8,
        marginTop: 2,
        fontSize: 10,
        color: 'var(--tx-3)'
      }
    }, /*#__PURE__*/React.createElement("span", null, fmtDate(o.ts || o._eventTs)), sender && /*#__PURE__*/React.createElement("span", {
      title: sender,
      style: {
        fontFamily: 'var(--mono)'
      }
    }, fmtUserId(sender)), o.origin_server && /*#__PURE__*/React.createElement("span", {
      style: {
        fontFamily: 'var(--mono)',
        color: 'var(--tx-3)'
      }
    }, o.origin_server)), o.operand && /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 4,
        fontSize: 10.5,
        color: 'var(--tx-1)',
        display: 'flex',
        flexDirection: 'column',
        gap: 2
      }
    }, o.op === 'INS' && o.operand.value != null && /*#__PURE__*/React.createElement("div", {
      style: { display: 'flex', alignItems: 'center', gap: 4, flexWrap: 'wrap' }
    }, /*#__PURE__*/React.createElement("span", {
      style: { color: 'var(--green)', fontSize: 9, fontWeight: 600 }
    }, "SET"), /*#__PURE__*/React.createElement("span", {
      style: { fontFamily: 'var(--mono)', fontSize: 10, background: 'var(--green-dim)', padding: '1px 6px', borderRadius: 3 }
    }, String(o.operand.value).slice(0, 60)),
    onRestore && /*#__PURE__*/React.createElement("button", {
      className: 'b-gho',
      style: { fontSize: 9.5, padding: '1px 6px', display: 'flex', alignItems: 'center', gap: 3, whiteSpace: 'nowrap' },
      title: 'Restore to: ' + String(o.operand.value).slice(0, 50),
      onClick: () => onRestore(o.operand.value)
    }, /*#__PURE__*/React.createElement(I, { n: 'check', s: 9 }), 'Restore')),
    o.op === 'ALT' && o.operand.from != null && o.operand.to != null && /*#__PURE__*/React.createElement("div", {
      style: { display: 'flex', alignItems: 'center', gap: 4, flexWrap: 'wrap' }
    }, /*#__PURE__*/React.createElement("span", {
      style: { fontFamily: 'var(--mono)', fontSize: 10, background: 'var(--red-dim)', padding: '1px 6px', borderRadius: 3, textDecoration: 'line-through', color: 'var(--tx-2)' }
    }, String(o.operand.from).slice(0, 40)), /*#__PURE__*/React.createElement("span", {
      style: { color: 'var(--tx-3)', fontSize: 10 }
    }, "\u2192"), /*#__PURE__*/React.createElement("span", {
      style: { fontFamily: 'var(--mono)', fontSize: 10, background: 'var(--green-dim)', padding: '1px 6px', borderRadius: 3 }
    }, String(o.operand.to).slice(0, 40)),
    onRestore && /*#__PURE__*/React.createElement("button", {
      className: 'b-gho',
      style: { fontSize: 9.5, padding: '1px 6px', display: 'flex', alignItems: 'center', gap: 3, whiteSpace: 'nowrap' },
      title: 'Restore to: ' + String(o.operand.to).slice(0, 50),
      onClick: () => onRestore(o.operand.to)
    }, /*#__PURE__*/React.createElement(I, { n: 'check', s: 9 }), 'Restore')),
    o.op === 'NUL' && /*#__PURE__*/React.createElement("div", {
      style: { display: 'flex', alignItems: 'center', gap: 4 }
    }, /*#__PURE__*/React.createElement("span", {
      style: { color: 'var(--red)', fontSize: 9, fontWeight: 600 }
    }, "CLEARED"), o.operand.reason && /*#__PURE__*/React.createElement("span", {
      style: { fontSize: 9.5, color: 'var(--tx-3)', fontStyle: 'italic' }
    }, o.operand.reason), o.operand.previous_value && /*#__PURE__*/React.createElement("span", {
      style: { fontFamily: 'var(--mono)', fontSize: 10, background: 'var(--red-dim)', padding: '1px 6px', borderRadius: 3, textDecoration: 'line-through', color: 'var(--tx-3)' }
    }, String(o.operand.previous_value).slice(0, 40))),
    o.op !== 'INS' && o.op !== 'ALT' && o.op !== 'NUL' && o.operand.value != null && /*#__PURE__*/React.createElement("span", {
      style: { fontFamily: 'var(--mono)', fontSize: 10, color: 'var(--tx-2)' }
    }, String(o.operand.value).slice(0, 60)),
    o.operand.source && /*#__PURE__*/React.createElement("span", {
      style: { fontSize: 9, fontStyle: 'italic', color: 'var(--tx-3)' }
    }, "via ", o.operand.source)), o.provenance && o.provenance.length > 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 2,
        fontSize: 9,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, "chain: ", o.provenance.map(p => p.slice(0, 12)).join(' → '))));
  })));
};

/* ═══════════════════ ACTION LOG ═══════════════════════════
 * Records state changes to any given room, or across all rooms.
 * Uses classifyEvent() for human-readable labels.
 * Accepts optional roomId prop for per-room scoping.
 * ═══════════════════════════════════════════════════════════════ */
const _isActionLogRelevant = (ev) => {
  const type = ev.getType();
  if (type.startsWith('io.khora.')) return true;
  if (type === 'm.room.create' || type === 'm.room.member' ||
      type === 'm.room.encryption' || type === 'm.room.tombstone') return true;
  return false;
};
const _collectRoomEvents = (room, roomInfo) => {
  const seenIds = new Set();
  const events = [];
  const timelineSets = room.getTimelineSets ? room.getTimelineSets() : [];
  const allTlEvents = [];
  if (timelineSets.length > 0) {
    for (const ts of timelineSets) {
      for (const tl of ts.getTimelines()) {
        for (const ev of tl.getEvents()) {
          if (!seenIds.has(ev.getId())) { seenIds.add(ev.getId()); allTlEvents.push(ev); }
        }
      }
    }
  } else {
    for (const ev of room.getLiveTimeline().getEvents()) {
      if (!seenIds.has(ev.getId())) { seenIds.add(ev.getId()); allTlEvents.push(ev); }
    }
  }
  for (const ev of allTlEvents) {
    if (!_isActionLogRelevant(ev)) continue;
    const cls = classifyEvent(ev, roomInfo);
    events.push({
      id: ev.getId(), roomId: room.roomId, roomInfo, sender: ev.getSender(),
      ts: ev.getTs(), type: ev.getType(), content: ev.getContent(),
      ...cls
    });
  }
  for (const ev of room.currentState.getStateEvents()) {
    if (seenIds.has(ev.getId())) continue;
    seenIds.add(ev.getId());
    if (!_isActionLogRelevant(ev)) continue;
    const cls = classifyEvent(ev, roomInfo);
    events.push({
      id: ev.getId(), roomId: room.roomId, roomInfo, sender: ev.getSender(),
      ts: ev.getTs(), type: ev.getType(), content: ev.getContent(),
      ...cls
    });
  }
  return events;
};
const ActionLog = ({
  session,
  roomId
}) => {
  const [events, setEvents] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [filter, setFilter] = useState('all');
  const [targetFilter, setTargetFilter] = useState('all');
  const loadEvents = useCallback(async () => {
    setLoading(true);
    setError(null);
    const allEvents = [];
    try {
      if (roomId) {
        // ── Per-room mode: load events from a single room directly ──
        const roomInfo = await classifyRoom(roomId);
        if (svc.client) {
          const room = svc.client.getRoom(roomId);
          if (room) {
            try {
              const canPag = room.getLiveTimeline().getPaginationToken('b');
              if (canPag) await svc.client.scrollback(room, 50);
            } catch (e) {/* pagination may fail */}
            allEvents.push(..._collectRoomEvents(room, roomInfo));
          }
        } else {
          // HTTP-only fallback for single room
          try {
            const stateEvts = await svc._api('GET', `/rooms/${encodeURIComponent(roomId)}/state`);
            if (Array.isArray(stateEvts)) {
              for (const raw of stateEvts) {
                const type = raw.type || '';
                if (!type.startsWith('io.khora.') && type !== 'm.room.create' && type !== 'm.room.member' && type !== 'm.room.encryption' && type !== 'm.room.tombstone') continue;
                const fakeEv = {
                  getType: () => type, getContent: () => raw.content || {},
                  getId: () => raw.event_id || `state_${roomId}_${type}_${raw.state_key || ''}`,
                  getSender: () => raw.sender || '', getTs: () => raw.origin_server_ts || 0, isState: () => true
                };
                const cls = classifyEvent(fakeEv, roomInfo);
                allEvents.push({ id: fakeEv.getId(), roomId, roomInfo, sender: fakeEv.getSender(),
                  ts: fakeEv.getTs(), type, content: fakeEv.getContent(), ...cls });
              }
            }
          } catch (apiErr) {
            console.warn('ActionLog: HTTP state fetch failed for room', roomId, apiErr.message);
          }
        }
      } else {
        // ── Global mode: scan all rooms ──
        const scanned = await svc.scanRooms();
        const roomIds = Object.keys(scanned);
        for (const rid of roomIds) {
          try {
            const roomInfo = await classifyRoom(rid, scanned[rid]);
            if (svc.client) {
              const room = svc.client.getRoom(rid);
              if (!room) continue;
              try {
                const canPag = room.getLiveTimeline().getPaginationToken('b');
                if (canPag) await svc.client.scrollback(room, 50);
              } catch (e) {/* pagination may fail */}
              allEvents.push(..._collectRoomEvents(room, roomInfo));
            } else {
              // HTTP-only fallback: fetch state events via REST API
              try {
                const stateEvts = await svc._api('GET', `/rooms/${encodeURIComponent(rid)}/state`);
                if (Array.isArray(stateEvts)) {
                  for (const raw of stateEvts) {
                    const type = raw.type || '';
                    if (!type.startsWith('io.khora.') && type !== 'm.room.create' && type !== 'm.room.member' && type !== 'm.room.encryption' && type !== 'm.room.tombstone') continue;
                    const fakeEv = {
                      getType: () => type, getContent: () => raw.content || {},
                      getId: () => raw.event_id || `state_${rid}_${type}_${raw.state_key || ''}`,
                      getSender: () => raw.sender || '', getTs: () => raw.origin_server_ts || 0, isState: () => true
                    };
                    const cls = classifyEvent(fakeEv, roomInfo);
                    allEvents.push({ id: fakeEv.getId(), roomId: rid, roomInfo, sender: fakeEv.getSender(),
                      ts: fakeEv.getTs(), type, content: fakeEv.getContent(), ...cls });
                  }
                }
              } catch (apiErr) {
                console.warn('ActionLog: HTTP state fetch failed for room', rid, apiErr.message);
              }
            }
          } catch (roomErr) {
            console.warn('ActionLog: skipping room', rid, roomErr.message);
          }
        }
      }
      allEvents.sort((a, b) => b.ts - a.ts);
      setEvents(allEvents);
    } catch (e) {
      console.error('ActionLog error:', e);
      setError(e.message || 'Failed to load events');
      setEvents(allEvents);
    }
    setLoading(false);
  }, [roomId]);
  useEffect(() => { loadEvents(); }, [loadEvents]);
  useEffect(() => {
    let debounce = null;
    const debouncedLoad = (e) => {
      if (roomId && e?.detail?.roomId && e.detail.roomId !== roomId) return;
      if (debounce) clearTimeout(debounce);
      debounce = setTimeout(() => { loadEvents(); }, 400);
    };
    window.addEventListener('khora:eo', debouncedLoad);
    window.addEventListener('khora:timeline', debouncedLoad);
    window.addEventListener('khora:state', debouncedLoad);
    return () => {
      window.removeEventListener('khora:eo', debouncedLoad);
      window.removeEventListener('khora:timeline', debouncedLoad);
      window.removeEventListener('khora:state', debouncedLoad);
      if (debounce) clearTimeout(debounce);
    };
  }, [loadEvents, roomId]);
  const roomTypes = [...new Set(events.map(ev => ev.roomInfo.type))].sort();
  const targetEntries = [...new Set(
    events
      .filter(ev => ev.type === EVT.OP && ev.content?.target)
      .map(ev => {
        const parts = (ev.content.target || '').split('.');
        return parts.length >= 2 ? `${parts[0]}.${parts[1]}` : parts[0];
      })
      .filter(Boolean)
  )].sort();
  let filtered = events;
  if (filter !== 'all') filtered = filtered.filter(ev => ev.roomInfo.type === filter);
  if (targetFilter !== 'all') filtered = filtered.filter(ev => {
    const parts = (ev.content?.target || '').split('.');
    const key = parts.length >= 2 ? `${parts[0]}.${parts[1]}` : parts[0];
    return key === targetFilter;
  });
  if (loading && events.length === 0) return /*#__PURE__*/React.createElement("div", {
    style: { height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }
  }, /*#__PURE__*/React.createElement(Spin, { s: 28 }));
  return /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: { maxWidth: 900, margin: '0 auto' }
  }, /*#__PURE__*/React.createElement("div", {
    style: { marginBottom: 20 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 10, marginBottom: 6 }
  }, /*#__PURE__*/React.createElement(I, { n: "list", s: 20, c: "var(--purple)" }),
  /*#__PURE__*/React.createElement("h2", {
    style: { fontFamily: 'var(--serif)', fontSize: 24, fontWeight: 700, letterSpacing: '-0.02em' }
  }, roomId ? "Room Log" : "Action Log"),
  /*#__PURE__*/React.createElement("span", {
    style: { fontSize: 11, color: 'var(--tx-3)', fontFamily: 'var(--mono)', marginLeft: 'auto' }
  }, filtered.length, " action", filtered.length !== 1 ? 's' : '')),
  /*#__PURE__*/React.createElement("p", {
    style: { color: 'var(--tx-1)', fontSize: 13, lineHeight: 1.6 }
  }, roomId ? "State changes for this room." : "Chronological log of state changes across your rooms.")),
  error && /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: { marginBottom: 14, padding: '10px 14px', border: '1px solid var(--red)', background: 'var(--bg-2)' }
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 8 }
  }, /*#__PURE__*/React.createElement(I, { n: "alert-triangle", s: 14, c: "var(--red)" }),
  /*#__PURE__*/React.createElement("span", { style: { fontSize: 12, color: 'var(--red)' } }, error),
  /*#__PURE__*/React.createElement("button", {
    onClick: loadEvents, className: "b-gho b-xs", style: { marginLeft: 'auto' }
  }, "Retry"))),
  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 8, marginBottom: 14, alignItems: 'center', flexWrap: 'wrap' }
  }, !roomId && /*#__PURE__*/React.createElement("select", {
    value: filter,
    onChange: e => setFilter(e.target.value),
    style: { width: 'auto', padding: '5px 8px', fontSize: 11 }
  }, /*#__PURE__*/React.createElement("option", { value: "all" }, "All Types"),
  roomTypes.map(t => /*#__PURE__*/React.createElement("option", { key: t, value: t }, t))),
  !roomId && targetEntries.length > 0 && /*#__PURE__*/React.createElement("select", {
    value: targetFilter,
    onChange: e => setTargetFilter(e.target.value),
    style: { width: 'auto', padding: '5px 8px', fontSize: 11 }
  }, /*#__PURE__*/React.createElement("option", { value: "all" }, "All Targets"),
  targetEntries.map(t => /*#__PURE__*/React.createElement("option", { key: t, value: t }, t))),
  /*#__PURE__*/React.createElement("button", {
    onClick: loadEvents, className: "b-gho b-xs",
    style: { display: 'flex', alignItems: 'center', gap: 4 }
  }, /*#__PURE__*/React.createElement(I, { n: "refresh-cw", s: 10 }), "Refresh")),
  filtered.length === 0 && !error ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: { textAlign: 'center', padding: '40px 20px', borderStyle: 'dashed' }
  }, /*#__PURE__*/React.createElement(I, { n: "list", s: 24, c: "var(--tx-3)" }),
  /*#__PURE__*/React.createElement("p", {
    style: { color: 'var(--tx-3)', marginTop: 8, fontSize: 12 }
  }, "No state changes recorded yet.")) :
  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', flexDirection: 'column', gap: 2 }
  }, filtered.slice(0, 500).map((ev, idx) => {
    const opC = OP_COLORS[ev.op] || 'blue';
    const rmC = ROOM_COLORS[ev.roomInfo.type] || 'orange';
    const username = (ev.sender || '').split(':')[0]?.replace('@', '') || '';
    return /*#__PURE__*/React.createElement("div", {
      key: ev.id || idx,
      style: {
        display: 'flex', alignItems: 'center', gap: 8, padding: '7px 10px',
        background: 'var(--bg-2)', border: '1px solid var(--border-0)',
        borderRadius: 'var(--r)', fontSize: 12
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: { fontSize: 10, color: 'var(--tx-3)', fontFamily: 'var(--mono)', minWidth: 62, flexShrink: 0 }
    }, ev.ts ? new Date(ev.ts).toLocaleTimeString() : ''),
    !roomId && /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${rmC}`, style: { fontSize: 8.5, flexShrink: 0 }
    }, ev.roomInfo.type),
    /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${opC}`, title: OP_DESCRIPTIONS[ev.op] ? `${OP_DESCRIPTIONS[ev.op].verb}: ${OP_DESCRIPTIONS[ev.op].desc}` : ev.op, style: { fontSize: 9, fontFamily: 'var(--mono)', minWidth: 28, textAlign: 'center', flexShrink: 0, cursor: 'help' }
    }, ev.op),
    ev.label && /*#__PURE__*/React.createElement("span", {
      style: { color: 'var(--tx-1)' }
    }, "\u2014 ", ev.label),
    ev.desc && /*#__PURE__*/React.createElement("span", {
      style: { color: 'var(--tx-2)', flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }
    }, ev.desc),
    /*#__PURE__*/React.createElement("span", {
      style: { fontSize: 10, color: 'var(--tx-3)', fontFamily: 'var(--mono)', marginLeft: 'auto', flexShrink: 0 }
    }, username));
  })));
};

// Legacy alias
const ActivityStream = ActionLog;

/* ═══════════════════ WELCOME / INVITATION SCREEN ═══════════════════ */

const WelcomeScreen = ({
  onContinue
}) => /*#__PURE__*/React.createElement("div", {
  className: "grid-bg",
  style: {
    height: '100%',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    position: 'relative'
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    position: 'absolute',
    top: 16,
    right: 16
  }
}, /*#__PURE__*/React.createElement(ThemeToggle, null)), /*#__PURE__*/React.createElement("div", {
  className: "anim-up",
  style: {
    width: '100%',
    maxWidth: 600,
    padding: 20
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    background: 'var(--bg-1)',
    border: '1px solid var(--border-0)',
    borderRadius: 'var(--r-lg)',
    padding: '48px 44px',
    position: 'relative',
    overflow: 'hidden'
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    height: 3,
    background: 'linear-gradient(90deg, var(--gold), var(--teal), var(--blue))'
  }
}), /*#__PURE__*/React.createElement("div", {
  style: {
    display: 'flex',
    alignItems: 'center',
    gap: 14,
    marginBottom: 6
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    width: 48,
    height: 48,
    borderRadius: 'var(--r-lg)',
    background: 'var(--gold-dim)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    color: 'var(--gold)'
  }
}, /*#__PURE__*/React.createElement(I, {
  n: "shield",
  s: 26
})), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h1", {
  style: {
    fontSize: 28,
    fontWeight: 800,
    fontFamily: 'var(--serif)',
    letterSpacing: '-0.02em'
  }
}, "Khora"), /*#__PURE__*/React.createElement("span", {
  style: {
    fontFamily: 'var(--mono)',
    fontSize: 10,
    color: 'var(--tx-2)',
    letterSpacing: '.08em'
  }
}, "SOVEREIGN CASE MANAGEMENT"))), /*#__PURE__*/React.createElement("p", {
  style: {
    color: 'var(--tx-0)',
    fontSize: 15,
    marginTop: 24,
    lineHeight: 1.7,
    fontWeight: 500
  }
}, "You've been invited to access Khora \u2014 a system where ", /*#__PURE__*/React.createElement("em", null, "you"), " own your data."), /*#__PURE__*/React.createElement("p", {
  style: {
    color: 'var(--tx-1)',
    fontSize: 13.5,
    marginTop: 12,
    lineHeight: 1.7
  }
}, "Khora works like email \u2014 you create a free account on a provider you trust, and you can connect with anyone on the network. Your data is never locked inside a single company. To get started, you'll create a free account (it takes less than a minute)."), /*#__PURE__*/React.createElement("div", {
  style: {
    background: 'var(--bg-2)',
    border: '1px solid var(--border-1)',
    borderRadius: 'var(--r-lg)',
    padding: '20px 22px',
    marginTop: 24
  }
}, /*#__PURE__*/React.createElement("span", {
  style: {
    fontFamily: 'var(--mono)',
    fontSize: 10.5,
    color: 'var(--gold)',
    letterSpacing: '.06em',
    fontWeight: 600,
    display: 'block',
    marginBottom: 12
  }
}, "GETTING STARTED"), /*#__PURE__*/React.createElement("div", {
  style: {
    display: 'flex',
    gap: 14,
    marginBottom: 16
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    width: 24,
    height: 24,
    borderRadius: '50%',
    background: 'var(--teal-dim)',
    color: 'var(--teal)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    fontSize: 12,
    fontWeight: 800,
    fontFamily: 'var(--mono)',
    flexShrink: 0,
    marginTop: 1
  }
}, "1"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 13.5,
    fontWeight: 600,
    color: 'var(--tx-0)',
    marginBottom: 4
  }
}, "Create your account"), /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 12.5,
    color: 'var(--tx-1)',
    lineHeight: 1.6
  }
}, "Click \"Get Started\" below, then use the ", /*#__PURE__*/React.createElement("strong", {
  style: {
    color: 'var(--tx-0)'
  }
}, "\"Create Account\""), " tab. Pick a username and password, or use the ", /*#__PURE__*/React.createElement("strong", {
  style: {
    color: 'var(--tx-0)'
  }
}, "dice"), " and ", /*#__PURE__*/React.createElement("strong", {
  style: {
    color: 'var(--tx-0)'
  }
}, "key"), " buttons to generate random ones. Creating your account signs you in automatically."), /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 11.5,
    color: 'var(--tx-2)',
    lineHeight: 1.5,
    marginTop: 6
  }
}, "Your account lives on an open network \u2014 like email, you can connect with anyone regardless of which server they use. For extra privacy, use a random username since your server can see metadata."))), /*#__PURE__*/React.createElement("div", {
  style: {
    display: 'flex',
    gap: 14,
    marginBottom: 16
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    width: 24,
    height: 24,
    borderRadius: '50%',
    background: 'var(--teal-dim)',
    color: 'var(--teal)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    fontSize: 12,
    fontWeight: 800,
    fontFamily: 'var(--mono)',
    flexShrink: 0,
    marginTop: 1
  }
}, "2"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 13.5,
    fontWeight: 600,
    color: 'var(--tx-0)',
    marginBottom: 4
  }
}, "Save your credentials"), /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 12.5,
    color: 'var(--tx-1)',
    lineHeight: 1.6
  }
}, "After filling in your username and password, use the ", /*#__PURE__*/React.createElement("strong", {
  style: {
    color: 'var(--tx-0)'
  }
}, "\"Save credentials\""), " button to download a file with your login details. Keep it somewhere safe \u2014 you'll need it to sign in on other devices."), /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 11.5,
    color: 'var(--tx-2)',
    lineHeight: 1.5,
    marginTop: 6
  }
}, "Already have an account from another app on this network (like Element)? Use the \"Sign In\" tab instead \u2014 it works too."))), /*#__PURE__*/React.createElement("div", {
  style: {
    display: 'flex',
    gap: 14
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    width: 24,
    height: 24,
    borderRadius: '50%',
    background: 'var(--teal-dim)',
    color: 'var(--teal)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    fontSize: 12,
    fontWeight: 800,
    fontFamily: 'var(--mono)',
    flexShrink: 0,
    marginTop: 1
  }
}, "3"), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 13.5,
    fontWeight: 600,
    color: 'var(--tx-0)',
    marginBottom: 4
  }
}, "Your role appears automatically"), /*#__PURE__*/React.createElement("div", {
  style: {
    fontSize: 12.5,
    color: 'var(--tx-1)',
    lineHeight: 1.6
  }
}, "Khora figures out whether you're a ", /*#__PURE__*/React.createElement("strong", {
  style: {
    color: 'var(--teal)'
  }
}, "Client"), ", ", /*#__PURE__*/React.createElement("strong", {
  style: {
    color: 'var(--gold)'
  }
}, "Provider"), ", Org Admin, or Network member based on the groups you belong to. If you have more than one role, you can switch between them without signing out.")))), /*#__PURE__*/React.createElement("div", {
  style: {
    background: 'var(--teal-dim)',
    border: '1px solid rgba(62,201,176,.15)',
    borderRadius: 'var(--r)',
    padding: '12px 16px',
    marginTop: 20,
    fontSize: 12,
    color: 'var(--tx-1)',
    lineHeight: 1.6,
    display: 'flex',
    gap: 10,
    alignItems: 'flex-start'
  }
}, /*#__PURE__*/React.createElement("div", {
  style: {
    flexShrink: 0,
    marginTop: 1
  }
}, /*#__PURE__*/React.createElement(I, {
  n: "lock",
  s: 15
})), /*#__PURE__*/React.createElement("span", null, "Your data is encrypted per-field on your device before it ever leaves. Providers see only the specific fields you share. You can revoke access at any time.")), /*#__PURE__*/React.createElement("button", {
  onClick: onContinue,
  className: "b-pri",
  style: {
    width: '100%',
    padding: 14,
    fontSize: 15,
    marginTop: 28,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 10
  }
}, "Get Started ", /*#__PURE__*/React.createElement(I, {
  n: "chevR",
  s: 18
})), /*#__PURE__*/React.createElement("p", {
  style: {
    textAlign: 'center',
    marginTop: 16,
    fontSize: 11.5,
    color: 'var(--tx-3)',
    fontFamily: 'var(--mono)',
    letterSpacing: '.03em'
  }
}, "Already have an account? Click \"Get Started\" to sign in."))));

/* ═══════════════════ LOGIN ═══════════════════ */
const LoginScreen = ({
  onLogin
}) => {
  const [mode, setMode] = useState('login'); // login | register
  const [hs, setHs] = useState('hyphae.social');
  const [user, setUser] = useState('');
  const [pass, setPass] = useState('');
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState('');
  const [extReg, setExtReg] = useState(null); // null or { server, username }
  const [copied, setCopied] = useState(false);

  // Extract host server from username if present (e.g. @user:matrix.org -> matrix.org)
  const userHost = user.includes(':') ? user.split(':').slice(1).join(':') : '';
  const effectiveHs = userHost || hs;
  const hideHs = !!userHost;
  const go = async e => {
    e.preventDefault();
    setLoading(true);
    setErr('');
    try {
      if (mode === 'register') {
        const baseUrl = effectiveHs.startsWith('http') ? effectiveHs : `https://${effectiveHs}`;
        // Probe server for supported registration auth flows
        const probe = await fetch(`${baseUrl}/_matrix/client/v3/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        });
        const probeData = await probe.json().catch(() => ({}));
        const flows = probeData.flows || [];
        const canDummy = flows.some(f => f.stages && f.stages.length === 1 && f.stages[0] === 'm.login.dummy');
        if (canDummy) {
          const resp = await fetch(`${baseUrl}/_matrix/client/v3/register`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: user.replace(/^@/, '').split(':')[0],
              password: pass,
              auth: {
                type: 'm.login.dummy',
                session: probeData.session
              }
            })
          });
          if (!resp.ok) {
            const e = await resp.json().catch(() => ({}));
            throw new Error(e.error || `Registration failed (${resp.status}). Try logging in if account exists.`);
          }
        } else {
          setExtReg({
            server: effectiveHs,
            username: user.replace(/^@/, '').split(':')[0]
          });
          setLoading(false);
          return;
        }
      }
      const s = await svc.login(effectiveHs, user, pass);
      onLogin(s);
    } catch (e) {
      setErr(e.message);
    }
    setLoading(false);
  };
  const infoSectionStyle = { maxWidth: 720, margin: '0 auto', padding: '0 20px' };
  const infoCardStyle = { background: 'var(--bg-1)', border: '1px solid var(--border-0)', borderRadius: 'var(--r-lg)', padding: '24px 24px' };
  const sectionLabelStyle = { fontFamily: 'var(--mono)', fontSize: 10, color: 'var(--gold)', letterSpacing: '.1em', textTransform: 'uppercase', fontWeight: 600, marginBottom: 12 };
  const sectionTitleStyle = { fontFamily: 'var(--serif)', fontSize: 22, fontWeight: 700, color: 'var(--tx-0)', marginBottom: 10, letterSpacing: '-0.01em' };
  const bodyTextStyle = { fontSize: 13.5, color: 'var(--tx-1)', lineHeight: 1.7 };
  const featureIconBox = (bg, fg) => ({ width: 40, height: 40, borderRadius: 'var(--r-lg)', background: bg, display: 'flex', alignItems: 'center', justifyContent: 'center', color: fg, flexShrink: 0 });

  return /*#__PURE__*/React.createElement("div", {
    className: "grid-bg",
    style: {
      height: '100%',
      overflowY: 'auto',
      position: 'relative'
    }
  },

  /* ── Top navbar ── */
  /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      zIndex: 100,
      background: 'var(--bg-0)',
      borderBottom: '1px solid var(--border-0)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      padding: '0 24px',
      height: 56
    }
  },
  /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 10 } },
    /*#__PURE__*/React.createElement("div", {
      style: { width: 32, height: 32, borderRadius: 'var(--r)', background: 'var(--gold-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--gold)' }
    }, /*#__PURE__*/React.createElement(I, { n: "shield", s: 18 })),
    /*#__PURE__*/React.createElement("span", {
      style: { fontFamily: 'var(--serif)', fontSize: 18, fontWeight: 800, letterSpacing: '-0.02em' }
    }, "Khora")
  ),
  /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 12 } },
    /*#__PURE__*/React.createElement(ThemeToggle, null),
    /*#__PURE__*/React.createElement("button", {
      className: "b-gho",
      onClick: () => { setMode('login'); window.scrollTo({ top: 0, behavior: 'smooth' }); },
      style: { padding: '8px 16px', fontSize: 13, fontWeight: 600 }
    }, "Login")
  )),

  /* ── Hero section: dodecahedron + login card ── */
  /*#__PURE__*/React.createElement("div", {
    style: {
      minHeight: '100%',
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      padding: '96px 20px 20px'
    }
  },

  /* Spinning dodecahedron hero */
  /*#__PURE__*/React.createElement("div", {
    style: { marginBottom: 20 }
  }, /*#__PURE__*/React.createElement(SpinningDodeca, { size: 120 })),

  /* Login card */
  /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      width: '100%',
      maxWidth: 440
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--bg-1)',
      border: '1px solid var(--border-0)',
      borderRadius: 'var(--r-lg)',
      padding: '44px 40px',
      position: 'relative',
      overflow: 'hidden'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      position: 'absolute',
      top: 0,
      left: 0,
      right: 0,
      height: 3,
      background: 'linear-gradient(90deg, var(--gold), var(--teal), var(--blue))'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("h1", {
    style: {
      fontSize: 28,
      fontWeight: 800,
      fontFamily: 'var(--serif)',
      letterSpacing: '-0.02em'
    }
  }, "Khora"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10,
      color: 'var(--tx-2)',
      letterSpacing: '.08em'
    }
  }, "SOVEREIGN CASE MANAGEMENT")), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 13,
      marginTop: 18,
      marginBottom: 24,
      lineHeight: 1.65,
      textAlign: 'center'
    }
  }, "Your data, your control. Every piece of information is encrypted separately \u2014 providers see only what you choose to share."), /*#__PURE__*/React.createElement("div", {
    className: "tabs",
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: `tab ${mode === 'login' ? 'active' : ''}`,
    onClick: () => {
      setMode('login');
      setErr('');
      setExtReg(null);
    }
  }, "Sign In"), /*#__PURE__*/React.createElement("div", {
    className: `tab ${mode === 'register' ? 'active' : ''}`,
    onClick: () => {
      setMode('register');
      setErr('');
      setExtReg(null);
    }
  }, "Create Account")), extReg && /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: 20,
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10,
      color: 'var(--tx-2)',
      letterSpacing: '.1em',
      textTransform: 'uppercase',
      marginBottom: 6
    }
  }, "\u25CF STEP 1"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 18,
      fontWeight: 700,
      color: 'var(--tx-0)',
      marginBottom: 8
    }
  }, "Create your account on ", /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--teal)'
    }
  }, extReg.server)), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6,
      marginBottom: 16
    }
  }, "This server requires verification (like email or CAPTCHA). Create your account on their website first, then come back to sign in."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 9.5,
      color: 'var(--tx-2)',
      letterSpacing: '.1em',
      textTransform: 'uppercase',
      marginBottom: 4
    }
  }, "YOUR USERNAME"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      background: 'var(--bg-1)',
      border: '1px solid var(--border-1)',
      borderRadius: 'var(--r)',
      padding: '10px 12px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      flex: 1,
      fontFamily: 'var(--mono)',
      fontSize: 14,
      color: 'var(--tx-0)',
      fontWeight: 600
    }
  }, extReg.username), /*#__PURE__*/React.createElement("button", {
    type: "button",
    className: "b-gho b-xs",
    onClick: () => {
      navigator.clipboard.writeText(extReg.username);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    },
    style: {
      flexShrink: 0,
      display: 'inline-flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: copied ? "check" : "copy",
    s: 12
  }), " ", copied ? "Copied" : "Copy"))), /*#__PURE__*/React.createElement("button", {
    type: "button",
    className: "b-pri",
    onClick: () => window.open('https://' + extReg.server, '_blank'),
    style: {
      width: '100%',
      padding: 10,
      fontSize: 13,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 6
    }
  }, "Open ", extReg.server, " ", /*#__PURE__*/React.createElement(I, {
    n: "external-link",
    s: 14
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      borderTop: '1px solid var(--border-0)',
      margin: '20px 0'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10,
      color: 'var(--tx-2)',
      letterSpacing: '.1em',
      textTransform: 'uppercase',
      marginBottom: 6
    }
  }, "\u25CF STEP 2"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 18,
      fontWeight: 700,
      color: 'var(--tx-0)',
      marginBottom: 8
    }
  }, "Sign in here"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6,
      marginBottom: 16
    }
  }, "Once your account exists on the server, come back and sign in with the same username and password."), /*#__PURE__*/React.createElement("button", {
    type: "button",
    className: "b-pri",
    onClick: () => {
      setExtReg(null);
      setMode('login');
      setErr('');
    },
    style: {
      width: '100%',
      padding: 10,
      fontSize: 13,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 6,
      marginBottom: 10
    }
  }, "I've created my account ", /*#__PURE__*/React.createElement(I, {
    n: "arrow-right",
    s: 14
  })), /*#__PURE__*/React.createElement("button", {
    type: "button",
    className: "b-gho",
    onClick: () => setExtReg(null),
    style: {
      width: '100%',
      padding: 8,
      fontSize: 12,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 4,
      color: 'var(--tx-2)'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "arrow-left",
    s: 12
  }), " Pick a different server")), mode === 'register' && !extReg && /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '12px 14px',
      marginBottom: 16,
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.7
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: 600,
      color: 'var(--tx-0)',
      marginBottom: 4
    }
  }, "What is a Matrix account?"), /*#__PURE__*/React.createElement("div", null, "Khora runs on ", /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--tx-0)'
    }
  }, "Matrix"), " \u2014 an open network, like email. You pick a server to host your account, and you can connect with anyone on the network regardless of which server they use."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 8
    }
  }, "All servers use ", /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--tx-0)'
    }
  }, "end-to-end encryption"), " \u2014 your data is encrypted on your device before it's sent, so no server operator can read it. The main differences between servers are speed, location, and who runs them."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 8,
      fontSize: 11.5,
      color: 'var(--tx-2)'
    }
  }, "Since your server can see ", /*#__PURE__*/React.createElement("em", null, "metadata"), " (who you talk to, when you're online), consider using a ", /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--tx-1)'
    }
  }, "random username"), " \u2014 click the dice icon below to generate one. Browse servers at ", /*#__PURE__*/React.createElement("a", {
    href: "https://servers.joinmatrix.org/",
    target: "_blank",
    rel: "noopener",
    style: {
      color: 'var(--teal)'
    }
  }, "servers.joinmatrix.org"), ".")), !extReg && /*#__PURE__*/React.createElement("form", {
    onSubmit: go
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "USERNAME"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("input", {
    style: {
      flex: 1
    },
    value: user,
    onChange: e => setUser(e.target.value),
    placeholder: mode === 'register' ? 'choose a username' : 'your username',
    autoComplete: "username"
  }), mode === 'register' && /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => {
      if (window.generateUsername) setUser(window.generateUsername());
    },
    className: "b-gho",
    style: {
      padding: '8px 10px',
      flexShrink: 0
    },
    title: "Generate random username"
  }, /*#__PURE__*/React.createElement(I, {
    n: "dice",
    s: 16
  })))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "PASSWORD"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "password",
    style: {
      flex: 1
    },
    value: pass,
    onChange: e => setPass(e.target.value),
    placeholder: "\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",
    autoComplete: mode === 'register' ? 'new-password' : 'current-password'
  }), mode === 'register' && /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => {
      const c = 'abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789!@#$%&*';
      const a = crypto.getRandomValues(new Uint8Array(20));
      setPass(Array.from(a, v => c[v % c.length]).join(''));
    },
    className: "b-gho",
    style: {
      padding: '8px 10px',
      flexShrink: 0
    },
    title: "Generate strong password"
  }, /*#__PURE__*/React.createElement(I, {
    n: "key",
    s: 16
  })))), mode === 'register' && user && pass && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14,
      textAlign: 'right'
    }
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    className: "b-gho b-xs",
    onClick: () => {
      const txt = `Khora Account Credentials\n========================\nServer: ${effectiveHs}\nUsername: ${user}\nPassword: ${pass}\n\nKeep this file safe. You will need these to sign in.\n`;
      const b = new Blob([txt], {
        type: 'text/plain'
      });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(b);
      a.download = 'khora-credentials.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    },
    style: {
      display: 'inline-flex',
      alignItems: 'center',
      gap: 5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "download",
    s: 12
  }), " Save credentials")), !hideHs && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "SERVER"), /*#__PURE__*/React.createElement("input", {
    value: hs,
    onChange: e => setHs(e.target.value),
    placeholder: "e.g. matrix.org"
  })), err && /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--red-dim)',
      border: '1px solid rgba(232,93,93,.2)',
      borderRadius: 'var(--r)',
      padding: '9px 14px',
      fontSize: 12.5,
      color: 'var(--red)',
      marginBottom: 16
    }
  }, err), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    className: "b-pri",
    disabled: loading,
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 8
    }
  }, loading ? /*#__PURE__*/React.createElement(Spin, {
    s: 16
  }) : /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 16
  }), " ", loading ? 'Connecting...' : mode === 'register' ? 'Create Account & Connect' : 'Connect')), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 16,
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 6,
      height: 6,
      borderRadius: '50%',
      background: typeof matrixcs !== 'undefined' ? 'var(--green)' : 'var(--gold)'
    }
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10.5,
      color: 'var(--tx-3)'
    }
  }, typeof matrixcs !== 'undefined' ? 'Secure connection ready' : 'Connecting\u2026'))),

  /* Scroll hint arrow */
  /*#__PURE__*/React.createElement("div", {
    style: { textAlign: 'center', marginTop: 16 }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => { const el = document.getElementById('khora-info'); if (el) el.scrollIntoView({ behavior: 'smooth' }); },
    className: "b-gho b-xs",
    style: { display: 'inline-flex', alignItems: 'center', gap: 6, color: 'var(--tx-3)', fontSize: 11, fontFamily: 'var(--mono)', letterSpacing: '.04em' }
  }, "Learn more ", /*#__PURE__*/React.createElement(I, { n: "chevronDown", s: 14 })))

  ), /* end anim-up */
  ), /* end hero section */

  /* ══════════════════════════════════════════════════════════════ */
  /* ═══════════════════ INFO SECTIONS BELOW FOLD ═══════════════ */
  /* ══════════════════════════════════════════════════════════════ */

  /*#__PURE__*/React.createElement("div", {
    id: "khora-info",
    style: { paddingBottom: 80 }
  },

  /* ── Section 1: What is Khora? ── */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoSectionStyle, paddingTop: 64, paddingBottom: 48 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { textAlign: 'center', marginBottom: 40 }
  }, /*#__PURE__*/React.createElement("div", {
    style: sectionLabelStyle
  }, "WHAT IS KHORA?"), /*#__PURE__*/React.createElement("h2", {
    style: { ...sectionTitleStyle, fontSize: 26 }
  }, "Your information, under your control"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, maxWidth: 560, margin: '0 auto' }
  }, "Khora is a case management system where the person being served owns their data. You decide exactly which pieces of your information to share with each provider, and you can take it back at any time. No vendor lock-in, no corporate database you can't see inside.")),

  /* Three feature cards */
  /*#__PURE__*/React.createElement("div", {
    style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 16 }
  },

  /* Card: You own it */
  /*#__PURE__*/React.createElement("div", {
    style: infoCardStyle
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--gold-dim)', 'var(--gold)')
  }, /*#__PURE__*/React.createElement(I, { n: "shield", s: 20 })), /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)' }
  }, "You own it")), /*#__PURE__*/React.createElement("p", {
    style: bodyTextStyle
  }, "Your information lives in a personal vault that belongs to you. Not to an organization, not to a database administrator \u2014 to you. You carry it between providers.")),

  /* Card: Field-by-field sharing */
  /*#__PURE__*/React.createElement("div", {
    style: infoCardStyle
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--teal-dim)', 'var(--teal)')
  }, /*#__PURE__*/React.createElement(I, { n: "eye", s: 20 })), /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)' }
  }, "Field-by-field sharing")), /*#__PURE__*/React.createElement("p", {
    style: bodyTextStyle
  }, "Share your name with one provider, your case notes with another, your contact info with a third. Each provider sees only the specific fields you choose \u2014 nothing more.")),

  /* Card: Revoke anytime */
  /*#__PURE__*/React.createElement("div", {
    style: infoCardStyle
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--red-dim)', 'var(--red)')
  }, /*#__PURE__*/React.createElement(I, { n: "x", s: 20 })), /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)' }
  }, "Revoke anytime")), /*#__PURE__*/React.createElement("p", {
    style: bodyTextStyle
  }, "Changed your mind? Pull back access to specific fields, or cut a provider off entirely. When you revoke, the encryption keys are destroyed \u2014 it's not a policy, it's math.")))),

  /* ── Section 2: Who is Khora for? ── */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoSectionStyle, paddingTop: 48, paddingBottom: 48 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { textAlign: 'center', marginBottom: 40 }
  }, /*#__PURE__*/React.createElement("div", {
    style: sectionLabelStyle
  }, "WHO IS IT FOR?"), /*#__PURE__*/React.createElement("h2", {
    style: sectionTitleStyle
  }, "Teams, organizations, and networks of any kind"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, maxWidth: 560, margin: '0 auto' }
  }, "Khora works for anyone where a team provides something for other people. It's ideal when there are teams within teams, organizations within networks, networks within networks. Nonprofits, clinics, outreach teams, businesses \u2014 if you have staff serving clients, Khora fits.")),

  /* Role cards - 2x2 grid */
  /*#__PURE__*/React.createElement("div", {
    style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: 16 }
  },

  /* Client */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoCardStyle, display: 'flex', gap: 14, alignItems: 'flex-start' }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--teal-dim)', 'var(--teal)')
  }, /*#__PURE__*/React.createElement(I, { n: "user", s: 20 })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)', marginBottom: 4 }
  }, "Client"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, fontSize: 12.5 }
  }, "The person being served. Owns a personal vault with all their data. Decides exactly who sees what, field by field."))),

  /* Provider */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoCardStyle, display: 'flex', gap: 14, alignItems: 'flex-start' }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--gold-dim)', 'var(--gold)')
  }, /*#__PURE__*/React.createElement(I, { n: "briefcase", s: 20 })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)', marginBottom: 4 }
  }, "Provider"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, fontSize: 12.5 }
  }, "A case worker or service professional. Connects to clients, records assessments, and manages cases \u2014 seeing only what each client has authorized."))),

  /* Organization */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoCardStyle, display: 'flex', gap: 14, alignItems: 'flex-start' }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--blue-dim)', 'var(--blue)')
  }, /*#__PURE__*/React.createElement(I, { n: "users", s: 20 })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)', marginBottom: 4 }
  }, "Organization"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, fontSize: 12.5 }
  }, "A team or agency. Manages staff roles, policies, and settings. Organizations can join networks to share standards with peer organizations."))),

  /* Network */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoCardStyle, display: 'flex', gap: 14, alignItems: 'flex-start' }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--purple-dim)', 'var(--purple)')
  }, /*#__PURE__*/React.createElement(I, { n: "globe", s: 20 })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)', marginBottom: 4 }
  }, "Network"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, fontSize: 12.5 }
  }, "The federation layer. Coordinates shared standards across member organizations \u2014 what you call things, how you measure them, and how decisions get made.")))

  ), /* end role grid */

  /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, textAlign: 'center', marginTop: 20, fontSize: 12.5, color: 'var(--tx-2)' }
  }, "You don't pick a role at signup. Khora detects it automatically based on the groups you belong to. One account can hold multiple roles at once.")),

  /* ── Section 3: Shared Standards & the GIVEN/MEANT divide ── */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoSectionStyle, paddingTop: 48, paddingBottom: 48 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { textAlign: 'center', marginBottom: 32 }
  }, /*#__PURE__*/React.createElement("div", {
    style: sectionLabelStyle
  }, "SHARED STANDARDS"), /*#__PURE__*/React.createElement("h2", {
    style: sectionTitleStyle
  }, "Agree on what you call things"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, maxWidth: 560, margin: '0 auto' }
  }, "When multiple organizations work together, they need a common language. Khora lets networks define shared forms, definitions, and norms \u2014 then propagate them to every member organization. Everyone collects data the same way, so it actually means the same thing.")),

  /* GIVEN / MEANT explainer */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoCardStyle, marginTop: 24 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { ...sectionLabelStyle, marginBottom: 16, color: 'var(--teal)' }
  }, "THE GIVEN / MEANT DIVIDE"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, marginBottom: 16 }
  }, "Here's a problem most systems hide from you: the same piece of information means different things to different institutions. Khora makes this visible."), /*#__PURE__*/React.createElement("div", {
    style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 16, marginBottom: 16 }
  },

  /* GIVEN side */
  /*#__PURE__*/React.createElement("div", {
    style: { background: 'var(--bg-2)', borderRadius: 'var(--r)', padding: '16px 18px', borderLeft: '3px solid var(--teal)' }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontFamily: 'var(--mono)', fontSize: 10, color: 'var(--teal)', letterSpacing: '.1em', fontWeight: 700, marginBottom: 8 }
  }, "GIVEN"), /*#__PURE__*/React.createElement("div", {
    style: { fontFamily: 'var(--serif)', fontSize: 15, color: 'var(--tx-0)', fontWeight: 600, marginBottom: 6 }
  }, "What actually happened"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, fontSize: 12.5 }
  }, "The raw information, as observed. A client says: \"I slept in my car last night.\" That's the given \u2014 uninterpreted, owned by the person who said it.")),

  /* MEANT side */
  /*#__PURE__*/React.createElement("div", {
    style: { background: 'var(--bg-2)', borderRadius: 'var(--r)', padding: '16px 18px', borderLeft: '3px solid var(--gold)' }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontFamily: 'var(--mono)', fontSize: 10, color: 'var(--gold)', letterSpacing: '.1em', fontWeight: 700, marginBottom: 8 }
  }, "MEANT"), /*#__PURE__*/React.createElement("div", {
    style: { fontFamily: 'var(--serif)', fontSize: 15, color: 'var(--tx-0)', fontWeight: 600, marginBottom: 6 }
  }, "What an institution classifies it as"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, fontSize: 12.5 }
  }, "The institutional interpretation. One agency calls it \"Literally Homeless, Category 1.\" Another says \"Priority 1 \u2014 immediate outreach.\" A third might not count it at all. Same fact, different meanings."))

  ), /* end GIVEN/MEANT grid */

  /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, fontSize: 12.5, color: 'var(--tx-2)' }
  }, "Most systems collapse this distinction \u2014 they record the classification and throw away the original observation. Khora keeps both, traces which framework turned one into the other, and shows you when frameworks disagree. The raw information always belongs to the person who provided it; the interpretations are documented as exactly that \u2014 interpretations."))),

  /* ── Section 4: How Security Works ── */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoSectionStyle, paddingTop: 48, paddingBottom: 48 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { textAlign: 'center', marginBottom: 40 }
  }, /*#__PURE__*/React.createElement("div", {
    style: sectionLabelStyle
  }, "SECURITY"), /*#__PURE__*/React.createElement("h2", {
    style: sectionTitleStyle
  }, "Three layers of encryption, zero trust required"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, maxWidth: 560, margin: '0 auto' }
  }, "You don't have to trust anyone \u2014 not the server operator, not the network, not us. Khora encrypts your data at every level, and the keys never leave your hands.")),

  /*#__PURE__*/React.createElement("div", {
    style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 16 }
  },

  /* Layer 1: In transit */
  /*#__PURE__*/React.createElement("div", {
    style: infoCardStyle
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--teal-dim)', 'var(--teal)')
  }, /*#__PURE__*/React.createElement(I, { n: "lock", s: 20 })), /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)' }
  }, "Encrypted in transit")), /*#__PURE__*/React.createElement("p", {
    style: bodyTextStyle
  }, "Everything you send is end-to-end encrypted before it leaves your device. The server that relays your messages cannot read them \u2014 it only knows that a message was sent, not what it says.")),

  /* Layer 2: Per-field */
  /*#__PURE__*/React.createElement("div", {
    style: infoCardStyle
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--gold-dim)', 'var(--gold)')
  }, /*#__PURE__*/React.createElement(I, { n: "key", s: 20 })), /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)' }
  }, "Encrypted per field")), /*#__PURE__*/React.createElement("p", {
    style: bodyTextStyle
  }, "Each provider you connect with gets a unique encryption key for each piece of data you share. Two providers working on the same case literally cannot see each other's fields \u2014 it's not access control, it's separate encryption.")),

  /* Layer 3: At rest */
  /*#__PURE__*/React.createElement("div", {
    style: infoCardStyle
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--purple-dim)', 'var(--purple)')
  }, /*#__PURE__*/React.createElement(I, { n: "shieldCheck", s: 20 })), /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)' }
  }, "Encrypted on your device")), /*#__PURE__*/React.createElement("p", {
    style: bodyTextStyle
  }, "Data stored on your device is encrypted at rest with a key derived from your session. When you log out, the key is destroyed. If someone gets your device while you're logged out, they get nothing."))

  )), /* end security grid + section */

  /* ── Section 5: What is a Matrix account? ── */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoSectionStyle, paddingTop: 48, paddingBottom: 48 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { textAlign: 'center', marginBottom: 32 }
  }, /*#__PURE__*/React.createElement("div", {
    style: sectionLabelStyle
  }, "YOUR ACCOUNT"), /*#__PURE__*/React.createElement("h2", {
    style: sectionTitleStyle
  }, "What is a Matrix account?"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, maxWidth: 560, margin: '0 auto' }
  }, "Khora runs on Matrix \u2014 an open, federated network. Think of it like email: you pick a server to host your account, and you can connect with anyone on the network regardless of which server they chose.")),

  /*#__PURE__*/React.createElement("div", {
    style: { ...infoCardStyle, maxWidth: 560, margin: '0 auto' }
  },

  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 14, marginBottom: 18, alignItems: 'flex-start' }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--teal-dim)', 'var(--teal)')
  }, /*#__PURE__*/React.createElement(I, { n: "globe", s: 20 })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)', marginBottom: 4 }
  }, "No single company controls it"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, fontSize: 12.5 }
  }, "Matrix is an open standard, not a product. Hundreds of independent servers run it. Your account isn't trapped inside one company's platform."))),

  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 14, marginBottom: 18, alignItems: 'flex-start' }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--gold-dim)', 'var(--gold)')
  }, /*#__PURE__*/React.createElement(I, { n: "share", s: 20 })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)', marginBottom: 4 }
  }, "Connect across servers"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, fontSize: 12.5 }
  }, "Just like you can email someone on Gmail from Yahoo, you can connect with anyone on any Matrix server. Your choice of server doesn't limit who you work with."))),

  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 14, alignItems: 'flex-start' }
  }, /*#__PURE__*/React.createElement("div", {
    style: featureIconBox('var(--purple-dim)', 'var(--purple)')
  }, /*#__PURE__*/React.createElement(I, { n: "eyeOff", s: 20 })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: { fontWeight: 700, fontSize: 14, color: 'var(--tx-0)', marginBottom: 4 }
  }, "Your server can see metadata, not content"), /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, fontSize: 12.5 }
  }, "The server that hosts your account can see who you connect with and when you're online, but never your actual data \u2014 it's encrypted before it leaves your device. For extra privacy, use a random username.")))

  ), /* end matrix card */

  /*#__PURE__*/React.createElement("p", {
    style: { ...bodyTextStyle, textAlign: 'center', marginTop: 20, fontSize: 12, color: 'var(--tx-3)' }
  }, "Browse available servers at ", /*#__PURE__*/React.createElement("a", {
    href: "https://servers.joinmatrix.org/",
    target: "_blank",
    rel: "noopener",
    style: { color: 'var(--teal)' }
  }, "servers.joinmatrix.org"), ".")),

  /* ── Footer ── */
  /*#__PURE__*/React.createElement("div", {
    style: { ...infoSectionStyle, paddingTop: 40, paddingBottom: 40, textAlign: 'center', borderTop: '1px solid var(--border-0)' }
  }, /*#__PURE__*/React.createElement("div", {
    style: { marginBottom: 12 }
  }, /*#__PURE__*/React.createElement(SpinningDodeca, { size: 28 })), /*#__PURE__*/React.createElement("p", {
    style: { fontFamily: 'var(--mono)', fontSize: 10.5, color: 'var(--tx-3)', letterSpacing: '.06em', lineHeight: 1.8 }
  }, "Built on the ", /*#__PURE__*/React.createElement("a", {
    href: "https://matrix.org",
    target: "_blank",
    rel: "noopener",
    style: { color: 'var(--tx-2)' }
  }, "Matrix"), " protocol. Open standard. No vendor lock-in."))

  ) /* end khora-info */
  ); /* end outer grid-bg */
};


/* ═══════════════════ PERSONAL DASHBOARD ═══════════════════ */
const PersonalDashboard = ({
  session,
  providers,
  observations,
  myResources,
  vaultData,
  allFields,
  vaultRoom,
  myTeams,
  onNavigate
}) => {
  const [loading, setLoading] = useState(true);
  const [bridgeEvents, setBridgeEvents] = useState([]);
  const [providerNotes, setProviderNotes] = useState([]);
  const [eventFilter, setEventFilter] = useState('all'); // all | notes | resources | fields | messages
  const [eventLimit, setEventLimit] = useState(25);

  // Time formatting for the dashboard
  const pdTimeAgo = ts => {
    if (!ts) return '';
    const diff = Date.now() - ts;
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
    if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
    return new Date(ts).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric'
    });
  };

  // Load all events from bridge rooms relevant to this individual
  const loadBridgeActivity = useCallback(async () => {
    setLoading(true);
    try {
      const allEvents = [];
      const allNotes = [];
      for (const prov of providers) {
        const bid = prov.bridgeRoomId;
        if (!bid || !svc.client) continue;
        const room = svc.client.getRoom(bid);
        if (!room) continue;

        // Paginate to get history
        try {
          for (let i = 0; i < 3; i++) {
            const canPaginate = room.getLiveTimeline().getPaginationToken('b');
            if (!canPaginate) break;
            await svc.client.scrollback(room, 80);
          }
        } catch (e) {/* continue with available events */}
        const seenIds = new Set();
        const roomEvents = [];
        const timelineSets = room.getTimelineSets ? room.getTimelineSets() : [];
        const collectEvents = ev => {
          if (seenIds.has(ev.getId())) return;
          seenIds.add(ev.getId());
          roomEvents.push(ev);
        };
        if (timelineSets.length > 0) {
          for (const ts of timelineSets) {
            for (const tl of ts.getTimelines()) {
              for (const ev of tl.getEvents()) collectEvents(ev);
            }
          }
        } else {
          for (const ev of room.getLiveTimeline().getEvents()) collectEvents(ev);
        }
        // Also include current state events
        for (const ev of room.currentState.getStateEvents()) collectEvents(ev);
        const provName = prov.providerName || prov.providerUserId || 'Provider';
        const orgName = prov.providerProfile?.org_membership?.org_name;
        for (const ev of roomEvents) {
          const type = ev.getType();
          const content = ev.getContent();
          const sender = ev.getSender();
          const ts = ev.getTs();
          const isOwnEvent = sender === svc.userId;

          // Categorize events
          if (type === EVT.NOTE) {
            allNotes.push({
              id: ev.getId(),
              title: content.title || 'Untitled',
              content: content.content || content.text || '',
              author: sender,
              provName,
              orgName,
              ts,
              tags: content.tags || [],
              tombstoned: content.tombstoned || false,
              bridgeRoomId: bid
            });
            allEvents.push({
              id: ev.getId(),
              category: 'notes',
              ts,
              provName,
              orgName,
              sender,
              icon: 'msg',
              iconBg: 'var(--purple-dim)',
              iconColor: 'var(--purple)',
              title: isOwnEvent ? 'You added a note' : `${provName} added a note`,
              desc: content.title || content.content?.slice(0, 80) || 'Note added',
              tags: [{
                label: 'NOTE',
                cls: 'tag-purple'
              }]
            });
          } else if (type === EVT.NOTE_EDIT) {
            allEvents.push({
              id: ev.getId(),
              category: 'notes',
              ts,
              provName,
              orgName,
              sender,
              icon: 'edit',
              iconBg: 'var(--gold-dim)',
              iconColor: 'var(--gold)',
              title: isOwnEvent ? 'You edited a note' : `${provName} edited a note`,
              desc: content.title || 'Note updated',
              tags: [{
                label: 'EDIT',
                cls: 'tag-gold'
              }]
            });
          } else if (type === EVT.RESOURCE_ALLOC) {
            allEvents.push({
              id: ev.getId(),
              category: 'resources',
              ts,
              provName,
              orgName,
              sender,
              icon: 'layers',
              iconBg: 'var(--green-dim)',
              iconColor: 'var(--green)',
              title: `${provName} allocated a resource`,
              desc: `${content.quantity || 1} ${content.unit || 'unit'} of ${content.resource_name || content.resource_type_id || 'resource'}`,
              tags: [{
                label: 'RESOURCE',
                cls: 'tag-green'
              }]
            });
          } else if (type === EVT.RESOURCE_VAULT) {
            allEvents.push({
              id: ev.getId(),
              category: 'resources',
              ts,
              provName,
              orgName,
              sender,
              icon: 'layers',
              iconBg: 'var(--green-dim)',
              iconColor: 'var(--green)',
              title: 'Resource recorded to vault',
              desc: `${content.resource_name}: ${content.quantity} ${content.unit || ''}`,
              tags: [{
                label: 'VAULT RECORD',
                cls: 'tag-teal'
              }]
            });
          } else if (type === EVT.RESOURCE_EVENT) {
            const evtType = content.event || 'update';
            allEvents.push({
              id: ev.getId(),
              category: 'resources',
              ts,
              provName,
              orgName,
              sender,
              icon: 'layers',
              iconBg: evtType === 'revoked' ? 'var(--red-dim)' : 'var(--teal-dim)',
              iconColor: evtType === 'revoked' ? 'var(--red)' : 'var(--teal)',
              title: `Resource ${evtType}`,
              desc: `${content.quantity || ''} ${content.unit || ''} — ${content.allocation_id?.slice(0, 16) || ''}`.trim(),
              tags: [{
                label: evtType.toUpperCase(),
                cls: evtType === 'revoked' ? 'tag-red' : 'tag-teal'
              }]
            });
          } else if (type === EVT.BRIDGE_REFS && !isOwnEvent) {
            const fieldCount = Object.keys(content.fields || {}).length;
            allEvents.push({
              id: ev.getId(),
              category: 'fields',
              ts,
              provName,
              orgName,
              sender,
              icon: 'key',
              iconBg: 'var(--blue-dim)',
              iconColor: 'var(--blue)',
              title: content.revoked ? 'Field access revoked' : 'Shared fields updated',
              desc: `${fieldCount} encrypted field ref${fieldCount !== 1 ? 's' : ''}`,
              tags: [{
                label: content.revoked ? 'REVOKED' : 'FIELDS',
                cls: content.revoked ? 'tag-red' : 'tag-blue'
              }]
            });
          } else if (type === EVT.OBSERVATION) {
            allEvents.push({
              id: ev.getId(),
              category: 'observations',
              ts,
              provName,
              orgName,
              sender,
              icon: 'clipboard',
              iconBg: 'var(--orange-dim)',
              iconColor: 'var(--orange)',
              title: isOwnEvent ? 'You recorded an observation' : `${provName} recorded an observation`,
              desc: `${content.prompt_id || 'observation'}: ${content.value || ''}`,
              tags: [{
                label: 'OBSERVATION',
                cls: 'tag-orange'
              }, {
                label: isOwnEvent ? 'GIVEN' : 'MEANT',
                cls: isOwnEvent ? 'tag-teal' : 'tag-gold'
              }]
            });
          } else if (type === EVT.BRIDGE_META) {
            allEvents.push({
              id: ev.getId(),
              category: 'bridge',
              ts,
              provName,
              orgName,
              sender,
              icon: 'share',
              iconBg: 'var(--gold-dim)',
              iconColor: 'var(--gold)',
              title: content.status === 'tombstoned' ? 'Bridge revoked' : 'Bridge updated',
              desc: `Status: ${content.status || 'active'}`,
              tags: [{
                label: 'BRIDGE',
                cls: 'tag-gold'
              }]
            });
          } else if (type === 'm.room.message' && !isOwnEvent) {
            const cvType = content[`${NS}.type`];
            if (cvType === 'request') {
              allEvents.push({
                id: ev.getId(),
                category: 'messages',
                ts,
                provName,
                orgName,
                sender,
                icon: 'msg',
                iconBg: 'var(--gold-dim)',
                iconColor: 'var(--gold)',
                title: `${provName} sent an info request`,
                desc: content.body?.slice(0, 100) || '',
                tags: [{
                  label: 'REQUEST',
                  cls: 'tag-gold'
                }]
              });
            } else {
              allEvents.push({
                id: ev.getId(),
                category: 'messages',
                ts,
                provName,
                orgName,
                sender,
                icon: 'msg',
                iconBg: 'var(--blue-dim)',
                iconColor: 'var(--blue)',
                title: `${provName} sent a message`,
                desc: content.body?.slice(0, 100) || '',
                tags: [{
                  label: 'MESSAGE',
                  cls: 'tag-blue'
                }]
              });
            }
          } else if (type === EVT.ROSTER_ASSIGN && !isOwnEvent) {
            allEvents.push({
              id: ev.getId(),
              category: 'fields',
              ts,
              provName,
              orgName,
              sender,
              icon: 'users',
              iconBg: 'var(--teal-dim)',
              iconColor: 'var(--teal)',
              title: 'Case assignment updated',
              desc: `Assignment changed by ${provName}`,
              tags: [{
                label: 'ASSIGNMENT',
                cls: 'tag-teal'
              }]
            });
          } else if (type === EVT.OP && !isOwnEvent) {
            allEvents.push({
              id: ev.getId(),
              category: 'fields',
              ts,
              provName,
              orgName,
              sender,
              icon: 'git-commit',
              iconBg: 'var(--teal-dim)',
              iconColor: 'var(--teal)',
              title: `${content.op || 'EO'} operation by ${provName}`,
              desc: `${content.target || 'entity'} — ${content.frame?.epistemic || 'MEANT'}`,
              tags: [{
                label: content.op || 'OP',
                cls: 'tag-teal'
              }, {
                label: content.frame?.epistemic || 'MEANT',
                cls: content.frame?.epistemic === 'GIVEN' ? 'tag-teal' : 'tag-gold'
              }]
            });
          }
        }
      }
      allEvents.sort((a, b) => b.ts - a.ts);
      allNotes.sort((a, b) => b.ts - a.ts);
      setBridgeEvents(allEvents);
      setProviderNotes(allNotes.filter(n => !n.tombstoned));
    } catch (e) {
      console.error('PersonalDashboard load error:', e);
    }
    setLoading(false);
  }, [providers]);
  useEffect(() => {
    loadBridgeActivity();
  }, [loadBridgeActivity]);

  // Listen for real-time updates
  useEffect(() => {
    let debounce = null;
    const handler = () => {
      if (debounce) clearTimeout(debounce);
      debounce = setTimeout(loadBridgeActivity, 500);
    };
    window.addEventListener('khora:eo', handler);
    window.addEventListener('khora:timeline', handler);
    window.addEventListener('khora:state', handler);
    return () => {
      window.removeEventListener('khora:eo', handler);
      window.removeEventListener('khora:timeline', handler);
      window.removeEventListener('khora:state', handler);
    };
  }, [loadBridgeActivity]);

  // Filtered events
  const filteredEvents = useMemo(() => {
    if (eventFilter === 'all') return bridgeEvents;
    return bridgeEvents.filter(e => e.category === eventFilter);
  }, [bridgeEvents, eventFilter]);

  // Recent messages derived from bridge events
  const recentMessages = useMemo(() =>
    bridgeEvents.filter(e => e.category === 'messages').slice(0, 5),
    [bridgeEvents]
  );

  // Vault snapshot key fields
  const vaultKeyFields = [
    { key: 'full_name', label: 'Name' },
    { key: 'email', label: 'Email' },
    { key: 'phone', label: 'Phone' },
    { key: 'dob', label: 'Date of Birth' },
    { key: 'address', label: 'Address' },
  ];

  // Stats
  const activeResources = myResources.filter(r => r.status === 'active').length;
  const totalNotes = providerNotes.length;
  const totalObs = observations.length;
  const filledFields = allFields.filter(f => vaultData[f.key]).length;
  const vaultCompletionPct = allFields.length > 0 ? Math.round(filledFields / allFields.length * 100) : 0;
  const providerEventCount = bridgeEvents.filter(e => e.sender !== svc.userId).length;
  if (loading) return /*#__PURE__*/React.createElement("div", {
    style: {
      height: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement(Spin, {
    s: 28
  }));
  return /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 900,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, vaultData.full_name ? `Welcome, ${vaultData.full_name.split(' ')[0]}` : "My Dashboard"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "Your vault, teams, messages, and activity \u2014 all in one place.")), /*#__PURE__*/React.createElement("div", {
    className: "pd-grid"
  }, [{
    l: 'Providers',
    v: providers.length,
    c: 'gold',
    i: 'briefcase',
    nav: 'providers'
  }, {
    l: 'Notes About Me',
    v: totalNotes,
    c: 'purple',
    i: 'msg'
  }, {
    l: 'Observations',
    v: totalObs,
    c: 'blue',
    i: 'clipboard',
    nav: 'observations'
  }, {
    l: 'Active Resources',
    v: activeResources,
    c: 'green',
    i: 'layers',
    nav: 'resources'
  }, {
    l: 'Vault Fields',
    v: `${filledFields}/${allFields.length}`,
    c: 'teal',
    i: 'folder',
    nav: 'vault'
  }, {
    l: 'Teams',
    v: (myTeams || []).length,
    c: 'purple',
    i: 'users',
    nav: 'providers'
  }, {
    l: 'Messages',
    v: recentMessages.length,
    c: 'blue',
    i: 'msg',
    nav: 'inbox'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card pd-stat",
    style: {
      cursor: s.nav ? 'pointer' : 'default'
    },
    onClick: () => s.nav && onNavigate(s.nav)
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0
    }
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("span", {
    style: {
      color: `var(--${s.c})`,
      opacity: .5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: s.i,
    s: 16
  }))), /*#__PURE__*/React.createElement("div", {
    className: "num",
    style: {
      color: `var(--${s.c})`
    }
  }, s.v)))),
  /* ── Vault Snapshot + My Teams (two-column) ── */
  /*#__PURE__*/React.createElement("div", { className: "pd-two-col" },
    /* Vault Snapshot */
    /*#__PURE__*/React.createElement("div", { className: "pd-section", style: { marginBottom: 0 } },
      /*#__PURE__*/React.createElement("div", { className: "pd-section-hdr" },
        /*#__PURE__*/React.createElement("h3", null, /*#__PURE__*/React.createElement(I, { n: "folder", s: 16, c: "var(--teal)" }), " My Vault"),
        /*#__PURE__*/React.createElement("button", { onClick: () => onNavigate('vault'), className: "b-gho b-xs" }, "Edit Vault")
      ),
      /*#__PURE__*/React.createElement("div", { className: "pd-vault-snap" },
        /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 4 } },
          /*#__PURE__*/React.createElement("span", { style: { fontSize: 11, color: 'var(--tx-2)', fontFamily: 'var(--mono)' } }, filledFields, "/", allFields.length, " fields filled"),
          /*#__PURE__*/React.createElement("span", { style: { fontSize: 11, fontWeight: 600, color: 'var(--teal)' } }, vaultCompletionPct, "% complete")
        ),
        /*#__PURE__*/React.createElement("div", { className: "vault-progress-bar" },
          /*#__PURE__*/React.createElement("div", { className: "vault-progress-fill", style: { width: vaultCompletionPct + '%' } })
        ),
        vaultKeyFields.map(f => /*#__PURE__*/React.createElement("div", { key: f.key, className: "pd-vault-field-row" },
          /*#__PURE__*/React.createElement("span", { className: "pd-vault-field-key" }, f.label),
          vaultData[f.key]
            ? /*#__PURE__*/React.createElement("span", { className: "pd-vault-field-val" }, vaultData[f.key])
            : /*#__PURE__*/React.createElement("span", { className: "pd-vault-field-empty" }, "Not set")
        ))
      )
    ),
    /* My Teams */
    /*#__PURE__*/React.createElement("div", { className: "pd-section", style: { marginBottom: 0 } },
      /*#__PURE__*/React.createElement("div", { className: "pd-section-hdr" },
        /*#__PURE__*/React.createElement("h3", null, /*#__PURE__*/React.createElement(I, { n: "users", s: 16, c: "var(--purple)" }), " My Teams"),
        (myTeams || []).length > 0 && /*#__PURE__*/React.createElement("button", { onClick: () => onNavigate('providers'), className: "b-gho b-xs" }, "View All")
      ),
      (myTeams || []).length === 0
        ? /*#__PURE__*/React.createElement("div", { className: "pd-empty" },
            /*#__PURE__*/React.createElement(I, { n: "users", s: 28, c: "var(--tx-3)" }),
            /*#__PURE__*/React.createElement("p", { style: { marginTop: 8, fontSize: 12 } }, "No teams yet."),
            /*#__PURE__*/React.createElement("p", { style: { fontSize: 11, marginTop: 4 } }, "Teams you join will appear here.")
          )
        : (myTeams || []).slice(0, 5).map(team =>
            /*#__PURE__*/React.createElement("div", {
              key: team.roomId,
              className: "pd-team-card",
              onClick: () => onNavigate('providers')
            },
              /*#__PURE__*/React.createElement("div", { className: "pd-team-dot", style: { background: `hsl(${team.color_hue || 260},60%,55%)` } }),
              /*#__PURE__*/React.createElement("div", { style: { flex: 1, minWidth: 0 } },
                /*#__PURE__*/React.createElement("div", { className: "pd-team-name" }, team.name || 'Unnamed Team'),
                team.members && /*#__PURE__*/React.createElement("div", { className: "pd-team-meta" },
                  team.members.length, " member", team.members.length !== 1 ? 's' : ''
                )
              ),
              /*#__PURE__*/React.createElement("span", { style: { color: `hsl(${team.color_hue || 260},60%,55%)`, opacity: 0.6 } },
                /*#__PURE__*/React.createElement(I, { n: "users", s: 12 })
              )
            )
          )
    )
  ),
  /* ── Recent Messages ── */
  /*#__PURE__*/React.createElement("div", { className: "pd-section" },
    /*#__PURE__*/React.createElement("div", { className: "pd-section-hdr" },
      /*#__PURE__*/React.createElement("h3", null, /*#__PURE__*/React.createElement(I, { n: "msg", s: 16, c: "var(--blue)" }), " Recent Messages"),
      /*#__PURE__*/React.createElement("button", { onClick: () => onNavigate('inbox'), className: "b-gho b-xs" }, "Open Messages")
    ),
    recentMessages.length === 0
      ? /*#__PURE__*/React.createElement("div", { className: "pd-empty" },
          /*#__PURE__*/React.createElement(I, { n: "msg", s: 28, c: "var(--tx-3)" }),
          /*#__PURE__*/React.createElement("p", { style: { marginTop: 8, fontSize: 12 } }, "No messages yet."),
          /*#__PURE__*/React.createElement("p", { style: { fontSize: 11, marginTop: 4 } }, "Messages from your providers will appear here.")
        )
      : /*#__PURE__*/React.createElement("div", { style: { display: 'flex', flexDirection: 'column', gap: 6 } },
          recentMessages.map(evt =>
            /*#__PURE__*/React.createElement("div", {
              key: evt.id,
              className: "pd-msg-row",
              onClick: () => onNavigate('inbox')
            },
              /*#__PURE__*/React.createElement("div", { className: "pd-event-icon", style: { background: evt.iconBg, color: evt.iconColor } },
                /*#__PURE__*/React.createElement(I, { n: "msg", s: 14 })
              ),
              /*#__PURE__*/React.createElement("div", { style: { flex: 1, minWidth: 0 } },
                /*#__PURE__*/React.createElement("div", { className: "pd-msg-sender" }, evt.provName || 'Provider'),
                /*#__PURE__*/React.createElement("div", { className: "pd-msg-preview" }, evt.desc),
                /*#__PURE__*/React.createElement("div", { className: "pd-msg-time" }, pdTimeAgo(evt.ts))
              ),
              evt.tags && evt.tags.map((t, ti) =>
                /*#__PURE__*/React.createElement("span", { key: ti, className: `tag ${t.cls}`, style: { fontSize: 8, alignSelf: 'center' } }, t.label)
              )
            )
          )
        )
  ),
  /*#__PURE__*/React.createElement("div", {
    className: "pd-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "pd-section-hdr"
  }, /*#__PURE__*/React.createElement("h3", null, /*#__PURE__*/React.createElement(I, {
    n: "msg",
    s: 16,
    c: "var(--purple)"
  }), " Content About Me"), totalNotes > 3 && /*#__PURE__*/React.createElement("button", {
    onClick: () => onNavigate('inbox'),
    className: "b-gho b-xs"
  }, "View All")), providerNotes.length === 0 && observations.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "pd-empty"
  }, /*#__PURE__*/React.createElement(I, {
    n: "clipboard",
    s: 28,
    c: "var(--tx-3)"
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      marginTop: 8,
      fontSize: 12
    }
  }, "No content about you yet."), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      marginTop: 4
    }
  }, "When providers add notes, observations, or assessments, they will appear here.")) : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 8
    }
  }, providerNotes.slice(0, 5).map(note => /*#__PURE__*/React.createElement("div", {
    key: note.id,
    className: "pd-content-card"
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'flex-start',
      justifyContent: 'space-between',
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 28,
      height: 28,
      borderRadius: '50%',
      background: 'var(--purple-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--purple)',
      flexShrink: 0
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "msg",
    s: 13
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 600
    }
  }, note.title), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginTop: 1
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      fontFamily: 'var(--mono)'
    }
  }, note.provName), note.orgName && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-blue",
    style: {
      fontSize: 7.5,
      padding: '1px 5px'
    }
  }, note.orgName)))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tag tag-purple",
    style: {
      fontSize: 8
    }
  }, "NOTE"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)'
    }
  }, pdTimeAgo(note.ts)))), note.content && /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.5,
      overflow: 'hidden',
      display: '-webkit-box',
      WebkitLineClamp: 2,
      WebkitBoxOrient: 'vertical'
    }
  }, note.content), note.tags && note.tags.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 3,
      marginTop: 6,
      flexWrap: 'wrap'
    }
  }, note.tags.map((t, ti) => /*#__PURE__*/React.createElement("span", {
    key: ti,
    className: "note-tag-chip"
  }, t.displayName || t))))), observations.slice(-3).reverse().map((obs, i) => {
    const prompt = DEFAULT_PROMPTS.find(p => p.key === obs.category);
    const optLabel = prompt?.options.find(o => o.v === obs.value)?.l || obs.value;
    return /*#__PURE__*/React.createElement("div", {
      key: obs.id || `obs-${i}`,
      className: "pd-content-card"
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        width: 28,
        height: 28,
        borderRadius: '50%',
        background: 'var(--blue-dim)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: 'var(--blue)',
        flexShrink: 0
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "clipboard",
      s: 13
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        fontWeight: 600
      }
    }, prompt?.question || obs.category), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        color: 'var(--tx-1)',
        display: 'block',
        marginTop: 1
      }
    }, optLabel))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: "tag tag-teal",
      style: {
        fontSize: 8
      }
    }, "GIVEN"), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, obs.date || ''))));
  }))), /*#__PURE__*/React.createElement("div", {
    className: "pd-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "pd-section-hdr"
  }, /*#__PURE__*/React.createElement("h3", null, /*#__PURE__*/React.createElement(I, {
    n: "layers",
    s: 16,
    c: "var(--green)"
  }), " Resources Shared With Me"), myResources.length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => onNavigate('resources'),
    className: "b-gho b-xs"
  }, "View All (", myResources.length, ")")), myResources.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "pd-empty"
  }, /*#__PURE__*/React.createElement(I, {
    n: "layers",
    s: 28,
    c: "var(--tx-3)"
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      marginTop: 8,
      fontSize: 12
    }
  }, "No resources allocated yet."), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      marginTop: 4
    }
  }, "When providers allocate vouchers, services, or other resources, they will appear here.")) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(120px,1fr))',
      gap: 8,
      marginBottom: 12
    }
  }, [{
    l: 'Active',
    v: myResources.filter(r => r.status === 'active').length,
    c: 'green'
  }, {
    l: 'Used',
    v: myResources.filter(r => r.status === 'consumed').length,
    c: 'blue'
  }, {
    l: 'Expired',
    v: myResources.filter(r => r.status === 'expired').length,
    c: 'orange'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: '10px 12px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0
    }
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 16,
      fontWeight: 700,
      color: `var(--${s.c})`,
      display: 'block',
      marginTop: 2
    }
  }, s.v)))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 6
    }
  }, myResources.slice(0, 5).map((alloc, i) => {
    const statusColors = {
      active: 'teal',
      consumed: 'blue',
      expired: 'orange',
      revoked: 'red'
    };
    return /*#__PURE__*/React.createElement("div", {
      key: alloc.allocation_id || i,
      className: "pd-res-card"
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 10
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        width: 28,
        height: 28,
        borderRadius: '50%',
        background: 'var(--green-dim)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: 'var(--green)',
        flexShrink: 0
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "layers",
      s: 13
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        fontWeight: 600
      }
    }, alloc.resource_name || alloc.resource_type_id), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginTop: 2
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)'
      }
    }, "x", alloc.quantity, " ", alloc.unit || ''), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, alloc.org_display_name || alloc.provider_display_name || '')))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${statusColors[alloc.status] || 'teal'}`,
      style: {
        fontSize: 8.5
      }
    }, (alloc.status || 'active').toUpperCase()), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, alloc.allocated_at ? pdTimeAgo(alloc.allocated_at) : '')));
  })))), /*#__PURE__*/React.createElement("div", {
    className: "pd-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "pd-section-hdr"
  }, /*#__PURE__*/React.createElement("h3", null, /*#__PURE__*/React.createElement(I, {
    n: "bell",
    s: 16,
    c: "var(--orange)"
  }), " Activity Feed"), /*#__PURE__*/React.createElement("button", {
    onClick: loadBridgeActivity,
    className: "b-gho b-xs",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "refresh-cw",
    s: 11
  }), "Refresh")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4,
      marginBottom: 14,
      flexWrap: 'wrap'
    }
  }, [{
    id: 'all',
    label: 'All'
  }, {
    id: 'notes',
    label: 'Notes'
  }, {
    id: 'resources',
    label: 'Resources'
  }, {
    id: 'messages',
    label: 'Messages'
  }, {
    id: 'fields',
    label: 'Field Updates'
  }, {
    id: 'observations',
    label: 'Observations'
  }].map(f => /*#__PURE__*/React.createElement("button", {
    key: f.id,
    onClick: () => setEventFilter(f.id),
    style: {
      padding: '5px 12px',
      borderRadius: 14,
      fontSize: 11,
      fontWeight: 600,
      cursor: 'pointer',
      border: '1px solid',
      transition: 'all .15s',
      fontFamily: 'var(--sans)',
      background: eventFilter === f.id ? 'var(--gold-dim)' : 'transparent',
      color: eventFilter === f.id ? 'var(--gold)' : 'var(--tx-2)',
      borderColor: eventFilter === f.id ? 'var(--gold)' : 'var(--border-1)'
    }
  }, f.label, eventFilter === f.id && filteredEvents.length > 0 ? ` (${filteredEvents.length})` : ''))), filteredEvents.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "pd-empty"
  }, /*#__PURE__*/React.createElement(I, {
    n: "bell",
    s: 28,
    c: "var(--tx-3)"
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      marginTop: 8,
      fontSize: 12
    }
  }, "No activity yet", eventFilter !== 'all' ? ' in this category' : '', "."), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      marginTop: 4
    }
  }, "Updates from your providers will stream here in real time.")) : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 6
    }
  }, filteredEvents.slice(0, eventLimit).map(evt => /*#__PURE__*/React.createElement("div", {
    key: evt.id,
    className: "pd-event"
  }, /*#__PURE__*/React.createElement("div", {
    className: "pd-event-icon",
    style: {
      background: evt.iconBg,
      color: evt.iconColor
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: evt.icon,
    s: 14
  })), /*#__PURE__*/React.createElement("div", {
    className: "pd-event-body"
  }, /*#__PURE__*/React.createElement("div", {
    className: "pd-event-title"
  }, evt.title), /*#__PURE__*/React.createElement("div", {
    className: "pd-event-desc"
  }, evt.desc), /*#__PURE__*/React.createElement("div", {
    className: "pd-event-meta"
  }, evt.tags?.map((t, ti) => /*#__PURE__*/React.createElement("span", {
    key: ti,
    className: `tag ${t.cls}`,
    style: {
      fontSize: 8,
      padding: '1px 6px'
    }
  }, t.label)), evt.orgName && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-blue",
    style: {
      fontSize: 7.5,
      padding: '1px 5px'
    }
  }, evt.orgName), /*#__PURE__*/React.createElement("span", {
    className: "pd-event-time"
  }, pdTimeAgo(evt.ts)))))), filteredEvents.length > eventLimit && /*#__PURE__*/React.createElement("button", {
    onClick: () => setEventLimit(l => l + 25),
    className: "b-gho b-sm",
    style: {
      alignSelf: 'center',
      marginTop: 8
    }
  }, "Load more (", filteredEvents.length - eventLimit, " remaining)"))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '14px 18px',
      display: 'flex',
      gap: 10,
      alignItems: 'flex-start',
      marginTop: 8
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 16,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--teal)'
    }
  }, "Your data, your control."), " All content shown here is encrypted in your vault and bridge rooms. You control which providers see what, and can revoke access at any time.")));
};

/* ═══════════════════ CLIENT APP ═══════════════════ */
const ClientApp = ({
  session,
  onLogout,
  showToast,
  availableContexts,
  activeContext,
  onSwitchContext
}) => {
  const [vaultRoom, setVaultRoom] = useState(null);
  const [schemaRoom, setSchemaRoom] = useState(null);
  const [vaultData, setVaultData] = useState({});
  const [observations, setObservations] = useState([]);
  const [metricsConsent, setMetricsConsent] = useState({
    enabled: false,
    categories: []
  });
  const [providers, setProviders] = useState([]);
  const [view, setView] = useState('dashboard');
  const [activeBridge, setActiveBridge] = useState(null);
  const [loading, setLoading] = useState(true);
  const [editModal, setEditModal] = useState(false);
  const [editData, setEditData] = useState({});
  const [addProviderModal, setAddProviderModal] = useState(false);
  const [newProviderId, setNewProviderId] = useState('');
  const [bridgeMessages, setBridgeMessages] = useState([]);
  const [msgText, setMsgText] = useState('');
  // Inbox chat state
  const [inboxConvo, setInboxConvo] = useState(null); // provider index for active inbox conversation
  const [inboxMessages, setInboxMessages] = useState([]);
  const [inboxMsgText, setInboxMsgText] = useState('');
  const [inboxTab, setInboxTab] = useState('providers'); // 'providers' | 'team'
  // ─── Team member DM state (client-side) ───
  const [clientTeamDMs, setClientTeamDMs] = useState([]); // [{roomId, peerId, peerName, teamName, peerType}]
  const [newTeamDMModal, setNewTeamDMModal] = useState(false);
  const [newDMTarget, setNewDMTarget] = useState(null);
  const [hardRevokeTarget, setHardRevokeTarget] = useState(null);
  const [obsModal, setObsModal] = useState(null); // prompt object or null
  const [obsValue, setObsValue] = useState('');
  const [obsDate, setObsDate] = useState(new Date().toISOString().slice(0, 10));
  const [obsFreeText, setObsFreeText] = useState('');
  const [provenanceTarget, setProvenanceTarget] = useState(null); // {entityKey, label, roomId} or null — toggles inline provenance panel
  const [initError, setInitError] = useState(null);
  const [claimedRooms, setClaimedRooms] = useState([]);
  const [pendingClaims, setPendingClaims] = useState([]);
  const [customFieldDefs, setCustomFieldDefs] = useState([]); // [{key,label,category,sensitive}]
  const [addFieldModal, setAddFieldModal] = useState(false);
  const [newFieldLabel, setNewFieldLabel] = useState('');
  const [newFieldCategory, setNewFieldCategory] = useState('details');
  const [newFieldSensitive, setNewFieldSensitive] = useState(false);
  const [newFieldDefinition, setNewFieldDefinition] = useState('');
  const [enabledFrameworks, setEnabledFrameworks] = useState([]); // framework ids toggled on
  const [frameworkModal, setFrameworkModal] = useState(false);
  const [myTeams, setMyTeams] = useState([]);
  const [clientSharingConsentModal, setClientSharingConsentModal] = useState(null); // {team} — prompts client team member to choose sharing preference
  const [myResources, setMyResources] = useState([]); // resource vault records from bridges
  const isMobile = useIsMobile();
  // Contact sharing state
  const [shareContactModal, setShareContactModal] = useState(false);
  const [copiedField, setCopiedField] = useState(null);

  useEffect(() => {
    initVault();
  }, []);

  // Framework-derived fields from enabled standards
  const frameworkFields = useMemo(() => getFrameworkFields(enabledFrameworks), [enabledFrameworks]);

  // Merge built-in fields + custom fields + framework fields
  const allFields = useMemo(() => [...VAULT_FIELDS, ...customFieldDefs, ...frameworkFields], [customFieldDefs, frameworkFields]);
  const allCategories = useMemo(() => {
    const cats = [...FIELD_CATEGORIES];
    for (const f of [...customFieldDefs, ...frameworkFields]) {
      if (!cats.includes(f.category)) cats.push(f.category);
    }
    return cats;
  }, [customFieldDefs, frameworkFields]);

  // ─── Contact sharing helpers ───
  const getContactText = () => {
    const lines = [];
    if (vaultData.full_name) lines.push(vaultData.full_name);
    if (vaultData.email) lines.push(vaultData.email);
    if (vaultData.phone) lines.push(vaultData.phone);
    lines.push('');
    lines.push('Khora ID: ' + svc.userId);
    return lines.join('\n');
  };
  const copyContact = async () => {
    try {
      await navigator.clipboard.writeText(getContactText());
      setCopiedField('contact');
      setTimeout(() => setCopiedField(null), 2000);
    } catch { showToast('Copy failed — please select and copy manually', 'warn'); }
  };
  const shareContactViaEmail = () => {
    const subject = encodeURIComponent('My contact details');
    const body = encodeURIComponent(getContactText());
    window.open('mailto:?subject=' + subject + '&body=' + body, '_self');
  };
  const shareContactViaSMS = () => {
    const body = encodeURIComponent(getContactText());
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    window.open('sms:' + (isIOS ? '&' : '?') + 'body=' + body, '_self');
  };

  // INS(vault.custom_field_def, {user_defined}) — schema_extension — client creates custom vault field
  const handleAddCustomField = async () => {
    const label = newFieldLabel.trim();
    const definition = newFieldDefinition.trim();
    if (!label) return;
    if (definition.length < 20) {
      showToast('Definition must be at least 20 characters', 'error');
      return;
    }
    const key = 'custom_' + label.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
    if (allFields.some(f => f.key === key)) {
      showToast('A field with that name already exists', 'error');
      return;
    }
    const def = {
      key,
      label,
      category: newFieldCategory,
      sensitive: newFieldSensitive,
      custom: true,
      definition
    };
    const updated = [...customFieldDefs, def];
    await emitOp(vaultRoom, 'INS', dot('vault', 'custom_field_def', key), {
      label,
      category: newFieldCategory,
      sensitive: newFieldSensitive,
      definition
    }, vaultFrame());
    await saveSnapshot(undefined, undefined, undefined, updated);
    setAddFieldModal(false);
    setNewFieldLabel('');
    setNewFieldCategory('details');
    setNewFieldSensitive(false);
    setNewFieldDefinition('');
    showToast(`Custom field "${label}" created`, 'success');
  };

  // NUL(vault.custom_field, {reason: client_deleted}) — schema_retraction — removes field definition and data
  const handleDeleteCustomField = async fieldKey => {
    const updated = customFieldDefs.filter(f => f.key !== fieldKey);
    const updatedData = {
      ...vaultData
    };
    delete updatedData[fieldKey];
    await emitOp(vaultRoom, 'NUL', dot('vault', 'custom_field_def', fieldKey), {
      reason: 'client_deleted'
    }, vaultFrame());
    await saveSnapshot(updatedData, undefined, undefined, updated);
    showToast('Custom field removed', 'warn');
  };
  const vaultFrame = room => ({
    type: 'vault',
    room: room || vaultRoom,
    role: 'client',
    epistemic: 'GIVEN'
  });
  const bridgeFrame = room => ({
    type: 'bridge',
    room,
    role: 'client',
    epistemic: 'MEANT'
  });

  // INS(vault.room, {identity, snapshot, schema}) — sovereign_creation — creates the client's entire data sovereignty container
  // Operator Manifest for initVault:
  //   INS(vault.room, {identity, snapshot}) — sovereign_creation — if no vault exists
  //   DES(vault.schema_catalog, {forms, definitions}) — canonical_vocabulary — seeds personal schema
  //   CON(vault.auto_join, {invited_rooms}) — client_record_claim — joins pending invites
  //   No REC — vault frame is client-sovereign and stable.
  const initVault = async () => {
    setLoading(true);
    setInitError(null);
    try {
      // Phase 1: Auto-join any invited client_record rooms so they appear in scanRooms.
      // Safety: only join rooms that were explicitly created for this user (client_matrix_id match)
      // AND have a valid owner set. Rooms are shown as "pending" until the client manually claims them.
      try {
        const invited = await svc.scanInvitedRooms([EVT.IDENTITY]);
        for (const [rid, state] of Object.entries(invited)) {
          const id = state[EVT.IDENTITY];
          if (id?.account_type === 'client_record' && id.client_matrix_id === svc.userId && id.owner) {
            try {
              await svc.joinRoom(rid);
            } catch (e) {
              console.warn('Auto-join failed for', rid, e.message);
            }
          }
        }
      } catch (e) {
        console.warn('Invited room scan failed:', e.message);
      }

      // Phase 2: Scan joined rooms (now includes any rooms we just auto-joined)
      const scanned = await svc.scanRooms([EVT.PROVIDER_PROFILE, EVT.TEAM_META, EVT.TEAM_MEMBERS, EVT.FIELD_DEF, EVT.DM_META]);
      let vault = null,
        schema = null;
      const detectedPending = [],
        detectedClaimed = [];
      const bridgeProfiles = {}; // bridgeRoomId → provider profile
      const detectedTeams = [];
      for (const [rid, state] of Object.entries(scanned)) {
        const id = state[EVT.IDENTITY];
        if (id?.account_type === 'client' && id.owner === svc.userId) vault = rid;
        if (id?.account_type === 'schema' && id.owner === svc.userId) schema = rid;
        // Detect client_record rooms where this client was invited or has claimed
        if (id?.account_type === 'client_record' && id.client_matrix_id === svc.userId) {
          if (id.status === 'claimed' && id.owner === svc.userId) {
            detectedClaimed.push({
              roomId: rid,
              ...id
            });
          } else {
            detectedPending.push({
              roomId: rid,
              ...id
            });
          }
        }
        // Detect team rooms the individual belongs to
        if (id?.account_type === 'team') {
          const teamMeta = state[EVT.TEAM_META] || {};
          const teamMembers = state[EVT.TEAM_MEMBERS] || {
            members: []
          };
          detectedTeams.push({
            roomId: rid,
            ...teamMeta,
            members: teamMembers.members || []
          });
        }
        // Collect provider profiles and bridge metadata from bridge rooms
        const bridgeMeta = state[EVT.BRIDGE_META];
        const provProfile = state[EVT.PROVIDER_PROFILE];
        if (bridgeMeta && bridgeMeta.client === svc.userId) {
          if (provProfile) bridgeProfiles[rid] = provProfile;
          // Track transferable and org_id from bridge meta
          bridgeProfiles[rid] = {
            ...(bridgeProfiles[rid] || {}),
            _bridgeMeta: bridgeMeta
          };
        }
      }
      if (!vault) {
        vault = await svc.createRoom('[Khora Vault]', 'Personal data vault', [{
          type: EVT.IDENTITY,
          state_key: '',
          content: {
            account_type: 'client',
            owner: svc.userId,
            created: Date.now(),
            created_by: svc.userId,
            origin_server: extractHomeserver(svc.userId)
          }
        }, {
          type: EVT.VAULT_SNAPSHOT,
          state_key: '',
          content: {
            fields: {},
            observations: [],
            metrics_consent: {
              enabled: false,
              categories: []
            },
            matching_consent: {
              enabled: false,
              layers: [],
              network_id: null,
              last_token_ts: null
            },
            custom_field_defs: [],
            enabled_frameworks: [],
            created_by: svc.userId,
            origin_server: extractHomeserver(svc.userId),
            last_modified_by: svc.userId,
            last_modified_at: Date.now()
          }
        }, {
          type: EVT.VAULT_PROVIDERS,
          state_key: '',
          content: {
            providers: []
          }
        }]);
        showToast('Vault created — encrypted room ready', 'success');
      }
      if (!schema) {
        schema = await svc.createRoom('[Khora Schema]', 'Schema definitions', [{
          type: EVT.IDENTITY,
          state_key: '',
          content: {
            account_type: 'schema',
            owner: svc.userId,
            created: Date.now()
          }
        }]);
        const allSeeds = [
        // Forms — GIVEN data collection instruments
        ...DEFAULT_FORMS.map(f => () => svc.setState(schema, EVT.SCHEMA_FORM, f, f.id)), ...DEFAULT_PROMPTS.map(p => () => svc.setState(schema, EVT.SCHEMA_PROMPT, p, p.key)),
        // Interpretations — MEANT frameworks
        ...DEFAULT_DEFINITIONS.map(d => () => svc.setState(schema, EVT.SCHEMA_DEF, d, d.key)), ...DEFAULT_AUTHORITIES.map(a => () => svc.setState(schema, EVT.SCHEMA_AUTHORITY, a, a.id)), [() => svc.setState(schema, EVT.SCHEMA_TRANSFORM, {
          id: 'transform_default',
          transforms: DEFAULT_TRANSFORMS
        }, 'default')]].flat();
        for (let i = 0; i < allSeeds.length; i++) {
          await allSeeds[i]();
          if (i % 3 === 2) await new Promise(r => setTimeout(r, 200));
        }
      }
      setVaultRoom(vault);
      setSchemaRoom(schema);
      await loadVault(vault, bridgeProfiles);
      setPendingClaims(detectedPending);
      setClaimedRooms(detectedClaimed);
      if (detectedTeams.length > 0) setMyTeams(detectedTeams.map((t, i) => ({
        ...t,
        color_hue: getLocalTeamColor(svc.userId, t.roomId, t.color_hue != null ? t.color_hue : distinctTeamHue(i))
      })));
      // Detect existing DM rooms (client side)
      const detectedClientDMs = [];
      for (const [rid, state] of Object.entries(scanned)) {
        const dmMeta = state[EVT.DM_META];
        if (dmMeta && (dmMeta.initiator === svc.userId || dmMeta.target === svc.userId)) {
          const peerId = dmMeta.initiator === svc.userId ? dmMeta.target : dmMeta.initiator;
          detectedClientDMs.push({
            roomId: rid,
            peerId,
            peerName: dmMeta.peer_names?.[peerId] || peerId,
            teamName: dmMeta.team_name || null,
            teamRoomId: dmMeta.team_room_id || null,
            peerType: dmMeta.peer_type || 'provider'
          });
        }
      }
      if (detectedClientDMs.length > 0) setClientTeamDMs(detectedClientDMs);
    } catch (e) {
      console.error('Vault init failed:', e);
      setInitError(e.message || 'Failed to initialize vault.');
    }
    setLoading(false);
  };
  const loadVault = async (rid, bridgeProfiles) => {
    const snap = await svc.getState(rid, EVT.VAULT_SNAPSHOT);
    setVaultData(snap?.fields || {});
    setObservations(snap?.observations || []);
    setMetricsConsent(snap?.metrics_consent || {
      enabled: false,
      categories: []
    });
    setCustomFieldDefs(snap?.custom_field_defs || []);
    setEnabledFrameworks(snap?.enabled_frameworks || []);
    const idx = await svc.getState(rid, EVT.VAULT_PROVIDERS);
    // Enrich providers with profile data and bridge meta from bridge rooms
    const enrichedProviders = (idx?.providers || []).map(p => {
      const profile = bridgeProfiles?.[p.bridgeRoomId];
      if (!profile) return p;
      const bm = profile._bridgeMeta;
      const clean = {
        ...profile
      };
      delete clean._bridgeMeta;
      return {
        ...p,
        providerProfile: clean.display_name ? clean : p.providerProfile,
        providerName: clean.display_name || p.providerName,
        transferable: bm?.transferable !== false ? true : false,
        org_id: bm?.org_id || p.org_id || null,
        assigned_staff: bm?.assigned_staff || [p.providerUserId]
      };
    });
    setProviders(enrichedProviders);
    // Load resource records from vault and bridge rooms
    const resources = [];
    if (svc.client) {
      // Load from vault shadow records
      const vRoom = svc.client.getRoom(rid);
      if (vRoom) {
        const vaultResEvents = vRoom.currentState.getStateEvents(EVT.RESOURCE_VAULT);
        if (vaultResEvents) {
          const evArr = Array.isArray(vaultResEvents) ? vaultResEvents : [vaultResEvents];
          for (const ev of evArr) {
            const c = ev.getContent ? ev.getContent() : ev;
            if (c && c.allocation_id) resources.push(c);
          }
        }
      }
      // Also load from bridge rooms directly (bridge is source of truth)
      for (const p of enrichedProviders) {
        const bRoom = svc.client.getRoom(p.bridgeRoomId);
        if (!bRoom) continue;
        const allocEvents = bRoom.currentState.getStateEvents(EVT.RESOURCE_ALLOC);
        if (!allocEvents) continue;
        const evArr = Array.isArray(allocEvents) ? allocEvents : [allocEvents];
        for (const ev of evArr) {
          const c = ev.getContent ? ev.getContent() : ev;
          if (c && c.id && !resources.find(r => r.allocation_id === c.id)) {
            resources.push({
              allocation_id: c.id,
              resource_type_id: c.resource_type_id,
              resource_name: c.resource_type_id,
              // will be overridden by vault shadow if available
              quantity: c.quantity,
              unit: c.unit,
              provider_display_name: c.allocated_by,
              org_display_name: c.org_id || '',
              allocated_at: c.allocated_at,
              status: c.status,
              notes: c.notes,
              bridge_room_id: p.bridgeRoomId,
              _provider_name: p.providerName || p.providerUserId
            });
          }
        }
      }
    }
    setMyResources(resources);
  };

  // ALT(vault.snapshot, {updated_fields}) — atomic_persistence — single state write for all vault data
  const saveSnapshot = async (fields, obs, mc, cfd, ef) => {
    const snapshot = {
      fields: fields ?? vaultData,
      observations: obs ?? observations,
      metrics_consent: mc ?? metricsConsent,
      custom_field_defs: cfd ?? customFieldDefs,
      enabled_frameworks: ef ?? enabledFrameworks,
      last_modified_by: svc.userId,
      last_modified_at: Date.now(),
      origin_server: extractHomeserver(svc.userId)
    };
    await svc.setState(vaultRoom, EVT.VAULT_SNAPSHOT, snapshot);
    setVaultData(snapshot.fields);
    setObservations(snapshot.observations);
    setMetricsConsent(snapshot.metrics_consent);
    setCustomFieldDefs(snapshot.custom_field_defs);
    setEnabledFrameworks(snapshot.enabled_frameworks);
  };
  const saveProviderIndex = async provs => {
    await svc.setState(vaultRoom, EVT.VAULT_PROVIDERS, {
      providers: provs
    });
    setProviders(provs);
  };

  // Edit identity fields — emits INS, ALT, or NUL per field depending on change type
  // INS(vault.field.value, {source: client_input}) — vault_population — new field
  // ALT(vault.field.value, {from: old, to: new}) — vault_update — changed field
  // NUL(vault.field.value, {reason: client_cleared}) — vault_clearance — cleared field
  const handleEditSave = async () => {
    const updated = {
      ...vaultData,
      ...editData
    };
    for (const [key, val] of Object.entries(editData)) {
      if (val && !vaultData[key]) {
        // INS — field first populated
        await emitOp(vaultRoom, 'INS', dot('vault', 'fields', key), {
          value: val,
          source: 'client_input'
        }, vaultFrame());
      } else if (val && vaultData[key] && val !== vaultData[key]) {
        // ALT — value change within stable frame
        await emitOp(vaultRoom, 'ALT', dot('vault', 'client_profile', key), {
          from: vaultData[key],
          to: val,
          source: 'client_input'
        }, vaultFrame());
      } else if (!val && vaultData[key]) {
        // NUL — existence removal
        await emitOp(vaultRoom, 'NUL', dot('vault', 'client_profile', key), {
          reason: 'client_cleared',
          previous_value: vaultData[key]
        }, vaultFrame());
      }
    }
    await saveSnapshot(updated);
    setEditModal(false);
    showToast('Vault updated', 'success');
    // Propagate to bridges (§8.3)
    for (const prov of providers) {
      const changedShared = Object.keys(editData).filter(k => prov.sharedFields?.[k]);
      if (changedShared.length > 0) await syncFieldsToBridge(prov.bridgeRoomId, prov.sharedFields, updated);
    }
  };

  // INS(vault.observation, {source: client_report}) — GIVEN_attestation — this is the GIVEN entry point
  // If metrics consent enabled: → SYN(metrics.observation+anon_demographics, {via: cohort_hash}) — metric_emission
  const handleRecordObservation = async () => {
    if (!obsValue || !obsModal) return;
    const obs = {
      id: genOpId(),
      category: obsModal.key,
      value: obsValue,
      date: obsDate,
      prompt_id: obsModal.id,
      schema_version: obsModal.version || 1,
      free_text: obsFreeText || undefined,
      ts: Date.now(),
      created_by: svc.userId,
      origin_server: extractHomeserver(svc.userId)
    };
    await emitOp(vaultRoom, 'INS', dot('vault', 'observations', obsModal.key), {
      value: obsValue,
      date: obsDate,
      reported_by: 'client',
      method: 'self_report',
      prompt: obsModal.question,
      free_text: obsFreeText || undefined
    }, vaultFrame());
    const newObs = [...observations, obs];
    await saveSnapshot(undefined, newObs);
    setObsModal(null);
    setObsValue('');
    setObsFreeText('');
    showToast(`Observation recorded: ${obsModal.question}`, 'success');
    // Emit to metrics if consent
    if (metricsConsent.enabled && obsModal.metrics && metricsConsent.categories?.includes(obsModal.category)) {
      for (const prov of providers) {
        if (prov.metricsRoom) {
          await emitMetric(prov.metricsRoom, svc.userId, {
            category: obsModal.key,
            value: obsValue,
            date_bucket: `${obsDate.slice(0, 7)}`
          }, vaultData);
        }
      }
    }
  };

  // CON(vault.providers.{id}, {bridge_room, initiated_by: client}) — relationship_establishment + INS(bridge.room, {e2ee, meta, refs}) — secure_channel
  const handleAddProvider = async () => {
    if (!newProviderId.trim()) return;
    if (!isValidMatrixId(newProviderId)) {
      showToast('Invalid Matrix ID — use format @user:server', 'error');
      return;
    }
    if (providers.find(p => p.providerUserId === newProviderId.trim())) {
      showToast('Already connected to this provider', 'info');
      return;
    }
    try {
      const bridgeId = await svc.createRoom(`[Khora Bridge] ${svc.userId} ↔ ${newProviderId}`, 'Khora bridge — shared data room', [{
        type: EVT.BRIDGE_META,
        state_key: '',
        content: {
          client: svc.userId,
          provider: newProviderId,
          relationship_type: RELATIONSHIP_TYPES.client_provider.id,
          created: Date.now(),
          status: 'active',
          transferable: true,
          org_id: null,
          assigned_staff: [newProviderId],
          created_by: svc.userId,
          origin_server: extractHomeserver(svc.userId)
        }
      }, {
        type: EVT.BRIDGE_REFS,
        state_key: '',
        content: {
          fields: {}
        }
      }]);
      await svc.invite(bridgeId, newProviderId);
      await emitOp(vaultRoom, 'CON', dot('vault', 'providers', newProviderId), {
        relationship: RELATIONSHIP_TYPES.client_provider.id,
        bridge_room: bridgeId,
        initiated_by: 'client'
      }, vaultFrame());
      const newProv = {
        bridgeRoomId: bridgeId,
        providerUserId: newProviderId,
        sharedFields: {},
        providerName: newProviderId,
        transferable: true
      };
      await saveProviderIndex([...providers, newProv]);
      setAddProviderModal(false);
      setNewProviderId('');
      showToast(`Bridge created — invite sent to ${newProviderId}`, 'success');
    } catch (e) {
      showToast('Failed: ' + e.message, 'error');
    }
  };

  // ALT(bridge.refs, {re_encrypted_fields}) — selective_sync — encrypts shared fields with fresh keys
  const syncFieldsToBridge = async (bridgeRoomId, sharedFields, data) => {
    const refs = {};
    for (const [fk, shared] of Object.entries(sharedFields)) {
      if (shared && data[fk]) {
        const keyB64 = await FieldCrypto.generateKey();
        const enc = await FieldCrypto.encrypt(data[fk], keyB64);
        refs[fk] = {
          ...enc,
          key: keyB64
        };
      }
    }
    await svc.setState(bridgeRoomId, EVT.BRIDGE_REFS, {
      fields: refs,
      updated: Date.now()
    });
  };

  // SEG(bridge.field_visibility, {state: shared|revoked}) — access_partitioning — key rotation on each toggle
  const handleToggleField = async (pi, fk) => {
    const prov = providers[pi];
    const newShared = {
      ...prov.sharedFields,
      [fk]: !prov.sharedFields[fk]
    };
    const ups = [...providers];
    ups[pi] = {
      ...prov,
      sharedFields: newShared
    };
    await saveProviderIndex(ups);
    await emitOp(prov.bridgeRoomId, 'SEG', dot('bridge', 'fields', fk), {
      visibility: newShared[fk] ? 'shared' : 'revoked',
      provider: prov.providerUserId
    }, bridgeFrame(prov.bridgeRoomId), newShared[fk] ? [] : [`prev_seg_${fk}`]);
    await syncFieldsToBridge(prov.bridgeRoomId, newShared, vaultData);
    const label = allFields.find(f => f.key === fk)?.label || fk;
    showToast(newShared[fk] ? `Shared ${label} — new key issued` : `Revoked ${label} — key destroyed`, newShared[fk] ? 'success' : 'warn');
  };

  // ALT(bridge.transferable, {boolean_flip}) — transferability_policy
  // Toggle whether this client allows their case to be transferred between providers within the org
  const handleToggleTransferable = async pi => {
    const prov = providers[pi];
    const newVal = !prov.transferable;
    try {
      // Update bridge meta (client has PL 100 — full control)
      const currentMeta = await svc.getState(prov.bridgeRoomId, EVT.BRIDGE_META);
      await svc.setState(prov.bridgeRoomId, EVT.BRIDGE_META, {
        ...currentMeta,
        transferable: newVal
      });
      await emitOp(prov.bridgeRoomId, 'ALT', dot('bridge', 'transferable'), {
        value: newVal,
        reason: newVal ? 'client_enabled_transfer' : 'client_disabled_transfer'
      }, bridgeFrame(prov.bridgeRoomId));
      // Update local provider index
      const ups = [...providers];
      ups[pi] = {
        ...prov,
        transferable: newVal
      };
      await saveProviderIndex(ups);
      showToast(newVal ? 'Provider transfer allowed — org can reassign your case' : 'Provider transfer blocked — only this provider can access your bridge', newVal ? 'success' : 'warn');
    } catch (e) {
      showToast('Failed to update transfer setting: ' + e.message, 'error');
    }
  };

  // ⚠️ HIGHEST-RISK VAULT OPERATION: NUL(bridge.old, {}) → INS(bridge.new, {}) → CON(bridge.connection, {})
  // NUL(bridge.old, {reason: hard_revoke}) — relationship_destruction — tombstone old room
  // INS(bridge.new, {fresh_keys}) — clean_room — create replacement
  // CON(bridge.connection, {new_bridge, initiated_by: client}) — relationship_re_establishment — re-link
  // All old keys destroyed. All shared data re-encrypted with new keys.
  const handleHardRevoke = async pi => {
    const prov = providers[pi];
    try {
      // Step 1: Seal old bridge — emit NUL, tombstone, and kick provider BEFORE creating new bridge
      await emitOp(prov.bridgeRoomId, 'NUL', dot('bridge', 'relationship'), {
        reason: 'hard_revoke'
      }, bridgeFrame(prov.bridgeRoomId));
      // Step 2: Create new bridge with fresh keys
      const newBridgeId = await svc.createRoom(`[Khora Bridge] ${svc.userId} ↔ ${prov.providerUserId}`, 'Khora bridge — replaced', [{
        type: EVT.BRIDGE_META,
        state_key: '',
        content: {
          client: svc.userId,
          provider: prov.providerUserId,
          relationship_type: RELATIONSHIP_TYPES.client_provider.id,
          created: Date.now(),
          status: 'active',
          previous: prov.bridgeRoomId,
          transferable: prov.transferable !== false,
          org_id: null,
          assigned_staff: [prov.providerUserId],
          created_by: svc.userId,
          origin_server: extractHomeserver(svc.userId)
        }
      }, {
        type: EVT.BRIDGE_REFS,
        state_key: '',
        content: {
          fields: {}
        }
      }]);
      // Step 3: Tombstone old bridge (points to new) and kick provider from old
      await svc.tombstone(prov.bridgeRoomId, newBridgeId);
      try {
        await svc.kick(prov.bridgeRoomId, prov.providerUserId, 'Bridge rotated — data revoked');
      } catch {}
      // Step 4: Sync shared fields to new bridge and invite provider
      const stillShared = Object.fromEntries(Object.entries(prov.sharedFields).filter(([, v]) => v));
      if (Object.keys(stillShared).length > 0) await syncFieldsToBridge(newBridgeId, stillShared, vaultData);
      await svc.invite(newBridgeId, prov.providerUserId);
      await emitOp(newBridgeId, 'CON', dot('bridge', 'connection', prov.providerUserId), {
        relationship: RELATIONSHIP_TYPES.client_provider.id,
        bridge_room: newBridgeId,
        initiated_by: 'client',
        reason: 'hard_revoke_replacement'
      }, bridgeFrame(newBridgeId));
      const ups = [...providers];
      ups[pi] = {
        ...prov,
        bridgeRoomId: newBridgeId
      };
      await saveProviderIndex(ups);
      setHardRevokeTarget(null);
      showToast('Hard revoke complete — old room tombstoned, all keys rotated', 'success');
    } catch (e) {
      showToast('Hard revoke failed: ' + e.message, 'error');
    }
  };

  // NUL(vault.relationship, {reason: full_severance}) — permanent_disconnection — kicks provider, clears all refs
  const handleRemoveProvider = async pi => {
    const prov = providers[pi];
    try {
      try {
        await svc.kick(prov.bridgeRoomId, prov.providerUserId);
      } catch {}
      await svc.setState(prov.bridgeRoomId, EVT.BRIDGE_REFS, {
        fields: {},
        revoked: true,
        updated: Date.now()
      });
      await emitOp(vaultRoom, 'NUL', dot('vault', 'relationships', prov.providerUserId), {
        reason: 'full_severance',
        bridge: prov.bridgeRoomId
      }, vaultFrame());
      await saveProviderIndex(providers.filter((_, i) => i !== pi));
      showToast(`${ROLES.provider.label} removed, all keys destroyed`, 'warn');
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  };

  // ─── Room claiming: client takes ownership of a provider-created client_record room ───
  const claimFrame = room => ({
    type: 'client_record',
    room,
    role: 'client',
    epistemic: 'GIVEN'
  });

  // ALT(room.ownership, {client_claim}) — sovereignty_transfer — client takes PL 100, previous owner drops to PL 50
  const handleClaimRoom = async record => {
    try {
      // 0. Ensure we've joined the room (required before writing state)
      try {
        await svc.joinRoom(record.roomId);
      } catch {}
      const prevIdentity = await svc.getState(record.roomId, EVT.IDENTITY);
      const previousOwner = prevIdentity?.owner || record.owner;
      // 1. Ensure client has PL 100 and provider drops to PL 50
      await svc.setPowerLevel(record.roomId, svc.userId, 100);
      if (previousOwner && previousOwner !== svc.userId) {
        await svc.setPowerLevel(record.roomId, previousOwner, 50);
      }
      // 2. Transfer ownership in identity state
      await svc.setState(record.roomId, EVT.IDENTITY, {
        ...prevIdentity,
        owner: svc.userId,
        status: 'claimed',
        claimed_at: Date.now(),
        claimed_by: svc.userId,
        previous_owner: previousOwner
      });
      // 3. Emit ALT operation recording the ownership transfer
      await emitOp(record.roomId, 'ALT', dot('room', 'ownership', 'owner'), {
        from: previousOwner,
        to: svc.userId,
        reason: 'client_claim'
      }, claimFrame(record.roomId));
      // 4. Move from pending to claimed
      setPendingClaims(prev => prev.filter(r => r.roomId !== record.roomId));
      setClaimedRooms(prev => [...prev, {
        ...record,
        owner: svc.userId,
        status: 'claimed',
        claimed_at: Date.now(),
        previous_owner: previousOwner
      }]);
      showToast(`Room claimed — you now have full control of "${record.client_name || 'this record'}"`, 'success');
    } catch (e) {
      showToast('Claim failed: ' + e.message, 'error');
    }
  };

  // NUL(room.member, {reason: owner_revocation}) — access_removal — kicks user from claimed room
  const handleRevokeFromClaimed = async (record, targetUserId) => {
    try {
      await svc.kick(record.roomId, targetUserId, 'Removed by room owner');
      await emitOp(record.roomId, 'NUL', dot('room', 'members', targetUserId), {
        reason: 'owner_revocation',
        removed_by: svc.userId
      }, claimFrame(record.roomId));
      showToast(`Removed ${targetUserId} from room`, 'warn');
    } catch (e) {
      showToast('Remove failed: ' + e.message, 'error');
    }
  };

  // NUL(room.client_record, {reason: owner_closed}) — permanent_decommission — tombstones room permanently
  const handleDeleteClaimedRoom = async record => {
    try {
      // Tombstone the room — marks it as permanently closed
      await svc.setState(record.roomId, 'm.room.tombstone', {
        body: 'This room has been closed by the owner'
      });
      await emitOp(record.roomId, 'NUL', dot('room', 'client_record', 'room'), {
        reason: 'owner_closed',
        closed_by: svc.userId
      }, claimFrame(record.roomId));
      setClaimedRooms(prev => prev.filter(r => r.roomId !== record.roomId));
      showToast('Room closed permanently', 'warn');
    } catch (e) {
      showToast('Close failed: ' + e.message, 'error');
    }
  };

  // ⚠️ REC(vault.metrics_consent, {state: enabled|disabled}) — data_flow_reinterpretation
  // INTERPRETATION SHIFT: changes what downstream systems receive. When enabled,
  // anonymized demographics flow to metrics rooms. When disabled, flow stops entirely.
  const handleMetricsToggle = async () => {
    const newConsent = {
      ...metricsConsent,
      enabled: !metricsConsent.enabled,
      categories: !metricsConsent.enabled ? DEFAULT_PROMPTS.filter(p => p.metrics).map(p => p.category) : []
    };
    await emitOp(vaultRoom, 'REC', dot('vault', 'consent', 'metrics'), {
      consent_level: newConsent.enabled ? 'anonymized_demographics' : 'none',
      categories: newConsent.categories
    }, vaultFrame());
    await saveSnapshot(undefined, undefined, newConsent);
    showToast(newConsent.enabled ? 'Metrics consent enabled — anonymized data will flow' : 'Metrics consent revoked', newConsent.enabled ? 'success' : 'warn');
  };

  // ⚠️ REC(vault.sharing_consent, {state: shared|withheld}) — visibility_reinterpretation
  // INTERPRETATION SHIFT: reinterprets what team members can see about individuals.
  // Handle sharing consent response — client-side team member proactively chooses whether to withhold content
  const handleClientSharingConsent = async (team, withhold) => {
    try {
      const consentValue = withhold ? 'withheld' : 'shared';
      const updatedMembers = (team.members || []).map(m => m.userId === svc.userId ? {
        ...m,
        sharing_consent: consentValue
      } : m);
      await svc.setState(team.roomId, EVT.TEAM_MEMBERS, {
        members: updatedMembers
      });
      await emitOp(team.roomId, 'REC', dot('org', 'consent', 'sharing', svc.userId), {
        consent: consentValue,
        decided_by: svc.userId
      }, vaultFrame());
      setMyTeams(prev => prev.map(t => t.roomId === team.roomId ? {
        ...t,
        members: updatedMembers
      } : t));
      setClientSharingConsentModal(null);
      if (withhold) {
        showToast('Content about individuals will not be shared with you in this team', 'warn');
      } else {
        showToast('Content about individuals may be shared with you in this team', 'success');
      }
    } catch (e) {
      showToast('Failed to save sharing preference: ' + e.message, 'error');
    }
  };
  const loadBridgeMessages = async bid => {
    setBridgeMessages(await svc.getMessages(bid));
  };
  const handleSendBridgeMsg = async () => {
    if (!msgText.trim() || !activeBridge) return;
    await svc.sendMessage(activeBridge, msgText, {
      [`${NS}.type`]: 'note'
    });
    await emitOp(activeBridge, 'INS', dot('bridge', 'messages', 'client_note'), {
      body: msgText
    }, bridgeFrame(activeBridge));
    setMsgText('');
    setTimeout(() => loadBridgeMessages(activeBridge), 500);
  };
  const openBridge = bid => {
    setActiveBridge(bid);
    setView('bridge');
    loadBridgeMessages(bid);
  };

  // ─── Inbox chat functions ───
  const loadInboxMessages = async bid => {
    setInboxMessages(await svc.getMessages(bid));
  };
  const openInboxConvo = providerIdxOrRoomId => {
    setInboxConvo(providerIdxOrRoomId);
    if (typeof providerIdxOrRoomId === 'number') {
      const prov = providers[providerIdxOrRoomId];
      if (prov) loadInboxMessages(prov.bridgeRoomId);
    } else if (typeof providerIdxOrRoomId === 'string') {
      loadInboxMessages(providerIdxOrRoomId);
    }
  };
  const handleSendInboxMsg = async () => {
    if (!inboxMsgText.trim() || inboxConvo === null) return;
    // Team DM (room ID string)
    if (typeof inboxConvo === 'string') {
      await svc.sendMessage(inboxConvo, inboxMsgText, {
        [`${NS}.type`]: 'team_dm'
      });
      setInboxMsgText('');
      setTimeout(() => loadInboxMessages(inboxConvo), 500);
      return;
    }
    // Provider bridge message (index number)
    const prov = providers[inboxConvo];
    if (!prov) return;
    await svc.sendMessage(prov.bridgeRoomId, inboxMsgText, {
      [`${NS}.type`]: 'note'
    });
    await emitOp(prov.bridgeRoomId, 'INS', dot('bridge', 'messages', 'client_note'), {
      body: inboxMsgText
    }, bridgeFrame(prov.bridgeRoomId));
    setInboxMsgText('');
    setTimeout(() => loadInboxMessages(prov.bridgeRoomId), 500);
  };
  // ─── Client-side team DM functions ───
  const startClientTeamDM = async (peerId, peerName, teamName, teamRoomId) => {
    const existing = clientTeamDMs.find(d => d.peerId === peerId);
    if (existing) {
      setInboxTab('team');
      openInboxConvo(existing.roomId);
      return;
    }
    try {
      const roomId = await svc.createRoom(`[Khora DM] ${svc.userId} ↔ ${peerId}`, 'Direct message between connected users', [{
        type: EVT.DM_META,
        state_key: '',
        content: {
          initiator: svc.userId,
          target: peerId,
          team_name: teamName || null,
          team_room_id: teamRoomId || null,
          peer_names: {
            [svc.userId]: vaultData.full_name || svc.userId,
            [peerId]: peerName || peerId
          },
          peer_type: 'provider',
          created: Date.now()
        }
      }]);
      await svc.invite(roomId, peerId);
      const newDM = { roomId, peerId, peerName: peerName || peerId, teamName: teamName || null, teamRoomId: teamRoomId || null, peerType: 'provider' };
      setClientTeamDMs(prev => [...prev, newDM]);
      setNewTeamDMModal(false);
      setNewDMTarget(null);
      setInboxTab('team');
      openInboxConvo(roomId);
      showToast(`DM created — invite sent to ${peerName || peerId}`, 'success');
    } catch (e) {
      showToast('Failed to create DM: ' + e.message, 'error');
    }
  };
  const clientTeamMemberContacts = useMemo(() => {
    const contacts = [];
    const seen = new Set();
    for (const team of myTeams) {
      for (const m of (team.members || [])) {
        if (m.userId === svc.userId || seen.has(m.userId)) continue;
        seen.add(m.userId);
        contacts.push({
          userId: m.userId,
          displayName: m.display_name || m.userId,
          teamName: team.name,
          teamRoomId: team.roomId,
          role: m.role,
          hasDM: clientTeamDMs.some(d => d.peerId === m.userId)
        });
      }
    }
    return contacts;
  }, [myTeams, clientTeamDMs]);
  const activeProviderIdx = providers.findIndex(p => p.bridgeRoomId === activeBridge);
  const activeProvider = activeProviderIdx >= 0 ? providers[activeProviderIdx] : null;
  const filledFields = allFields.filter(f => vaultData[f.key]);
  const sharedCount = providers.reduce((s, p) => s + Object.values(p.sharedFields || {}).filter(Boolean).length, 0);
  if (loading) return /*#__PURE__*/React.createElement("div", {
    style: {
      height: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement(Spin, {
    s: 28
  }));
  if (initError) return /*#__PURE__*/React.createElement("div", {
    style: {
      height: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      maxWidth: 400,
      padding: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 48,
      height: 48,
      borderRadius: 'var(--r-lg)',
      background: 'var(--red-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--red)',
      margin: '0 auto 16px'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "alert-triangle",
    s: 24
  })), /*#__PURE__*/React.createElement("h3", {
    style: {
      fontSize: 16,
      fontWeight: 700,
      marginBottom: 8
    }
  }, "Vault Setup Failed"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6,
      marginBottom: 16
    }
  }, initError), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: initVault,
    className: "b-pri"
  }, /*#__PURE__*/React.createElement(I, {
    n: "refresh-cw",
    s: 13
  }), "Retry"), /*#__PURE__*/React.createElement("button", {
    onClick: onLogout,
    className: "b-gho"
  }, "Sign Out"))));
  return /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      height: '100%'
    }
  },
  /* ─── Mobile Bottom Nav (client) ─── */
  isMobile && /*#__PURE__*/React.createElement(MobileBottomNav, {
    tabs: [
      { id: 'dashboard', icon: 'briefcase', label: 'Home' },
      { id: 'vault', icon: 'folder', label: 'Vault' },
      { id: 'inbox', icon: 'msg', label: 'Messages', badge: providers.length, badgeClass: 'nav-badge-teal' },
      { id: 'providers', icon: 'users', label: 'People' }
    ],
    activeView: activeBridge ? 'bridge' : view,
    onNavigate: id => { setView(id); setActiveBridge(null); },
    moreItems: [
      { id: 'observations', icon: 'clipboard', label: 'Observations' },
      { id: 'resources', icon: 'layers', label: 'My Resources' },
      { id: 'records', icon: 'shield', label: 'My Records', badge: pendingClaims.length, badgeClass: 'nav-badge-gold' },
      { id: 'activity', icon: 'layers', label: 'Activity Stream' },
      { id: 'transparency', icon: 'eye', label: 'Transparency' }
    ],
    onMoreNavigate: id => { setView(id); setActiveBridge(null); }
  },
    availableContexts && availableContexts.length > 1 && /*#__PURE__*/React.createElement("div", { style: { padding: '8px 0', borderTop: '1px solid var(--border-0)', marginTop: 8, display: 'flex', gap: 4 } },
      [{id:'provider',label:ROLES.provider.label,icon:'briefcase'},{id:'client',label:ROLES.client.label,icon:'shield'}].filter(opt => availableContexts.includes(opt.id)).map(opt => /*#__PURE__*/React.createElement("button", {
        key: opt.id, onClick: () => onSwitchContext(opt.id),
        className: activeContext === opt.id ? 'b-pri b-xs' : 'b-gho b-xs',
        style: { flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 4, borderRadius: 'var(--r)', fontSize: 11 }
      }, /*#__PURE__*/React.createElement(I, { n: opt.icon, s: 11 }), opt.label))
    ),
    /*#__PURE__*/React.createElement("div", { style: { padding: '8px 0', borderTop: '1px solid var(--border-0)', marginTop: 8, display: 'flex', gap: 8 } },
      /*#__PURE__*/React.createElement(ThemeToggle, { style: { flex: 1 } }),
      /*#__PURE__*/React.createElement("button", { onClick: onLogout, className: "b-gho b-sm", style: { flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 5 } },
        /*#__PURE__*/React.createElement(I, { n: "logout", s: 12 }), "Logout")
    )
  ),
  /*#__PURE__*/React.createElement("div", {
    className: "app-sidebar",
    style: {
      width: 250,
      minWidth: 250,
      height: '100%',
      background: 'var(--bg-1)',
      borderRight: '1px solid var(--border-0)',
      display: 'flex',
      flexDirection: 'column'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '18px 14px 14px',
      borderBottom: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 10,
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 28,
      height: 28,
      borderRadius: 'var(--r)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement(SpinningDodeca, { size: 28 })), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--serif)',
      fontWeight: 700,
      fontSize: 15
    }
  }, "Khora")), /*#__PURE__*/React.createElement("div", {
    onClick: () => setShareContactModal(true),
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginTop: 8,
      padding: '6px 8px',
      marginLeft: -8,
      marginRight: -8,
      borderRadius: 'var(--r)',
      cursor: 'pointer',
      transition: 'background .2s'
    },
    onMouseEnter: e => e.currentTarget.style.background = 'var(--bg-2)',
    onMouseLeave: e => e.currentTarget.style.background = 'transparent'
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 9.5,
      color: 'var(--tx-3)',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap',
      flex: 1
    }
  }, svc.userId), /*#__PURE__*/React.createElement(I, { n: "share", s: 12, c: "var(--tx-3)" }), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-teal"
  }, ROLES.client.label.toUpperCase()))),
  /* ─── Mode Toggle (sidebar) ─── */
  availableContexts && availableContexts.length > 1 && /*#__PURE__*/React.createElement("div", {
    className: "sidebar-mode-toggle"
  }, [{id:'provider',label:ROLES.provider.label,icon:'briefcase'},{id:'client',label:ROLES.client.label,icon:'shield'}].filter(opt => availableContexts.includes(opt.id)).map(opt => /*#__PURE__*/React.createElement("button", {
    key: opt.id,
    onClick: () => onSwitchContext(opt.id),
    className: activeContext === opt.id ? 'b-pri b-xs' : 'b-gho b-xs',
    style: { display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 4, borderRadius: 'var(--r)', fontSize: 11 }
  }, /*#__PURE__*/React.createElement(I, { n: opt.icon, s: 11 }), opt.label))),
  /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      overflow: 'auto',
      padding: '6px 6px'
    }
  }, [{
    id: 'dashboard',
    icon: 'briefcase',
    label: 'My Dashboard'
  }, {
    id: 'vault',
    icon: 'folder',
    label: 'My Vault'
  }, {
    id: 'inbox',
    icon: 'msg',
    label: 'Messages'
  }, {
    id: 'observations',
    icon: 'clipboard',
    label: 'Observations'
  }, {
    id: 'resources',
    icon: 'layers',
    label: `My Resources${myResources.length ? ` (${myResources.length})` : ''}`
  }, {
    id: 'providers',
    icon: 'users',
    label: 'People & Teams'
  }, {
    id: 'records',
    icon: 'shield',
    label: 'My Records'
  }, {
    id: 'activity',
    icon: 'list',
    label: 'Action Log'
  }, {
    id: 'transparency',
    icon: 'eye',
    label: 'Transparency'
  }].map(item => /*#__PURE__*/React.createElement("div", {
    key: item.id,
    onClick: () => {
      setView(item.id);
      setActiveBridge(null);
      if (item.id !== 'inbox') setInboxConvo(null);
    },
    style: {
      padding: '9px 10px',
      borderRadius: 'var(--r)',
      cursor: 'pointer',
      marginBottom: 1,
      background: view === item.id && !activeBridge ? 'var(--bg-4)' : 'transparent',
      borderLeft: view === item.id && !activeBridge ? '2px solid var(--teal)' : '2px solid transparent',
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      transition: 'all .15s',
      color: view === item.id && !activeBridge ? 'var(--tx-0)' : 'var(--tx-1)'
    },
    onMouseEnter: e => {
      if (!(view === item.id && !activeBridge)) e.currentTarget.style.background = 'var(--bg-3)';
    },
    onMouseLeave: e => {
      if (!(view === item.id && !activeBridge)) e.currentTarget.style.background = 'transparent';
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: item.icon,
    s: 14
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12.5,
      fontWeight: view === item.id ? 600 : 400
    }
  }, item.label), item.id === 'inbox' && providers.length > 0 && /*#__PURE__*/React.createElement("span", {
    className: "nav-badge nav-badge-teal"
  }, providers.length), item.id === 'records' && pendingClaims.length > 0 && /*#__PURE__*/React.createElement("span", {
    className: "nav-badge nav-badge-gold"
  }, pendingClaims.length))), providers.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '14px 10px 4px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "BRIDGES")), providers.map((p, i) => /*#__PURE__*/React.createElement("div", {
    key: p.bridgeRoomId,
    onClick: () => openBridge(p.bridgeRoomId),
    style: {
      padding: '8px 10px',
      borderRadius: 'var(--r)',
      cursor: 'pointer',
      marginBottom: 1,
      background: activeBridge === p.bridgeRoomId ? 'var(--bg-4)' : 'transparent',
      borderLeft: activeBridge === p.bridgeRoomId ? '2px solid var(--gold)' : '2px solid transparent',
      transition: 'all .15s'
    },
    onMouseEnter: e => {
      if (activeBridge !== p.bridgeRoomId) e.currentTarget.style.background = 'var(--bg-3)';
    },
    onMouseLeave: e => {
      if (activeBridge !== p.bridgeRoomId) e.currentTarget.style.background = 'transparent';
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: activeBridge === p.bridgeRoomId ? 600 : 400,
      display: 'block',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap'
    }
  }, p.providerName || p.providerUserId), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, p.providerProfile?.org_membership?.verified && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 9,
    c: "var(--blue)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 8.5,
      color: 'var(--blue)',
      fontWeight: 600,
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap',
      maxWidth: 100
    }
  }, p.providerProfile.org_membership.org_name)), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9.5,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)'
    }
  }, Object.values(p.sharedFields || {}).filter(Boolean).length, " fields")))))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 10px',
      borderTop: '1px solid var(--border-0)',
      display: 'flex',
      flexDirection: 'column',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    server: svc._baseUrl ? (() => { try { return new URL(svc._baseUrl).hostname; } catch(e) { return 'unknown'; } })() : 'unknown',
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Session",
    compact: true
  }), /*#__PURE__*/React.createElement(ThemeToggle, {
    style: {
      width: '100%',
      justifyContent: 'center'
    }
  }), /*#__PURE__*/React.createElement("button", {
    onClick: onLogout,
    className: "b-gho b-sm",
    style: {
      width: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "logout",
    s: 12
  }), "Logout"))), /*#__PURE__*/React.createElement("div", {
    className: "app-main",
    style: {
      flex: 1,
      overflow: 'auto',
      padding: 24,
      minWidth: 0
    }
  }, view === 'dashboard' && !activeBridge && /*#__PURE__*/React.createElement(PersonalDashboard, {
    session: session,
    providers: providers,
    observations: observations,
    myResources: myResources,
    vaultData: vaultData,
    allFields: allFields,
    vaultRoom: vaultRoom,
    myTeams: myTeams,
    onNavigate: v => {
      setView(v);
      setActiveBridge(null);
    }
  }), view === 'vault' && !activeBridge && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "Your Vault"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "All data encrypted in your private Matrix room. Only you can read this."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: vaultRoom,
    encrypted: true,
    encLabel: "Megolm E2EE + AES-256-GCM at rest",
    label: "Vault Data",
    members: [{ userId: svc.userId, role: 'owner (sole access)' }],
    extra: [{ label: 'Sovereignty', value: 'You are the only person who can read or decrypt this data. Providers can only see fields you explicitly share.' }]
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setFrameworkModal(true),
    className: "b-gho",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "grid",
    s: 14
  }), enabledFrameworks.length > 0 && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green",
    style: {
      fontSize: 8,
      padding: '1px 5px'
    }
  }, enabledFrameworks.length), "Frameworks"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setAddFieldModal(true),
    className: "b-gho",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "Add Field"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setEditData({
        ...vaultData
      });
      setEditModal(true);
    },
    className: "b-pri",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "key",
    s: 14
  }), "Edit Vault"))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(170px,1fr))',
      gap: 10,
      marginBottom: 24
    }
  }, [{
    l: 'Fields',
    v: `${filledFields.length}/${allFields.length}`,
    c: 'teal',
    i: 'folder'
  }, {
    l: ROLES.provider.label + 's',
    v: providers.length,
    c: 'gold',
    i: 'users'
  }, {
    l: 'Observations',
    v: observations.length,
    c: 'blue',
    i: 'clipboard'
  }, {
    l: 'Shared Fields',
    v: sharedCount,
    c: 'orange',
    i: 'share'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginTop: 2
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700
    }
  }, s.v), /*#__PURE__*/React.createElement("span", {
    style: {
      color: `var(--${s.c})`,
      opacity: .5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: s.i,
    s: 15
  })))))), allCategories.map(cat => {
    const fields = allFields.filter(f => f.category === cat);
    const color = CAT_COLORS[cat] || 'gold';
    if (!fields.length) return null;
    return /*#__PURE__*/React.createElement("div", {
      key: cat,
      style: {
        marginBottom: 16
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginBottom: 8
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        color: `var(--${color})`
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: CAT_ICONS[cat] || 'file',
      s: 13
    })), /*#__PURE__*/React.createElement("span", {
      className: "section-label",
      style: {
        marginBottom: 0
      }
    }, (CAT_LABELS[cat] || cat.charAt(0).toUpperCase() + cat.slice(1)).toUpperCase())), /*#__PURE__*/React.createElement("div", {
      className: "card",
      style: {
        padding: 0,
        overflow: 'hidden'
      }
    }, fields.map((f, fi) => /*#__PURE__*/React.createElement(React.Fragment, {
      key: f.key
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '10px 16px',
        borderBottom: fi < fields.length - 1 && !(provenanceTarget?.entityKey === f.key && provenanceTarget?.roomId === vaultRoom) ? '1px solid var(--border-0)' : 'none',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        fontWeight: 500
      }
    }, f.label), f.sensitive && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-red",
      style: {
        fontSize: 8.5
      }
    }, "SENSITIVE"), f.custom && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-purple",
      style: {
        fontSize: 8.5
      }
    }, "CUSTOM"), f.framework && /*#__PURE__*/React.createElement("a", {
      href: f.uri || f.frameworkUri,
      target: "_blank",
      rel: "noopener",
      className: `tag tag-${FRAMEWORK_BY_ID[f.framework]?.accent || 'blue'}`,
      style: {
        fontSize: 8.5,
        textDecoration: 'none',
        cursor: 'pointer'
      },
      title: `${f.frameworkName} — ${f.property}`
    }, f.frameworkName)), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontFamily: 'var(--mono)',
        fontSize: 11.5,
        color: vaultData[f.key] ? 'var(--tx-1)' : 'var(--tx-3)',
        maxWidth: 200,
        overflow: 'hidden',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap'
      }
    }, vaultData[f.key] ? f.sensitive ? '••••••••' : vaultData[f.key] : '—'), /*#__PURE__*/React.createElement("span", {
      onClick: () => setProvenanceTarget(pt => pt?.entityKey === f.key && pt?.roomId === vaultRoom ? null : {
        entityKey: f.key,
        label: f.label,
        roomId: vaultRoom
      }),
      style: {
        cursor: 'pointer',
        color: provenanceTarget?.entityKey === f.key && provenanceTarget?.roomId === vaultRoom ? 'var(--teal)' : 'var(--tx-3)',
        transition: 'color .15s'
      },
      title: "View provenance"
    }, /*#__PURE__*/React.createElement(I, {
      n: "git-commit",
      s: 12
    })), f.custom && /*#__PURE__*/React.createElement("span", {
      onClick: () => handleDeleteCustomField(f.key),
      style: {
        cursor: 'pointer',
        color: 'var(--tx-3)',
        transition: 'color .15s'
      },
      onMouseEnter: e => e.currentTarget.style.color = 'var(--red)',
      onMouseLeave: e => e.currentTarget.style.color = 'var(--tx-3)'
    }, /*#__PURE__*/React.createElement(I, {
      n: "trash",
      s: 12
    })))), provenanceTarget?.entityKey === f.key && provenanceTarget?.roomId === vaultRoom && /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '4px 16px 12px',
        borderBottom: fi < fields.length - 1 ? '1px solid var(--border-0)' : 'none'
      }
    }, /*#__PURE__*/React.createElement(RecordProvenance, {
      roomId: vaultRoom,
      entityKey: f.key,
      label: f.label,
      session: session
    }))))));
  })), view === 'observations' && !activeBridge && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "Observations"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "Record what\u2019s happening in your own words. These are your self-reports \u2014 simple check-ins that help your providers stay in the loop."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: vaultRoom,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Observations",
    members: [{ userId: svc.userId, role: 'owner' }],
    extra: [{ label: 'Data type', value: 'Immutable GIVEN events stored as timeline events in your personal vault room' }]
  }))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "RECORD NEW OBSERVATION"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-2)',
      marginBottom: 12
    }
  }, "Pick a question below to record something that happened. Your answers are stored privately in your encrypted vault \u2014 only you decide who sees them."), DEFAULT_FORMS.map(f => /*#__PURE__*/React.createElement("div", {
    key: f.id,
    style: {
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11.5,
      fontWeight: 600,
      color: 'var(--tx-0)'
    }
  }, f.name), /*#__PURE__*/React.createElement(MaturityBadge, {
    maturity: f.maturity
  }), f.source && /*#__PURE__*/React.createElement(SourceBadge, {
    source: f.source
  })), f.description && /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      lineHeight: 1.5,
      marginBottom: 2,
      marginTop: 2
    }
  }, f.description), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      fontStyle: 'italic',
      marginBottom: 6
    }
  }, f.source?.level === 'network' ? "This form was set up by your care network and shared to all member organizations." : "This form was created locally by your organization."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fill,minmax(200px,1fr))',
      gap: 8
    }
  }, f.fields.map(p => /*#__PURE__*/React.createElement("div", {
    key: p.id,
    className: "card-h",
    onClick: () => {
      setObsModal(p);
      setObsValue('');
      setObsFreeText('');
      setObsDate(new Date().toISOString().slice(0, 10));
    },
    style: {
      padding: 14
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 6,
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tag tag-${OBS_CAT_COLORS[p.category] || 'blue'}`
  }, p.category), p.sensitive && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-red",
    style: {
      fontSize: 8
    }
  }, "SENSITIVE"), p.maturity && /*#__PURE__*/React.createElement(MaturityBadge, {
    maturity: p.maturity
  })), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 600,
      display: 'block'
    }
  }, p.question), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginTop: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-3)'
    }
  }, p.options.length, " response options")))))))), /*#__PURE__*/React.createElement("div", {
    className: "card"
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "OBSERVATION HISTORY (", observations.length, ")"), observations.length === 0 ? /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 12.5,
      padding: '16px 0',
      textAlign: 'center'
    }
  }, "No observations recorded yet") : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4,
      marginTop: 8
    }
  }, [...observations].reverse().map((obs, i) => {
    const prompt = DEFAULT_PROMPTS.find(p => p.key === obs.category);
    const optLabel = prompt?.options.find(o => o.v === obs.value)?.l || obs.value;
    const obsEntityKey = obs.category;
    const obsProvOpen = provenanceTarget?.entityKey === obsEntityKey && provenanceTarget?.roomId === vaultRoom && provenanceTarget?._obsId === obs.id;
    return /*#__PURE__*/React.createElement(React.Fragment, {
      key: obs.id || i
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '10px 14px',
        background: 'var(--bg-3)',
        borderRadius: 'var(--r)',
        display: 'flex',
        alignItems: 'center',
        gap: 10
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${OBS_CAT_COLORS[obs.category] || 'blue'}`,
      style: {
        fontSize: 9
      }
    }, obs.category), /*#__PURE__*/React.createElement("span", {
      className: "tag tag-teal",
      style: {
        fontSize: 8.5
      }
    }, "GIVEN"), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        flex: 1
      }
    }, optLabel), obs.created_by && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      },
      title: obs.created_by
    }, obs.created_by.split(':')[0]?.slice(1)), obs.origin_server && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 8.5,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, obs.origin_server), obs.free_text && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        color: 'var(--tx-2)',
        fontStyle: 'italic'
      }
    }, obs.free_text), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, obs.date), /*#__PURE__*/React.createElement("span", {
      onClick: () => setProvenanceTarget(obsProvOpen ? null : {
        entityKey: obsEntityKey,
        label: `Observation: ${obs.category}`,
        roomId: vaultRoom,
        _obsId: obs.id
      }),
      style: {
        cursor: 'pointer',
        color: obsProvOpen ? 'var(--teal)' : 'var(--tx-3)',
        transition: 'color .15s',
        flexShrink: 0
      },
      title: "View provenance"
    }, /*#__PURE__*/React.createElement(I, {
      n: "git-commit",
      s: 11
    }))), obsProvOpen && /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 2,
        marginBottom: 4
      }
    }, /*#__PURE__*/React.createElement(RecordProvenance, {
      roomId: vaultRoom,
      entityKey: obsEntityKey,
      label: `Observation: ${obs.category}`,
      session: session
    })));
  }))), observations.filter(obs => FRAMEWORK_BINDINGS[obs.category]?.bindings?.[obs.value]).length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 24,
      height: 24,
      borderRadius: '50%',
      background: 'linear-gradient(135deg,var(--teal),var(--gold))',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--bg-0)',
      fontSize: 11,
      fontWeight: 800
    }
  }, "\u2192"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 15,
      fontWeight: 700
    }
  }, "What Your Observations Mean"), /*#__PURE__*/React.createElement("span", {
    className: "gm-sup-badge"
  }, "GIVEN \u2192 MEANT")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginBottom: 10
    }
  }, "Your observations are facts. Below you can see how different institutional frameworks interpret those same facts differently."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 10
    }
  }, observations.filter(obs => FRAMEWORK_BINDINGS[obs.category]?.bindings?.[obs.value]).slice(-3).reverse().map((obs, i) => /*#__PURE__*/React.createElement(RecordGivenMeant, {
    key: obs.id || i,
    promptKey: obs.category,
    value: obs.value,
    reporter: `${ROLES.client.label} self-report`,
    timestamp: obs.ts
  }))))), view === 'resources' && !activeBridge && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "My Resources"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4,
      marginBottom: 20
    }
  }, "Resources allocated to you by providers across all your bridges. This is your record \u2014 encrypted in your vault."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: vaultRoom,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "My Resources",
    members: [{ userId: svc.userId, role: 'owner' }],
    extra: [{ label: 'Storage', value: 'Resource vault records are stored in your personal vault and mirrored in each bridge room. Only you and the allocating provider can see allocations.' }]
  }), myResources.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '30px 20px',
      borderStyle: 'dashed'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "layers",
    s: 28,
    c: "var(--tx-3)"
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 8,
      fontSize: 12
    }
  }, "No resources have been allocated to you yet."), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 11,
      marginTop: 4
    }
  }, "When a provider allocates resources (vouchers, funds, services), they'll appear here.")) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(140px,1fr))',
      gap: 10,
      marginBottom: 20
    }
  }, [{
    l: 'Total',
    v: myResources.length,
    c: 'teal'
  }, {
    l: 'Active',
    v: myResources.filter(r => r.status === 'active').length,
    c: 'green'
  }, {
    l: 'Used',
    v: myResources.filter(r => r.status === 'consumed').length,
    c: 'blue'
  }, {
    l: 'Expired',
    v: myResources.filter(r => r.status === 'expired').length,
    c: 'orange'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: 12
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      color: `var(--${s.c})`
    }
  }, s.v)))), (() => {
    const byProvider = {};
    myResources.forEach(r => {
      const key = r.org_display_name || r.provider_display_name || r.bridge_room_id || 'Unknown';
      if (!byProvider[key]) byProvider[key] = [];
      byProvider[key].push(r);
    });
    return Object.entries(byProvider).map(([provName, allocs]) => /*#__PURE__*/React.createElement("div", {
      key: provName,
      style: {
        marginBottom: 16
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginBottom: 8
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "briefcase",
      s: 14,
      c: "var(--gold)"
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        fontWeight: 600
      }
    }, provName), /*#__PURE__*/React.createElement("span", {
      className: "tag tag-gold",
      style: {
        fontSize: 8
      }
    }, allocs.length)), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        flexDirection: 'column',
        gap: 6
      }
    }, allocs.sort((a, b) => (b.allocated_at || 0) - (a.allocated_at || 0)).map((alloc, i) => {
      const statusColors = {
        active: 'teal',
        consumed: 'blue',
        expired: 'orange',
        revoked: 'red'
      };
      const clientAllocProvOpen = provenanceTarget?.entityKey === alloc.allocation_id && provenanceTarget?.roomId === alloc.bridge_room_id;
      return /*#__PURE__*/React.createElement(React.Fragment, {
        key: alloc.allocation_id || i
      }, /*#__PURE__*/React.createElement("div", {
        className: "card",
        style: {
          padding: '10px 14px'
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          marginBottom: 2
        }
      }, /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 13,
          fontWeight: 600
        }
      }, alloc.resource_name || alloc.resource_type_id), /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: 6
        }
      }, /*#__PURE__*/React.createElement("span", {
        className: `tag tag-${statusColors[alloc.status] || 'teal'}`,
        style: {
          fontSize: 8.5
        }
      }, (alloc.status || 'active').toUpperCase()), /*#__PURE__*/React.createElement("span", {
        onClick: () => setProvenanceTarget(clientAllocProvOpen ? null : {
          entityKey: alloc.allocation_id,
          label: `Resource: ${alloc.resource_name || alloc.resource_type_id}`,
          roomId: alloc.bridge_room_id
        }),
        style: {
          cursor: 'pointer',
          color: clientAllocProvOpen ? 'var(--teal)' : 'var(--tx-3)',
          transition: 'color .15s'
        },
        title: "View provenance"
      }, /*#__PURE__*/React.createElement(I, {
        n: "git-commit",
        s: 11
      })))), /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: 8
        }
      }, /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 11,
          color: 'var(--tx-2)',
          fontFamily: 'var(--mono)'
        }
      }, "x", alloc.quantity, " ", alloc.unit || ''), /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 9.5,
          color: 'var(--tx-3)',
          fontFamily: 'var(--mono)'
        }
      }, alloc.allocated_at ? new Date(alloc.allocated_at).toLocaleDateString() : '')), alloc.notes && /*#__PURE__*/React.createElement("p", {
        style: {
          fontSize: 11,
          color: 'var(--tx-2)',
          marginTop: 4,
          fontStyle: 'italic'
        }
      }, alloc.notes)), clientAllocProvOpen && /*#__PURE__*/React.createElement("div", {
        style: {
          marginTop: 2,
          marginBottom: 4
        }
      }, /*#__PURE__*/React.createElement(RecordProvenance, {
        roomId: alloc.bridge_room_id,
        entityKey: alloc.allocation_id,
        label: `Resource: ${alloc.resource_name || alloc.resource_type_id}`,
        session: session
      })));
    }))));
  })())), view === 'providers' && !activeBridge && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "People & Teams"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "Your ", ROLES.provider.label.toLowerCase(), "s, teams you belong to, and contacts \u2014 all in one place."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "People & Teams",
    extra: [{ label: 'Providers', value: providers.length + ' provider(s), each with a separate encrypted bridge room' }, { label: 'Teams', value: myTeams.length + ' team(s), each a separate encrypted Matrix room' }, { label: 'Privacy', value: 'Provider relationships are stored as bridge rooms. Team memberships are stored in team rooms. No central directory has access to all your connections.' }]
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => setAddProviderModal(true),
    className: "b-pri",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "Add ", ROLES.provider.label)), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "briefcase",
    s: 16,
    c: "var(--gold)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 15,
      fontWeight: 700
    }
  }, ROLES.provider.label, "s"), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 9
    }
  }, providers.length)), providers.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '24px 20px',
      borderStyle: 'dashed'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "briefcase",
    s: 24,
    c: "var(--tx-3)"
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 8,
      fontSize: 12
    }
  }, "No ", ROLES.provider.label.toLowerCase(), "s yet. Add one to create an encrypted bridge.")) : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 10
    }
  }, providers.map((prov, pi) => {
    const shCount = Object.values(prov.sharedFields || {}).filter(Boolean).length;
    const pp = prov.providerProfile;
    const orgInfo = pp?.org_membership;
    return /*#__PURE__*/React.createElement("div", {
      key: prov.bridgeRoomId,
      className: "card",
      style: {
        padding: 0,
        overflow: 'hidden'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '14px 18px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        borderBottom: '1px solid var(--border-0)'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        minWidth: 0
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8,
        flexWrap: 'wrap'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 14,
        fontWeight: 600
      }
    }, prov.providerName || prov.providerUserId), pp?.title && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11,
        color: 'var(--tx-2)'
      }
    }, pp.title), /*#__PURE__*/React.createElement("span", {
      className: "tag tag-green"
    }, /*#__PURE__*/React.createElement(I, {
      n: "lock",
      s: 9
    }), "E2EE")), orgInfo?.verified ? /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 5,
        marginTop: 4
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "shieldCheck",
      s: 12,
      c: "var(--blue)"
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11,
        fontWeight: 600,
        color: 'var(--blue)'
      }
    }, orgInfo.org_name), orgInfo.email_verified ? /*#__PURE__*/React.createElement("span", {
      className: "tag tag-green",
      style: {
        fontSize: 7.5,
        padding: '1px 5px'
      }
    }, "EMAIL VERIFIED") : /*#__PURE__*/React.createElement("span", {
      className: "tag tag-green",
      style: {
        fontSize: 7.5,
        padding: '1px 5px'
      }
    }, "VERIFIED"), orgInfo.role && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)'
      }
    }, orgInfo.role)) : /*#__PURE__*/React.createElement("span", {
      style: {
        fontFamily: 'var(--mono)',
        fontSize: 10,
        color: 'var(--tx-3)'
      }
    }, "Independent ", ROLES.provider.label.toLowerCase()), pp?.credentials && /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 2
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9.5,
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)'
      }
    }, pp.credentials)), /*#__PURE__*/React.createElement("span", {
      style: {
        fontFamily: 'var(--mono)',
        fontSize: 10,
        color: 'var(--tx-3)',
        display: 'block',
        marginTop: 2
      }
    }, "Bridge: ", prov.bridgeRoomId.slice(0, 20), "\u2026")), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => { setView('inbox'); openInboxConvo(pi); },
      className: "b-pri b-sm",
      style: { display: 'flex', alignItems: 'center', gap: 4 }
    }, /*#__PURE__*/React.createElement(I, { n: "msg", s: 11 }), "Message"), /*#__PURE__*/React.createElement("button", {
      onClick: () => openBridge(prov.bridgeRoomId),
      className: "b-gho b-sm"
    }, "Open Bridge"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setHardRevokeTarget(pi),
      className: "b-red b-sm"
    }, /*#__PURE__*/React.createElement(I, {
      n: "zap",
      s: 11
    })), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleRemoveProvider(pi),
      className: "b-gho b-sm",
      style: {
        color: 'var(--red)'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "trash",
      s: 12
    })))), /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '10px 18px',
        borderBottom: '1px solid var(--border-0)',
        background: prov.transferable === false ? 'var(--red-dim)' : 'var(--green-dim)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        gap: 10
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8,
        flex: 1
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: prov.transferable === false ? 'lock' : 'users',
      s: 14,
      c: prov.transferable === false ? 'var(--red)' : 'var(--green)'
    }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        fontWeight: 600,
        color: prov.transferable === false ? 'var(--red)' : 'var(--green)',
        display: 'block'
      }
    }, prov.transferable === false ? 'Transfer Locked' : 'Transferable'), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-2)'
      }
    }, prov.transferable === false ? 'Only this provider can access your bridge. Org cannot reassign.' : 'Org can reassign your case to a different provider if needed.'))), /*#__PURE__*/React.createElement(Toggle, {
      on: prov.transferable !== false,
      onChange: () => handleToggleTransferable(pi)
    })), /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '12px 18px'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: "section-label"
    }, "FIELD-LEVEL SHARING"), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '0'
      }
    }, allFields.map(f => {
      const isShared = prov.sharedFields?.[f.key] || false;
      const hasData = !!vaultData[f.key];
      return /*#__PURE__*/React.createElement("div", {
        key: f.key,
        style: {
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '6px 0',
          borderBottom: '1px solid var(--border-0)',
          marginRight: 16
        }
      }, /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 12,
          color: hasData ? 'var(--tx-0)' : 'var(--tx-3)'
        }
      }, f.label, f.custom ? ' ✦' : ''), /*#__PURE__*/React.createElement(Toggle, {
        on: isShared,
        onChange: () => handleToggleField(pi, f.key),
        disabled: !hasData
      }));
    })), /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 10,
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "key",
      s: 12,
      c: "var(--tx-3)"
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, shCount, "/", allFields.length, " fields \u2014 unique AES-256-GCM keys"))));
  }))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 16,
    c: "var(--purple,var(--blue))"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 15,
      fontWeight: 700
    }
  }, "My Teams"), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-blue",
    style: {
      fontSize: 9
    }
  }, myTeams.length)), myTeams.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '24px 20px',
      borderStyle: 'dashed'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 24,
    c: "var(--tx-3)"
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 8,
      fontSize: 12
    }
  }, "Not part of any teams yet. Teams are created by ", ROLES.provider.label.toLowerCase(), "s to collaborate.")) : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fill,minmax(200px,1fr))',
      gap: 10
    }
  }, myTeams.map(team => {
    const myMembership = (team.members || []).find(m => m.userId === svc.userId);
    return /*#__PURE__*/React.createElement("div", {
      key: team.roomId,
      className: "card",
      style: {
        padding: 0,
        overflow: 'hidden'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '14px 18px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        marginBottom: 6
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 14,
        fontWeight: 600
      }
    }, team.name || 'Unnamed Team'), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 4
      }
    }, team.org_name && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-blue",
      style: {
        fontSize: 8
      }
    }, team.org_name), myMembership?.sharing_consent === 'shared' && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-green",
      style: {
        fontSize: 7
      }
    }, "SHARING"), myMembership?.sharing_consent === 'withheld' && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-red",
      style: {
        fontSize: 7
      }
    }, "WITHHELD"))), team.description && /*#__PURE__*/React.createElement("p", {
      style: {
        fontSize: 11,
        color: 'var(--tx-2)',
        lineHeight: 1.5,
        marginBottom: 8
      }
    }, team.description), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "user",
      s: 11,
      c: "var(--tx-3)"
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        color: 'var(--tx-2)'
      }
    }, team.members?.length || 0, " member", (team.members?.length || 0) !== 1 ? 's' : '')), team.members && team.members.length > 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 3,
        flexWrap: 'wrap',
        marginTop: 6
      }
    }, team.members.slice(0, 4).map((m, mi) => /*#__PURE__*/React.createElement("span", {
      key: mi,
      style: {
        fontSize: 9,
        padding: '2px 6px',
        background: 'var(--bg-3)',
        borderRadius: 'var(--r)',
        color: 'var(--tx-1)'
      }
    }, m.display_name || m.userId?.split(':')[0]?.replace('@', ''), m.userId !== svc.userId && /*#__PURE__*/React.createElement("button", {
      onClick: e => { e.stopPropagation(); startClientTeamDM(m.userId, m.display_name || m.userId, team.name, team.roomId); },
      style: { background: 'none', border: 'none', cursor: 'pointer', padding: '0 0 0 3px', color: 'var(--purple)', display: 'inline-flex' },
      title: `Message ${m.display_name || m.userId}`
    }, /*#__PURE__*/React.createElement(I, { n: "msg", s: 8 })))), team.members.length > 4 && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--tx-3)'
      }
    }, "+", team.members.length - 4))), myMembership && myMembership.sharing_consent === 'pending' && /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '10px 18px',
        background: 'var(--gold-dim)',
        borderTop: '1px solid rgba(218,165,32,.15)'
      }
    }, /*#__PURE__*/React.createElement("p", {
      style: {
        fontSize: 11,
        color: 'var(--tx-1)',
        lineHeight: 1.6,
        marginBottom: 8
      }
    }, /*#__PURE__*/React.createElement("strong", null, "Content sharing decision required."), " Content about individuals served by this team will be shared with you by default. Would you like to withhold it?"), /*#__PURE__*/React.createElement("button", {
      onClick: () => setClientSharingConsentModal({
        team
      }),
      className: "b-pri b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 3
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "shield",
      s: 10
    }), "Make My Choice")), myMembership && (myMembership.sharing_consent === 'shared' || myMembership.sharing_consent === 'withheld') && /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '8px 18px',
        borderTop: '1px solid var(--border-0)',
        display: 'flex',
        justifyContent: 'flex-end'
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setClientSharingConsentModal({
        team
      }),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 3
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "shield",
      s: 10
    }), "Change Sharing")));
  }))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "msg",
    s: 16,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 15,
      fontWeight: 700
    }
  }, "Contacts")), (() => {
    // Derive contacts: people who appear across bridges + teams (deduplicated)
    const contactMap = {};
    for (const prov of providers) {
      const uid = prov.providerUserId;
      if (uid && uid !== svc.userId && !contactMap[uid]) {
        contactMap[uid] = {
          userId: uid,
          name: prov.providerName || uid,
          source: 'bridge',
          org: prov.providerProfile?.org_membership?.org_name
        };
      }
    }
    for (const team of myTeams) {
      for (const m of team.members || []) {
        if (m.userId && m.userId !== svc.userId && !contactMap[m.userId]) {
          contactMap[m.userId] = {
            userId: m.userId,
            name: m.display_name || m.userId,
            source: 'team',
            team: team.name
          };
        }
      }
    }
    const contacts = Object.values(contactMap);
    return contacts.length === 0 ? /*#__PURE__*/React.createElement("div", {
      className: "card",
      style: {
        textAlign: 'center',
        padding: '24px 20px',
        borderStyle: 'dashed'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "msg",
      s: 24,
      c: "var(--tx-3)"
    }), /*#__PURE__*/React.createElement("p", {
      style: {
        color: 'var(--tx-2)',
        marginTop: 8,
        fontSize: 12
      }
    }, "No contacts yet. Connect with ", ROLES.provider.label.toLowerCase(), "s or join teams to build your network.")) : /*#__PURE__*/React.createElement("div", {
      className: "card",
      style: {
        padding: 0,
        overflow: 'hidden'
      }
    }, contacts.map((c, ci) => /*#__PURE__*/React.createElement("div", {
      key: c.userId,
      style: {
        padding: '10px 16px',
        borderBottom: ci < contacts.length - 1 ? '1px solid var(--border-0)' : 'none',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        width: 24,
        height: 24,
        borderRadius: '50%',
        background: c.source === 'bridge' ? 'var(--gold-dim)' : 'var(--blue-dim)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: c.source === 'bridge' ? 'var(--gold)' : 'var(--blue)',
        flexShrink: 0
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: c.source === 'bridge' ? 'briefcase' : 'users',
      s: 11
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        fontWeight: 500,
        display: 'block'
      }
    }, c.name), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9.5,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, c.userId))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, c.org && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-blue",
      style: {
        fontSize: 8
      }
    }, c.org), c.team && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-purple",
      style: {
        fontSize: 8
      }
    }, c.team), /*#__PURE__*/React.createElement("span", {
      className: `tag ${c.source === 'bridge' ? 'tag-gold' : 'tag-blue'}`,
      style: {
        fontSize: 8
      }
    }, c.source === 'bridge' ? ROLES.provider.label : 'Team')))));
  })())), view === 'records' && !activeBridge && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "My Records"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "Rooms created by providers on your behalf. Claim them to take full ownership and control."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "My Records",
    extra: [{ label: 'Ownership', value: 'Each record is a separate Matrix room. Pending records were created by a provider. Once claimed, ownership (power level 100) transfers to you and only you can control access.' }, { label: 'Rooms', value: (pendingClaims.length + claimedRooms.length) + ' record rooms (' + pendingClaims.length + ' pending, ' + claimedRooms.length + ' claimed)' }]
  }))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(140px,1fr))',
      gap: 10,
      marginBottom: 20
    }
  }, [{
    l: 'Pending',
    v: pendingClaims.length,
    c: 'gold',
    i: 'clock'
  }, {
    l: 'Claimed',
    v: claimedRooms.length,
    c: 'teal',
    i: 'shield'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginTop: 2
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700
    }
  }, s.v), /*#__PURE__*/React.createElement("span", {
    style: {
      color: `var(--${s.c})`,
      opacity: .5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: s.i,
    s: 15
  })))))), pendingClaims.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "PENDING \u2014 AWAITING YOUR CLAIM"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 8,
      marginTop: 8
    }
  }, pendingClaims.map(rec => /*#__PURE__*/React.createElement("div", {
    key: rec.roomId,
    className: "card",
    style: {
      padding: '14px 18px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 14,
      fontWeight: 600
    }
  }, rec.client_name || 'Unnamed Record'), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold"
  }, "Pending")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 10,
      marginTop: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-2)'
    }
  }, "Created by: ", /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)'
    }
  }, rec.owner)), rec.created && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)'
    }
  }, new Date(rec.created).toLocaleDateString())), rec.notes && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginTop: 4,
      display: 'block',
      fontStyle: 'italic'
    }
  }, rec.notes)), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleClaimRoom(rec),
    className: "b-pri",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      whiteSpace: 'nowrap'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 13
  }), "Claim Room"))))), claimedRooms.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CLAIMED \u2014 YOU OWN THESE ROOMS"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 8,
      marginTop: 8
    }
  }, claimedRooms.map(rec => /*#__PURE__*/React.createElement("div", {
    key: rec.roomId,
    className: "card",
    style: {
      padding: 0,
      overflow: 'hidden'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '14px 18px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      borderBottom: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 14,
      fontWeight: 600
    }
  }, rec.client_name || 'Record'), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-teal"
  }, "Claimed"), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green"
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 9
  }), "PL 100")), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10,
      color: 'var(--tx-3)'
    }
  }, "Room: ", rec.roomId.slice(0, 25), "\u2026")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4
    }
  }, rec.previous_owner && /*#__PURE__*/React.createElement("button", {
    onClick: () => handleRevokeFromClaimed(rec, rec.previous_owner),
    className: "b-gho b-sm",
    style: {
      color: 'var(--red)',
      display: 'flex',
      alignItems: 'center',
      gap: 3
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "userMinus",
    s: 11
  }), "Remove Provider"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleDeleteClaimedRoom(rec),
    className: "b-gho b-sm",
    style: {
      color: 'var(--red)',
      display: 'flex',
      alignItems: 'center',
      gap: 3
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "trash",
    s: 11
  }), "Close Room"))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 18px',
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 16,
      flexWrap: 'wrap'
    }
  }, rec.previous_owner && /*#__PURE__*/React.createElement("span", null, "Previous owner: ", /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10.5
    }
  }, rec.previous_owner)), rec.claimed_at && /*#__PURE__*/React.createElement("span", null, "Claimed: ", /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10.5
    }
  }, new Date(rec.claimed_at).toLocaleString())))))))), pendingClaims.length === 0 && claimedRooms.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '40px 20px',
      borderStyle: 'dashed'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 32
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 10,
      fontSize: 13
    }
  }, "No records to claim"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 11.5,
      marginTop: 4
    }
  }, "When a provider creates a room for you and sends an invite, it will appear here for you to claim.")), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '14px 18px',
      marginTop: 20,
      display: 'flex',
      gap: 10,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 16,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--teal)'
    }
  }, "Full control after claiming:"), " When you claim a room, ownership transfers to you (power level 100). You can remove the provider, close the room, or manage who has access. The provider cannot undo your claim."))), view === 'inbox' && !activeBridge && /*#__PURE__*/React.createElement("div", {
    className: "anim-up inbox-wrap"
  }, /*#__PURE__*/React.createElement("div", {
    className: "inbox-header"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "Messages"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "Encrypted conversations with your connections. Messages are end-to-end encrypted."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: typeof inboxConvo === 'number' ? (providers[inboxConvo] || {}).bridgeRoomId : inboxConvo || (providers[0] || {}).bridgeRoomId,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Messages",
    members: typeof inboxConvo === 'number' && inboxConvo !== null ? providers.filter(p => p.bridgeRoomId === providers[inboxConvo]?.bridgeRoomId).map(p => ({ userId: p.providerUserId, role: 'provider' })).concat([{ userId: svc.userId, role: 'client (you)' }]) : undefined,
    extra: [{ label: 'Privacy', value: 'Each conversation is a separate encrypted Matrix room. Only you and your connection can read messages.' }]
  })), /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 6, flexShrink: 0 }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setAddProviderModal(true),
    className: "b-pri",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "New Conversation"), clientTeamMemberContacts.length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => setNewTeamDMModal(true),
    className: "b-gho b-sm",
    style: { display: 'flex', alignItems: 'center', gap: 6 }
  }, /*#__PURE__*/React.createElement(I, { n: "msg", s: 14 }), "New DM"))), /*#__PURE__*/React.createElement("div", {
    className: "inbox-panel"
  }, /*#__PURE__*/React.createElement("div", {
    className: "inbox-list"
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 14px 8px',
      borderBottom: '1px solid var(--border-0)',
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0,
      flex: 1
    }
  }, `CONVERSATIONS (${providers.length + clientTeamDMs.length})`)), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      overflow: 'auto'
    }
  }, (() => {
    const total = providers.length + clientTeamDMs.length;
    if (total === 0) return /*#__PURE__*/React.createElement("div", { style: { padding: '40px 16px', textAlign: 'center' } }, /*#__PURE__*/React.createElement(I, { n: "msg", s: 28, c: "var(--tx-3)" }), /*#__PURE__*/React.createElement("p", { style: { color: 'var(--tx-3)', fontSize: 11.5, marginTop: 10 } }, "No conversations yet"), /*#__PURE__*/React.createElement("p", { style: { color: 'var(--tx-3)', fontSize: 10.5, marginTop: 4 } }, "Start a new conversation to get started."));
    const renderSectionHdr = (label, count, iconName, color) => /*#__PURE__*/React.createElement("div", {
      style: { padding: '6px 14px 4px', display: 'flex', alignItems: 'center', gap: 6, position: 'sticky', top: 0, background: 'var(--bg-1)', zIndex: 1, borderBottom: '1px solid var(--border-0)' }
    }, iconName && /*#__PURE__*/React.createElement(I, { n: iconName, s: 11, c: color }), /*#__PURE__*/React.createElement("span", { style: { fontSize: 9.5, fontWeight: 700, color: color || 'var(--tx-2)', textTransform: 'uppercase', letterSpacing: '.5px' } }, label, " (", count, ")"));
    const teamNames = [...new Set(clientTeamDMs.map(d => d.teamName).filter(Boolean))];
    const ungroupedDMs = clientTeamDMs.filter(d => !d.teamName);
    return /*#__PURE__*/React.createElement(React.Fragment, null,
      providers.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null,
        (clientTeamDMs.length > 0) && renderSectionHdr("Providers", providers.length, "user", "var(--teal)"),
        ...providers.map((p, i) => {
          const isActive = inboxConvo === i;
          const name = p.providerName || p.providerProfile?.display_name || p.providerUserId || 'Provider';
          return /*#__PURE__*/React.createElement("div", {
            key: p.bridgeRoomId || i,
            onClick: () => openInboxConvo(i),
            style: { padding: '10px 14px', cursor: 'pointer', borderBottom: '1px solid var(--border-0)', background: isActive ? 'var(--bg-4)' : 'transparent', borderLeft: isActive ? '3px solid var(--teal)' : '3px solid transparent', transition: 'all .15s' },
            onMouseEnter: e => { if (!isActive) e.currentTarget.style.background = 'var(--bg-3)'; },
            onMouseLeave: e => { if (!isActive) e.currentTarget.style.background = 'transparent'; }
          }, /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 8 } },
            /*#__PURE__*/React.createElement("div", { style: { width: 32, height: 32, borderRadius: '50%', background: 'var(--teal-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--teal)', border: '2px solid var(--teal)', flexShrink: 0 } }, /*#__PURE__*/React.createElement(I, { n: "user", s: 14 })),
            /*#__PURE__*/React.createElement("div", { style: { flex: 1, minWidth: 0 } },
              /*#__PURE__*/React.createElement("span", { style: { fontSize: 12.5, fontWeight: isActive ? 700 : 500, display: 'block', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, name),
              /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 3, marginTop: 2, flexWrap: 'wrap' } },
                /*#__PURE__*/React.createElement("span", { style: { fontSize: 8, padding: '1px 5px', borderRadius: 10, background: 'var(--teal-dim)', color: 'var(--teal)', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '.5px' } }, "Provider"),
                /*#__PURE__*/React.createElement("span", { className: "tag tag-green", style: { fontSize: 7 } }, /*#__PURE__*/React.createElement(I, { n: "lock", s: 6 }), "E2EE")
              )
            )
          ));
        })
      ),
      clientTeamDMs.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null,
        ...teamNames.map(teamName => {
          const tDMs = clientTeamDMs.filter(d => d.teamName === teamName);
          return /*#__PURE__*/React.createElement(React.Fragment, { key: teamName },
            renderSectionHdr(teamName, tDMs.length, "users", "var(--purple)"),
            ...tDMs.map(dm => {
              const isActive = inboxConvo === dm.roomId;
              return /*#__PURE__*/React.createElement("div", {
                key: dm.roomId,
                onClick: () => openInboxConvo(dm.roomId),
                style: { padding: '10px 14px', cursor: 'pointer', borderBottom: '1px solid var(--border-0)', background: isActive ? 'var(--bg-4)' : 'transparent', borderLeft: isActive ? '3px solid var(--purple)' : '3px solid transparent', transition: 'all .15s' },
                onMouseEnter: e => { if (!isActive) e.currentTarget.style.background = 'var(--bg-3)'; },
                onMouseLeave: e => { if (!isActive) e.currentTarget.style.background = 'transparent'; }
              }, /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                /*#__PURE__*/React.createElement("div", { style: { width: 32, height: 32, borderRadius: '50%', background: 'var(--purple-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--purple)', border: '2px solid var(--purple)', flexShrink: 0 } }, /*#__PURE__*/React.createElement(I, { n: "user", s: 14 })),
                /*#__PURE__*/React.createElement("div", { style: { flex: 1, minWidth: 0 } },
                  /*#__PURE__*/React.createElement("span", { style: { fontSize: 12.5, fontWeight: isActive ? 700 : 500, display: 'block', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, dm.peerName || dm.peerId),
                  /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 3, marginTop: 2 } },
                    /*#__PURE__*/React.createElement("span", { style: { fontSize: 8, padding: '1px 5px', borderRadius: 10, background: 'var(--purple-dim)', color: 'var(--purple)', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '.5px' } }, "DM"),
                    /*#__PURE__*/React.createElement(ConnectionBadges, { userType: dm.peerType || 'provider', teamName: dm.teamName, teamColors: teamColorsList, size: "xs" })
                  )
                )
              ));
            })
          );
        }),
        ungroupedDMs.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null,
          teamNames.length > 0 && renderSectionHdr("Other DMs", ungroupedDMs.length, "users", "var(--purple)"),
          ...ungroupedDMs.map(dm => {
            const isActive = inboxConvo === dm.roomId;
            return /*#__PURE__*/React.createElement("div", {
              key: dm.roomId,
              onClick: () => openInboxConvo(dm.roomId),
              style: { padding: '10px 14px', cursor: 'pointer', borderBottom: '1px solid var(--border-0)', background: isActive ? 'var(--bg-4)' : 'transparent', borderLeft: isActive ? '3px solid var(--purple)' : '3px solid transparent', transition: 'all .15s' },
              onMouseEnter: e => { if (!isActive) e.currentTarget.style.background = 'var(--bg-3)'; },
              onMouseLeave: e => { if (!isActive) e.currentTarget.style.background = 'transparent'; }
            }, /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 8 } },
              /*#__PURE__*/React.createElement("div", { style: { width: 32, height: 32, borderRadius: '50%', background: 'var(--purple-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--purple)', border: '2px solid var(--purple)', flexShrink: 0 } }, /*#__PURE__*/React.createElement(I, { n: "user", s: 14 })),
              /*#__PURE__*/React.createElement("div", { style: { flex: 1, minWidth: 0 } },
                /*#__PURE__*/React.createElement("span", { style: { fontSize: 12.5, fontWeight: isActive ? 700 : 500, display: 'block', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, dm.peerName || dm.peerId),
                /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 3, marginTop: 2 } },
                  /*#__PURE__*/React.createElement("span", { style: { fontSize: 8, padding: '1px 5px', borderRadius: 10, background: 'var(--purple-dim)', color: 'var(--purple)', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '.5px' } }, "DM")
                )
              )
            ));
          })
        )
      )
    );
  })())), /*#__PURE__*/React.createElement("div", {
    className: "inbox-chat"
  }, inboxConvo !== null && (typeof inboxConvo === 'string' || providers[inboxConvo]) ? (() => {
    const isTeamDM = typeof inboxConvo === 'string';
    const p = isTeamDM ? null : providers[inboxConvo];
    const dm = isTeamDM ? clientTeamDMs.find(d => d.roomId === inboxConvo) : null;
    const chatName = isTeamDM ? (dm?.peerName || dm?.peerId || 'Team Member') : (p?.providerName || p?.providerUserId || 'Unknown');
    const avatarClr = isTeamDM ? 'purple' : 'gold';
    return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      className: "inbox-chat-hdr"
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        width: 32,
        height: 32,
        borderRadius: '50%',
        background: `var(--${avatarClr}-dim)`,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: `var(--${avatarClr})`,
        border: `2px solid var(--${avatarClr})`
      }
    }, !isTeamDM && p?.providerProfile?.org_membership?.verified ? /*#__PURE__*/React.createElement(I, {
      n: "shieldCheck",
      s: 14
    }) : /*#__PURE__*/React.createElement(I, {
      n: "user",
      s: 14
    })), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        minWidth: 0
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 14,
        fontWeight: 700,
        display: 'block'
      }
    }, chatName), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        flexWrap: 'wrap'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: "tag tag-green",
      style: {
        fontSize: 8
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "lock",
      s: 8
    }), "E2EE"), isTeamDM ? /*#__PURE__*/React.createElement(ConnectionBadges, {
      userType: dm?.peerType || 'provider',
      teamName: dm?.teamName,
      size: "xs"
    }) : /*#__PURE__*/React.createElement(ConnectionBadges, {
      userType: "provider",
      orgName: p?.providerProfile?.org_membership?.verified ? p.providerProfile.org_membership.org_name : null,
      orgType: p?.providerProfile?.org_membership?.org_type,
      teamName: (() => { const t = myTeams.find(t => (t.members || []).some(m => m.userId === p?.providerUserId)); return t?.name || null; })(),
      verified: p?.providerProfile?.org_membership?.verified,
      role: p?.providerProfile?.org_membership?.role,
      size: "xs"
    }), !isTeamDM && p?.providerProfile?.title && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-2)'
      }
    }, p.providerProfile.title))), !isTeamDM && p && /*#__PURE__*/React.createElement("button", {
      onClick: () => openBridge(p.bridgeRoomId),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "share",
      s: 11
    }), "Bridge"), /*#__PURE__*/React.createElement("button", {
      onClick: () => loadInboxMessages(isTeamDM ? inboxConvo : p.bridgeRoomId),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "refresh-cw",
      s: 11
    }))), /*#__PURE__*/React.createElement("div", {
      className: "inbox-msgs"
    }, inboxMessages.length === 0 ? /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        flexDirection: 'column'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "msg",
      s: 32,
      c: "var(--tx-3)"
    }), /*#__PURE__*/React.createElement("p", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 12,
        marginTop: 10
      }
    }, "No messages yet"), /*#__PURE__*/React.createElement("p", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 11,
        marginTop: 4
      }
    }, "Start the conversation below")) : [...inboxMessages].reverse().map((msg, i) => {
      const isOwn = msg.sender === svc.userId;
      return /*#__PURE__*/React.createElement("div", {
        key: msg.id || i,
        style: {
          display: 'flex',
          flexDirection: 'column',
          alignItems: isOwn ? 'flex-end' : 'flex-start',
          marginBottom: 4
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          maxWidth: '75%',
          padding: '10px 14px',
          borderRadius: isOwn ? '14px 14px 4px 14px' : '14px 14px 14px 4px',
          background: isOwn ? 'var(--teal-dim)' : 'var(--bg-3)',
          border: `1px solid ${isOwn ? 'rgba(62,201,176,.2)' : 'var(--border-0)'}`,
          transition: 'transform .1s'
        }
      }, /*#__PURE__*/React.createElement("p", {
        style: {
          fontSize: 12.5,
          color: 'var(--tx-0)',
          lineHeight: 1.5,
          wordBreak: 'break-word'
        }
      }, msg.content?.body)), /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: 4,
          marginTop: 3,
          padding: '0 6px'
        }
      }, /*#__PURE__*/React.createElement("span", {
        style: {
          fontFamily: 'var(--mono)',
          fontSize: 9,
          color: isOwn ? 'var(--teal)' : 'var(--gold)'
        }
      }, isOwn ? 'You' : p.providerName || msg.sender), /*#__PURE__*/React.createElement("span", {
        style: {
          fontFamily: 'var(--mono)',
          fontSize: 8,
          color: 'var(--tx-3)'
        }
      }, msg.ts ? new Date(msg.ts).toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      }) : '')));
    })), /*#__PURE__*/React.createElement("div", {
      className: "inbox-compose"
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("input", {
      value: inboxMsgText,
      onChange: e => setInboxMsgText(e.target.value),
      placeholder: "Type a message (E2EE)...",
      onKeyDown: e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSendInboxMsg();
        }
      },
      style: {
        flex: 1,
        borderRadius: 20,
        padding: '10px 18px'
      }
    }), /*#__PURE__*/React.createElement("button", {
      onClick: handleSendInboxMsg,
      className: "b-pri",
      disabled: !inboxMsgText.trim(),
      style: {
        borderRadius: 20,
        width: 42,
        height: 42,
        padding: 0,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "send",
      s: 16
    })))));
  })() : /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      flexDirection: 'column'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 64,
      height: 64,
      borderRadius: '50%',
      background: 'var(--teal-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--teal)',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "inbox",
    s: 28
  })), /*#__PURE__*/React.createElement("h3", {
    style: {
      fontSize: 16,
      fontWeight: 700,
      marginBottom: 6
    }
  }, "Your Inbox"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      fontSize: 12,
      maxWidth: 280,
      textAlign: 'center',
      lineHeight: 1.6
    }
  }, providers.length > 0 ? 'Select a conversation from the left to start chatting with your providers.' : 'Add a provider to begin your first encrypted conversation.'), providers.length === 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => setAddProviderModal(true),
    className: "b-pri",
    style: {
      marginTop: 14,
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "Add Provider"))))), view === 'bridge' && activeBridge && activeProvider && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setView('providers');
      setActiveBridge(null);
    },
    className: "b-gho b-sm",
    style: {
      marginBottom: 14,
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "back",
    s: 13
  }), "Back"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 20,
      fontWeight: 700
    }
  }, "Bridge: ", activeProvider.providerName || activeProvider.providerUserId), activeProvider.providerProfile?.title && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: 'var(--tx-2)',
      display: 'block',
      marginTop: 2
    }
  }, activeProvider.providerProfile.title), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginTop: 4,
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green"
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 9
  }), "Megolm + AES-GCM"), activeProvider.providerProfile?.org_membership?.verified && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-blue"
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 9
  }), activeProvider.providerProfile.org_membership.org_name), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 9.5,
      color: 'var(--tx-3)'
    }
  }, activeBridge))), /*#__PURE__*/React.createElement("button", {
    onClick: () => setHardRevokeTarget(activeProviderIdx),
    className: "b-red b-sm"
  }, /*#__PURE__*/React.createElement(I, {
    n: "zap",
    s: 12
  }), "Hard Revoke")), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: activeBridge,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Bridge Room",
    members: [{ userId: svc.userId, role: 'client' }, { userId: activeProvider.providerUserId, role: 'provider' }],
    extra: [{ label: 'Bridge type', value: 'Shared room between you and this provider. Data you share here is visible to both parties.' }, { label: 'Your power level', value: activeProvider._bridgeMeta?.client === svc.userId ? '100 (admin)' : '50' }]
  }), activeProvider.providerProfile?.org_membership?.verified && /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--blue-dim)',
      border: '1px solid rgba(91,156,245,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 16,
      display: 'flex',
      alignItems: 'center',
      gap: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 28,
      height: 28,
      borderRadius: '50%',
      background: 'var(--bg-3)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--blue)',
      border: '2px solid var(--blue)'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 14
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 700,
      color: 'var(--blue)'
    }
  }, activeProvider.providerProfile.org_membership.org_name), activeProvider.providerProfile.org_membership.email_verified ? /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green",
    style: {
      fontSize: 7.5,
      padding: '1px 5px'
    }
  }, "EMAIL VERIFIED") : /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green",
    style: {
      fontSize: 7.5,
      padding: '1px 5px'
    }
  }, "VERIFIED")), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      fontFamily: 'var(--mono)'
    }
  }, activeProvider.providerProfile.org_membership.org_type ? (ORG_TYPE_LABELS[activeProvider.providerProfile.org_membership.org_type] || activeProvider.providerProfile.org_membership.org_type) + ' · ' : '', activeProvider.providerProfile.org_membership.role), activeProvider.providerProfile.org_membership.verified_domain && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9,
      color: 'var(--green)',
      fontFamily: 'var(--mono)',
      display: 'block',
      marginTop: 2
    }
  }, "@", activeProvider.providerProfile.org_membership.verified_domain)), activeProvider.providerProfile.credentials && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9.5,
      color: 'var(--tx-2)',
      fontFamily: 'var(--mono)'
    }
  }, activeProvider.providerProfile.credentials)), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CURRENTLY SHARED"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexWrap: 'wrap',
      gap: 6,
      marginTop: 4
    }
  }, allFields.filter(f => activeProvider.sharedFields?.[f.key]).map(f => /*#__PURE__*/React.createElement("span", {
    key: f.key,
    className: "tag tag-blue"
  }, f.label)), Object.values(activeProvider.sharedFields || {}).filter(Boolean).length === 0 && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: 'var(--tx-3)'
    }
  }, "No fields shared"))), /*#__PURE__*/React.createElement("div", {
    className: "card"
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "MESSAGES"), /*#__PURE__*/React.createElement("div", {
    style: {
      maxHeight: 280,
      overflow: 'auto',
      marginBottom: 12
    }
  }, bridgeMessages.length === 0 ? /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 12,
      padding: '14px 0',
      textAlign: 'center'
    }
  }, "No messages yet") : bridgeMessages.map((msg, i) => /*#__PURE__*/React.createElement("div", {
    key: msg.id || i,
    style: {
      padding: '8px 0',
      borderBottom: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      marginBottom: 3
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10,
      color: msg.sender === svc.userId ? 'var(--teal)' : 'var(--gold)'
    }
  }, msg.sender === svc.userId ? 'You' : msg.sender), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 9,
      color: 'var(--tx-3)'
    }
  }, msg.ts ? new Date(msg.ts).toLocaleString() : '')), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12.5,
      color: 'var(--tx-1)'
    }
  }, msg.content?.body)))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("input", {
    value: msgText,
    onChange: e => setMsgText(e.target.value),
    placeholder: "Message (E2EE)...",
    onKeyDown: e => {
      if (e.key === 'Enter' && !e.shiftKey) handleSendBridgeMsg();
    },
    style: {
      flex: 1
    }
  }), /*#__PURE__*/React.createElement("button", {
    onClick: handleSendBridgeMsg,
    className: "b-pri"
  }, /*#__PURE__*/React.createElement(I, {
    n: "send",
    s: 13
  }))))), view === 'activity' && !activeBridge && /*#__PURE__*/React.createElement(ActivityStream, {
    session: session
  }), view === 'transparency' && !activeBridge && /*#__PURE__*/React.createElement(TransparencyPage, {
    onBack: () => setView('dashboard')
  })), /*#__PURE__*/React.createElement(Modal, {
    open: shareContactModal,
    onClose: () => setShareContactModal(false),
    title: "Share My Details",
    w: 400
  }, /*#__PURE__*/React.createElement("div", {
    style: { background: 'var(--bg-1)', border: '1px solid var(--border-1)', borderRadius: 'var(--r-lg)', padding: '14px 16px', marginBottom: 16 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 15, fontWeight: 700, color: 'var(--tx-0)', marginBottom: 4 }
  }, vaultData.full_name || svc.userId?.split(':')[0]?.replace('@', '') || 'Anonymous'),
  vaultData.email && /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 12, color: 'var(--tx-1)', marginBottom: 2, display: 'flex', alignItems: 'center', gap: 6 }
  }, /*#__PURE__*/React.createElement(I, { n: "mail", s: 12, c: "var(--tx-2)" }), vaultData.email),
  vaultData.phone && /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 12, color: 'var(--tx-1)', marginBottom: 2, display: 'flex', alignItems: 'center', gap: 6 }
  }, /*#__PURE__*/React.createElement(I, { n: "phone", s: 12, c: "var(--tx-2)" }), vaultData.phone),
  /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 10, color: 'var(--tx-3)', fontFamily: 'var(--mono)', marginTop: 6 }
  }, svc.userId)),
  !vaultData.full_name && !vaultData.email && !vaultData.phone && /*#__PURE__*/React.createElement("p", {
    style: { fontSize: 11, color: 'var(--tx-2)', fontStyle: 'italic', marginBottom: 12 }
  }, "Add your name, email, or phone in My Vault to include them when sharing."),
  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 8 }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: copyContact,
    style: { flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, padding: '10px 0', background: 'var(--bg-3)', border: '1px solid var(--border-1)', borderRadius: 'var(--r)', cursor: 'pointer', color: copiedField === 'contact' ? 'var(--green)' : 'var(--tx-1)', fontSize: 12, fontWeight: 600, transition: 'all .2s' }
  }, /*#__PURE__*/React.createElement(I, { n: copiedField === 'contact' ? "check" : "copy", s: 14 }), copiedField === 'contact' ? 'Copied!' : 'Copy'),
  /*#__PURE__*/React.createElement("button", {
    onClick: shareContactViaSMS,
    style: { flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, padding: '10px 0', background: 'var(--bg-3)', border: '1px solid var(--border-1)', borderRadius: 'var(--r)', cursor: 'pointer', color: 'var(--tx-1)', fontSize: 12, fontWeight: 600, transition: 'all .2s' }
  }, /*#__PURE__*/React.createElement(I, { n: "msg", s: 14 }), "Text"),
  /*#__PURE__*/React.createElement("button", {
    onClick: shareContactViaEmail,
    style: { flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, padding: '10px 0', background: 'var(--bg-3)', border: '1px solid var(--border-1)', borderRadius: 'var(--r)', cursor: 'pointer', color: 'var(--tx-1)', fontSize: 12, fontWeight: 600, transition: 'all .2s' }
  }, /*#__PURE__*/React.createElement(I, { n: "mail", s: 14 }), "Email"))),

  /*#__PURE__*/React.createElement(Modal, {
    open: editModal,
    onClose: () => setEditModal(false),
    title: "Edit Vault Data",
    w: 540
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Changes to shared fields are re-encrypted with new keys per provider. Each edit emits EO operations (INS/ALT/NUL) to the vault timeline."), allCategories.map(cat => {
    const fields = allFields.filter(f => f.category === cat);
    if (!fields.length) return null;
    return /*#__PURE__*/React.createElement("div", {
      key: cat,
      style: {
        marginBottom: 14
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: "section-label"
    }, (CAT_LABELS[cat] || cat.charAt(0).toUpperCase() + cat.slice(1)).toUpperCase()), fields.map(f => /*#__PURE__*/React.createElement("div", {
      key: f.key,
      style: {
        marginBottom: 8
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4,
        marginBottom: 3
      }
    }, /*#__PURE__*/React.createElement("label", {
      style: {
        fontSize: 11.5,
        color: 'var(--tx-1)'
      }
    }, f.label), f.sensitive && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-red",
      style: {
        fontSize: 8
      }
    }, "SENSITIVE"), f.custom && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-purple",
      style: {
        fontSize: 8
      }
    }, "CUSTOM"), f.framework && /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${FRAMEWORK_BY_ID[f.framework]?.accent || 'blue'}`,
      style: {
        fontSize: 8
      }
    }, f.frameworkName)), ['case_notes', 'history', 'medical', 'documents'].includes(f.key) || f.custom && f.category === 'case' ? /*#__PURE__*/React.createElement("textarea", {
      value: editData[f.key] || '',
      onChange: e => setEditData({
        ...editData,
        [f.key]: e.target.value
      }),
      placeholder: `Enter ${f.label.toLowerCase()}...`,
      style: {
        minHeight: 50
      }
    }) : /*#__PURE__*/React.createElement("input", {
      value: editData[f.key] || '',
      onChange: e => setEditData({
        ...editData,
        [f.key]: e.target.value
      }),
      placeholder: `Enter ${f.label.toLowerCase()}...`
    }))));
  }), /*#__PURE__*/React.createElement("button", {
    onClick: handleEditSave,
    className: "b-pri",
    style: {
      width: '100%'
    }
  }, "Save & Re-encrypt Shared Fields")), /*#__PURE__*/React.createElement(Modal, {
    open: addProviderModal,
    onClose: () => setAddProviderModal(false),
    title: "Add Provider"
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Creates a new encrypted bridge room and invites the provider. No data shared until you toggle fields on."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "PROVIDER MATRIX ID"), /*#__PURE__*/React.createElement("input", {
    value: newProviderId,
    onChange: e => setNewProviderId(e.target.value),
    placeholder: "@provider:matrix.org"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.5
    }
  }, "Bridge uses Megolm + per-field AES-256-GCM. Keys destroyed on revocation.")), /*#__PURE__*/React.createElement("button", {
    onClick: handleAddProvider,
    className: "b-pri",
    style: {
      width: '100%'
    }
  }, "Create Bridge Room")), /*#__PURE__*/React.createElement(Modal, {
    open: newTeamDMModal,
    onClose: () => { setNewTeamDMModal(false); setNewDMTarget(null); },
    title: "New Team Member DM",
    w: 480
  }, /*#__PURE__*/React.createElement("p", {
    style: { fontSize: 12, color: 'var(--tx-1)', marginBottom: 14, lineHeight: 1.6 }
  }, "Start an encrypted direct conversation with a team member."),
  clientTeamMemberContacts.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: { textAlign: 'center', padding: '20px 0', color: 'var(--tx-3)', fontSize: 12 }
  }, "No team members found. Join a team first.") : /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', flexDirection: 'column', gap: 6, maxHeight: 320, overflow: 'auto', marginBottom: 16 }
  }, clientTeamMemberContacts.map(c => /*#__PURE__*/React.createElement("div", {
    key: c.userId,
    onClick: () => setNewDMTarget(c),
    style: {
      padding: '10px 14px', borderRadius: 'var(--r)', border: `1px solid ${newDMTarget?.userId === c.userId ? 'var(--purple)' : 'var(--border-0)'}`,
      background: newDMTarget?.userId === c.userId ? 'var(--purple-dim)' : 'var(--bg-2)', cursor: 'pointer', transition: 'all .15s'
    }
  }, /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 8, justifyContent: 'space-between' } },
    /*#__PURE__*/React.createElement("div", { style: { flex: 1, minWidth: 0 } },
      /*#__PURE__*/React.createElement("span", { style: { fontSize: 13, fontWeight: 600, display: 'block' } }, c.displayName),
      /*#__PURE__*/React.createElement("div", { style: { marginTop: 3 } },
        /*#__PURE__*/React.createElement(ConnectionBadges, { userType: "provider", teamName: c.teamName, role: c.role, size: "xs" }))),
    c.hasDM && /*#__PURE__*/React.createElement("span", { className: "tag tag-green", style: { fontSize: 8 } }, "DM exists"))))),
  newDMTarget && /*#__PURE__*/React.createElement("button", {
    onClick: () => startClientTeamDM(newDMTarget.userId, newDMTarget.displayName, newDMTarget.teamName, newDMTarget.teamRoomId),
    className: "b-pri",
    style: { width: '100%', padding: 12, fontSize: 14 }
  }, /*#__PURE__*/React.createElement(I, { n: "msg", s: 16 }), " Start Conversation with ", newDMTarget.displayName)), /*#__PURE__*/React.createElement(Modal, {
    open: !!obsModal,
    onClose: () => setObsModal(null),
    title: obsModal?.question || 'Record Observation',
    w: 500
  }, obsModal && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "DATE"), /*#__PURE__*/React.createElement("input", {
    type: "date",
    value: obsDate,
    onChange: e => setObsDate(e.target.value)
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "RESPONSE"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4
    }
  }, obsModal.options.map(o => /*#__PURE__*/React.createElement("div", {
    key: o.v,
    onClick: () => setObsValue(o.v),
    style: {
      padding: '10px 14px',
      borderRadius: 'var(--r)',
      cursor: 'pointer',
      border: `1px solid ${obsValue === o.v ? 'var(--teal)' : 'var(--border-1)'}`,
      background: obsValue === o.v ? 'var(--teal-dim)' : 'var(--bg-3)',
      transition: 'all .15s'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12.5,
      color: obsValue === o.v ? 'var(--teal)' : 'var(--tx-1)'
    }
  }, o.l))))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ADDITIONAL NOTES (OPTIONAL)"), /*#__PURE__*/React.createElement("textarea", {
    value: obsFreeText,
    onChange: e => setObsFreeText(e.target.value),
    placeholder: "Any additional context...",
    style: {
      minHeight: 50
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      borderRadius: 'var(--r)',
      padding: '8px 12px',
      marginBottom: 14,
      fontSize: 11,
      color: 'var(--teal)'
    }
  }, "This observation will be recorded as a GIVEN event in your vault \u2014 immutable, append-only."), /*#__PURE__*/React.createElement("button", {
    onClick: handleRecordObservation,
    className: "b-pri",
    disabled: !obsValue,
    style: {
      width: '100%'
    }
  }, "Record Observation"))), /*#__PURE__*/React.createElement(Modal, {
    open: hardRevokeTarget !== null,
    onClose: () => setHardRevokeTarget(null),
    title: "Hard Revoke",
    w: 440
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--red-dim)',
      border: '1px solid rgba(232,93,93,.15)',
      borderRadius: 'var(--r)',
      padding: '12px 16px',
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12.5,
      color: 'var(--red)',
      fontWeight: 600,
      marginBottom: 4
    }
  }, "Destructive operation"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, "Current bridge will be ", /*#__PURE__*/React.createElement("strong", null, "tombstoned"), ", provider ", /*#__PURE__*/React.createElement("strong", null, "kicked"), ". A new bridge with ", /*#__PURE__*/React.createElement("strong", null, "fresh encryption keys"), " is created for any still-shared fields.")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-2)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", null, "Caveat:"), " If the provider previously decrypted and cached data, we cannot delete it from their device. This prevents future access, not retroactive erasure."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setHardRevokeTarget(null),
    className: "b-gho",
    style: {
      flex: 1
    }
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleHardRevoke(hardRevokeTarget),
    className: "b-red",
    style: {
      flex: 1
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "zap",
    s: 13
  }), "Execute"))), /*#__PURE__*/React.createElement(Modal, {
    open: !!clientSharingConsentModal,
    onClose: () => setClientSharingConsentModal(null),
    title: "Content Sharing Preference",
    w: 480
  }, clientSharingConsentModal && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--gold-dim)',
      border: '1px solid rgba(218,165,32,.15)',
      borderRadius: 'var(--r)',
      padding: '14px 18px',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 16,
    c: "var(--gold)"
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.7,
      margin: 0
    }
  }, "As a member of ", /*#__PURE__*/React.createElement("strong", null, clientSharingConsentModal.team?.name || 'this team'), ", content created about the individuals this team serves may be shared with you."))), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 13,
      fontWeight: 600,
      color: 'var(--tx-0)',
      marginBottom: 6
    }
  }, "Would you like to withhold content about individuals from being shared with you?"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-2)',
      lineHeight: 1.6,
      marginBottom: 18
    }
  }, "By default, relevant content is shared with all team members to support coordination. If you choose to withhold, you will not receive content created about individuals served by this team."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => handleClientSharingConsent(clientSharingConsentModal.team, false),
    className: "b-pri",
    style: {
      width: '100%',
      padding: '12px 16px',
      fontSize: 13,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "check",
    s: 14
  }), " No, share content with me"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleClientSharingConsent(clientSharingConsentModal.team, true),
    className: "b-gho",
    style: {
      width: '100%',
      padding: '12px 16px',
      fontSize: 13,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 6,
      color: 'var(--red)'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 14
  }), " Yes, withhold content from me")), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginTop: 14
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-3)',
      lineHeight: 1.6,
      margin: 0
    }
  }, "You can change this preference at any time from your teams view. This choice is recorded as an epistemic operation for full auditability.")))), /*#__PURE__*/React.createElement(Modal, {
    open: addFieldModal,
    onClose: () => {
      setAddFieldModal(false);
      setNewFieldLabel('');
      setNewFieldCategory('details');
      setNewFieldSensitive(false);
      setNewFieldDefinition('');
    },
    title: "Add Custom Field",
    w: 440
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Create a new field to store any data you want in your vault. Custom fields work just like built-in fields \u2014 encrypted, shareable, and fully under your control."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "FIELD NAME"), /*#__PURE__*/React.createElement("input", {
    value: newFieldLabel,
    onChange: e => setNewFieldLabel(e.target.value),
    placeholder: "e.g. Emergency Contact, Preferred Language...",
    autoFocus: true,
    onKeyDown: e => {
      if (e.key === 'Enter' && newFieldLabel.trim()) handleAddCustomField();
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CATEGORY"), /*#__PURE__*/React.createElement("select", {
    value: newFieldCategory,
    onChange: e => setNewFieldCategory(e.target.value),
    style: {
      width: '100%'
    }
  }, FIELD_CATEGORIES.map(c => /*#__PURE__*/React.createElement("option", {
    key: c,
    value: c
  }, CAT_LABELS[c])))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 500
    }
  }, "Sensitive field"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-2)',
      marginTop: 2
    }
  }, "Sensitive fields are masked in the vault view")), /*#__PURE__*/React.createElement(Toggle, {
    on: newFieldSensitive,
    onChange: () => setNewFieldSensitive(!newFieldSensitive)
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "DEFINITION *"), /*#__PURE__*/React.createElement("textarea", {
    value: newFieldDefinition,
    onChange: e => setNewFieldDefinition(e.target.value),
    placeholder: "Describe what this field means and how it should be interpreted (min 20 characters)...",
    rows: 3,
    style: {
      width: '100%',
      resize: 'vertical'
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10,
      color: newFieldDefinition.trim().length >= 20 ? 'var(--green)' : 'var(--tx-3)',
      marginTop: 3,
      textAlign: 'right'
    }
  }, newFieldDefinition.trim().length, "/20 characters min")), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--purple-dim)',
      border: '1px solid rgba(167,139,250,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.5
    }
  }, "Custom fields are encrypted with AES-256-GCM, stored in your vault, and can be selectively shared with providers \u2014 identical to built-in fields.")), /*#__PURE__*/React.createElement("button", {
    onClick: handleAddCustomField,
    className: "b-pri",
    disabled: !newFieldLabel.trim() || newFieldDefinition.trim().length < 20,
    style: {
      width: '100%'
    }
  }, "Create Field")), /*#__PURE__*/React.createElement(Modal, {
    open: frameworkModal,
    onClose: () => setFrameworkModal(false),
    title: "Data Field Frameworks",
    w: 640
  }, /*#__PURE__*/React.createElement(FrameworkTogglePanel, {
    enabledFrameworks: enabledFrameworks,
    onToggle: async next => {
      setEnabledFrameworks(next);
      await saveSnapshot(undefined, undefined, undefined, undefined, next);
      const delta = next.length - enabledFrameworks.length;
      if (delta > 0) showToast(`Framework enabled — ${getFrameworkFields(next).length} total fields`, 'success');else if (delta < 0) showToast('Framework disabled', 'warn');
    }
  })));
};

/* ═══════════════════ DATA TABLE COMPONENTS ═══════════════════ */

// Config objects for data table display
const DT_STATUS_CFG = {
  imported: {
    l: 'Imported',
    bg: 'var(--gold-dim)',
    c: 'var(--gold)'
  },
  invited: {
    l: 'Invited',
    bg: 'var(--teal-dim)',
    c: 'var(--teal)'
  },
  joined: {
    l: 'Joined',
    bg: 'var(--green-dim)',
    c: 'var(--green)'
  },
  claimed: {
    l: 'Claimed',
    bg: 'var(--green-dim)',
    c: 'var(--green)'
  },
  active: {
    l: 'Active',
    bg: 'var(--green-dim)',
    c: 'var(--green)'
  },
  revoked: {
    l: 'Revoked',
    bg: 'var(--red-dim)',
    c: 'var(--red)'
  }
};
const DT_PRI_CFG = {
  critical: 'tag-red',
  high: 'tag-gold',
  medium: 'tag-teal',
  low: 'tag-purple',
  none: 'tag-purple'
};
const DT_NEED_COLORS = {
  housing: 'tag-blue',
  medical: 'tag-purple',
  legal: 'tag-gold',
  employment: 'tag-teal',
  substance: 'tag-orange',
  outreach: 'tag-purple',
  childcare: 'tag-green'
};
const DT_OP_CFG = {
  sovereign: {
    l: 'Sovereign',
    cls: 'tag-purple'
  },
  attested: {
    l: 'Attested',
    cls: 'tag-teal'
  },
  contributed: {
    l: 'Contributed',
    cls: 'tag-blue'
  },
  published: {
    l: 'Published',
    cls: 'tag-green'
  }
};
const DT_PROV_COLORS = {
  restocked: 'var(--green)',
  allocated: 'var(--teal)',
  returned: 'var(--blue)',
  expired: 'var(--gold)',
  capacity_reduced: 'var(--red)',
  capacity_restored: 'var(--green)',
  completed: 'var(--green)'
};

// Small helper components
const DtEo = ({
  op
}) => /*#__PURE__*/React.createElement("span", {
  className: "dt-eo"
}, op);
const DtRoom = ({
  room
}) => {
  if (!room) return /*#__PURE__*/React.createElement("span", {
    className: "dt-room"
  }, "no room");
  const short = room.replace(/!|:[\w.-]+/g, '').substring(0, 22);
  return /*#__PURE__*/React.createElement("span", {
    className: "dt-room"
  }, '⬡ ' + short);
};
const DtDiscBar = ({
  level = 0
}) => {
  const segs = [];
  for (let i = 0; i < 5; i++) segs.push(/*#__PURE__*/React.createElement("span", {
    key: i,
    className: 'seg' + (i < Math.round(level * 5) ? ' on' : '')
  }));
  return /*#__PURE__*/React.createElement("div", {
    className: "dt-disc"
  }, segs, /*#__PURE__*/React.createElement("span", {
    className: "pct"
  }, Math.round(level * 100), "%"));
};
const DtUtilBar = ({
  pct = 0
}) => {
  const c = pct > .9 ? 'var(--red)' : pct > .7 ? 'var(--gold)' : 'var(--green)';
  return /*#__PURE__*/React.createElement("div", {
    className: "dt-util"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-util-track"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-util-fill",
    style: {
      width: pct * 100 + '%',
      background: c
    }
  })), /*#__PURE__*/React.createElement("span", {
    className: "dt-util-label",
    style: {
      color: c
    }
  }, Math.round(pct * 100), "%"));
};
const DtLock = () => /*#__PURE__*/React.createElement("svg", {
  width: "10",
  height: "10",
  viewBox: "0 0 16 16"
}, /*#__PURE__*/React.createElement("rect", {
  x: "2",
  y: "7",
  width: "12",
  height: "8",
  rx: "2",
  fill: "currentColor"
}), /*#__PURE__*/React.createElement("path", {
  d: "M5 7V5a3 3 0 016 0v2",
  stroke: "currentColor",
  strokeWidth: "1.5",
  fill: "none"
}));
const DtStatusBadge = ({
  status
}) => {
  const c = DT_STATUS_CFG[status] || DT_STATUS_CFG.imported;
  return /*#__PURE__*/React.createElement("span", {
    className: "tag",
    style: {
      background: c.bg,
      color: c.c,
      fontSize: 11
    }
  }, c.l);
};
const dtFmtDate = iso => {
  if (!iso) return '—';
  const d = new Date(iso),
    now = new Date(),
    diff = now - d;
  if (diff < 864e5) return 'Today';
  if (diff < 1728e5) return 'Yesterday';
  if (diff < 6048e5) return Math.floor(diff / 864e5) + 'd ago';
  return d.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric'
  });
};

/* ─── EditableCell — click-to-edit cell with blur save ─── */
const EditableCell = ({
  value,
  onSave,
  placeholder,
  type
}) => {
  const [editing, setEditing] = useState(false);
  const [draft, setDraft] = useState(value || '');
  const inputRef = useRef(null);
  useEffect(() => {
    setDraft(value || '');
  }, [value]);
  useEffect(() => {
    if (editing && inputRef.current) inputRef.current.focus();
  }, [editing]);
  const commit = () => {
    setEditing(false);
    if (draft !== (value || '')) onSave && onSave(draft);
  };
  if (editing) return /*#__PURE__*/React.createElement("input", {
    ref: inputRef,
    className: "dt-ecell-input",
    value: draft,
    onChange: e => setDraft(e.target.value),
    onBlur: commit,
    onKeyDown: e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        commit();
      }
      if (e.key === 'Escape') {
        setDraft(value || '');
        setEditing(false);
      }
    },
    onClick: e => e.stopPropagation()
  });
  return /*#__PURE__*/React.createElement("div", {
    className: "dt-ecell",
    title: "Double-click to edit",
    onDoubleClick: e => {
      e.stopPropagation();
      setEditing(true);
    }
  }, draft || /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--tx-3)',
      fontStyle: 'italic'
    }
  }, placeholder || '—'));
};

/* ─── Generic DataTable component (enhanced) ─── */
const DataTable = ({
  data,
  columns,
  groupOptions,
  defaultVisibleCols,
  onRowClick,
  renderCell,
  getVal,
  selectedId,
  label,
  selectable,
  onBulkAction,
  bulkActions,
  draggable,
  onReorder,
  onAddRow,
  addRowLabel,
  editable,
  onCellEdit
}) => {
  const [search, setSearch] = useState('');
  const [groupBy, setGroupBy] = useState('none');
  const [sortField, setSortField] = useState(null);
  const [sortDir, setSortDir] = useState('asc');
  const [visibleCols, setVisibleCols] = useState(defaultVisibleCols || columns.map(c => c.key));
  const [colDd, setColDd] = useState(false);
  const [grpDd, setGrpDd] = useState(false);
  // Multi-select
  const [selected, setSelected] = useState(new Set());
  // Drag reorder
  const [dragId, setDragId] = useState(null);
  const [dragOverId, setDragOverId] = useState(null);
  const visCols = columns.filter(c => c.fixed || visibleCols.includes(c.key));
  const extraColCount = (selectable ? 1 : 0) + (draggable ? 1 : 0);

  // Filter
  const filtered = data.filter(row => {
    if (!search) return true;
    const s = search.toLowerCase();
    return visCols.some(c => {
      const v = getVal(row, c.key);
      return v && String(v).toLowerCase().includes(s);
    });
  });

  // Sort
  const sorted = [...filtered];
  if (sortField) {
    sorted.sort((a, b) => {
      const va = getVal(a, sortField),
        vb = getVal(b, sortField);
      const cmp = String(va || '').localeCompare(String(vb || ''), undefined, {
        numeric: true
      });
      return sortDir === 'asc' ? cmp : -cmp;
    });
  }

  // Group
  let grouped;
  if (groupBy !== 'none') {
    grouped = {};
    sorted.forEach(row => {
      const gk = getVal(row, groupBy) || 'Other';
      if (!grouped[gk]) grouped[gk] = [];
      grouped[gk].push(row);
    });
  } else {
    grouped = {
      '__all': sorted
    };
  }
  const handleSort = key => {
    if (sortField === key) setSortDir(d => d === 'asc' ? 'desc' : 'asc');else {
      setSortField(key);
      setSortDir('asc');
    }
  };
  const toggleCol = key => {
    setVisibleCols(prev => prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]);
  };

  // Multi-select helpers
  const toggleSelect = (id, e) => {
    e && e.stopPropagation();
    setSelected(prev => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id);else next.add(id);
      return next;
    });
  };
  const toggleSelectAll = () => {
    if (selected.size === filtered.length) setSelected(new Set());else setSelected(new Set(filtered.map(r => r.id)));
  };
  const isAllSelected = filtered.length > 0 && selected.size === filtered.length;
  const isSomeSelected = selected.size > 0 && selected.size < filtered.length;

  // Drag handlers
  const handleDragStart = (e, id) => {
    setDragId(id);
    e.dataTransfer.effectAllowed = 'move';
  };
  const handleDragOver = (e, id) => {
    e.preventDefault();
    setDragOverId(id);
  };
  const handleDragEnd = () => {
    if (dragId && dragOverId && dragId !== dragOverId && onReorder) {
      const fromIdx = data.findIndex(r => r.id === dragId);
      const toIdx = data.findIndex(r => r.id === dragOverId);
      if (fromIdx >= 0 && toIdx >= 0) onReorder(fromIdx, toIdx);
    }
    setDragId(null);
    setDragOverId(null);
  };
  return /*#__PURE__*/React.createElement(React.Fragment, null, selectable && selected.size > 0 && /*#__PURE__*/React.createElement("div", {
    className: "dt-bulk-bar"
  }, /*#__PURE__*/React.createElement("span", {
    className: "dt-bulk-count"
  }, selected.size, " selected"), /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-xs",
    onClick: () => setSelected(new Set())
  }, "Clear"), /*#__PURE__*/React.createElement("div", {
    className: "dt-bulk-actions"
  }, (bulkActions || []).map(a => /*#__PURE__*/React.createElement("button", {
    key: a.id,
    className: a.cls || 'b-gho b-xs',
    onClick: () => {
      onBulkAction && onBulkAction(a.id, [...selected]);
      setSelected(new Set());
    }
  }, a.icon && /*#__PURE__*/React.createElement(I, {
    n: a.icon,
    s: 11
  }), a.label)))), /*#__PURE__*/React.createElement("div", {
    className: "dt-toolbar"
  }, /*#__PURE__*/React.createElement("input", {
    className: "dt-search",
    placeholder: `Search ${label || ''}...`,
    value: search,
    onChange: e => setSearch(e.target.value)
  }), groupOptions && /*#__PURE__*/React.createElement("div", {
    className: "dt-dd-wrap"
  }, /*#__PURE__*/React.createElement("button", {
    className: groupBy !== 'none' ? 'b-gho b-sm' : 'b-gho b-sm',
    style: groupBy !== 'none' ? {
      background: 'var(--green-dim)',
      color: 'var(--green)',
      borderColor: 'rgba(61,214,140,.2)'
    } : {},
    onClick: () => {
      setGrpDd(!grpDd);
      setColDd(false);
    }
  }, '≡ ' + (groupBy === 'none' ? 'Group' : (groupOptions.find(g => g.k === groupBy) || {}).l || groupBy)), grpDd && /*#__PURE__*/React.createElement("div", {
    className: "dt-dd"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-dd-label"
  }, "Group By"), groupOptions.map(g => /*#__PURE__*/React.createElement("div", {
    key: g.k,
    className: 'dt-dd-item' + (groupBy === g.k ? ' sel' : ''),
    onClick: () => {
      setGroupBy(g.k);
      setGrpDd(false);
    }
  }, g.l)))), /*#__PURE__*/React.createElement("div", {
    className: "dt-dd-wrap"
  }, /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-sm",
    onClick: () => {
      setColDd(!colDd);
      setGrpDd(false);
    }
  }, '⊞ Columns (' + visCols.length + ')'), colDd && /*#__PURE__*/React.createElement("div", {
    className: "dt-dd"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-dd-label"
  }, "Toggle Columns"), columns.map(c => {
    const on = c.fixed || visibleCols.includes(c.key);
    return /*#__PURE__*/React.createElement("div", {
      key: c.key,
      className: "dt-dd-item",
      style: c.fixed ? {
        opacity: .5
      } : {},
      onClick: () => !c.fixed && toggleCol(c.key)
    }, /*#__PURE__*/React.createElement("span", {
      className: 'dt-check' + (on ? ' on' : '')
    }, on ? '✓' : ''), c.label, c.fixed ? ' (always)' : '');
  }))), /*#__PURE__*/React.createElement("span", {
    className: "dt-toolbar-right"
  }, filtered.length, " ", label || 'rows')), /*#__PURE__*/React.createElement("div", {
    className: "dt-wrap"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-scroll"
  }, /*#__PURE__*/React.createElement("table", {
    className: "dt"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, draggable && /*#__PURE__*/React.createElement("th", {
    style: {
      width: 24,
      padding: '6px 4px'
    }
  }), selectable && /*#__PURE__*/React.createElement("th", {
    className: "dt-sel-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: 'dt-cb' + (isAllSelected ? ' checked' : isSomeSelected ? ' partial' : ''),
    onClick: toggleSelectAll
  }, isAllSelected ? '✓' : isSomeSelected ? '—' : '')), visCols.map(c => /*#__PURE__*/React.createElement("th", {
    key: c.key,
    onClick: () => handleSort(c.key)
  }, c.label, sortField === c.key ? sortDir === 'asc' ? ' ↑' : ' ↓' : '')))), /*#__PURE__*/React.createElement("tbody", null, Object.entries(grouped).map(([gName, rows]) => /*#__PURE__*/React.createElement(React.Fragment, {
    key: gName
  }, gName !== '__all' && /*#__PURE__*/React.createElement("tr", {
    className: "dt-grp"
  }, /*#__PURE__*/React.createElement("td", {
    colSpan: visCols.length + extraColCount
  }, '▾ ' + gName + ' (' + rows.length + ')')), rows.map(row => /*#__PURE__*/React.createElement("tr", {
    key: row.id,
    className: 'dt-row' + (selectedId === row.id ? ' selected' : '') + (row.status === 'revoked' ? ' revoked' : '') + (dragId === row.id ? ' dragging' : '') + (dragOverId === row.id ? ' drag-over' : ''),
    onClick: () => onRowClick && onRowClick(row),
    draggable: draggable ? true : undefined,
    onDragStart: draggable ? e => handleDragStart(e, row.id) : undefined,
    onDragOver: draggable ? e => handleDragOver(e, row.id) : undefined,
    onDragEnd: draggable ? handleDragEnd : undefined
  }, draggable && /*#__PURE__*/React.createElement("td", {
    className: "dt-drag-handle"
  }, "\u283F"), selectable && /*#__PURE__*/React.createElement("td", {
    className: "dt-sel-col"
  }, /*#__PURE__*/React.createElement("div", {
    className: 'dt-cb' + (selected.has(row.id) ? ' checked' : ''),
    onClick: e => toggleSelect(row.id, e)
  }, selected.has(row.id) ? '✓' : '')), visCols.map(col => /*#__PURE__*/React.createElement("td", {
    key: col.key
  }, editable && col.editable ? /*#__PURE__*/React.createElement(EditableCell, {
    value: getVal(row, col.key),
    placeholder: col.placeholder,
    onSave: v => onCellEdit && onCellEdit(row, col.key, v)
  }) : renderCell(row, col))))))))), onAddRow && /*#__PURE__*/React.createElement("div", {
    className: "dt-add-row",
    onClick: onAddRow
  }, "+ ", addRowLabel || 'Add row'))));
};

/* ─── Individual Side Panel ─── */
const IndividualPanel = ({
  row,
  notes,
  allocations,
  onClose,
  panelTab,
  setPanelTab,
  provenanceField,
  setProvenanceField,
  svc,
  onRestoreField
}) => {
  if (!row) return null;
  const indNotes = (notes || []).filter(n => n.indId === row.id);
  const indAllocs = (allocations || []).filter(a => a.indId === row.id);

  // ─── Load field EO change history from bridge room timeline ───
  const [fieldHistories, setFieldHistories] = React.useState({});
  React.useEffect(() => {
    if (!svc || !row.bridgeRoom) { setFieldHistories({}); return; }
    let cancelled = false;
    const load = async () => {
      try {
        const room = svc.client && svc.client.getRoom(row.bridgeRoom);
        if (!room) return;
        // Paginate backwards to capture history
        for (let i = 0; i < 3; i++) {
          const token = room.getLiveTimeline().getPaginationToken('b');
          if (!token) break;
          try { await svc.client.scrollback(room, 100); } catch (e) { break; }
        }
        const events = [];
        const timelineSets = room.getTimelineSets ? room.getTimelineSets() : [];
        if (timelineSets.length > 0) {
          const seen = new Set();
          for (const ts of timelineSets) {
            for (const tl of ts.getTimelines()) {
              for (const ev of tl.getEvents()) {
                if (!seen.has(ev.getId())) { seen.add(ev.getId()); events.push(ev); }
              }
            }
          }
        } else {
          for (const ev of room.getLiveTimeline().getEvents()) events.push(ev);
        }
        const hist = {};
        events.forEach(ev => {
          if (ev.getType && ev.getType() === EVT.OP) {
            const c = ev.getContent();
            if (c.target && c.target.startsWith('org.individuals.') && (c.op === 'ALT' || c.op === 'INS')) {
              const parts = c.target.split('.');
              const fieldKey = parts[2];
              if (fieldKey && fieldKey !== row.id) { // skip individual-level ops (roomId as fieldKey)
                if (!hist[fieldKey]) hist[fieldKey] = [];
                hist[fieldKey].push({ eo_op: c.op, from: c.operand?.from, to: c.operand?.to, at: c.ts || ev.getTs(), by: (c.created_by || ev.getSender() || '').split(':')[0]?.replace('@','') || '?' });
              }
            }
          }
        });
        // Sort each field history newest-first
        Object.keys(hist).forEach(k => hist[k].sort((a, b) => (b.at || 0) - (a.at || 0)));
        if (!cancelled) setFieldHistories(hist);
      } catch (e) { /* history load failed silently */ }
    };
    load();
    // Also refresh on new EO events
    const handler = e => { if (e.detail?.roomId === row.bridgeRoom) load(); };
    window.addEventListener('khora:eo', handler);
    return () => { cancelled = true; window.removeEventListener('khora:eo', handler); };
  }, [row.bridgeRoom, svc]);
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "dt-panel-overlay",
    onClick: onClose
  }), /*#__PURE__*/React.createElement("div", {
    className: "dt-panel"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-panel-head"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", null, row.name || row.alias || 'Unknown'), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      alignItems: 'center',
      marginTop: 6,
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement(DtStatusBadge, {
    status: row.status
  }), /*#__PURE__*/React.createElement(DtDiscBar, {
    level: row.disclosureLevel || 0
  }), /*#__PURE__*/React.createElement(DtRoom, {
    room: row.bridgeRoom
  }))), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    style: {
      background: 'none',
      border: 'none',
      cursor: 'pointer',
      fontSize: 20,
      color: 'var(--tx-2)'
    }
  }, "\u2715")), /*#__PURE__*/React.createElement("div", {
    className: "dt-panel-tabs"
  }, ['fields', 'notes', 'allocations'].map(t => /*#__PURE__*/React.createElement("button", {
    key: t,
    className: 'dt-panel-tab' + (panelTab === t ? ' active' : ''),
    onClick: () => setPanelTab(t)
  }, t === 'fields' ? 'Fields' : t === 'notes' ? `Notes (${indNotes.length})` : `Allocations (${indAllocs.length})`))), /*#__PURE__*/React.createElement("div", {
    className: "dt-panel-body"
  }, panelTab === 'fields' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "Schema Fields \u2014 click for provenance"), Object.entries(row.fields || {}).map(([key, f]) => /*#__PURE__*/React.createElement(React.Fragment, {
    key: key
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 12px',
      borderRadius: 'var(--r)',
      border: '1px solid var(--border-0)',
      marginBottom: 6,
      cursor: 'pointer',
      background: provenanceField === key ? 'var(--green-dim)' : 'var(--bg-2)',
      transition: 'all .15s'
    },
    onClick: () => setProvenanceField(provenanceField === key ? null : key)
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontWeight: 600,
      textTransform: 'uppercase',
      letterSpacing: '.05em',
      color: 'var(--tx-2)'
    }
  }, key.replace(/_/g, ' ')), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4
    }
  }, f.eo_op && /*#__PURE__*/React.createElement(DtEo, {
    op: f.eo_op
  }), f.frame && /*#__PURE__*/React.createElement("span", {
    className: "dt-eo",
    style: {
      background: f.frame === 'GIVEN' ? 'var(--teal-dim)' : 'var(--gold-dim)',
      color: f.frame === 'GIVEN' ? 'var(--teal)' : 'var(--gold)'
    }
  }, f.frame), f.room && /*#__PURE__*/React.createElement("span", {
    className: "dt-eo"
  }, f.room))), f.disclosed === false ? /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "dt-locked"
  }, /*#__PURE__*/React.createElement(DtLock, null), " not disclosed")) : /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 4,
      fontSize: 14,
      fontWeight: 500
    }
  }, f.value || '—')), provenanceField === key && f.disclosed !== false && /*#__PURE__*/React.createElement("div", {
    className: "dt-gm"
  }, f.given && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "g"
  }, "GIVEN: "), f.given), f.meant && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 3
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "m"
  }, "MEANT: "), f.meant), f.source && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 6,
      fontSize: 11
    }
  }, /*#__PURE__*/React.createElement("strong", null, "Source: "), f.source, " \xB7 ", /*#__PURE__*/React.createElement("strong", null, "Confidence: "), f.confidence), (() => {
  const hist = [...(f.history || []), ...(fieldHistories[key] || [])].sort((a, b) => (b.at || 0) - (a.at || 0));
  if (hist.length === 0) return null;
  return React.createElement(React.Fragment, null,
    React.createElement("div", { style: { marginTop: 10, marginBottom: 6 } },
      React.createElement("span", { className: "section-label" }, "CHANGE HISTORY")),
    hist.map((evt, i) => React.createElement("div", {
      key: i,
      style: { display: 'flex', alignItems: 'center', gap: 6, fontSize: 12, color: 'var(--tx-1)', padding: '5px 0', borderBottom: '1px solid var(--border-0)', flexWrap: 'wrap' }
    },
      React.createElement(DtEo, { op: evt.eo_op || 'ALT' }),
      React.createElement("span", { style: { fontWeight: 500, minWidth: 55, flexShrink: 0 } }, dtFmtDate(evt.at)),
      React.createElement("span", { style: { color: 'var(--tx-2)', fontSize: 11, flexShrink: 0 } }, evt.by || evt.type || ''),
      (evt.from !== undefined || evt.to !== undefined) && React.createElement("span", {
        style: { fontFamily: 'var(--mono)', fontSize: 10, color: 'var(--tx-3)', flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }
      }, evt.from != null ? String(evt.from).slice(0, 24) : '\u2205', ' \u2192 ', evt.to != null ? String(evt.to).slice(0, 24) : '\u2205'),
      onRestoreField && evt.to != null && React.createElement("button", {
        className: 'b-gho',
        style: { fontSize: 10, padding: '2px 7px', marginLeft: 'auto', whiteSpace: 'nowrap', flexShrink: 0, display: 'flex', alignItems: 'center', gap: 3 },
        title: 'Restore to: ' + String(evt.to).slice(0, 50),
        onClick: e => { e.stopPropagation(); onRestoreField(key, evt.to); }
      }, React.createElement(I, { n: 'check', s: 9 }), 'Restore')
    ))
  );
})())))))), panelTab === 'notes' && /*#__PURE__*/React.createElement(React.Fragment, null, (() => {
    const shared = indNotes.filter(n => n.type === 'shared');
    const internal = indNotes.filter(n => n.type === 'internal');
    return /*#__PURE__*/React.createElement(React.Fragment, null, shared.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
      className: "section-label"
    }, "Shared Notes (bridge room \u2014 individual can see)"), shared.map(n => /*#__PURE__*/React.createElement("div", {
      key: n.id,
      className: "dt-note shared"
    }, /*#__PURE__*/React.createElement("div", {
      className: "dt-note-meta"
    }, /*#__PURE__*/React.createElement("strong", null, n.author), /*#__PURE__*/React.createElement("span", null, dtFmtDate(n.at)), /*#__PURE__*/React.createElement(DtEo, {
      op: n.eo_op || 'INS'
    }), /*#__PURE__*/React.createElement("span", {
      className: "dt-eo",
      style: {
        background: 'var(--green-dim)',
        color: 'var(--green)'
      }
    }, n.frame || 'GIVEN'), n.category && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-purple",
      style: {
        fontSize: 9
      }
    }, n.category)), /*#__PURE__*/React.createElement("div", {
      className: "dt-note-text"
    }, n.text), n.tags && n.tags.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "dt-note-tags"
    }, n.tags.map(t => /*#__PURE__*/React.createElement("span", {
      key: t,
      className: "dt-note-tag"
    }, t)))))), internal.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
      className: "section-label",
      style: {
        marginTop: 16
      }
    }, "Internal Notes (roster room \u2014 org-only, individual CANNOT see)"), internal.map(n => /*#__PURE__*/React.createElement("div", {
      key: n.id,
      className: "dt-note internal"
    }, /*#__PURE__*/React.createElement("div", {
      className: "dt-note-meta"
    }, /*#__PURE__*/React.createElement("strong", null, n.author), /*#__PURE__*/React.createElement("span", null, dtFmtDate(n.at)), /*#__PURE__*/React.createElement(DtEo, {
      op: n.eo_op || 'INS'
    }), /*#__PURE__*/React.createElement("span", {
      className: "dt-eo",
      style: {
        background: 'var(--gold-dim)',
        color: 'var(--gold)'
      }
    }, n.frame || 'MEANT'), n.category && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-purple",
      style: {
        fontSize: 9
      }
    }, n.category), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--gold)'
      }
    }, " internal")), /*#__PURE__*/React.createElement("div", {
      className: "dt-note-text"
    }, n.text), n.tags && n.tags.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "dt-note-tags"
    }, n.tags.map(t => /*#__PURE__*/React.createElement("span", {
      key: t,
      className: "dt-note-tag"
    }, t)))))), indNotes.length === 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '40px 0',
        textAlign: 'center',
        color: 'var(--tx-3)'
      }
    }, "No notes recorded."), /*#__PURE__*/React.createElement("div", {
      className: "dt-hint"
    }, /*#__PURE__*/React.createElement("strong", null, "Privacy logic: "), "Shared notes emit ", /*#__PURE__*/React.createElement(DtEo, {
      op: "INS"
    }), " in the ", /*#__PURE__*/React.createElement("strong", null, "bridge room"), " \u2192 encrypted via Megolm + per-field AES-256-GCM \u2192 client + provider can read. Internal notes emit ", /*#__PURE__*/React.createElement(DtEo, {
      op: "INS"
    }), " in the ", /*#__PURE__*/React.createElement("strong", null, "roster room"), " \u2192 only org team members can read."));
  })()), panelTab === 'allocations' && /*#__PURE__*/React.createElement(React.Fragment, null, indAllocs.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '40px 0',
      textAlign: 'center',
      color: 'var(--tx-3)'
    }
  }, "No allocations recorded.") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "Resources Received (dual-write: bridge + vault shadow)"), indAllocs.map(a => {
    const stCls = a.status === 'active' ? 'tag-green' : a.status === 'consumed' ? 'tag-purple' : 'tag-gold';
    return /*#__PURE__*/React.createElement("div", {
      key: a.id,
      className: "dt-alloc"
    }, /*#__PURE__*/React.createElement("div", {
      className: "dt-alloc-header"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      className: "dt-alloc-title"
    }, a.resourceName), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 11,
        color: 'var(--tx-2)',
        marginTop: 2
      }
    }, a.quantity, " ", a.unit, " \xB7 ", a.org)), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 4,
        alignItems: 'center'
      }
    }, /*#__PURE__*/React.createElement(DtEo, {
      op: a.eo_op || 'CON'
    }), /*#__PURE__*/React.createElement("span", {
      className: 'tag ' + stCls,
      style: {
        fontSize: 10
      }
    }, a.status))), /*#__PURE__*/React.createElement("div", {
      className: "dt-alloc-detail"
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, "By: "), a.allocatedBy), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, "Date: "), dtFmtDate(a.at)), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, "Bridge: "), /*#__PURE__*/React.createElement(DtRoom, {
      room: a.bridgeRoom
    })), a.expiresAt && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, "Expires: "), a.expiresAt)), a.constraintsChecked && a.constraintsChecked.length > 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 8,
        fontSize: 11,
        color: 'var(--tx-1)'
      }
    }, /*#__PURE__*/React.createElement("strong", null, "Constraints verified: "), a.constraintsChecked.map(c => /*#__PURE__*/React.createElement("span", {
      key: c,
      style: {
        display: 'inline-block',
        padding: '1px 6px',
        borderRadius: 5,
        background: 'var(--green-dim)',
        color: 'var(--green)',
        fontSize: 10,
        marginRight: 3,
        marginBottom: 2
      }
    }, c))), a.vaultShadow && /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 8,
        padding: '8px 10px',
        borderRadius: 'var(--r)',
        background: 'var(--bg-3)',
        border: '1px solid var(--border-0)',
        fontSize: 11,
        color: 'var(--tx-2)'
      }
    }, /*#__PURE__*/React.createElement("strong", null, "Vault shadow: "), "\"", a.vaultShadow.resource_name, "\" from ", a.vaultShadow.org, " \u2014 denormalized, survives bridge severance"), a.events && a.events.length > 0 && /*#__PURE__*/React.createElement("div", {
      className: "dt-alloc-events"
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 10,
        fontWeight: 700,
        textTransform: 'uppercase',
        letterSpacing: '.06em',
        color: 'var(--tx-2)',
        marginBottom: 4
      }
    }, "Lifecycle Events"), a.events.map((evt, i) => /*#__PURE__*/React.createElement("div", {
      key: i,
      className: "dt-alloc-event"
    }, /*#__PURE__*/React.createElement("span", {
      className: "dot",
      style: {
        background: evt.event === 'allocated' ? 'var(--green)' : evt.event === 'consumed' ? 'var(--tx-3)' : 'var(--gold)'
      }
    }), /*#__PURE__*/React.createElement(DtEo, {
      op: evt.eo_op || 'ALT'
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontWeight: 500
      }
    }, evt.event), /*#__PURE__*/React.createElement("span", null, dtFmtDate(evt.at)), /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 11,
        marginLeft: 'auto'
      }
    }, evt.note)))));
  }), /*#__PURE__*/React.createElement("div", {
    className: "dt-hint"
  }, /*#__PURE__*/React.createElement("strong", null, "Allocation logic: "), "Every allocation emits ", /*#__PURE__*/React.createElement(DtEo, {
    op: "CON"
  }), " (\u22C8 connecting individual to resource). Status changes emit ", /*#__PURE__*/React.createElement(DtEo, {
    op: "ALT"
  }), " (\u223F). Revocations emit ", /*#__PURE__*/React.createElement(DtEo, {
    op: "NUL"
  }), " (\u2205). The bridge room gets the live record; the vault gets a denormalized shadow copy."))));
};

/* ─── Resource Side Panel ─── */
const ResourcePanel = ({
  row,
  allocations,
  onClose,
  panelTab,
  setPanelTab
}) => {
  if (!row) return null;
  const resAllocs = (allocations || []).filter(a => a.resourceId === row.id);
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "dt-panel-overlay",
    onClick: onClose
  }), /*#__PURE__*/React.createElement("div", {
    className: "dt-panel"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-panel-head"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", null, row.name), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6,
      alignItems: 'center',
      marginTop: 6,
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: 'tag tag-' + (RESOURCE_CATEGORY_COLORS[row.category] || 'teal'),
    style: {
      fontSize: 10
    }
  }, RESOURCE_CATEGORY_LABELS[row.category] || row.category), row.relation && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 10
    }
  }, row.relation), row.opacityLevel && (() => {
    const o = DT_OP_CFG[row.opacityLevel];
    return o ? /*#__PURE__*/React.createElement("span", {
      className: 'tag ' + o.cls,
      style: {
        fontSize: 10
      }
    }, o.l) : null;
  })(), /*#__PURE__*/React.createElement(DtRoom, {
    room: row.orgRoom
  }))), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    style: {
      background: 'none',
      border: 'none',
      cursor: 'pointer',
      fontSize: 20,
      color: 'var(--tx-2)'
    }
  }, "\u2715")), /*#__PURE__*/React.createElement("div", {
    className: "dt-panel-tabs"
  }, ['details', 'provisioning', 'allocations'].map(t => /*#__PURE__*/React.createElement("button", {
    key: t,
    className: 'dt-panel-tab' + (panelTab === t ? ' active' : ''),
    onClick: () => setPanelTab(t)
  }, t === 'details' ? 'Details' : t === 'provisioning' ? 'Provisioning' : `Allocations (${resAllocs.length})`))), /*#__PURE__*/React.createElement("div", {
    className: "dt-panel-body"
  }, panelTab === 'details' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "dt-cap"
  }, [{
    n: row.available || 0,
    l: 'Available',
    c: 'var(--green)'
  }, {
    n: row.allocated || 0,
    l: 'Allocated',
    c: 'var(--teal)'
  }, {
    n: row.reserved || 0,
    l: 'Reserved',
    c: 'var(--gold)'
  }, {
    n: row.totalCapacity || 0,
    l: 'Total',
    c: 'var(--tx-0)'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "dt-cap-box"
  }, /*#__PURE__*/React.createElement("div", {
    className: "num",
    style: {
      color: s.c
    }
  }, s.n), /*#__PURE__*/React.createElement("div", {
    className: "lbl"
  }, s.l)))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement(DtUtilBar, {
    pct: row.utilizationPct || 0
  })), /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "Details"), /*#__PURE__*/React.createElement("div", {
    className: "dt-field-grid"
  }, [{
    k: 'Holder',
    v: (row.holder || '—') + ' (' + (row.holderType || 'org') + ')'
  }, {
    k: 'Relation',
    v: row.relation || '—'
  }, {
    k: 'Network',
    v: row.network || '—'
  }, {
    k: 'Governance',
    v: row.governance || '—'
  }, {
    k: 'Updated',
    v: dtFmtDate(row.lastUpdated)
  }].map(({
    k,
    v
  }) => /*#__PURE__*/React.createElement(React.Fragment, {
    key: k
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-field-key"
  }, k), /*#__PURE__*/React.createElement("div", null, v)))), row.constraints && row.constraints.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginTop: 12
    }
  }, "Constraints (with governance provenance)"), row.constraints.map((c, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    style: {
      padding: '6px 10px',
      borderRadius: 'var(--r)',
      border: '1px solid var(--border-0)',
      marginBottom: 4,
      fontSize: 12,
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--green)'
    }
  }, "\u2713"), c, /*#__PURE__*/React.createElement("span", {
    style: {
      marginLeft: 'auto',
      fontSize: 10,
      color: 'var(--tx-3)',
      fontStyle: 'italic'
    }
  }, row.governance))))), panelTab === 'provisioning' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "Provisioning Timeline (org room events)"), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 12,
      padding: '8px 10px',
      borderRadius: 'var(--r)',
      background: 'var(--bg-3)',
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, "These events live in ", /*#__PURE__*/React.createElement(DtRoom, {
    room: row.orgRoom
  }), ". Individual identities are NOT in these events \u2014 only bridge room references. Inventory = total - allocated - reserved."), (row.provisioningEvents || []).map((evt, i) => {
    const color = DT_PROV_COLORS[evt.event] || 'var(--tx-2)';
    const icon = evt.event === 'restocked' ? '↑' : evt.event === 'allocated' ? '→' : evt.event === 'returned' ? '←' : evt.event === 'expired' ? '⏱' : evt.event.includes('capacity') ? '⚡' : '✓';
    return /*#__PURE__*/React.createElement("div", {
      key: i,
      className: "dt-prov"
    }, /*#__PURE__*/React.createElement("div", {
      className: "dt-prov-icon",
      style: {
        background: color + '18',
        color
      }
    }, icon), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1
      }
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, (evt.event || '').replace(/_/g, ' ')), " ", /*#__PURE__*/React.createElement(DtEo, {
      op: evt.eo_op || 'ALT'
    }), ' ', /*#__PURE__*/React.createElement("span", {
      style: {
        color,
        fontWeight: 600,
        fontFamily: 'var(--mono)',
        fontSize: 12
      }
    }, evt.delta)), /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 2,
        fontSize: 12,
        color: 'var(--tx-1)'
      }
    }, evt.detail), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 11,
        color: 'var(--tx-3)'
      }
    }, dtFmtDate(evt.at), " \xB7 ", evt.by)));
  }), (!row.provisioningEvents || row.provisioningEvents.length === 0) && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '40px 0',
      textAlign: 'center',
      color: 'var(--tx-3)'
    }
  }, "No provisioning events recorded."), /*#__PURE__*/React.createElement("div", {
    className: "dt-hint"
  }, /*#__PURE__*/React.createElement("strong", null, "Provisioning logic: "), "Capacity changes emit ", /*#__PURE__*/React.createElement(DtEo, {
    op: "ALT"
  }), " (\u223F) or ", /*#__PURE__*/React.createElement(DtEo, {
    op: "NUL"
  }), " (\u2205). New funding emits ", /*#__PURE__*/React.createElement(DtEo, {
    op: "INS"
  }), " (\u25B3). Allocations emit ", /*#__PURE__*/React.createElement(DtEo, {
    op: "CON"
  }), " (\u22C8). All events carry full provenance.")), panelTab === 'allocations' && /*#__PURE__*/React.createElement(React.Fragment, null, resAllocs.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '40px 0',
      textAlign: 'center',
      color: 'var(--tx-3)'
    }
  }, "No allocations from this resource.") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "Allocations from this resource (anonymized in org view)"), resAllocs.map(a => /*#__PURE__*/React.createElement("div", {
    key: a.id,
    className: "dt-alloc"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-alloc-header"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: 600,
      fontSize: 13
    }
  }, a.indName || '[bridge ref]'), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, a.quantity, " ", a.unit, " \xB7 ", dtFmtDate(a.at))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(DtEo, {
    op: a.eo_op || 'CON'
  }), /*#__PURE__*/React.createElement("span", {
    className: 'tag ' + (a.status === 'active' ? 'tag-green' : 'tag-purple'),
    style: {
      fontSize: 10
    }
  }, a.status))), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginTop: 4
    }
  }, "Bridge: ", /*#__PURE__*/React.createElement(DtRoom, {
    room: a.bridgeRoom
  }), " \xB7 By: ", a.allocatedBy))), /*#__PURE__*/React.createElement("div", {
    className: "dt-hint"
  }, /*#__PURE__*/React.createElement("strong", null, "Privacy note: "), "In production, this panel shows bridge room references, not individual names, unless the viewer has access to each bridge. Names resolve only for bridges you're a member of."))))));
};

/* ─── NoteCreateModal — create a note (attached or unattached) ─── */
/* On mobile (<=700px) renders as full-screen sheet for fast field entry */
const NoteCreateModal = ({
  open,
  onClose,
  individuals,
  staff,
  svc,
  rosterRoom,
  onSave,
  showToast,
  T,
  initialAttachTo,
  teamContext
}) => {
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [attachTo, setAttachTo] = useState(''); // bridgeRoomId or ''
  const [tags, setTags] = useState([]); // [{userId, displayName}]
  const [tagSearch, setTagSearch] = useState('');
  const [tagDd, setTagDd] = useState(false);
  const [moreOptions, setMoreOptions] = useState(false);
  const isMobile = useIsMobile();
  const titleRef = useRef(null);

  useEffect(() => {
    if (open) {
      setAttachTo(initialAttachTo || '');
      setMoreOptions(!!initialAttachTo); // auto-expand if pre-attached
      // Auto-focus title on mobile after animation
      if (isMobile) setTimeout(() => titleRef.current?.focus(), 300);
    }
  }, [open, initialAttachTo]);

  const authorName = (() => {
    const me = (staff||[]).find(s => s.userId === svc.userId);
    if (me) return me.display_name || svc.userId?.split(':')[0]?.replace('@','') || 'Unknown';
    return svc.userId?.split(':')[0]?.replace('@','') || 'Unknown';
  })();

  if (!open) return null;
  const allPeople = [...(staff || []).map(s => ({
    userId: s.userId,
    displayName: s.display_name || s.userId?.split(':')[0]?.replace('@', '') || T.staff_term
  })), ...(individuals || []).map(ind => ({
    userId: ind._case?.clientUserId || ind.id,
    displayName: ind.name || 'Unknown'
  }))].filter((p, i, arr) => arr.findIndex(x => x.userId === p.userId) === i);
  const filteredPeople = allPeople.filter(p => !tags.find(t => t.userId === p.userId) && (p.displayName || '').toLowerCase().includes(tagSearch.toLowerCase()));
  const handleSave = async () => {
    if (!title.trim() && !content.trim()) return;
    const noteData = {
      id: 'note_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8),
      title: title.trim(),
      content: content.trim(),
      attached_to: attachTo || null,
      tags: tags,
      author: svc.userId,
      created: Date.now(),
      updated: Date.now(),
      tombstoned: false,
      ...(teamContext ? { team_id: teamContext.roomId, team_name: teamContext.name } : {})
    };
    try {
      const targetRoom = attachTo || rosterRoom;
      if (targetRoom) {
        await svc.sendEvent(targetRoom, EVT.NOTE, noteData);
        if (attachTo && rosterRoom) {
          await svc.sendEvent(rosterRoom, EVT.NOTE_REF, {
            note_id: noteData.id,
            subject_room: attachTo,
            title: noteData.title,
            attached_to: attachTo,
            author: svc.userId,
            created: noteData.created
          });
        }
      }
      // Emit EO operation to track note creation in the action log
      try {
        await emitOp(targetRoom, 'INS', dot(attachTo ? 'bridge' : 'roster', 'notes', noteData.id), {
          note_id: noteData.id,
          attached_to: attachTo || undefined,
          author: svc.userId
        }, {
          type: attachTo ? 'bridge' : 'roster',
          room: targetRoom,
          role: 'provider',
          epistemic: 'MEANT'
        });
      } catch (oe) {
        console.warn('Note EO event failed:', oe.message);
      }
      onSave && onSave(noteData);
      showToast && showToast('Note created', 'success');
      setTitle('');
      setContent('');
      setAttachTo('');
      setTags([]);
      setTagSearch('');
      setMoreOptions(false);
      onClose();
    } catch (e) {
      showToast && showToast('Failed to create note: ' + e.message, 'error');
    }
  };

  /* ── Shared form fields: attach-to, created-by, tag people ── */
  const renderAttachTo = () => /*#__PURE__*/React.createElement("div", {
    style: { marginBottom: 14 }
  }, initialAttachTo ? /*#__PURE__*/React.createElement(React.Fragment, null,
    /*#__PURE__*/React.createElement("span", { className: "section-label" },
      "ATTACHED TO ", T?.client_term?.toUpperCase() || 'INDIVIDUAL'),
    /*#__PURE__*/React.createElement("div", {
      style: { fontSize: 14, fontWeight: 600, color: 'var(--tx-0)', padding: '8px 12px',
        background: 'var(--bg-2)', borderRadius: 'var(--r)', border: '1px solid var(--border-0)', marginTop: 4 }
    }, (individuals || []).find(i => i.id === initialAttachTo)?.name || initialAttachTo),
    /*#__PURE__*/React.createElement("div", {
      style: { fontSize: 10, color: 'var(--tx-2)', marginTop: 4 }
    }, "Stored in the individual\u2019s bridge room \u2014 they can see and control this note.")
  ) : /*#__PURE__*/React.createElement(React.Fragment, null,
    /*#__PURE__*/React.createElement("span", { className: "section-label" },
      "ATTACH TO ", T?.client_term?.toUpperCase() || 'INDIVIDUAL', " (OPTIONAL)"),
    /*#__PURE__*/React.createElement("select", {
      value: attachTo, onChange: e => setAttachTo(e.target.value), style: { width: '100%' }
    }, /*#__PURE__*/React.createElement("option", { value: "" }, "Standalone (not attached)"),
      (individuals || []).map(ind => /*#__PURE__*/React.createElement("option", {
        key: ind.id, value: ind.id
      }, ind.name || ind.id))),
    /*#__PURE__*/React.createElement("div", {
      style: { fontSize: 10, color: 'var(--tx-2)', marginTop: 4 }
    }, attachTo ? 'Stored in the individual\'s bridge room \u2014 they can see and control this note.' : 'Stored in your roster room \u2014 internal to your organization.')
  ));

  const renderCreatedBy = () => /*#__PURE__*/React.createElement("div", {
    style: { marginBottom: 14 }
  }, /*#__PURE__*/React.createElement("span", { className: "section-label" }, "CREATED BY"),
    /*#__PURE__*/React.createElement("div", {
      style: { fontSize: 13, color: 'var(--tx-1)', padding: '8px 12px',
        background: 'var(--bg-2)', borderRadius: 'var(--r)', border: '1px solid var(--border-0)', marginTop: 4,
        display: 'flex', alignItems: 'center', gap: 8 }
    }, /*#__PURE__*/React.createElement("span", {
      style: { width: 20, height: 20, borderRadius: '50%', background: 'var(--purple-dim)', color: 'var(--purple)',
        display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 9, fontWeight: 700, flexShrink: 0 }
    }, authorName[0].toUpperCase()), authorName));

  const renderTags = () => /*#__PURE__*/React.createElement("div", {
    style: { marginBottom: 18 }
  }, /*#__PURE__*/React.createElement("span", { className: "section-label" }, "TAG PEOPLE"),
    /*#__PURE__*/React.createElement("div", { style: { position: 'relative' } },
      /*#__PURE__*/React.createElement("input", {
        value: tagSearch,
        onChange: e => { setTagSearch(e.target.value); setTagDd(true); },
        onFocus: () => setTagDd(true),
        placeholder: "Search people to tag...",
        style: { marginBottom: tags.length ? 6 : 0 }
      }),
      tagDd && tagSearch && filteredPeople.length > 0 && /*#__PURE__*/React.createElement("div", {
        className: "dt-dd",
        style: { position: 'absolute', top: '100%', left: 0, right: 0, zIndex: 200 }
      }, filteredPeople.slice(0, 8).map(p => /*#__PURE__*/React.createElement("div", {
        key: p.userId, className: "dt-dd-item",
        onClick: () => { setTags(prev => [...prev, p]); setTagSearch(''); setTagDd(false); }
      }, /*#__PURE__*/React.createElement("span", {
        style: { width: 20, height: 20, borderRadius: '50%', background: 'var(--purple-dim)', color: 'var(--purple)',
          display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 9, fontWeight: 700, flexShrink: 0 }
      }, (p.displayName || '?')[0].toUpperCase()), p.displayName,
        /*#__PURE__*/React.createElement("span", {
          style: { fontSize: 9, color: 'var(--tx-3)', fontFamily: 'var(--mono)', marginLeft: 'auto' }
        }, p.userId?.split(':')[0]?.replace('@', '')))))),
    tags.length > 0 && /*#__PURE__*/React.createElement("div", { className: "note-tags" },
      tags.map(t => /*#__PURE__*/React.createElement("span", {
        key: t.userId, className: "note-tag-chip",
        onClick: () => setTags(prev => prev.filter(x => x.userId !== t.userId)),
        style: { cursor: 'pointer' }
      }, t.displayName, " \u2715"))));

  /* ── Mobile full-screen sheet ── */
  if (isMobile) {
    return /*#__PURE__*/React.createElement("div", { className: "note-sheet-mobile" },
      /* Header with close + save */
      /*#__PURE__*/React.createElement("div", { className: "note-sheet-header" },
        /*#__PURE__*/React.createElement("button", {
          onClick: onClose, className: "b-gho b-sm",
          style: { display: 'flex', alignItems: 'center', gap: 4 }
        }, /*#__PURE__*/React.createElement(I, { n: "x", s: 16 }), "Close"),
        /*#__PURE__*/React.createElement("button", {
          onClick: handleSave, className: "b-pri b-sm",
          disabled: !title.trim() && !content.trim(),
          style: { display: 'flex', alignItems: 'center', gap: 4 }
        }, /*#__PURE__*/React.createElement(I, { n: "check", s: 14 }), "Save")
      ),
      /* Body */
      /*#__PURE__*/React.createElement("div", { className: "note-sheet-body" },
        /*#__PURE__*/React.createElement("input", {
          ref: titleRef,
          className: "note-sheet-title",
          value: title,
          onChange: e => setTitle(e.target.value),
          placeholder: "Note title...",
          type: "text",
          enterKeyHint: "next"
        }),
        /*#__PURE__*/React.createElement("textarea", {
          value: content,
          onChange: e => setContent(e.target.value),
          placeholder: "Write your note...",
          enterKeyHint: "done"
        }),
        /* Expandable more options */
        /*#__PURE__*/React.createElement("button", {
          className: "note-sheet-expand-toggle",
          onClick: () => setMoreOptions(!moreOptions)
        }, /*#__PURE__*/React.createElement("span", { style: { display: 'inline-flex', transition: 'transform .2s', transform: moreOptions ? 'rotate(180deg)' : 'rotate(0)' } },
            /*#__PURE__*/React.createElement(I, { n: "chevronDown", s: 14 })),
          moreOptions ? "Hide options" : "More options",
          (attachTo || tags.length > 0) && /*#__PURE__*/React.createElement("span", {
            style: { fontSize: 10, color: 'var(--gold)', marginLeft: 4 }
          }, attachTo ? '\u2022 Attached' : '', tags.length ? ` \u2022 ${tags.length} tagged` : '')
        ),
        moreOptions && /*#__PURE__*/React.createElement("div", { className: "note-sheet-expand" },
          renderAttachTo(),
          renderCreatedBy(),
          renderTags()
        )
      )
    );
  }

  /* ── Desktop modal ── */
  return /*#__PURE__*/React.createElement(Modal, {
    open: open, onClose: onClose, title: "New Note", w: 560
  },
    /*#__PURE__*/React.createElement("div", { style: { marginBottom: 14 } },
      /*#__PURE__*/React.createElement("span", { className: "section-label" }, "TITLE"),
      /*#__PURE__*/React.createElement("input", {
        value: title, onChange: e => setTitle(e.target.value), placeholder: "Note title..."
      })),
    /*#__PURE__*/React.createElement("div", { style: { marginBottom: 14 } },
      /*#__PURE__*/React.createElement("span", { className: "section-label" }, "CONTENT"),
      /*#__PURE__*/React.createElement("textarea", {
        value: content, onChange: e => setContent(e.target.value),
        placeholder: "Write your note...", style: { minHeight: 100 }
      })),
    renderAttachTo(),
    renderCreatedBy(),
    renderTags(),
    /*#__PURE__*/React.createElement("button", {
      onClick: handleSave, className: "b-pri",
      disabled: !title.trim() && !content.trim(),
      style: { width: '100%', padding: 12, fontSize: 14 }
    }, "Save Note"));
};

/* ─── NoteDetailModal — view/edit a note with auditable edit history ─── */
/* Edits require an explicit "Save" click (no character-level spam).
   Each save emits a NOTE_EDIT timeline event and an ALT EO operation,
   recording who, when, and what changed. Edit history renders inline
   diffs with crossed-through old text and highlighted new text. */
const NoteDetailModal = ({ note, open, onClose, onSave, svc, staff, rosterRoom, showToast, T }) => {
  const [editing, setEditing] = useState(false);
  const [editTitle, setEditTitle] = useState('');
  const [editContent, setEditContent] = useState('');
  const [saving, setSaving] = useState(false);
  const isMobile = useIsMobile();

  useEffect(() => {
    if (open && note) {
      setEditing(false);
      setEditTitle(note.title || '');
      setEditContent(note.content || note.text || '');
    }
  }, [open, note?.id]);

  if (!open || !note) return null;

  const authorName = (() => {
    const uid = note.author || '';
    const s = (staff || []).find(st => st.userId === uid);
    if (s) return s.display_name || uid.split(':')[0]?.replace('@', '') || 'Unknown';
    return uid.split(':')[0]?.replace('@', '') || 'Unknown';
  })();

  const getDisplayName = uid => {
    const s = (staff || []).find(st => st.userId === uid);
    if (s) return s.display_name || uid.split(':')[0]?.replace('@', '') || 'Unknown';
    return (uid || '').split(':')[0]?.replace('@', '') || 'Unknown';
  };

  const titleChanged = editTitle.trim() !== (note.title || '').trim();
  const contentChanged = editContent.trim() !== (note.content || note.text || '').trim();
  const hasChanges = titleChanged || contentChanged;

  const handleSave = async () => {
    if (!hasChanges || saving) return;
    setSaving(true);
    try {
      const editData = {
        note_id: note.id,
        title: editTitle.trim(),
        content: editContent.trim(),
        prev_title: note.title || '',
        prev_content: note.content || note.text || '',
        edited_by: svc.userId,
        edited_at: Date.now()
      };
      const targetRoom = note._sourceRoom || note.attached_to || rosterRoom;
      if (targetRoom) {
        await svc.sendEvent(targetRoom, EVT.NOTE_EDIT, editData);
        // Emit ALT EO operation for audit trail
        try {
          const changes = {};
          if (titleChanged) changes.title = { from: editData.prev_title, to: editData.title };
          if (contentChanged) changes.content = { from: editData.prev_content, to: editData.content };
          await emitOp(targetRoom, 'ALT', dot(note.attached_to ? 'bridge' : 'roster', 'notes', note.id), {
            note_id: note.id,
            changes: changes,
            edited_by: svc.userId
          }, {
            type: note.attached_to ? 'bridge' : 'roster',
            room: targetRoom,
            role: 'provider',
            epistemic: 'MEANT'
          });
        } catch (oe) {
          console.warn('Note edit EO event failed:', oe.message);
        }
      }
      onSave && onSave(editData);
      showToast && showToast('Note updated', 'success');
      setEditing(false);
    } catch (e) {
      showToast && showToast('Failed to save edit: ' + e.message, 'error');
    } finally {
      setSaving(false);
    }
  };

  /* ── Inline word-level diff renderer ── */
  const renderDiff = (oldText, newText) => {
    if (!oldText && !newText) return null;
    if (oldText === newText) return null;
    const oldWords = (oldText || '').split(/(\s+)/);
    const newWords = (newText || '').split(/(\s+)/);
    // Simple LCS-based word diff
    const m = oldWords.length, n = newWords.length;
    const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        dp[i][j] = oldWords[i - 1] === newWords[j - 1] ? dp[i - 1][j - 1] + 1 : Math.max(dp[i - 1][j], dp[i][j - 1]);
      }
    }
    const parts = [];
    let i = m, j = n;
    while (i > 0 || j > 0) {
      if (i > 0 && j > 0 && oldWords[i - 1] === newWords[j - 1]) {
        parts.unshift({ type: 'same', text: oldWords[i - 1] });
        i--; j--;
      } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
        parts.unshift({ type: 'ins', text: newWords[j - 1] });
        j--;
      } else {
        parts.unshift({ type: 'del', text: oldWords[i - 1] });
        i--;
      }
    }
    return /*#__PURE__*/React.createElement("div", { className: "note-diff" },
      parts.map((p, idx) =>
        p.type === 'del' ? /*#__PURE__*/React.createElement("span", { key: idx, className: "note-diff-del" }, p.text) :
        p.type === 'ins' ? /*#__PURE__*/React.createElement("span", { key: idx, className: "note-diff-ins" }, p.text) :
        p.text
      )
    );
  };

  /* ── Edit history section ── */
  const editHistory = note.edit_history || [];
  const renderEditHistory = () => {
    if (editHistory.length === 0) return null;
    return /*#__PURE__*/React.createElement("div", { className: "note-edit-history" },
      /*#__PURE__*/React.createElement("span", { className: "section-label" }, "EDIT HISTORY"),
      editHistory.slice().reverse().map((entry, idx) =>
        /*#__PURE__*/React.createElement("div", { key: idx, className: "note-edit-entry" },
          /*#__PURE__*/React.createElement("div", { className: "note-edit-entry-meta" },
            /*#__PURE__*/React.createElement("span", {
              style: { width: 18, height: 18, borderRadius: '50%', background: 'var(--purple-dim)', color: 'var(--purple)',
                display: 'inline-flex', alignItems: 'center', justifyContent: 'center', fontSize: 8, fontWeight: 700, flexShrink: 0 }
            }, (getDisplayName(entry.edited_by))[0].toUpperCase()),
            /*#__PURE__*/React.createElement("strong", null, getDisplayName(entry.edited_by)),
            " edited \u00b7 ",
            dtFmtDate(entry.edited_at)
          ),
          entry.prev_title !== undefined && entry.title !== undefined && entry.prev_title !== entry.title && /*#__PURE__*/React.createElement("div", null,
            /*#__PURE__*/React.createElement("div", { className: "note-edit-entry-field" }, "Title"),
            renderDiff(entry.prev_title, entry.title)
          ),
          entry.prev_content !== undefined && entry.content !== undefined && entry.prev_content !== entry.content && /*#__PURE__*/React.createElement("div", null,
            /*#__PURE__*/React.createElement("div", { className: "note-edit-entry-field" }, "Content"),
            renderDiff(entry.prev_content, entry.content)
          )
        )
      )
    );
  };

  /* ── Render ── */
  const isOwnNote = note.author === svc.userId;

  return /*#__PURE__*/React.createElement(Modal, {
    open: open, onClose: () => { setEditing(false); onClose(); },
    title: editing ? 'Edit Note' : (note.title || 'Note'),
    w: 600
  },
    /* ── Content section ── */
    /*#__PURE__*/React.createElement("div", { style: { marginBottom: 14 } },
      /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 4 } },
        /*#__PURE__*/React.createElement("span", { className: "section-label" }, editing ? "TITLE" : "CONTENT"),
        !editing && !note.tombstoned && /*#__PURE__*/React.createElement("button", {
          onClick: () => setEditing(true),
          className: "b-gho b-xs",
          style: { display: 'flex', alignItems: 'center', gap: 4, fontSize: 11 }
        }, /*#__PURE__*/React.createElement(I, { n: "edit", s: 11 }), "Edit")
      ),
      editing ? /*#__PURE__*/React.createElement(React.Fragment, null,
        /*#__PURE__*/React.createElement("input", {
          value: editTitle,
          onChange: e => setEditTitle(e.target.value),
          placeholder: "Note title...",
          style: { marginBottom: 10, fontWeight: 600 }
        }),
        /*#__PURE__*/React.createElement("span", { className: "section-label" }, "CONTENT"),
        /*#__PURE__*/React.createElement("textarea", {
          value: editContent,
          onChange: e => setEditContent(e.target.value),
          placeholder: "Note content...",
          style: { minHeight: 120, marginTop: 4 }
        }),
        /* ── Live preview of changes ── */
        hasChanges && /*#__PURE__*/React.createElement("div", { style: { marginTop: 10 } },
          /*#__PURE__*/React.createElement("span", { className: "section-label", style: { color: 'var(--gold)' } }, "CHANGES PREVIEW"),
          titleChanged && /*#__PURE__*/React.createElement("div", null,
            /*#__PURE__*/React.createElement("div", { className: "note-edit-entry-field" }, "Title"),
            renderDiff(note.title || '', editTitle.trim())
          ),
          contentChanged && /*#__PURE__*/React.createElement("div", null,
            /*#__PURE__*/React.createElement("div", { className: "note-edit-entry-field" }, "Content"),
            renderDiff(note.content || note.text || '', editContent.trim())
          )
        ),
        /* ── Save / Cancel buttons ── */
        /*#__PURE__*/React.createElement("div", { style: { display: 'flex', gap: 8, marginTop: 14 } },
          /*#__PURE__*/React.createElement("button", {
            onClick: handleSave,
            className: "b-pri",
            disabled: !hasChanges || saving,
            style: { flex: 1, padding: 10, fontSize: 13 }
          }, saving ? "Saving..." : "Save Changes"),
          /*#__PURE__*/React.createElement("button", {
            onClick: () => {
              setEditing(false);
              setEditTitle(note.title || '');
              setEditContent(note.content || note.text || '');
            },
            className: "b-gho",
            style: { padding: 10, fontSize: 13 }
          }, "Cancel")
        )
      ) : /*#__PURE__*/React.createElement("div", {
        style: { fontSize: 13, color: 'var(--tx-0)', lineHeight: 1.7, whiteSpace: 'pre-wrap',
          background: 'var(--bg-2)', padding: 14, borderRadius: 'var(--r)',
          border: '1px solid var(--border-0)', marginTop: 6 }
      }, note.content || note.text || '(empty)')
    ),
    /* ── Attached To ── */
    note.attached_to && /*#__PURE__*/React.createElement("div", { style: { marginBottom: 14 } },
      /*#__PURE__*/React.createElement("span", { className: "section-label" }, "ATTACHED TO"),
      /*#__PURE__*/React.createElement("div", { style: { fontSize: 12, color: 'var(--tx-1)', marginTop: 4 } },
        note.attached_to_name || note.attached_to)
    ),
    /* ── Tags ── */
    note.tags?.length > 0 && /*#__PURE__*/React.createElement("div", { style: { marginBottom: 14 } },
      /*#__PURE__*/React.createElement("span", { className: "section-label" }, "TAGGED"),
      /*#__PURE__*/React.createElement("div", { className: "note-tags", style: { marginTop: 4 } },
        note.tags.map(t => /*#__PURE__*/React.createElement("span", { key: t.userId, className: "note-tag-chip" }, t.displayName))
      )
    ),
    /* ── Footer: created / last edited ── */
    /*#__PURE__*/React.createElement("div", {
      style: { fontSize: 11, color: 'var(--tx-3)', borderTop: '1px solid var(--border-0)', paddingTop: 10 }
    },
      "Created ", dtFmtDate(note.created), " by ", authorName,
      note.updated && note.updated !== note.created && /*#__PURE__*/React.createElement("span", null,
        " \u00b7 Last edited ", dtFmtDate(note.updated),
        note.last_edited_by ? (" by " + getDisplayName(note.last_edited_by)) : ''
      )
    ),
    /* ── Edit History ── */
    renderEditHistory()
  );
};

/* ─── NotesTable — table of all notes ─── */
/* On mobile, renders as card list instead of DataTable */
const NotesTable = ({
  notes,
  individuals,
  onNoteClick,
  onNewNote,
  T
}) => {
  const isMobile = useIsMobile();
  const NOTE_COLS = [{
    key: 'title',
    label: 'Title',
    fixed: true
  }, {
    key: 'content',
    label: 'Content'
  }, {
    key: 'attached_to_name',
    label: 'Attached To'
  }, {
    key: 'tags_display',
    label: 'Tags'
  }, {
    key: 'author_name',
    label: 'Author'
  }, {
    key: 'created',
    label: 'Created'
  }];
  const NOTE_GROUPS = [{
    k: 'none',
    l: 'No grouping'
  }, {
    k: 'attached_to_name',
    l: 'Attached To'
  }, {
    k: 'author_name',
    l: 'Author'
  }];
  const noteRows = (notes || []).map(n => {
    const ind = (individuals || []).find(i => i.id === n.attached_to);
    return {
      ...n,
      attached_to_name: ind ? ind.name : n.attached_to ? '[bridge]' : 'Standalone',
      tags_display: (n.tags || []).map(t => t.displayName).join(', ') || '—',
      author_name: (n.author || '').split(':')[0]?.replace('@', '') || 'Unknown'
    };
  });
  const getNoteVal = (row, key) => {
    if (key === 'created') return row.created || 0;
    return row[key] || '';
  };
  const renderNoteCell = (row, col) => {
    if (row.tombstoned) {
      if (col.key === 'title') return /*#__PURE__*/React.createElement("span", {
        style: {
          color: 'var(--red)',
          fontStyle: 'italic'
        }
      }, "Deleted by individual");
      if (col.key === 'content') return /*#__PURE__*/React.createElement("span", {
        style: {
          color: 'var(--tx-3)'
        }
      }, "\u2014");
    }
    if (col.key === 'title') return /*#__PURE__*/React.createElement("div", {
      style: {
        fontWeight: 600,
        fontSize: 13
      }
    }, row.title || '(untitled)');
    if (col.key === 'content') return /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 12,
        color: 'var(--tx-1)',
        maxWidth: 300,
        overflow: 'hidden',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap'
      }
    }, row.content?.slice(0, 80) || '—');
    if (col.key === 'attached_to_name') {
      if (row.attached_to) return /*#__PURE__*/React.createElement("span", {
        className: "note-attached-to"
      }, row.attached_to_name);
      return /*#__PURE__*/React.createElement("span", {
        style: {
          color: 'var(--tx-3)',
          fontSize: 12
        }
      }, "Standalone");
    }
    if (col.key === 'tags_display') {
      if (!row.tags || row.tags.length === 0) return /*#__PURE__*/React.createElement("span", {
        style: {
          color: 'var(--tx-3)',
          fontSize: 12
        }
      }, "\u2014");
      return /*#__PURE__*/React.createElement("div", {
        className: "note-tags"
      }, row.tags.map(t => /*#__PURE__*/React.createElement("span", {
        key: t.userId,
        className: "note-tag-chip"
      }, t.displayName)));
    }
    if (col.key === 'author_name') return /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        color: 'var(--tx-1)'
      }
    }, row.author_name);
    if (col.key === 'created') return /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        color: 'var(--tx-2)'
      }
    }, dtFmtDate(row.created));
    return /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 12
      }
    }, "\u2014");
  };
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5
    }
  }, "All notes across cases and standalone. Click a note for details.")), /*#__PURE__*/React.createElement("button", {
    onClick: onNewNote,
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 12
  }), "New Note")), noteRows.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '40px 20px',
      borderStyle: 'dashed'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "msg",
    s: 28,
    c: "var(--tx-3)"
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 10,
      fontSize: 13
    }
  }, "No notes yet"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 11.5,
      marginTop: 4
    }
  }, "Click \"New Note\" to create one. Notes can be attached to individuals or standalone."), /*#__PURE__*/React.createElement("button", {
    onClick: onNewNote,
    className: "b-pri b-sm",
    style: {
      marginTop: 12
    }
  }, "Create First Note")) : isMobile ?
    /* ── Mobile card list ── */
    /*#__PURE__*/React.createElement("div", { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
      noteRows.map(row => /*#__PURE__*/React.createElement("div", {
        key: row.id,
        className: 'note-card' + (row.tombstoned ? ' tombstoned' : row.attached_to ? ' attached' : ' standalone'),
        onClick: () => onNoteClick(row)
      },
        row.tombstoned ? /*#__PURE__*/React.createElement("div", {
          style: { color: 'var(--red)', fontSize: 12, fontStyle: 'italic' }
        }, "Deleted by individual") : /*#__PURE__*/React.createElement(React.Fragment, null,
          /*#__PURE__*/React.createElement("div", { className: "note-header" },
            /*#__PURE__*/React.createElement("div", { className: "note-title" }, row.title || '(untitled)'),
            /*#__PURE__*/React.createElement("div", { className: "note-meta" }, dtFmtDate(row.created))
          ),
          /*#__PURE__*/React.createElement("div", { className: "note-body" }, row.content?.slice(0, 120) || ''),
          /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 6, marginTop: 8, flexWrap: 'wrap' } },
            row.attached_to && /*#__PURE__*/React.createElement("span", { className: "note-attached-to" }, row.attached_to_name),
            /*#__PURE__*/React.createElement("span", { style: { fontSize: 10, color: 'var(--tx-2)' } }, row.author_name),
            row.tags && row.tags.length > 0 && /*#__PURE__*/React.createElement("div", { className: "note-tags", style: { marginTop: 0 } },
              row.tags.map(t => /*#__PURE__*/React.createElement("span", { key: t.userId, className: "note-tag-chip" }, t.displayName)))
          )
        )
      ))
    ) :
    /* ── Desktop DataTable ── */
    /*#__PURE__*/React.createElement(DataTable, {
      data: noteRows,
      columns: NOTE_COLS,
      groupOptions: NOTE_GROUPS,
      defaultVisibleCols: ['title', 'content', 'attached_to_name', 'tags_display', 'author_name', 'created'],
      onRowClick: onNoteClick,
      renderCell: renderNoteCell,
      getVal: getNoteVal,
      label: "notes",
      selectable: true,
      bulkActions: [{
        id: 'delete',
        label: 'Delete',
        cls: 'b-red b-xs',
        icon: 'trash'
      }]
    }));
};

/* ─── Linked Record Types — configurable record types for Airtable-style linking ─── */
const LINKED_RECORD_TYPES = [
  { id: 'individual', label: 'Personal', icon: 'user', color: 'var(--green)', colorDim: 'var(--green-dim)' },
  { id: 'note', label: 'Note', icon: 'msg', color: 'var(--blue)', colorDim: 'var(--blue-dim)' },
  { id: 'resource', label: 'Resource', icon: 'layers', color: 'var(--teal)', colorDim: 'var(--teal-dim)' },
  { id: 'case', label: 'Case', icon: 'briefcase', color: 'var(--gold)', colorDim: 'var(--gold-dim)' },
  { id: 'task', label: 'Task', icon: 'check', color: 'var(--orange)', colorDim: 'var(--orange-dim)' },
  { id: 'document', label: 'Document', icon: 'file', color: 'var(--purple)', colorDim: 'var(--purple-dim)' }
];

/* ─── CreateLinkedRecordModal — link sub-records with governance ─── */
const CreateLinkedRecordModal = ({
  open,
  onClose,
  parentRecord,
  individuals,
  notes,
  resourceTypes,
  cases: allCases,
  svc,
  orgRole,
  orgRoom,
  teamMode,
  activeTeamObj,
  showToast,
  onLinkCreated,
  linkedRecords
}) => {
  const [selectedType, setSelectedType] = useState('individual');
  const [search, setSearch] = useState('');
  const [selectedTarget, setSelectedTarget] = useState(null);
  const [newRecordMode, setNewRecordMode] = useState(false);
  const [newRecordName, setNewRecordName] = useState('');
  const [newRecordNotes, setNewRecordNotes] = useState('');
  const [saving, setSaving] = useState(false);
  const [governanceNote, setGovernanceNote] = useState('');

  if (!open || !parentRecord) return null;

  const typeConfig = LINKED_RECORD_TYPES.find(t => t.id === selectedType) || LINKED_RECORD_TYPES[0];
  const existingLinks = linkedRecords?.[parentRecord.id] || [];
  const existingLinkedIds = new Set(existingLinks.map(l => l.linked_record_id));

  // Build candidate records based on selected type
  let candidates = [];
  if (selectedType === 'individual') {
    candidates = (individuals || []).filter(i => i.id !== parentRecord.id && !existingLinkedIds.has(i.id)).map(i => ({
      id: i.id, name: i.name || 'Unknown', meta: i.status || '', icon: 'user', color: 'var(--green)'
    }));
  } else if (selectedType === 'note') {
    candidates = (notes || []).filter(n => !existingLinkedIds.has(n.id)).map(n => ({
      id: n.id, name: n.title || 'Untitled Note', meta: n.type || 'note', icon: 'msg', color: 'var(--blue)'
    }));
  } else if (selectedType === 'resource') {
    candidates = (resourceTypes || []).filter(r => !existingLinkedIds.has(r.id)).map(r => ({
      id: r.id, name: r.name || 'Unknown Resource', meta: r.category || 'general', icon: 'layers', color: 'var(--teal)'
    }));
  } else if (selectedType === 'case') {
    candidates = (allCases || []).filter(c => c.bridgeRoomId !== parentRecord.id && !existingLinkedIds.has(c.bridgeRoomId)).map(c => ({
      id: c.bridgeRoomId, name: c.sharedData?.full_name || c.clientUserId || 'Unknown', meta: 'case', icon: 'briefcase', color: 'var(--gold)'
    }));
  } else {
    // task, document — allow creating new sub-records
    candidates = [];
  }

  const filtered = search ? candidates.filter(c => c.name.toLowerCase().includes(search.toLowerCase())) : candidates;

  // Governance requirement check
  const governanceRequired = teamMode && activeTeamObj;
  const consentMode = activeTeamObj?.schemaRule?.mode || 'lead_decides';
  const isTeamLead = activeTeamObj?.lead === svc?.userId;

  const handleLink = async (target) => {
    if (!target) return;
    setSaving(true);
    try {
      const linkId = 'lr_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
      const linkRecord = {
        id: linkId,
        linked_record_id: target.id,
        record_type: selectedType,
        record_type_label: typeConfig.label,
        label: target.name,
        created_by: svc?.userId || 'unknown',
        created_at: new Date().toISOString(),
        governance: governanceRequired ? {
          team_id: activeTeamObj.roomId,
          team_name: activeTeamObj.name,
          consent_mode: consentMode,
          approved_by: isTeamLead ? svc?.userId : null,
          governance_note: governanceNote || null,
          status: (consentMode === 'lead_decides' && isTeamLead) || consentMode === 'advisory' ? 'approved' : 'pending_approval'
        } : null
      };

      if (onLinkCreated) onLinkCreated(parentRecord.id, linkRecord);
      if (showToast) {
        const govStatus = linkRecord.governance?.status;
        if (govStatus === 'pending_approval') {
          showToast(`Link created (pending team approval under ${consentMode} governance)`, 'warning');
        } else {
          showToast(`Linked ${typeConfig.label} "${target.name}" to ${parentRecord.name}`, 'success');
        }
      }
      onClose();
    } catch (e) {
      if (showToast) showToast('Failed to create link: ' + e.message, 'error');
    } finally {
      setSaving(false);
    }
  };

  const handleCreateNew = async () => {
    if (!newRecordName.trim()) return;
    setSaving(true);
    try {
      const linkId = 'lr_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
      const subRecordId = 'sub_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
      const linkRecord = {
        id: linkId,
        linked_record_id: subRecordId,
        record_type: selectedType,
        record_type_label: typeConfig.label,
        label: newRecordName.trim(),
        notes: newRecordNotes.trim() || null,
        is_sub_record: true,
        created_by: svc?.userId || 'unknown',
        created_at: new Date().toISOString(),
        governance: governanceRequired ? {
          team_id: activeTeamObj.roomId,
          team_name: activeTeamObj.name,
          consent_mode: consentMode,
          approved_by: isTeamLead ? svc?.userId : null,
          governance_note: governanceNote || null,
          status: (consentMode === 'lead_decides' && isTeamLead) || consentMode === 'advisory' ? 'approved' : 'pending_approval'
        } : null
      };

      if (onLinkCreated) onLinkCreated(parentRecord.id, linkRecord);
      if (showToast) showToast(`Created & linked new ${typeConfig.label} "${newRecordName.trim()}"`, 'success');
      onClose();
    } catch (e) {
      if (showToast) showToast('Failed to create sub-record: ' + e.message, 'error');
    } finally {
      setSaving(false);
    }
  };

  return /*#__PURE__*/React.createElement(Modal, {
    open: open,
    onClose: onClose,
    title: `Link Record to ${parentRecord.name || 'Record'}`,
    w: 560
  },
  // Record type selector
  /*#__PURE__*/React.createElement("div", {
    style: { marginBottom: 14 }
  }, /*#__PURE__*/React.createElement("label", {
    className: "section-label",
    style: { fontSize: 10, marginBottom: 6 }
  }, "RECORD TYPE"),
  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 4, flexWrap: 'wrap' }
  }, LINKED_RECORD_TYPES.map(rt => /*#__PURE__*/React.createElement("button", {
    key: rt.id,
    className: selectedType === rt.id ? 'b-pri b-xs' : 'b-gho b-xs',
    style: { display: 'flex', alignItems: 'center', gap: 4, fontSize: 11 },
    onClick: () => { setSelectedType(rt.id); setSelectedTarget(null); setSearch(''); setNewRecordMode(false); }
  }, /*#__PURE__*/React.createElement(I, { n: rt.icon, s: 11 }), rt.label)))),

  // Governance indicator
  governanceRequired && /*#__PURE__*/React.createElement("div", {
    style: { padding: '8px 12px', background: 'var(--purple-dim)', border: '1px solid rgba(139,92,246,.15)', borderRadius: 'var(--r)', marginBottom: 12, display: 'flex', alignItems: 'center', gap: 8 }
  }, /*#__PURE__*/React.createElement(I, { n: "shieldCheck", s: 14, c: "var(--purple)" }),
  /*#__PURE__*/React.createElement("div", { style: { flex: 1 } },
    /*#__PURE__*/React.createElement("div", { style: { fontSize: 11.5, fontWeight: 600, color: 'var(--purple)' } },
      "Team governance active"),
    /*#__PURE__*/React.createElement("div", { style: { fontSize: 10, color: 'var(--tx-2)' } },
      "Consent mode: ", consentMode.replace(/_/g, ' '),
      !isTeamLead && consentMode !== 'advisory' ? ' — link will require team lead approval' : '')),
  /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "Governance note (optional)",
    value: governanceNote,
    onChange: e => setGovernanceNote(e.target.value),
    style: { width: 160, padding: '4px 8px', fontSize: 10, borderRadius: 'var(--r)' }
  })),

  // Toggle: Link existing or create new
  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 4, marginBottom: 12 }
  }, /*#__PURE__*/React.createElement("button", {
    className: !newRecordMode ? 'b-pri b-xs' : 'b-gho b-xs',
    onClick: () => setNewRecordMode(false)
  }, "Link Existing"), /*#__PURE__*/React.createElement("button", {
    className: newRecordMode ? 'b-pri b-xs' : 'b-gho b-xs',
    onClick: () => setNewRecordMode(true)
  }, /*#__PURE__*/React.createElement(I, { n: "plus", s: 10 }), "Create New Sub-Record")),

  !newRecordMode ? /*#__PURE__*/React.createElement(React.Fragment, null,
    // Search
    /*#__PURE__*/React.createElement("input", {
      type: "text",
      placeholder: `Search ${typeConfig.label.toLowerCase()}s...`,
      value: search,
      onChange: e => setSearch(e.target.value),
      style: { marginBottom: 10, padding: '8px 12px', fontSize: 12.5 }
    }),

    // Candidate list
    /*#__PURE__*/React.createElement("div", {
      style: { maxHeight: 280, overflow: 'auto', marginBottom: 12 }
    }, filtered.length === 0 ? /*#__PURE__*/React.createElement("div", {
      style: { padding: 20, textAlign: 'center', color: 'var(--tx-2)', fontSize: 12 }
    }, candidates.length === 0 ? `No ${typeConfig.label.toLowerCase()} records available. Try creating a new sub-record.` : 'No matches found')
    : filtered.map(c => /*#__PURE__*/React.createElement("div", {
      key: c.id,
      className: "lr-record-card",
      style: { borderColor: selectedTarget?.id === c.id ? 'var(--purple)' : undefined, background: selectedTarget?.id === c.id ? 'var(--purple-dim)' : undefined },
      onClick: () => setSelectedTarget(c)
    }, /*#__PURE__*/React.createElement("div", {
      className: "lr-avatar",
      style: { background: c.color || 'var(--purple)' }
    }, (c.name || '?')[0].toUpperCase()),
    /*#__PURE__*/React.createElement("div", { className: "lr-info" },
      /*#__PURE__*/React.createElement("div", { className: "lr-name" }, c.name),
      /*#__PURE__*/React.createElement("div", { className: "lr-meta" }, c.meta)),
    /*#__PURE__*/React.createElement("span", {
      className: "lr-type-badge",
      style: { background: typeConfig.colorDim, color: typeConfig.color }
    }, typeConfig.label),
    selectedTarget?.id === c.id && /*#__PURE__*/React.createElement(I, { n: "check", s: 16, c: "var(--purple)" })))),

    // Link button
    /*#__PURE__*/React.createElement("button", {
      className: "b-pri",
      style: { width: '100%' },
      disabled: !selectedTarget || saving,
      onClick: () => handleLink(selectedTarget)
    }, saving ? 'Linking...' : `Link ${typeConfig.label}`)
  )

  : /*#__PURE__*/React.createElement(React.Fragment, null,
    // Create new sub-record form
    /*#__PURE__*/React.createElement("div", { style: { marginBottom: 10 } },
      /*#__PURE__*/React.createElement("label", {
        className: "section-label",
        style: { fontSize: 10, marginBottom: 4 }
      }, `NEW ${typeConfig.label.toUpperCase()} NAME`),
      /*#__PURE__*/React.createElement("input", {
        type: "text",
        placeholder: `Enter ${typeConfig.label.toLowerCase()} name...`,
        value: newRecordName,
        onChange: e => setNewRecordName(e.target.value),
        style: { padding: '10px 14px', fontSize: 13 }
      })),

    /*#__PURE__*/React.createElement("div", { style: { marginBottom: 14 } },
      /*#__PURE__*/React.createElement("label", {
        className: "section-label",
        style: { fontSize: 10, marginBottom: 4 }
      }, "NOTES (OPTIONAL)"),
      /*#__PURE__*/React.createElement("textarea", {
        placeholder: "Add details about this sub-record...",
        value: newRecordNotes,
        onChange: e => setNewRecordNotes(e.target.value),
        style: { padding: '10px 14px', fontSize: 12.5, minHeight: 60 }
      })),

    // Sovereignty notice
    /*#__PURE__*/React.createElement("div", {
      style: { padding: '8px 12px', background: 'var(--gold-dim)', border: '1px solid var(--gold-mid)', borderRadius: 'var(--r)', marginBottom: 12, fontSize: 11, color: 'var(--tx-1)', lineHeight: 1.5 }
    }, /*#__PURE__*/React.createElement(I, { n: "eye", s: 11, c: "var(--gold)" }),
    " This creates a sub-record linked to ", /*#__PURE__*/React.createElement("strong", null, parentRecord.name), ". The link is stored as an EO operation and can be audited."),

    /*#__PURE__*/React.createElement("button", {
      className: "b-pri",
      style: { width: '100%' },
      disabled: !newRecordName.trim() || saving,
      onClick: handleCreateNew
    }, saving ? 'Creating...' : `Create & Link ${typeConfig.label}`)),

  // Existing links section
  existingLinks.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: { borderTop: '1px solid var(--border-0)', paddingTop: 12, marginTop: 12 }
  }, /*#__PURE__*/React.createElement("label", {
    className: "section-label",
    style: { fontSize: 10, marginBottom: 6 }
  }, `EXISTING LINKS (${existingLinks.length})`),
  existingLinks.map(link => {
    const lrt = LINKED_RECORD_TYPES.find(t => t.id === link.record_type);
    return /*#__PURE__*/React.createElement("div", {
      key: link.id,
      style: { display: 'flex', alignItems: 'center', gap: 8, padding: '6px 8px', borderRadius: 'var(--r)', marginBottom: 4, background: 'var(--bg-2)', border: '1px solid var(--border-0)' }
    }, /*#__PURE__*/React.createElement("span", {
      className: "lr-type-badge",
      style: { background: lrt?.colorDim || 'var(--purple-dim)', color: lrt?.color || 'var(--purple)' }
    }, link.record_type_label || link.record_type),
    /*#__PURE__*/React.createElement("span", { style: { flex: 1, fontSize: 12, fontWeight: 500 } }, link.label),
    link.governance && /*#__PURE__*/React.createElement("span", {
      className: "tag",
      style: { fontSize: 8, padding: '1px 6px', background: link.governance.status === 'approved' ? 'var(--green-dim)' : 'var(--orange-dim)', color: link.governance.status === 'approved' ? 'var(--green)' : 'var(--orange)' }
    }, link.governance.status === 'approved' ? 'Approved' : 'Pending'),
    /*#__PURE__*/React.createElement("span", { style: { fontSize: 9, color: 'var(--tx-3)' } },
      new Date(link.created_at).toLocaleDateString()));
  })));
};

/* ─── DatabaseView — unified tabbed view for Individuals, Notes, Resources ─── */
const DatabaseView = ({
  cases,
  caseAssignments,
  openCase,
  T,
  svc,
  caseAllocations,
  providerProfile,
  orgRoom,
  orgMeta,
  staff,
  orgRole,
  showToast,
  bridgeNotes,
  rosterNotes,
  allAllocations,
  onCreateOrg,
  onEditProfile,
  onDiscover,
  myVerification,
  emailVerifyConfig,
  openEmailVerifyModal,
  orgChannels,
  ORG_TYPE_LABELS,
  ORG_ROLE_LABELS,
  notes,
  onNewNote,
  onNoteClick,
  onOpenIndividual,
  onOpenResource,
  resourceTypes,
  resourceRelations,
  resourceInventory,
  rosterRoom,
  networkRoom,
  onCreateResource,
  onRefresh,
  onRestock,
  onEstablishRelation,
  canViewResource,
  canControlResource,
  canAllocateResource,
  clientRecords,
  onCreateClient,
  onCellEdit,
  onBulkAction,
  onReorder,
  onAddRow,
  fieldDefs,
  fieldCrosswalks,
  teams,
  onSaveFieldDef,
  onSaveCrosswalk,
  fieldGovernanceConfig,
  onPropose,
  teamMode,
  activeTeamObj,
  sidebarCollapsed,
  linkedRecords,
  onCreateLinkedRecord,
  onRemoveLinkedRecord,
  onCreateTable,
  onOpenTable,
  trashedIndividuals,
  onRestoreIndividual,
  onRestoreField
}) => {
  const [dbTab, setDbTab] = useState('individuals');
  const [enabledFieldCols, setEnabledFieldCols] = useState([]);
  const [addFieldDd, setAddFieldDd] = useState(false);
  const [addColumnModal, setAddColumnModal] = useState(false);

  // Transform cases into individual rows (same as IndividualsView)
  const individuals = cases.map(c => {
    const assignment = caseAssignments[c.bridgeRoomId];
    const fields = {};
    Object.entries(c.sharedData || {}).forEach(([k, v]) => {
      if (k === 'full_name') return;
      fields[k] = {
        value: v,
        disclosed: true,
        eo_op: 'INS',
        frame: 'GIVEN',
        room: 'bridge',
        editable: false,
        history: []
      };
    });
    return {
      id: c.bridgeRoomId,
      name: c.sharedData.full_name || c.clientUserId || 'Unknown',
      alias: null,
      status: c.meta?.status === 'tombstoned' ? 'revoked' : c.sharedData.full_name ? 'active' : 'imported',
      disclosureLevel: Object.keys(c.sharedData || {}).length > 0 ? Math.min(Object.keys(c.sharedData).length / 10, 1) : 0,
      lastContact: c.meta?.last_updated || c.meta?.created,
      assignedTo: (assignment?.primary || c.meta?.provider || '').split(':')[0]?.replace('@', '') || '—',
      activeCases: 1,
      priority: assignment?.priority || 'none',
      nextAction: assignment?.next_action || null,
      bridgeRoom: c.bridgeRoomId,
      fields,
      transferable: c.transferable,
      _case: c
    };
  });

  // Also include client records that aren't yet in cases (provider-created)
  const caseRoomIds = new Set(cases.map(c => c.bridgeRoomId));
  const extraClients = (clientRecords || []).filter(r => !caseRoomIds.has(r.roomId)).map(r => ({
    id: r.roomId,
    name: r.client_name || 'Unknown',
    alias: null,
    status: r.status || 'created',
    disclosureLevel: 0,
    lastContact: r.created,
    assignedTo: (r.owner || '').split(':')[0]?.replace('@', '') || '—',
    activeCases: 0,
    priority: 'none',
    bridgeRoom: r.roomId,
    fields: {},
    transferable: false,
    _clientRecord: r
  }));
  const allIndividuals = [...individuals, ...extraClients].filter(row => !(trashedIndividuals || {})[row.id]);
  const IND_COLS = [{
    key: 'name',
    label: 'Individual',
    fixed: true,
    editable: true,
    placeholder: 'Enter name...'
  }, {
    key: 'status',
    label: 'Status'
  }, {
    key: 'priority',
    label: 'Priority',
    editable: true
  }, {
    key: 'assignedTo',
    label: 'Assigned'
  }, {
    key: 'fields_count',
    label: 'Fields'
  }, {
    key: 'transferable',
    label: 'Transfer'
  }, {
    key: 'linked_records',
    label: 'Linked Records'
  }];
  // Add dynamic field columns
  const fieldKeys = new Set();
  cases.forEach(c => Object.keys(c.sharedData || {}).forEach(k => {
    if (k !== 'full_name') fieldKeys.add(k);
  }));
  fieldKeys.forEach(k => {
    IND_COLS.push({
      key: k,
      label: k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
      isField: true,
      editable: true
    });
  });
  // Also add provider-enabled field columns from fieldDefs
  enabledFieldCols.forEach(key => {
    if (!fieldKeys.has(key)) {
      const def = Object.values(fieldDefs || {}).find(d => d.key === key);
      IND_COLS.push({
        key,
        label: def?.label || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        isField: true,
        editable: true
      });
    }
  });
  const IND_GROUPS = [{
    k: 'none',
    l: 'No grouping'
  }, {
    k: 'status',
    l: 'Status'
  }, {
    k: 'assignedTo',
    l: 'Assigned To'
  }, {
    k: 'priority',
    l: 'Priority'
  }];
  const enabledExtras = enabledFieldCols.filter(k => !fieldKeys.has(k));
  const defaultVisCols = ['name', 'status', 'priority', 'assignedTo', 'fields_count', 'linked_records', 'transferable', ...Array.from(fieldKeys).slice(0, 3), ...enabledExtras];
  const getIndVal = (row, key) => {
    if (key === 'fields_count') return Object.keys(row.fields || {}).length;
    if (key === 'transferable') return row.transferable ? 'Yes' : 'Locked';
    if (key === 'linked_records') return (linkedRecords?.[row.id] || []).length;
    if (row.fields && row.fields[key]) return row.fields[key].value || '';
    return row[key] || '';
  };
  const renderIndCell = (row, col) => {
    const k = col.key;
    if (k === 'linked_records') {
      const links = linkedRecords?.[row.id] || [];
      return /*#__PURE__*/React.createElement("div", {
        style: { display: 'flex', alignItems: 'center', gap: 4, flexWrap: 'wrap' }
      }, links.slice(0, 3).map(link => /*#__PURE__*/React.createElement("span", {
        key: link.id,
        className: "linked-rec-chip",
        title: `${link.record_type}: ${link.label}`,
        onClick: e => { e.stopPropagation(); }
      }, /*#__PURE__*/React.createElement("span", { className: "lr-type" }, link.record_type_label || link.record_type), link.label)),
      links.length > 3 && /*#__PURE__*/React.createElement("span", {
        style: { fontSize: 10, color: 'var(--tx-2)', fontFamily: 'var(--mono)' }
      }, "+", links.length - 3),
      /*#__PURE__*/React.createElement("button", {
        className: "linked-rec-add",
        onClick: e => { e.stopPropagation(); onCreateLinkedRecord && onCreateLinkedRecord(row); },
        title: "Link a record"
      }, /*#__PURE__*/React.createElement(I, { n: "plus", s: 9 }), "Link"));
    }
    if (k === 'name') {
      const initial = (row.name || '?')[0].toUpperCase();
      return /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: 8
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          width: 24,
          height: 24,
          borderRadius: '50%',
          background: row.status === 'revoked' ? 'var(--border-1)' : 'var(--green)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          color: '#fff',
          fontSize: 11,
          fontWeight: 700,
          flexShrink: 0
        }
      }, initial), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
        style: {
          fontWeight: 600,
          fontSize: 13
        }
      }, row.name), row.alias && /*#__PURE__*/React.createElement("div", {
        style: {
          fontSize: 11,
          color: 'var(--tx-3)'
        }
      }, "\"", row.alias, "\"")));
    }
    if (k === 'status') return /*#__PURE__*/React.createElement(DtStatusBadge, {
      status: row.status
    });
    if (k === 'priority') {
      const cls = DT_PRI_CFG[row.priority] || 'tag-purple';
      return /*#__PURE__*/React.createElement("span", {
        className: 'tag ' + cls,
        style: {
          fontSize: 10
        }
      }, row.priority);
    }
    if (k === 'assignedTo') return /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        color: 'var(--tx-1)'
      }
    }, row.assignedTo);
    if (k === 'fields_count') {
      const ct = Object.keys(row.fields || {}).length;
      return /*#__PURE__*/React.createElement("span", {
        style: {
          display: 'inline-flex',
          alignItems: 'center',
          justifyContent: 'center',
          width: 22,
          height: 22,
          borderRadius: 5,
          background: ct > 0 ? 'var(--green-dim)' : 'var(--bg-3)',
          color: ct > 0 ? 'var(--green)' : 'var(--tx-3)',
          fontSize: 12,
          fontWeight: 700
        }
      }, ct);
    }
    if (k === 'transferable') {
      return row.transferable ? /*#__PURE__*/React.createElement("span", {
        className: "tag tag-teal",
        style: {
          fontSize: 9
        }
      }, "Transferable") : /*#__PURE__*/React.createElement("span", {
        className: "tag tag-red",
        style: {
          fontSize: 9
        }
      }, "Locked");
    }
    if (col.isField && row.fields && row.fields[k]) {
      const f = row.fields[k];
      if (f.disclosed === false) return /*#__PURE__*/React.createElement("span", {
        className: "dt-locked"
      }, /*#__PURE__*/React.createElement(DtLock, null), " not disclosed");
      return /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 13
        }
      }, f.value || '—');
    }
    return /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 12
      }
    }, "\u2014");
  };

  // Stat cards
  const totalLinks = Object.values(linkedRecords || {}).reduce((s, arr) => s + arr.length, 0);
  const indStats = [{
    l: 'Total',
    v: allIndividuals.length,
    c: 'gold'
  }, {
    l: 'Active',
    v: allIndividuals.filter(i => i.status === 'active').length,
    c: 'green'
  }, {
    l: 'Linked Records',
    v: totalLinks,
    c: 'purple'
  }, {
    l: T.staff_term_plural,
    v: (staff || []).length,
    c: 'blue'
  }, {
    l: 'Fields Active',
    v: cases.reduce((s, c) => s + Object.keys(c.sharedData || {}).length, 0) + enabledFieldCols.length,
    c: 'teal'
  }];
  // ── Team-specific database: require team selection when teams exist ──
  const hasTeams = (teams || []).length > 0;
  const isTeamScoped = !!activeTeamObj;
  // Detect holonic data (child-team rollups or cross-team linked records)
  const childTeams = activeTeamObj?.hierarchy?.child_teams || [];
  const childTeamObjs = childTeams.map(c => (teams || []).find(t => t.roomId === c.roomId)).filter(Boolean);
  const rollupTables = childTeamObjs.flatMap(ct =>
    (ct.customTables || []).filter(t => t.status === 'active' && t.rollup_to_parent).map(t => ({ ...t, _fromTeam: ct }))
  );
  const hasHolonicData = rollupTables.length > 0 || childTeamObjs.length > 0;
  // Cross-team linked records
  const crossTeamLinks = Object.values(linkedRecords || {}).flat().filter(lr => {
    if (!activeTeamObj) return false;
    return lr.source_team && lr.source_team !== activeTeamObj.roomId;
  });
  const hasCrossTeamLinks = crossTeamLinks.length > 0;

  // If teams exist but none is selected, show team selection prompt
  if (hasTeams && !isTeamScoped) {
    return React.createElement("div", {
      className: `anim-up db-view${sidebarCollapsed ? ' db-full-width' : ''}`,
      style: { textAlign: 'center', padding: '60px 20px' }
    },
      React.createElement(I, { n: "database", s: 48, c: "var(--border-1)" }),
      React.createElement("h2", {
        style: { fontFamily: 'var(--serif)', fontSize: 22, fontWeight: 700, marginTop: 16, marginBottom: 8 }
      }, "Select a Team"),
      React.createElement("p", {
        style: { color: 'var(--tx-2)', fontSize: 13, maxWidth: 440, margin: '0 auto 24px', lineHeight: 1.5 }
      }, "The database is team-specific. Select a team to view and manage its individuals, notes, resources, and tables. Data from linked teams will be clearly marked."),
      React.createElement("div", {
        style: { display: 'flex', flexDirection: 'column', gap: 8, maxWidth: 360, margin: '0 auto' }
      },
        (teams || []).map(t => {
          const tColor = `hsl(${t.color_hue || 260}, 60%, 55%)`;
          return React.createElement("button", {
            key: t.roomId,
            className: "card",
            style: { display: 'flex', alignItems: 'center', gap: 12, padding: '14px 18px', cursor: 'pointer', border: `1px solid ${tColor}33`, transition: 'all .15s', textAlign: 'left' },
            onClick: () => {
              // Trigger team context switch via the parent switchTeamContext
              if (typeof window.__khoraSwitchTeam === 'function') window.__khoraSwitchTeam(t.roomId);
            },
            onMouseEnter: e => { e.currentTarget.style.borderColor = tColor; e.currentTarget.style.background = `${tColor}11`; },
            onMouseLeave: e => { e.currentTarget.style.borderColor = `${tColor}33`; e.currentTarget.style.background = ''; }
          },
            React.createElement("span", { style: { width: 12, height: 12, borderRadius: '50%', background: tColor, flexShrink: 0 } }),
            React.createElement("div", { style: { flex: 1 } },
              React.createElement("div", { style: { fontWeight: 700, fontSize: 13.5 } }, t.name || 'Unnamed Team'),
              React.createElement("div", { style: { fontSize: 11, color: 'var(--tx-2)', marginTop: 2 } },
                (t.members || []).length, ' members',
                t.hierarchy?.parent_team_name ? ` · nested under ${t.hierarchy.parent_team_name}` : '',
                (t.customTables || []).filter(tb => tb.status === 'active').length > 0
                  ? ` · ${(t.customTables || []).filter(tb => tb.status === 'active').length} tables`
                  : ''
              )
            ),
            React.createElement(I, { n: "chevronRight", s: 14, c: "var(--tx-3)" })
          );
        })
      )
    );
  }

  return /*#__PURE__*/React.createElement("div", {
    className: `anim-up db-view${sidebarCollapsed ? ' db-full-width' : ''}`
  },
  // ── Team scope header ──
  isTeamScoped && React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 10, padding: '10px 16px', marginBottom: 14, background: `hsla(${activeTeamObj.color_hue || 260}, 60%, 55%, 0.08)`, border: `1px solid hsla(${activeTeamObj.color_hue || 260}, 60%, 55%, 0.2)`, borderRadius: 'var(--r-lg)' }
  },
    React.createElement("span", { style: { width: 10, height: 10, borderRadius: '50%', background: `hsl(${activeTeamObj.color_hue || 260}, 60%, 55%)`, flexShrink: 0 } }),
    React.createElement(I, { n: "database", s: 14, c: `hsl(${activeTeamObj.color_hue || 260}, 60%, 55%)` }),
    React.createElement("span", { style: { fontSize: 12.5, fontWeight: 700 } }, activeTeamObj.name, " Database"),
    React.createElement("span", { style: { fontSize: 11, color: 'var(--tx-3)' } }, "\u00B7 ", (activeTeamObj.members || []).length, " members"),
    // Holonic merge indicator
    hasHolonicData && React.createElement("span", {
      className: "tag tag-teal",
      style: { fontSize: 8, display: 'inline-flex', alignItems: 'center', gap: 3 },
      title: `Includes rolled-up data from ${childTeamObjs.length} sub-team(s): ${childTeamObjs.map(c => c.name).join(', ')}`
    }, React.createElement(I, { n: "layers", s: 8, c: "var(--teal)" }), "\u21A5 HOLONIC MERGE \u00B7 ", childTeamObjs.length, " sub-team", childTeamObjs.length !== 1 ? "s" : ""),
    hasCrossTeamLinks && React.createElement("span", {
      className: "tag tag-purple",
      style: { fontSize: 8, display: 'inline-flex', alignItems: 'center', gap: 3 },
      title: `${crossTeamLinks.length} linked record(s) from other teams`
    }, React.createElement(I, { n: "link", s: 8, c: "var(--purple)" }), "CROSS-TEAM LINKS \u00B7 ", crossTeamLinks.length)
  ),
  // ── Holonic data detail banner ──
  isTeamScoped && hasHolonicData && React.createElement("div", {
    style: { background: 'var(--teal-dim)', border: '1px solid rgba(62,201,176,.15)', borderRadius: 'var(--r)', padding: '8px 14px', marginBottom: 12, fontSize: 11, color: 'var(--tx-1)', lineHeight: 1.5 }
  },
    React.createElement("strong", { style: { color: 'var(--teal)' } }, "Holonic data merge: "),
    "This team includes rolled-up data from ", childTeamObjs.length, " sub-team", childTeamObjs.length !== 1 ? "s" : "", " (",
    childTeamObjs.map((ct, i) => React.createElement(React.Fragment, { key: ct.roomId },
      i > 0 && ", ",
      React.createElement("strong", null, ct.name)
    )),
    "). Sub-team data is aggregated per table rollup policies. Rows originating from sub-teams are tagged with their source."
  ),
  /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 8
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, isTeamScoped ? activeTeamObj.name + " Database" : "Database"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 2
    }
  }, isTeamScoped ? `Team-specific data for ${activeTeamObj.name}. ${hasHolonicData ? 'Includes holonic data from sub-teams.' : ''}` : "Manage individuals, notes, and resources in one place."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: rosterRoom,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Database",
    extra: [{ label: 'Storage model', value: 'Individuals are stored across bridge rooms (one per client-provider relationship). Notes are stored in bridge or roster rooms. Resources are stored in org room state events.' }, { label: 'Roster room', value: rosterRoom || 'Not initialized' }, orgRoom ? { label: 'Org room', value: orgRoom } : null, networkRoom ? { label: 'Network room', value: networkRoom } : null].filter(Boolean)
  }))), /*#__PURE__*/React.createElement("div", {
    className: "db-tabs"
  }, [{
    id: 'individuals',
    label: 'Individuals',
    count: allIndividuals.length,
    icon: 'users'
  }, {
    id: 'notes',
    label: 'Notes',
    count: (notes || []).length,
    icon: 'msg'
  }, {
    id: 'resources',
    label: 'Resources',
    count: (resourceTypes || []).length,
    icon: 'layers'
  }, {
    id: 'definitions',
    label: 'Definitions',
    count: Object.keys(fieldDefs || {}).length,
    icon: 'grid'
  }, {
    id: 'tables',
    label: 'Tables',
    count: (activeTeamObj?.customTables || []).filter(t => t.status === 'active').length,
    icon: 'database'
  }, {
    id: 'trash',
    label: 'Trash',
    count: Object.keys(trashedIndividuals || {}).length,
    icon: 'trash'
  }].map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    className: 'db-tab' + (dbTab === tab.id ? ' active' : ''),
    onClick: () => setDbTab(tab.id)
  }, /*#__PURE__*/React.createElement(I, {
    n: tab.icon,
    s: 13
  }), tab.label, /*#__PURE__*/React.createElement("span", {
    className: "db-tab-count"
  }, tab.count)))), dbTab === 'individuals' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(140px,1fr))',
      gap: 10,
      marginBottom: 16
    }
  }, indStats.map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: 12
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      display: 'block',
      marginTop: 2
    }
  }, s.v)))), /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }
  },
  // Add Column button (primary action)
  /*#__PURE__*/React.createElement("button", {
    className: "b-pri b-sm",
    style: { display: 'flex', alignItems: 'center', gap: 4 },
    onClick: () => setAddColumnModal(true)
  }, /*#__PURE__*/React.createElement(I, { n: "plus", s: 11 }), "Add Column"),
  // Quick-add from existing definitions dropdown
  /*#__PURE__*/React.createElement("div", {
    className: "dt-dd-wrap",
    style: { position: 'relative' }
  }, /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-sm",
    style: { display: 'flex', alignItems: 'center', gap: 4 },
    onClick: () => setAddFieldDd(!addFieldDd)
  }, /*#__PURE__*/React.createElement(I, { n: "grid", s: 11 }), "Columns (", (IND_COLS.length - 6 + enabledFieldCols.filter(k => !fieldKeys.has(k)).length), ")"), addFieldDd && /*#__PURE__*/React.createElement("div", {
    className: "dt-dd",
    style: { minWidth: 280, maxHeight: 360, overflow: 'auto' }
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-dd-label"
  }, "Toggle column visibility"), Object.values(fieldDefs || {}).filter(d => d.key !== 'full_name').map(d => {
    const isEnabled = fieldKeys.has(d.key) || enabledFieldCols.includes(d.key);
    return /*#__PURE__*/React.createElement("div", {
      key: d.uri || d.key,
      className: "dt-dd-item",
      style: { display: 'flex', alignItems: 'center', gap: 8 },
      onClick: () => {
        if (isEnabled && !fieldKeys.has(d.key)) {
          setEnabledFieldCols(prev => prev.filter(x => x !== d.key));
        } else if (!isEnabled) {
          // Require definition for any column
          if (!d.definition || d.definition.length < 10) {
            if (showToast) showToast('This field needs a definition before it can be added as a column. Use "Add Column" to create one with a definition.', 'warning');
            setAddFieldDd(false);
            return;
          }
          setEnabledFieldCols(prev => [...prev, d.key]);
        }
        setAddFieldDd(false);
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: { width: 14, height: 14, borderRadius: 3, border: '1.5px solid ' + (isEnabled ? 'var(--teal)' : 'var(--border-1)'), background: isEnabled ? 'var(--teal)' : 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }
    }, isEnabled && /*#__PURE__*/React.createElement("span", { style: { color: '#fff', fontSize: 9, fontWeight: 700 } }, "\u2713")),
    /*#__PURE__*/React.createElement("div", { style: { flex: 1, minWidth: 0 } },
      /*#__PURE__*/React.createElement("div", { style: { fontWeight: 500, fontSize: 12 } }, d.label || d.key),
      /*#__PURE__*/React.createElement("div", { style: { fontSize: 9.5, color: 'var(--tx-3)', marginTop: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } },
        d.definition ? d.definition.slice(0, 50) + (d.definition.length > 50 ? '...' : '') : '\u26A0 No definition')),
    fieldKeys.has(d.key) && /*#__PURE__*/React.createElement("span", { className: "tag tag-green", style: { fontSize: 7, flexShrink: 0 } }, "DATA"));
  }),
  /*#__PURE__*/React.createElement("div", {
    className: "dt-dd-item",
    style: { borderTop: '1px solid var(--border-0)', color: 'var(--purple)', fontWeight: 600, fontSize: 11.5, marginTop: 4, display: 'flex', alignItems: 'center', gap: 4 },
    onClick: () => { setAddFieldDd(false); setAddColumnModal(true); }
  }, /*#__PURE__*/React.createElement(I, { n: "plus", s: 10, c: "var(--purple)" }), "Create New Column..."))),
  // Team governance indicator
  teamMode && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-purple",
    style: { fontSize: 9, display: 'inline-flex', alignItems: 'center', gap: 3 }
  }, /*#__PURE__*/React.createElement(I, { n: "shieldCheck", s: 9, c: "var(--purple)" }),
    (() => {
      const at = activeTeamObj || (teamMode ? (teams || []).find(t => t.roomId === teamMode.roomId) : null);
      const mode = at?.schemaRule?.mode || 'lead_decides';
      return (TEAM_CONSENT_MODES[mode] || TEAM_CONSENT_MODES.lead_decides).label;
    })(), " governance"),
  // Active column chips
  enabledFieldCols.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 4, flexWrap: 'wrap', alignItems: 'center' }
  }, enabledFieldCols.map(k => {
    const def = Object.values(fieldDefs || {}).find(d => d.key === k);
    return /*#__PURE__*/React.createElement("span", {
      key: k,
      className: "tag tag-teal",
      style: { fontSize: 10, display: 'inline-flex', alignItems: 'center', gap: 3, cursor: 'pointer' },
      title: def?.definition ? def.definition.slice(0, 100) : 'Click to remove column',
      onClick: () => setEnabledFieldCols(prev => prev.filter(x => x !== k))
    }, def?.label || k, " \u00d7");
  }))),
  // Add Column Modal
  /*#__PURE__*/React.createElement(AddColumnModal, {
    open: addColumnModal,
    onClose: (addedKey) => { setAddColumnModal(false); if (addedKey) setEnabledFieldCols(prev => prev.includes(addedKey) ? prev : [...prev, addedKey]); },
    onSave: async (def) => {
      // Save field definition
      const schemaRoom = svc.client ? svc.client.getRooms().find(r => {
        const id = r.currentState.getStateEvents(EVT.IDENTITY, '');
        return id?.getContent()?.account_type === 'schema' && id.getContent().owner === svc.userId;
      })?.roomId : null;
      if (schemaRoom) {
        const updated = { ...fieldDefs, [def.uri]: def };
        await svc.setState(schemaRoom, EVT.FIELD_DEF, { definitions: updated });
      }
      // Add as enabled column
      setEnabledFieldCols(prev => prev.includes(def.key) ? prev : [...prev, def.key]);
    },
    onPropose: onPropose,
    fieldDefs: fieldDefs,
    teams: teams,
    teamMode: teamMode,
    activeTeamObj: activeTeamObj,
    svc: svc,
    orgRoom: orgRoom,
    networkRoom: networkRoom,
    showToast: showToast,
    fieldGovernanceConfig: fieldGovernanceConfig
  }),
  /*#__PURE__*/React.createElement(DataTable, {
    data: allIndividuals,
    columns: IND_COLS,
    groupOptions: IND_GROUPS,
    defaultVisibleCols: defaultVisCols,
    onRowClick: row => onOpenIndividual ? onOpenIndividual(row) : row._case ? openCase(row._case.bridgeRoomId) : null,
    renderCell: renderIndCell,
    getVal: getIndVal,
    label: "individuals",
    selectable: true,
    bulkActions: [{
      id: 'assign',
      label: 'Assign',
      cls: 'b-gho b-xs',
      icon: 'briefcase'
    }, {
      id: 'tag',
      label: 'Tag',
      cls: 'b-gho b-xs',
      icon: 'users'
    }, {
      id: 'delete',
      label: 'Delete',
      cls: 'b-red b-xs',
      icon: 'trash'
    }],
    onBulkAction: onBulkAction,
    draggable: true,
    onReorder: onReorder,
    editable: true,
    onCellEdit: onCellEdit,
    onAddRow: onAddRow || onCreateClient,
    addRowLabel: `Add ${T?.client_term || 'Individual'}`
  })), dbTab === 'notes' && /*#__PURE__*/React.createElement(NotesTable, {
    notes: notes,
    individuals: allIndividuals,
    onNoteClick: onNoteClick,
    onNewNote: onNewNote,
    T: T
  }), dbTab === 'resources' && /*#__PURE__*/React.createElement(ResourcesTableView, {
    resourceTypes: resourceTypes,
    resourceRelations: resourceRelations,
    resourceInventory: resourceInventory,
    T: T,
    svc: svc,
    orgRole: orgRole,
    orgRoom: orgRoom,
    rosterRoom: rosterRoom,
    networkRoom: networkRoom,
    allAllocations: allAllocations,
    onCreateResource: onCreateResource,
    onRefresh: onRefresh,
    onRestock: onRestock,
    onEstablishRelation: onEstablishRelation,
    canViewResource: canViewResource,
    canControlResource: canControlResource,
    canAllocateResource: canAllocateResource,
    individuals: cases
  }), dbTab === 'definitions' && /*#__PURE__*/React.createElement(FieldDictionaryView, {
    fieldDefs: fieldDefs || {},
    fieldCrosswalks: fieldCrosswalks || [],
    teams: teams || [],
    onSaveFieldDef: onSaveFieldDef,
    onSaveCrosswalk: onSaveCrosswalk,
    svc: svc,
    orgRoom: orgRoom,
    networkRoom: networkRoom,
    showToast: showToast,
    fieldGovernanceConfig: fieldGovernanceConfig,
    onPropose: onPropose
  }),
  dbTab === 'tables' && React.createElement('div', { className: 'anim-up' },
    !activeTeamObj
      ? React.createElement('div', { style: { textAlign: 'center', padding: '40px 20px', color: 'var(--tx-3)' } },
          React.createElement(I, { n: 'database', s: 32, c: 'var(--border-1)' }),
          React.createElement('p', { style: { marginTop: 10, fontSize: 13 } }, 'Custom tables are team-specific.'),
          React.createElement('p', { style: { fontSize: 12, marginTop: 4 } }, 'Select a team context from the sidebar to view and create tables.'))
      : React.createElement(React.Fragment, null,
          // Team context header + create button
          React.createElement('div', { style: { display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', marginBottom: 16 } },
            React.createElement('div', null,
              React.createElement('div', { style: { fontWeight: 700, fontSize: 14 } }, activeTeamObj.name, ' Tables'),
              React.createElement('div', { style: { fontSize: 11, color: 'var(--tx-2)', marginTop: 2, display: 'flex', alignItems: 'center', gap: 6 } },
                (() => {
                  const mode = activeTeamObj.schemaRule?.mode || 'lead_decides';
                  const cm = TEAM_CONSENT_MODES[mode] || TEAM_CONSENT_MODES.lead_decides;
                  const govColor = cm.color === 'gold' ? 'var(--gold)' : cm.color === 'green' ? 'var(--green)' : 'var(--blue)';
                  return React.createElement(React.Fragment, null,
                    React.createElement(I, { n: 'shieldCheck', s: 10, c: govColor }),
                    React.createElement('span', { style: { color: govColor } }, cm.label, ' governance'),
                    React.createElement('span', { style: { color: 'var(--tx-3)' } }, '\u00B7'),
                    cm.id !== 'lead_decides'
                      ? React.createElement('span', null, 'Table creation requires approval from team members')
                      : React.createElement('span', null, 'Team lead can create tables immediately')
                  );
                })(),
                // Parent team rollup notice
                activeTeamObj.hierarchy?.parent_team_name && React.createElement('span', { style: { marginLeft: 6 } },
                  React.createElement('span', { style: { color: 'var(--teal)' } },
                    '\u21A5 nested under ', activeTeamObj.hierarchy.parent_team_name))
              )
            ),
            React.createElement('button', {
              className: 'b-pri b-sm',
              style: { display: 'flex', alignItems: 'center', gap: 4 },
              onClick: () => onCreateTable && onCreateTable(activeTeamObj)
            }, React.createElement(I, { n: 'plus', s: 11 }), 'New Table')
          ),

          // Pending proposals notice
          (() => {
            const pending = (activeTeamObj.schema?.pending_changes || []).filter(c => c.action === 'create_table');
            if (pending.length === 0) return null;
            return React.createElement('div', { style: { background: 'var(--gold-dim)', border: '1px solid rgba(201,163,82,.2)', borderRadius: 'var(--r)', padding: '10px 14px', marginBottom: 12 } },
              React.createElement('div', { style: { fontWeight: 600, fontSize: 11.5, color: 'var(--gold)', display: 'flex', alignItems: 'center', gap: 6 } },
                React.createElement(I, { n: 'shieldCheck', s: 12, c: 'var(--gold)' }),
                pending.length, ' table', pending.length > 1 ? 's' : '', ' pending governance approval'),
              pending.map(p => React.createElement('div', { key: p.id, style: { fontSize: 11, color: 'var(--tx-1)', marginTop: 4, display: 'flex', align: 'center', gap: 6 } },
                React.createElement('span', { className: 'tag tag-gold', style: { fontSize: 8 } }, 'PENDING'),
                React.createElement('strong', null, p.table_definition?.name),
                ' — proposed by ', p.proposed_by?.split(':')[0]?.replace('@', '') || 'unknown',
                ' on ', new Date(p.proposed_at).toLocaleDateString()
              ))
            );
          })(),

          // Child teams with rollup tables
          (() => {
            const children = activeTeamObj.hierarchy?.child_teams || [];
            const childTeamObjs = children.map(c => (teams || []).find(t => t.roomId === c.roomId)).filter(Boolean);
            const rollupTables = childTeamObjs.flatMap(ct =>
              (ct.customTables || []).filter(t => t.status === 'active' && t.rollup_to_parent).map(t => ({ ...t, _fromTeam: ct }))
            );
            if (rollupTables.length === 0) return null;
            return React.createElement('div', { style: { marginBottom: 16 } },
              React.createElement('div', { className: 'section-label', style: { marginBottom: 8 } }, 'ROLLED UP FROM SUB-TEAMS'),
              rollupTables.map(t =>
                React.createElement('div', { key: t.id, style: { background: 'var(--teal-dim)', border: '1px solid rgba(62,201,176,.15)', borderRadius: 'var(--r)', padding: '10px 14px', marginBottom: 8, display: 'flex', alignItems: 'center', gap: 10, cursor: 'pointer' },
                  onClick: () => onOpenTable && onOpenTable(t, t._fromTeam)
                },
                  React.createElement(I, { n: 'database', s: 14, c: 'var(--teal)' }),
                  React.createElement('div', { style: { flex: 1 } },
                    React.createElement('div', { style: { fontWeight: 600, fontSize: 12.5 } }, t.name),
                    React.createElement('div', { style: { fontSize: 10.5, color: 'var(--tx-2)', marginTop: 1 } }, 'From: ', t._fromTeam.name, ' \u00B7 ', (t.columns || []).length, ' columns'),
                    t.description && React.createElement('div', { style: { fontSize: 10, color: 'var(--tx-3)', marginTop: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, t.description)
                  ),
                  React.createElement('span', { className: 'tag tag-teal', style: { fontSize: 8 } }, '\u21A5 ROLLUP')
                )
              )
            );
          })(),

          // Own tables grid
          (() => {
            const ownTables = (activeTeamObj.customTables || []).filter(t => t.status === 'active');
            if (ownTables.length === 0) {
              return React.createElement('div', { style: { textAlign: 'center', padding: '40px 20px', color: 'var(--tx-3)' } },
                React.createElement(I, { n: 'database', s: 28, c: 'var(--border-1)' }),
                React.createElement('p', { style: { marginTop: 8, fontSize: 13 } }, 'No tables yet.'),
                React.createElement('p', { style: { fontSize: 11, marginTop: 4 } }, 'Tables are team-specific and subject to governance rules before activation.'));
            }
            return React.createElement('div', null,
              React.createElement('div', { className: 'section-label', style: { marginBottom: 8 } }, 'TEAM TABLES'),
              React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(240px, 1fr))', gap: 10 } },
                ownTables.map(t =>
                  React.createElement('div', {
                    key: t.id,
                    className: 'card',
                    style: { padding: '12px 14px', cursor: 'pointer', transition: 'border-color .15s' },
                    onClick: () => onOpenTable && onOpenTable(t, activeTeamObj)
                  },
                    React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 6 } },
                      React.createElement(I, { n: 'database', s: 14, c: 'var(--purple)' }),
                      React.createElement('div', { style: { fontWeight: 700, fontSize: 13, flex: 1 } }, t.name),
                      t.rollup_to_parent && React.createElement('span', { className: 'tag tag-teal', style: { fontSize: 7 } }, '\u21A5 ROLLUP')
                    ),
                    React.createElement('p', { style: { fontSize: 10.5, color: 'var(--tx-2)', lineHeight: 1.4, marginBottom: 6 } },
                      (t.description || '').slice(0, 80), (t.description || '').length > 80 ? '...' : ''),
                    React.createElement('div', { style: { display: 'flex', gap: 6, flexWrap: 'wrap' } },
                      React.createElement('span', { className: 'tag tag-blue', style: { fontSize: 8 } }, (t.columns || []).length, ' col', (t.columns || []).length !== 1 ? 's' : ''),
                      React.createElement('span', { className: 'tag tag-purple', style: { fontSize: 8 } }, 'v', t.version || 1)
                    )
                  )
                )
              )
            );
          })()
        )
  ),
  dbTab === 'trash' && React.createElement('div', { className: 'anim-up' },
    Object.keys(trashedIndividuals || {}).length === 0
      ? React.createElement('div', { style: { textAlign: 'center', padding: '60px 20px', color: 'var(--tx-3)' } },
          React.createElement(I, { n: 'trash', s: 32, c: 'var(--border-1)' }),
          React.createElement('p', { style: { marginTop: 12, fontSize: 13, fontWeight: 500 } }, 'Trash is empty'),
          React.createElement('p', { style: { fontSize: 11, marginTop: 4, color: 'var(--tx-3)' } }, 'Deleted individuals will appear here and can be restored.'))
      : React.createElement('div', null,
          React.createElement('span', { className: 'section-label', style: { display: 'block', marginBottom: 10 } }, 'DELETED INDIVIDUALS — click Restore to recover'),
          Object.entries(trashedIndividuals || {}).map(([roomId, info]) =>
            React.createElement('div', {
              key: roomId,
              style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px 14px', borderRadius: 'var(--r)', border: '1px solid var(--border-0)', background: 'var(--bg-2)', marginBottom: 6, gap: 12 }
            },
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                React.createElement('div', {
                  style: { width: 28, height: 28, borderRadius: '50%', background: 'var(--border-1)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--tx-2)', fontSize: 12, fontWeight: 700, flexShrink: 0 }
                }, (info.name || '?')[0].toUpperCase()),
                React.createElement('div', null,
                  React.createElement('div', { style: { fontWeight: 600, fontSize: 13 } }, info.name || 'Unknown'),
                  React.createElement('div', { style: { fontSize: 11, color: 'var(--tx-3)', marginTop: 2 } },
                    'Deleted by ', (info.deletedBy || '').split(':')[0]?.replace('@', '') || '?',
                    ' \u00B7 ', info.deletedAt ? new Date(info.deletedAt).toLocaleDateString() : 'Unknown date'),
                  React.createElement('div', { style: { fontSize: 10, color: 'var(--tx-3)', fontFamily: 'var(--mono)', marginTop: 2 } }, roomId)
                )
              ),
              React.createElement('button', {
                className: 'b-gho b-sm',
                style: { display: 'flex', alignItems: 'center', gap: 4, whiteSpace: 'nowrap' },
                onClick: () => onRestoreIndividual && onRestoreIndividual(roomId)
              }, React.createElement(I, { n: 'check', s: 11 }), 'Restore')
            )
          )
        )
  )
  );
};

/* ─── Wikidata definition fetcher ─── */
const _wikidataCache = {};
const WIKIDATA_SEARCH_LABELS = {
  'full_name': 'personal name',
  'dob': 'date of birth',
  'id_number': 'identity document',
  'email': 'email address',
  'phone': 'telephone number',
  'address': 'street address',
  'affiliation': 'organizational affiliation',
  'case_notes': 'case note',
  'documents': 'document',
  'history': 'case history',
  'restricted_notes': 'classified information'
};
async function fetchWikidataDefinition(fieldKey, label) {
  const searchTerm = WIKIDATA_SEARCH_LABELS[fieldKey] || label;
  if (_wikidataCache[searchTerm]) return _wikidataCache[searchTerm];
  try {
    const url = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(searchTerm)}&language=en&limit=1&format=json&origin=*`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('Wikidata search failed');
    const data = await resp.json();
    if (!data.search || data.search.length === 0) {
      _wikidataCache[searchTerm] = null;
      return null;
    }
    const entity = data.search[0];
    const entityId = entity.id;
    const detailUrl = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${entityId}&languages=en&props=descriptions|sitelinks&format=json&origin=*`;
    const detailResp = await fetch(detailUrl);
    if (!detailResp.ok) throw new Error('Wikidata entity fetch failed');
    const detailData = await detailResp.json();
    const ent = detailData.entities?.[entityId];
    const description = ent?.descriptions?.en?.value || entity.description || '';
    const wpTitle = ent?.sitelinks?.enwiki?.title || null;
    const result = {
      id: entityId,
      label: entity.label,
      description: description,
      wikidataUrl: `https://www.wikidata.org/wiki/${entityId}`,
      wikipediaUrl: wpTitle ? `https://en.wikipedia.org/wiki/${encodeURIComponent(wpTitle)}` : null
    };
    _wikidataCache[searchTerm] = result;
    return result;
  } catch (e) {
    console.debug('Wikidata fetch error:', e.message);
    _wikidataCache[searchTerm] = null;
    return null;
  }
}

/* ─── Fields that are self-explanatory — don't cite HUD authority ─── */
const SIMPLE_FIELD_KEYS = new Set(['full_name', 'email', 'phone', 'address', 'affiliation', 'case_notes', 'documents']);

/* ─── DefinitionPopup — slide-from-right panel for field definitions ─── */
const DefinitionPopup = ({ fieldDef, fieldDefs, fieldCrosswalks, onClose, onSaveCrosswalk, onSaveFieldDef, teams, svc, orgRoom, networkRoom, showToast, onEvolve, onMerge }) => {
  const [wikiData, setWikiData] = useState(null);
  const [wikiLoading, setWikiLoading] = useState(false);
  const [addCrosswalkFor, setAddCrosswalkFor] = useState(false);
  const [xwTargetUri, setXwTargetUri] = useState('');
  const [xwRelationship, setXwRelationship] = useState('equivalent');
  const [xwNotes, setXwNotes] = useState('');
  const [editingAuthority, setEditingAuthority] = useState(false);
  const [authDraft, setAuthDraft] = useState({ org: '', name: '', provision: '', uri: '' });
  const [authUriBrowserOpen, setAuthUriBrowserOpen] = useState(false);
  const d = fieldDef;
  if (!d) return null;

  // Reset authority draft when field changes
  React.useEffect(() => {
    setAuthDraft({
      org: d.authority?.org || '',
      name: d.authority?.name || '',
      provision: d.authority?.provision || '',
      uri: d.authority?.uri || ''
    });
    setEditingAuthority(false);
  }, [d.uri]);

  const saveAuthority = async () => {
    const hasValues = authDraft.org || authDraft.name;
    const newAuthority = hasValues ? { ...authDraft } : null;
    const updated = { ...d, authority: newAuthority };

    // Check if field is in use by any team schema
    const teamsUsing = (teams || []).filter(t => t.schema?.fields?.some(f => f.uri === d.uri));

    if (teamsUsing.length > 0 && (orgRoom || networkRoom)) {
      // Field is in use — create governance proposal
      const targetRoom = networkRoom || orgRoom;
      const proposal = {
        id: 'prop_auth_' + d.key + '_' + Date.now(),
        type: 'field_authority_change',
        summary: `Change authority on "${d.label}" field`,
        detail: newAuthority
          ? `Set authority to: ${newAuthority.org} — ${newAuthority.name}${newAuthority.provision ? ' (' + newAuthority.provision + ')' : ''}`
          : `Remove authority from "${d.label}"`,
        field_uri: d.uri,
        proposed_authority: newAuthority,
        previous_authority: d.authority || null,
        affected_teams: teamsUsing.map(t => ({ id: t.id, name: t.name })),
        proposed_by: svc?.userId,
        proposed_at: Date.now(),
        status: 'submitted',
        positions: {}
      };
      if (svc) await svc.setState(targetRoom, EVT.GOV_PROPOSAL, proposal, proposal.id);
      if (showToast) showToast(`Governance proposal created — ${teamsUsing.length} team(s) use this field`);
      setEditingAuthority(false);
    } else {
      // Field not in use — apply directly
      if (onSaveFieldDef) await onSaveFieldDef(updated);
      if (showToast) showToast('Authority updated');
      setEditingAuthority(false);
    }
  };

  const isSimple = SIMPLE_FIELD_KEYS.has(d.key);
  const getSource = uri => {
    if (uri?.startsWith('khora:vault/')) return { label: 'Vault', color: 'gold' };
    if (uri?.startsWith('khora:team/')) return { label: 'Team', color: 'purple' };
    if (uri?.startsWith('khora:org/')) return { label: 'Org', color: 'blue' };
    return { label: 'External', color: 'teal' };
  };
  const src = getSource(d.uri);
  const getCrosswalksForUri = uri => (fieldCrosswalks || []).filter(xw => xw.from_uri === uri || (xw.bidirectional && xw.to_uri === uri));
  const xws = getCrosswalksForUri(d.uri);

  // Fetch Wikidata definition on mount
  React.useEffect(() => {
    let cancelled = false;
    setWikiLoading(true);
    setWikiData(null);
    fetchWikidataDefinition(d.key, d.label).then(result => {
      if (!cancelled) {
        setWikiData(result);
        setWikiLoading(false);
      }
    });
    return () => { cancelled = true; };
  }, [d.uri, d.key]);

  return React.createElement(React.Fragment, null,
    React.createElement('div', { className: 'def-popup-overlay', onClick: onClose }),
    React.createElement('div', { className: 'def-popup' },
      /* Header */
      React.createElement('div', { className: 'def-popup-head' },
        React.createElement('div', null,
          React.createElement('h3', null, d.label),
          React.createElement('div', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginTop: 3 } }, d.uri),
          React.createElement('div', { style: { display: 'flex', gap: 4, marginTop: 8 } },
            React.createElement('span', { className: `tag tag-${src.color}`, style: { fontSize: 9 } }, src.label),
            React.createElement('span', { className: 'tag tag-blue', style: { fontSize: 9 } }, (d.data_type || 'text').toUpperCase()),
            d.sensitive && React.createElement('span', { className: 'tag tag-red', style: { fontSize: 9 } },
              React.createElement(I, { n: 'lock', s: 8 }), 'Sensitive')
          )
        ),
        React.createElement('div', { style: { display: 'flex', gap: 4, marginLeft: 'auto', marginRight: 8 } },
          onEvolve && React.createElement('button', { className: 'b-gho b-xs', onClick: () => onEvolve(d), style: { display: 'flex', alignItems: 'center', gap: 3, fontSize: 10 } },
            React.createElement(I, { n: 'layers', s: 10 }), 'Evolve'),
          onMerge && React.createElement('button', { className: 'b-gho b-xs', onClick: () => onMerge(d), style: { display: 'flex', alignItems: 'center', gap: 3, fontSize: 10 } },
            React.createElement(I, { n: 'grid', s: 10 }), 'Merge with...')
        ),
        React.createElement('button', { className: 'def-popup-close', onClick: onClose }, '\u2715')
      ),
      // Version badge
      (d.version && d.version > 1) && React.createElement('div', { style: { padding: '6px 18px', borderBottom: '1px solid var(--border-0)', display: 'flex', gap: 6, alignItems: 'center' } },
        React.createElement('span', { className: 'cf-migrate-badge current' }, 'v', d.version),
        (d.version_history || []).length > 0 && React.createElement('span', { style: { fontSize: 10, color: 'var(--tx-3)' } }, d.version_history.length, ' previous version(s)'),
        d.superseded_by && React.createElement('span', { className: 'cf-migrate-badge outdated' }, 'Superseded')
      ),
      /* Body */
      React.createElement('div', { className: 'def-popup-body' },
        /* Wikidata section */
        React.createElement('div', { className: 'def-popup-section' },
          React.createElement('span', { className: 'def-popup-section-label' }, 'Wikidata'),
          wikiLoading
            ? React.createElement('div', { className: 'def-popup-loading' }, 'Looking up on Wikidata\u2026')
            : wikiData
              ? React.createElement('div', { className: 'def-popup-wiki' },
                  React.createElement('div', { className: 'def-popup-wiki-label' },
                    React.createElement('span', { style: { fontSize: 13 } }, '\u{1F310}'),
                    wikiData.label, ' (', wikiData.id, ')'
                  ),
                  React.createElement('div', { className: 'def-popup-wiki-desc' }, wikiData.description),
                  React.createElement('div', { style: { display: 'flex', gap: 10 } },
                    React.createElement('a', { className: 'def-popup-wiki-link', href: wikiData.wikidataUrl, target: '_blank', rel: 'noopener' }, 'Wikidata \u2197'),
                    wikiData.wikipediaUrl && React.createElement('a', { className: 'def-popup-wiki-link', href: wikiData.wikipediaUrl, target: '_blank', rel: 'noopener' }, 'Wikipedia \u2197')
                  )
                )
              : React.createElement('div', { style: { fontSize: 11.5, color: 'var(--tx-3)', padding: '8px 0' } }, 'No Wikidata entry found.')
        ),
        /* Definition */
        React.createElement('div', { className: 'def-popup-section' },
          React.createElement('span', { className: 'def-popup-section-label' }, 'Definition'),
          React.createElement('p', { style: { fontSize: 12.5, lineHeight: 1.6, color: 'var(--tx-1)' } },
            d.definition || 'No definition provided.')
        ),
        /* Scope */
        d.scope && React.createElement('div', { className: 'def-popup-section' },
          React.createElement('span', { className: 'def-popup-section-label' }, 'Scope'),
          React.createElement('p', { style: { fontSize: 12, lineHeight: 1.5, color: 'var(--tx-2)' } }, d.scope)
        ),
        /* Authority — editable */
        React.createElement('div', { className: 'def-popup-section' },
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
            React.createElement('span', { className: 'def-popup-section-label' }, 'Authority'),
            !editingAuthority && React.createElement('button', {
              className: 'b-gho b-xs',
              onClick: () => setEditingAuthority(true),
              style: { display: 'flex', alignItems: 'center', gap: 3 }
            }, React.createElement(I, { n: 'pencil', s: 10 }), d.authority ? 'Edit' : 'Add')
          ),
          !editingAuthority && d.authority && React.createElement('div',
            { style: { display: 'flex', alignItems: 'center', gap: 8, marginTop: 4 } },
            React.createElement('span', { className: 'tag tag-teal', style: { fontSize: 9 } }, d.authority.org || 'External'),
            React.createElement('span', { style: { fontSize: 11.5, color: 'var(--tx-1)' } }, d.authority.name),
            d.authority.provision && React.createElement('span', { style: { fontFamily: 'var(--mono)', fontSize: 10, color: 'var(--tx-2)' } }, d.authority.provision)
          ),
          !editingAuthority && !d.authority && React.createElement('div',
            { style: { fontSize: 11, color: 'var(--tx-3)', marginTop: 4 } }, 'No authority set'),
          editingAuthority && React.createElement('div', { style: { marginTop: 8, display: 'flex', flexDirection: 'column', gap: 6 } },
            React.createElement('input', { placeholder: 'Organization (e.g. HUD)', value: authDraft.org,
              onChange: e => setAuthDraft({...authDraft, org: e.target.value}),
              style: { fontSize: 12, padding: '4px 8px', border: '1px solid var(--border-0)', borderRadius: 'var(--r)', background: 'var(--bg-2)', color: 'var(--tx-0)' } }),
            React.createElement('input', { placeholder: 'Standard name (e.g. HMIS Data Standards)', value: authDraft.name,
              onChange: e => setAuthDraft({...authDraft, name: e.target.value}),
              style: { fontSize: 12, padding: '4px 8px', border: '1px solid var(--border-0)', borderRadius: 'var(--r)', background: 'var(--bg-2)', color: 'var(--tx-0)' } }),
            React.createElement('input', { placeholder: 'Provision (e.g. Element 3.01)', value: authDraft.provision,
              onChange: e => setAuthDraft({...authDraft, provision: e.target.value}),
              style: { fontSize: 12, padding: '4px 8px', border: '1px solid var(--border-0)', borderRadius: 'var(--r)', background: 'var(--bg-2)', color: 'var(--tx-0)' } }),
            React.createElement('div', { style: { display: 'flex', gap: 4, alignItems: 'center' } },
              React.createElement('input', { placeholder: 'Reference URI', value: authDraft.uri,
                onChange: e => setAuthDraft({...authDraft, uri: e.target.value}),
                style: { flex: 1, fontSize: 12, padding: '4px 8px', border: '1px solid var(--border-0)', borderRadius: 'var(--r)', background: 'var(--bg-2)', color: 'var(--tx-0)' } }),
              React.createElement('button', { className: 'b-gho b-xs', onClick: () => setAuthUriBrowserOpen(true),
                title: 'Search URI libraries',
                style: { display: 'flex', alignItems: 'center', gap: 3, whiteSpace: 'nowrap', flexShrink: 0 } },
                React.createElement(I, { n: 'search', s: 10 }), 'Search')
            ),
            React.createElement(UriLibraryBrowser, {
              open: authUriBrowserOpen,
              onClose: () => setAuthUriBrowserOpen(false),
              mode: 'select',
              onSelect: entry => {
                setAuthDraft(prev => ({
                  ...prev,
                  uri: entry.uri || prev.uri,
                  org: prev.org || entry.source_library || '',
                  name: prev.name || entry.label || ''
                }));
                setAuthUriBrowserOpen(false);
              }
            }),
            ((teams || []).filter(t => t.schema?.fields?.some(f => f.uri === d.uri)).length > 0) &&
              React.createElement('div', { style: { fontSize: 10, color: 'var(--orange)', padding: '6px 8px', background: 'var(--bg-1)', borderRadius: 'var(--r)', border: '1px solid var(--orange)', opacity: 0.9 } },
                '\u26A0 This field is used by ', (teams || []).filter(t => t.schema?.fields?.some(f => f.uri === d.uri)).length, ' team(s). Saving will create a governance proposal instead of applying directly.'
              ),
            React.createElement('div', { style: { display: 'flex', gap: 6, marginTop: 4 } },
              React.createElement('button', { className: 'b-pri b-xs', onClick: saveAuthority }, 'Save'),
              d.authority && React.createElement('button', { className: 'b-gho b-xs', onClick: () => { setAuthDraft({ org: '', name: '', provision: '', uri: '' }); } }, 'Clear'),
              React.createElement('button', { className: 'b-gho b-xs', onClick: () => setEditingAuthority(false) }, 'Cancel')
            )
          )
        ),
        /* Crosswalks */
        React.createElement('div', { className: 'def-popup-section' },
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
            React.createElement('span', { className: 'def-popup-section-label' }, 'Also Known As'),
            React.createElement('button', { className: 'b-gho b-xs', onClick: () => setAddCrosswalkFor(!addCrosswalkFor),
              style: { display: 'flex', alignItems: 'center', gap: 3 } },
              React.createElement(I, { n: 'plus', s: 10 }), 'Link')
          ),
          xws.length === 0 && !addCrosswalkFor
            ? React.createElement('p', { style: { fontSize: 11, color: 'var(--tx-3)', marginTop: 4 } },
                'No crosswalks. Link this field to equivalent definitions in other contexts.')
            : React.createElement('div', { style: { marginTop: 6, display: 'flex', flexDirection: 'column', gap: 4 } },
                xws.map(xw => {
                  const rel = CROSSWALK_TYPES[xw.relationship] || CROSSWALK_TYPES.related;
                  const targetUri = xw.from_uri === d.uri ? xw.to_uri : xw.from_uri;
                  const targetDef = fieldDefs[targetUri];
                  return React.createElement('div', { key: xw.id, style: { display: 'flex', alignItems: 'center', gap: 8, padding: '6px 10px', background: 'var(--bg-2)', borderRadius: 'var(--r)', border: '1px solid var(--border-0)' } },
                    React.createElement('span', { style: { fontWeight: 700, color: `var(--${rel.color})`, fontSize: 14 }, title: rel.desc }, rel.symbol),
                    React.createElement('div', { style: { flex: 1 } },
                      React.createElement('span', { style: { fontSize: 12, fontWeight: 600 } }, targetDef?.label || targetUri),
                      targetDef?.definition && React.createElement('div', { style: { fontSize: 10.5, color: 'var(--tx-2)', marginTop: 1 } },
                        targetDef.definition.slice(0, 80), targetDef.definition.length > 80 ? '...' : '')
                    ),
                    React.createElement('span', { className: `tag tag-${rel.color}`, style: { fontSize: 8 } }, rel.label)
                  );
                })
              ),
          /* Add crosswalk form */
          addCrosswalkFor && React.createElement('div', { style: { marginTop: 8, padding: '10px 12px', background: 'var(--bg-2)', border: '1px solid var(--border-1)', borderRadius: 'var(--r)' } },
            React.createElement('div', { style: { fontSize: 11, fontWeight: 600, marginBottom: 6 } }, 'Link to field:'),
            React.createElement('div', { style: { display: 'flex', gap: 6, flexWrap: 'wrap', alignItems: 'flex-end' } },
              React.createElement('select', { value: xwTargetUri, onChange: e => setXwTargetUri(e.target.value), style: { flex: 1, minWidth: 140, fontSize: 11, padding: '5px 8px' } },
                React.createElement('option', { value: '' }, '-- select --'),
                Object.values(fieldDefs).filter(fd => fd.uri !== d.uri).map(fd =>
                  React.createElement('option', { key: fd.uri, value: fd.uri }, fd.label, ' (', fd.uri, ')')
                )
              ),
              React.createElement('select', { value: xwRelationship, onChange: e => setXwRelationship(e.target.value), style: { fontSize: 11, padding: '5px 8px', minWidth: 100 } },
                Object.values(CROSSWALK_TYPES).map(ct =>
                  React.createElement('option', { key: ct.id, value: ct.id }, ct.symbol, ' ', ct.label)
                )
              ),
              React.createElement('input', { type: 'text', value: xwNotes, onChange: e => setXwNotes(e.target.value), placeholder: 'Notes...', style: { fontSize: 11, padding: '5px 8px', minWidth: 100, flex: 1 } }),
              React.createElement('button', { className: 'b-pri b-xs', disabled: !xwTargetUri, onClick: () => {
                if (onSaveCrosswalk && xwTargetUri) {
                  onSaveCrosswalk({ id: 'xw_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6), from_uri: d.uri, to_uri: xwTargetUri, relationship: xwRelationship, bidirectional: xwRelationship === 'equivalent' || xwRelationship === 'related', notes: xwNotes || '', created_at: Date.now() });
                  setXwTargetUri(''); setXwNotes(''); setAddCrosswalkFor(false);
                }
              }}, 'Save'),
              React.createElement('button', { className: 'b-gho b-xs', onClick: () => { setAddCrosswalkFor(false); setXwTargetUri(''); setXwNotes(''); }}, 'Cancel')
            )
          )
        )
      )
    )
  );
};

/* ─── FieldDictionaryView — global data dictionary for all field definitions ─── */
const FieldDictionaryView = ({
  fieldDefs,
  fieldCrosswalks,
  teams,
  onSaveFieldDef,
  onSaveCrosswalk,
  svc,
  orgRoom,
  networkRoom,
  showToast,
  fieldGovernanceConfig,
  onPropose
}) => {
  const [expandedUri, setExpandedUri] = useState(null);
  const [crosswalkPopover, setCrosswalkPopover] = useState(null);
  const [potentialCrosswalks, setPotentialCrosswalks] = useState([]);
  const [scanningCrosswalks, setScanningCrosswalks] = useState(false);
  const [createFieldOpen, setCreateFieldOpen] = useState(false);
  const [mergeFieldsOpen, setMergeFieldsOpen] = useState(false);
  const [mergeSelection, setMergeSelection] = useState([]);
  const [evolveFieldOpen, setEvolveFieldOpen] = useState(false);
  const [evolveTarget, setEvolveTarget] = useState(null);
  const scanDone = React.useRef(false);

  // Background scan for potential crosswalks (runs once when tab opens)
  React.useEffect(() => {
    if (scanDone.current || Object.keys(fieldDefs || {}).length < 2) return;
    scanDone.current = true;
    (async () => {
      try {
        setScanningCrosswalks(true);
        const existingPairs = new Set((fieldCrosswalks || []).map(xw => `${xw.from_uri}|${xw.to_uri}`));
        const defs = Object.values(fieldDefs || {});
        const potentials = [];
        for (let i = 0; i < defs.length && potentials.length < 5; i++) {
          const di = defs[i];
          const textI = `${di.label}. ${di.definition || ''}`;
          const embI = await getFieldEmbedding(textI);
          if (!embI) {
            setScanningCrosswalks(false);
            return;
          }
          for (let j = i + 1; j < defs.length; j++) {
            const dj = defs[j];
            if (existingPairs.has(`${di.uri}|${dj.uri}`) || existingPairs.has(`${dj.uri}|${di.uri}`)) continue;
            const textJ = `${dj.label}. ${dj.definition || ''}`;
            const embJ = await getFieldEmbedding(textJ);
            if (!embJ) continue;
            const sim = cosineSim(embI, embJ);
            if (sim > 0.85) potentials.push({
              from: di,
              to: dj,
              similarity: sim
            });
          }
        }
        setPotentialCrosswalks(potentials);
        setScanningCrosswalks(false);
      } catch {
        setScanningCrosswalks(false);
      }
    })();
  }, [fieldDefs, fieldCrosswalks]);
  const getCrosswalksForUri = uri => (fieldCrosswalks || []).filter(xw => xw.from_uri === uri || xw.bidirectional && xw.to_uri === uri);
  const getTeamsUsing = uri => (teams || []).filter(t => t.schema?.fields?.some(f => f.uri === uri));
  const getSource = uri => {
    if (uri?.startsWith('khora:vault/')) return {
      label: 'Vault',
      color: 'gold'
    };
    if (uri?.startsWith('khora:team/')) return {
      label: 'Team',
      color: 'purple'
    };
    if (uri?.startsWith('khora:org/')) return {
      label: 'Org',
      color: 'blue'
    };
    return {
      label: 'External',
      color: 'teal'
    };
  };
  const defs = Object.values(fieldDefs || {});
  const DEF_COLS = [{
    key: 'label',
    label: 'Field',
    fixed: true
  }, {
    key: 'key',
    label: 'Key'
  }, {
    key: 'category',
    label: 'Category'
  }, {
    key: 'definition',
    label: 'Definition'
  }, {
    key: 'data_type',
    label: 'Type'
  }, {
    key: 'source',
    label: 'Source'
  }, {
    key: 'authority_name',
    label: 'Authority'
  }, {
    key: 'crosswalks',
    label: 'Also Known As'
  }, {
    key: 'version',
    label: 'v'
  }, {
    key: 'sensitive',
    label: ''
  }];
  const defRows = defs.map(d => ({
    ...d,
    source: getSource(d.uri)?.label || 'Unknown',
    authority_name: d.authority?.name || '',
    crosswalks: getCrosswalksForUri(d.uri).length
  }));
  const getDefVal = (row, key) => {
    if (key === 'sensitive') return row.sensitive ? 'Yes' : 'No';
    return row[key] || '';
  };
  const renderDefCell = (row, col) => {
    if (col.key === 'label') return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      style: {
        fontWeight: 600
      }
    }, row.label), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 9,
        fontFamily: 'var(--mono)',
        color: 'var(--tx-3)',
        marginTop: 2
      }
    }, row.uri));
    if (col.key === 'key') return /*#__PURE__*/React.createElement("span", {
      style: {
        fontFamily: 'var(--mono)',
        fontSize: 11
      }
    }, row.key);
    if (col.key === 'category') {
      const cl = CAT_LABELS[row.category] || row.category;
      const cc = CAT_COLORS[row.category] || 'blue';
      return /*#__PURE__*/React.createElement("span", {
        className: `tag tag-${cc}`,
        style: {
          fontSize: 9
        }
      }, cl);
    }
    if (col.key === 'definition') return /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 11.5,
        lineHeight: 1.5,
        color: 'var(--tx-1)',
        maxWidth: 300
      }
    }, (row.definition || '').length > 120 ? (row.definition || '').slice(0, 120) + '...' : row.definition || '');
    if (col.key === 'data_type') return /*#__PURE__*/React.createElement("span", {
      className: "tag tag-blue",
      style: {
        fontSize: 8
      }
    }, (row.data_type || 'text').toUpperCase());
    if (col.key === 'source') {
      const src = getSource(row.uri);
      return /*#__PURE__*/React.createElement("span", {
        className: `tag tag-${src.color}`,
        style: {
          fontSize: 8
        }
      }, src.label);
    }
    if (col.key === 'authority_name') return row.authority && !SIMPLE_FIELD_KEYS.has(row.key) ? /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        color: 'var(--teal)'
      },
      title: row.authority.uri
    }, row.authority.org ? /*#__PURE__*/React.createElement("strong", null, row.authority.org) : '', " ", row.authority.provision || '') : /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 10
      }
    }, SIMPLE_FIELD_KEYS.has(row.key) ? 'Wikidata' : '\u2014');
    if (col.key === 'crosswalks') {
      const xws = getCrosswalksForUri(row.uri);
      if (xws.length === 0) return /*#__PURE__*/React.createElement("span", {
        style: {
          color: 'var(--tx-3)',
          fontSize: 10
        }
      }, "\u2014");
      return /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          gap: 3,
          flexWrap: 'wrap'
        }
      }, xws.slice(0, 3).map(xw => {
        const rel = CROSSWALK_TYPES[xw.relationship] || CROSSWALK_TYPES.related;
        const targetUri = xw.from_uri === row.uri ? xw.to_uri : xw.from_uri;
        const targetDef = fieldDefs[targetUri];
        return /*#__PURE__*/React.createElement("span", {
          key: xw.id,
          className: `tag tag-${rel.color}`,
          style: {
            fontSize: 8,
            cursor: 'pointer'
          },
          onClick: e => {
            e.stopPropagation();
            setCrosswalkPopover({
              uri: row.uri,
              xws
            });
          }
        }, rel.symbol, " ", targetDef?.label || targetUri.split('/').pop());
      }), xws.length > 3 && /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 9,
          color: 'var(--tx-3)'
        }
      }, "+", xws.length - 3));
    }
    if (col.key === 'version') return /*#__PURE__*/React.createElement("span", {
      style: {
        fontFamily: 'var(--mono)',
        fontSize: 10,
        color: 'var(--tx-2)'
      }
    }, "v", row.version || 1);
    if (col.key === 'sensitive') return row.sensitive ? /*#__PURE__*/React.createElement(I, {
      n: "lock",
      s: 11,
      c: "var(--red)"
    }) : null;
    if (col.key === 'definition') {
      if (!row.definition) return React.createElement('span', { className: 'tag tag-orange', style: { fontSize: 9 } }, '\u26A0 Missing definition');
    }
    return row[col.key] || '';
  };

  const govRequired = !!(fieldGovernanceConfig?.governance_required);

  return /*#__PURE__*/React.createElement("div", null,
    // ── Toolbar: New Field + Merge ──
    React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 } },
      React.createElement('button', { className: 'b-pri b-xs', onClick: () => setCreateFieldOpen(true), style: { display: 'flex', alignItems: 'center', gap: 4 } },
        React.createElement(I, { n: 'plus', s: 11 }), 'New Field'),
      mergeSelection.length >= 2 && React.createElement('button', { className: 'b-gho b-xs', onClick: () => {
        setMergeFieldsOpen(true);
      }, style: { display: 'flex', alignItems: 'center', gap: 4, color: 'var(--teal)' } },
        React.createElement(I, { n: 'grid', s: 11 }), 'Merge ', mergeSelection.length, ' Fields'),
      mergeSelection.length > 0 && React.createElement('button', { className: 'b-gho b-xs', onClick: () => setMergeSelection([]),
        style: { fontSize: 10, color: 'var(--tx-3)' } }, 'Clear selection'),
      React.createElement('div', { style: { flex: 1 } }),
      React.createElement('span', { style: { fontSize: 10, color: 'var(--tx-3)', fontFamily: 'var(--mono)' } }, defs.length, ' fields'),
      govRequired && React.createElement('span', { className: 'tag tag-orange', style: { fontSize: 8, marginLeft: 4 } },
        React.createElement(I, { n: 'shieldCheck', s: 8 }), ' Governance')
    ),
    // ── Potential crosswalks banner ──
    potentialCrosswalks.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 14px',
      background: 'var(--teal-dim)',
      border: '1px solid rgba(61,214,140,.15)',
      borderRadius: 'var(--r)',
      marginBottom: 12,
      display: 'flex',
      alignItems: 'center',
      gap: 10
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "grid",
    s: 14,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 600,
      color: 'var(--teal)'
    }
  }, potentialCrosswalks.length, " potential crosswalk", potentialCrosswalks.length !== 1 ? 's' : '', " detected"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginLeft: 8
    }
  }, "Fields that may refer to the same concept.")),
    React.createElement("button", {
    className: "b-gho b-xs", style: { color: 'var(--teal)' },
    onClick: () => {
      // Pre-select fields for merge
      const fields = potentialCrosswalks.slice(0, 3).flatMap(pc => [pc.from, pc.to]);
      const unique = [...new Map(fields.map(f => [f.uri, f])).values()];
      setMergeSelection(unique);
      setMergeFieldsOpen(true);
    }
  }, "Review & Merge")), /*#__PURE__*/React.createElement(DataTable, {
    data: defRows,
    columns: DEF_COLS,
    defaultVisibleCols: ['label', 'category', 'definition', 'source', 'authority_name', 'crosswalks', 'sensitive'],
    groupOptions: [{
      key: 'category',
      label: 'Category'
    }, {
      key: 'source',
      label: 'Source'
    }],
    getVal: getDefVal,
    renderCell: renderDefCell,
    label: "field definitions",
    selectable: true,
    onRowClick: row => setExpandedUri(expandedUri === row.uri ? null : row.uri),
    selectedId: expandedUri,
    bulkActions: [{ id: 'merge', label: 'Merge', cls: 'b-gho b-xs', icon: 'grid' }, { id: 'evolve', label: 'Evolve', cls: 'b-gho b-xs', icon: 'layers' }],
    onBulkAction: (action, selectedRows) => {
      if (action === 'merge' && selectedRows.length >= 2) {
        setMergeSelection(selectedRows.map(r => fieldDefs[r.uri]).filter(Boolean));
        setMergeFieldsOpen(true);
      } else if (action === 'evolve' && selectedRows.length === 1) {
        setEvolveTarget(fieldDefs[selectedRows[0].uri]);
        setEvolveFieldOpen(true);
      }
    }
  }), expandedUri && fieldDefs[expandedUri] && React.createElement(DefinitionPopup, {
    fieldDef: fieldDefs[expandedUri],
    fieldDefs: fieldDefs,
    fieldCrosswalks: fieldCrosswalks,
    onClose: () => setExpandedUri(null),
    onSaveCrosswalk: onSaveCrosswalk,
    onSaveFieldDef: onSaveFieldDef,
    teams: teams,
    svc: svc,
    orgRoom: orgRoom,
    networkRoom: networkRoom,
    showToast: showToast,
    onEvolve: fd => { setEvolveTarget(fd); setEvolveFieldOpen(true); setExpandedUri(null); },
    onMerge: fd => { setMergeSelection([fd]); setExpandedUri(null); }
  }),
    // ── Modals ──
    React.createElement(CreateFieldModal, {
      open: createFieldOpen,
      onClose: () => setCreateFieldOpen(false),
      onSave: onSaveFieldDef,
      onPropose: onPropose || (async (proposal, room) => { if (svc) await svc.setState(room, EVT.GOV_PROPOSAL, proposal, proposal.id); }),
      fieldDefs: fieldDefs,
      categories: FIELD_CATEGORIES,
      catLabels: CAT_LABELS,
      namespace: networkRoom ? 'network' : orgRoom ? 'org' : 'local',
      governanceRequired: govRequired,
      svc: svc,
      orgRoom: orgRoom,
      networkRoom: networkRoom,
      showToast: showToast
    }),
    React.createElement(MergeFieldsModal, {
      open: mergeFieldsOpen,
      onClose: () => { setMergeFieldsOpen(false); setMergeSelection([]); },
      fieldsToMerge: mergeSelection,
      fieldDefs: fieldDefs,
      onSaveFieldDef: onSaveFieldDef,
      onSaveCrosswalk: onSaveCrosswalk,
      governanceRequired: govRequired,
      svc: svc,
      orgRoom: orgRoom,
      networkRoom: networkRoom,
      showToast: showToast
    }),
    React.createElement(EvolveFieldModal, {
      open: evolveFieldOpen,
      onClose: () => { setEvolveFieldOpen(false); setEvolveTarget(null); },
      fieldDef: evolveTarget,
      onSaveFieldDef: onSaveFieldDef,
      governanceRequired: govRequired,
      svc: svc,
      orgRoom: orgRoom,
      networkRoom: networkRoom,
      showToast: showToast
    })
  );
};

/* ─── CreateFieldModal — create a new field definition with required definition ─── */
const FIELD_DATA_TYPES = [
  { v: 'text', l: 'Text' }, { v: 'text_long', l: 'Long Text' }, { v: 'date', l: 'Date' },
  { v: 'email', l: 'Email' }, { v: 'phone', l: 'Phone' }, { v: 'address', l: 'Address' },
  { v: 'number', l: 'Number' }, { v: 'single_select', l: 'Single Select' },
  { v: 'multi_select', l: 'Multi Select' }, { v: 'boolean', l: 'Yes / No' }, { v: 'document', l: 'Document' }
];
const fieldLabelToKey = label => label.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '').slice(0, 48) || 'unnamed_field';

const CreateFieldModal = ({ open, onClose, onSave, onPropose, fieldDefs, categories, catLabels, namespace, governanceRequired, svc, orgRoom, networkRoom, showToast }) => {
  const [label, setLabel] = useState('');
  const [key, setKey] = useState('');
  const [keyEdited, setKeyEdited] = useState(false);
  const [category, setCategory] = useState('details');
  const [dataType, setDataType] = useState('text');
  const [definition, setDefinition] = useState('');
  const [scope, setScope] = useState('');
  const [sensitive, setSensitive] = useState(false);
  const [authOrg, setAuthOrg] = useState('');
  const [authName, setAuthName] = useState('');
  const [authProvision, setAuthProvision] = useState('');
  const [authUri, setAuthUri] = useState('');
  const [showAuth, setShowAuth] = useState(false);
  const [authUriBrowserOpen, setAuthUriBrowserOpen] = useState(false);
  const [saving, setSaving] = useState(false);
  const [duplicateWarning, setDuplicateWarning] = useState(null);

  if (!open) return null;

  const ns = namespace || 'org';
  const uri = `khora:${ns}/${key || fieldLabelToKey(label)}`;
  const computedKey = key || fieldLabelToKey(label);
  const defLen = definition.length;
  const isValid = label.trim().length > 0 && computedKey.length > 0 && defLen >= 20 && dataType;

  // Check for duplicate URIs / keys
  React.useEffect(() => {
    if (!computedKey || !fieldDefs) { setDuplicateWarning(null); return; }
    const existing = Object.values(fieldDefs).find(d => d.key === computedKey || d.uri === uri);
    setDuplicateWarning(existing ? `A field with key "${computedKey}" already exists (${existing.label})` : null);
  }, [computedKey, uri, fieldDefs]);

  const handleSave = async () => {
    if (!isValid || duplicateWarning) return;
    setSaving(true);
    const authority = (authOrg || authName) ? { org: authOrg, name: authName, provision: authProvision, uri: authUri } : null;
    const def = {
      uri,
      key: computedKey,
      label: label.trim(),
      category,
      data_type: dataType,
      definition: definition.trim(),
      scope: scope.trim() || null,
      sensitive,
      authority,
      version: 1,
      version_history: [],
      migration_rules: [],
      supersedes: null,
      superseded_by: null,
      created_by: svc?.userId || 'unknown',
      created_at: Date.now()
    };
    try {
      if (governanceRequired && (orgRoom || networkRoom)) {
        // Create governance proposal instead of saving directly
        const targetRoom = networkRoom || orgRoom;
        const proposal = {
          id: 'prop_field_' + computedKey + '_' + Date.now(),
          type: 'new_field_definition',
          summary: `Create new field: "${label.trim()}"`,
          detail: `New ${dataType} field in ${(catLabels || {})[category] || category} category. Definition: ${definition.trim().slice(0, 100)}${defLen > 100 ? '...' : ''}`,
          field_definition: def,
          proposed_by: svc?.userId,
          proposed_at: Date.now(),
          status: 'submitted',
          positions: {}
        };
        if (onPropose) await onPropose(proposal, targetRoom);
        if (showToast) showToast('Governance proposal created for new field');
      } else {
        if (onSave) await onSave(def);
        if (showToast) showToast(`Field "${label.trim()}" created`);
      }
      onClose();
    } catch (e) {
      console.error('CreateField error:', e);
      if (showToast) showToast('Error creating field: ' + e.message);
    }
    setSaving(false);
  };

  return React.createElement('div', { className: 'cf-overlay', onClick: e => { if (e.target === e.currentTarget) onClose(); } },
    React.createElement('div', { className: 'cf-modal' },
      React.createElement('div', { className: 'cf-header' },
        React.createElement('h3', null, 'Create Field Definition'),
        React.createElement('button', { className: 'b-gho b-xs', onClick: onClose, style: { fontSize: 16, lineHeight: 1, padding: '2px 8px' } }, '\u2715')
      ),
      React.createElement('div', { className: 'cf-body' },
        // Label & Key
        React.createElement('div', { className: 'cf-row-pair' },
          React.createElement('div', { className: 'cf-row' },
            React.createElement('label', { className: 'cf-label' }, 'Field Label', React.createElement('span', { className: 'required' }, '*')),
            React.createElement('input', { value: label, onChange: e => { setLabel(e.target.value); if (!keyEdited) setKey(fieldLabelToKey(e.target.value)); },
              placeholder: 'e.g. Housing Status', style: { fontSize: 13 } })
          ),
          React.createElement('div', { className: 'cf-row' },
            React.createElement('label', { className: 'cf-label' }, 'Key'),
            React.createElement('input', { value: key || fieldLabelToKey(label), onChange: e => { setKey(e.target.value); setKeyEdited(true); },
              style: { fontSize: 12, fontFamily: 'var(--mono)' } })
          )
        ),
        // Category & Type
        React.createElement('div', { className: 'cf-row-pair' },
          React.createElement('div', { className: 'cf-row' },
            React.createElement('label', { className: 'cf-label' }, 'Category', React.createElement('span', { className: 'required' }, '*')),
            React.createElement('select', { value: category, onChange: e => setCategory(e.target.value), style: { fontSize: 13 } },
              (categories || ['identity', 'contact', 'details', 'case', 'sensitive']).map(c =>
                React.createElement('option', { key: c, value: c }, (catLabels || {})[c] || c)
              )
            )
          ),
          React.createElement('div', { className: 'cf-row' },
            React.createElement('label', { className: 'cf-label' }, 'Data Type', React.createElement('span', { className: 'required' }, '*')),
            React.createElement('select', { value: dataType, onChange: e => setDataType(e.target.value), style: { fontSize: 13 } },
              FIELD_DATA_TYPES.map(t => React.createElement('option', { key: t.v, value: t.v }, t.l))
            )
          )
        ),
        // Definition (required)
        React.createElement('div', { className: 'cf-row' },
          React.createElement('label', { className: 'cf-label' }, 'Definition', React.createElement('span', { className: 'required' }, '*')),
          React.createElement('textarea', { value: definition, onChange: e => setDefinition(e.target.value),
            placeholder: 'Describe what this field means and how it should be interpreted (min 20 characters)...',
            style: { fontSize: 13, minHeight: 72 } }),
          React.createElement('div', { className: `cf-char-count ${defLen < 20 ? 'warn' : 'ok'}` }, defLen, '/20 min')
        ),
        // Scope
        React.createElement('div', { className: 'cf-row' },
          React.createElement('label', { className: 'cf-label' }, 'Scope', React.createElement('span', { style: { fontSize: 9, color: 'var(--tx-3)', marginLeft: 4 } }, 'recommended')),
          React.createElement('textarea', { value: scope, onChange: e => setScope(e.target.value),
            placeholder: "What's included vs excluded in this field...", style: { fontSize: 13, minHeight: 48 } })
        ),
        // Sensitive toggle
        React.createElement('div', { className: 'cf-row' },
          React.createElement('div', { className: 'cf-toggle', onClick: () => setSensitive(!sensitive) },
            React.createElement('div', { className: `cf-toggle-track${sensitive ? ' on' : ''}` },
              React.createElement('div', { className: 'cf-toggle-knob' })
            ),
            React.createElement('span', { style: { fontSize: 12, color: sensitive ? 'var(--red)' : 'var(--tx-2)' } },
              sensitive ? 'Sensitive — requires elevated access' : 'Not sensitive')
          )
        ),
        // Authority (collapsible)
        React.createElement('div', { className: 'cf-row' },
          React.createElement('button', { className: 'b-gho b-xs', onClick: () => setShowAuth(!showAuth),
            style: { display: 'flex', alignItems: 'center', gap: 4, alignSelf: 'flex-start' } },
            React.createElement(I, { n: showAuth ? 'chevronDown' : 'chevronRight', s: 10 }), 'Authority ', showAuth ? '(hide)' : '(optional)')
        ),
        showAuth && React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: 6, padding: '0 0 0 8px', borderLeft: '2px solid var(--border-1)' } },
          React.createElement('input', { value: authOrg, onChange: e => setAuthOrg(e.target.value), placeholder: 'Organization (e.g. HUD)', style: { fontSize: 12, padding: '6px 10px' } }),
          React.createElement('input', { value: authName, onChange: e => setAuthName(e.target.value), placeholder: 'Standard name', style: { fontSize: 12, padding: '6px 10px' } }),
          React.createElement('input', { value: authProvision, onChange: e => setAuthProvision(e.target.value), placeholder: 'Provision (e.g. Element 3.01)', style: { fontSize: 12, padding: '6px 10px' } }),
          React.createElement('div', { style: { display: 'flex', gap: 4, alignItems: 'center' } },
            React.createElement('input', { value: authUri, onChange: e => setAuthUri(e.target.value), placeholder: 'Reference URI', style: { flex: 1, fontSize: 12, padding: '6px 10px' } }),
            React.createElement('button', { className: 'b-gho b-xs', onClick: () => setAuthUriBrowserOpen(true),
              title: 'Search URI libraries',
              style: { display: 'flex', alignItems: 'center', gap: 3, whiteSpace: 'nowrap', flexShrink: 0 } },
              React.createElement(I, { n: 'search', s: 10 }), 'Search')
          ),
          React.createElement(UriLibraryBrowser, {
            open: authUriBrowserOpen,
            onClose: () => setAuthUriBrowserOpen(false),
            mode: 'select',
            onSelect: entry => {
              setAuthUri(entry.uri || '');
              if (!authOrg) setAuthOrg(entry.source_library || '');
              if (!authName) setAuthName(entry.label || '');
              setAuthUriBrowserOpen(false);
            }
          })
        ),
        // Duplicate warning
        duplicateWarning && React.createElement('div', { style: { fontSize: 11, color: 'var(--orange)', padding: '6px 10px', background: 'var(--orange-dim)', borderRadius: 'var(--r)', border: '1px solid rgba(224,148,58,.2)' } },
          '\u26A0 ', duplicateWarning),
        // Governance notice
        governanceRequired && React.createElement('div', { className: 'cf-gov-notice' },
          React.createElement(I, { n: 'shieldCheck', s: 12 }), 'Governance is required — this will create a proposal for review'
        ),
        // Preview
        React.createElement('div', { className: 'cf-preview' },
          React.createElement('span', { style: { fontWeight: 600, fontSize: 12 } }, 'Preview'),
          React.createElement('div', { className: 'cf-preview-uri' }, uri),
          React.createElement('div', { style: { marginTop: 6, fontSize: 11, color: 'var(--tx-1)', lineHeight: 1.5 } },
            label.trim() || 'Field Name', ' — ', definition.trim().slice(0, 80) || 'definition...', definition.length > 80 ? '...' : '')
        )
      ),
      React.createElement('div', { className: 'cf-footer' },
        React.createElement('button', { className: 'b-gho', onClick: onClose }, 'Cancel'),
        React.createElement('button', { className: 'b-pri', disabled: !isValid || !!duplicateWarning || saving, onClick: handleSave },
          saving ? 'Saving...' : governanceRequired ? 'Submit Proposal' : 'Create Field')
      )
    )
  );
};

/* ─── AddColumnModal — add a column to the Individuals table with required definition + team governance ─── */
const AddColumnModal = ({ open, onClose, onSave, onPropose, fieldDefs, teams, teamMode, activeTeamObj, svc, orgRoom, networkRoom, showToast, fieldGovernanceConfig }) => {
  const [label, setLabel] = useState('');
  const [key, setKey] = useState('');
  const [keyEdited, setKeyEdited] = useState(false);
  const [category, setCategory] = useState('details');
  const [dataType, setDataType] = useState('text');
  const [definition, setDefinition] = useState('');
  const [scope, setScope] = useState('');
  const [sensitive, setSensitive] = useState(false);
  const [saving, setSaving] = useState(false);
  const [duplicateWarning, setDuplicateWarning] = useState(null);
  const [mode, setMode] = useState('new'); // 'new' | 'existing'
  const [selectedExistingUri, setSelectedExistingUri] = useState('');
  const [existingSearch, setExistingSearch] = useState('');

  const computedKey = key || fieldLabelToKey(label);
  const uri = `khora:${teamMode ? 'team/' + teamMode.roomId + '/' : 'org/'}${computedKey}`;

  // Check for duplicate URIs / keys — must be before any early return (Rules of Hooks)
  React.useEffect(() => {
    if (!open || !computedKey || !fieldDefs) { setDuplicateWarning(null); return; }
    const existing = Object.values(fieldDefs).find(d => d.key === computedKey || d.uri === uri);
    setDuplicateWarning(existing ? `A column with key "${computedKey}" already exists (${existing.label})` : null);
  }, [open, computedKey, uri, fieldDefs]);

  if (!open) return null;

  const defLen = definition.length;
  const isValidNew = label.trim().length > 0 && computedKey.length > 0 && defLen >= 20 && dataType;
  const isValidExisting = !!selectedExistingUri;

  // Resolve team governance context
  const activeTeam = activeTeamObj || (teamMode ? (teams || []).find(t => t.roomId === teamMode.roomId) : null);
  const teamSchemaRule = activeTeam?.schemaRule || { mode: 'lead_decides' };
  const consentMode = TEAM_CONSENT_MODES[teamSchemaRule.mode] || TEAM_CONSENT_MODES.lead_decides;
  const isTeamLead = activeTeam?.owner === svc?.userId;
  const isInTeamContext = !!activeTeam;
  const teamGovRequired = isInTeamContext && (teamSchemaRule.mode !== 'lead_decides' || !isTeamLead);
  const orgGovRequired = !!(fieldGovernanceConfig?.governance_required);
  const governanceRequired = teamGovRequired || orgGovRequired;

  // Cascading governance: team rules cascade from org/network
  const cascadeSource = activeTeam && orgRoom ? 'org' : activeTeam && networkRoom ? 'network' : null;

  const handleReset = () => {
    setLabel(''); setKey(''); setKeyEdited(false); setCategory('details');
    setDataType('text'); setDefinition(''); setScope(''); setSensitive(false);
    setSelectedExistingUri(''); setExistingSearch(''); setDuplicateWarning(null);
  };

  const handleSaveNew = async () => {
    if (!isValidNew || duplicateWarning) return;
    setSaving(true);
    const def = {
      uri,
      key: computedKey,
      label: label.trim(),
      category,
      data_type: dataType,
      definition: definition.trim(),
      scope: scope.trim() || null,
      sensitive,
      authority: null,
      version: 1,
      version_history: [],
      migration_rules: [],
      supersedes: null,
      superseded_by: null,
      created_by: svc?.userId || 'unknown',
      created_at: Date.now()
    };

    try {
      if (governanceRequired) {
        // Create governance proposal
        const targetRoom = activeTeam ? activeTeam.roomId : (networkRoom || orgRoom);
        const proposal = {
          id: 'prop_col_' + computedKey + '_' + Date.now(),
          type: 'add_column',
          summary: `Add column: "${label.trim()}"`,
          detail: `New ${dataType} column in ${category} category. Definition: ${definition.trim().slice(0, 120)}${defLen > 120 ? '...' : ''}`,
          field_definition: def,
          proposed_by: svc?.userId,
          proposed_at: Date.now(),
          status: 'submitted',
          positions: {},
          governance_context: {
            team: activeTeam ? { roomId: activeTeam.roomId, name: activeTeam.name, consent_mode: teamSchemaRule.mode } : null,
            org: orgRoom || null,
            network: networkRoom || null,
            cascading: !!cascadeSource,
            cascade_source: cascadeSource
          }
        };

        if (isInTeamContext) {
          // Route through team schema governance
          const currentSchema = { ...(activeTeam.schema || { version: 1, fields: [], pending_changes: [], change_log: [] }) };
          const change = {
            id: 'chg_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
            action: 'add_field',
            uri: def.uri,
            required: false,
            summary: `Add column "${label.trim()}" — ${definition.trim().slice(0, 80)}`,
            proposed_by: svc.userId,
            proposed_at: Date.now(),
            field_definition: def,
            approvals: teamSchemaRule.mode === 'lead_decides' ? {} : { [svc.userId]: Date.now() },
            blocks: {}
          };

          if (teamSchemaRule.mode === 'lead_decides' && isTeamLead) {
            // Apply immediately
            if (onSave) await onSave(def);
            currentSchema.fields = [...(currentSchema.fields || []), { uri: def.uri, required: false, added_version: (currentSchema.version || 1) + 1 }];
            currentSchema.version = (currentSchema.version || 1) + 1;
            currentSchema.last_modified = Date.now();
            currentSchema.modified_by = svc.userId;
            currentSchema.change_log = [...(currentSchema.change_log || []), { version: currentSchema.version, summary: change.summary, by: svc.userId, ts: Date.now() }];
            await svc.setState(activeTeam.roomId, EVT.TEAM_SCHEMA, currentSchema);
            if (showToast) showToast(`Column "${label.trim()}" added to team schema (v${currentSchema.version})`, 'success');
          } else {
            // Save definition first, then add as pending change
            if (onSave) await onSave(def);
            currentSchema.pending_changes = [...(currentSchema.pending_changes || []), change];
            await svc.setState(activeTeam.roomId, EVT.TEAM_SCHEMA, currentSchema);
            const modeLabel = consentMode.label.toLowerCase();
            if (showToast) showToast(`Column proposal submitted — awaiting ${modeLabel} approval from team`, 'info');
          }
        } else {
          // Org/network level governance
          if (onPropose) await onPropose(proposal, targetRoom);
          if (showToast) showToast('Governance proposal created for new column');
        }
      } else {
        // No governance — save directly
        if (onSave) await onSave(def);
        if (showToast) showToast(`Column "${label.trim()}" created`);
      }
      handleReset();
      onClose();
    } catch (e) {
      console.error('AddColumn error:', e);
      if (showToast) showToast('Error adding column: ' + e.message, 'error');
    }
    setSaving(false);
  };

  const handleSelectExisting = async () => {
    if (!selectedExistingUri) return;
    setSaving(true);
    const existingDef = fieldDefs[selectedExistingUri];
    if (!existingDef) { setSaving(false); return; }

    // Existing field must have a definition
    if (!existingDef.definition || existingDef.definition.length < 10) {
      if (showToast) showToast('This field is missing a definition. Please add a definition in the Definitions tab first.', 'warning');
      setSaving(false);
      return;
    }

    try {
      if (isInTeamContext) {
        const currentSchema = { ...(activeTeam.schema || { version: 1, fields: [], pending_changes: [], change_log: [] }) };
        // Check if already in team schema
        if ((currentSchema.fields || []).some(f => f.uri === selectedExistingUri)) {
          if (showToast) showToast('This field is already in the team schema', 'warning');
          setSaving(false);
          return;
        }
        const change = {
          id: 'chg_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          action: 'add_field',
          uri: selectedExistingUri,
          required: false,
          summary: `Add column "${existingDef.label}" from definitions`,
          proposed_by: svc.userId,
          proposed_at: Date.now(),
          approvals: teamSchemaRule.mode === 'lead_decides' ? {} : { [svc.userId]: Date.now() },
          blocks: {}
        };

        if (teamSchemaRule.mode === 'lead_decides' && isTeamLead) {
          currentSchema.fields = [...(currentSchema.fields || []), { uri: selectedExistingUri, required: false, added_version: (currentSchema.version || 1) + 1 }];
          currentSchema.version = (currentSchema.version || 1) + 1;
          currentSchema.last_modified = Date.now();
          currentSchema.modified_by = svc.userId;
          currentSchema.change_log = [...(currentSchema.change_log || []), { version: currentSchema.version, summary: change.summary, by: svc.userId, ts: Date.now() }];
          await svc.setState(activeTeam.roomId, EVT.TEAM_SCHEMA, currentSchema);
          if (showToast) showToast(`Column "${existingDef.label}" added to team schema`, 'success');
        } else {
          currentSchema.pending_changes = [...(currentSchema.pending_changes || []), change];
          await svc.setState(activeTeam.roomId, EVT.TEAM_SCHEMA, currentSchema);
          const modeLabel = consentMode.label.toLowerCase();
          if (showToast) showToast(`Column proposal submitted — awaiting ${modeLabel} approval`, 'info');
        }
      }
      // Always add to enabledFieldCols locally
      onClose(existingDef.key);
      handleReset();
    } catch (e) {
      console.error('AddColumn existing error:', e);
      if (showToast) showToast('Error: ' + e.message, 'error');
    }
    setSaving(false);
  };

  const existingDefs = Object.values(fieldDefs || {}).filter(d =>
    d.key !== 'full_name' && d.definition && d.definition.length >= 10
  );
  const filteredExisting = existingSearch
    ? existingDefs.filter(d => d.label?.toLowerCase().includes(existingSearch.toLowerCase()) || d.key?.toLowerCase().includes(existingSearch.toLowerCase()))
    : existingDefs;

  return React.createElement('div', { className: 'cf-overlay', onClick: e => { if (e.target === e.currentTarget) { handleReset(); onClose(); } } },
    React.createElement('div', { className: 'cf-modal', style: { width: 560 } },
      React.createElement('div', { className: 'cf-header' },
        React.createElement('h3', null, 'Add Column'),
        React.createElement('button', { className: 'b-gho b-xs', onClick: () => { handleReset(); onClose(); }, style: { fontSize: 16, lineHeight: 1, padding: '2px 8px' } }, '\u2715')
      ),
      // Governance context banner
      isInTeamContext && React.createElement('div', { className: 'acm-gov-banner' },
        React.createElement(I, { n: 'shieldCheck', s: 13, c: consentMode.color === 'gold' ? 'var(--gold)' : consentMode.color === 'green' ? 'var(--green)' : 'var(--blue)' }),
        React.createElement('div', { style: { flex: 1 } },
          React.createElement('div', { style: { fontWeight: 600, fontSize: 12 } },
            'Team: ', activeTeam.name, ' \u2014 ', consentMode.label, ' governance'),
          React.createElement('div', { style: { fontSize: 10.5, color: 'var(--tx-2)', marginTop: 1 } },
            consentMode.desc),
          cascadeSource && React.createElement('div', { style: { fontSize: 9.5, color: 'var(--tx-3)', marginTop: 2, fontStyle: 'italic' } },
            'Rules cascade from ', cascadeSource, ' level')
        )
      ),
      // Mode tabs
      React.createElement('div', { className: 'acm-mode-tabs' },
        React.createElement('button', {
          className: 'acm-mode-tab' + (mode === 'existing' ? ' active' : ''),
          onClick: () => setMode('existing')
        }, React.createElement(I, { n: 'grid', s: 11 }), 'From Definitions'),
        React.createElement('button', {
          className: 'acm-mode-tab' + (mode === 'new' ? ' active' : ''),
          onClick: () => setMode('new')
        }, React.createElement(I, { n: 'plus', s: 11 }), 'Create New')
      ),
      React.createElement('div', { className: 'cf-body' },
        mode === 'existing' && React.createElement(React.Fragment, null,
          React.createElement('div', { className: 'cf-row' },
            React.createElement('input', {
              value: existingSearch, onChange: e => setExistingSearch(e.target.value),
              placeholder: 'Search defined fields...', style: { fontSize: 13 }
            })
          ),
          existingDefs.length === 0
            ? React.createElement('div', { style: { padding: '20px 0', textAlign: 'center', color: 'var(--tx-3)', fontSize: 12 } },
                'No field definitions with definitions yet. Create one using "Create New" tab.')
            : React.createElement('div', { className: 'acm-existing-list' },
                filteredExisting.map(d => React.createElement('div', {
                  key: d.uri,
                  className: 'acm-existing-item' + (selectedExistingUri === d.uri ? ' selected' : ''),
                  onClick: () => setSelectedExistingUri(d.uri === selectedExistingUri ? '' : d.uri)
                },
                  React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 6 } },
                    React.createElement('div', { className: 'acm-existing-radio' + (selectedExistingUri === d.uri ? ' checked' : '') }),
                    React.createElement('div', null,
                      React.createElement('div', { style: { fontWeight: 600, fontSize: 12.5 } }, d.label),
                      React.createElement('div', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginTop: 1 } }, d.key)
                    )
                  ),
                  React.createElement('div', { style: { fontSize: 11, color: 'var(--tx-1)', marginTop: 4, lineHeight: 1.4 } },
                    (d.definition || '').slice(0, 100), (d.definition || '').length > 100 ? '...' : ''),
                  React.createElement('div', { style: { display: 'flex', gap: 4, marginTop: 4 } },
                    React.createElement('span', { className: 'tag tag-blue', style: { fontSize: 8 } }, (d.data_type || 'text').toUpperCase()),
                    React.createElement('span', { className: 'tag tag-' + (CAT_COLORS[d.category] || 'blue'), style: { fontSize: 8 } }, CAT_LABELS[d.category] || d.category)
                  )
                ))
              ),
          // Governance info for existing
          governanceRequired && selectedExistingUri && React.createElement('div', { className: 'cf-gov-notice' },
            React.createElement(I, { n: 'shieldCheck', s: 12 }),
            isInTeamContext
              ? `This will ${teamSchemaRule.mode === 'lead_decides' && isTeamLead ? 'be added to' : 'create a proposal for'} the team schema`
              : 'Governance is required \u2014 this will create a proposal for review'
          )
        ),
        mode === 'new' && React.createElement(React.Fragment, null,
          // Label & Key
          React.createElement('div', { className: 'cf-row-pair' },
            React.createElement('div', { className: 'cf-row' },
              React.createElement('label', { className: 'cf-label' }, 'Column Name', React.createElement('span', { className: 'required' }, '*')),
              React.createElement('input', { value: label, onChange: e => { setLabel(e.target.value); if (!keyEdited) setKey(fieldLabelToKey(e.target.value)); },
                placeholder: 'e.g. Housing Status', style: { fontSize: 13 } })
            ),
            React.createElement('div', { className: 'cf-row' },
              React.createElement('label', { className: 'cf-label' }, 'Key'),
              React.createElement('input', { value: key || fieldLabelToKey(label), onChange: e => { setKey(e.target.value); setKeyEdited(true); },
                style: { fontSize: 12, fontFamily: 'var(--mono)' } })
            )
          ),
          // Category & Type
          React.createElement('div', { className: 'cf-row-pair' },
            React.createElement('div', { className: 'cf-row' },
              React.createElement('label', { className: 'cf-label' }, 'Category', React.createElement('span', { className: 'required' }, '*')),
              React.createElement('select', { value: category, onChange: e => setCategory(e.target.value), style: { fontSize: 13 } },
                ['identity', 'contact', 'details', 'case', 'sensitive'].map(c =>
                  React.createElement('option', { key: c, value: c }, CAT_LABELS[c] || c)
                )
              )
            ),
            React.createElement('div', { className: 'cf-row' },
              React.createElement('label', { className: 'cf-label' }, 'Data Type', React.createElement('span', { className: 'required' }, '*')),
              React.createElement('select', { value: dataType, onChange: e => setDataType(e.target.value), style: { fontSize: 13 } },
                FIELD_DATA_TYPES.map(t => React.createElement('option', { key: t.v, value: t.v }, t.l))
              )
            )
          ),
          // Definition (required)
          React.createElement('div', { className: 'cf-row' },
            React.createElement('label', { className: 'cf-label' }, 'Definition', React.createElement('span', { className: 'required' }, '*'),
              React.createElement('span', { style: { fontSize: 9, color: 'var(--tx-3)', marginLeft: 6, fontWeight: 400 } }, 'Every column must have a clear definition')),
            React.createElement('textarea', { value: definition, onChange: e => setDefinition(e.target.value),
              placeholder: 'Describe what this column means, how it should be interpreted, and what values are expected (min 20 characters)...',
              style: { fontSize: 13, minHeight: 72 } }),
            React.createElement('div', { className: `cf-char-count ${defLen < 20 ? 'warn' : 'ok'}` }, defLen, '/20 min')
          ),
          // Scope
          React.createElement('div', { className: 'cf-row' },
            React.createElement('label', { className: 'cf-label' }, 'Scope',
              React.createElement('span', { style: { fontSize: 9, color: 'var(--tx-3)', marginLeft: 4 } }, 'recommended')),
            React.createElement('textarea', { value: scope, onChange: e => setScope(e.target.value),
              placeholder: "What's included vs excluded...", style: { fontSize: 13, minHeight: 48 } })
          ),
          // Sensitive
          React.createElement('div', { className: 'cf-row' },
            React.createElement('div', { className: 'cf-toggle', onClick: () => setSensitive(!sensitive) },
              React.createElement('div', { className: `cf-toggle-track${sensitive ? ' on' : ''}` },
                React.createElement('div', { className: 'cf-toggle-knob' })
              ),
              React.createElement('span', { style: { fontSize: 12, color: sensitive ? 'var(--red)' : 'var(--tx-2)' } },
                sensitive ? 'Sensitive \u2014 requires elevated access' : 'Not sensitive')
            )
          ),
          // Duplicate warning
          duplicateWarning && React.createElement('div', { style: { fontSize: 11, color: 'var(--orange)', padding: '6px 10px', background: 'var(--orange-dim)', borderRadius: 'var(--r)', border: '1px solid rgba(224,148,56,.2)' } },
            '\u26A0 ', duplicateWarning),
          // Governance notice
          governanceRequired && React.createElement('div', { className: 'cf-gov-notice' },
            React.createElement(I, { n: 'shieldCheck', s: 12 }),
            isInTeamContext
              ? `Team governance (${consentMode.label.toLowerCase()}) \u2014 ${teamSchemaRule.mode === 'lead_decides' && isTeamLead ? 'will be applied directly' : 'this will create a proposal for team review'}`
              : 'Governance is required \u2014 this will create a proposal for review'
          ),
          // Preview
          React.createElement('div', { className: 'cf-preview' },
            React.createElement('span', { style: { fontWeight: 600, fontSize: 12 } }, 'Preview'),
            React.createElement('div', { className: 'cf-preview-uri' }, uri),
            React.createElement('div', { style: { marginTop: 6, fontSize: 11, color: 'var(--tx-1)', lineHeight: 1.5 } },
              label.trim() || 'Column Name', ' \u2014 ', definition.trim().slice(0, 80) || 'definition...', definition.length > 80 ? '...' : '')
          )
        )
      ),
      React.createElement('div', { className: 'cf-footer' },
        React.createElement('button', { className: 'b-gho', onClick: () => { handleReset(); onClose(); } }, 'Cancel'),
        mode === 'existing'
          ? React.createElement('button', { className: 'b-pri', disabled: !isValidExisting || saving, onClick: handleSelectExisting },
              saving ? 'Adding...' : governanceRequired && !(teamSchemaRule.mode === 'lead_decides' && isTeamLead) ? 'Submit Proposal' : 'Add Column')
          : React.createElement('button', { className: 'b-pri', disabled: !isValidNew || !!duplicateWarning || saving, onClick: handleSaveNew },
              saving ? 'Saving...' : governanceRequired && !(teamSchemaRule.mode === 'lead_decides' && isTeamLead) ? 'Submit Proposal' : 'Create Column')
      )
    )
  );
};

/* ─── CreateTableModal — create a new team-scoped custom table with governance ─── */
const TABLE_COLUMN_TYPES = [
  { id: 'text', label: 'Text' },
  { id: 'number', label: 'Number' },
  { id: 'date', label: 'Date' },
  { id: 'boolean', label: 'Yes / No' },
  { id: 'single_select', label: 'Single Select' },
  { id: 'multi_select', label: 'Multi-Select' },
  { id: 'url', label: 'URL / Link' }
];

const CreateTableModal = ({ open, onClose, team, svc, teams, showToast }) => {
  const [tableName, setTableName] = useState('');
  const [tableDesc, setTableDesc] = useState('');
  const [tablePurpose, setTablePurpose] = useState('');
  const [rollupToParent, setRollupToParent] = useState(false);
  const [columns, setColumns] = useState([
    { id: 'c1', key: '', label: '', data_type: 'text', description: '', required: false, sensitive: false, options: [] }
  ]);
  const [saving, setSaving] = useState(false);

  if (!open || !team) return null;

  const schemaRule = team.schemaRule || { mode: 'lead_decides' };
  const consentMode = TEAM_CONSENT_MODES[schemaRule.mode] || TEAM_CONSENT_MODES.lead_decides;
  const isLead = team.owner === svc?.userId;
  const needsProposal = schemaRule.mode !== 'lead_decides' || !isLead;
  const parentTeam = team.hierarchy?.parent_team_id
    ? teams.find(t => t.roomId === team.hierarchy.parent_team_id)
    : null;

  const fieldLabelToKey = lbl => lbl.trim().toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');

  const addColumn = () => {
    setColumns(prev => [...prev, {
      id: 'c' + Date.now(), key: '', label: '', data_type: 'text',
      description: '', required: false, sensitive: false, options: []
    }]);
  };

  const updateColumn = (id, field, value) => {
    setColumns(prev => prev.map(c => {
      if (c.id !== id) return c;
      const updated = { ...c, [field]: value };
      if (field === 'label' && !c._keyEdited) updated.key = fieldLabelToKey(value);
      return updated;
    }));
  };

  const removeColumn = id => {
    if (columns.length <= 1) return;
    setColumns(prev => prev.filter(c => c.id !== id));
  };

  const isValid = () => {
    if (!tableName.trim() || tableName.trim().length < 2) return false;
    if (!tableDesc.trim() || tableDesc.trim().length < 15) return false;
    if (columns.length === 0) return false;
    // Every column needs a label, key, and a description (governance requirement)
    return columns.every(c => c.label.trim().length > 0 && c.key.length > 0 && c.description.trim().length >= 10);
  };

  const handleSave = async () => {
    if (!isValid()) return;
    setSaving(true);
    try {
      const tableId = 'tbl_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
      const tableDef = {
        id: tableId,
        name: tableName.trim(),
        description: tableDesc.trim(),
        purpose: tablePurpose.trim() || null,
        columns: columns.map(c => ({
          key: c.key,
          label: c.label.trim(),
          data_type: c.data_type,
          description: c.description.trim(),
          required: c.required,
          sensitive: c.sensitive,
          options: c.options || []
        })),
        team_id: team.roomId,
        created_by: svc.userId,
        created_at: Date.now(),
        governance_proposal_id: null,
        version: 1,
        change_log: [{ version: 1, summary: 'Table created', by: svc.userId, ts: Date.now() }],
        rollup_to_parent: rollupToParent && !!parentTeam,
        status: needsProposal ? 'pending_approval' : 'active'
      };

      if (needsProposal) {
        // Create a pending schema change proposal for the table
        const currentSchema = { ...(team.schema || { version: 1, fields: [], pending_changes: [], change_log: [] }) };
        const change = {
          id: 'chg_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          action: 'create_table',
          table_id: tableId,
          summary: `Create table "${tableName.trim()}"`,
          detail: tableDesc.trim().slice(0, 120),
          proposed_by: svc.userId,
          proposed_at: Date.now(),
          table_definition: tableDef,
          approvals: schemaRule.mode === 'lead_decides' ? {} : { [svc.userId]: Date.now() },
          blocks: {}
        };
        currentSchema.pending_changes = [...(currentSchema.pending_changes || []), change];
        await svc.setState(team.roomId, EVT.TEAM_SCHEMA, currentSchema);
        showToast(`Table proposal submitted — awaiting ${consentMode.label.toLowerCase()} approval`, 'info');
      } else {
        // Apply immediately — store as TEAM_TABLE_DEF state event (state_key = table id)
        await svc.setState(team.roomId, EVT.TEAM_TABLE_DEF, tableDef, tableId);
        showToast(`Table "${tableName.trim()}" created`, 'success');
      }
      // Reset and close
      setTableName(''); setTableDesc(''); setTablePurpose(''); setRollupToParent(false);
      setColumns([{ id: 'c1', key: '', label: '', data_type: 'text', description: '', required: false, sensitive: false, options: [] }]);
      onClose(needsProposal ? null : tableDef);
    } catch (e) {
      console.error('[CreateTable]', e);
      showToast('Failed to create table: ' + e.message, 'error');
    }
    setSaving(false);
  };

  const govColor = consentMode.color === 'gold' ? 'var(--gold)' : consentMode.color === 'green' ? 'var(--green)' : 'var(--blue)';

  return React.createElement('div', { className: 'cf-overlay', onClick: e => { if (e.target === e.currentTarget) onClose(null); } },
    React.createElement('div', { className: 'cf-modal', style: { width: 620, maxHeight: '90vh', display: 'flex', flexDirection: 'column' } },
      React.createElement('div', { className: 'cf-header' },
        React.createElement('div', null,
          React.createElement('h3', null, 'New Table'),
          React.createElement('span', { style: { fontSize: 10.5, color: 'var(--tx-2)' } }, 'in ', React.createElement('strong', null, team.name))
        ),
        React.createElement('button', { className: 'b-gho b-xs', onClick: () => onClose(null), style: { fontSize: 16, lineHeight: 1, padding: '2px 8px' } }, '\u2715')
      ),

      // Governance banner
      React.createElement('div', { style: { margin: '0 20px 0', padding: '10px 14px', borderRadius: 'var(--r)', background: 'var(--bg-3)', border: '1px solid var(--border-1)', display: 'flex', gap: 10, alignItems: 'flex-start' } },
        React.createElement(I, { n: 'shieldCheck', s: 14, c: govColor }),
        React.createElement('div', { style: { flex: 1 } },
          React.createElement('div', { style: { fontWeight: 700, fontSize: 12, color: govColor } }, consentMode.label, ' governance'),
          React.createElement('div', { style: { fontSize: 11, color: 'var(--tx-1)', marginTop: 2 } }, consentMode.desc),
          needsProposal
            ? React.createElement('div', { style: { marginTop: 4, fontSize: 10.5, color: 'var(--tx-2)', fontStyle: 'italic' } },
                'This table will be submitted as a proposal and must be approved before activation.')
            : React.createElement('div', { style: { marginTop: 4, fontSize: 10.5, color: 'var(--green)', fontStyle: 'italic' } },
                'As team lead, you can create this table immediately.')
        )
      ),

      React.createElement('div', { className: 'cf-body', style: { flex: 1, overflowY: 'auto' } },
        // Table name
        React.createElement('div', { className: 'cf-row' },
          React.createElement('span', { className: 'section-label' }, 'TABLE NAME *'),
          React.createElement('input', { value: tableName, onChange: e => setTableName(e.target.value), placeholder: 'e.g. Service Encounters, Housing Referrals...' })
        ),
        // Description (governance requirement)
        React.createElement('div', { className: 'cf-row' },
          React.createElement('span', { className: 'section-label' }, 'DESCRIPTION * \u2014 what data this table holds (min 15 chars)'),
          React.createElement('textarea', {
            value: tableDesc, onChange: e => setTableDesc(e.target.value),
            placeholder: 'Describe what this table captures and why it is needed...',
            style: { minHeight: 56 }
          }),
          tableDesc.length > 0 && tableDesc.length < 15 && React.createElement('span', { style: { fontSize: 10.5, color: 'var(--red)', marginTop: 3 } }, tableDesc.length, '/15 characters')
        ),
        // Purpose / rationale
        React.createElement('div', { className: 'cf-row' },
          React.createElement('span', { className: 'section-label' }, 'PURPOSE / RATIONALE (optional but recommended)'),
          React.createElement('textarea', {
            value: tablePurpose, onChange: e => setTablePurpose(e.target.value),
            placeholder: 'Why does this team need this table? What decisions will it inform?',
            style: { minHeight: 44 }
          })
        ),

        // Parent rollup
        parentTeam && React.createElement('div', { className: 'cf-row' },
          React.createElement('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
            React.createElement('input', { type: 'checkbox', checked: rollupToParent, onChange: e => setRollupToParent(e.target.checked) }),
            React.createElement('div', null,
              React.createElement('div', { style: { fontWeight: 600, fontSize: 12 } }, 'Roll up data to parent team: ', React.createElement('strong', { style: { color: 'var(--teal)' } }, parentTeam.name)),
              React.createElement('div', { style: { fontSize: 10.5, color: 'var(--tx-2)', marginTop: 1 } },
                'When enabled, parent team leads can view aggregate (non-PII) data from this table.')
            )
          )
        ),

        // Columns section
        React.createElement('div', { style: { marginTop: 8 } },
          React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 } },
            React.createElement('span', { className: 'section-label' }, 'COLUMNS * \u2014 each requires a description (governance)'),
            React.createElement('button', { className: 'b-gho b-xs', onClick: addColumn, style: { display: 'flex', alignItems: 'center', gap: 4 } },
              React.createElement(I, { n: 'plus', s: 10 }), 'Add Column')
          ),
          columns.map((col, idx) =>
            React.createElement('div', { key: col.id, style: { background: 'var(--bg-3)', border: '1px solid var(--border-1)', borderRadius: 'var(--r)', padding: '12px 14px', marginBottom: 8 } },
              React.createElement('div', { style: { display: 'flex', gap: 8, marginBottom: 6 } },
                React.createElement('div', { style: { flex: 2 } },
                  React.createElement('span', { className: 'section-label', style: { fontSize: 9 } }, 'COLUMN NAME *'),
                  React.createElement('input', {
                    value: col.label, onChange: e => updateColumn(col.id, 'label', e.target.value),
                    placeholder: 'e.g. Encounter Date, Outcome...',
                    style: { fontSize: 12 }
                  })
                ),
                React.createElement('div', { style: { flex: 1 } },
                  React.createElement('span', { className: 'section-label', style: { fontSize: 9 } }, 'TYPE'),
                  React.createElement('select', {
                    value: col.data_type, onChange: e => updateColumn(col.id, 'data_type', e.target.value),
                    style: { fontSize: 12 }
                  }, TABLE_COLUMN_TYPES.map(t => React.createElement('option', { key: t.id, value: t.id }, t.label)))
                ),
                React.createElement('div', { style: { flex: 1 } },
                  React.createElement('span', { className: 'section-label', style: { fontSize: 9 } }, 'KEY (auto)'),
                  React.createElement('input', {
                    value: col.key, onChange: e => { updateColumn(col.id, '_keyEdited', true); updateColumn(col.id, 'key', e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '_')); },
                    placeholder: 'field_key',
                    style: { fontSize: 11, fontFamily: 'var(--mono)', color: 'var(--tx-2)' }
                  })
                ),
                React.createElement('button', {
                  className: 'b-gho b-xs', onClick: () => removeColumn(col.id),
                  style: { alignSelf: 'flex-end', color: 'var(--red)', opacity: columns.length <= 1 ? 0.3 : 1 },
                  disabled: columns.length <= 1
                }, React.createElement(I, { n: 'x', s: 11 }))
              ),
              // Column description (governance requirement)
              React.createElement('div', null,
                React.createElement('span', { className: 'section-label', style: { fontSize: 9 } }, 'DESCRIPTION * (min 10 chars)'),
                React.createElement('input', {
                  value: col.description, onChange: e => updateColumn(col.id, 'description', e.target.value),
                  placeholder: 'What does this column capture? How should it be filled in?',
                  style: { fontSize: 11 }
                }),
                col.description.length > 0 && col.description.length < 10 && React.createElement('span', { style: { fontSize: 9.5, color: 'var(--red)' } }, col.description.length, '/10')
              ),
              // Options for select types
              (col.data_type === 'single_select' || col.data_type === 'multi_select') &&
                React.createElement('div', { style: { marginTop: 6 } },
                  React.createElement('span', { className: 'section-label', style: { fontSize: 9 } }, 'OPTIONS (comma-separated)'),
                  React.createElement('input', {
                    value: col.options.join(', '),
                    onChange: e => updateColumn(col.id, 'options', e.target.value.split(',').map(s => s.trim()).filter(Boolean)),
                    placeholder: 'Option A, Option B, Option C',
                    style: { fontSize: 11 }
                  })
                ),
              // Toggles
              React.createElement('div', { style: { display: 'flex', gap: 16, marginTop: 6 } },
                React.createElement('label', { style: { display: 'flex', alignItems: 'center', gap: 4, cursor: 'pointer', fontSize: 11 } },
                  React.createElement('input', { type: 'checkbox', checked: col.required, onChange: e => updateColumn(col.id, 'required', e.target.checked) }),
                  'Required'),
                React.createElement('label', { style: { display: 'flex', alignItems: 'center', gap: 4, cursor: 'pointer', fontSize: 11 } },
                  React.createElement('input', { type: 'checkbox', checked: col.sensitive, onChange: e => updateColumn(col.id, 'sensitive', e.target.checked) }),
                  'Sensitive / PII')
              )
            )
          )
        )
      ),

      React.createElement('div', { className: 'cf-footer' },
        React.createElement('button', { className: 'b-gho', onClick: () => onClose(null) }, 'Cancel'),
        React.createElement('button', {
          className: 'b-pri', disabled: !isValid() || saving, onClick: handleSave,
          style: { display: 'flex', alignItems: 'center', gap: 4 }
        },
          React.createElement(I, { n: needsProposal ? 'shieldCheck' : 'plus', s: 13 }),
          saving ? 'Saving...' : needsProposal ? 'Submit Proposal' : 'Create Table'
        )
      )
    )
  );
};

/* ─── CustomTableView — view + add records for a team custom table ─── */
const CustomTableView = ({ table, team, svc, showToast, onBack }) => {
  const [records, setRecords] = useState([]);
  const [loading, setLoading] = useState(true);
  const [addingRow, setAddingRow] = useState(false);
  const [newRowData, setNewRowData] = useState({});
  const [saving, setSaving] = useState(false);

  // Load existing records from Matrix state
  React.useEffect(() => {
    if (!table || !team || !svc) { setLoading(false); return; }
    setLoading(true);
    try {
      const room = svc.client?.getRoom(team.roomId);
      const allState = room?.currentState?.events;
      const found = [];
      if (allState) {
        const recMap = allState.get(EVT.TEAM_TABLE_RECORD);
        if (recMap) {
          for (const [stateKey, evObj] of recMap.entries()) {
            if (stateKey.startsWith(table.id + ':')) {
              const content = evObj.getContent?.() || evObj.content || {};
              if (content.id && content.status !== 'archived') found.push(content);
            }
          }
        }
      }
      found.sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
      setRecords(found);
    } catch (e) {
      console.warn('[CustomTableView] load error:', e.message);
    }
    setLoading(false);
  }, [table?.id, team?.roomId]);

  const handleAddRow = async () => {
    // Validate required columns
    const missing = (table.columns || []).filter(c => c.required && !newRowData[c.key]?.toString().trim());
    if (missing.length > 0) {
      showToast('Required fields: ' + missing.map(c => c.label).join(', '), 'warning');
      return;
    }
    setSaving(true);
    try {
      const recId = 'rec_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 5);
      const record = {
        id: recId,
        table_id: table.id,
        data: { ...newRowData },
        created_by: svc.userId,
        created_at: Date.now(),
        modified_by: svc.userId,
        modified_at: Date.now(),
        status: 'active'
      };
      await svc.setState(team.roomId, EVT.TEAM_TABLE_RECORD, record, table.id + ':' + recId);
      setRecords(prev => [record, ...prev]);
      setNewRowData({});
      setAddingRow(false);
      showToast('Record added', 'success');
    } catch (e) {
      showToast('Failed to add record: ' + e.message, 'error');
    }
    setSaving(false);
  };

  const schemaRule = team.schemaRule || { mode: 'lead_decides' };
  const consentMode = TEAM_CONSENT_MODES[schemaRule.mode] || TEAM_CONSENT_MODES.lead_decides;
  const govColor = consentMode.color === 'gold' ? 'var(--gold)' : consentMode.color === 'green' ? 'var(--green)' : 'var(--blue)';

  return React.createElement('div', { className: 'anim-up', style: { padding: '0 0 24px' } },
    // Header
    React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 10, marginBottom: 16 } },
      React.createElement('button', { className: 'b-gho b-sm', onClick: onBack, style: { display: 'flex', alignItems: 'center', gap: 4 } },
        React.createElement(I, { n: 'arr-l', s: 12 }), 'Back'),
      React.createElement('div', { style: { flex: 1 } },
        React.createElement('h3', { style: { fontFamily: 'var(--serif)', fontSize: 18, fontWeight: 700 } }, table.name),
        React.createElement('div', { style: { fontSize: 11, color: 'var(--tx-2)', marginTop: 1 } },
          React.createElement('strong', { style: { color: govColor } }, consentMode.label, ' governance'), ' \u00B7 ', team.name,
          table.rollup_to_parent && React.createElement('span', { style: { marginLeft: 6, color: 'var(--teal)', fontSize: 10, fontWeight: 600 } }, '\u21A5 rolls up'))
      ),
      React.createElement('button', {
        className: 'b-pri b-sm', onClick: () => setAddingRow(true),
        style: { display: 'flex', alignItems: 'center', gap: 4 }
      }, React.createElement(I, { n: 'plus', s: 11 }), 'Add Row')
    ),
    // Description
    React.createElement('p', { style: { fontSize: 12, color: 'var(--tx-1)', marginBottom: 12, lineHeight: 1.5 } }, table.description),

    // Add row inline form
    addingRow && React.createElement('div', { style: { background: 'var(--bg-3)', border: '1px solid var(--border-1)', borderRadius: 'var(--r)', padding: '14px 16px', marginBottom: 16 } },
      React.createElement('div', { style: { fontWeight: 700, fontSize: 12, marginBottom: 10 } }, 'New Row'),
      React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(160px, 1fr))', gap: 8, marginBottom: 10 } },
        (table.columns || []).map(col =>
          React.createElement('div', { key: col.key },
            React.createElement('span', { className: 'section-label', style: { fontSize: 9 } },
              col.label.toUpperCase(), col.required ? ' *' : ''),
            col.data_type === 'boolean'
              ? React.createElement('select', {
                  value: newRowData[col.key] || '',
                  onChange: e => setNewRowData(d => ({ ...d, [col.key]: e.target.value })),
                  style: { fontSize: 12 }
                }, React.createElement('option', { value: '' }, '—'), React.createElement('option', { value: 'yes' }, 'Yes'), React.createElement('option', { value: 'no' }, 'No'))
              : col.data_type === 'single_select'
              ? React.createElement('select', {
                  value: newRowData[col.key] || '',
                  onChange: e => setNewRowData(d => ({ ...d, [col.key]: e.target.value })),
                  style: { fontSize: 12 }
                }, React.createElement('option', { value: '' }, '— select —'), ...(col.options || []).map(o => React.createElement('option', { key: o, value: o }, o)))
              : React.createElement('input', {
                  type: col.data_type === 'number' ? 'number' : col.data_type === 'date' ? 'date' : 'text',
                  value: newRowData[col.key] || '',
                  onChange: e => setNewRowData(d => ({ ...d, [col.key]: e.target.value })),
                  placeholder: col.description.slice(0, 40),
                  style: { fontSize: 12 }
                })
          )
        )
      ),
      React.createElement('div', { style: { display: 'flex', gap: 8 } },
        React.createElement('button', { className: 'b-gho b-sm', onClick: () => { setAddingRow(false); setNewRowData({}); } }, 'Cancel'),
        React.createElement('button', { className: 'b-pri b-sm', disabled: saving, onClick: handleAddRow },
          saving ? 'Saving...' : 'Add Row')
      )
    ),

    // Records table
    loading
      ? React.createElement('div', { style: { textAlign: 'center', padding: 32, color: 'var(--tx-3)' } }, 'Loading records...')
      : records.length === 0 && !addingRow
        ? React.createElement('div', { style: { textAlign: 'center', padding: 32, color: 'var(--tx-3)', fontSize: 12 } },
            React.createElement(I, { n: 'layers', s: 24, c: 'var(--border-1)' }),
            React.createElement('p', { style: { marginTop: 8 } }, 'No records yet. Add the first row.'))
        : React.createElement('div', { style: { overflowX: 'auto' } },
            React.createElement('table', { className: 'dt', style: { width: '100%' } },
              React.createElement('thead', null,
                React.createElement('tr', null,
                  React.createElement('th', { style: { width: 32, fontFamily: 'var(--mono)', fontSize: 9, color: 'var(--tx-3)' } }, '#'),
                  (table.columns || []).map(col =>
                    React.createElement('th', { key: col.key },
                      col.label,
                      col.required && React.createElement('span', { style: { color: 'var(--red)', marginLeft: 2 } }, '*'),
                      col.sensitive && React.createElement('span', { title: 'Sensitive / PII', style: { marginLeft: 4, color: 'var(--orange)' } }, '\uD83D\uDD12')
                    )
                  ),
                  React.createElement('th', { style: { width: 90, fontSize: 9 } }, 'ADDED')
                )
              ),
              React.createElement('tbody', null,
                records.map((rec, idx) =>
                  React.createElement('tr', { key: rec.id },
                    React.createElement('td', { style: { fontFamily: 'var(--mono)', fontSize: 9, color: 'var(--tx-3)', textAlign: 'center' } }, idx + 1),
                    (table.columns || []).map(col =>
                      React.createElement('td', { key: col.key, style: { maxWidth: 200, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } },
                        rec.data?.[col.key] ?? React.createElement('span', { style: { color: 'var(--tx-3)', fontStyle: 'italic' } }, '—'))
                    ),
                    React.createElement('td', { style: { fontSize: 10, color: 'var(--tx-3)' } },
                      rec.created_at ? new Date(rec.created_at).toLocaleDateString() : '—')
                  )
                )
              )
            )
          )
  );
};

/* ─── MergeFieldsModal — merge duplicate field definitions into a canonical one ─── */
const MergeFieldsModal = ({ open, onClose, fieldsToMerge, fieldDefs, onSaveFieldDef, onSaveCrosswalk, governanceRequired, svc, orgRoom, networkRoom, showToast }) => {
  const [canonicalUri, setCanonicalUri] = useState(null);
  const [saving, setSaving] = useState(false);

  React.useEffect(() => {
    if (fieldsToMerge && fieldsToMerge.length > 0) setCanonicalUri(fieldsToMerge[0].uri);
  }, [fieldsToMerge]);

  if (!open || !fieldsToMerge || fieldsToMerge.length < 2) return null;

  const canonical = fieldsToMerge.find(f => f.uri === canonicalUri) || fieldsToMerge[0];
  const deprecated = fieldsToMerge.filter(f => f.uri !== canonicalUri);

  const handleMerge = async () => {
    setSaving(true);
    try {
      // Mark deprecated fields
      for (const dep of deprecated) {
        const updated = {
          ...dep,
          superseded_by: canonical.uri,
          deprecated_at: Date.now(),
          deprecated_reason: 'merged'
        };
        if (onSaveFieldDef) await onSaveFieldDef(updated);
        // Create crosswalk
        if (onSaveCrosswalk) {
          await onSaveCrosswalk({
            id: 'xw_merge_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
            from_uri: dep.uri,
            to_uri: canonical.uri,
            relationship: 'equivalent',
            bidirectional: true,
            notes: `Merged: "${dep.label}" → "${canonical.label}"`,
            created_at: Date.now(),
            merge_operation: true
          });
        }
      }
      if (showToast) showToast(`Merged ${deprecated.length} field(s) into "${canonical.label}"`);
      onClose();
    } catch (e) {
      console.error('Merge error:', e);
      if (showToast) showToast('Error merging: ' + e.message);
    }
    setSaving(false);
  };

  return React.createElement('div', { className: 'cf-overlay', onClick: e => { if (e.target === e.currentTarget) onClose(); } },
    React.createElement('div', { className: 'cf-modal' },
      React.createElement('div', { className: 'cf-header' },
        React.createElement('h3', null, 'Merge Field Definitions'),
        React.createElement('button', { className: 'b-gho b-xs', onClick: onClose, style: { fontSize: 16, lineHeight: 1, padding: '2px 8px' } }, '\u2715')
      ),
      React.createElement('div', { className: 'cf-body' },
        React.createElement('div', { style: { fontSize: 12, color: 'var(--tx-2)', lineHeight: 1.6, marginBottom: 8 } },
          'Select the canonical (primary) field. Other fields will be deprecated and linked as equivalents.'),
        React.createElement('div', { className: 'cf-merge-fields' },
          fieldsToMerge.map(f => React.createElement('div', {
            key: f.uri,
            className: `cf-merge-card${f.uri === canonicalUri ? ' canonical' : ''}`,
            onClick: () => setCanonicalUri(f.uri)
          },
            React.createElement('input', { type: 'radio', checked: f.uri === canonicalUri, readOnly: true, style: { accentColor: 'var(--teal)' } }),
            React.createElement('div', { style: { flex: 1 } },
              React.createElement('div', { style: { fontWeight: 600, fontSize: 13 } }, f.label),
              React.createElement('div', { style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', marginTop: 2 } }, f.uri),
              f.definition && React.createElement('div', { style: { fontSize: 11, color: 'var(--tx-2)', marginTop: 4, lineHeight: 1.4 } }, f.definition.slice(0, 100))
            ),
            f.uri === canonicalUri
              ? React.createElement('span', { className: 'tag tag-teal', style: { fontSize: 9 } }, 'CANONICAL')
              : React.createElement('span', { className: 'tag tag-red', style: { fontSize: 9 } }, 'DEPRECATED')
          ))
        ),
        deprecated.length > 0 && React.createElement('div', { style: { padding: '10px 14px', background: 'var(--bg-2)', borderRadius: 'var(--r)', border: '1px solid var(--border-0)', fontSize: 11, color: 'var(--tx-2)', lineHeight: 1.5 } },
          React.createElement('strong', null, 'What happens:'), React.createElement('br', null),
          '\u2022 ', deprecated.map(d => `"${d.label}"`).join(', '), ' will be marked as superseded', React.createElement('br', null),
          '\u2022 Equivalent crosswalks will be created automatically', React.createElement('br', null),
          '\u2022 Existing data is preserved — only metadata changes')
      ),
      React.createElement('div', { className: 'cf-footer' },
        React.createElement('button', { className: 'b-gho', onClick: onClose }, 'Cancel'),
        React.createElement('button', { className: 'b-pri', disabled: saving, onClick: handleMerge },
          saving ? 'Merging...' : `Merge into "${canonical.label}"`)
      )
    )
  );
};

/* ─── EvolveFieldModal — evolve a field definition with migration rules ─── */
const EVOLVE_TYPES = [
  { v: 'rename', l: 'Rename', desc: 'Change the field key or label' },
  { v: 'type_change', l: 'Type Change', desc: 'Change the data type (e.g. text → select)' },
  { v: 'split', l: 'Split', desc: 'Split into multiple fields' },
  { v: 'deprecate', l: 'Deprecate', desc: 'Mark as deprecated (data preserved)' }
];

const EvolveFieldModal = ({ open, onClose, fieldDef, onSaveFieldDef, governanceRequired, svc, orgRoom, networkRoom, showToast }) => {
  const [evolveType, setEvolveType] = useState('rename');
  const [newLabel, setNewLabel] = useState('');
  const [newKey, setNewKey] = useState('');
  const [newDataType, setNewDataType] = useState('');
  const [transformNotes, setTransformNotes] = useState('');
  const [deprecateReason, setDeprecateReason] = useState('');
  const [saving, setSaving] = useState(false);

  React.useEffect(() => {
    if (fieldDef) {
      setNewLabel(fieldDef.label || '');
      setNewKey(fieldDef.key || '');
      setNewDataType(fieldDef.data_type || 'text');
    }
  }, [fieldDef?.uri]);

  if (!open || !fieldDef) return null;

  const currentVersion = fieldDef.version || 1;
  const nextVersion = currentVersion + 1;

  const handleEvolve = async () => {
    setSaving(true);
    try {
      const historyEntry = {
        version: nextVersion,
        previous_version: currentVersion,
        change_type: evolveType,
        changes: {},
        transform_notes: transformNotes.trim(),
        created_at: Date.now(),
        created_by: svc?.userId
      };

      const migrationRule = {
        from_version: currentVersion,
        to_version: nextVersion,
        transform_type: evolveType,
        transform_config: {}
      };

      if (evolveType === 'rename') {
        historyEntry.changes = { old_label: fieldDef.label, new_label: newLabel.trim(), old_key: fieldDef.key, new_key: newKey || fieldDef.key };
        migrationRule.transform_config = { old_key: fieldDef.key, new_key: newKey || fieldDef.key };
      } else if (evolveType === 'type_change') {
        historyEntry.changes = { old_type: fieldDef.data_type, new_type: newDataType };
        migrationRule.transform_config = { old_type: fieldDef.data_type, new_type: newDataType, notes: transformNotes.trim() };
      } else if (evolveType === 'deprecate') {
        historyEntry.changes = { reason: deprecateReason.trim() };
        migrationRule.transform_config = { action: 'archive', reason: deprecateReason.trim() };
      } else if (evolveType === 'split') {
        historyEntry.changes = { notes: transformNotes.trim() };
        migrationRule.transform_config = { notes: transformNotes.trim() };
      }

      const updated = {
        ...fieldDef,
        version: nextVersion,
        label: evolveType === 'rename' ? newLabel.trim() : fieldDef.label,
        key: evolveType === 'rename' && newKey ? newKey : fieldDef.key,
        data_type: evolveType === 'type_change' ? newDataType : fieldDef.data_type,
        superseded_by: evolveType === 'deprecate' ? 'deprecated' : fieldDef.superseded_by,
        deprecated_at: evolveType === 'deprecate' ? Date.now() : fieldDef.deprecated_at,
        deprecated_reason: evolveType === 'deprecate' ? deprecateReason.trim() : fieldDef.deprecated_reason,
        version_history: [...(fieldDef.version_history || []), historyEntry],
        migration_rules: [...(fieldDef.migration_rules || []), migrationRule]
      };

      if (onSaveFieldDef) await onSaveFieldDef(updated);
      if (showToast) showToast(`Field "${fieldDef.label}" evolved to v${nextVersion}`);
      onClose();
    } catch (e) {
      console.error('Evolve error:', e);
      if (showToast) showToast('Error: ' + e.message);
    }
    setSaving(false);
  };

  return React.createElement('div', { className: 'cf-overlay', onClick: e => { if (e.target === e.currentTarget) onClose(); } },
    React.createElement('div', { className: 'cf-modal' },
      React.createElement('div', { className: 'cf-header' },
        React.createElement('h3', null, 'Evolve Field Definition'),
        React.createElement('button', { className: 'b-gho b-xs', onClick: onClose, style: { fontSize: 16, lineHeight: 1, padding: '2px 8px' } }, '\u2715')
      ),
      React.createElement('div', { className: 'cf-body' },
        // Current version info
        React.createElement('div', { className: 'cf-preview', style: { marginTop: 0 } },
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
            React.createElement('span', { style: { fontWeight: 600, fontSize: 13 } }, fieldDef.label),
            React.createElement('span', { className: 'cf-migrate-badge current' }, 'v', currentVersion)
          ),
          React.createElement('div', { className: 'cf-preview-uri' }, fieldDef.uri),
          React.createElement('div', { style: { fontSize: 11, color: 'var(--tx-2)', marginTop: 4 } }, fieldDef.definition?.slice(0, 100))
        ),
        React.createElement('div', { className: 'cf-merge-arrow' }, '\u2193 evolves to v', nextVersion),
        // Change type
        React.createElement('div', { className: 'cf-row' },
          React.createElement('label', { className: 'cf-label' }, 'Change Type'),
          React.createElement('div', { style: { display: 'flex', gap: 6, flexWrap: 'wrap' } },
            EVOLVE_TYPES.map(t => React.createElement('button', {
              key: t.v,
              className: `b-gho b-xs${evolveType === t.v ? ' active' : ''}`,
              style: evolveType === t.v ? { background: 'var(--teal-dim)', color: 'var(--teal)', borderColor: 'var(--teal)' } : {},
              onClick: () => setEvolveType(t.v)
            }, t.l))
          )
        ),
        // Type-specific fields
        evolveType === 'rename' && React.createElement(React.Fragment, null,
          React.createElement('div', { className: 'cf-row-pair' },
            React.createElement('div', { className: 'cf-row' },
              React.createElement('label', { className: 'cf-label' }, 'New Label'),
              React.createElement('input', { value: newLabel, onChange: e => setNewLabel(e.target.value), style: { fontSize: 13 } })
            ),
            React.createElement('div', { className: 'cf-row' },
              React.createElement('label', { className: 'cf-label' }, 'New Key'),
              React.createElement('input', { value: newKey, onChange: e => setNewKey(e.target.value), style: { fontSize: 12, fontFamily: 'var(--mono)' } })
            )
          )
        ),
        evolveType === 'type_change' && React.createElement(React.Fragment, null,
          React.createElement('div', { className: 'cf-row' },
            React.createElement('label', { className: 'cf-label' }, 'New Data Type'),
            React.createElement('select', { value: newDataType, onChange: e => setNewDataType(e.target.value), style: { fontSize: 13 } },
              FIELD_DATA_TYPES.map(t => React.createElement('option', { key: t.v, value: t.v }, t.l))
            )
          ),
          React.createElement('div', { className: 'cf-row' },
            React.createElement('label', { className: 'cf-label' }, 'Transform Notes'),
            React.createElement('textarea', { value: transformNotes, onChange: e => setTransformNotes(e.target.value),
              placeholder: 'Describe how to convert old values to new type (e.g. "text values map to select options as follows...")',
              style: { fontSize: 12, minHeight: 56 } })
          )
        ),
        evolveType === 'deprecate' && React.createElement('div', { className: 'cf-row' },
          React.createElement('label', { className: 'cf-label' }, 'Deprecation Reason'),
          React.createElement('textarea', { value: deprecateReason, onChange: e => setDeprecateReason(e.target.value),
            placeholder: 'Why is this field being deprecated?', style: { fontSize: 12, minHeight: 48 } })
        ),
        evolveType === 'split' && React.createElement('div', { className: 'cf-row' },
          React.createElement('label', { className: 'cf-label' }, 'Split Details'),
          React.createElement('textarea', { value: transformNotes, onChange: e => setTransformNotes(e.target.value),
            placeholder: 'Describe how this field will be split and which new fields will be created...',
            style: { fontSize: 12, minHeight: 56 } })
        ),
        // Version history
        (fieldDef.version_history || []).length > 0 && React.createElement('div', { className: 'cf-row' },
          React.createElement('label', { className: 'cf-label' }, 'Version History'),
          React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: 4 } },
            (fieldDef.version_history || []).map((h, i) => React.createElement('div', {
              key: i, style: { fontSize: 10.5, padding: '4px 8px', background: 'var(--bg-2)', borderRadius: 'var(--r)', color: 'var(--tx-2)', fontFamily: 'var(--mono)' }
            }, `v${h.version}: ${h.change_type} — ${new Date(h.created_at).toLocaleDateString()}`))
          )
        )
      ),
      React.createElement('div', { className: 'cf-footer' },
        React.createElement('button', { className: 'b-gho', onClick: onClose }, 'Cancel'),
        React.createElement('button', { className: 'b-pri', disabled: saving, onClick: handleEvolve },
          saving ? 'Saving...' : `Evolve to v${nextVersion}`)
      )
    )
  );
};

/* ─── UriLibraryBrowser — searchable modal to browse standard URI vocabularies ─── */
const UriLibraryBrowser = ({ open, onClose, onSelect, mode = 'select' }) => {
  const [search, setSearch] = useState('');
  const [selectedLib, setSelectedLib] = useState('all');
  const [selectedCat, setSelectedCat] = useState('all');
  const [selectedEntry, setSelectedEntry] = useState(null);

  if (!open) return null;

  const results = searchUriLibraries(search, {
    libraryId: selectedLib !== 'all' ? selectedLib : undefined,
    category: selectedCat !== 'all' ? selectedCat : undefined,
    limit: 80
  });

  // Gather all categories from current results pool for filter chips
  const pool = selectedLib !== 'all'
    ? URI_LIBRARY_INDEX.filter(e => e.library_id === selectedLib)
    : URI_LIBRARY_INDEX;
  const categories = [...new Set(pool.map(e => e.category).filter(Boolean))].sort();

  const activeLib = selectedLib !== 'all' ? URI_LIBRARIES.find(l => l.id === selectedLib) : null;

  const typeColor = dt => {
    const m = { text: 'blue', select: 'teal', date: 'gold', number: 'orange', boolean: 'green',
      email: 'blue', phone: 'blue', address: 'gold', text_long: 'purple', document: 'orange',
      single_select: 'teal', multi_select: 'teal', duration: 'gold' };
    return m[dt] || 'blue';
  };

  const handleSelect = entry => {
    if (onSelect) {
      onSelect({
        uri: entry.uri,
        key: entry.label.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/(^_|_$)/g, ''),
        label: entry.label,
        definition: entry.definition,
        data_type: entry.data_type || 'text',
        category: entry.category || 'general',
        tags: entry.tags || [],
        source_library: entry.library_name,
        source_library_id: entry.library_id
      });
    }
    onClose();
  };

  return ReactDOM.createPortal(React.createElement('div', {
    className: 'uri-browser-overlay',
    onClick: e => { if (e.target === e.currentTarget) onClose(); }
  },
    React.createElement('div', { className: 'uri-browser' },
      // Header
      React.createElement('div', { className: 'uri-browser-header' },
        React.createElement('div', { className: 'uri-browser-header-row' },
          React.createElement('div', { className: 'uri-browser-title' },
            React.createElement(I, { n: 'globe', s: 18, c: 'var(--teal)' }),
            mode === 'link' ? 'Link to Standard URI' : 'Browse URI Libraries'
          ),
          React.createElement('button', { className: 'uri-browser-close', onClick: onClose }, '\u2715')
        ),
        // Search
        React.createElement('div', { className: 'uri-browser-search' },
          React.createElement('span', { className: 'uri-browser-search-icon' },
            React.createElement(I, { n: 'search', s: 14, c: 'var(--tx-3)' })
          ),
          React.createElement('input', {
            value: search,
            onChange: e => setSearch(e.target.value),
            placeholder: 'Search by name, definition, URI, or keyword\u2026',
            autoFocus: true
          })
        ),
        // Library filter chips
        React.createElement('div', { className: 'uri-browser-filters' },
          React.createElement('button', {
            className: `uri-browser-lib-chip${selectedLib === 'all' ? ' active' : ''}`,
            onClick: () => { setSelectedLib('all'); setSelectedCat('all'); }
          }, 'All Libraries'),
          URI_LIBRARIES.map(lib => React.createElement('button', {
            key: lib.id,
            className: `uri-browser-lib-chip${selectedLib === lib.id ? ' active' : ''}`,
            onClick: () => { setSelectedLib(lib.id); setSelectedCat('all'); }
          },
            React.createElement('span', { className: 'uri-browser-lib-dot', style: { background: `var(--${lib.color})` } }),
            lib.name,
            React.createElement('span', { style: { fontSize: 9, opacity: .6, fontFamily: 'var(--mono)' } }, lib.entries.length)
          ))
        ),
        // Category chips (contextual to selected library)
        categories.length > 1 && React.createElement('div', { className: 'uri-browser-cat-chips', style: { marginBottom: 14 } },
          React.createElement('button', {
            className: `uri-browser-cat-chip${selectedCat === 'all' ? ' active' : ''}`,
            onClick: () => setSelectedCat('all')
          }, 'All'),
          categories.map(c => React.createElement('button', {
            key: c,
            className: `uri-browser-cat-chip${selectedCat === c ? ' active' : ''}`,
            onClick: () => setSelectedCat(c)
          }, c))
        )
      ),
      // Body
      React.createElement('div', { className: 'uri-browser-body' },
        // Active library info bar
        activeLib && React.createElement('div', { className: 'uri-browser-lib-info' },
          React.createElement('div', null,
            React.createElement('div', { className: 'uri-browser-lib-info-name' }, activeLib.name),
            React.createElement('div', null, activeLib.description),
            React.createElement('div', { style: { marginTop: 4, fontFamily: 'var(--mono)', fontSize: 10, color: 'var(--teal)' } }, 'Prefix: ', activeLib.prefix)
          )
        ),
        // Results count
        React.createElement('div', { className: 'uri-browser-results-count' },
          React.createElement('span', null, results.length, ' ', results.length === 1 ? 'result' : 'results'),
          search && React.createElement('span', null, ' for "', search, '"')
        ),
        // Results grid
        results.length === 0
          ? React.createElement('div', { className: 'uri-browser-empty' },
              React.createElement('div', { className: 'uri-browser-empty-icon' }, React.createElement(I, { n: 'search', s: 28, c: 'var(--tx-3)' })),
              React.createElement('div', null, search ? `No URIs matching "${search}"` : 'No entries in this category.'),
              React.createElement('div', { style: { fontSize: 11, marginTop: 4 } }, 'Try a different search term or browse another library.')
            )
          : React.createElement('div', { className: 'uri-browser-grid' },
              results.map(entry => React.createElement('div', {
                key: entry.uri,
                className: `uri-browser-entry${selectedEntry === entry.uri ? ' selected' : ''}`,
                onClick: () => setSelectedEntry(selectedEntry === entry.uri ? null : entry.uri)
              },
                // Color dot / icon
                React.createElement('div', {
                  className: 'uri-browser-entry-icon',
                  style: { background: `var(--${entry.library_color}-dim)`, color: `var(--${entry.library_color})` }
                }, entry.label.charAt(0).toUpperCase()),
                // Body
                React.createElement('div', { className: 'uri-browser-entry-body' },
                  React.createElement('div', { className: 'uri-browser-entry-label' }, entry.label),
                  React.createElement('div', { className: 'uri-browser-entry-uri' }, entry.uri),
                  React.createElement('div', { className: 'uri-browser-entry-def' }, entry.definition),
                  React.createElement('div', { className: 'uri-browser-entry-tags' },
                    React.createElement('span', {
                      className: 'uri-browser-entry-lib',
                      style: { background: `var(--${entry.library_color}-dim)`, color: `var(--${entry.library_color})` }
                    }, entry.library_name),
                    React.createElement('span', { className: 'uri-browser-entry-tag' }, entry.category),
                    (entry.tags || []).slice(0, 3).map(t => React.createElement('span', { key: t, className: 'uri-browser-entry-tag' }, t))
                  )
                ),
                // Right side: type badge + select button
                React.createElement('div', { className: 'uri-browser-entry-right' },
                  React.createElement('span', {
                    className: 'uri-browser-entry-type',
                    style: { background: `var(--${typeColor(entry.data_type)}-dim)`, color: `var(--${typeColor(entry.data_type)})` }
                  }, (entry.data_type || 'text').replace('_', ' ')),
                  React.createElement('button', {
                    className: 'uri-browser-entry-select',
                    onClick: e => { e.stopPropagation(); handleSelect(entry); }
                  }, mode === 'link' ? 'Link' : 'Select')
                )
              ))
            )
      ),
      // Footer
      React.createElement('div', { className: 'uri-browser-footer' },
        React.createElement('div', { className: 'uri-browser-footer-info' },
          React.createElement(I, { n: 'globe', s: 11, c: 'var(--tx-3)' }),
          URI_LIBRARIES.length, ' libraries \u00B7 ', URI_LIBRARY_INDEX.length, ' total definitions'
        ),
        React.createElement('div', { className: 'uri-browser-footer-actions' },
          selectedEntry && React.createElement('button', {
            className: 'b-pri b-sm',
            onClick: () => {
              const entry = URI_LIBRARY_INDEX.find(e => e.uri === selectedEntry);
              if (entry) handleSelect(entry);
            }
          }, mode === 'link' ? 'Link Selected URI' : 'Use Selected URI'),
          React.createElement('button', { className: 'b-gho b-sm', onClick: onClose }, 'Cancel')
        )
      )
    )
  ), document.body);
};

/* ─── FieldPicker — select a field definition to insert into a form ─── */
const FieldPicker = ({ open, onClose, onSelect, fieldDefs, catLabels, catColors }) => {
  const [search, setSearch] = useState('');
  const [filterCat, setFilterCat] = useState('all');
  const [uriBrowserOpen, setUriBrowserOpen] = useState(false);

  if (!open) return null;

  const defs = Object.values(fieldDefs || {});
  const filtered = defs.filter(d => {
    if (d.superseded_by || d.deprecated_at) return false;
    if (filterCat !== 'all' && d.category !== filterCat) return false;
    if (search && !d.label.toLowerCase().includes(search.toLowerCase()) && !d.key.toLowerCase().includes(search.toLowerCase())) return false;
    return true;
  });

  const cats = [...new Set(defs.map(d => d.category).filter(Boolean))];

  const handleUriSelect = entry => {
    onSelect({
      uri: entry.uri,
      key: entry.key,
      label: entry.label,
      definition: entry.definition,
      data_type: entry.data_type || 'text',
      category: entry.category || 'general',
      sensitive: false,
      source_library: entry.source_library
    });
    onClose();
  };

  return React.createElement('div', { className: 'fp-overlay', onClick: e => { if (e.target === e.currentTarget) onClose(); } },
    React.createElement('div', { className: 'fp-modal' },
      React.createElement('div', { className: 'fp-header' },
        React.createElement('span', { style: { fontSize: 14, fontWeight: 600 } }, 'Insert from Field Dictionary'),
        React.createElement('button', { className: 'b-gho b-xs', onClick: onClose, style: { fontSize: 14, lineHeight: 1, padding: '2px 8px' } }, '\u2715')
      ),
      // URI Library browser button
      React.createElement('div', {
        style: { padding: '8px 14px', borderBottom: '1px solid var(--border-0)', display: 'flex', alignItems: 'center', gap: 8 }
      },
        React.createElement('button', {
          className: 'b-gho b-sm',
          style: { display: 'flex', alignItems: 'center', gap: 6, color: 'var(--teal)', borderColor: 'var(--teal)', fontSize: 12 },
          onClick: () => setUriBrowserOpen(true)
        },
          React.createElement(I, { n: 'globe', s: 12, c: 'var(--teal)' }),
          'Browse URI Libraries'
        ),
        React.createElement('span', { style: { fontSize: 10, color: 'var(--tx-3)' } }, 'Schema.org \u00B7 Dublin Core \u00B7 FOAF \u00B7 HMIS \u00B7 vCard \u00B7 FHIR')
      ),
      React.createElement('div', { className: 'fp-search' },
        React.createElement('input', { value: search, onChange: e => setSearch(e.target.value), placeholder: 'Search fields...',  autoFocus: true }),
        React.createElement('div', { style: { display: 'flex', gap: 4, marginTop: 6, flexWrap: 'wrap' } },
          React.createElement('button', {
            className: `b-gho b-xs${filterCat === 'all' ? ' active' : ''}`,
            style: filterCat === 'all' ? { background: 'var(--teal-dim)', color: 'var(--teal)', borderColor: 'var(--teal)' } : {},
            onClick: () => setFilterCat('all')
          }, 'All'),
          cats.map(c => React.createElement('button', {
            key: c,
            className: `b-gho b-xs${filterCat === c ? ' active' : ''}`,
            style: filterCat === c ? { background: `var(--${(catColors || {})[c] || 'blue'}-dim)`, color: `var(--${(catColors || {})[c] || 'blue'})`, borderColor: `var(--${(catColors || {})[c] || 'blue'})` } : {},
            onClick: () => setFilterCat(c)
          }, (catLabels || {})[c] || c))
        )
      ),
      React.createElement('div', { className: 'fp-list' },
        filtered.length === 0
          ? React.createElement('div', { style: { padding: 20, textAlign: 'center', fontSize: 12, color: 'var(--tx-3)' } }, 'No matching fields')
          : filtered.map(d => React.createElement('div', {
              key: d.uri,
              className: 'fp-item',
              onClick: () => { onSelect(d); onClose(); }
            },
            React.createElement('div', { className: 'fp-item-info' },
              React.createElement('div', { className: 'fp-item-label' }, d.label),
              React.createElement('div', { className: 'fp-item-def' }, d.definition || 'No definition')
            ),
            React.createElement('div', { className: 'fp-item-meta' },
              React.createElement('span', { className: `tag tag-${(catColors || {})[d.category] || 'blue'}`, style: { fontSize: 8 } }, (catLabels || {})[d.category] || d.category),
              React.createElement('span', { className: 'tag tag-blue', style: { fontSize: 8 } }, (d.data_type || 'text').toUpperCase())
            )
          ))
      )
    ),
    // URI Library Browser modal (nested)
    uriBrowserOpen && React.createElement(UriLibraryBrowser, {
      open: true,
      onClose: () => setUriBrowserOpen(false),
      onSelect: handleUriSelect,
      mode: 'select'
    })
  );
};

/* ─── TeamDetailView — expanded team view with Overview / Schema / Activity tabs ─── */
const TeamDetailView = ({
  team,
  teams,
  svc,
  fieldDefs,
  fieldCrosswalks,
  showToast,
  teamMode,
  onSwitchTeam,
  onBack,
  onInvite,
  onUpdateTeam,
  onSaveFieldDef,
  onSaveCrosswalk
}) => {
  const [teamTab, setTeamTab] = useState('overview');
  const [addFieldModal, setAddFieldModal] = useState(false);
  const [editFieldUri, setEditFieldUri] = useState(null);
  // Add field form state
  const [fieldDraft, setFieldDraft] = useState({
    key: '',
    label: '',
    definition: '',
    scope: '',
    category: 'case',
    data_type: 'text',
    sensitive: false,
    authority: null
  });
  const [addExistingField, setAddExistingField] = useState(false);
  const [selectedExistingUri, setSelectedExistingUri] = useState('');
  const [uriBrowserOpen, setUriBrowserOpen] = useState(false);
  // Embedding-based similarity suggestions
  const [similarFields, setSimilarFields] = useState([]);
  const [searchingSimilar, setSearchingSimilar] = useState(false);
  const [dismissedSuggestions, setDismissedSuggestions] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem('khora_dismissed_xw_suggestions') || '[]');
    } catch {
      return [];
    }
  });
  const similarTimerRef = React.useRef(null);
  const isLead = team.owner === svc?.userId;
  const schema = team.schema || {
    version: 1,
    fields: [],
    pending_changes: [],
    change_log: []
  };
  const schemaRule = team.schemaRule || {
    mode: 'lead_decides'
  };
  const consentMode = TEAM_CONSENT_MODES[schemaRule.mode] || TEAM_CONSENT_MODES.lead_decides;

  // Resolve field URIs to full definitions
  const resolvedFields = (schema.fields || []).map(sf => {
    const def = fieldDefs[sf.uri] || DOMAIN_CONFIG.vaultFields.find(v => v.uri === sf.uri);
    return {
      ...sf,
      def: def || {
        uri: sf.uri,
        key: sf.uri.split('/').pop(),
        label: sf.uri.split('/').pop(),
        definition: ''
      }
    };
  });

  // Get crosswalks for a field
  const getCrosswalksForUri = uri => (fieldCrosswalks || []).filter(xw => xw.from_uri === uri || xw.bidirectional && xw.to_uri === uri);
  const getSource = uri => {
    if (uri?.startsWith('khora:vault/')) return {
      label: 'Vault',
      color: 'gold'
    };
    if (uri?.startsWith('khora:team/')) return {
      label: 'Team',
      color: 'purple'
    };
    if (uri?.startsWith('khora:org/')) return {
      label: 'Org',
      color: 'blue'
    };
    return {
      label: 'External',
      color: 'teal'
    };
  };

  // Consent threshold helpers
  const getMemberCount = () => (team.members || []).length;
  const getThreshold = () => {
    if (schemaRule.mode === 'lead_decides') return 0;
    if (schemaRule.mode === 'majority') return Math.floor(getMemberCount() / 2) + 1;
    return getMemberCount(); // unanimous
  };
  const canModifySchema = () => {
    if (schemaRule.mode === 'lead_decides') return isLead;
    return true; // anyone can propose in majority/unanimous
  };

  // Apply a schema change
  const applySchemaChange = async change => {
    const currentSchema = {
      ...schema
    };
    if (schemaRule.mode === 'lead_decides' && isLead) {
      // Apply immediately
      if (change.action === 'add_field') {
        currentSchema.fields = [...(currentSchema.fields || []), {
          uri: change.uri,
          required: change.required || false,
          added_version: currentSchema.version + 1
        }];
      } else if (change.action === 'remove_field') {
        currentSchema.fields = (currentSchema.fields || []).filter(f => f.uri !== change.uri);
      }
      currentSchema.version = (currentSchema.version || 1) + 1;
      currentSchema.last_modified = Date.now();
      currentSchema.modified_by = svc.userId;
      currentSchema.change_log = [...(currentSchema.change_log || []), {
        version: currentSchema.version,
        summary: change.summary || change.action,
        by: svc.userId,
        ts: Date.now()
      }];
      try {
        await svc.setState(team.roomId, EVT.TEAM_SCHEMA, currentSchema);
        onUpdateTeam({
          ...team,
          schema: currentSchema
        });
        showToast(`Schema updated to v${currentSchema.version}`, 'success');
      } catch (e) {
        showToast('Schema update failed: ' + e.message, 'error');
      }
    } else {
      // Add as pending change
      const pending = {
        id: 'chg_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        ...change,
        proposed_by: svc.userId,
        proposed_at: Date.now(),
        approvals: schemaRule.mode === 'lead_decides' ? {} : {
          [svc.userId]: Date.now()
        },
        blocks: {}
      };
      currentSchema.pending_changes = [...(currentSchema.pending_changes || []), pending];
      try {
        await svc.setState(team.roomId, EVT.TEAM_SCHEMA, currentSchema);
        onUpdateTeam({
          ...team,
          schema: currentSchema
        });
        showToast('Schema change proposed — awaiting approval', 'info');
      } catch (e) {
        showToast('Failed: ' + e.message, 'error');
      }
    }
  };

  // Approve or block a pending change
  const respondToChange = async (changeId, position) => {
    const currentSchema = {
      ...schema
    };
    const pc = (currentSchema.pending_changes || []).find(c => c.id === changeId);
    if (!pc) return;
    if (position === 'approve') {
      pc.approvals = {
        ...(pc.approvals || {}),
        [svc.userId]: Date.now()
      };
    } else {
      pc.blocks = {
        ...(pc.blocks || {}),
        [svc.userId]: Date.now()
      };
    }

    // Check if threshold met
    const approvalCount = Object.keys(pc.approvals || {}).length;
    const blockCount = Object.keys(pc.blocks || {}).length;
    const threshold = getThreshold();
    if (schemaRule.mode === 'unanimous' && blockCount > 0) {
      // Blocked — remove pending change
      currentSchema.pending_changes = (currentSchema.pending_changes || []).filter(c => c.id !== changeId);
      showToast('Schema change blocked', 'warning');
    } else if (approvalCount >= threshold) {
      // Auto-apply
      if (pc.action === 'add_field') {
        currentSchema.fields = [...(currentSchema.fields || []), {
          uri: pc.uri,
          required: pc.required || false,
          added_version: currentSchema.version + 1
        }];
      } else if (pc.action === 'remove_field') {
        currentSchema.fields = (currentSchema.fields || []).filter(f => f.uri !== pc.uri);
      }
      currentSchema.version = (currentSchema.version || 1) + 1;
      currentSchema.last_modified = Date.now();
      currentSchema.modified_by = svc.userId;
      currentSchema.change_log = [...(currentSchema.change_log || []), {
        version: currentSchema.version,
        summary: pc.summary || pc.action,
        by: pc.proposed_by,
        ts: Date.now()
      }];
      currentSchema.pending_changes = (currentSchema.pending_changes || []).filter(c => c.id !== changeId);
      showToast(`Schema updated to v${currentSchema.version} — approved by ${approvalCount} members`, 'success');
    }
    try {
      await svc.setState(team.roomId, EVT.TEAM_SCHEMA, currentSchema);
      onUpdateTeam({
        ...team,
        schema: currentSchema
      });
    } catch (e) {
      showToast('Failed: ' + e.message, 'error');
    }
  };

  // Change consent mode
  const changeConsentMode = async newMode => {
    const newRule = {
      mode: newMode,
      modified_by: svc.userId,
      modified_at: Date.now()
    };
    try {
      await svc.setState(team.roomId, EVT.TEAM_SCHEMA_RULE, newRule);
      onUpdateTeam({
        ...team,
        schemaRule: newRule
      });
      showToast(`Consent mode changed to ${TEAM_CONSENT_MODES[newMode]?.label}`, 'success');
    } catch (e) {
      showToast('Failed: ' + e.message, 'error');
    }
  };

  // Add existing field from vault/other defs
  const handleAddExistingField = async () => {
    if (!selectedExistingUri) return;
    await applySchemaChange({
      action: 'add_field',
      uri: selectedExistingUri,
      required: false,
      summary: `Added ${fieldDefs[selectedExistingUri]?.label || selectedExistingUri}`
    });
    setAddExistingField(false);
    setSelectedExistingUri('');
  };

  // Save new custom field definition + add to schema
  const handleSaveNewField = async () => {
    if (!fieldDraft.label || !fieldDraft.definition) {
      showToast('Label and definition are required', 'warning');
      return;
    }
    const key = fieldDraft.key || fieldDraft.label.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
    const uri = `khora:team/${team.roomId}/${key}`;
    const def = {
      uri,
      key,
      label: fieldDraft.label,
      version: 1,
      definition: fieldDraft.definition,
      scope: fieldDraft.scope || '',
      category: fieldDraft.category || 'case',
      sensitive: fieldDraft.sensitive || false,
      data_type: fieldDraft.data_type || 'text',
      authority: fieldDraft.authority || null,
      created_by: svc.userId,
      created_at: Date.now(),
      supersedes: null
    };
    // Save the definition
    if (onSaveFieldDef) await onSaveFieldDef(def);
    // Add to team schema
    await applySchemaChange({
      action: 'add_field',
      uri,
      required: false,
      summary: `Added "${fieldDraft.label}"`
    });
    setAddFieldModal(false);
    setFieldDraft({
      key: '',
      label: '',
      definition: '',
      scope: '',
      category: 'case',
      data_type: 'text',
      sensitive: false,
      authority: null
    });
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 960,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onBack,
    className: "b-gho b-sm",
    style: {
      marginBottom: 14,
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "back",
    s: 13
  }), "All Teams"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, team.name || 'Unnamed Team'), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginTop: 4
    }
  }, isLead && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 9
    }
  }, "LEAD"), team.org_name && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-blue",
    style: {
      fontSize: 9
    }
  }, team.org_name), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)'
    }
  }, team.members?.length || 0, " members"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)'
    }
  }, schema.fields?.length || 0, " fields"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)'
    }
  }, "v", schema.version || 1)), team.description && /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-2)',
      marginTop: 6,
      lineHeight: 1.5
    }
  }, team.description)), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, isLead && /*#__PURE__*/React.createElement("button", {
    onClick: () => onInvite(team),
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "userPlus",
    s: 12
  }), "Invite"))), /*#__PURE__*/React.createElement("div", {
    className: "db-tabs"
  }, [{
    id: 'overview',
    label: 'Overview',
    icon: 'users'
  }, {
    id: 'schema',
    label: 'Schema',
    icon: 'grid'
  }, {
    id: 'activity',
    label: 'Activity',
    icon: 'layers'
  }].map(tab => /*#__PURE__*/React.createElement("button", {
    key: tab.id,
    className: 'db-tab' + (teamTab === tab.id ? ' active' : ''),
    onClick: () => setTeamTab(tab.id)
  }, /*#__PURE__*/React.createElement(I, {
    n: tab.icon,
    s: 13
  }), tab.label))), teamTab === 'overview' && /*#__PURE__*/React.createElement("div", null, isLead && /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: '16px 20px',
      marginBottom: 12,
      borderLeft: team.color_hue != null ? `3px solid hsl(${team.color_hue}, 65%, 55%)` : undefined
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "TEAM COLOR"), /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 12, marginTop: 8 }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 28, height: 28, borderRadius: '50%', flexShrink: 0,
      background: `hsl(${team.color_hue != null ? team.color_hue : 260}, 65%, 55%)`
    }
  }), /*#__PURE__*/React.createElement("input", {
    type: "range", min: 0, max: 360, value: team.color_hue != null ? team.color_hue : 260,
    "aria-label": `Team color: ${hueToColorName(team.color_hue != null ? team.color_hue : 260)}`,
    onChange: (e) => {
      const hue = parseInt(e.target.value);
      onUpdateTeam({ ...team, color_hue: hue });
      setLocalTeamColor(svc.userId, team.roomId, hue);
    },
    style: { flex: 1, accentColor: `hsl(${team.color_hue != null ? team.color_hue : 260}, 65%, 55%)` }
  }), /*#__PURE__*/React.createElement("span", {
    style: { fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--tx-3)', minWidth: 50 }
  }, hueToColorName(team.color_hue != null ? team.color_hue : 260), " ", team.color_hue != null ? team.color_hue : 260, "\u00B0"))), onSwitchTeam && /*#__PURE__*/React.createElement("button", {
    onClick: () => onSwitchTeam(teamMode?.roomId === team.roomId ? null : team.roomId),
    className: teamMode?.roomId === team.roomId ? "b-pri b-sm" : "b-gho b-sm",
    title: "When operating as this team, actions you take (notes, field changes, allocations) will be recorded under this team\u2019s context.",
    style: {
      marginBottom: 12,
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      width: '100%',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: teamMode?.roomId === team.roomId ? "check" : "users",
    s: 13
  }), teamMode?.roomId === team.roomId ? "Operating as This Team" : "Operate as This Team"), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: '16px 20px',
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "MEMBERS (", team.members?.length || 0, ")"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 6,
      marginTop: 8
    }
  }, (team.members || []).map((m, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 10,
      padding: '6px 10px',
      background: 'var(--bg-2)',
      borderRadius: 'var(--r)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 28,
      height: 28,
      borderRadius: '50%',
      background: m.role === 'lead' ? 'var(--gold-dim)' : 'var(--bg-3)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: m.role === 'lead' ? 'var(--gold)' : 'var(--tx-2)',
      flexShrink: 0
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: m.role === 'lead' ? 'briefcase' : 'user',
    s: 12
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12.5,
      fontWeight: 500
    }
  }, m.display_name || m.userId), m.userId !== m.display_name && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)',
      marginLeft: 6
    }
  }, m.userId)), /*#__PURE__*/React.createElement("span", {
    className: `tag ${m.role === 'lead' ? 'tag-gold' : 'tag-blue'}`,
    style: {
      fontSize: 8
    }
  }, m.role?.toUpperCase()))))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: '16px 20px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "DETAILS"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '100px 1fr',
      gap: '6px 12px',
      marginTop: 8,
      fontSize: 12
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--tx-3)'
    }
  }, "Created"), /*#__PURE__*/React.createElement("span", null, team.created ? new Date(team.created).toLocaleDateString() : '—'), /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--tx-3)'
    }
  }, "Room ID"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10,
      wordBreak: 'break-all'
    }
  }, team.roomId), /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--tx-3)'
    }
  }, "Schema"), /*#__PURE__*/React.createElement("span", null, "v", schema.version || 1, " \u2014 ", schema.fields?.length || 0, " fields"), /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--tx-3)'
    }
  }, "Consent"), /*#__PURE__*/React.createElement("span", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: consentMode.icon,
    s: 11,
    c: `var(--${consentMode.color})`
  }), consentMode.label)))), teamTab === 'schema' && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.08em',
      color: 'var(--tx-2)'
    }
  }, "TEAM SCHEMA"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10,
      color: 'var(--tx-3)'
    }
  }, "v", schema.version || 1, " \u2014 ", schema.fields?.length || 0, " fields")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, isLead && /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)'
    }
  }, "Consent:"), /*#__PURE__*/React.createElement("select", {
    value: schemaRule.mode,
    onChange: e => changeConsentMode(e.target.value),
    className: "ipt",
    style: {
      fontSize: 10,
      padding: '3px 6px',
      minWidth: 0
    }
  }, Object.values(TEAM_CONSENT_MODES).map(m => /*#__PURE__*/React.createElement("option", {
    key: m.id,
    value: m.id
  }, m.label)))), canModifySchema() && /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-xs",
    onClick: () => setAddExistingField(true),
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 3
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 10
  }), "Add Existing"), /*#__PURE__*/React.createElement("button", {
    className: "b-pri b-xs",
    onClick: () => {
      setAddFieldModal(true);
      setFieldDraft({
        key: '',
        label: '',
        definition: '',
        scope: '',
        category: 'case',
        data_type: 'text',
        sensitive: false,
        authority: null
      });
    },
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 3
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 10
  }), "New Field")))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 12px',
      background: `var(--${consentMode.color}-dim, var(--bg-2))`,
      border: `1px solid rgba(128,128,128,.1)`,
      borderRadius: 'var(--r)',
      marginBottom: 12,
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: consentMode.icon,
    s: 13,
    c: `var(--${consentMode.color})`
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-1)'
    }
  }, consentMode.desc)), (schema.pending_changes || []).length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 12
    }
  }, schema.pending_changes.map(pc => {
    const approvalCount = Object.keys(pc.approvals || {}).length;
    const threshold = getThreshold();
    const alreadyResponded = !!(pc.approvals?.[svc.userId] || pc.blocks?.[svc.userId]);
    return /*#__PURE__*/React.createElement("div", {
      key: pc.id,
      style: {
        padding: '10px 14px',
        background: 'var(--gold-dim)',
        border: '1px solid var(--gold-mid)',
        borderRadius: 'var(--r)',
        marginBottom: 6
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center'
      }
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        fontWeight: 600
      }
    }, "Pending: ", pc.summary || pc.action), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-2)',
        marginLeft: 8
      }
    }, "by ", (pc.proposed_by || '').split(':')[0]?.replace('@', ''))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        fontFamily: 'var(--mono)',
        color: 'var(--tx-2)'
      }
    }, approvalCount, "/", threshold, " approved"), !alreadyResponded && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("button", {
      className: "b-gho b-xs",
      style: {
        color: 'var(--green)'
      },
      onClick: () => respondToChange(pc.id, 'approve')
    }, "Approve"), /*#__PURE__*/React.createElement("button", {
      className: "b-gho b-xs",
      style: {
        color: 'var(--red)'
      },
      onClick: () => respondToChange(pc.id, 'block')
    }, "Block")), alreadyResponded && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-green",
      style: {
        fontSize: 8
      }
    }, "Responded"))), /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 6,
        height: 3,
        background: 'var(--border-1)',
        borderRadius: 2,
        overflow: 'hidden'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        height: '100%',
        background: 'var(--green)',
        width: `${Math.min(100, approvalCount / threshold * 100)}%`,
        borderRadius: 2,
        transition: 'width .3s'
      }
    })));
  })), resolvedFields.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '40px 20px',
      borderStyle: 'dashed'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "grid",
    s: 32
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 10,
      fontSize: 13
    }
  }, "No fields in schema"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 11.5,
      marginTop: 4
    }
  }, "Add fields to define what data this team tracks about individuals.")) : /*#__PURE__*/React.createElement("table", {
    className: "dt",
    style: {
      width: '100%'
    }
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    style: {
      textAlign: 'left',
      padding: '8px 12px',
      fontSize: 10,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.06em',
      color: 'var(--tx-3)',
      borderBottom: '2px solid var(--border-1)'
    }
  }, "Field"), /*#__PURE__*/React.createElement("th", {
    style: {
      textAlign: 'left',
      padding: '8px 12px',
      fontSize: 10,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.06em',
      color: 'var(--tx-3)',
      borderBottom: '2px solid var(--border-1)'
    }
  }, "Category"), /*#__PURE__*/React.createElement("th", {
    style: {
      textAlign: 'left',
      padding: '8px 12px',
      fontSize: 10,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.06em',
      color: 'var(--tx-3)',
      borderBottom: '2px solid var(--border-1)',
      maxWidth: 300
    }
  }, "Definition"), /*#__PURE__*/React.createElement("th", {
    style: {
      textAlign: 'left',
      padding: '8px 12px',
      fontSize: 10,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.06em',
      color: 'var(--tx-3)',
      borderBottom: '2px solid var(--border-1)'
    }
  }, "Source"), /*#__PURE__*/React.createElement("th", {
    style: {
      textAlign: 'left',
      padding: '8px 12px',
      fontSize: 10,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.06em',
      color: 'var(--tx-3)',
      borderBottom: '2px solid var(--border-1)'
    }
  }, "Also Known As"), /*#__PURE__*/React.createElement("th", {
    style: {
      width: 60,
      textAlign: 'center',
      padding: '8px 12px',
      fontSize: 10,
      fontWeight: 700,
      textTransform: 'uppercase',
      letterSpacing: '0.06em',
      color: 'var(--tx-3)',
      borderBottom: '2px solid var(--border-1)'
    }
  }))), /*#__PURE__*/React.createElement("tbody", null, resolvedFields.map(sf => {
    const d = sf.def;
    const src = getSource(d.uri);
    const xws = getCrosswalksForUri(d.uri);
    return /*#__PURE__*/React.createElement("tr", {
      key: sf.uri,
      style: {
        borderBottom: '1px solid var(--border-0)'
      }
    }, /*#__PURE__*/React.createElement("td", {
      style: {
        padding: '10px 12px'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontWeight: 600,
        fontSize: 12.5
      }
    }, d.label), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 9,
        fontFamily: 'var(--mono)',
        color: 'var(--tx-3)',
        marginTop: 1
      }
    }, d.key)), /*#__PURE__*/React.createElement("td", {
      style: {
        padding: '10px 12px'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${CAT_COLORS[d.category] || 'blue'}`,
      style: {
        fontSize: 8
      }
    }, CAT_LABELS[d.category] || d.category)), /*#__PURE__*/React.createElement("td", {
      style: {
        padding: '10px 12px',
        maxWidth: 300
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11.5,
        lineHeight: 1.5,
        color: 'var(--tx-1)'
      }
    }, (d.definition || '').length > 100 ? (d.definition || '').slice(0, 100) + '...' : d.definition || 'No definition')), /*#__PURE__*/React.createElement("td", {
      style: {
        padding: '10px 12px'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${src.color}`,
      style: {
        fontSize: 8
      }
    }, src.label)), /*#__PURE__*/React.createElement("td", {
      style: {
        padding: '10px 12px'
      }
    }, xws.length === 0 ? /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 10
      }
    }, "\u2014") : /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 3,
        flexWrap: 'wrap'
      }
    }, xws.slice(0, 2).map(xw => {
      const rel = CROSSWALK_TYPES[xw.relationship] || CROSSWALK_TYPES.related;
      const targetUri = xw.from_uri === d.uri ? xw.to_uri : xw.from_uri;
      const targetDef = fieldDefs[targetUri];
      return /*#__PURE__*/React.createElement("span", {
        key: xw.id,
        className: `tag tag-${rel.color}`,
        style: {
          fontSize: 8
        }
      }, rel.symbol, " ", targetDef?.label || targetUri.split('/').pop());
    }))), /*#__PURE__*/React.createElement("td", {
      style: {
        padding: '10px 12px',
        textAlign: 'center'
      }
    }, canModifySchema() && /*#__PURE__*/React.createElement("button", {
      className: "b-gho b-xs",
      style: {
        color: 'var(--red)',
        fontSize: 10
      },
      onClick: () => applySchemaChange({
        action: 'remove_field',
        uri: sf.uri,
        summary: `Removed "${d.label}"`
      }),
      title: "Remove field"
    }, /*#__PURE__*/React.createElement(I, {
      n: "close",
      s: 10
    }))));
  }))), (schema.change_log || []).length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CHANGE LOG"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 3,
      marginTop: 6
    }
  }, [...(schema.change_log || [])].reverse().map((cl, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      display: 'flex',
      gap: 8,
      padding: '4px 0'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10,
      color: 'var(--tx-3)',
      minWidth: 24
    }
  }, "v", cl.version), /*#__PURE__*/React.createElement("span", null, cl.summary), /*#__PURE__*/React.createElement("span", {
    style: {
      marginLeft: 'auto',
      fontSize: 10,
      color: 'var(--tx-3)'
    }
  }, (cl.by || '').split(':')[0]?.replace('@', ''), " \u2014 ", cl.ts ? new Date(cl.ts).toLocaleDateString() : '')))))), teamTab === 'activity' && /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: '20px',
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "layers",
    s: 28,
    c: "var(--tx-3)"
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 10,
      fontSize: 12
    }
  }, "Action log for team operations will appear here."), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 11,
      marginTop: 4
    }
  }, "Schema changes, member joins, and other team events are logged as epistemic operations.")), addExistingField && /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-modal",
    onClick: () => setAddExistingField(false)
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-panel",
    onClick: e => e.stopPropagation(),
    style: {
      maxWidth: 700
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 16,
      fontWeight: 700
    }
  }, "Add Existing Field"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setAddExistingField(false),
    style: {
      background: 'none',
      border: 'none',
      color: 'var(--tx-2)',
      cursor: 'pointer',
      fontSize: 18
    }
  }, "\xD7")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-2)',
      marginBottom: 12
    }
  }, "Select a field from the global dictionary to add to this team's schema."), /*#__PURE__*/React.createElement("select", {
    value: selectedExistingUri,
    onChange: e => setSelectedExistingUri(e.target.value),
    className: "ipt",
    style: {
      width: '100%',
      marginBottom: 8
    }
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Choose a field..."), Object.values(fieldDefs).filter(d => !schema.fields?.some(f => f.uri === d.uri)).map(d => /*#__PURE__*/React.createElement("option", {
    key: d.uri,
    value: d.uri
  }, d.label, " \u2014 ", (d.definition || '').slice(0, 60), (d.definition || '').length > 60 ? '...' : ''))), selectedExistingUri && fieldDefs[selectedExistingUri] && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 12px',
      background: 'var(--bg-2)',
      borderRadius: 'var(--r)',
      marginBottom: 8
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: 600,
      fontSize: 12
    }
  }, fieldDefs[selectedExistingUri].label), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginTop: 4
    }
  }, fieldDefs[selectedExistingUri].definition), fieldDefs[selectedExistingUri].authority && /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10,
      color: 'var(--teal)',
      marginTop: 4
    }
  }, fieldDefs[selectedExistingUri].authority.org, " \u2014 ", fieldDefs[selectedExistingUri].authority.provision)), /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'right'
    }
  }, /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-sm",
    onClick: () => setAddExistingField(false),
    style: {
      marginRight: 6
    }
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    className: "b-pri b-sm",
    disabled: !selectedExistingUri,
    onClick: handleAddExistingField
  }, "Add to Schema")))), addFieldModal && /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-modal",
    onClick: () => setAddFieldModal(false)
  }, /*#__PURE__*/React.createElement("div", {
    className: "fb-adopt-panel",
    onClick: e => e.stopPropagation(),
    style: {
      maxWidth: 600
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 16,
      fontWeight: 700
    }
  }, "Define New Field"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setAddFieldModal(false),
    style: {
      background: 'none',
      border: 'none',
      color: 'var(--tx-2)',
      cursor: 'pointer',
      fontSize: 18
    }
  }, "\xD7")),
  // Import from URI Library button
  React.createElement('div', {
    style: { marginBottom: 12, display: 'flex', alignItems: 'center', gap: 8 }
  },
    React.createElement('button', {
      className: 'b-gho b-sm',
      style: { display: 'flex', alignItems: 'center', gap: 6, color: 'var(--teal)', borderColor: 'var(--teal)', fontSize: 12 },
      onClick: () => setUriBrowserOpen(true)
    },
      React.createElement(I, { n: 'globe', s: 12, c: 'var(--teal)' }),
      'Import from URI Library'
    ),
    React.createElement('span', { style: { fontSize: 10, color: 'var(--tx-3)' } }, 'Pre-fill from Schema.org, HMIS, FHIR, etc.')
  ),
  // URI Library Browser
  uriBrowserOpen && React.createElement(UriLibraryBrowser, {
    open: true,
    onClose: () => setUriBrowserOpen(false),
    onSelect: entry => {
      setFieldDraft(d => ({
        ...d,
        key: entry.key,
        label: entry.label,
        definition: entry.definition,
        data_type: entry.data_type || 'text',
        category: entry.category || d.category,
        standard_uri: entry.uri,
        source_library: entry.source_library
      }));
      setUriBrowserOpen(false);
    },
    mode: 'select'
  }),
  /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 10,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      display: 'block',
      marginBottom: 3
    }
  }, "Label *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: fieldDraft.label,
    onChange: e => {
      const label = e.target.value;
      setFieldDraft(d => ({
        ...d,
        label,
        key: label.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '')
      }));
    },
    className: "ipt",
    placeholder: "e.g. Housing Status",
    style: {
      width: '100%'
    }
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      display: 'block',
      marginBottom: 3
    }
  }, "Key"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: fieldDraft.key,
    onChange: e => setFieldDraft(d => ({
      ...d,
      key: e.target.value
    })),
    className: "ipt",
    placeholder: "housing_status",
    style: {
      width: '100%',
      fontFamily: 'var(--mono)',
      fontSize: 11
    }
  }))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      display: 'block',
      marginBottom: 3
    }
  }, "Definition *"), /*#__PURE__*/React.createElement("textarea", {
    value: fieldDraft.definition,
    onChange: e => {
      const val = e.target.value;
      setFieldDraft(d => ({
        ...d,
        definition: val
      }));
      // Debounced similarity search
      if (similarTimerRef.current) clearTimeout(similarTimerRef.current);
      if (val.length > 20) {
        similarTimerRef.current = setTimeout(async () => {
          setSearchingSimilar(true);
          const results = await findSimilarFields(`${fieldDraft.label}. ${val}`, fieldDefs, schema.fields?.map(f => f.uri) || []);
          setSimilarFields(results.filter(r => !dismissedSuggestions.includes(r.uri)));
          setSearchingSimilar(false);
        }, 500);
      } else {
        setSimilarFields([]);
      }
    },
    className: "ipt",
    rows: 3,
    placeholder: "What this field captures and what it means...",
    style: {
      width: '100%',
      resize: 'vertical'
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      display: 'block',
      marginBottom: 3
    }
  }, "Scope (optional)"), /*#__PURE__*/React.createElement("textarea", {
    value: fieldDraft.scope,
    onChange: e => setFieldDraft(d => ({
      ...d,
      scope: e.target.value
    })),
    className: "ipt",
    rows: 2,
    placeholder: "What this field includes and excludes...",
    style: {
      width: '100%',
      resize: 'vertical'
    }
  })), searchingSimilar && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 12px',
      background: 'var(--bg-2)',
      borderRadius: 'var(--r)',
      marginBottom: 10,
      fontSize: 11,
      color: 'var(--tx-3)'
    }
  }, "Analyzing definitions..."), similarFields.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 14px',
      background: 'var(--teal-dim)',
      border: '1px solid rgba(61,214,140,.15)',
      borderRadius: 'var(--r)',
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11,
      fontWeight: 600,
      color: 'var(--teal)',
      marginBottom: 8
    }
  }, "Similar fields found:"), similarFields.map(sf => /*#__PURE__*/React.createElement("div", {
    key: sf.uri,
    style: {
      padding: '8px 10px',
      background: 'var(--bg-2)',
      borderRadius: 'var(--r)',
      marginBottom: 4,
      display: 'flex',
      alignItems: 'flex-start',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 600
    }
  }, sf.def.label), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9,
      fontFamily: 'var(--mono)',
      color: 'var(--teal)'
    }
  }, Math.round(sf.similarity * 100), "% match")), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-2)',
      marginTop: 2
    }
  }, (sf.def.definition || '').slice(0, 80), (sf.def.definition || '').length > 80 ? '...' : '')), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 3,
      flexShrink: 0
    }
  }, /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-xs",
    style: {
      color: 'var(--green)',
      fontSize: 9
    },
    onClick: async () => {
      if (onSaveCrosswalk) {
        const key = fieldDraft.key || fieldDraft.label.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
        const newUri = `khora:team/${team.roomId}/${key}`;
        await onSaveCrosswalk({
          id: 'xw_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          from_uri: newUri,
          to_uri: sf.uri,
          relationship: 'equivalent',
          bidirectional: true,
          notes: 'Auto-suggested by similarity analysis',
          created_at: Date.now()
        });
      }
      setSimilarFields(prev => prev.filter(s => s.uri !== sf.uri));
    }
  }, "Link as equivalent"), /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-xs",
    style: {
      color: 'var(--gold)',
      fontSize: 9
    },
    onClick: async () => {
      if (onSaveCrosswalk) {
        const key = fieldDraft.key || fieldDraft.label.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
        const newUri = `khora:team/${team.roomId}/${key}`;
        await onSaveCrosswalk({
          id: 'xw_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          from_uri: newUri,
          to_uri: sf.uri,
          relationship: 'related',
          bidirectional: true,
          notes: 'Auto-suggested by similarity analysis',
          created_at: Date.now()
        });
      }
      setSimilarFields(prev => prev.filter(s => s.uri !== sf.uri));
    }
  }, "Link as related"), /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-xs",
    style: {
      color: 'var(--tx-3)',
      fontSize: 9
    },
    onClick: () => {
      const updated = [...dismissedSuggestions, sf.uri];
      setDismissedSuggestions(updated);
      try {
        localStorage.setItem('khora_dismissed_xw_suggestions', JSON.stringify(updated));
      } catch {}
      setSimilarFields(prev => prev.filter(s => s.uri !== sf.uri));
    }
  }, "Ignore"))))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr 80px',
      gap: 10,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      display: 'block',
      marginBottom: 3
    }
  }, "Category"), /*#__PURE__*/React.createElement("select", {
    value: fieldDraft.category,
    onChange: e => setFieldDraft(d => ({
      ...d,
      category: e.target.value
    })),
    className: "ipt",
    style: {
      width: '100%'
    }
  }, FIELD_CATEGORIES.map(c => /*#__PURE__*/React.createElement("option", {
    key: c,
    value: c
  }, CAT_LABELS[c] || c)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      display: 'block',
      marginBottom: 3
    }
  }, "Data Type"), /*#__PURE__*/React.createElement("select", {
    value: fieldDraft.data_type,
    onChange: e => setFieldDraft(d => ({
      ...d,
      data_type: e.target.value
    })),
    className: "ipt",
    style: {
      width: '100%'
    }
  }, ['text', 'text_long', 'date', 'number', 'email', 'phone', 'address', 'single_select', 'multi_select', 'document'].map(t => /*#__PURE__*/React.createElement("option", {
    key: t,
    value: t
  }, t.replace(/_/g, ' '))))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'flex-end'
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      marginBottom: 5
    }
  }, "Sensitive"), /*#__PURE__*/React.createElement("div", {
    onClick: () => setFieldDraft(d => ({
      ...d,
      sensitive: !d.sensitive
    })),
    style: {
      width: 36,
      height: 20,
      borderRadius: 10,
      background: fieldDraft.sensitive ? 'var(--red)' : 'var(--border-2)',
      cursor: 'pointer',
      position: 'relative',
      transition: 'background .2s'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 16,
      height: 16,
      borderRadius: '50%',
      background: 'white',
      position: 'absolute',
      top: 2,
      left: fieldDraft.sensitive ? 18 : 2,
      transition: 'left .2s'
    }
  })))), /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'right',
      marginTop: 14
    }
  }, /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-sm",
    onClick: () => setAddFieldModal(false),
    style: {
      marginRight: 6
    }
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    className: "b-pri b-sm",
    disabled: !fieldDraft.label || !fieldDraft.definition,
    onClick: handleSaveNewField
  }, schemaRule.mode === 'lead_decides' && isLead ? 'Save & Add' : 'Propose Field')))));
};

/* ─── ProfileActivityFeed — simple action log for an individual ─── */
const ProfileActivityFeed = ({
  individual,
  svc
}) => {
  const [events, setEvents] = useState([]);
  const [loading, setLoading] = useState(true);
  useEffect(() => {
    let cancelled = false;
    const load = async () => {
      setLoading(true);
      try {
        const roomId = individual.bridgeRoom || individual._case?.bridgeRoomId || individual.id;
        if (!roomId || !svc.client) {
          if (!cancelled) setLoading(false);
          return;
        }
        const room = svc.client.getRoom(roomId);
        if (!room) {
          if (!cancelled) setLoading(false);
          return;
        }
        // Paginate back to load recent historical events
        try {
          const canPag = room.getLiveTimeline().getPaginationToken('b');
          if (canPag) await svc.client.scrollback(room, 50);
        } catch (e) {/* pagination may fail */}
        const collected = [];
        const seenIds = new Set();
        const roomInfo = { type: 'bridge' };

        // Collect from ALL timeline sets (not just live)
        const timelineSets = room.getTimelineSets ? room.getTimelineSets() : [];
        const allTlEvents = [];
        if (timelineSets.length > 0) {
          for (const ts of timelineSets) {
            for (const tl of ts.getTimelines()) {
              for (const ev of tl.getEvents()) {
                if (!seenIds.has(ev.getId())) { seenIds.add(ev.getId()); allTlEvents.push(ev); }
              }
            }
          }
        } else {
          for (const ev of room.getLiveTimeline().getEvents()) {
            if (!seenIds.has(ev.getId())) { seenIds.add(ev.getId()); allTlEvents.push(ev); }
          }
        }
        for (const ev of allTlEvents) {
          const type = ev.getType();
          if (!type.startsWith('io.khora.') && !type.startsWith('m.room.')) continue;
          const classified = classifyEvent(ev, roomInfo);
          if (classified) {
            collected.push({ id: ev.getId(), ...classified, sender: ev.getSender(), ts: ev.getTs() });
          }
        }
        // Also collect state events not in timeline
        for (const ev of room.currentState.getStateEvents()) {
          if (seenIds.has(ev.getId())) continue;
          seenIds.add(ev.getId());
          const type = ev.getType();
          if (!type.startsWith('io.khora.')) continue;
          const classified = classifyEvent(ev, roomInfo);
          if (classified) {
            collected.push({ id: ev.getId(), ...classified, sender: ev.getSender(), ts: ev.getTs() });
          }
        }
        collected.sort((a, b) => b.ts - a.ts);
        if (!cancelled) setEvents(collected.slice(0, 50));
      } catch (e) {
        console.warn('Profile activity load failed:', e.message);
      }
      if (!cancelled) setLoading(false);
    };
    load();
    let debounce = null;
    const handler = () => {
      if (debounce) clearTimeout(debounce);
      debounce = setTimeout(() => load(), 300);
    };
    window.addEventListener('khora:eo', handler);
    window.addEventListener('khora:timeline', handler);
    window.addEventListener('khora:state', handler);
    return () => {
      cancelled = true;
      window.removeEventListener('khora:eo', handler);
      window.removeEventListener('khora:timeline', handler);
      window.removeEventListener('khora:state', handler);
      if (debounce) clearTimeout(debounce);
    };
  }, [individual.id, individual.bridgeRoom]);
  if (loading) return /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: { textAlign: 'center', padding: '30px 20px', color: 'var(--tx-3)' }
  }, "Loading activity...");
  if (events.length === 0) return /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: { textAlign: 'center', padding: '30px 20px', color: 'var(--tx-3)' }
  }, "No activity recorded yet for this individual.");
  return /*#__PURE__*/React.createElement("div", null, events.map(ev => {
    const opColor = OP_COLORS[ev.op] || 'blue';
    const verb = OP_DESCRIPTIONS[ev.op]?.verb || ev.op;
    const username = (ev.sender || '').split(':')[0]?.replace('@', '') || 'unknown';
    return /*#__PURE__*/React.createElement("div", {
      key: ev.id,
      style: { display: 'flex', gap: 10, padding: '10px 0', borderBottom: '1px solid var(--border-0)' }
    }, /*#__PURE__*/React.createElement("span", {
      className: "dt-eo",
      style: { background: `var(--${opColor}-dim)`, color: `var(--${opColor})`, flexShrink: 0 }
    }, ev.op), /*#__PURE__*/React.createElement("div", {
      style: { flex: 1, minWidth: 0 }
    }, /*#__PURE__*/React.createElement("div", {
      style: { fontSize: 13 }
    }, /*#__PURE__*/React.createElement("strong", null, verb), ev.label && /*#__PURE__*/React.createElement("span", {
      style: { color: 'var(--tx-1)' }
    }, " \u2014 ", ev.label)), ev.desc && /*#__PURE__*/React.createElement("div", {
      style: { fontSize: 11, color: 'var(--tx-2)', marginTop: 2 }
    }, ev.desc), /*#__PURE__*/React.createElement("div", {
      style: { fontSize: 10, color: 'var(--tx-3)', marginTop: 3 }
    }, username, " \xB7 ", new Date(ev.ts).toLocaleString())));
  }));
};

/* ─── IndividualProfilePage — full profile view for an individual ─── */
const IndividualProfilePage = ({
  individual,
  notes,
  allocations,
  onBack,
  onOpenCase,
  onAddNote,
  svc,
  T,
  showToast,
  resourceTypes,
  resourceRelations,
  resourceInventory,
  orgRoom,
  orgRole,
  canAllocateResource,
  onAllocate,
  fieldDefs,
  onFieldEdit
}) => {
  const [tab, setTab] = useState('fields');
  const [profileAllocModal, setProfileAllocModal] = useState(false);
  const [addFieldValue, setAddFieldValue] = useState(null);
  const [addFieldInput, setAddFieldInput] = useState('');
  const [addFieldPicker, setAddFieldPicker] = useState(false);
  const [profileAllocDraft, setProfileAllocDraft] = useState({
    resource_type_id: '',
    quantity: 1,
    notes: ''
  });
  const [provenanceTarget, setProvenanceTarget] = useState(null);
  if (!individual) return null;
  const indNotes = (notes || []).filter(n => n.attached_to === individual.id || n.indId === individual.id);
  const _provMeta = individual._case?.meta || {};
  const _provServer = extractHomeserver(individual.bridgeRoom || individual.id);
  const _provCreatedBy = _provMeta.created_by || _provMeta.provider || '';
  const _provCreatedAt = _provMeta.created;
  const indAllocs = (allocations || []).filter(a => a.indId === individual.id);
  return /*#__PURE__*/React.createElement("div", {
    className: "anim-up profile-page"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onBack,
    className: "b-gho b-sm",
    style: {
      marginBottom: 14,
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "back",
    s: 13
  }), "Back to Database"), /*#__PURE__*/React.createElement("div", {
    className: "profile-header"
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-avatar",
    style: {
      background: individual.status === 'revoked' ? 'var(--border-1)' : 'var(--green)'
    }
  }, (individual.name || '?')[0].toUpperCase()), /*#__PURE__*/React.createElement("div", {
    className: "profile-info"
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-name"
  }, individual.name || 'Unknown'), /*#__PURE__*/React.createElement("div", {
    className: "profile-badges"
  }, /*#__PURE__*/React.createElement(DtStatusBadge, {
    status: individual.status
  }), individual.bridgeRoom && /*#__PURE__*/React.createElement(DtRoom, {
    room: individual.bridgeRoom
  }), individual.transferable ? /*#__PURE__*/React.createElement("span", {
    className: "tag tag-teal",
    style: {
      fontSize: 9
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 8
  }), "Transferable") : /*#__PURE__*/React.createElement("span", {
    className: "tag tag-red",
    style: {
      fontSize: 9
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 8
  }), "Transfer Locked"), /*#__PURE__*/React.createElement(DtDiscBar, {
    level: individual.disclosureLevel || 0
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6,
      marginTop: 10
    }
  }, individual._case && /*#__PURE__*/React.createElement("button", {
    onClick: () => onOpenCase(individual._case.bridgeRoomId),
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "briefcase",
    s: 12
  }), "Open Case"), /*#__PURE__*/React.createElement("button", {
    onClick: () => onAddNote(individual.id),
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "msg",
    s: 12
  }), "Add Note")))), /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 12, padding: '8px 14px', marginBottom: 12, background: 'var(--bg-2)', borderRadius: 'var(--r)', border: '1px solid var(--border-0)', fontSize: 11, color: 'var(--tx-2)', fontFamily: 'var(--mono)', flexWrap: 'wrap' }
  }, /*#__PURE__*/React.createElement("span", { style: { display: 'flex', alignItems: 'center', gap: 4 } },
    /*#__PURE__*/React.createElement(I, { n: "server", s: 11, c: "var(--teal)" }), _provServer),
  _provCreatedAt && /*#__PURE__*/React.createElement("span", { style: { display: 'flex', alignItems: 'center', gap: 4 } },
    /*#__PURE__*/React.createElement(I, { n: "clock", s: 11, c: "var(--blue)" }),
    new Date(_provCreatedAt).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })),
  _provCreatedBy && /*#__PURE__*/React.createElement("span", { style: { display: 'flex', alignItems: 'center', gap: 4 } },
    /*#__PURE__*/React.createElement(I, { n: "user", s: 11, c: "var(--gold)" }),
    (_provCreatedBy.startsWith('@') ? _provCreatedBy.split(':')[0].slice(1) : _provCreatedBy)),
  individual.bridgeRoom && /*#__PURE__*/React.createElement("span", { style: { display: 'flex', alignItems: 'center', gap: 4, marginLeft: 'auto', fontSize: 9.5, color: 'var(--tx-3)', maxWidth: 180, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } },
    /*#__PURE__*/React.createElement(I, { n: "hash", s: 10, c: "var(--tx-3)" }), individual.bridgeRoom)
  ), /*#__PURE__*/React.createElement("div", {
    className: "profile-tabs"
  }, [{
    id: 'fields',
    label: 'Fields'
  }, {
    id: 'notes',
    label: `Notes (${indNotes.length})`
  }, {
    id: 'allocations',
    label: `Allocations (${indAllocs.length})`
  }, {
    id: 'activity',
    label: 'Activity'
  }, {
    id: 'provenance',
    label: 'Provenance'
  }].map(t => /*#__PURE__*/React.createElement("button", {
    key: t.id,
    className: 'profile-tab' + (tab === t.id ? ' active' : ''),
    onClick: () => setTab(t.id)
  }, t.label))), tab === 'fields' && /*#__PURE__*/React.createElement("div", {
    className: "profile-section"
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 }
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-section-title",
    style: { marginBottom: 0 }
  }, "Fields"), /*#__PURE__*/React.createElement("div", {
    className: "dt-dd-wrap",
    style: { position: 'relative' }
  }, /*#__PURE__*/React.createElement("button", {
    className: "b-pri b-sm",
    style: { display: 'flex', alignItems: 'center', gap: 4 },
    onClick: () => setAddFieldPicker(!addFieldPicker)
  }, /*#__PURE__*/React.createElement(I, { n: "plus", s: 11 }), "Add Field"), addFieldPicker && /*#__PURE__*/React.createElement("div", {
    className: "dt-dd",
    style: { minWidth: 240, maxHeight: 280, overflow: 'auto', right: 0, left: 'auto' }
  }, /*#__PURE__*/React.createElement("div", { className: "dt-dd-label" }, "Add a field value"), Object.values(fieldDefs || {}).filter(d => d.key !== 'full_name' && !(individual.fields || {})[d.key]).map(d => /*#__PURE__*/React.createElement("div", {
    key: d.uri || d.key,
    className: "dt-dd-item",
    onClick: () => { setAddFieldValue(d); setAddFieldInput(''); setAddFieldPicker(false); }
  }, /*#__PURE__*/React.createElement("div", { style: { fontWeight: 500, fontSize: 12.5 } }, d.label || d.key), /*#__PURE__*/React.createElement("div", { style: { fontSize: 10, color: 'var(--tx-3)', marginTop: 1 } }, [d.category, d.data_type].filter(Boolean).join(' \u00b7 ')))), Object.values(fieldDefs || {}).filter(d => d.key !== 'full_name' && !(individual.fields || {})[d.key]).length === 0 && /*#__PURE__*/React.createElement("div", {
    style: { padding: '12px 14px', fontSize: 11.5, color: 'var(--tx-3)' }
  }, "All fields already have values.")))), addFieldValue && /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: { padding: 14, marginBottom: 12, border: '1px solid var(--gold)', background: 'var(--bg-2)' }
  }, /*#__PURE__*/React.createElement("div", { style: { fontSize: 12, fontWeight: 600, marginBottom: 6, color: 'var(--gold)' } }, "Set value for: ", addFieldValue.label || addFieldValue.key), /*#__PURE__*/React.createElement("div", { style: { display: 'flex', gap: 6 } }, /*#__PURE__*/React.createElement("input", {
    className: "dt-search",
    style: { flex: 1, width: 'auto' },
    placeholder: `Enter ${addFieldValue.label || addFieldValue.key}...`,
    value: addFieldInput,
    onChange: e => setAddFieldInput(e.target.value),
    onKeyDown: e => {
      if (e.key === 'Enter' && addFieldInput.trim() && onFieldEdit) {
        onFieldEdit(individual, addFieldValue.key, addFieldInput.trim());
        setAddFieldValue(null);
        setAddFieldInput('');
      }
    },
    autoFocus: true
  }), /*#__PURE__*/React.createElement("button", {
    className: "b-pri b-sm",
    disabled: !addFieldInput.trim(),
    onClick: () => {
      if (addFieldInput.trim() && onFieldEdit) {
        onFieldEdit(individual, addFieldValue.key, addFieldInput.trim());
        setAddFieldValue(null);
        setAddFieldInput('');
      }
    }
  }, "Save"), /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-sm",
    onClick: () => { setAddFieldValue(null); setAddFieldInput(''); }
  }, "Cancel"))), Object.keys(individual.fields || {}).length === 0 && !addFieldValue ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '30px 20px',
      color: 'var(--tx-3)'
    }
  }, "No fields yet. Click ", /*#__PURE__*/React.createElement("strong", null, "Add Field"), " above to get started.") : /*#__PURE__*/React.createElement("div", {
    className: "profile-fields-grid"
  }, Object.entries(individual.fields || {}).map(([key, f]) => {
    const _fpOpen = provenanceTarget?.entityKey === key && provenanceTarget?.roomId === individual.bridgeRoom;
    return /*#__PURE__*/React.createElement("div", {
    key: key,
    className: "profile-field-card"
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-field-label"
  }, (() => { const def = Object.values(fieldDefs || {}).find(d => d.key === key); return def?.label || key.replace(/_/g, ' '); })()), f.disclosed === false ? /*#__PURE__*/React.createElement("div", {
    className: "dt-locked"
  }, /*#__PURE__*/React.createElement(DtLock, null), " not disclosed") : /*#__PURE__*/React.createElement("div", {
    className: "profile-field-value"
  }, f.value || '\u2014'), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4,
      marginTop: 6,
      alignItems: 'center'
    }
  }, f.eo_op && /*#__PURE__*/React.createElement(DtEo, {
    op: f.eo_op
  }), f.frame && /*#__PURE__*/React.createElement("span", {
    className: "dt-eo",
    style: {
      background: f.frame === 'GIVEN' ? 'var(--teal-dim)' : 'var(--gold-dim)',
      color: f.frame === 'GIVEN' ? 'var(--teal)' : 'var(--gold)'
    }
  }, f.frame), individual.bridgeRoom && /*#__PURE__*/React.createElement("span", {
    onClick: () => setProvenanceTarget(_fpOpen ? null : { entityKey: key, label: key.replace(/_/g, ' '), roomId: individual.bridgeRoom }),
    style: { cursor: 'pointer', color: _fpOpen ? 'var(--teal)' : 'var(--tx-3)', transition: 'color .15s', marginLeft: 'auto' },
    title: "View field history"
  }, /*#__PURE__*/React.createElement(I, { n: "git-commit", s: 11 }))),
  _fpOpen && /*#__PURE__*/React.createElement("div", {
    style: { marginTop: 6 }
  }, /*#__PURE__*/React.createElement(RecordProvenance, {
    roomId: individual.bridgeRoom,
    entityKey: key,
    label: key.replace(/_/g, ' '),
    session: null,
    onRestore: onFieldEdit ? value => onFieldEdit(individual, key, value) : null
  })));
  }))), tab === 'notes' && /*#__PURE__*/React.createElement("div", {
    className: "profile-section"
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-section-title",
    style: {
      marginBottom: 0
    }
  }, "Notes"), /*#__PURE__*/React.createElement("button", {
    onClick: () => onAddNote(individual.id),
    className: "b-gho b-xs",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 3
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 11
  }), "Add Note")), indNotes.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '30px 20px',
      color: 'var(--tx-3)'
    }
  }, "No notes yet. Click \"Add Note\" to create one.") : indNotes.map(n => /*#__PURE__*/React.createElement("div", {
    key: n.id,
    className: 'note-card' + (n.tombstoned ? ' tombstoned' : n.attached_to ? ' attached' : ' standalone')
  }, n.tombstoned ? /*#__PURE__*/React.createElement("div", {
    className: "tombstone-notice"
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 14
  }), "This note was deleted by the individual. The record has been tombstoned.") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "note-header"
  }, /*#__PURE__*/React.createElement("div", {
    className: "note-title"
  }, n.title || '(untitled)'), /*#__PURE__*/React.createElement("div", {
    className: "note-meta"
  }, dtFmtDate(n.created), " \xB7 ", (n.author || '').split(':')[0]?.replace('@', ''))), /*#__PURE__*/React.createElement("div", {
    className: "note-body"
  }, n.content || n.text || ''), n.tags && n.tags.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "note-tags"
  }, n.tags.map(t => /*#__PURE__*/React.createElement("span", {
    key: t.userId,
    className: "note-tag-chip"
  }, t.displayName))))))), tab === 'allocations' && /*#__PURE__*/React.createElement("div", {
    className: "profile-section"
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-section-title",
    style: {
      marginBottom: 0
    }
  }, "Resource Allocations"), orgRoom && (resourceTypes || []).length > 0 && onAllocate && individual.bridgeRoom && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setProfileAllocDraft({
        resource_type_id: '',
        quantity: 1,
        notes: ''
      });
      setProfileAllocModal(true);
    },
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 11
  }), "Allocate")), indAllocs.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '30px 20px',
      color: 'var(--tx-3)'
    }
  }, "No resource allocations.") : indAllocs.map(a => /*#__PURE__*/React.createElement("div", {
    key: a.id,
    className: "dt-alloc"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-alloc-header"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: 600,
      fontSize: 13
    }
  }, a.resourceName || 'Resource'), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, a.quantity, " ", a.unit, " \xB7 ", dtFmtDate(a.at))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(DtEo, {
    op: a.eo_op || 'CON'
  }), /*#__PURE__*/React.createElement("span", {
    className: 'tag ' + (a.status === 'active' ? 'tag-green' : 'tag-purple'),
    style: {
      fontSize: 10
    }
  }, a.status)))))), tab === 'activity' && /*#__PURE__*/React.createElement("div", {
    className: "profile-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-section-title"
  }, "Recent Activity"), /*#__PURE__*/React.createElement(ProfileActivityFeed, {
    individual: individual,
    svc: svc
  })), tab === 'provenance' && /*#__PURE__*/React.createElement("div", {
    className: "profile-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-section-title"
  }, "Record Provenance"), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: individual.bridgeRoom,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Personal Record",
    members: [
      ...(individual._case?.meta?.client ? [{ userId: individual._case.meta.client, role: 'client (sovereign owner)' }] : []),
      ...(individual._case?.meta?.provider ? [{ userId: individual._case.meta.provider, role: 'provider' }] : []),
      ...((individual._case?.meta?.assigned_staff || []).filter(s => s !== individual._case?.meta?.provider).map(s => ({ userId: s, role: 'assigned ' + T.staff_term.toLowerCase() })))
    ],
    extra: [
      { label: 'Record type', value: 'Individual profile stored in a shared bridge room' },
      { label: 'Sovereignty', value: individual._case?.meta?.client ? 'Client-owned bridge — client has superadmin power level' : 'Provider-created record' }
    ]
  }), /*#__PURE__*/React.createElement("div", {
    style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, margin: '14px 0' }
  }, /*#__PURE__*/React.createElement("div", {
    style: { padding: '10px 12px', background: 'var(--bg-2)', borderRadius: 6 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 9, textTransform: 'uppercase', color: 'var(--tx-3)', letterSpacing: '.04em', marginBottom: 2 }
  }, "Server"), /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 11.5, fontFamily: 'var(--mono)', color: 'var(--tx-1)', wordBreak: 'break-all' }
  }, _provServer)), /*#__PURE__*/React.createElement("div", {
    style: { padding: '10px 12px', background: 'var(--bg-2)', borderRadius: 6 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 9, textTransform: 'uppercase', color: 'var(--tx-3)', letterSpacing: '.04em', marginBottom: 2 }
  }, "Created by"), /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 11.5, color: 'var(--tx-1)' }
  }, _provCreatedBy ? (_provCreatedBy.startsWith('@') ? _provCreatedBy.split(':')[0].slice(1) : _provCreatedBy) : 'Unknown'), _provCreatedBy && /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 9.5, color: 'var(--tx-3)', fontFamily: 'var(--mono)' }
  }, extractHomeserver(_provCreatedBy))), /*#__PURE__*/React.createElement("div", {
    style: { padding: '10px 12px', background: 'var(--bg-2)', borderRadius: 6 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 9, textTransform: 'uppercase', color: 'var(--tx-3)', letterSpacing: '.04em', marginBottom: 2 }
  }, "Created"), /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 11.5, color: 'var(--tx-1)' }
  }, _provCreatedAt ? new Date(_provCreatedAt).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }) + ' ' + new Date(_provCreatedAt).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }) : '\u2014')), /*#__PURE__*/React.createElement("div", {
    style: { padding: '10px 12px', background: 'var(--bg-2)', borderRadius: 6 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 9, textTransform: 'uppercase', color: 'var(--tx-3)', letterSpacing: '.04em', marginBottom: 2 }
  }, "Status"), /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 4 }
  }, /*#__PURE__*/React.createElement("span", {
    style: { width: 6, height: 6, borderRadius: '50%', background: individual.status === 'active' ? 'var(--green)' : individual.status === 'revoked' ? 'var(--red)' : 'var(--gold)' }
  }), /*#__PURE__*/React.createElement("span", {
    style: { fontSize: 11.5, color: 'var(--tx-1)', textTransform: 'capitalize' }
  }, individual.status || 'unknown')))), /*#__PURE__*/React.createElement("div", {
    style: { marginTop: 4 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 10.5, textTransform: 'uppercase', color: 'var(--tx-3)', letterSpacing: '.04em', marginBottom: 8, fontWeight: 600 }
  }, "Full EO Operation History"), /*#__PURE__*/React.createElement(RecordProvenance, {
    roomId: individual.bridgeRoom,
    entityKey: 'bridge',
    label: individual.name || 'Individual',
    session: null
  }))), /*#__PURE__*/React.createElement(Modal, {
    open: profileAllocModal,
    onClose: () => setProfileAllocModal(false),
    title: "Allocate Resource",
    w: 480
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Allocate a resource to ", /*#__PURE__*/React.createElement("strong", null, individual.name || 'this individual'), ". The allocation is recorded in the bridge room and updates org inventory."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "RESOURCE TYPE"), /*#__PURE__*/React.createElement("select", {
    value: profileAllocDraft.resource_type_id,
    onChange: e => setProfileAllocDraft({
      ...profileAllocDraft,
      resource_type_id: e.target.value
    })
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select a resource..."), (resourceTypes || []).filter(rt => canAllocateResource && canAllocateResource(rt, svc.userId, orgRole)).map(rt => {
    const relation = (resourceRelations || []).find(r => r.resource_type_id === rt.id);
    const inv = relation ? (resourceInventory || {})[relation.id] : null;
    return /*#__PURE__*/React.createElement("option", {
      key: rt.id,
      value: rt.id
    }, rt.name, " (", rt.unit, ")", inv ? ` — ${inv.available || 0} available` : '');
  }))), profileAllocDraft.resource_type_id && (() => {
    const rt = (resourceTypes || []).find(t => t.id === profileAllocDraft.resource_type_id);
    if (!rt) return null;
    return /*#__PURE__*/React.createElement("div", {
      style: {
        background: 'var(--bg-2)',
        border: '1px solid var(--border-0)',
        borderRadius: 'var(--r)',
        padding: '10px 14px',
        marginBottom: 14
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginBottom: 4
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${RESOURCE_CATEGORY_COLORS[rt.category] || 'teal'}`,
      style: {
        fontSize: 8.5
      }
    }, RESOURCE_CATEGORY_LABELS[rt.category] || rt.category), rt.fungible && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)'
      }
    }, "fungible"), rt.perishable && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--orange)',
        fontFamily: 'var(--mono)'
      }
    }, "expires ", rt.ttl_days, "d")), rt.tags?.length > 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 3,
        flexWrap: 'wrap'
      }
    }, rt.tags.map(tag => /*#__PURE__*/React.createElement("span", {
      key: tag,
      style: {
        fontSize: 8,
        padding: '1px 5px',
        borderRadius: 99,
        background: 'var(--bg-3)',
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)'
      }
    }, tag))));
  })(), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "QUANTITY"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    min: "1",
    value: profileAllocDraft.quantity,
    onChange: e => setProfileAllocDraft({
      ...profileAllocDraft,
      quantity: e.target.value
    }),
    placeholder: "1"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "NOTES (OPTIONAL)"), /*#__PURE__*/React.createElement("input", {
    value: profileAllocDraft.notes,
    onChange: e => setProfileAllocDraft({
      ...profileAllocDraft,
      notes: e.target.value
    }),
    placeholder: "e.g. For medical appointments this week"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: async () => {
      if (!profileAllocDraft.resource_type_id || !onAllocate) return;
      const success = await onAllocate(individual.bridgeRoom, profileAllocDraft);
      if (success) {
        setProfileAllocModal(false);
        setProfileAllocDraft({
          resource_type_id: '',
          quantity: 1,
          notes: ''
        });
      }
    },
    className: "b-pri",
    disabled: !profileAllocDraft.resource_type_id,
    style: {
      width: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 13
  }), "Allocate Resource")));
};

/* ─── ResourceProfilePage — full profile view for a resource ─── */
const ResourceProfilePage = ({
  resource,
  allocations,
  onBack,
  T
}) => {
  const [tab, setTab] = useState('details');
  if (!resource) return null;
  const resAllocs = (allocations || []).filter(a => a.resourceId === resource.id);
  return /*#__PURE__*/React.createElement("div", {
    className: "anim-up profile-page"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onBack,
    className: "b-gho b-sm",
    style: {
      marginBottom: 14,
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "back",
    s: 13
  }), "Back to Database"), /*#__PURE__*/React.createElement("div", {
    className: "profile-header"
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-avatar",
    style: {
      background: 'var(--teal)'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "layers",
    s: 22
  })), /*#__PURE__*/React.createElement("div", {
    className: "profile-info"
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-name"
  }, resource.name), /*#__PURE__*/React.createElement("div", {
    className: "profile-badges"
  }, /*#__PURE__*/React.createElement("span", {
    className: 'tag tag-' + (RESOURCE_CATEGORY_COLORS[resource.category] || 'teal'),
    style: {
      fontSize: 10
    }
  }, RESOURCE_CATEGORY_LABELS[resource.category] || resource.category), resource.relation && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 10
    }
  }, resource.relation), resource.opacityLevel && (() => {
    const o = DT_OP_CFG[resource.opacityLevel];
    return o ? /*#__PURE__*/React.createElement("span", {
      className: 'tag ' + o.cls,
      style: {
        fontSize: 10
      }
    }, o.l) : null;
  })(), /*#__PURE__*/React.createElement(DtRoom, {
    room: resource.orgRoom
  })))), /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 12, padding: '8px 14px', marginBottom: 12, background: 'var(--bg-2)', borderRadius: 'var(--r)', border: '1px solid var(--border-0)', fontSize: 11, color: 'var(--tx-2)', fontFamily: 'var(--mono)', flexWrap: 'wrap' }
  }, /*#__PURE__*/React.createElement("span", { style: { display: 'flex', alignItems: 'center', gap: 4 } },
    /*#__PURE__*/React.createElement(I, { n: "server", s: 11, c: "var(--teal)" }), extractHomeserver(resource.orgRoom || resource.id || '')),
  resource.created && /*#__PURE__*/React.createElement("span", { style: { display: 'flex', alignItems: 'center', gap: 4 } },
    /*#__PURE__*/React.createElement(I, { n: "clock", s: 11, c: "var(--blue)" }),
    new Date(resource.created).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })),
  resource.orgRoom && /*#__PURE__*/React.createElement("span", { style: { display: 'flex', alignItems: 'center', gap: 4, marginLeft: 'auto', fontSize: 9.5, color: 'var(--tx-3)', maxWidth: 180, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } },
    /*#__PURE__*/React.createElement(I, { n: "hash", s: 10, c: "var(--tx-3)" }), resource.orgRoom)
  ), /*#__PURE__*/React.createElement("div", {
    className: "profile-tabs"
  }, [{
    id: 'details',
    label: 'Details'
  }, {
    id: 'provisioning',
    label: 'Provisioning'
  }, {
    id: 'allocations',
    label: `Allocations (${resAllocs.length})`
  }, {
    id: 'provenance',
    label: 'Provenance'
  }].map(t => /*#__PURE__*/React.createElement("button", {
    key: t.id,
    className: 'profile-tab' + (tab === t.id ? ' active' : ''),
    onClick: () => setTab(t.id)
  }, t.label))), tab === 'details' && /*#__PURE__*/React.createElement("div", {
    className: "profile-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-cap"
  }, [{
    n: resource.available || 0,
    l: 'Available',
    c: 'var(--green)'
  }, {
    n: resource.allocated || 0,
    l: 'Allocated',
    c: 'var(--teal)'
  }, {
    n: resource.reserved || 0,
    l: 'Reserved',
    c: 'var(--gold)'
  }, {
    n: resource.totalCapacity || 0,
    l: 'Total',
    c: 'var(--tx-0)'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "dt-cap-box"
  }, /*#__PURE__*/React.createElement("div", {
    className: "num",
    style: {
      color: s.c
    }
  }, s.n), /*#__PURE__*/React.createElement("div", {
    className: "lbl"
  }, s.l)))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement(DtUtilBar, {
    pct: resource.utilizationPct || 0
  })), /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "Details"), /*#__PURE__*/React.createElement("div", {
    className: "dt-field-grid"
  }, [{
    k: 'Holder',
    v: (resource.holder || '—') + ' (' + (resource.holderType || 'org') + ')'
  }, {
    k: 'Relation',
    v: resource.relation || '—'
  }, {
    k: 'Network',
    v: resource.network || '—'
  }, {
    k: 'Governance',
    v: resource.governance || '—'
  }, {
    k: 'Updated',
    v: dtFmtDate(resource.lastUpdated)
  }, {
    k: 'Unit',
    v: resource.unit || '—'
  }].map(({
    k,
    v
  }) => /*#__PURE__*/React.createElement(React.Fragment, {
    key: k
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-field-key"
  }, k), /*#__PURE__*/React.createElement("div", null, v))))), tab === 'provisioning' && /*#__PURE__*/React.createElement("div", {
    className: "profile-section"
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "Provisioning Timeline"), (resource.provisioningEvents || []).length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '30px 20px',
      color: 'var(--tx-3)'
    }
  }, "No provisioning events.") : (resource.provisioningEvents || []).map((evt, i) => {
    const color = DT_PROV_COLORS[evt.event] || 'var(--tx-2)';
    return /*#__PURE__*/React.createElement("div", {
      key: i,
      className: "dt-prov"
    }, /*#__PURE__*/React.createElement("div", {
      className: "dt-prov-icon",
      style: {
        background: color + '18',
        color
      }
    }, evt.event === 'restocked' ? '↑' : '→'), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1
      }
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("strong", null, (evt.event || '').replace(/_/g, ' ')), " ", /*#__PURE__*/React.createElement(DtEo, {
      op: evt.eo_op || 'ALT'
    }), ' ', /*#__PURE__*/React.createElement("span", {
      style: {
        color,
        fontWeight: 600,
        fontFamily: 'var(--mono)',
        fontSize: 12
      }
    }, evt.delta)), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 11,
        color: 'var(--tx-3)'
      }
    }, dtFmtDate(evt.at))));
  })), tab === 'allocations' && /*#__PURE__*/React.createElement("div", {
    className: "profile-section"
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "Allocations"), resAllocs.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '30px 20px',
      color: 'var(--tx-3)'
    }
  }, "No allocations.") : resAllocs.map(a => /*#__PURE__*/React.createElement("div", {
    key: a.id,
    className: "dt-alloc"
  }, /*#__PURE__*/React.createElement("div", {
    className: "dt-alloc-header"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      fontWeight: 600,
      fontSize: 13
    }
  }, a.indName || '[bridge ref]'), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, a.quantity, " ", a.unit, " \xB7 ", dtFmtDate(a.at))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(DtEo, {
    op: a.eo_op || 'CON'
  }), /*#__PURE__*/React.createElement("span", {
    className: 'tag ' + (a.status === 'active' ? 'tag-green' : 'tag-purple'),
    style: {
      fontSize: 10
    }
  }, a.status)))))), tab === 'provenance' && /*#__PURE__*/React.createElement("div", {
    className: "profile-section"
  }, /*#__PURE__*/React.createElement("div", {
    className: "profile-section-title"
  }, "Record Provenance"), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: resource.orgRoom,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Resource Record",
    extra: [
      { label: 'Record type', value: 'Resource type stored in the organization room' },
      { label: 'Holder', value: resource.holder || 'Organization' }
    ]
  }), /*#__PURE__*/React.createElement("div", {
    style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, margin: '14px 0' }
  }, /*#__PURE__*/React.createElement("div", {
    style: { padding: '10px 12px', background: 'var(--bg-2)', borderRadius: 6 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 9, textTransform: 'uppercase', color: 'var(--tx-3)', letterSpacing: '.04em', marginBottom: 2 }
  }, "Server"), /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 11.5, fontFamily: 'var(--mono)', color: 'var(--tx-1)', wordBreak: 'break-all' }
  }, extractHomeserver(resource.orgRoom || resource.id || ''))), /*#__PURE__*/React.createElement("div", {
    style: { padding: '10px 12px', background: 'var(--bg-2)', borderRadius: 6 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 9, textTransform: 'uppercase', color: 'var(--tx-3)', letterSpacing: '.04em', marginBottom: 2 }
  }, "Created"), /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 11.5, color: 'var(--tx-1)' }
  }, resource.created ? new Date(resource.created).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }) + ' ' + new Date(resource.created).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }) : '\u2014')), /*#__PURE__*/React.createElement("div", {
    style: { padding: '10px 12px', background: 'var(--bg-2)', borderRadius: 6 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 9, textTransform: 'uppercase', color: 'var(--tx-3)', letterSpacing: '.04em', marginBottom: 2 }
  }, "Unit"), /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 11.5, color: 'var(--tx-1)' }
  }, resource.unit || '\u2014')), /*#__PURE__*/React.createElement("div", {
    style: { padding: '10px 12px', background: 'var(--bg-2)', borderRadius: 6 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 9, textTransform: 'uppercase', color: 'var(--tx-3)', letterSpacing: '.04em', marginBottom: 2 }
  }, "Category"), /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 11.5, color: 'var(--tx-1)', textTransform: 'capitalize' }
  }, RESOURCE_CATEGORY_LABELS[resource.category] || resource.category || '\u2014'))), /*#__PURE__*/React.createElement("div", {
    style: { marginTop: 4 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 10.5, textTransform: 'uppercase', color: 'var(--tx-3)', letterSpacing: '.04em', marginBottom: 8, fontWeight: 600 }
  }, "Full EO Operation History"), resource.orgRoom ? /*#__PURE__*/React.createElement(RecordProvenance, {
    roomId: resource.orgRoom,
    entityKey: resource.id || 'resources',
    label: resource.name || 'Resource',
    session: null
  }) : /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 11, color: 'var(--tx-3)', padding: 12 }
  }, "No room available for provenance lookup."))));
};

/* ─── DashboardOverview — lightweight home with stats and recent activity ─── */
const DashboardOverview = ({
  cases,
  clientRecords,
  staff,
  T,
  notes,
  resourceTypes,
  onGoToDatabase,
  onDiscover,
  onCreateClient
}) => {
  const recentNotes = (notes || []).slice(0, 5);
  return /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 1000,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "Dashboard"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 2
    }
  }, "Quick overview of your workspace."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Dashboard",
    compact: true
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onDiscover,
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "search",
    s: 12
  }), "Find ", T?.client_term || 'Client'), /*#__PURE__*/React.createElement("button", {
    onClick: onCreateClient,
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 12
  }), "New ", T?.client_term || 'Individual'))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(160px,1fr))',
      gap: 10,
      marginBottom: 24
    }
  }, [{
    l: `Active ${T?.client_term_plural || 'Cases'}`,
    v: cases.length,
    c: 'gold',
    i: 'users'
  }, {
    l: `${T?.client_term || 'Client'} Records`,
    v: (clientRecords || []).length,
    c: 'teal',
    i: 'shield'
  }, {
    l: T.staff_term_plural,
    v: (staff || []).length,
    c: 'blue',
    i: 'briefcase'
  }, {
    l: 'Resources',
    v: (resourceTypes || []).length,
    c: 'green',
    i: 'layers'
  }, {
    l: 'Notes',
    v: (notes || []).length,
    c: 'purple',
    i: 'msg'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: 14,
      cursor: 'pointer'
    },
    onClick: onGoToDatabase
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginTop: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 22,
      fontWeight: 700
    }
  }, s.v), /*#__PURE__*/React.createElement("span", {
    style: {
      color: `var(--${s.c})`,
      opacity: .5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: s.i,
    s: 18
  })))))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "QUICK ACTIONS"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      marginTop: 8,
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onGoToDatabase,
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "grid",
    s: 12
  }), "Open Database"), /*#__PURE__*/React.createElement("button", {
    onClick: onDiscover,
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "search",
    s: 12
  }), "Find ", T?.client_term || 'Client'), /*#__PURE__*/React.createElement("button", {
    onClick: onCreateClient,
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 12
  }), "New ", T?.client_term || 'Individual'))), recentNotes.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "card"
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "RECENT NOTES"), recentNotes.map(n => /*#__PURE__*/React.createElement("div", {
    key: n.id,
    style: {
      padding: '8px 0',
      borderBottom: '1px solid var(--border-0)',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 600
    }
  }, n.title || '(untitled)'), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginLeft: 8
    }
  }, (n.author || '').split(':')[0]?.replace('@', ''))), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)'
    }
  }, dtFmtDate(n.created))))));
};

/* ─── IndividualsView — replaces old dashboard card grid ─── */
const IndividualsView = ({
  cases,
  caseAssignments,
  openCase,
  T,
  svc,
  caseAllocations,
  providerProfile,
  orgRoom,
  orgMeta,
  staff,
  orgRole,
  showToast,
  bridgeNotes,
  rosterNotes,
  allAllocations,
  onCreateOrg,
  onEditProfile,
  onDiscover,
  myVerification,
  emailVerifyConfig,
  openEmailVerifyModal,
  orgChannels,
  ORG_TYPE_LABELS,
  ORG_ROLE_LABELS
}) => {
  const [dtTab, setDtTab] = useState('individuals');
  const [selectedRow, setSelectedRow] = useState(null);
  const [panelTab, setPanelTab] = useState('fields');
  const [provenanceField, setProvenanceField] = useState(null);

  // Transform cases into individual rows
  const individuals = cases.map(c => {
    const assignment = caseAssignments[c.bridgeRoomId];
    const fields = {};
    Object.entries(c.sharedData || {}).forEach(([k, v]) => {
      if (k === 'full_name') return; // handled as name
      fields[k] = {
        value: v,
        disclosed: true,
        eo_op: 'INS',
        frame: 'GIVEN',
        room: 'bridge',
        editable: false,
        history: []
      };
    });
    return {
      id: c.bridgeRoomId,
      name: c.sharedData.full_name || c.clientUserId || 'Unknown',
      alias: null,
      status: c.meta?.status === 'tombstoned' ? 'revoked' : c.sharedData.full_name ? 'active' : 'imported',
      disclosureLevel: Object.keys(c.sharedData || {}).length > 0 ? Math.min(Object.keys(c.sharedData).length / 10, 1) : 0,
      lastContact: c.meta?.last_updated || c.meta?.created,
      assignedTo: (assignment?.primary || c.meta?.provider || '').split(':')[0]?.replace('@', '') || '—',
      activeCases: 1,
      needs: [],
      priority: assignment?.priority || 'none',
      nextAction: assignment?.next_action || null,
      nextActionDue: assignment?.next_action_due || null,
      bridgeRoom: c.bridgeRoomId,
      vaultRoom: null,
      rosterRef: null,
      fields,
      transferable: c.transferable,
      _case: c // preserve original for openCase
    };
  });
  const IND_COLS = [{
    key: 'name',
    label: 'Individual',
    fixed: true
  }, {
    key: 'status',
    label: 'Status'
  }, {
    key: 'priority',
    label: 'Priority'
  }, {
    key: 'assignedTo',
    label: 'Assigned'
  }, {
    key: 'fields_count',
    label: 'Fields'
  }, {
    key: 'transferable',
    label: 'Transfer'
  }];

  // Add dynamic field columns from shared data
  const fieldKeys = new Set();
  cases.forEach(c => Object.keys(c.sharedData || {}).forEach(k => {
    if (k !== 'full_name') fieldKeys.add(k);
  }));
  fieldKeys.forEach(k => {
    IND_COLS.push({
      key: k,
      label: k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
      isField: true
    });
  });
  const IND_GROUPS = [{
    k: 'none',
    l: 'No grouping'
  }, {
    k: 'status',
    l: 'Status'
  }, {
    k: 'assignedTo',
    l: 'Assigned To'
  }, {
    k: 'priority',
    l: 'Priority'
  }];
  const defaultVisCols = ['name', 'status', 'priority', 'assignedTo', 'fields_count', 'transferable', ...Array.from(fieldKeys).slice(0, 3)];
  const getIndVal = (row, key) => {
    if (key === 'fields_count') return Object.keys(row.fields || {}).length;
    if (key === 'transferable') return row.transferable ? 'Yes' : 'Locked';
    if (row.fields && row.fields[key]) return row.fields[key].value || '';
    return row[key] || '';
  };
  const renderIndCell = (row, col) => {
    const k = col.key;
    if (k === 'name') {
      const initial = (row.name || '?')[0].toUpperCase();
      return /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: 8
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          width: 24,
          height: 24,
          borderRadius: '50%',
          background: row.status === 'revoked' ? 'var(--border-1)' : 'var(--green)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          color: '#fff',
          fontSize: 11,
          fontWeight: 700,
          flexShrink: 0
        }
      }, initial), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
        style: {
          fontWeight: 600,
          fontSize: 13
        }
      }, row.name), row.alias && /*#__PURE__*/React.createElement("div", {
        style: {
          fontSize: 11,
          color: 'var(--tx-3)'
        }
      }, "\"", row.alias, "\"")));
    }
    if (k === 'status') return /*#__PURE__*/React.createElement(DtStatusBadge, {
      status: row.status
    });
    if (k === 'priority') {
      const cls = DT_PRI_CFG[row.priority] || 'tag-purple';
      return /*#__PURE__*/React.createElement("span", {
        className: 'tag ' + cls,
        style: {
          fontSize: 10
        }
      }, row.priority);
    }
    if (k === 'assignedTo') return /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        color: 'var(--tx-1)'
      }
    }, row.assignedTo);
    if (k === 'fields_count') {
      const ct = Object.keys(row.fields || {}).length;
      return /*#__PURE__*/React.createElement("span", {
        style: {
          display: 'inline-flex',
          alignItems: 'center',
          justifyContent: 'center',
          width: 22,
          height: 22,
          borderRadius: 5,
          background: ct > 0 ? 'var(--green-dim)' : 'var(--bg-3)',
          color: ct > 0 ? 'var(--green)' : 'var(--tx-3)',
          fontSize: 12,
          fontWeight: 700
        }
      }, ct);
    }
    if (k === 'transferable') {
      return row.transferable ? /*#__PURE__*/React.createElement("span", {
        className: "tag tag-teal",
        style: {
          fontSize: 9
        }
      }, "Transferable") : /*#__PURE__*/React.createElement("span", {
        className: "tag tag-red",
        style: {
          fontSize: 9
        }
      }, "Locked");
    }
    if (k === 'needs' && row.needs) {
      return row.needs.length > 0 ? row.needs.map(n => /*#__PURE__*/React.createElement("span", {
        key: n,
        className: 'tag ' + (DT_NEED_COLORS[n] || 'tag-purple'),
        style: {
          fontSize: 9,
          marginRight: 2
        }
      }, n)) : /*#__PURE__*/React.createElement("span", {
        style: {
          color: 'var(--tx-3)',
          fontSize: 12
        }
      }, "\u2014");
    }
    // Field columns
    if (col.isField && row.fields && row.fields[k]) {
      const f = row.fields[k];
      if (f.disclosed === false) return /*#__PURE__*/React.createElement("span", {
        className: "dt-locked"
      }, /*#__PURE__*/React.createElement(DtLock, null), " not disclosed");
      return /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 13
        }
      }, f.value || '—');
    }
    return /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 12
      }
    }, "\u2014");
  };
  const selectedInd = selectedRow ? individuals.find(r => r.id === selectedRow) : null;

  // Combine notes for selected individual
  const allNotes = [...(bridgeNotes[selectedRow] || []).map(n => ({
    ...n,
    type: 'shared'
  })), ...(rosterNotes || []).filter(n => n.indId === selectedRow).map(n => ({
    ...n,
    type: 'internal'
  }))];
  return /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 1200,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, T.provider_term, " Dashboard"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 2
    }
  }, "Each row is an encrypted bridge room. Click to view fields, notes, and allocations.")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onDiscover,
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, "Find ", T?.client_term || 'Individual'))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(160px,1fr))',
      gap: 10,
      marginBottom: 20
    }
  }, [{
    l: 'Active Cases',
    v: cases.length,
    c: 'gold'
  }, {
    l: T.staff_term_plural,
    v: staff.length,
    c: 'blue'
  }, {
    l: 'Access Model',
    v: `${T.client_term}-granted`,
    c: 'teal'
  }, {
    l: 'Fields Shared',
    v: cases.reduce((s, c) => s + Object.keys(c.sharedData || {}).length, 0),
    c: 'green'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: 12
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      display: 'block',
      marginTop: 2
    }
  }, s.v)))), /*#__PURE__*/React.createElement(DataTable, {
    data: individuals,
    columns: IND_COLS,
    groupOptions: IND_GROUPS,
    defaultVisibleCols: defaultVisCols,
    onRowClick: row => {
      setSelectedRow(row.id);
      setPanelTab('fields');
      setProvenanceField(null);
    },
    renderCell: renderIndCell,
    getVal: getIndVal,
    selectedId: selectedRow,
    label: "individuals"
  }), selectedInd && /*#__PURE__*/React.createElement(IndividualPanel, {
    row: selectedInd,
    notes: allNotes,
    allocations: allAllocations || [],
    onClose: () => setSelectedRow(null),
    panelTab: panelTab,
    setPanelTab: setPanelTab,
    provenanceField: provenanceField,
    setProvenanceField: setProvenanceField,
    svc: svc,
    onRestoreField: null
  }));
};

/* ─── ResourcesTableView — replaces old card-based resource view ─── */
const ResourcesTableView = ({
  resourceTypes,
  resourceRelations,
  resourceInventory,
  T,
  svc,
  orgRole,
  orgRoom,
  rosterRoom,
  networkRoom,
  allAllocations,
  onCreateResource,
  onRefresh,
  onRestock,
  onEstablishRelation,
  canViewResource,
  canControlResource,
  canAllocateResource,
  individuals
}) => {
  const [selectedRow, setSelectedRow] = useState(null);
  const [panelTab, setPanelTab] = useState('details');

  // Build resource rows
  const resources = resourceTypes.filter(rt => canViewResource(rt, svc.userId, orgRole)).map(rt => {
    const relation = resourceRelations.find(rel => rel.resource_type_id === rt.id);
    const inv = relation ? resourceInventory[relation.id] : null;
    const total = inv ? inv.total_capacity || inv.capacity || 0 : 0;
    const allocated = inv ? inv.allocated || 0 : 0;
    const reserved = inv ? inv.reserved || 0 : 0;
    const available = total - allocated - reserved;
    const utilPct = total > 0 ? (allocated + reserved) / total : 0;
    return {
      id: rt.id,
      name: rt.name,
      type: rt.category,
      category: rt.category,
      holder: rt._sourceRoom ? 'Organization' : 'Personal',
      holderType: rt._source || 'org',
      relation: relation ? relation.relation_type || 'operates' : '—',
      network: rt._source === 'network' ? 'Network' : '—',
      totalCapacity: total,
      available: Math.max(0, available),
      allocated,
      reserved,
      utilizationPct: utilPct,
      lastUpdated: inv?.last_updated || rt.created,
      opacityLevel: relation?.opacity !== undefined ? ['sovereign', 'attested', 'contributed', 'published'][relation.opacity] || 'sovereign' : 'sovereign',
      governance: rt.constraints?.join(', ') || '—',
      constraints: rt.constraints || [],
      orgRoom: rt._sourceRoom || orgRoom,
      provisioningEvents: inv?.events || [],
      unit: rt.unit,
      infinite: rt.infinite || false,
      replenishes: rt.replenishes || false,
      replenish_cycle: rt.replenish_cycle || null,
      _rt: rt,
      _relation: relation,
      _inv: inv
    };
  });
  const RES_COLS = [{
    key: 'name',
    label: 'Resource',
    fixed: true
  }, {
    key: 'category',
    label: 'Category'
  }, {
    key: 'supply',
    label: 'Supply'
  }, {
    key: 'holder',
    label: 'Source'
  }, {
    key: 'relation',
    label: 'Relation'
  }, {
    key: 'capacity',
    label: 'Capacity'
  }, {
    key: 'utilization',
    label: 'Utilization'
  }, {
    key: 'opacityLevel',
    label: 'Opacity'
  }, {
    key: 'unit',
    label: 'Unit'
  }];
  const RES_GROUPS = [{
    k: 'none',
    l: 'No grouping'
  }, {
    k: 'category',
    l: 'Category'
  }, {
    k: 'holder',
    l: 'Source'
  }, {
    k: 'relation',
    l: 'Relation'
  }, {
    k: 'opacityLevel',
    l: 'Opacity'
  }];
  const defaultVisCols = ['name', 'category', 'supply', 'holder', 'capacity', 'utilization', 'opacityLevel'];
  const getResVal = (row, key) => {
    if (key === 'capacity') return row.infinite ? 999999 : row.available;
    if (key === 'utilization') return row.utilizationPct;
    if (key === 'supply') return row.infinite ? 'infinite' : row.replenishes ? 'replenishes' : 'finite';
    return row[key] || '';
  };
  const renderResCell = (row, col) => {
    const k = col.key;
    if (k === 'name') return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      style: {
        fontWeight: 600,
        fontSize: 13
      }
    }, row.name), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 11,
        color: 'var(--tx-2)'
      }
    }, (row.type || '').replace(/_/g, ' ')));
    if (k === 'category') return /*#__PURE__*/React.createElement("span", {
      className: 'tag tag-' + (RESOURCE_CATEGORY_COLORS[row.category] || 'teal'),
      style: {
        fontSize: 10
      }
    }, RESOURCE_CATEGORY_LABELS[row.category] || row.category);
    if (k === 'holder') return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 13,
        fontWeight: 500
      }
    }, row.holder), /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 11,
        color: 'var(--tx-2)'
      }
    }, row.holderType));
    if (k === 'relation') return /*#__PURE__*/React.createElement("span", {
      className: "tag tag-gold",
      style: {
        fontSize: 10
      }
    }, row.relation);
    if (k === 'network') return /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        color: 'var(--tx-1)'
      }
    }, row.network);
    if (k === 'supply') {
      const badges = [];
      if (row.infinite) badges.push(/*#__PURE__*/React.createElement("span", { key: "inf", className: "tag tag-teal", style: { fontSize: 10 } }, "\u221E Infinite"));
      if (row.replenishes) badges.push(/*#__PURE__*/React.createElement("span", { key: "rep", className: "tag tag-blue", style: { fontSize: 10 } }, "\u21BB ", row.replenish_cycle || 'auto'));
      if (!row.infinite && !row.replenishes) badges.push(/*#__PURE__*/React.createElement("span", { key: "fin", style: { fontSize: 11, color: 'var(--tx-2)' } }, "Finite"));
      return /*#__PURE__*/React.createElement("div", { style: { display: 'flex', gap: 4, flexWrap: 'wrap' } }, badges);
    }
    if (k === 'capacity') return row.infinite ? /*#__PURE__*/React.createElement("span", {
      style: {
        fontWeight: 600,
        fontSize: 13,
        color: 'var(--teal)'
      }
    }, "Unlimited") : /*#__PURE__*/React.createElement("div", {
      style: {
        fontSize: 13
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontWeight: 600,
        color: 'var(--green)'
      }
    }, row.available), /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--tx-2)'
      }
    }, " / ", row.totalCapacity), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11,
        color: 'var(--tx-3)',
        marginLeft: 4
      }
    }, "avail"));
    if (k === 'utilization') return /*#__PURE__*/React.createElement(DtUtilBar, {
      pct: row.utilizationPct
    });
    if (k === 'opacityLevel') {
      const o = DT_OP_CFG[row.opacityLevel];
      return o ? /*#__PURE__*/React.createElement("span", {
        className: 'tag ' + o.cls,
        style: {
          fontSize: 10
        }
      }, o.l) : /*#__PURE__*/React.createElement("span", {
        style: {
          color: 'var(--tx-3)'
        }
      }, "\u2014");
    }
    if (k === 'unit') return /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        color: 'var(--tx-1)',
        fontFamily: 'var(--mono)'
      }
    }, row.unit);
    return /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 12
      }
    }, "\u2014");
  };
  const selectedRes = selectedRow ? resources.find(r => r.id === selectedRow) : null;
  return /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 1200,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "Resources"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 2
    }
  }, "Resource types, inventory tracking, and allocation history. Click a row for details."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: orgRoom || rosterRoom,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Resources",
    extra: [{ label: 'Storage', value: 'Resource type definitions are stored as state events in the org/roster/network room. Inventory and allocations are tracked in org room state. Per-client allocations are mirrored in bridge rooms.' }, orgRoom ? { label: 'Org room', value: orgRoom } : null, networkRoom ? { label: 'Network room', value: networkRoom } : null].filter(Boolean)
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onRefresh,
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, "Refresh"), (orgRoom || networkRoom || rosterRoom) && /*#__PURE__*/React.createElement("button", {
    onClick: onCreateResource,
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, "New Resource Type"))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(160px,1fr))',
      gap: 10,
      marginBottom: 20
    }
  }, [{
    l: 'Visible Types',
    v: resources.length,
    c: 'teal'
  }, {
    l: 'With Inventory',
    v: resources.filter(r => r.totalCapacity > 0 || r.infinite).length,
    c: 'green'
  }, {
    l: 'Relations',
    v: resourceRelations.length,
    c: 'blue'
  }, {
    l: 'Categories',
    v: [...new Set(resources.map(r => r.category))].length,
    c: 'gold'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: 12
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      display: 'block',
      marginTop: 2
    }
  }, s.v)))), resources.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '40px 20px'
    }
  }, /*#__PURE__*/React.createElement("h3", {
    style: {
      fontSize: 16,
      fontWeight: 700,
      marginBottom: 8
    }
  }, "No Resource Types Yet"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6,
      marginBottom: 16
    }
  }, "Resource types define the services and goods you can track and allocate."), (orgRoom || networkRoom || rosterRoom) && /*#__PURE__*/React.createElement("button", {
    onClick: onCreateResource,
    className: "b-pri"
  }, "Create Resource Type")) : /*#__PURE__*/React.createElement(DataTable, {
    data: resources,
    columns: RES_COLS,
    groupOptions: RES_GROUPS,
    defaultVisibleCols: defaultVisCols,
    onRowClick: row => {
      setSelectedRow(row.id);
      setPanelTab('details');
    },
    renderCell: renderResCell,
    getVal: getResVal,
    selectedId: selectedRow,
    label: "resources"
  }), selectedRes && /*#__PURE__*/React.createElement(ResourcePanel, {
    row: selectedRes,
    allocations: allAllocations || [],
    onClose: () => setSelectedRow(null),
    panelTab: panelTab,
    setPanelTab: setPanelTab
  }));
};

/* ═══════════════════ PROVIDER APP ═══════════════════ */
const ProviderApp = ({
  session,
  onLogout,
  showToast,
  availableContexts,
  activeMode,
  onSwitchContext
}) => {
  const { theme: appTheme } = useTheme();
  const isLightTheme = appTheme === 'light';
  const [rosterRoom, setRosterRoom] = useState(null);
  const [metricsRoom, setMetricsRoom] = useState(null);
  const [schemaRoom, setSchemaRoom] = useState(null);
  const [networkRoom, setNetworkRoom] = useState(null);
  const [cases, setCases] = useState([]);
  const [networkMembers, setNetworkMembers] = useState([]);
  const [activeCase, setActiveCase] = useState(null);
  const [view, setView] = useState('dashboard'); // dashboard|inbox|case|schema|resources|network|activity|staff|org-settings|org-inbox
  const [loading, setLoading] = useState(true);
  const [messages, setMessages] = useState([]);
  const [msgText, setMsgText] = useState('');
  const [requestText, setRequestText] = useState('');
  const [discoverModal, setDiscoverModal] = useState(false);
  const [discoverUserId, setDiscoverUserId] = useState('');
  const [networkModal, setNetworkModal] = useState(false);
  const [networkName, setNetworkName] = useState('');
  const [joinNetworkModal, setJoinNetworkModal] = useState(false);
  const [joinNetworkId, setJoinNetworkId] = useState('');
  const [provObsModal, setProvObsModal] = useState(null);
  const [provObsValue, setProvObsValue] = useState('');
  const [provObsNotes, setProvObsNotes] = useState('');
  const [provObservations, setProvObservations] = useState([]);
  const [provenanceTarget, setProvenanceTarget] = useState(null); // {entityKey, label, roomId} or null
  const [initError, setInitError] = useState(null);
  // Organization context — orgs are a feature within the provider experience
  const [orgRoom, setOrgRoom] = useState(null);
  const [orgMeta, setOrgMeta] = useState({});
  const [staff, setStaff] = useState([]);
  const [orgRole, setOrgRole] = useState(null); // null = no org, 'admin', 'case_manager', etc.
  const [allOrgs, setAllOrgs] = useState([]); // multi-org: all orgs user belongs to [{roomId, role, meta, roster, ...}]
  const [createOrgModal, setCreateOrgModal] = useState(false);
  const [joinOrgModal, setJoinOrgModal] = useState(false);
  const [joinOrgId, setJoinOrgId] = useState('');
  const [setupData, setSetupData] = useState({
    name: '',
    type: 'direct_service',
    service_area: '',
    languages: 'en'
  });
  const [inviteModal, setInviteModal] = useState(false);
  const [inviteUserId, setInviteUserId] = useState('');
  const [inviteRole, setInviteRole] = useState('case_manager');
  // Case assignments — tracks which staff are assigned to which bridges within the org
  const [caseAssignments, setCaseAssignments] = useState({}); // { [bridgeRoomId]: { primary, staff:[], client_name, transferable } }
  // Trash bin — soft-deleted individuals: { [roomId]: { deletedBy, deletedAt, name } }
  const [trashedIndividuals, setTrashedIndividuals] = useState({});
  const [transferModal, setTransferModal] = useState(null); // case object to transfer
  const [transferTarget, setTransferTarget] = useState(''); // staff user ID to transfer to
  // Client records — provider-created rooms representing clients
  const [clientRecords, setClientRecords] = useState([]);
  const [createClientModal, setCreateClientModal] = useState(false);
  const openCreateClientModal = () => {
    if (!activeTeamContext) {
      if (showToast) showToast('Switch to a team context to create individual records. Select a team in the sidebar, or create one in the Teams view.', 'info');
      setView('teams');
      return;
    }
    setCreateClientModal(true);
    setNewClientName('');
    setNewClientMatrixId('');
    setNewClientNotes('');
  };
  const [clientInviteModal, setClientInviteModal] = useState(null); // client record object or null
  const [newClientName, setNewClientName] = useState('');
  const [newClientMatrixId, setNewClientMatrixId] = useState('');
  const [newClientNotes, setNewClientNotes] = useState('');
  const [clientInviteMatrixId, setClientInviteMatrixId] = useState('');
  const [copiedField, setCopiedField] = useState(null);
  // Teams — flexible groups of people (not tied to a single org)
  const [teams, setTeams] = useState([]);
  const [createTeamModal, setCreateTeamModal] = useState(false);
  const [newTeamName, setNewTeamName] = useState('');
  const [newTeamDesc, setNewTeamDesc] = useState('');
  const [newTeamParentId, setNewTeamParentId] = useState('');     // parent team selection
  const [newTeamGovernance, setNewTeamGovernance] = useState('lead_decides');  // governance mode
  // Custom table creation modal
  const [createTableModal, setCreateTableModal] = useState(null); // null | { teamId, teamName }
  const [activeCustomTable, setActiveCustomTable] = useState(null); // null | { table, teamId }
  const [teamInviteModal, setTeamInviteModal] = useState(null); // team object or null
  const [teamInviteUserId, setTeamInviteUserId] = useState('');
  const [activeTeamDetail, setActiveTeamDetail] = useState(null); // expanded team detail view
  // ─── Active team context (workspace-level team scope) ───
  const [activeTeamContext, setActiveTeamContext] = useState(() => {
    try { return localStorage.getItem('khora_active_team') || null; } catch { return null; }
  });
  const activeTeamObj = useMemo(
    () => activeTeamContext ? teams.find(t => t.roomId === activeTeamContext) || null : null,
    [activeTeamContext, teams]
  );
  const activeTeamMemberIds = useMemo(
    () => activeTeamObj ? (activeTeamObj.members || []).map(m => m.userId) : [],
    [activeTeamObj]
  );
  // Filtered views when team context is active
  const teamFilteredCases = useMemo(
    () => activeTeamObj ? cases.filter(c => { const a = caseAssignments[c.bridgeRoomId]; return activeTeamMemberIds.includes(a?.primary || c.meta?.provider); }) : cases,
    [activeTeamObj, cases, caseAssignments, activeTeamMemberIds]
  );
  const switchTeamContext = React.useCallback((teamRoomId) => {
    setActiveTeamContext(teamRoomId);
    try {
      if (teamRoomId) localStorage.setItem('khora_active_team', teamRoomId);
      else localStorage.removeItem('khora_active_team');
    } catch {}
    if (teamRoomId) {
      const t = teams.find(t => t.roomId === teamRoomId);
      if (t) {
        setTeamMode({ roomId: t.roomId, name: t.name, color_hue: t.color_hue });
        setActiveTeamDetail(t);
      }
    } else {
      setTeamMode(null);
      setActiveTeamDetail(null);
    }
  }, [teams]);
  // Expose switchTeamContext globally so DatabaseView team picker can call it
  React.useEffect(() => { window.__khoraSwitchTeam = switchTeamContext; return () => { delete window.__khoraSwitchTeam; }; }, [switchTeamContext]);
  const [teamMode, setTeamMode] = useState(null); // null = individual mode, { roomId, name, color_hue } = operating as team
  // ─── Sidebar collapse state ───
  const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
    try { return localStorage.getItem('khora_sidebar_collapsed') === 'true'; } catch { return false; }
  });
  const toggleSidebar = React.useCallback(() => {
    setSidebarCollapsed(prev => {
      const next = !prev;
      try { localStorage.setItem('khora_sidebar_collapsed', String(next)); } catch {}
      return next;
    });
  }, []);
  // ─── Linked records state ───
  const [linkedRecords, setLinkedRecords] = useState({}); // { [parentRecordId]: [{id, linked_record_id, record_type, label, created_by, created_at, governance}] }
  const [createLinkedRecordModal, setCreateLinkedRecordModal] = useState(null); // {parentRecord} or null
  // Field definitions & crosswalks
  const [fieldDefs, setFieldDefs] = useState({}); // uri → definition object
  const [fieldCrosswalks, setFieldCrosswalks] = useState([]); // crosswalk records
  const [fieldGovernanceConfig, setFieldGovernanceConfig] = useState({}); // {governance_required: bool}
  const [sharingConsentModal, setSharingConsentModal] = useState(null); // {team, member} or null — prompts team member to choose sharing preference
  // Client data import
  const [importModal, setImportModal] = useState(false);
  // Database merge (auditable SYN)
  const [dbMergeModal, setDbMergeModal] = useState(false);
  const [dbMergeRecordA, setDbMergeRecordA] = useState(null);
  const [dbMergeRecordB, setDbMergeRecordB] = useState(null);
  // ─── Database / Notes / Profile state ───
  const [dbNotes, setDbNotes] = useState([]); // all notes across roster + bridges
  const [newNoteModal, setNewNoteModal] = useState(false);
  const [newNoteAttachTo, setNewNoteAttachTo] = useState(null); // pre-fill attach for profile page
  const [noteDetailModal, setNoteDetailModal] = useState(null); // note object for detail view
  const [activeIndividual, setActiveIndividual] = useState(null); // individual row for profile page
  const [activeResourceProfile, setActiveResourceProfile] = useState(null); // resource row for profile page
  const cellEditTimerRef = useRef({}); // debounce timers for cell edits
  const isMobile = useIsMobile();
  // Memoized team colors list for badge rendering
  const teamColorsList = useMemo(() => teams.map(t => ({ name: t.name, color_hue: t.color_hue })), [teams]);
  // Provider profile — self-reported identity info
  const [providerProfile, setProviderProfile] = useState({});
  const [profileModal, setProfileModal] = useState(false);
  const [profileDraft, setProfileDraft] = useState({
    display_name: '',
    title: '',
    credentials: '',
    bio: '',
    service_types: ''
  });
  // Contact sharing state
  const [shareContactModal, setShareContactModal] = useState(false);
  const [shareAsOrg, setShareAsOrg] = useState(false);
  // Email verification state
  const [emailVerifyConfig, setEmailVerifyConfig] = useState(EmailVerification.defaultConfig());
  const [emailVerifyModal, setEmailVerifyModal] = useState(false);
  const [verifyEmail, setVerifyEmail] = useState('');
  const [verifyCode, setVerifyCode] = useState('');
  const [verifyStep, setVerifyStep] = useState('email'); // 'email' | 'code' | 'done'
  const [verifyError, setVerifyError] = useState('');
  const [verifyPending, setVerifyPending] = useState(false);
  const [myVerification, setMyVerification] = useState(null); // current user's verification status
  const [emailConfigDraft, setEmailConfigDraft] = useState(EmailVerification.defaultConfig());
  const [emailConfigModal, setEmailConfigModal] = useState(false);
  // ─── Inter-org messaging & opacity ───
  const [orgOpacity, setOrgOpacity] = useState('translucent'); // transparent|translucent|opaque
  const [orgMsgAccess, setOrgMsgAccess] = useState({
    read: ['admin', 'case_manager'],
    respond: ['admin']
  });
  const [orgChannels, setOrgChannels] = useState([]); // [{roomId, peerOrg:{name,roomId}, lastMessage, unread}]
  const [activeChannel, setActiveChannel] = useState(null);
  const [channelMessages, setChannelMessages] = useState([]);
  const [orgMsgText, setOrgMsgText] = useState('');
  const [composeOrgModal, setComposeOrgModal] = useState(false);
  const [composePeerOrgId, setComposePeerOrgId] = useState('');
  const [composePeerOrgName, setComposePeerOrgName] = useState('');
  const [msgAccessModal, setMsgAccessModal] = useState(false);
  const [msgAccessDraft, setMsgAccessDraft] = useState({
    read: [],
    respond: []
  });
  // ─── Org terminology customization ───
  const [orgTerminology, setOrgTerminology] = useState({
    ...TERMINOLOGY_DEFAULTS
  });
  const [terminologyDraft, setTerminologyDraft] = useState({
    ...TERMINOLOGY_DEFAULTS
  });
  const [terminologyModal, setTerminologyModal] = useState(false);
  // Convenience accessors for the active terminology
  const T = orgTerminology; // T.client_term, T.client_term_plural, T.provider_term, T.provider_term_plural, T.staff_term, T.staff_term_plural
  // ─── Org custom roles ───
  const [orgRolesConfig, setOrgRolesConfig] = useState(DOMAIN_CONFIG.defaultOrgRoles);
  const [editingRole, setEditingRole] = useState(null); // {key, label, description} being edited
  const [addRoleModal, setAddRoleModal] = useState(false);
  const [newRoleDraft, setNewRoleDraft] = useState({ label: '', description: '' });
  // Derived role accessors — used in place of static ORG_ROLES / ORG_ROLE_LABELS
  const activeOrgRoles = orgRolesConfig.map(r => r.key);
  const activeOrgRoleLabels = Object.fromEntries(orgRolesConfig.map(r => [r.key, r.label]));
  const activeOrgRoleDescs = Object.fromEntries(orgRolesConfig.map(r => [r.key, r.description]));
  // ─── Inbox chat state ───
  const [inboxConvo, setInboxConvo] = useState(null); // room ID of active inbox conversation
  const [inboxMessages, setInboxMessages] = useState([]);
  const [inboxMsgText, setInboxMsgText] = useState('');
  const [inboxTab, setInboxTab] = useState('direct'); // kept for compat
  const [msgBuckets, setMsgBuckets] = useState(() => { try { return JSON.parse(localStorage.getItem('khora_msg_buckets') || '[]'); } catch { return []; } }); // [{id,label,roomIds:[]}]
  const [newBucketModal, setNewBucketModal] = useState(false);
  const [newBucketDraft, setNewBucketDraft] = useState('');
  const [assignBucketTarget, setAssignBucketTarget] = useState(null); // roomId being assigned to a group
  // ─── Team member DM state ───
  const [teamDMs, setTeamDMs] = useState([]); // [{roomId, peerId, peerName, teamName, teamRoomId}]
  const [teamDMMessages, setTeamDMMessages] = useState([]);
  const [teamDMMsgText, setTeamDMMsgText] = useState('');
  const [newTeamDMModal, setNewTeamDMModal] = useState(false);
  const [newDMTarget, setNewDMTarget] = useState(null); // {userId, displayName, teamName}
  const teamFilteredTeamDMs = useMemo(
    () => activeTeamObj ? teamDMs.filter(dm => activeTeamMemberIds.includes(dm.peerId)) : teamDMs,
    [activeTeamObj, teamDMs, activeTeamMemberIds]
  );
  // ─── Unified inbox grouping (by team, then custom buckets) ───
  const inboxGrouped = useMemo(() => {
    const bucketIds = new Set(msgBuckets.flatMap(b => b.roomIds));
    const allCases = activeTeamObj ? cases.filter(c => { const a = caseAssignments[c.bridgeRoomId]; return activeTeamMemberIds.includes(a?.primary || c.meta?.provider); }) : cases;
    const allDMs = activeTeamObj ? teamDMs.filter(dm => activeTeamMemberIds.includes(dm.peerId)) : teamDMs;
    const allCh = orgChannels;
    const toC = (type, id, data) => ({ type, id, data });
    const bucketSections = msgBuckets.map(b => ({ id: b.id, label: b.label, isCustom: true, convos: b.roomIds.map(rid => { const c = allCases.find(x => x.bridgeRoomId === rid); if (c) return toC('case', rid, c); const ch = allCh.find(x => x.roomId === rid); if (ch) return toC('channel', rid, ch); const dm = allDMs.find(x => x.roomId === rid); if (dm) return toC('team_dm', rid, dm); return null; }).filter(Boolean) })).filter(s => s.convos.length > 0);
    const teamSections = teams.map(team => { const mids = new Set((team.members || []).map(m => m.userId)); const convos = [...allCases.filter(c => { if (bucketIds.has(c.bridgeRoomId)) return false; const a = caseAssignments[c.bridgeRoomId]; return mids.has(a?.primary) || mids.has(c.meta?.provider); }).map(c => toC('case', c.bridgeRoomId, c)), ...allDMs.filter(dm => !bucketIds.has(dm.roomId) && dm.teamRoomId === team.roomId).map(dm => toC('team_dm', dm.roomId, dm))]; return { id: team.roomId, label: team.name, team, convos }; }).filter(s => s.convos.length > 0);
    const assignedIds = new Set([...bucketSections, ...teamSections].flatMap(s => s.convos.map(c => c.id)));
    const otherConvos = [...allCases.filter(c => !assignedIds.has(c.bridgeRoomId) && !bucketIds.has(c.bridgeRoomId)).map(c => toC('case', c.bridgeRoomId, c)), ...allCh.filter(ch => !assignedIds.has(ch.roomId) && !bucketIds.has(ch.roomId)).map(ch => toC('channel', ch.roomId, ch)), ...allDMs.filter(dm => !assignedIds.has(dm.roomId) && !bucketIds.has(dm.roomId)).map(dm => toC('team_dm', dm.roomId, dm))];
    return { bucketSections, teamSections, otherConvos };
  }, [cases, orgChannels, teamDMs, teams, caseAssignments, activeTeamObj, activeTeamMemberIds, msgBuckets]);
  // ─── Notifications state ───
  const [notifications, setNotifications] = useState([]);
  // ─── Resource tracking state ───
  const [resourceTypes, setResourceTypes] = useState([]); // catalog of resource types (from org/network room)
  const [resourceRelations, setResourceRelations] = useState([]); // org's relations to resource types
  const [resourceInventory, setResourceInventory] = useState({}); // { [relationId]: inventory object }
  const [createResourceModal, setCreateResourceModal] = useState(false);
  const [resourceDraft, setResourceDraft] = useState({
    name: '',
    category: 'general',
    unit: 'unit',
    fungible: true,
    perishable: false,
    ttl_days: '',
    tags: '',
    infinite: false,
    initial_quantity: '',
    replenishes: false,
    replenish_cycle: '',
    permissions: buildDefaultResourcePermissions()
  });
  // ─── Resource permission management state ───
  const [permModal, setPermModal] = useState(null); // resource type object or null
  const [permDraft, setPermDraft] = useState({
    controllers: [],
    allocators: [],
    viewers: []
  });
  const [permGrantType, setPermGrantType] = useState('role'); // 'role' or 'user'
  const [permGrantId, setPermGrantId] = useState('');
  const [permGrantAbility, setPermGrantAbility] = useState('controllers');
  // ─── Resource allocation state (case-level) ───
  const [allocModal, setAllocModal] = useState(false);
  const [allocDraft, setAllocDraft] = useState({
    resource_type_id: '',
    quantity: 1,
    notes: ''
  });
  const [caseAllocations, setCaseAllocations] = useState([]); // allocations for active case
  // ─── Inventory management state ───
  const [restockModal, setRestockModal] = useState(null); // relation object or null
  const [restockQty, setRestockQty] = useState('');
  const [restockNote, setRestockNote] = useState('');
  // ─── Data table state ───
  const [bridgeNotes, setBridgeNotes] = useState({}); // {bridgeRoomId: notes[]}
  const [rosterNotes, setRosterNotes] = useState([]); // internal notes from roster
  const [allAllocations, setAllAllocations] = useState([]); // all allocations across cases

  // ─── Multi-org switching ───
  const switchOrg = React.useCallback(async (targetRoomId) => {
    const target = allOrgs.find(o => o.roomId === targetRoomId);
    if (!target || target.roomId === orgRoom) return;
    setOrgRoom(target.roomId);
    setOrgRole(target.role);
    setOrgMeta(target.meta || {});
    setStaff(target.roster?.staff || []);
    try { localStorage.setItem('khora_active_org', target.roomId); } catch {}
    // Reload org-specific settings from cached scan data
    if (target.opacity) setOrgOpacity(target.opacity.level || 'translucent');
    if (target.msgAccess) setOrgMsgAccess(target.msgAccess);
    if (target.terminology) {
      const t = { ...TERMINOLOGY_DEFAULTS, ...target.terminology };
      setOrgTerminology(t);
      setTerminologyDraft(t);
    }
    // Reload email verification config from Matrix state
    try {
      const evConfig = await svc.getState(target.roomId, EVT.ORG_EMAIL_CONFIG).catch(() => null);
      if (evConfig) { setEmailVerifyConfig(evConfig); setEmailConfigDraft(evConfig); }
      const myStaff = target.roster?.staff?.find(s => s.userId === svc.userId);
      if (myStaff?.email_verification) setMyVerification(myStaff.email_verification);
    } catch {}
    // Reload case assignments
    try {
      const assignments = await svc.getState(target.roomId, EVT.ROSTER_ASSIGN);
      if (assignments?.assignments) setCaseAssignments(assignments.assignments);
      else setCaseAssignments({});
    } catch {}
    // Reload trash bin
    try {
      const trashState = await svc.getState(target.roomId, EVT.ORG_TRASH);
      setTrashedIndividuals(trashState || {});
    } catch { setTrashedIndividuals({}); }
    // Reload org channels for the new org
    try {
      const scanned = await svc.scanRooms([EVT.ORG_MSG_CHANNEL]);
      const newChannels = [];
      for (const [rid, state] of Object.entries(scanned)) {
        const chanMeta = state[EVT.ORG_MSG_CHANNEL];
        if (chanMeta && chanMeta.type === 'org_msg_channel') {
          newChannels.push({ roomId: rid, ...chanMeta });
        }
      }
      setOrgChannels(newChannels);
    } catch {}
    // Reset active channel when switching orgs
    setActiveChannel(null);
    setChannelMessages([]);
  }, [allOrgs, orgRoom]);

  // ─── Team mode switching ───
  const switchTeam = React.useCallback((targetRoomId) => {
    if (!targetRoomId) {
      setTeamMode(null);
      setActiveTeamContext(null);
      try { localStorage.removeItem('khora_active_team'); } catch {}
      return;
    }
    const target = teams.find(t => t.roomId === targetRoomId);
    if (!target) return;
    const mode = { roomId: target.roomId, name: target.name, color_hue: target.color_hue };
    setTeamMode(mode);
    setActiveTeamContext(target.roomId);
    try { localStorage.setItem('khora_active_team', target.roomId); } catch {}
  }, [teams]);

  // Helper: active context for tagging actions with team/org
  const activeContext = () => ({
    ...(teamMode ? { team_id: teamMode.roomId, team_name: teamMode.name } : {}),
    ...(orgRoom ? { org_id: orgRoom, org_name: orgMeta.name } : {})
  });

  // Notification helpers
  const addNotification = notif => {
    setNotifications(prev => [{
      ...notif,
      id: `notif_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`,
      read: false,
      timestamp: Date.now()
    }, ...prev].slice(0, 50));
  };
  const handleNotifClick = notif => {
    setNotifications(prev => prev.map(n => n.id === notif.id ? {
      ...n,
      read: true
    } : n));
    // Navigate based on notification type
    if (notif.type === 'schema_update' || notif.type === 'schema_new') {
      setView('schema');
      setActiveCase(null);
    } else if (notif.type === 'message' && notif.targetView) {
      setView(notif.targetView);
      setActiveCase(null);
    } else if (notif.type === 'org_event') {
      setView('org-settings');
      setActiveCase(null);
    }
  };
  const handleDismissAllNotifs = () => {
    setNotifications(prev => prev.map(n => ({
      ...n,
      read: true
    })));
  };
  useEffect(() => {
    initProvider();
  }, []);

  // ─── Real-time notification generation from Khora events ───
  useEffect(() => {
    const handleTimelineNotif = e => {
      const d = e.detail;
      if (!d || d.isOwn) return; // don't notify for own actions
      const type = d.type;
      if (type === EVT.OP) {
        const op = d.content?.op;
        const targetPath = d.content?.target || '';
        addNotification({
          type: 'data_change',
          title: `${op || 'EO'} operation: ${targetPath}`,
          description: `${d.sender?.split(':')[0]?.slice(1) || 'Someone'} performed ${op} on ${targetPath}`
        });
      } else if (type === EVT.OBSERVATION) {
        addNotification({
          type: 'data_change',
          title: 'New observation recorded',
          description: `${d.sender?.split(':')[0]?.slice(1) || 'Someone'} recorded: ${d.content?.prompt_key || 'observation'}`
        });
      } else if (type === EVT.NOTE) {
        addNotification({
          type: 'data_change',
          title: 'New note created',
          description: d.content?.title || 'Untitled note'
        });
      } else if (type === EVT.NOTE_EDIT) {
        addNotification({
          type: 'data_change',
          title: 'Note edited',
          description: (d.content?.title || 'Untitled') + ' edited by ' + (d.sender?.split(':')[0]?.slice(1) || 'someone')
        });
      }
    };
    const handleStateNotif = e => {
      const d = e.detail;
      if (!d || d.isOwn) return;
      const type = d.type;
      if (type === EVT.SCHEMA_FORM || type === EVT.SCHEMA_FIELD) {
        addNotification({
          type: 'schema_update',
          title: 'Schema updated',
          description: d.content?.name || d.content?.question_text || 'Form definition changed'
        });
      } else if (type === EVT.ORG_ROSTER) {
        addNotification({
          type: 'org_event',
          title: 'Organization roster updated',
          description: `${(d.content?.staff || []).length} staff members`
        });
      } else if (type === EVT.BRIDGE_META) {
        addNotification({
          type: 'data_change',
          title: 'Bridge updated',
          description: `Status: ${d.content?.status || 'unknown'}`
        });
      } else if (type === EVT.RESOURCE_TYPE || type === EVT.RESOURCE_RELATION || type === EVT.RESOURCE_INVENTORY) {
        loadResources(orgRoom, networkRoom, rosterRoom);
      }
    };
    window.addEventListener('khora:timeline', handleTimelineNotif);
    window.addEventListener('khora:state', handleStateNotif);
    return () => {
      window.removeEventListener('khora:timeline', handleTimelineNotif);
      window.removeEventListener('khora:state', handleStateNotif);
    };
  }, []);
  const rosterFrame = room => ({
    type: 'roster',
    room: room || rosterRoom,
    role: 'provider',
    epistemic: 'MEANT'
  });
  const bridgeFrame = room => ({
    type: 'bridge',
    room,
    role: 'provider',
    epistemic: 'MEANT'
  });
  const networkFrame = room => ({
    type: 'network',
    room: room || networkRoom,
    role: 'provider',
    epistemic: 'MEANT'
  });
  const orgFrame = room => ({
    type: 'org',
    room: room || orgRoom,
    role: orgRole || 'admin',
    epistemic: 'MEANT',
    ...(teamMode ? { team_id: teamMode.roomId, team_name: teamMode.name } : {})
  });
  const initProvider = async () => {
    setLoading(true);
    setInitError(null);
    try {
      // Single-pass scan: fetch all Khora state across rooms in one request
      const scanned = await svc.scanRooms([EVT.ORG_METADATA, EVT.ORG_ROSTER, EVT.PROVIDER_PROFILE, EVT.ORG_OPACITY, EVT.ORG_MSG_ACCESS, EVT.ORG_MSG_CHANNEL, EVT.ORG_TERMINOLOGY, EVT.ORG_ROLES, EVT.TEAM_META, EVT.TEAM_MEMBERS, EVT.TEAM_SCHEMA, EVT.TEAM_SCHEMA_RULE, EVT.TEAM_HIERARCHY, EVT.TEAM_TABLE_DEF, EVT.FIELD_DEF, EVT.FIELD_CROSSWALK, EVT.DM_META]);
      let roster = null,
        metricsR = null,
        schema = null,
        network = null;
      const detectedOrgs = []; // multi-org: collect all orgs user belongs to
      const bridgeData = [];
      const detectedClientRecords = [];
      const detectedOrgChannels = [];
      const detectedTeams = [];
      const detectedFieldDefs = {};
      const detectedCrosswalks = [];
      for (const [rid, state] of Object.entries(scanned)) {
        const id = state[EVT.IDENTITY];
        if (id?.account_type === 'provider' && id.owner === svc.userId) roster = rid;
        if (id?.account_type === 'metrics' && id.owner === svc.userId) metricsR = rid;
        if (id?.account_type === 'schema' && id.owner === svc.userId) schema = rid;
        if (id?.account_type === 'network') network = rid;
        // Detect client record rooms created by this provider (or claimed from this provider)
        if (id?.account_type === 'client_record' && (id.owner === svc.userId || id.previous_owner === svc.userId)) {
          detectedClientRecords.push({
            roomId: rid,
            ...id
          });
        }
        // Detect org rooms — owned or joined as staff (collect ALL orgs for multi-org support)
        if (id?.account_type === 'organization') {
          let myOrgRole = null;
          if (id.owner === svc.userId) {
            myOrgRole = 'admin';
          } else {
            const orgRoster = state[EVT.ORG_ROSTER];
            const entry = orgRoster?.staff?.find(s => s.userId === svc.userId);
            if (entry) myOrgRole = entry.role;
          }
          if (myOrgRole) {
            detectedOrgs.push({
              roomId: rid,
              role: myOrgRole,
              meta: state[EVT.ORG_METADATA] || {},
              roster: state[EVT.ORG_ROSTER],
              opacity: state[EVT.ORG_OPACITY],
              msgAccess: state[EVT.ORG_MSG_ACCESS],
              terminology: state[EVT.ORG_TERMINOLOGY],
              identity: id
            });
          }
        }
        // Detect inter-org messaging channels
        const chanMeta = state[EVT.ORG_MSG_CHANNEL];
        if (chanMeta && chanMeta.type === 'org_msg_channel') {
          detectedOrgChannels.push({
            roomId: rid,
            ...chanMeta
          });
        }
        // Detect team rooms (with schema + consent rule + hierarchy + custom tables)
        if (id?.account_type === 'team') {
          const teamMeta = state[EVT.TEAM_META] || {};
          const teamMembers = state[EVT.TEAM_MEMBERS] || {
            members: []
          };
          const teamSchema = state[EVT.TEAM_SCHEMA] || null;
          const teamSchemaRule = state[EVT.TEAM_SCHEMA_RULE] || null;
          const teamHierarchy = state[EVT.TEAM_HIERARCHY] || null;
          // Collect all TEAM_TABLE_DEF state events (keyed by stateKey = table.id)
          const teamTableDefs = [];
          const roomObj = svc.client?.getRoom(rid);
          if (roomObj) {
            const allState = roomObj.currentState?.events;
            if (allState) {
              const tableDefMap = allState.get(EVT.TEAM_TABLE_DEF);
              if (tableDefMap) {
                for (const [stateKey, evObj] of tableDefMap.entries()) {
                  const content = evObj.getContent?.() || evObj.content || {};
                  if (content.id) teamTableDefs.push(content);
                }
              }
            }
          }
          detectedTeams.push({
            roomId: rid,
            ...teamMeta,
            members: teamMembers.members || [],
            owner: id.owner,
            created: id.created,
            schema: teamSchema,
            schemaRule: teamSchemaRule,
            hierarchy: teamHierarchy,
            customTables: teamTableDefs
          });
        }
        // Collect field definitions and crosswalks from schema rooms
        if (id?.account_type === 'schema') {
          const defs = state[EVT.FIELD_DEF];
          if (defs?.definitions) Object.assign(detectedFieldDefs, defs.definitions);
          const xws = state[EVT.FIELD_CROSSWALK];
          if (xws?.crosswalks) detectedCrosswalks.push(...xws.crosswalks);
        }
        const meta = state[EVT.BRIDGE_META];
        if (meta && meta.status !== 'tombstoned') {
          // Include bridges where this user is the provider OR any org staff member is assigned
          if (meta.provider === svc.userId) {
            bridgeData.push({
              rid,
              meta,
              refs: state[EVT.BRIDGE_REFS],
              mine: true
            });
          } else if (meta.assigned_staff?.includes(svc.userId)) {
            bridgeData.push({
              rid,
              meta,
              refs: state[EVT.BRIDGE_REFS],
              mine: true
            });
          }
        }
      }
      // Multi-org: select preferred org from localStorage, or fall back to first detected
      let preferredOrgId = null;
      try { preferredOrgId = localStorage.getItem('khora_active_org'); } catch {}
      const selectedOrg = detectedOrgs.find(o => o.roomId === preferredOrgId) || detectedOrgs[0] || null;
      const detectedOrg = selectedOrg?.roomId || null;
      const detectedOrgRole = selectedOrg?.role || null;
      if (!roster) {
        roster = await svc.createRoom('[Khora Roster]', 'Provider case index', [{
          type: EVT.IDENTITY,
          state_key: '',
          content: {
            account_type: 'provider',
            owner: svc.userId,
            created: Date.now()
          }
        }, {
          type: EVT.ROSTER_INDEX,
          state_key: '',
          content: {
            cases: []
          }
        }]);
      }
      if (!metricsR) {
        metricsR = await svc.createRoom('[Khora Metrics]', 'Anonymized metrics', [{
          type: EVT.IDENTITY,
          state_key: '',
          content: {
            account_type: 'metrics',
            owner: svc.userId,
            created: Date.now()
          }
        }]);
      }
      if (!schema) {
        schema = await svc.createRoom('[Khora Schema]', 'Schema definitions', [{
          type: EVT.IDENTITY,
          state_key: '',
          content: {
            account_type: 'schema',
            owner: svc.userId,
            created: Date.now()
          }
        }]);
        const allSeeds = [
        // Forms — GIVEN data collection instruments
        ...DEFAULT_FORMS.map(f => () => svc.setState(schema, EVT.SCHEMA_FORM, f, f.id)), ...DEFAULT_PROMPTS.map(p => () => svc.setState(schema, EVT.SCHEMA_PROMPT, p, p.key)),
        // Interpretations — MEANT assessments (provider instruments)
        ...DEFAULT_PROVIDER_PROMPTS.map(pp => () => svc.setState(schema, EVT.SCHEMA_ASSESSMENT, pp, pp.key)),
        // Interpretations — classification rules and authorities
        ...DEFAULT_DEFINITIONS.map(d => () => svc.setState(schema, EVT.SCHEMA_DEF, d, d.key)), ...DEFAULT_AUTHORITIES.map(a => () => svc.setState(schema, EVT.SCHEMA_AUTHORITY, a, a.id)), [() => svc.setState(schema, EVT.SCHEMA_TRANSFORM, {
          id: 'transform_default',
          transforms: DEFAULT_TRANSFORMS
        }, 'default')]].flat();
        for (let i = 0; i < allSeeds.length; i++) {
          await allSeeds[i]();
          if (i % 3 === 2) await new Promise(r => setTimeout(r, 200));
        }
      }
      // Fallback: if metrics/schema not found by owner, check org metadata for linked room IDs
      if (detectedOrgs.length > 0) {
        const activeOrg = detectedOrgs[0];
        if (!metricsR && activeOrg.meta?.metrics_room) {
          metricsR = activeOrg.meta.metrics_room;
        }
        if (!schema && activeOrg.meta?.schema_room) {
          schema = activeOrg.meta.schema_room;
        }
      }
      setRosterRoom(roster);
      setMetricsRoom(metricsR);
      setSchemaRoom(schema);
      // Load provider profile from roster room
      const rosterState = scanned[roster];
      if (rosterState?.[EVT.PROVIDER_PROFILE]) setProviderProfile(rosterState[EVT.PROVIDER_PROFILE]);
      if (network) {
        setNetworkRoom(network);
        await loadNetworkMembers(network);
      }
      // Store all detected orgs for multi-org switching
      setAllOrgs(detectedOrgs);
      // Load org context if detected during scan
      if (detectedOrg) {
        setOrgRoom(detectedOrg);
        setOrgRole(detectedOrgRole);
        try { localStorage.setItem('khora_active_org', detectedOrg); } catch {}
        const orgState = scanned[detectedOrg];
        if (orgState?.[EVT.ORG_METADATA]) setOrgMeta(orgState[EVT.ORG_METADATA]);
        if (orgState?.[EVT.ORG_ROSTER]?.staff) setStaff(orgState[EVT.ORG_ROSTER].staff);
        // Load email verification config
        try {
          const evConfig = await svc.getState(detectedOrg, EVT.ORG_EMAIL_CONFIG).catch(() => null);
          if (evConfig) {
            setEmailVerifyConfig(evConfig);
            setEmailConfigDraft(evConfig);
          }
          // Load my verification status from roster
          const myStaff = orgState?.[EVT.ORG_ROSTER]?.staff?.find(s => s.userId === svc.userId);
          if (myStaff?.email_verification) setMyVerification(myStaff.email_verification);
        } catch (e) {
          console.warn('Email verify config load:', e.message);
        }
        // Load opacity & message access settings
        if (orgState?.[EVT.ORG_OPACITY]) setOrgOpacity(orgState[EVT.ORG_OPACITY].level || 'translucent');
        if (orgState?.[EVT.ORG_MSG_ACCESS]) setOrgMsgAccess(orgState[EVT.ORG_MSG_ACCESS]);
        // Load org terminology customization
        if (orgState?.[EVT.ORG_TERMINOLOGY]) {
          const t = {
            ...TERMINOLOGY_DEFAULTS,
            ...orgState[EVT.ORG_TERMINOLOGY]
          };
          setOrgTerminology(t);
          setTerminologyDraft(t);
        }
        // Load org custom roles
        if (orgState?.[EVT.ORG_ROLES]?.roles) {
          setOrgRolesConfig(orgState[EVT.ORG_ROLES].roles);
        }
        // Load detected org messaging channels
        if (detectedOrgChannels.length > 0) setOrgChannels(detectedOrgChannels);
        // Load case assignments from org room
        try {
          const assignments = await svc.getState(detectedOrg, EVT.ROSTER_ASSIGN);
          if (assignments?.assignments) setCaseAssignments(assignments.assignments);
        } catch (e) {
          console.warn('Assignment load:', e.message);
        }
        // Load trash bin state from org room
        try {
          const trashState = await svc.getState(detectedOrg, EVT.ORG_TRASH);
          if (trashState) setTrashedIndividuals(trashState);
        } catch (e) { /* trash may be empty */ }
      }
      // Load teams detected during scan — apply per-user local color overrides
      if (detectedTeams.length > 0) setTeams(detectedTeams.map((t, i) => ({
        ...t,
        color_hue: getLocalTeamColor(svc.userId, t.roomId, t.color_hue != null ? t.color_hue : distinctTeamHue(i))
      })));
      // Restore team mode from localStorage
      try {
        const savedTeamId = JSON.parse(localStorage.getItem('khora_active_team') || 'null')?.roomId;
        if (savedTeamId) {
          const savedTeam = detectedTeams.find(t => t.roomId === savedTeamId);
          if (savedTeam) {
            const localHue = getLocalTeamColor(svc.userId, savedTeam.roomId, savedTeam.color_hue != null ? savedTeam.color_hue : 260);
            setTeamMode({ roomId: savedTeam.roomId, name: savedTeam.name, color_hue: localHue });
          }
        }
      } catch {}
      // Detect existing team member DM rooms from scan
      const detectedDMs = [];
      for (const [rid, state] of Object.entries(scanned)) {
        const dmMeta = state[EVT.DM_META];
        if (dmMeta && (dmMeta.initiator === svc.userId || dmMeta.target === svc.userId)) {
          const peerId = dmMeta.initiator === svc.userId ? dmMeta.target : dmMeta.initiator;
          detectedDMs.push({
            roomId: rid,
            peerId,
            peerName: dmMeta.peer_names?.[peerId] || peerId,
            teamName: dmMeta.team_name || null,
            teamRoomId: dmMeta.team_room_id || null,
            orgName: dmMeta.org_name || null,
            peerType: dmMeta.peer_type || 'provider'
          });
        }
      }
      if (detectedDMs.length > 0) setTeamDMs(detectedDMs);
      // Load field definitions and crosswalks
      // Seed vault field defs if schema room exists and no defs stored yet
      if (schema && Object.keys(detectedFieldDefs).length === 0) {
        const seedDefs = {};
        for (const f of DOMAIN_CONFIG.vaultFields) {
          seedDefs[f.uri] = {
            uri: f.uri,
            key: f.key,
            label: f.label,
            version: 1,
            definition: f.definition || '',
            scope: f.scope || '',
            category: f.category,
            sensitive: f.sensitive,
            data_type: f.data_type || 'text',
            authority: f.authority || null,
            created_by: svc.userId,
            created_at: Date.now(),
            supersedes: null
          };
        }
        try {
          await svc.setState(schema, EVT.FIELD_DEF, {
            definitions: seedDefs
          });
        } catch (e) {
          console.debug('Field def seed:', e.message);
        }
        Object.assign(detectedFieldDefs, seedDefs);
      }
      setFieldDefs(detectedFieldDefs);
      setFieldCrosswalks(detectedCrosswalks);
      // Load field governance config from org or network room
      if (detectedOrg || network) {
        try {
          const govRoom = network || detectedOrg;
          const govConfig = await svc.getState(govRoom, EVT.FIELD_GOV_CONFIG);
          if (govConfig) setFieldGovernanceConfig(govConfig);
        } catch { /* no config yet */ }
      }
      // Load client records detected during scan
      if (detectedClientRecords.length > 0) {
        // Check room membership to determine status
        const enriched = [];
        for (const rec of detectedClientRecords) {
          let status = rec.status || 'created';
          // If the identity state already says 'claimed', respect that
          if (status === 'claimed') {
            enriched.push({
              ...rec,
              status
            });
            continue;
          }
          if (rec.client_matrix_id && svc.client) {
            try {
              const members = await svc.getRoomMembers(rec.roomId);
              const clientMember = members.find(m => m.userId === rec.client_matrix_id);
              if (clientMember) status = 'joined';else if (status === 'created' && rec.client_matrix_id) status = 'invited';
            } catch {}
          }
          enriched.push({
            ...rec,
            status
          });
        }
        setClientRecords(enriched);
      }
      // Process bridge data collected during scan (no second pass needed)
      await loadCasesFromScan(bridgeData, metricsR);
      await loadResources(detectedOrg, network, roster);
      // Auto-register bridges in org assignments if needed
      if (detectedOrg && bridgeData.length > 0) {
        const currentAssignments = {};
        try {
          const a = await svc.getState(detectedOrg, EVT.ROSTER_ASSIGN);
          if (a?.assignments) Object.assign(currentAssignments, a.assignments);
        } catch {}
        const casesForSync = bridgeData.map(({
          rid,
          meta,
          refs
        }) => ({
          bridgeRoomId: rid,
          meta,
          sharedData: {},
          clientUserId: meta.client,
          transferable: meta.transferable !== false,
          assigned_staff: meta.assigned_staff || [meta.provider]
        }));
        await syncAssignments(detectedOrg, casesForSync, currentAssignments);
      }
    } catch (e) {
      console.error('Provider init failed:', e);
      setInitError(e.message || 'Failed to initialize provider workspace.');
    }
    setLoading(false);
  };
  const loadCasesFromScan = async (bridgeData, mRoom) => {
    const found = [];
    for (const {
      rid,
      meta,
      refs
    } of bridgeData) {
      const decrypted = {};
      if (refs?.fields) {
        for (const [key, ref] of Object.entries(refs.fields)) {
          try {
            if (ref.key && ref.ciphertext && ref.iv) {
              const plain = await FieldCrypto.decrypt(ref.ciphertext, ref.iv, ref.key);
              if (plain !== null) decrypted[key] = plain;
            }
          } catch {/* skip undecryptable field */}
        }
      }
      // Backfill org_id on bridge meta if provider has an org and bridge doesn't have one yet
      if (orgRoom && !meta.org_id && meta.provider === svc.userId) {
        try {
          await svc.setState(rid, EVT.BRIDGE_META, {
            ...meta,
            org_id: orgRoom
          });
          meta.org_id = orgRoom;
        } catch {}
      }
      found.push({
        bridgeRoomId: rid,
        clientUserId: meta.client,
        meta,
        sharedData: decrypted,
        metricsRoom: mRoom || metricsRoom,
        transferable: meta.transferable !== false,
        org_id: meta.org_id || null,
        assigned_staff: meta.assigned_staff || [meta.provider]
      });
    }
    setCases(found);
    // Load data table extras (notes, allocations) in background
    loadDataTableExtras(found).catch(e => console.warn('DT extras load:', e.message));
  };
  const loadCases = async () => {
    const scanned = await svc.scanRooms();
    const bridgeData = [];
    for (const [rid, state] of Object.entries(scanned)) {
      const meta = state[EVT.BRIDGE_META];
      if (meta && meta.status !== 'tombstoned') {
        if (meta.provider === svc.userId || meta.assigned_staff?.includes(svc.userId)) {
          bridgeData.push({
            rid,
            meta,
            refs: state[EVT.BRIDGE_REFS]
          });
        }
      }
    }
    await loadCasesFromScan(bridgeData);
  };

  // Load notes and allocations for the data table view
  const loadDataTableExtras = async currentCases => {
    if (!svc.client) return;
    const notesMap = {};
    const allAllocs = [];
    for (const c of currentCases) {
      const room = svc.client.getRoom(c.bridgeRoomId);
      if (!room) continue;
      // Paginate backwards to capture historical observations, messages, and allocations
      try {
        for (let i = 0; i < 3; i++) {
          const canPaginate = room.getLiveTimeline().getPaginationToken('b');
          if (!canPaginate) break;
          await svc.client.scrollback(room, 100);
        }
      } catch (e) {/* pagination may fail — continue with available events */}
      const seenIds = new Set();
      const events = [];
      const timelineSets = room.getTimelineSets ? room.getTimelineSets() : [];
      if (timelineSets.length > 0) {
        for (const ts of timelineSets) {
          for (const tl of ts.getTimelines()) {
            for (const ev of tl.getEvents()) {
              if (!seenIds.has(ev.getId())) {
                seenIds.add(ev.getId());
                events.push(ev);
              }
            }
          }
        }
      } else {
        for (const ev of room.getLiveTimeline().getEvents()) events.push(ev);
      }
      // Extract observations as "shared notes"
      const obs = events.filter(e => e.getType() === EVT.OBSERVATION).map(e => {
        const content = e.getContent();
        return {
          id: e.getId(),
          indId: c.bridgeRoomId,
          type: 'shared',
          eo_op: 'INS',
          frame: content.frame || 'GIVEN',
          room: 'bridge',
          category: content.category || 'observation',
          author: (e.getSender() || '').split(':')[0]?.replace('@', '') || 'Unknown',
          at: content.ts || e.getTs(),
          text: content.notes || content.value || content.question || '(observation recorded)',
          tags: content.tags || []
        };
      });
      // Extract messages as shared notes
      const msgs = events.filter(e => e.getType() === 'm.room.message' && e.getContent().msgtype === 'm.text').slice(-10).map(e => ({
        id: e.getId(),
        indId: c.bridgeRoomId,
        type: 'shared',
        eo_op: 'INS',
        frame: 'GIVEN',
        room: 'bridge',
        category: 'message',
        author: (e.getSender() || '').split(':')[0]?.replace('@', '') || 'Unknown',
        at: e.getTs(),
        text: e.getContent().body || '',
        tags: []
      }));
      notesMap[c.bridgeRoomId] = [...obs, ...msgs].sort((a, b) => (b.at || 0) - (a.at || 0));
      // Extract allocations
      const allocEvts = events.filter(e => e.getType() === EVT.RESOURCE_ALLOC).map(e => {
        const content = e.getContent();
        return {
          id: content.id || e.getId(),
          indId: c.bridgeRoomId,
          resourceId: content.resource_type_id,
          eo_op: 'CON',
          frame: 'MEANT',
          resourceName: content.resource_name || content.resource_type_id || 'Resource',
          quantity: content.quantity || 1,
          unit: content.unit || 'unit',
          status: content.status || 'active',
          allocatedBy: (content.allocated_by || '').split(':')[0]?.replace('@', '') || T.staff_term,
          org: 'Organization',
          at: content.allocated_at || e.getTs(),
          expiresAt: content.expires_at || null,
          bridgeRoom: c.bridgeRoomId,
          vaultShadow: content.vault_shadow || null,
          events: content.events || [],
          constraintsChecked: content.constraints_checked || [],
          indName: c.sharedData.full_name || c.clientUserId || 'Unknown'
        };
      });
      allAllocs.push(...allocEvts);
    }
    setBridgeNotes(notesMap);
    setAllAllocations(allAllocs);

    // ─── Load structured notes (io.khora.note) from bridges + roster ───
    const allNotes = [];
    // Notes from bridge rooms (attached to individuals)
    for (const c of currentCases) {
      const room = svc.client.getRoom(c.bridgeRoomId);
      if (!room) continue;
      const events = room.getLiveTimeline().getEvents();
      events.filter(e => e.getType() === EVT.NOTE).forEach(e => {
        const content = e.getContent();
        allNotes.push({
          ...content,
          id: content.id || e.getId(),
          attached_to: content.attached_to || c.bridgeRoomId,
          author: content.author || e.getSender(),
          created: content.created || e.getTs(),
          _sourceRoom: c.bridgeRoomId
        });
      });
    }
    // Notes from roster room (standalone or references)
    if (rosterRoom) {
      const rRoom = svc.client.getRoom(rosterRoom);
      if (rRoom) {
        rRoom.getLiveTimeline().getEvents().filter(e => e.getType() === EVT.NOTE).forEach(e => {
          const content = e.getContent();
          allNotes.push({
            ...content,
            id: content.id || e.getId(),
            author: content.author || e.getSender(),
            created: content.created || e.getTs(),
            _sourceRoom: rosterRoom
          });
        });
      }
    }
    // ─── Collect NOTE_EDIT events and apply to notes ───
    const allEdits = [];
    for (const c of currentCases) {
      const room = svc.client.getRoom(c.bridgeRoomId);
      if (!room) continue;
      room.getLiveTimeline().getEvents().filter(e => e.getType() === EVT.NOTE_EDIT).forEach(e => {
        allEdits.push(e.getContent());
      });
    }
    if (rosterRoom) {
      const rRoom = svc.client.getRoom(rosterRoom);
      if (rRoom) {
        rRoom.getLiveTimeline().getEvents().filter(e => e.getType() === EVT.NOTE_EDIT).forEach(e => {
          allEdits.push(e.getContent());
        });
      }
    }
    // Group edits by note_id, sorted chronologically
    const editsByNote = {};
    allEdits.sort((a, b) => (a.edited_at || 0) - (b.edited_at || 0)).forEach(ed => {
      if (!ed.note_id) return;
      if (!editsByNote[ed.note_id]) editsByNote[ed.note_id] = [];
      editsByNote[ed.note_id].push(ed);
    });
    // Sort by created desc, deduplicate by id, apply edits
    const seenNoteIds = new Set();
    const dedupedNotes = allNotes.filter(n => {
      if (seenNoteIds.has(n.id)) return false;
      seenNoteIds.add(n.id);
      return true;
    }).map(n => {
      const edits = editsByNote[n.id];
      if (!edits || edits.length === 0) return { ...n, edit_history: [] };
      // Apply edits sequentially to get current state
      let current = { ...n, edit_history: edits };
      for (const ed of edits) {
        if (ed.title !== undefined) current.title = ed.title;
        if (ed.content !== undefined) current.content = ed.content;
        current.updated = ed.edited_at;
        current.last_edited_by = ed.edited_by;
      }
      return current;
    }).sort((a, b) => (b.created || 0) - (a.created || 0));
    setDbNotes(dedupedNotes);
  };

  // ─── Cell edit handler with debounced EO event tracking ───
  const handleDbCellEdit = (row, fieldKey, newValue) => {
    const oldValue = row[fieldKey] || row.fields && row.fields[fieldKey]?.value || '';
    if (newValue === oldValue) return;
    // Debounce: clear existing timer for this row+field, set a new one
    const timerKey = row.id + ':' + fieldKey;
    if (cellEditTimerRef.current[timerKey]) clearTimeout(cellEditTimerRef.current[timerKey]);
    cellEditTimerRef.current[timerKey] = setTimeout(async () => {
      try {
        const roomId = row.bridgeRoom || row.id;
        // Emit EO operation to track the edit
        await emitOp(roomId, oldValue ? 'ALT' : 'INS', dot('org', 'individuals', fieldKey), {
          from: oldValue || undefined,
          to: newValue,
          edit_source: 'database_view'
        }, {
          type: 'org',
          epistemic: 'MEANT',
          role: orgRole || 'provider'
        });
        // Persist the edit to Matrix state
        if (row._case) {
          if (fieldKey === 'name') {
            // Update full_name in bridge shared data
            const updatedData = {
              ...row._case.sharedData,
              full_name: newValue
            };
            await svc.setState(roomId, EVT.BRIDGE_REFS, {
              fields: updatedData
            });
            // Update client_name in ROSTER_ASSIGN for org room
            if (orgRoom && caseAssignments[roomId]) {
              const updatedAssignments = {
                ...caseAssignments
              };
              updatedAssignments[roomId] = {
                ...updatedAssignments[roomId],
                client_name: newValue
              };
              await svc.setState(orgRoom, EVT.ROSTER_ASSIGN, {
                assignments: updatedAssignments
              });
              setCaseAssignments(updatedAssignments);
            }
          } else if (fieldKey === 'priority') {
            // Update priority in ROSTER_ASSIGN
            if (orgRoom && caseAssignments[roomId]) {
              const updatedAssignments = {
                ...caseAssignments
              };
              updatedAssignments[roomId] = {
                ...updatedAssignments[roomId],
                priority: newValue
              };
              await svc.setState(orgRoom, EVT.ROSTER_ASSIGN, {
                assignments: updatedAssignments
              });
              setCaseAssignments(updatedAssignments);
            }
          } else {
            // Dynamic field — update shared data in bridge
            const updatedData = {
              ...row._case.sharedData,
              [fieldKey]: newValue
            };
            await svc.setState(roomId, EVT.BRIDGE_REFS, {
              fields: updatedData
            });
          }
        } else if (row._clientRecord) {
          // Client record rows — update identity state
          const updates = {
            ...row._clientRecord
          };
          if (fieldKey === 'name') updates.client_name = newValue;
          await svc.setState(row.id, EVT.IDENTITY, updates);
        }
      } catch (e) {
        console.warn('Cell edit event failed:', e.message);
      }
      delete cellEditTimerRef.current[timerKey];
    }, 300); // 300ms debounce
  };

  // ─── Note save handler ───
  const handleNoteSave = noteData => {
    setDbNotes(prev => [noteData, ...prev]);
  };

  // ─── Note edit handler (ALT operation) ───
  const handleNoteEdit = editData => {
    setDbNotes(prev => prev.map(n => {
      if (n.id !== editData.note_id) return n;
      const editEntry = {
        title: editData.title,
        content: editData.content,
        prev_title: editData.prev_title,
        prev_content: editData.prev_content,
        edited_by: editData.edited_by,
        edited_at: editData.edited_at
      };
      return {
        ...n,
        title: editData.title,
        content: editData.content,
        updated: editData.edited_at,
        last_edited_by: editData.edited_by,
        edit_history: [...(n.edit_history || []), editEntry]
      };
    }));
    // Update the detail modal if it's showing this note
    setNoteDetailModal(prev => {
      if (!prev || prev.id !== editData.note_id) return prev;
      const editEntry = {
        title: editData.title,
        content: editData.content,
        prev_title: editData.prev_title,
        prev_content: editData.prev_content,
        edited_by: editData.edited_by,
        edited_at: editData.edited_at
      };
      return {
        ...prev,
        title: editData.title,
        content: editData.content,
        updated: editData.edited_at,
        last_edited_by: editData.edited_by,
        edit_history: [...(prev.edit_history || []), editEntry]
      };
    });
  };

  // ─── Bulk action handler for database table ───
  const handleBulkAction = async (actionId, selectedRows) => {
    if (actionId === 'delete') {
      if (!window.confirm(`Move ${selectedRows.length} individual(s) to trash?`)) return;
      let newTrash = { ...trashedIndividuals };
      for (const rowId of selectedRows) {
        const c = cases.find(c => c.bridgeRoomId === rowId);
        const roomId = rowId;
        try {
          // EO: NUL(org.individuals.{roomId}, {from: 'active', to: 'deleted', reason: 'user_deleted'}) — individual_trash
          await emitOp(roomId, 'NUL', dot('org', 'individuals', roomId), {
            from: c ? 'active' : 'created',
            to: 'deleted',
            reason: 'user_deleted'
          }, {
            type: 'org',
            epistemic: 'MEANT',
            role: orgRole || 'provider'
          });
          newTrash[roomId] = {
            deletedBy: svc.userId,
            deletedAt: Date.now(),
            name: c?.sharedData?.full_name || c?.clientUserId || 'Unknown'
          };
        } catch (e) {
          console.warn('Bulk delete failed for', roomId, e.message);
        }
      }
      if (orgRoom) {
        try {
          await svc.setState(orgRoom, EVT.ORG_TRASH, newTrash);
        } catch (e) { console.warn('Trash persist failed:', e.message); }
      }
      setTrashedIndividuals(newTrash);
      showToast(`${selectedRows.length} individual(s) moved to trash`, 'warn');
    } else if (actionId === 'assign') {
      const staffList = (staff || []).map(s => s.display_name || s.userId?.split(':')[0]?.replace('@', '') || s.userId);
      const staffName = window.prompt('Assign to ' + T.staff_term.toLowerCase() + (staffList.length > 0 ? ' (' + staffList.join(', ') + ')' : '') + ':');
      if (!staffName) return;
      for (const rowId of selectedRows) {
        try {
          if (orgRoom && caseAssignments[rowId]) {
            const updatedAssignments = {
              ...caseAssignments
            };
            updatedAssignments[rowId] = {
              ...updatedAssignments[rowId],
              primary: staffName,
              staff: [staffName, ...(updatedAssignments[rowId].staff || []).filter(s => s !== staffName)]
            };
            await svc.setState(orgRoom, EVT.ROSTER_ASSIGN, {
              assignments: updatedAssignments
            });
            setCaseAssignments(updatedAssignments);
          }
          await emitOp(rowId, 'ALT', dot('org', 'individuals', 'assigned_to'), {
            to: staffName,
            edit_source: 'database_bulk'
          }, {
            type: 'org',
            epistemic: 'MEANT',
            role: orgRole || 'provider'
          });
        } catch (e) {
          console.warn('Bulk assign failed for', rowId, e.message);
        }
      }
      showToast(`${selectedRows.length} individual(s) assigned to ${staffName}`, 'success');
    } else if (actionId === 'tag') {
      showToast('Tagging is not yet implemented', 'info');
    }
  };

  // ─── Restore individual from trash ───
  const handleRestoreIndividual = async (roomId) => {
    try {
      // EO: INS(org.individuals.{roomId}, {from: 'deleted', to: 'active', reason: 'user_restored'}) — individual_restore
      await emitOp(roomId, 'INS', dot('org', 'individuals', roomId), {
        from: 'deleted',
        to: 'active',
        reason: 'user_restored'
      }, {
        type: 'org',
        epistemic: 'MEANT',
        role: orgRole || 'provider'
      });
      const newTrash = { ...trashedIndividuals };
      delete newTrash[roomId];
      if (orgRoom) {
        await svc.setState(orgRoom, EVT.ORG_TRASH, newTrash);
      }
      setTrashedIndividuals(newTrash);
      showToast('Individual restored', 'success');
    } catch (e) {
      showToast('Restore failed: ' + e.message, 'error');
    }
  };

  // ─── Row reorder handler for database table ───
  const handleReorder = (fromIdx, toIdx) => {
    setClientRecords(prev => {
      const updated = [...prev];
      const [moved] = updated.splice(fromIdx, 1);
      updated.splice(toIdx, 0, moved);
      return updated;
    });
    try {
      emitOp(orgRoom || rosterRoom, 'ALT', dot('org', 'individual_order', 'sort_order'), {
        from: fromIdx,
        to: toIdx,
        edit_source: 'database_drag'
      }, {
        type: 'org',
        epistemic: 'MEANT',
        role: orgRole || 'provider'
      });
    } catch (e) {/* silent */}
  };

  // Auto-register cases in org ROSTER_ASSIGN when they aren't tracked yet
  const syncAssignments = async (orgRoomId, currentCases, currentAssignments) => {
    if (!orgRoomId) return;
    let updated = false;
    const assignments = {
      ...currentAssignments
    };
    for (const c of currentCases) {
      if (!assignments[c.bridgeRoomId]) {
        assignments[c.bridgeRoomId] = {
          primary: c.meta.provider,
          staff: c.assigned_staff || [c.meta.provider],
          client_name: c.sharedData.full_name || c.clientUserId,
          transferable: c.transferable,
          added: Date.now()
        };
        updated = true;
      }
    }
    if (updated) {
      try {
        await svc.setState(orgRoomId, EVT.ROSTER_ASSIGN, {
          assignments
        });
        setCaseAssignments(assignments);
      } catch (e) {
        console.warn('Assignment sync failed:', e.message);
      }
    }
  };
  const loadNetworkMembers = async nRoom => {
    const members = await svc.getState(nRoom, EVT.NET_MEMBERS);
    setNetworkMembers(members?.organizations || []);
  };
  const loadResources = async (oRoom, nRoom, pRoom) => {
    const types = [];
    const relations = [];
    const inv = {};
    if (!svc.client) {
      setResourceTypes(types);
      setResourceRelations(relations);
      setResourceInventory(inv);
      return;
    }
    // Load resource types from org room
    if (oRoom) {
      const room = svc.client.getRoom(oRoom);
      if (room) {
        const stateEvents = room.currentState.getStateEvents(EVT.RESOURCE_TYPE);
        if (stateEvents) {
          const evArr = Array.isArray(stateEvents) ? stateEvents : [stateEvents];
          evArr.forEach(e => {
            const c = e.getContent ? e.getContent() : e;
            if (c && c.id) types.push({
              ...c,
              _source: 'org'
            });
          });
        }
        const relEvents = room.currentState.getStateEvents(EVT.RESOURCE_RELATION);
        if (relEvents) {
          const evArr = Array.isArray(relEvents) ? relEvents : [relEvents];
          evArr.forEach(e => {
            const c = e.getContent ? e.getContent() : e;
            if (c && c.id) relations.push(c);
          });
        }
        const invEvents = room.currentState.getStateEvents(EVT.RESOURCE_INVENTORY);
        if (invEvents) {
          const evArr = Array.isArray(invEvents) ? invEvents : [invEvents];
          evArr.forEach(e => {
            const c = e.getContent ? e.getContent() : e;
            if (c && c.relation_id) inv[c.relation_id] = c;
          });
        }
      }
    }
    // Load resource types from network room (if different)
    if (nRoom) {
      const room = svc.client.getRoom(nRoom);
      if (room) {
        const stateEvents = room.currentState.getStateEvents(EVT.RESOURCE_TYPE);
        if (stateEvents) {
          const evArr = Array.isArray(stateEvents) ? stateEvents : [stateEvents];
          evArr.forEach(e => {
            const c = e.getContent ? e.getContent() : e;
            if (c && c.id && !types.find(t => t.id === c.id)) types.push({
              ...c,
              _source: 'network'
            });
          });
        }
      }
    }
    // Load personal resource types from roster room
    if (pRoom) {
      const room = svc.client.getRoom(pRoom);
      if (room) {
        const stateEvents = room.currentState.getStateEvents(EVT.RESOURCE_TYPE);
        if (stateEvents) {
          const evArr = Array.isArray(stateEvents) ? stateEvents : [stateEvents];
          evArr.forEach(e => {
            const c = e.getContent ? e.getContent() : e;
            if (c && c.id && !types.find(t => t.id === c.id)) types.push({
              ...c,
              _source: 'personal'
            });
          });
        }
        const relEvents = room.currentState.getStateEvents(EVT.RESOURCE_RELATION);
        if (relEvents) {
          const evArr = Array.isArray(relEvents) ? relEvents : [relEvents];
          evArr.forEach(e => {
            const c = e.getContent ? e.getContent() : e;
            if (c && c.id) relations.push(c);
          });
        }
        const invEvents = room.currentState.getStateEvents(EVT.RESOURCE_INVENTORY);
        if (invEvents) {
          const evArr = Array.isArray(invEvents) ? invEvents : [invEvents];
          evArr.forEach(e => {
            const c = e.getContent ? e.getContent() : e;
            if (c && c.relation_id) inv[c.relation_id] = c;
          });
        }
      }
    }
    setResourceTypes(types);
    setResourceRelations(relations);
    setResourceInventory(inv);
  };
  const loadMessages = async bid => {
    setMessages(await svc.getMessages(bid));
  };
  const handleSendMsg = async () => {
    if (!msgText.trim() || !activeCase) return;
    await svc.sendMessage(activeCase, msgText, {
      [`${NS}.type`]: 'note'
    });
    await emitOp(activeCase, 'INS', dot('bridge', 'messages', 'provider_note'), {
      body: msgText
    }, bridgeFrame(activeCase));
    setMsgText('');
    setTimeout(() => loadMessages(activeCase), 500);
  };
  const handleSendRequest = async () => {
    if (!requestText.trim() || !activeCase) return;
    await svc.sendMessage(activeCase, `Information Request: ${requestText}`, {
      [`${NS}.type`]: 'request'
    });
    await emitOp(activeCase, 'DES', dot('bridge', 'case', 'information_request'), {
      request: requestText
    }, bridgeFrame(activeCase));
    setRequestText('');
    showToast('Request sent to client', 'success');
    setTimeout(() => loadMessages(activeCase), 500);
  };

  // Record structured provider observation in bridge room (MEANT frame)
  const handleProviderObservation = async () => {
    if (!provObsValue || !provObsModal || !activeCase) return;
    const obs = {
      id: genOpId(),
      prompt_id: provObsModal.id,
      prompt_key: provObsModal.key,
      value: provObsValue,
      notes: provObsNotes || undefined,
      schema_version: provObsModal.version || 1,
      author: svc.userId,
      ts: Date.now(),
      created_by: svc.userId,
      origin_server: extractHomeserver(svc.userId),
      ...(teamMode ? { team_id: teamMode.roomId, team_name: teamMode.name } : {})
    };
    await svc.sendEvent(activeCase, EVT.OBSERVATION, obs);
    await emitOp(activeCase, 'INS', dot('bridge', 'observations', provObsModal.key), {
      value: provObsValue,
      prompt: provObsModal.question,
      notes: provObsNotes || undefined,
      epistemic_crossing: provObsModal.category === 'assessment' ? 'GIVEN → MEANT' : undefined
    }, bridgeFrame(activeCase));
    setProvObservations(prev => [...prev, obs]);
    setProvObsModal(null);
    setProvObsValue('');
    setProvObsNotes('');
    showToast(`Observation recorded: ${provObsModal.question}`, 'success');
  };

  // Load provider observations from bridge (paginate to capture historical observations)
  const loadProviderObservations = async bid => {
    if (!svc.client) return;
    const room = svc.client.getRoom(bid);
    if (!room) return;
    // Paginate backwards to ensure we capture historical observations
    try {
      for (let i = 0; i < 3; i++) {
        const canPaginate = room.getLiveTimeline().getPaginationToken('b');
        if (!canPaginate) break;
        await svc.client.scrollback(room, 100);
      }
    } catch (e) {/* pagination may fail — continue with available events */}
    const seenIds = new Set();
    const allEvents = [];
    const timelineSets = room.getTimelineSets ? room.getTimelineSets() : [];
    if (timelineSets.length > 0) {
      for (const ts of timelineSets) {
        for (const tl of ts.getTimelines()) {
          for (const ev of tl.getEvents()) {
            if (!seenIds.has(ev.getId()) && ev.getType() === EVT.OBSERVATION) {
              seenIds.add(ev.getId());
              allEvents.push(ev);
            }
          }
        }
      }
    } else {
      for (const ev of room.getLiveTimeline().getEvents()) {
        if (ev.getType() === EVT.OBSERVATION) allEvents.push(ev);
      }
    }
    const obs = allEvents.map(e => e.getContent());
    setProvObservations(obs);
  };

  // ─── Case transfer between providers within org ───
  const handleTransferCase = async () => {
    if (!transferModal || !transferTarget.trim() || !orgRoom) return;
    const c = transferModal;
    // Check if client has allowed transfers
    if (!c.transferable) {
      showToast(`Transfer blocked — ${T.client_term.toLowerCase()} has disabled provider transfers for this bridge`, 'error');
      return;
    }
    // Don't transfer to the same provider
    if (transferTarget === c.meta.provider) {
      showToast('Case is already assigned to this provider', 'warn');
      return;
    }
    // Verify target is org staff
    const targetStaff = staff.find(s => s.userId === transferTarget);
    if (!targetStaff) {
      showToast('Target must be a member of your organization', 'error');
      return;
    }
    try {
      // Step 1: Invite new provider to the bridge room
      try {
        await svc.invite(c.bridgeRoomId, transferTarget);
      } catch (e) {
        // May fail if already a member or if we lack permissions
        console.warn('Invite during transfer:', e.message);
      }
      // Step 2: Update bridge meta — set new provider, update assigned_staff
      const updatedStaff = [...new Set([...(c.assigned_staff || []), transferTarget])];
      try {
        const currentMeta = await svc.getState(c.bridgeRoomId, EVT.BRIDGE_META);
        await svc.setState(c.bridgeRoomId, EVT.BRIDGE_META, {
          ...currentMeta,
          provider: transferTarget,
          assigned_staff: updatedStaff,
          transferred_from: c.meta.provider,
          transferred_at: Date.now(),
          transferred_by: svc.userId,
          last_modified_by: svc.userId,
          last_modified_at: Date.now(),
          origin_server: extractHomeserver(svc.userId)
        });
      } catch (e) {
        // Expected: provider may not have bridge state permission (client has PL 100).
        // Org-side ROSTER_ASSIGN is the authoritative record for case assignments.
        console.warn('Bridge meta update (expected if client controls bridge):', e.message);
      }
      // Step 3: Update ROSTER_ASSIGN in org room
      const updatedAssignments = {
        ...caseAssignments
      };
      updatedAssignments[c.bridgeRoomId] = {
        primary: transferTarget,
        staff: updatedStaff,
        client_name: c.sharedData?.full_name || c.clientUserId,
        transferable: c.transferable,
        transferred_from: c.meta.provider,
        transferred_at: Date.now(),
        transferred_by: svc.userId,
        added: caseAssignments[c.bridgeRoomId]?.added || Date.now()
      };
      await svc.setState(orgRoom, EVT.ROSTER_ASSIGN, {
        assignments: updatedAssignments
      });
      setCaseAssignments(updatedAssignments);
      // Step 4: Emit EO operation
      await emitOp(orgRoom, 'ALT', dot('org', 'case_assignment', 'provider'), {
        from: c.meta.provider,
        to: transferTarget,
        bridge_room: c.bridgeRoomId,
        client: c.clientUserId,
        reason: 'org_transfer',
        initiated_by: svc.userId
      }, orgFrame());
      // Step 5: Remove old provider from bridge room to revoke access
      if (c.meta.provider !== transferTarget) {
        try {
          await svc.kick(c.bridgeRoomId, c.meta.provider, 'Case transferred to new provider');
        } catch (e) {
          // May fail if we lack kick permission (client has PL 100) — log but don't block
          console.warn('Old provider kick during transfer:', e.message);
        }
      }
      setTransferModal(null);
      setTransferTarget('');
      showToast(`Case transferred to ${targetStaff.userId}`, 'success');
      // Refresh cases
      await loadCases();
    } catch (e) {
      showToast('Transfer failed: ' + e.message, 'error');
    }
  };

  // ─── Client record management ───
  const handleCreateClientRecord = async () => {
    if (!newClientName.trim()) return;
    try {
      const clientId = newClientMatrixId.trim() || null;
      const roomId = await svc.createClientRoom(`[Client] ${newClientName}`, `${T.client_term} record for ${newClientName}`, [{
        type: EVT.IDENTITY,
        state_key: '',
        content: {
          account_type: 'client_record',
          owner: svc.userId,
          created: Date.now(),
          client_name: newClientName,
          client_matrix_id: clientId,
          notes: newClientNotes || undefined,
          status: 'created'
        }
      }], clientId);
      // If client Matrix ID provided, invite them and set them as admin
      if (clientId) {
        try {
          await svc.invite(roomId, clientId);
          await svc.setState(roomId, EVT.IDENTITY, {
            account_type: 'client_record',
            owner: svc.userId,
            created: Date.now(),
            client_name: newClientName,
            client_matrix_id: clientId,
            notes: newClientNotes || undefined,
            status: 'invited'
          });
        } catch (e) {
          console.warn('Invite failed:', e.message);
        }
      }
      await emitOp(roomId, 'DES', dot('org', 'client_record', newClientName), {
        created_by: svc.userId,
        client_id: clientId || undefined,
        status: clientId ? 'invited' : 'created'
      }, orgFrame());
      const newRecord = {
        roomId,
        client_name: newClientName,
        client_matrix_id: clientId,
        notes: newClientNotes || undefined,
        owner: svc.userId,
        created: Date.now(),
        status: clientId ? 'invited' : 'created'
      };
      setClientRecords(prev => [...prev, newRecord]);
      setCreateClientModal(false);
      // Emit EO event to track individual creation
      try {
        await emitOp(roomId, 'INS', dot('org', 'individuals', newClientName), {
          designation: newClientName,
          client_name: newClientName,
          client_matrix_id: clientId || undefined,
          edit_source: 'client_creation'
        }, {
          type: 'org',
          epistemic: 'MEANT',
          role: orgRole || 'provider'
        });
      } catch (e) {
        console.warn('Creation event tracking failed:', e.message);
      }
      setNewClientName('');
      setNewClientMatrixId('');
      setNewClientNotes('');
      showToast(`${T.client_term} "${newClientName}" created${clientId ? ' — invite sent' : ''}`, 'success');
    } catch (e) {
      showToast('Failed: ' + e.message, 'error');
    }
  };
  const handleClientInvite = async () => {
    if (!clientInviteModal || !clientInviteMatrixId.trim()) return;
    if (!isValidMatrixId(clientInviteMatrixId)) {
      showToast('Invalid Matrix ID — use format @user:server', 'error');
      return;
    }
    try {
      const clientId = clientInviteMatrixId.trim();
      // Set client PL 100, invite, THEN demote self to PL 50.
      // Order matters: if invite fails after self-demotion, no one has admin.
      await svc.setPowerLevel(clientInviteModal.roomId, clientId, 100);
      await svc.invite(clientInviteModal.roomId, clientId);
      await svc.setPowerLevel(clientInviteModal.roomId, svc.userId, 50);
      // Update identity state with the client's Matrix ID
      await svc.setState(clientInviteModal.roomId, EVT.IDENTITY, {
        ...clientInviteModal,
        client_matrix_id: clientId,
        status: 'invited'
      });
      await emitOp(clientInviteModal.roomId, 'CON', dot('org', 'client_record', clientId), {
        invited_by: svc.userId,
        status: 'invited'
      }, orgFrame());
      setClientRecords(prev => prev.map(r => r.roomId === clientInviteModal.roomId ? {
        ...r,
        client_matrix_id: clientId,
        status: 'invited'
      } : r));
      showToast(`Invite sent to ${clientId} — they will have full room control`, 'success');
    } catch (e) {
      showToast('Invite failed: ' + e.message, 'error');
    }
  };

  // ─── Team CRUD ───
  const handleCreateTeam = async () => {
    if (!newTeamName.trim()) return;
    try {
      const teamHue = distinctTeamHue(teams.length);
      const govMode = newTeamGovernance || 'lead_decides';
      const parentTeam = newTeamParentId ? teams.find(t => t.roomId === newTeamParentId) : null;
      // Default team schema: identity + contact fields from vault
      const defaultSchemaFields = DOMAIN_CONFIG.vaultFields.filter(f => f.category === 'identity' || f.category === 'contact').map(f => ({
        uri: f.uri,
        required: f.category === 'identity',
        added_version: 1
      }));
      const roomId = await svc.createRoom(`[Khora Team] ${newTeamName}`, newTeamDesc || `Team: ${newTeamName}`, [{
        type: EVT.IDENTITY,
        state_key: '',
        content: {
          account_type: 'team',
          owner: svc.userId,
          created: Date.now()
        }
      }, {
        type: EVT.TEAM_META,
        state_key: '',
        content: {
          name: newTeamName,
          description: newTeamDesc || '',
          color_hue: teamHue,
          created: Date.now(),
          created_by: svc.userId,
          org_id: orgRoom || null,
          org_name: orgMeta.name || null,
          parent_team_id: parentTeam?.roomId || null,
          parent_team_name: parentTeam?.name || null
        }
      }, {
        type: EVT.TEAM_MEMBERS,
        state_key: '',
        content: {
          members: [{
            userId: svc.userId,
            role: 'lead',
            joined: Date.now(),
            display_name: providerProfile.display_name || '',
            sharing_consent: 'shared'
          }]
        }
      }, {
        type: EVT.TEAM_SCHEMA,
        state_key: '',
        content: {
          version: 1,
          fields: defaultSchemaFields,
          pending_changes: [],
          change_log: [{
            version: 1,
            summary: 'Initial schema',
            by: svc.userId,
            ts: Date.now()
          }],
          last_modified: Date.now(),
          modified_by: svc.userId
        }
      }, {
        type: EVT.TEAM_SCHEMA_RULE,
        state_key: '',
        content: {
          mode: govMode,
          modified_by: svc.userId,
          modified_at: Date.now()
        }
      }, {
        type: EVT.TEAM_HIERARCHY,
        state_key: '',
        content: {
          parent_team_id: parentTeam?.roomId || null,
          parent_team_name: parentTeam?.name || null,
          child_teams: [],
          rollup_policy: parentTeam ? 'explicit' : 'none',
          created_by: svc.userId,
          created_at: Date.now()
        }
      }]);
      // If nested under a parent team, register this child on the parent's hierarchy
      if (parentTeam) {
        try {
          const parentHierarchy = await svc.getState(parentTeam.roomId, EVT.TEAM_HIERARCHY) || {};
          const updatedChildren = [...(parentHierarchy.child_teams || []), { roomId, name: newTeamName }];
          await svc.setState(parentTeam.roomId, EVT.TEAM_HIERARCHY, {
            ...parentHierarchy,
            child_teams: updatedChildren,
            modified_at: Date.now()
          });
          // Update local state for parent
          setTeams(prev => prev.map(t => t.roomId === parentTeam.roomId ? {
            ...t,
            hierarchy: { ...(t.hierarchy || {}), child_teams: updatedChildren }
          } : t));
        } catch (e) {
          console.warn('[Team] Failed to register child on parent hierarchy:', e.message);
        }
      }
      await emitOp(roomId, 'DES', dot('org', 'teams', newTeamName), {
        created_by: svc.userId,
        org: orgMeta.name || null,
        parent_team: parentTeam?.name || null,
        governance_mode: govMode
      }, orgFrame());
      const newTeam = {
        roomId,
        name: newTeamName,
        description: newTeamDesc || '',
        color_hue: teamHue,
        created: Date.now(),
        created_by: svc.userId,
        org_id: orgRoom || null,
        org_name: orgMeta.name || null,
        parent_team_id: parentTeam?.roomId || null,
        parent_team_name: parentTeam?.name || null,
        members: [{
          userId: svc.userId,
          role: 'lead',
          joined: Date.now(),
          display_name: providerProfile.display_name || '',
          sharing_consent: 'shared'
        }],
        owner: svc.userId,
        schema: {
          version: 1,
          fields: defaultSchemaFields,
          pending_changes: [],
          change_log: []
        },
        schemaRule: { mode: govMode },
        hierarchy: {
          parent_team_id: parentTeam?.roomId || null,
          parent_team_name: parentTeam?.name || null,
          child_teams: [],
          rollup_policy: parentTeam ? 'explicit' : 'none'
        },
        customTables: []
      };
      setLocalTeamColor(svc.userId, roomId, teamHue);
      setTeams(prev => [...prev, newTeam]);
      setCreateTeamModal(false);
      setNewTeamName('');
      setNewTeamDesc('');
      setNewTeamParentId('');
      setNewTeamGovernance('lead_decides');
      showToast(`Team "${newTeamName}" created${parentTeam ? ` under ${parentTeam.name}` : ''}`, 'success');
    } catch (e) {
      showToast('Failed to create team: ' + e.message, 'error');
    }
  };
  const handleTeamInvite = async () => {
    if (!teamInviteModal || !teamInviteUserId.trim()) return;
    if (!isValidMatrixId(teamInviteUserId)) {
      showToast('Invalid Matrix ID — use format @user:server', 'error');
      return;
    }
    try {
      const uid = teamInviteUserId.trim();
      // Warn if invitee is not an org member (cross-org teams are allowed but noteworthy)
      if (orgRoom && staff.length > 0 && !staff.find(s => s.userId === uid)) {
        showToast(`Note: ${uid} is not a member of your organization`, 'info');
      }
      // Invite user to the team room
      if (svc.client) await svc.client.invite(teamInviteModal.roomId, uid);else await svc._api('POST', `/rooms/${encodeURIComponent(teamInviteModal.roomId)}/invite`, {
        user_id: uid
      });
      // Update the members list — new members start with sharing_consent:'pending' so they must proactively choose
      const updatedMembers = [...(teamInviteModal.members || []), {
        userId: uid,
        role: 'member',
        joined: Date.now(),
        sharing_consent: 'pending'
      }];
      await svc.setState(teamInviteModal.roomId, EVT.TEAM_MEMBERS, {
        members: updatedMembers
      });
      await emitOp(teamInviteModal.roomId, 'CON', dot('org', 'teams', 'members', uid), {
        invited_by: svc.userId,
        role: 'member'
      }, orgFrame());
      setTeams(prev => prev.map(t => t.roomId === teamInviteModal.roomId ? {
        ...t,
        members: updatedMembers
      } : t));
      showToast(`Invited ${uid} to team`, 'success');
      setTeamInviteUserId('');
    } catch (e) {
      showToast('Team invite failed: ' + e.message, 'error');
    }
  };

  // Handle sharing consent response — team member proactively chooses whether to withhold content
  const handleSharingConsent = async (team, memberId, withhold) => {
    try {
      const consentValue = withhold ? 'withheld' : 'shared';
      const updatedMembers = (team.members || []).map(m => m.userId === memberId ? {
        ...m,
        sharing_consent: consentValue
      } : m);
      await svc.setState(team.roomId, EVT.TEAM_MEMBERS, {
        members: updatedMembers
      });
      await emitOp(team.roomId, 'REC', dot('org', 'consent', 'sharing', memberId), {
        consent: consentValue,
        decided_by: memberId
      }, orgFrame());
      setTeams(prev => prev.map(t => t.roomId === team.roomId ? {
        ...t,
        members: updatedMembers
      } : t));
      setSharingConsentModal(null);
      if (withhold) {
        showToast('Content about individuals will not be shared with you in this team', 'warn');
      } else {
        showToast('Content about individuals may be shared with you in this team', 'success');
      }
    } catch (e) {
      showToast('Failed to save sharing preference: ' + e.message, 'error');
    }
  };
  const copyToClipboard = async (text, label) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopiedField(label);
      setTimeout(() => setCopiedField(null), 2000);
    } catch {
      showToast('Copy failed — please select and copy manually', 'warn');
    }
  };

  // ─── Share invite via email, SMS, or native share ───
  const getInviteShareText = roomId => {
    const link = getInviteUrl(roomId);
    return `You've been invited to securely manage your information on Khora.\n\nJoin here: ${link}\n\n${getSetupInstructions(roomId)}`;
  };

  const shareInviteViaEmail = roomId => {
    const subject = encodeURIComponent('You\'re invited to Khora');
    const body = encodeURIComponent(getInviteShareText(roomId));
    window.open(`mailto:?subject=${subject}&body=${body}`, '_self');
  };

  const shareInviteViaSMS = roomId => {
    const body = encodeURIComponent(getInviteShareText(roomId));
    // Use sms: URI — &body= works on most platforms, ;body= on some iOS versions
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    window.open(`sms:${isIOS ? '&' : '?'}body=${body}`, '_self');
  };

  const shareInviteNative = async roomId => {
    const text = getInviteShareText(roomId);
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'Khora Invite',
          text,
          url: getInviteUrl(roomId)
        });
      } catch (e) {
        if (e.name !== 'AbortError') {
          showToast('Share failed: ' + e.message, 'warn');
        }
      }
    } else {
      // Fallback: copy to clipboard
      await copyToClipboard(text, 'share');
      showToast('Invite copied to clipboard (share not supported in this browser)', 'info');
    }
  };

  // ─── Contact sharing helpers ───
  const getContactText = (asOrg) => {
    const lines = [];
    const name = providerProfile.display_name || svc.userId?.split(':')[0]?.replace('@', '');
    if (name) lines.push(name);
    if (asOrg && providerProfile.title) lines.push(providerProfile.title);
    if (asOrg && orgMeta?.name) lines.push(orgMeta.name);
    if (asOrg && providerProfile.credentials) lines.push(providerProfile.credentials);
    if (asOrg && myVerification?.status === 'verified' && myVerification.email) {
      lines.push(myVerification.email);
    }
    lines.push('');
    lines.push('Khora ID: ' + svc.userId);
    return lines.join('\n');
  };
  const copyContact = async () => {
    try {
      await navigator.clipboard.writeText(getContactText(shareAsOrg));
      setCopiedField('contact');
      setTimeout(() => setCopiedField(null), 2000);
    } catch { showToast('Copy failed — please select and copy manually', 'warn'); }
  };
  const shareContactViaEmail = () => {
    const subject = encodeURIComponent('My contact details');
    const body = encodeURIComponent(getContactText(shareAsOrg));
    window.open('mailto:?subject=' + subject + '&body=' + body, '_self');
  };
  const shareContactViaSMS = () => {
    const body = encodeURIComponent(getContactText(shareAsOrg));
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    window.open('sms:' + (isIOS ? '&' : '?') + 'body=' + body, '_self');
  };

  // ─── Import completion handler ───
  const handleImportComplete = importResults => {
    const newRecords = importResults.created.map(r => ({
      roomId: r.roomId,
      client_name: r.displayName,
      client_matrix_id: null,
      notes: `Imported (${r.fieldCount} encrypted fields)`,
      owner: svc.userId,
      created: Date.now(),
      status: 'created',
      imported: true
    }));
    setClientRecords(prev => [...prev, ...newRecords]);
  };
  const getInviteUrl = roomId => `https://matrix.to/#/${roomId}`;
  const getSetupInstructions = roomId => {
    const hs = svc._baseUrl ? svc._baseUrl.replace(/^https?:\/\//, '') : 'hyphae.social';
    const link = getInviteUrl(roomId);
    return `You've been invited to securely manage your information on Khora.\n\nTo get started:\n\n1. Create a free Matrix account:\n   Go to https://${hs} and click "Create Account"\n   (Matrix is a secure, decentralized messaging protocol — your data stays on the server you choose)\n\n2. Download a Matrix client (optional):\n   Web: https://app.element.io\n   Mobile: Search "Element" in your app store\n   Or use any Matrix-compatible app\n\n3. Sign in with your new account\n\n4. Accept the room invitation:\n   The invite should appear automatically in your Matrix client.\n   You can also open this link: ${link}\n   (Note: this is a private room — the invite must be accepted from the account specified above)\n\n5. You will have full control of this room — you can remove anyone from it at any time.\n\nQuestions? Contact your provider for help getting set up.`;
  };

  // Discover client by Matrix ID
  const handleDiscoverClient = async () => {
    if (!discoverUserId.trim()) return;
    try {
      // Check if we already have a bridge with this client
      const existing = cases.find(c => c.clientUserId === discoverUserId);
      if (existing) {
        showToast('Already connected with this client', 'info');
        setDiscoverModal(false);
        return;
      }
      // We can't create the bridge — the client must initiate. But we can check if one exists.
      const scanned = await svc.scanRooms();
      let found = false;
      for (const [rid, state] of Object.entries(scanned)) {
        const meta = state[EVT.BRIDGE_META];
        if (meta && meta.client === discoverUserId && meta.provider === svc.userId) {
          found = true;
          break;
        }
      }
      if (found) {
        await loadCases();
        showToast('Bridge found — refreshing cases', 'success');
      } else {
        showToast(`No bridge found for ${discoverUserId}. The client must create a bridge and invite you.`, 'warn');
      }
      setDiscoverModal(false);
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  };

  // INS(network.room, {identity, members}) — federation_creation + DES(network.schema_catalog, {forms, definitions}) — canonical_vocabulary + INS(network.seed_resources, {defaults}) — initial_catalog
  // Create a network — requires an org
  const handleCreateNetwork = async () => {
    if (!networkName.trim()) return;
    if (!orgRoom) {
      showToast('Create or join an organization before creating a network', 'warn');
      return;
    }
    try {
      const nRoom = await svc.createRoom(`[Khora Network] ${networkName}`, 'Network governance room', [{
        type: EVT.IDENTITY,
        state_key: '',
        content: {
          account_type: 'network',
          name: networkName,
          owner: svc.userId,
          created: Date.now()
        }
      }, {
        type: EVT.NET_MEMBERS,
        state_key: '',
        content: {
          organizations: [{
            id: orgRoom,
            name: orgMeta.name || '',
            joined: Date.now(),
            role: 'admin'
          }],
          governance: {
            schema_changes_require: 'admin_approval',
            admins: [orgRoom]
          }
        }
      }]);
      // Seed network schema — forms propagate to member orgs, then to clients through providers
      // Forms (GIVEN data collection) — propagate as standard (orgs can extend)
      for (const f of DEFAULT_FORMS) await svc.setState(nRoom, EVT.SCHEMA_FORM, {
        ...f,
        propagation: f.source?.propagation || 'standard',
        network: networkName
      }, `net:${f.id}`);
      for (const p of DEFAULT_PROMPTS) await svc.setState(nRoom, EVT.SCHEMA_PROMPT, {
        ...p,
        propagation: p.source?.propagation || 'standard',
        network: networkName
      }, `net:${p.key}`);
      // Interpretations — assessments propagate alongside forms
      for (const pp of DEFAULT_PROVIDER_PROMPTS) await svc.setState(nRoom, EVT.SCHEMA_ASSESSMENT, {
        ...pp,
        propagation: pp.source?.propagation || 'standard',
        network: networkName
      }, `net:${pp.key}`);
      // Definitions propagate as required (immutable at org level)
      for (const d of DEFAULT_DEFINITIONS) await svc.setState(nRoom, EVT.SCHEMA_DEF, {
        ...d,
        propagation: 'required',
        network: networkName
      }, `net:${d.key}`);
      // Seed default resource types into network catalog (draft maturity, optional propagation)
      try {
        await ResourceService.loadSeedResourceTypes(nRoom);
      } catch (e) {
        console.warn('Resource seed loading failed:', e.message);
      }
      await emitOp(nRoom, 'INS', dot('network', networkName), {
        created_by: svc.userId,
        org: orgMeta.name
      }, networkFrame(nRoom));
      setNetworkRoom(nRoom);
      await loadNetworkMembers(nRoom);
      setNetworkModal(false);
      setNetworkName('');
      showToast(`Network "${networkName}" created`, 'success');
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  };

  // CON(network.org, {action: join}) — membership_link
  // Join existing network by room ID — requires an org
  const handleJoinNetwork = async () => {
    if (!joinNetworkId.trim()) return;
    if (!orgRoom) {
      showToast('Create or join an organization before joining a network', 'warn');
      return;
    }
    try {
      if (svc.client) {
        await svc.client.joinRoom(joinNetworkId);
      } else {
        await svc._api('POST', `/join/${encodeURIComponent(joinNetworkId)}`, {});
      }
      // Add this org to the network members list
      try {
        const currentMembers = await svc.getState(joinNetworkId, EVT.NET_MEMBERS);
        const orgs = currentMembers?.organizations || [];
        if (!orgs.find(o => o.id === orgRoom)) {
          orgs.push({ id: orgRoom, name: orgMeta.name || '', joined: Date.now(), role: 'member' });
          await svc.setState(joinNetworkId, EVT.NET_MEMBERS, { ...currentMembers, organizations: orgs });
        }
        await emitOp(joinNetworkId, 'CON', dot('network', 'org', orgRoom), {
          action: 'join',
          org_name: orgMeta.name || '',
          joined_by: svc.userId
        }, networkFrame(joinNetworkId));
      } catch (e) {
        console.warn('Network members update:', e.message);
      }
      setNetworkRoom(joinNetworkId);
      await loadNetworkMembers(joinNetworkId);
      setJoinNetworkModal(false);
      setJoinNetworkId('');
      showToast('Joined network', 'success');
    } catch (e) {
      if (e.message?.includes('forbidden') || e.message?.includes('not invited')) {
        showToast('Cannot join — you must be invited by a network admin first', 'error');
      } else {
        showToast('Failed to join: ' + e.message, 'error');
      }
    }
  };

  // ─── Organization management ───
  const handleCreateResourceType = async () => {
    if (!resourceDraft.name.trim()) return;
    const targetRoom = orgRoom || networkRoom || rosterRoom;
    if (!targetRoom) {
      showToast('No room available for resource creation', 'error');
      return;
    }
    try {
      const level = orgRoom ? 'org' : networkRoom ? 'network' : 'individual';
      const typeData = {
        name: resourceDraft.name.trim(),
        category: resourceDraft.category,
        unit: resourceDraft.unit.trim() || 'unit',
        fungible: resourceDraft.fungible,
        perishable: resourceDraft.perishable,
        ttl_days: resourceDraft.perishable && resourceDraft.ttl_days ? parseInt(resourceDraft.ttl_days) : null,
        infinite: resourceDraft.infinite,
        replenishes: resourceDraft.replenishes,
        replenish_cycle: resourceDraft.replenishes ? resourceDraft.replenish_cycle : null,
        tags: resourceDraft.tags ? resourceDraft.tags.split(',').map(t => t.trim()).filter(Boolean) : [],
        permissions: resourceDraft.permissions || buildDefaultResourcePermissions()
      };
      const created = await ResourceService.createResourceType(targetRoom, typeData, level);
      // Auto-establish relation + inventory if initial quantity or infinite
      const initQty = parseInt(resourceDraft.initial_quantity) || 0;
      if (created && created.id && (initQty > 0 || resourceDraft.infinite)) {
        const relationRoom = orgRoom || rosterRoom;
        if (relationRoom) {
          const cap = resourceDraft.infinite ? 999999 : initQty;
          await ResourceService.establishRelation(relationRoom, {
            resource_type_id: created.id,
            relation_type: 'operates',
            capacity: cap,
            available: cap
          });
        }
      }
      setCreateResourceModal(false);
      setResourceDraft({
        name: '',
        category: 'general',
        unit: 'unit',
        fungible: true,
        perishable: false,
        ttl_days: '',
        tags: '',
        infinite: false,
        initial_quantity: '',
        replenishes: false,
        replenish_cycle: '',
        permissions: buildDefaultResourcePermissions()
      });
      showToast(`Resource type "${typeData.name}" created`, 'success');
      // Optimistically add the new resource type to local state immediately,
      // since room.currentState won't reflect the new state event until the
      // next /sync response from the server.
      const optimisticType = created && created.id ? {
        ...created,
        _source: level === 'individual' ? 'personal' : level === 'network' ? 'network' : 'org'
      } : null;
      if (optimisticType) {
        setResourceTypes(prev => {
          if (prev.some(t => t.id === optimisticType.id)) return prev;
          return [...prev, optimisticType];
        });
      }
      // Delayed reload to reconcile with server state after sync.
      // Use longer delay + preserve optimistic type if sync hasn't delivered it yet.
      setTimeout(() => {
        loadResources(orgRoom, networkRoom, rosterRoom);
        // Re-add optimistic type if sync hasn't delivered it yet
        if (optimisticType) {
          setTimeout(() => {
            setResourceTypes(prev => {
              if (prev.some(t => t.id === optimisticType.id)) return prev;
              return [...prev, optimisticType];
            });
          }, 100);
        }
      }, 2500);
    } catch (e) {
      showToast('Error creating resource: ' + e.message, 'error');
    }
  };

  // ─── Promote personal resource to organization (move semantics) ───
  const handlePromoteResource = async rt => {
    if (!orgRoom || !rosterRoom) return;
    try {
      const {
        _source,
        ...typeData
      } = rt;
      await ResourceService.createResourceType(orgRoom, typeData, 'org');
      // Remove from roster room by writing empty content (Matrix tombstone pattern)
      await svc.setState(rosterRoom, EVT.RESOURCE_TYPE, {}, rt.id);
      await svc.setState(rosterRoom, EVT.RESOURCE_PERM, {}, rt.id);
      // If there was a personal relation, remove it too
      const personalRelation = resourceRelations.find(r => r.resource_type_id === rt.id && r.holder === rosterRoom);
      if (personalRelation) {
        await svc.setState(rosterRoom, EVT.RESOURCE_RELATION, {}, personalRelation.id);
      }
      showToast(`"${rt.name}" promoted to organization`, 'success');
      setTimeout(() => loadResources(orgRoom, networkRoom, rosterRoom), 800);
    } catch (e) {
      showToast('Error promoting resource: ' + e.message, 'error');
    }
  };

  // ─── Update resource permissions ───
  const handleSavePermissions = async () => {
    const targetRoom = orgRoom || rosterRoom;
    if (!permModal || !targetRoom) return;
    try {
      await ResourceService.updateResourcePermissions(targetRoom, permModal.id, permDraft, orgRole);
      setPermModal(null);
      showToast(`Permissions updated for "${permModal.name}"`, 'success');
      setTimeout(() => loadResources(orgRoom, networkRoom, rosterRoom), 800);
    } catch (e) {
      showToast('Error updating permissions: ' + e.message, 'error');
    }
  };
  const handleAddPermGrant = () => {
    if (!permGrantId) return;
    const grant = {
      type: permGrantType,
      id: permGrantId
    };
    // Avoid duplicates
    if (permDraft[permGrantAbility].some(g => g.type === grant.type && g.id === grant.id)) {
      showToast('This grant already exists', 'warn');
      return;
    }
    setPermDraft({
      ...permDraft,
      [permGrantAbility]: [...permDraft[permGrantAbility], grant]
    });
    setPermGrantId('');
  };
  const handleRemovePermGrant = (ability, index) => {
    setPermDraft({
      ...permDraft,
      [ability]: permDraft[ability].filter((_, i) => i !== index)
    });
  };
  const openPermModal = rt => {
    setPermDraft({
      controllers: rt.permissions?.controllers || [],
      allocators: rt.permissions?.allocators || [],
      viewers: rt.permissions?.viewers || []
    });
    setPermGrantAbility('controllers');
    setPermGrantType('role');
    setPermGrantId('');
    setPermModal(rt);
  };
  const handleEstablishRelation = async resourceTypeId => {
    const targetRoom = orgRoom || rosterRoom;
    if (!targetRoom) {
      showToast('No room available to establish resource relations', 'error');
      return;
    }
    try {
      await ResourceService.establishRelation(targetRoom, {
        resource_type_id: resourceTypeId,
        relation_type: 'operates',
        capacity: 0,
        available: 0
      });
      showToast('Resource relation established', 'success');
      setTimeout(() => loadResources(orgRoom, networkRoom, rosterRoom), 800);
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  };

  // ─── Load allocations for active case (bridge room) ───
  const loadCaseAllocations = async bridgeRoomId => {
    if (!svc.client) return;
    const room = svc.client.getRoom(bridgeRoomId);
    if (!room) {
      setCaseAllocations([]);
      return;
    }
    const allocEvents = room.currentState.getStateEvents(EVT.RESOURCE_ALLOC);
    const allocs = [];
    if (allocEvents) {
      const evArr = Array.isArray(allocEvents) ? allocEvents : [allocEvents];
      for (const ev of evArr) {
        const c = ev.getContent ? ev.getContent() : ev;
        if (c && c.id) allocs.push(c);
      }
    }
    setCaseAllocations(allocs);
  };

  // ─── Allocate resource to client in active case ───
  const handleAllocateResource = async () => {
    if (!allocDraft.resource_type_id || !activeCase || !(orgRoom || rosterRoom)) return;
    const caseData = cases.find(c => c.bridgeRoomId === activeCase);
    if (!caseData) return;
    // Find vault room for client (from bridge meta)
    const bridgeMeta = caseData.meta;
    const clientId = bridgeMeta?.client;
    // Find client vault room from scanned state
    let vaultRoomId = null;
    if (svc.client) {
      for (const room of svc.client.getRooms()) {
        const idEv = room.currentState.getStateEvents(EVT.IDENTITY, '');
        if (idEv) {
          const content = idEv.getContent();
          if (content.account_type === 'client' && content.owner === clientId) {
            vaultRoomId = room.roomId;
            break;
          }
        }
      }
    }
    // Find the relation for this resource type
    const relation = resourceRelations.find(r => r.resource_type_id === allocDraft.resource_type_id);
    const holderRoom = orgRoom || rosterRoom;
    try {
      const result = await ResourceService.allocateResource(activeCase, {
        resource_type_id: allocDraft.resource_type_id,
        relation_id: relation?.id || null,
        quantity: parseInt(allocDraft.quantity) || 1,
        allocated_to: clientId,
        notes: allocDraft.notes || null
      }, holderRoom, vaultRoomId);
      if (!result.valid) {
        const msgs = result.violations.map(v => v.message).join('; ');
        showToast(`Allocation blocked: ${msgs}`, 'error');
        return;
      }
      setAllocModal(false);
      setAllocDraft({
        resource_type_id: '',
        quantity: 1,
        notes: ''
      });
      showToast('Resource allocated successfully', 'success');
      setTimeout(() => {
        loadCaseAllocations(activeCase);
        loadResources(orgRoom, networkRoom, rosterRoom);
      }, 800);
    } catch (e) {
      showToast('Error allocating resource: ' + e.message, 'error');
    }
  };

  // ─── Allocate resource from individual profile page ───
  const handleProfileAllocate = async (bridgeRoomId, allocData) => {
    if (!allocData.resource_type_id || !bridgeRoomId || !(orgRoom || rosterRoom)) return false;
    const caseData = cases.find(c => c.bridgeRoomId === bridgeRoomId);
    if (!caseData) {
      showToast('No case found for this individual', 'error');
      return false;
    }
    const bridgeMeta = caseData.meta;
    const clientId = bridgeMeta?.client;
    let vaultRoomId = null;
    if (svc.client) {
      for (const room of svc.client.getRooms()) {
        const idEv = room.currentState.getStateEvents(EVT.IDENTITY, '');
        if (idEv) {
          const content = idEv.getContent();
          if (content.account_type === 'client' && content.owner === clientId) {
            vaultRoomId = room.roomId;
            break;
          }
        }
      }
    }
    const relation = resourceRelations.find(r => r.resource_type_id === allocData.resource_type_id);
    const holderRoom = orgRoom || rosterRoom;
    try {
      const result = await ResourceService.allocateResource(bridgeRoomId, {
        resource_type_id: allocData.resource_type_id,
        relation_id: relation?.id || null,
        quantity: parseInt(allocData.quantity) || 1,
        allocated_to: clientId,
        notes: allocData.notes || null
      }, holderRoom, vaultRoomId);
      if (!result.valid) {
        const msgs = result.violations.map(v => v.message).join('; ');
        showToast(`Allocation blocked: ${msgs}`, 'error');
        return false;
      }
      showToast('Resource allocated successfully', 'success');
      setTimeout(() => {
        loadDataTableExtras(cases);
        loadResources(orgRoom, networkRoom, rosterRoom);
      }, 800);
      return true;
    } catch (e) {
      showToast('Error allocating resource: ' + e.message, 'error');
      return false;
    }
  };

  // ─── Record lifecycle event (consumed, revoked, returned) ───
  const handleResourceLifecycle = async (allocationId, eventType) => {
    if (!activeCase || !(orgRoom || rosterRoom)) return;
    const alloc = caseAllocations.find(a => a.id === allocationId);
    if (!alloc) return;
    const caseData = cases.find(c => c.bridgeRoomId === activeCase);
    const clientId = caseData?.meta?.client;
    let vaultRoomId = null;
    if (clientId && svc.client) {
      for (const room of svc.client.getRooms()) {
        const idEv = room.currentState.getStateEvents(EVT.IDENTITY, '');
        if (idEv) {
          const content = idEv.getContent();
          if (content.account_type === 'client' && content.owner === clientId) {
            vaultRoomId = room.roomId;
            break;
          }
        }
      }
    }
    const holderRoom = orgRoom || rosterRoom;
    try {
      await ResourceService.recordResourceEvent(activeCase, {
        allocation_id: allocationId,
        event: eventType,
        quantity: alloc.quantity
      }, holderRoom, vaultRoomId);
      showToast(`Resource marked as ${eventType}`, 'success');
      setTimeout(() => {
        loadCaseAllocations(activeCase);
        loadResources(orgRoom, networkRoom, rosterRoom);
      }, 800);
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  };

  // ─── Restock inventory ───
  const handleRestock = async () => {
    const holderRoom = orgRoom || rosterRoom;
    if (!restockModal || !restockQty || !holderRoom) return;
    try {
      await ResourceService.restockInventory(holderRoom, restockModal.id, parseInt(restockQty), {
        note: restockNote || undefined,
        restocked_by: svc.userId
      });
      setRestockModal(null);
      setRestockQty('');
      setRestockNote('');
      showToast('Inventory restocked', 'success');
      setTimeout(() => loadResources(orgRoom, networkRoom, rosterRoom), 800);
    } catch (e) {
      showToast('Error restocking: ' + e.message, 'error');
    }
  };

  // INS(org.room, {identity, metadata, roster}) — organization_creation + DES(org.schema, {seeded_forms, definitions}) — local_vocabulary + INS(org.staff_roster, {creator_as_admin}) — initial_membership
  const handleCreateOrg = async () => {
    if (!setupData.name.trim()) return;
    try {
      const org = await svc.createRoom(`[Khora Org] ${setupData.name}`, `Organization: ${setupData.name}`, [{
        type: EVT.IDENTITY,
        state_key: '',
        content: {
          account_type: 'organization',
          owner: svc.userId,
          created: Date.now()
        }
      }, {
        type: EVT.ORG_METADATA,
        state_key: '',
        content: {
          name: setupData.name,
          type: setupData.type,
          service_area: setupData.service_area,
          languages: setupData.languages.split(',').map(s => s.trim()),
          created: Date.now()
        }
      }, {
        type: EVT.ORG_ROSTER,
        state_key: '',
        content: {
          staff: [{
            userId: svc.userId,
            role: 'admin',
            joined: Date.now()
          }]
        }
      }, {
        type: EVT.ORG_ROLES,
        state_key: '',
        content: {
          roles: DOMAIN_CONFIG.defaultOrgRoles
        }
      }, {
        type: EVT.ROSTER_ASSIGN,
        state_key: '',
        content: {}
      }, {
        type: EVT.ORG_OPACITY,
        state_key: '',
        content: {
          level: 'translucent',
          updated: Date.now(),
          updated_by: svc.userId
        }
      }, {
        type: EVT.ORG_MSG_ACCESS,
        state_key: '',
        content: {
          read: ['admin', 'case_manager'],
          respond: ['admin'],
          updated: Date.now()
        }
      }]);
      await emitOp(org, 'DES', dot('org', 'organization'), {
        designation: setupData.name,
        type: setupData.type,
        service_area: setupData.service_area
      }, orgFrame(org));
      await emitOp(org, 'INS', dot('org', 'staff', svc.userId), {
        role: 'admin',
        initiated_by: 'org_creation'
      }, orgFrame(org));
      setOrgRoom(org);
      setOrgRole('admin');
      setOrgMeta({
        name: setupData.name,
        type: setupData.type,
        service_area: setupData.service_area
      });
      setStaff([{
        userId: svc.userId,
        role: 'admin',
        joined: Date.now()
      }]);
      setCreateOrgModal(false);
      setSetupData({
        name: '',
        type: 'direct_service',
        service_area: '',
        languages: 'en'
      });
      showToast(`Organization "${setupData.name}" created`, 'success');
      // Create supporting rooms for org
      const orgMetricsR = await svc.createRoom('[Khora Metrics]', 'Org anonymized metrics', [{
        type: EVT.IDENTITY,
        state_key: '',
        content: {
          account_type: 'metrics',
          owner: svc.userId,
          created: Date.now()
        }
      }]);
      const orgSchema = await svc.createRoom('[Khora Schema]', 'Org schema definitions', [{
        type: EVT.IDENTITY,
        state_key: '',
        content: {
          account_type: 'schema',
          owner: svc.userId,
          created: Date.now()
        }
      }]);
      // Forms — GIVEN data collection (propagated to clients through providers)
      for (const f of DEFAULT_FORMS) await svc.setState(orgSchema, EVT.SCHEMA_FORM, f, f.id);
      for (const p of DEFAULT_PROMPTS) await svc.setState(orgSchema, EVT.SCHEMA_PROMPT, p, p.key);
      // Interpretations — MEANT assessments, definitions, authorities
      for (const pp of DEFAULT_PROVIDER_PROMPTS) await svc.setState(orgSchema, EVT.SCHEMA_ASSESSMENT, pp, pp.key);
      for (const d of DEFAULT_DEFINITIONS) await svc.setState(orgSchema, EVT.SCHEMA_DEF, d, d.key);
      for (const a of DEFAULT_AUTHORITIES) await svc.setState(orgSchema, EVT.SCHEMA_AUTHORITY, a, a.id);
      await svc.setState(orgSchema, EVT.SCHEMA_TRANSFORM, {
        id: 'transform_default',
        transforms: DEFAULT_TRANSFORMS
      }, 'default');
      // Link supporting room IDs back to the org so other members can discover them
      try {
        await svc.setState(org, EVT.ORG_METADATA, {
          name: setupData.name,
          type: setupData.type,
          service_area: setupData.service_area,
          languages: setupData.languages.split(',').map(s => s.trim()),
          created: Date.now(),
          metrics_room: orgMetricsR,
          schema_room: orgSchema
        });
      } catch (e) {
        console.warn('Org metadata linkage:', e.message);
      }
    } catch (e) {
      showToast('Error creating org: ' + e.message, 'error');
    }
  };
  const handleJoinOrg = async () => {
    if (!joinOrgId.trim()) return;
    try {
      if (svc.client) {
        await svc.client.joinRoom(joinOrgId);
      } else {
        await svc._api('POST', `/join/${encodeURIComponent(joinOrgId)}`, {});
      }
      // Load the org metadata
      const meta = await svc.getState(joinOrgId, EVT.ORG_METADATA);
      const roster = await svc.getState(joinOrgId, EVT.ORG_ROSTER);
      let entry = roster?.staff?.find(s => s.userId === svc.userId);
      // Add user to roster if not already present (pending admin role assignment)
      if (!entry) {
        const staffList = roster?.staff || [];
        entry = { userId: svc.userId, role: 'pending', joined: Date.now() };
        staffList.push(entry);
        try {
          await svc.setState(joinOrgId, EVT.ORG_ROSTER, { staff: staffList });
          await emitOp(joinOrgId, 'CON', dot('org', 'staff', svc.userId), {
            action: 'join_request',
            role: 'pending'
          }, orgFrame(joinOrgId));
        } catch (e) {
          console.warn('Roster self-add:', e.message);
        }
      }
      setOrgRoom(joinOrgId);
      setOrgRole(entry?.role || 'pending');
      if (meta) setOrgMeta(meta);
      const updatedRoster = await svc.getState(joinOrgId, EVT.ORG_ROSTER);
      if (updatedRoster?.staff) setStaff(updatedRoster.staff);
      setJoinOrgModal(false);
      setJoinOrgId('');
      showToast(`Joined organization${meta?.name ? ' "' + meta.name + '"' : ''}`, 'success');
    } catch (e) {
      if (e.message?.includes('forbidden') || e.message?.includes('not invited')) {
        showToast('Cannot join — you must be invited by an org admin first. Share your Matrix ID with them.', 'error');
      } else {
        showToast('Failed to join org: ' + e.message, 'error');
      }
    }
  };

  // CON(org.staff.{userId}, {invitation}) — staff_onboarding — invites user and adds to roster
  const handleInviteStaff = async () => {
    if (!inviteUserId.trim() || !orgRoom) return;
    if (!isValidMatrixId(inviteUserId)) {
      showToast('Invalid Matrix ID — use format @user:server', 'error');
      return;
    }
    try {
      await svc.invite(orgRoom, inviteUserId);
      const newStaff = [...staff, {
        userId: inviteUserId,
        role: inviteRole,
        joined: Date.now()
      }];
      await svc.setState(orgRoom, EVT.ORG_ROSTER, {
        staff: newStaff
      });
      await emitOp(orgRoom, 'CON', dot('org', 'staff', inviteUserId), {
        relationship: 'staff',
        role: inviteRole,
        invited_by: svc.userId
      }, orgFrame());
      setStaff(newStaff);
      setInviteModal(false);
      setInviteUserId('');
      showToast(`Invited ${inviteUserId} as ${activeOrgRoleLabels[inviteRole]}`, 'success');
    } catch (e) {
      showToast('Invite failed: ' + e.message, 'error');
    }
  };

  // NUL(org.staff_member, {reason: removed}) — membership_severance — kicks from room and removes from roster
  const handleRemoveStaff = async userId => {
    if (userId === svc.userId) {
      showToast('Cannot remove yourself', 'error');
      return;
    }
    try {
      await svc.kick(orgRoom, userId, 'Removed from organization');
      const newStaff = staff.filter(s => s.userId !== userId);
      await svc.setState(orgRoom, EVT.ORG_ROSTER, {
        staff: newStaff
      });
      await emitOp(orgRoom, 'NUL', dot('org', 'staff', userId), {
        reason: 'removed',
        removed_by: svc.userId
      }, orgFrame());
      setStaff(newStaff);
      showToast(`Removed ${userId}`, 'warn');
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  };

  // ─── Email verification management ───
  const handleSaveEmailVerifyConfig = async () => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      const config = {
        enabled: emailConfigDraft.enabled,
        required_domains: emailConfigDraft.required_domains.filter(d => d.trim()),
        require_for_roles: emailConfigDraft.require_for_roles,
        grace_period_hours: emailConfigDraft.grace_period_hours || 72
      };
      await svc.setState(orgRoom, EVT.ORG_EMAIL_CONFIG, config);
      setEmailVerifyConfig(config);
      await emitOp(orgRoom, 'ALT', dot('org', 'email_verification_config', 'enabled'), {
        value: config.enabled,
        domains: config.required_domains,
        roles: config.require_for_roles
      }, orgFrame());
      setEmailConfigModal(false);
      showToast(`Email verification ${config.enabled ? 'enabled' : 'disabled'}`, 'success');
    } catch (e) {
      showToast('Error saving config: ' + e.message, 'error');
    }
  };

  // INS(org.email_challenge, {hashed_code, webhook}) — verification_initiation → CON(org.email_code, {dest: email_inbox, via: webhook}) — out_of_band_delivery
  const handleStartEmailVerify = async () => {
    if (!verifyEmail.trim() || !orgRoom) return;
    setVerifyError('');
    if (!EmailVerification.isValidEmail(verifyEmail)) {
      setVerifyError('Please enter a valid email address');
      return;
    }
    if (emailVerifyConfig.required_domains?.length > 0 && !EmailVerification.domainMatches(verifyEmail, emailVerifyConfig.required_domains)) {
      setVerifyError(`Email must be from: ${emailVerifyConfig.required_domains.join(', ')}`);
      return;
    }
    setVerifyPending(true);
    try {
      const {
        challenge,
        plainCode
      } = await EmailVerification.createChallenge(svc.userId, verifyEmail);
      // Store challenge in org room state (hashed code only)
      await svc.setState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, challenge, svc.userId);
      // Attempt to deliver via webhook; fall back to Matrix DM display
      const sent = await EmailVerification.sendCodeViaWebhook(verifyEmail, plainCode, orgMeta.name || 'Organization');
      if (!sent) {
        // Fallback: show code in-app for development/demo (in production, email infra handles this)
        showToast(`Verification code: ${plainCode} (demo mode — production sends via email)`, 'info', 12000);
      } else {
        showToast('Verification code sent to ' + verifyEmail, 'success');
      }
      await emitOp(orgRoom, 'INS', dot('org', 'email_verification', svc.userId), {
        email_domain: EmailVerification.extractDomain(verifyEmail),
        status: 'pending'
      }, orgFrame());
      setVerifyStep('code');
    } catch (e) {
      setVerifyError('Failed to start verification: ' + e.message);
    }
    setVerifyPending(false);
  };

  // DES(org.email_identity, {attestation: code_validated}) — verified_attestation on success | ALT(org.challenge.attempts, {increment: +1}) — lockout_progression on failure
  const handleSubmitVerifyCode = async () => {
    if (!verifyCode.trim() || verifyCode.length !== 6 || !orgRoom) return;
    setVerifyError('');
    setVerifyPending(true);
    try {
      // Fetch the stored challenge
      const challenge = await svc.getState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, svc.userId);
      const result = await EmailVerification.validateChallenge(challenge, verifyCode);
      if (!result.valid) {
        // Update attempt count
        if (result.reason === 'incorrect_code') {
          const updated = {
            ...challenge,
            attempts: (challenge.attempts || 0) + 1
          };
          await svc.setState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, updated, svc.userId);
          setVerifyError(`Incorrect code (${updated.attempts}/${challenge.max_attempts} attempts)`);
        } else if (result.reason === 'expired') {
          setVerifyError('Code expired. Please request a new one.');
          setVerifyStep('email');
        } else if (result.reason === 'max_attempts') {
          setVerifyError('Too many attempts. Please request a new code.');
          setVerifyStep('email');
        } else {
          setVerifyError('Verification failed. Please try again.');
        }
        setVerifyPending(false);
        return;
      }
      // Success — update roster with verified status
      const verifiedEntry = {
        status: 'verified',
        email: verifyEmail.trim().toLowerCase(),
        domain: EmailVerification.extractDomain(verifyEmail),
        verified_at: Date.now()
      };
      const newStaff = staff.map(s => s.userId === svc.userId ? {
        ...s,
        email_verification: verifiedEntry
      } : s);
      await svc.setState(orgRoom, EVT.ORG_ROSTER, {
        staff: newStaff
      });
      // Clear the challenge
      await svc.setState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, {
        status: 'completed',
        verified_at: Date.now()
      }, svc.userId);
      await emitOp(orgRoom, 'ALT', dot('org', 'email_verification', svc.userId), {
        value: 'verified',
        email_domain: EmailVerification.extractDomain(verifyEmail),
        verified_at: Date.now()
      }, orgFrame());
      setStaff(newStaff);
      setMyVerification(verifiedEntry);
      setVerifyStep('done');
      showToast('Email verified successfully', 'success');
    } catch (e) {
      setVerifyError('Verification error: ' + e.message);
    }
    setVerifyPending(false);
  };

  // NUL(org.verification, {reason: admin_revoked}) — attestation_destruction — admin removes verified status
  const handleRevokeVerification = async userId => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      const newStaff = staff.map(s => s.userId === userId ? {
        ...s,
        email_verification: {
          status: 'revoked',
          revoked_at: Date.now(),
          revoked_by: svc.userId
        }
      } : s);
      await svc.setState(orgRoom, EVT.ORG_ROSTER, {
        staff: newStaff
      });
      await emitOp(orgRoom, 'NUL', dot('org', 'email_verification', userId), {
        reason: 'admin_revoked',
        revoked_by: svc.userId
      }, orgFrame());
      setStaff(newStaff);
      if (userId === svc.userId) setMyVerification({
        status: 'revoked'
      });
      showToast(`Revoked verification for ${userId}`, 'warn');
    } catch (e) {
      showToast('Error revoking: ' + e.message, 'error');
    }
  };
  const openEmailVerifyModal = () => {
    setVerifyEmail('');
    setVerifyCode('');
    setVerifyStep('email');
    setVerifyError('');
    setVerifyPending(false);
    setEmailVerifyModal(true);
  };

  // ─── Provider profile management ───
  const handleSaveProfile = async () => {
    if (!rosterRoom) return;
    try {
      const profile = {
        display_name: profileDraft.display_name.trim(),
        title: profileDraft.title.trim(),
        credentials: profileDraft.credentials.trim(),
        bio: profileDraft.bio.trim(),
        service_types: profileDraft.service_types.trim(),
        org_membership: orgRoom ? {
          org_room_id: orgRoom,
          org_name: orgMeta.name || '',
          org_type: orgMeta.type || '',
          role: orgRole || '',
          verified: myVerification?.status === 'verified' || !emailVerifyConfig.enabled,
          email_verified: myVerification?.status === 'verified',
          verified_email: myVerification?.status === 'verified' ? myVerification.email : null,
          verified_domain: myVerification?.status === 'verified' ? myVerification.domain : null
        } : null,
        updated: Date.now()
      };
      await svc.setState(rosterRoom, EVT.PROVIDER_PROFILE, profile);
      await emitOp(rosterRoom, 'ALT', dot('org', 'provider_profile', 'profile'), {
        display_name: profile.display_name,
        title: profile.title,
        updated_by: svc.userId
      }, orgFrame());
      setProviderProfile(profile);
      setProfileModal(false);
      showToast('Profile saved', 'success');
      // Background sync to bridges — non-blocking
      for (const c of cases) {
        svc.setState(c.bridgeRoomId, EVT.PROVIDER_PROFILE, profile)
          .catch(e => console.warn('Profile sync to bridge failed', c.bridgeRoomId, e.message));
      }
    } catch (e) {
      showToast('Failed to save profile: ' + e.message, 'error');
    }
  };
  const openProfileModal = () => {
    setProfileDraft({
      display_name: providerProfile.display_name || '',
      title: providerProfile.title || '',
      credentials: providerProfile.credentials || '',
      bio: providerProfile.bio || '',
      service_types: providerProfile.service_types || ''
    });
    setProfileModal(true);
  };

  // ─── Inter-org messaging ───

  // Check if current user has permission for an org messaging action
  const hasOrgMsgPermission = useCallback(action => {
    // action: 'read' or 'respond'
    if (!orgRole) return false;
    const allowed = orgMsgAccess[action] || [];
    return allowed.includes(orgRole);
  }, [orgRole, orgMsgAccess]);

  // Build opacity-aware envelope for inter-org messages.
  // transparent: reveals org room ID, org name, sender ID, sender name
  // translucent: reveals org name only (not room ID or sender identity)
  // opaque: reveals nothing about the sender org
  const buildOpacityEnvelope = useCallback(() => ({
    [`${NS}.type`]: 'org_message',
    [`${NS}.envelope`]: {
      opacity: orgOpacity,
      org_room_id: orgOpacity === 'transparent' ? orgRoom : undefined,
      org_name: orgOpacity !== 'opaque' ? orgMeta.name || undefined : undefined,
      sender_id: orgOpacity === 'transparent' ? svc.userId : undefined,
      sender_name: orgOpacity === 'transparent' ? providerProfile.display_name || undefined : undefined,
      ts: Date.now()
    }
  }), [orgOpacity, orgRoom, orgMeta.name, providerProfile.display_name]);

  // Save opacity setting (admin only)
  const handleSaveOpacity = async level => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      await svc.setState(orgRoom, EVT.ORG_OPACITY, {
        level,
        updated: Date.now(),
        updated_by: svc.userId
      });
      setOrgOpacity(level);
      await emitOp(orgRoom, 'ALT', dot('org', 'opacity', 'level'), {
        from: orgOpacity,
        to: level,
        changed_by: svc.userId
      }, orgFrame());
      showToast(`Opacity set to ${OPACITY_LABELS[level]}`, 'success');
    } catch (e) {
      showToast('Failed to update opacity: ' + e.message, 'error');
    }
  };

  // Save message access settings (admin only)
  const handleSaveMsgAccess = async () => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      await svc.setState(orgRoom, EVT.ORG_MSG_ACCESS, {
        ...msgAccessDraft,
        updated: Date.now()
      });
      setOrgMsgAccess(msgAccessDraft);
      await emitOp(orgRoom, 'ALT', dot('org', 'msg_access', 'roles'), {
        read: msgAccessDraft.read,
        respond: msgAccessDraft.respond
      }, orgFrame());
      setMsgAccessModal(false);
      showToast('Message access roles updated', 'success');
    } catch (e) {
      showToast('Failed to update access: ' + e.message, 'error');
    }
  };

  // Save org terminology customization (admin only)
  const handleSaveTerminology = async () => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      const payload = {
        ...terminologyDraft,
        updated: Date.now(),
        updated_by: svc.userId
      };
      await svc.setState(orgRoom, EVT.ORG_TERMINOLOGY, payload);
      setOrgTerminology({
        ...TERMINOLOGY_DEFAULTS,
        ...terminologyDraft
      });
      setTerminologyModal(false);
      await emitOp(orgRoom, 'ALT', dot('org', 'terminology', 'terms'), {
        client_term: terminologyDraft.client_term,
        provider_term: terminologyDraft.provider_term,
        staff_term: terminologyDraft.staff_term,
        changed_by: svc.userId
      }, orgFrame());
      showToast('Terminology updated', 'success');
    } catch (e) {
      showToast('Failed to update terminology: ' + e.message, 'error');
    }
  };

  // Reset terminology to defaults
  const handleResetTerminology = () => {
    setTerminologyDraft({
      ...TERMINOLOGY_DEFAULTS
    });
  };

  // Save org custom roles (admin only)
  const handleSaveOrgRoles = async (roles) => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      await svc.setState(orgRoom, EVT.ORG_ROLES, { roles, updated: Date.now(), updated_by: svc.userId });
      setOrgRolesConfig(roles);
      await emitOp(orgRoom, 'ALT', dot('org', 'roles', 'config'), { role_count: roles.length, changed_by: svc.userId }, orgFrame());
      showToast('Roles updated', 'success');
    } catch (e) {
      showToast('Failed to update roles: ' + e.message, 'error');
    }
  };

  // Delete an org role (admin only, not the protected admin role)
  const handleDeleteRole = async (roleKey) => {
    if (!orgRoom || orgRole !== 'admin') return;
    const role = orgRolesConfig.find(r => r.key === roleKey);
    if (role?.protected) { showToast('Cannot delete the Admin role', 'warn'); return; }
    const usersWithRole = staff.filter(s => s.role === roleKey);
    if (usersWithRole.length > 0) {
      showToast(`Cannot delete role — ${usersWithRole.length} ${usersWithRole.length === 1 ? 'member has' : 'members have'} this role. Reassign them first.`, 'warn');
      return;
    }
    const updated = orgRolesConfig.filter(r => r.key !== roleKey);
    await handleSaveOrgRoles(updated);
  };

  // Add a new custom org role
  const handleAddRole = async () => {
    if (!newRoleDraft.label.trim()) return;
    let key = newRoleDraft.label.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
    // Ensure uniqueness
    while (orgRolesConfig.some(r => r.key === key)) { key += '_1'; }
    const updated = [...orgRolesConfig, { key, label: newRoleDraft.label.trim(), description: newRoleDraft.description.trim() || 'Custom role.' }];
    await handleSaveOrgRoles(updated);
    setNewRoleDraft({ label: '', description: '' });
    setAddRoleModal(false);
  };

  // Save edits to an existing role (label/description)
  const handleSaveRoleEdit = async () => {
    if (!editingRole) return;
    const updated = orgRolesConfig.map(r => r.key === editingRole.key ? { ...r, label: editingRole.label.trim(), description: editingRole.description.trim() } : r);
    await handleSaveOrgRoles(updated);
    setEditingRole(null);
  };

  // Create org-to-org messaging channel
  const handleCreateOrgChannel = async () => {
    if (!orgRoom || !composePeerOrgId.trim()) return;
    // Check for existing channel
    const existing = orgChannels.find(c => c.orgs?.includes(composePeerOrgId.trim()));
    if (existing) {
      setActiveChannel(existing.roomId);
      setView('org-inbox');
      setComposeOrgModal(false);
      showToast('Channel already exists — opened', 'info');
      return;
    }
    try {
      const peerOrgId = composePeerOrgId.trim();
      const channelRoom = await svc.createRoom(`[Khora Org Msg] ${orgMeta.name || 'Org'} ↔ ${composePeerOrgName || peerOrgId.slice(0, 12)}`, 'Inter-org messaging channel', [{
        type: EVT.IDENTITY,
        state_key: '',
        content: {
          account_type: 'org_msg_channel',
          created: Date.now()
        }
      }, {
        type: EVT.ORG_MSG_CHANNEL,
        state_key: '',
        content: {
          type: 'org_msg_channel',
          orgs: [orgRoom, peerOrgId],
          org_names: {
            [orgRoom]: orgMeta.name || '',
            [peerOrgId]: composePeerOrgName || ''
          },
          created: Date.now(),
          created_by: svc.userId
        }
      }]);
      // Invite eligible staff from the peer org (not the room ID — Matrix can't invite rooms)
      try {
        const peerRoster = await svc.getState(peerOrgId, EVT.ORG_ROSTER);
        const peerStaff = peerRoster?.staff || [];
        const peerMsgAccess = await svc.getState(peerOrgId, EVT.ORG_MSG_ACCESS);
        const readRoles = peerMsgAccess?.read || ['admin', 'case_manager'];
        let invited = 0;
        for (const s of peerStaff.filter(s => readRoles.includes(s.role))) {
          try { await svc.invite(channelRoom, s.userId); invited++; } catch {}
        }
        if (invited === 0 && peerStaff.length > 0) {
          // Fallback: invite all staff if no role-filtered matches
          for (const s of peerStaff) {
            try { await svc.invite(channelRoom, s.userId); invited++; } catch {}
          }
        }
        if (invited === 0) {
          showToast('Channel created but could not invite peer org staff — they may need to join manually', 'warn');
        }
      } catch (e) {
        console.warn('Peer org staff invite:', e.message);
        showToast('Channel created but peer org roster not readable — share the channel ID with them', 'warn');
      }
      await emitOp(channelRoom, 'INS', dot('org', 'channels', 'channel'), {
        from_org: orgRoom,
        to_org: peerOrgId
      }, orgFrame());
      const newChannel = {
        roomId: channelRoom,
        orgs: [orgRoom, peerOrgId],
        org_names: {
          [orgRoom]: orgMeta.name || '',
          [peerOrgId]: composePeerOrgName || ''
        },
        type: 'org_msg_channel',
        created: Date.now()
      };
      setOrgChannels(prev => [...prev, newChannel]);
      setActiveChannel(channelRoom);
      setView('org-inbox');
      setComposeOrgModal(false);
      setComposePeerOrgId('');
      setComposePeerOrgName('');
      showToast('Messaging channel created', 'success');
    } catch (e) {
      showToast('Failed to create channel: ' + e.message, 'error');
    }
  };

  // Load messages for an org channel
  const loadChannelMessages = async channelRoomId => {
    if (!channelRoomId) return;
    const msgs = await svc.getMessages(channelRoomId);
    setChannelMessages(msgs);
  };

  // Send a message in an org channel — applies opacity envelope
  const handleSendOrgMsg = async () => {
    if (!orgMsgText.trim() || !activeChannel) return;
    if (!hasOrgMsgPermission('respond')) {
      showToast('You do not have permission to send org messages', 'warn');
      return;
    }
    try {
      const envelope = buildOpacityEnvelope();
      await svc.sendMessage(activeChannel, orgMsgText, envelope);
      await emitOp(activeChannel, 'INS', dot('org', 'messages', 'org_message'), {
        opacity: orgOpacity,
        body_length: orgMsgText.length
      }, orgFrame());
      setOrgMsgText('');
      setTimeout(() => loadChannelMessages(activeChannel), 500);
    } catch (e) {
      showToast('Send failed: ' + e.message, 'error');
    }
  };

  // Open a channel
  const openChannel = channelRoomId => {
    setActiveChannel(channelRoomId);
    setView('org-inbox');
    loadChannelMessages(channelRoomId);
  };

  // Resolve display info for a message based on opacity
  const resolveMessageSender = useCallback(msg => {
    const env = msg.content?.[`${NS}.envelope`];
    if (!env) return {
      label: msg.sender === svc.userId ? 'You' : msg.sender,
      isOwn: msg.sender === svc.userId
    };
    const isOwn = msg.sender === svc.userId || env.org_room_id === orgRoom;
    switch (env.opacity) {
      case 'transparent':
        return {
          label: env.sender_name || env.sender_id || 'Unknown',
          org: env.org_name,
          isOwn
        };
      case 'translucent':
        return {
          label: env.org_name || 'Organization',
          org: env.org_name,
          isOwn
        };
      case 'opaque':
        return {
          label: 'An organization',
          org: null,
          isOwn
        };
      default:
        return {
          label: msg.sender,
          isOwn
        };
    }
  }, [orgRoom]);

  // ─── Inbox chat functions ───
  const loadInboxMessages = async roomId => {
    setInboxMessages(await svc.getMessages(roomId));
  };
  const openInboxConvo = roomId => {
    setInboxConvo(roomId);
    loadInboxMessages(roomId);
  };
  const handleSendInboxMsg = async () => {
    if (!inboxMsgText.trim() || !inboxConvo) return;
    const isOrgChannel = orgChannels.some(ch => ch.roomId === inboxConvo);
    if (isOrgChannel) {
      if (!hasOrgMsgPermission('respond')) {
        showToast('You do not have permission to send org messages', 'warn');
        return;
      }
      const envelope = buildOpacityEnvelope();
      await svc.sendMessage(inboxConvo, inboxMsgText, envelope);
      await emitOp(inboxConvo, 'INS', dot('org', 'messages', 'org_message'), {
        opacity: orgOpacity,
        body_length: inboxMsgText.length
      }, orgFrame());
    } else if (teamDMs.some(d => d.roomId === inboxConvo)) {
      await svc.sendMessage(inboxConvo, inboxMsgText, {
        [`${NS}.type`]: 'team_dm',
        [`${NS}.sender_name`]: providerProfile.display_name || svc.userId
      });
    } else {
      await svc.sendMessage(inboxConvo, inboxMsgText, {
        [`${NS}.type`]: 'note'
      });
      await emitOp(inboxConvo, 'INS', dot('bridge', 'messages', 'provider_note'), {
        body: inboxMsgText
      }, bridgeFrame(inboxConvo));
    }
    setInboxMsgText('');
    setTimeout(() => loadInboxMessages(inboxConvo), 500);
  };
  // ─── Message group (bucket) functions ───
  const saveMsgBuckets = nb => { setMsgBuckets(nb); try { localStorage.setItem('khora_msg_buckets', JSON.stringify(nb)); } catch {} };
  const createMsgBucket = label => { const b = { id: Date.now().toString(36), label: label.trim(), roomIds: [] }; saveMsgBuckets([...msgBuckets, b]); };
  const assignToBucket = (roomId, bucketId) => { saveMsgBuckets(msgBuckets.map(b => b.id === bucketId ? { ...b, roomIds: [...new Set([...b.roomIds, roomId])] } : { ...b, roomIds: b.roomIds.filter(r => r !== roomId) })); setAssignBucketTarget(null); };
  const removeFromBuckets = roomId => { saveMsgBuckets(msgBuckets.map(b => ({ ...b, roomIds: b.roomIds.filter(r => r !== roomId) }))); setAssignBucketTarget(null); };
  const deleteMsgBucket = id => saveMsgBuckets(msgBuckets.filter(b => b.id !== id));
  // ─── Team member DM functions ───
  const startTeamDM = async (peerId, peerName, teamName, teamRoomId) => {
    // Check if DM room already exists
    const existing = teamDMs.find(d => d.peerId === peerId);
    if (existing) {
      setInboxTab('team');
      openInboxConvo(existing.roomId);
      return;
    }
    try {
      const roomId = await svc.createRoom(`[Khora DM] ${svc.userId} ↔ ${peerId}`, 'Direct message between connected users', [{
        type: EVT.DM_META,
        state_key: '',
        content: {
          initiator: svc.userId,
          target: peerId,
          team_name: teamName || null,
          team_room_id: teamRoomId || null,
          org_name: orgMeta?.name || null,
          peer_names: {
            [svc.userId]: providerProfile.display_name || svc.userId,
            [peerId]: peerName || peerId
          },
          peer_type: 'provider',
          created: Date.now()
        }
      }]);
      await svc.invite(roomId, peerId);
      const newDM = {
        roomId,
        peerId,
        peerName: peerName || peerId,
        teamName: teamName || null,
        teamRoomId: teamRoomId || null,
        orgName: orgMeta?.name || null,
        peerType: 'provider'
      };
      setTeamDMs(prev => [...prev, newDM]);
      setNewTeamDMModal(false);
      setNewDMTarget(null);
      setInboxTab('team');
      openInboxConvo(roomId);
      showToast(`DM created — invite sent to ${peerName || peerId}`, 'success');
    } catch (e) {
      showToast('Failed to create DM: ' + e.message, 'error');
    }
  };
  // Build list of all messageable team members (excluding self)
  const teamMemberContacts = useMemo(() => {
    const contacts = [];
    const seen = new Set();
    for (const team of teams) {
      for (const m of (team.members || [])) {
        if (m.userId === svc.userId || seen.has(m.userId)) continue;
        seen.add(m.userId);
        contacts.push({
          userId: m.userId,
          displayName: m.display_name || m.userId,
          teamName: team.name,
          teamRoomId: team.roomId,
          role: m.role,
          hasDM: teamDMs.some(d => d.peerId === m.userId)
        });
      }
    }
    return contacts;
  }, [teams, teamDMs]);

  const getInboxConvoName = useCallback(roomId => {
    const c = cases.find(c => c.bridgeRoomId === roomId);
    if (c) return c.sharedData.full_name || c.clientUserId;
    const ch = orgChannels.find(ch => ch.roomId === roomId);
    if (ch) {
      const peerOrgId = ch.orgs?.find(o => o !== orgRoom);
      return ch.org_names?.[peerOrgId] || peerOrgId?.slice(0, 20) || 'Organization';
    }
    const dm = teamDMs.find(d => d.roomId === roomId);
    if (dm) return dm.peerName || dm.peerId;
    return roomId?.slice(0, 20) || 'Unknown';
  }, [cases, orgChannels, orgRoom, teamDMs]);
  const getInboxConvoType = useCallback(roomId => {
    if (cases.some(c => c.bridgeRoomId === roomId)) return 'case';
    if (orgChannels.some(ch => ch.roomId === roomId)) return 'channel';
    if (teamDMs.some(d => d.roomId === roomId)) return 'team_dm';
    return 'unknown';
  }, [cases, orgChannels, teamDMs]);

  // Determine network role based on org membership
  const networkRole = useMemo(() => {
    if (!networkRoom || !orgRoom) return null;
    const myOrg = networkMembers.find(m => m.id === orgRoom || m.id === svc.userId);
    return myOrg?.role || 'member';
  }, [networkRoom, orgRoom, networkMembers]);
  const openCase = bid => {
    setView('case');
    setActiveCase(bid);
    loadMessages(bid);
    loadProviderObservations(bid);
    loadCaseAllocations(bid);
  };
  const activeCaseData = cases.find(c => c.bridgeRoomId === activeCase);

  if (loading) return /*#__PURE__*/React.createElement("div", {
    style: {
      height: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement(Spin, {
    s: 28
  }));
  if (initError) return /*#__PURE__*/React.createElement("div", {
    style: {
      height: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      maxWidth: 400,
      padding: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 48,
      height: 48,
      borderRadius: 'var(--r-lg)',
      background: 'var(--red-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--red)',
      margin: '0 auto 16px'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "alert-triangle",
    s: 24
  })), /*#__PURE__*/React.createElement("h3", {
    style: {
      fontSize: 16,
      fontWeight: 700,
      marginBottom: 8
    }
  }, "Provider Setup Failed"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6,
      marginBottom: 16
    }
  }, initError), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: initProvider,
    className: "b-pri"
  }, /*#__PURE__*/React.createElement(I, {
    n: "refresh-cw",
    s: 13
  }), "Retry"), /*#__PURE__*/React.createElement("button", {
    onClick: onLogout,
    className: "b-gho"
  }, "Sign Out"))));
  return /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      height: '100%'
    }
  },
  /* ─── Mobile Bottom Nav (provider) ─── */
  isMobile && /*#__PURE__*/React.createElement(MobileBottomNav, {
    tabs: [
      { id: 'dashboard', icon: 'briefcase', label: 'Home' },
      { id: 'database', icon: 'grid', label: 'Database' },
      { id: 'inbox', icon: 'msg', label: 'Messages', badge: cases.length + (orgChannels || []).length, badgeClass: 'nav-badge-gold' },
      { id: 'clients', icon: 'users', label: T.client_term_plural || 'Clients' }
    ],
    activeView: activeCase ? 'case' : view,
    onNavigate: id => { setView(id); setActiveCase(null); setActiveIndividual(null); setActiveResourceProfile(null); setActiveTeamDetail && setActiveTeamDetail(null); },
    moreItems: [
      { id: 'teams', icon: 'users', label: 'Teams' },
      { id: 'schema', icon: 'grid', label: 'Schema' },
      { id: 'hierarchy', icon: 'globe', label: 'My Network' },
      { id: 'activity', icon: 'layers', label: 'Activity Stream' },
      { id: 'transparency', icon: 'eye', label: 'Transparency' },
      ...(orgRoom ? [{ id: 'org-settings', icon: 'briefcase', label: 'Organization' }] : [])
    ],
    onMoreNavigate: id => { setView(id); setActiveCase(null); setActiveIndividual(null); setActiveResourceProfile(null); }
  },
    /*#__PURE__*/React.createElement("div", { style: { padding: '8px 0', borderTop: '1px solid var(--border-0)', marginTop: 4 } },
      /*#__PURE__*/React.createElement("div", { className: "team-ctx-pills" },
        /*#__PURE__*/React.createElement("button", {
          className: "team-ctx-pill",
          onClick: () => onSwitchContext('client')
        }, /*#__PURE__*/React.createElement(I, { n: "user", s: 10 }), "Personal"),
        teams.map(t => { const _tpActive = activeTeamContext === t.roomId; const _tpColor = `hsl(${t.color_hue || 260}, 60%, 55%)`; return /*#__PURE__*/React.createElement("button", {
          key: t.roomId,
          className: "team-ctx-pill" + (_tpActive ? " active" : ""),
          style: _tpActive ? { background: _tpColor, borderColor: _tpColor, color: '#fff' } : {},
          onClick: () => switchTeamContext(t.roomId)
        }, /*#__PURE__*/React.createElement("span", {
          className: "pill-dot",
          style: { background: _tpActive ? '#fff' : _tpColor }
        }), t.name || 'Unnamed Team'); })
      )
    ),
    /*#__PURE__*/React.createElement("div", { style: { padding: '8px 0', borderTop: '1px solid var(--border-0)', marginTop: 8, display: 'flex', gap: 8 } },
      /*#__PURE__*/React.createElement(ThemeToggle, { style: { flex: 1 } }),
      /*#__PURE__*/React.createElement("button", { onClick: onLogout, className: "b-gho b-sm", style: { flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 5 } },
        /*#__PURE__*/React.createElement(I, { n: "logout", s: 12 }), "Logout")
    )
  ),
  /* ─── Mobile FAB for quick note ─── */
  isMobile && /*#__PURE__*/React.createElement("button", {
    className: "mobile-fab",
    onClick: () => { setNewNoteAttachTo(null); setNewNoteModal(true); },
    "aria-label": "Quick note"
  }, /*#__PURE__*/React.createElement(I, { n: "plus", s: 24 })),
  /*#__PURE__*/React.createElement("div", {
    className: `app-sidebar${sidebarCollapsed ? ' collapsed' : ''}`,
    style: {
      width: sidebarCollapsed ? 0 : 260,
      minWidth: sidebarCollapsed ? 0 : 260,
      height: '100%',
      background: 'var(--bg-1)',
      borderRight: sidebarCollapsed ? 'none' : (teamMode ? `2px solid ${teamColorThemed(teamMode.color_hue, isLightTheme).primary}` : '1px solid var(--border-0)'),
      display: 'flex',
      flexDirection: 'column'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '18px 14px 14px',
      borderBottom: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 10,
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 28,
      height: 28,
      borderRadius: 'var(--r)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement(SpinningDodeca, { size: 28 })), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--serif)',
      fontWeight: 700,
      fontSize: 15,
      flex: 1
    }
  }, "Khora"), /*#__PURE__*/React.createElement("button", {
    className: "sidebar-collapse-btn",
    onClick: toggleSidebar,
    title: "Collapse sidebar"
  }, /*#__PURE__*/React.createElement(I, { n: "chevronLeft", s: 14 })), /*#__PURE__*/React.createElement(NotificationBell, {
    notifications: notifications,
    onNotifClick: handleNotifClick,
    onDismiss: n => setNotifications(prev => prev.filter(x => x.id !== n.id)),
    onDismissAll: handleDismissAllNotifs
  })), teamMode && /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', gap: 6, marginTop: 8, padding: '5px 8px', borderRadius: 'var(--r)', background: `hsla(${teamMode.color_hue || 260}, 60%, 55%, 0.1)` }
  }, /*#__PURE__*/React.createElement("span", {
    style: { width: 7, height: 7, borderRadius: '50%', background: `hsl(${teamMode.color_hue || 260}, 60%, 55%)`, flexShrink: 0 }
  }), /*#__PURE__*/React.createElement("span", {
    style: { fontSize: 10.5, fontWeight: 700, color: `hsl(${teamMode.color_hue || 260}, 60%, 50%)`, fontFamily: 'var(--mono)', letterSpacing: '0.05em', textTransform: 'uppercase', flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }
  }, teamMode.name)), /*#__PURE__*/React.createElement("div", {
    onClick: () => setShareContactModal(true),
    style: {
      marginTop: 10,
      padding: '10px 12px',
      background: 'var(--bg-2)',
      border: '1px solid var(--border-1)',
      borderRadius: 'var(--r-lg)',
      cursor: 'pointer',
      transition: 'border-color .2s'
    },
    onMouseEnter: e => e.currentTarget.style.borderColor = 'var(--gold)',
    onMouseLeave: e => e.currentTarget.style.borderColor = 'var(--border-1)'
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 32,
      height: 32,
      borderRadius: '50%',
      background: orgRoom ? 'var(--blue-dim)' : 'var(--gold-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: orgRoom ? 'var(--blue)' : 'var(--gold)',
      border: orgRoom ? '2px solid var(--blue)' : '2px solid var(--gold)'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: orgRoom ? 'shieldCheck' : 'user',
    s: 16
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      minWidth: 0
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 700,
      display: 'block',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap',
      color: 'var(--tx-0)'
    }
  }, providerProfile.display_name || svc.userId?.split(':')[0]?.replace('@', '') || T.provider_term), providerProfile.title && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      display: 'block',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap'
    }
  }, providerProfile.title))), orgRoom ? /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--blue-dim)',
      border: '1px solid rgba(91,156,245,.2)',
      borderRadius: 'var(--r)',
      padding: '6px 8px',
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 12,
    c: "var(--blue)"
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      minWidth: 0
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10.5,
      fontWeight: 600,
      color: 'var(--blue)',
      display: 'block',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap'
    }
  }, orgMeta.name || 'Organization'), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9,
      color: 'var(--tx-2)',
      fontFamily: 'var(--mono)'
    }
  }, activeOrgRoleLabels[orgRole] || orgRole, " \xB7 ", ORG_TYPE_LABELS[orgMeta.type] || orgMeta.type)), myVerification?.status === 'verified' ? /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green",
    style: {
      fontSize: 7.5,
      padding: '1px 5px'
    }
  }, "VERIFIED") : emailVerifyConfig.enabled ? /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 7.5,
      padding: '1px 5px',
      cursor: 'pointer'
    },
    onClick: e => { e.stopPropagation(); openEmailVerifyModal(); }
  }, "UNVERIFIED") : /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green",
    style: {
      fontSize: 7.5,
      padding: '1px 5px'
    }
  }, "VERIFIED"), allOrgs.length > 1 && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 8,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)',
      marginLeft: 2
    }
  }, (allOrgs.findIndex(o => o.roomId === orgRoom) + 1) + "/" + allOrgs.length)) : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4,
      padding: '4px 0'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9.5,
      color: 'var(--tx-3)',
      fontStyle: 'italic'
    }
  }, "No organization \u2014 unaffiliated")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4,
      marginTop: 6
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 8.5,
      color: 'var(--tx-3)',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap',
      flex: 1
    }
  }, svc.userId), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 8
    }
  }, T.provider_term.toUpperCase())), providerProfile.credentials && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9,
      color: 'var(--tx-2)',
      fontFamily: 'var(--mono)',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap',
      display: 'block'
    }
  }, providerProfile.credentials)))),
  /* ─── Unified Team / Personal Switcher (sidebar) ─── */
  /*#__PURE__*/React.createElement("div", {
    className: "team-ctx-wrap"
  }, /*#__PURE__*/React.createElement("div", { className: "team-ctx-pills" },
      /*#__PURE__*/React.createElement("button", {
        className: "team-ctx-pill",
        onClick: () => onSwitchContext('client')
      }, /*#__PURE__*/React.createElement(I, { n: "user", s: 10 }), "Personal"),
      teams.map(t => { const _tpActive = activeTeamContext === t.roomId; const _tpColor = `hsl(${t.color_hue || 260}, 60%, 55%)`; return /*#__PURE__*/React.createElement("button", {
        key: t.roomId,
        className: "team-ctx-pill" + (_tpActive ? " active" : ""),
        style: _tpActive ? { background: _tpColor, borderColor: _tpColor, color: '#fff' } : {},
        onClick: () => switchTeamContext(t.roomId)
      }, /*#__PURE__*/React.createElement("span", {
        className: "pill-dot",
        style: { background: _tpActive ? '#fff' : _tpColor }
      }), t.name || 'Unnamed Team'); })
    )
  ),
  /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      overflow: 'auto',
      padding: '6px 6px'
    }
  }, (() => {
    const schemaNotifCount = notifications.filter(n => (n.type === 'schema_update' || n.type === 'schema_new') && !n.read).length;
    const activityNotifCount = notifications.filter(n => n.type === 'data_change' && !n.read).length;
    return [{
      id: 'dashboard',
      icon: 'briefcase',
      label: 'Dashboard'
    }, {
      id: 'database',
      icon: 'grid',
      label: 'Database'
    }, {
      id: 'inbox',
      icon: 'msg',
      label: 'Messages'
    }, {
      id: 'teams',
      icon: 'users',
      label: `Teams${teams.length ? ` (${teams.length})` : ''}`
    }, {
      id: 'schema',
      icon: 'grid',
      label: 'Schema',
      badge: schemaNotifCount,
      badgeClass: 'nav-badge-teal'
    }, {
      id: 'hierarchy',
      icon: 'globe',
      label: 'My Network'
    }, {
      id: 'activity',
      icon: 'list',
      label: 'Action Log',
      badge: activityNotifCount,
      badgeClass: 'nav-badge-teal'
    }, {
      id: 'transparency',
      icon: 'eye',
      label: 'Transparency'
    }].map(item => /*#__PURE__*/React.createElement("div", {
      key: item.id,
      onClick: () => {
        setView(item.id);
        setActiveCase(null);
        setActiveIndividual(null);
        setActiveResourceProfile(null);
        // When clicking Teams nav and a team is selected, open its detail view
        if (item.id === 'teams' && activeTeamContext) {
          const t = teams.find(t => t.roomId === activeTeamContext);
          setActiveTeamDetail(t || null);
        } else {
          setActiveTeamDetail(null);
        }
        if (item.id !== 'inbox') {
          setInboxConvo(null);
          setInboxMessages([]);
        }
      },
      style: {
        padding: '9px 10px',
        borderRadius: 'var(--r)',
        cursor: 'pointer',
        marginBottom: 1,
        background: (view === item.id || item.id === 'database' && (view === 'individual-profile' || view === 'resource-profile')) && !activeCase ? 'var(--bg-4)' : 'transparent',
        borderLeft: (view === item.id || item.id === 'database' && (view === 'individual-profile' || view === 'resource-profile')) && !activeCase ? `2px solid ${teamMode ? `hsl(${teamMode.color_hue || 260}, 60%, 55%)` : 'var(--gold)'}` : '2px solid transparent',
        display: 'flex',
        alignItems: 'center',
        gap: 8,
        transition: 'all .15s',
        color: (view === item.id || item.id === 'database' && (view === 'individual-profile' || view === 'resource-profile')) && !activeCase ? 'var(--tx-0)' : 'var(--tx-1)'
      },
      onMouseEnter: e => {
        if (!(view === item.id && !activeCase)) e.currentTarget.style.background = 'var(--bg-3)';
      },
      onMouseLeave: e => {
        if (!(view === item.id && !activeCase)) e.currentTarget.style.background = 'transparent';
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: item.icon,
      s: 14
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        fontWeight: view === item.id || item.id === 'database' && (view === 'individual-profile' || view === 'resource-profile') ? 600 : 400
      }
    }, item.label), item.id === 'inbox' && cases.length + orgChannels.length > 0 && /*#__PURE__*/React.createElement("span", {
      className: "nav-badge nav-badge-gold"
    }, cases.length + orgChannels.length), item.badge > 0 && /*#__PURE__*/React.createElement("span", {
      className: `nav-badge ${item.badgeClass}`
    }, item.badge)));
  })(), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '14px 10px 4px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ORGANIZATION")), orgRoom ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '6px 10px',
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 20,
      height: 20,
      borderRadius: 'var(--r)',
      background: 'var(--blue-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--blue)'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 11
  })), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11.5,
      fontWeight: 600,
      color: 'var(--tx-0)',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap'
    }
  }, orgMeta.name || 'Organization')), orgMeta.type && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-teal",
    style: {
      fontSize: 8,
      marginTop: 4,
      marginLeft: 26
    }
  }, ORG_TYPE_LABELS[orgMeta.type] || orgMeta.type)), [{
    id: 'org-settings',
    icon: 'settings',
    label: 'Org Settings',
    reqRole: 'admin'
  }, {
    id: 'org-inbox',
    icon: 'msg',
    label: `Messages${orgChannels.length ? ` (${orgChannels.length})` : ''}`
  }, {
    id: 'staff',
    icon: 'users',
    label: T.staff_term_plural
  }, {
    id: 'network',
    icon: 'globe',
    label: 'Network'
  }].filter(item => !item.reqRole || orgRole === item.reqRole).filter(item => item.id !== 'org-inbox' || hasOrgMsgPermission('read')).map(item => /*#__PURE__*/React.createElement("div", {
    key: item.id,
    onClick: () => {
      setView(item.id);
      setActiveCase(null);
    },
    style: {
      padding: '9px 10px',
      borderRadius: 'var(--r)',
      cursor: 'pointer',
      marginBottom: 1,
      background: view === item.id && !activeCase ? 'var(--bg-4)' : 'transparent',
      borderLeft: view === item.id && !activeCase ? '2px solid var(--blue)' : '2px solid transparent',
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      transition: 'all .15s',
      color: view === item.id && !activeCase ? 'var(--tx-0)' : 'var(--tx-1)'
    },
    onMouseEnter: e => {
      if (!(view === item.id && !activeCase)) e.currentTarget.style.background = 'var(--bg-3)';
    },
    onMouseLeave: e => {
      if (!(view === item.id && !activeCase)) e.currentTarget.style.background = 'transparent';
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: item.icon,
    s: 14
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12.5,
      fontWeight: view === item.id ? 600 : 400
    }
  }, item.label)))) : /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '4px 10px',
      display: 'flex',
      flexDirection: 'column',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setCreateOrgModal(true),
    className: "b-gho b-sm",
    style: {
      width: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 12
  }), "Create Organization"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setJoinOrgModal(true),
    className: "b-gho b-xs",
    style: {
      width: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 10
  }), "Join Organization")), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '14px 10px 4px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, activeTeamObj ? "CASES \u2014 " + activeTeamObj.name + " (" + teamFilteredCases.length + ")" : "CASES (" + cases.length + ")")), teamFilteredCases.length === 0 && /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 11.5,
      padding: '12px 10px',
      textAlign: 'center'
    }
  }, activeTeamObj ? "No cases for this team" : "No clients shared with you yet"), teamFilteredCases.map((c, i) => {
    const assignment = caseAssignments[c.bridgeRoomId];
    const isPrimary = (assignment?.primary || c.meta?.provider) === svc.userId;
    return /*#__PURE__*/React.createElement("div", {
      key: c.bridgeRoomId,
      onClick: () => openCase(c.bridgeRoomId),
      style: {
        padding: '8px 10px',
        borderRadius: 'var(--r)',
        cursor: 'pointer',
        marginBottom: 1,
        background: activeCase === c.bridgeRoomId ? 'var(--bg-4)' : 'transparent',
        borderLeft: activeCase === c.bridgeRoomId ? '2px solid var(--gold)' : '2px solid transparent',
        transition: 'all .15s'
      },
      onMouseEnter: e => {
        if (activeCase !== c.bridgeRoomId) e.currentTarget.style.background = 'var(--bg-3)';
      },
      onMouseLeave: e => {
        if (activeCase !== c.bridgeRoomId) e.currentTarget.style.background = 'transparent';
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        fontWeight: activeCase === c.bridgeRoomId ? 600 : 400,
        display: 'block'
      }
    }, c.sharedData.full_name || c.clientUserId), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4,
        marginTop: 1
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9.5,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, Object.keys(c.sharedData).length, " fields"), c.transferable ? /*#__PURE__*/React.createElement(I, {
      n: "users",
      s: 8,
      c: "var(--teal)"
    }) : /*#__PURE__*/React.createElement(I, {
      n: "lock",
      s: 8,
      c: "var(--red)"
    }), !isPrimary && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 8,
        color: 'var(--gold)',
        fontFamily: 'var(--mono)'
      }
    }, (assignment?.primary || c.meta?.provider)?.split(':')[0]?.replace('@', ''))));
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 10px',
      display: 'flex',
      flexDirection: 'column',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setDiscoverModal(true),
    className: "b-gho b-sm",
    style: {
      width: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "search",
    s: 12
  }), "Find ", T?.client_term || 'Individual'), /*#__PURE__*/React.createElement("button", {
    onClick: () => loadCases(),
    className: "b-gho b-xs",
    style: {
      width: '100%'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "search",
    s: 10
  }), "Refresh"))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 10px',
      borderTop: '1px solid var(--border-0)',
      display: 'flex',
      flexDirection: 'column',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    server: svc._baseUrl ? (() => { try { return new URL(svc._baseUrl).hostname; } catch(e) { return 'unknown'; } })() : 'unknown',
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Session",
    compact: true
  }), /*#__PURE__*/React.createElement(ThemeToggle, {
    style: {
      width: '100%',
      justifyContent: 'center'
    }
  }), /*#__PURE__*/React.createElement("button", {
    onClick: onLogout,
    className: "b-gho b-sm",
    style: {
      width: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "logout",
    s: 12
  }), "Logout"))), /*#__PURE__*/React.createElement("div", {
    className: `app-main${sidebarCollapsed ? ' sidebar-collapsed-show' : ''}`,
    style: {
      flex: 1,
      overflow: 'auto',
      padding: 0,
      minWidth: 0,
      position: 'relative'
    }
  }, sidebarCollapsed && /*#__PURE__*/React.createElement("button", {
    className: "sidebar-toggle-btn",
    onClick: toggleSidebar,
    title: "Expand sidebar"
  }, /*#__PURE__*/React.createElement(I, { n: "chevronRight", s: 14 })), orgRoom && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 20px',
      background: 'linear-gradient(var(--bg-1), var(--bg-1)), linear-gradient(var(--blue-dim), var(--blue-dim))',
      backdropFilter: 'blur(8px)',
      WebkitBackdropFilter: 'blur(8px)',
      borderBottom: '1px solid rgba(91,156,245,.15)',
      display: 'flex',
      alignItems: 'center',
      gap: 10,
      minHeight: 40,
      position: 'sticky',
      top: 0,
      zIndex: 5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 16,
    c: "var(--blue)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontWeight: 700,
      fontSize: 13.5,
      color: 'var(--blue)',
      fontFamily: 'var(--serif)'
    }
  }, orgMeta.name || 'Organization'), orgMeta.type && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-teal",
    style: {
      fontSize: 8
    }
  }, ORG_TYPE_LABELS[orgMeta.type] || orgMeta.type), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-blue",
    style: {
      fontSize: 8
    }
  }, activeOrgRoleLabels[orgRole] || orgRole), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1
    }
  }), allOrgs.length > 1 && /*#__PURE__*/React.createElement("select", {
    value: orgRoom,
    onChange: e => switchOrg(e.target.value),
    style: {
      background: 'var(--bg-2)',
      color: 'var(--tx-0)',
      border: '1px solid var(--border-1)',
      borderRadius: 'var(--r)',
      padding: '4px 8px',
      fontSize: 11,
      fontFamily: 'var(--sans)',
      cursor: 'pointer',
      outline: 'none'
    }
  }, allOrgs.map(o => /*#__PURE__*/React.createElement("option", {
    key: o.roomId,
    value: o.roomId
  }, o.meta?.name || o.roomId)))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: 24
    }
  }, view === 'dashboard' && !activeCase && /*#__PURE__*/React.createElement(React.Fragment, null,
    activeTeamObj && /*#__PURE__*/React.createElement("div", {
      style: { display: 'flex', alignItems: 'center', gap: 8, padding: '10px 16px', marginBottom: 12, background: `hsla(${activeTeamObj.color_hue || 260}, 60%, 55%, 0.08)`, border: `1px solid hsla(${activeTeamObj.color_hue || 260}, 60%, 55%, 0.2)`, borderRadius: 'var(--r-lg)' }
    }, /*#__PURE__*/React.createElement(I, { n: "users", s: 14, c: `hsl(${activeTeamObj.color_hue || 260}, 60%, 55%)` }),
      /*#__PURE__*/React.createElement("span", { style: { fontSize: 12.5, fontWeight: 600 } }, "Viewing as: ", activeTeamObj.name),
      /*#__PURE__*/React.createElement("span", { style: { fontSize: 11, color: 'var(--tx-3)' } }, "\u00B7 ", (activeTeamObj.members || []).length, " members"),
      /*#__PURE__*/React.createElement("button", { onClick: () => switchTeamContext(null), className: "b-gho b-xs", style: { marginLeft: 'auto', fontSize: 10 } }, "Clear filter")
    ),
    /*#__PURE__*/React.createElement(DashboardOverview, {
      cases: activeTeamObj ? cases.filter(c => { const a = caseAssignments[c.bridgeRoomId]; return activeTeamMemberIds.includes(a?.primary || c.meta?.provider); }) : cases,
      clientRecords: activeTeamObj ? clientRecords.filter(cr => activeTeamMemberIds.includes(cr.created_by || cr.provider)) : clientRecords,
      staff: staff,
      T: T,
      notes: activeTeamObj ? dbNotes.filter(n => activeTeamMemberIds.includes(n.by || n.author)) : dbNotes,
      resourceTypes: resourceTypes,
      onGoToDatabase: () => {
        setView('database');
        setActiveCase(null);
      },
      onDiscover: () => setDiscoverModal(true),
      onCreateClient: openCreateClientModal
    })
  ), view === 'database' && !activeCase && /*#__PURE__*/React.createElement(React.Fragment, null,
    /*#__PURE__*/React.createElement(DatabaseView, {
    cases: teamFilteredCases,
    caseAssignments: caseAssignments,
    openCase: openCase,
    T: T,
    svc: svc,
    caseAllocations: caseAllocations,
    providerProfile: providerProfile,
    orgRoom: orgRoom,
    orgMeta: orgMeta,
    staff: staff,
    orgRole: orgRole,
    showToast: showToast,
    bridgeNotes: bridgeNotes,
    rosterNotes: rosterNotes,
    allAllocations: allAllocations,
    onCreateOrg: () => setCreateOrgModal(true),
    onEditProfile: openProfileModal,
    onDiscover: () => setDiscoverModal(true),
    myVerification: myVerification,
    emailVerifyConfig: emailVerifyConfig,
    openEmailVerifyModal: openEmailVerifyModal,
    orgChannels: orgChannels,
    ORG_TYPE_LABELS: ORG_TYPE_LABELS,
    ORG_ROLE_LABELS: activeOrgRoleLabels,
    notes: activeTeamObj ? dbNotes.filter(n => activeTeamMemberIds.includes(n.by || n.author)) : dbNotes,
    onNewNote: () => {
      setNewNoteAttachTo(null);
      setNewNoteModal(true);
    },
    onNoteClick: note => setNoteDetailModal(note),
    onOpenIndividual: row => {
      setActiveIndividual(row);
      setView('individual-profile');
    },
    onOpenResource: row => {
      setActiveResourceProfile(row);
      setView('resource-profile');
    },
    resourceTypes: resourceTypes,
    resourceRelations: resourceRelations,
    resourceInventory: resourceInventory,
    rosterRoom: rosterRoom,
    networkRoom: networkRoom,
    onCreateResource: () => {
      setResourceDraft({
        name: '',
        category: 'general',
        unit: 'unit',
        fungible: true,
        perishable: false,
        ttl_days: '',
        tags: '',
        infinite: false,
        initial_quantity: '',
        replenishes: false,
        replenish_cycle: '',
        permissions: buildDefaultResourcePermissions()
      });
      setCreateResourceModal(true);
    },
    onRefresh: () => loadResources(orgRoom, networkRoom, rosterRoom),
    onRestock: relation => {
      setRestockModal(relation);
      setRestockQty('');
      setRestockNote('');
    },
    onEstablishRelation: handleEstablishRelation,
    canViewResource: canViewResource,
    canControlResource: canControlResource,
    canAllocateResource: canAllocateResource,
    clientRecords: clientRecords,
    onCreateClient: openCreateClientModal,
    onCellEdit: handleDbCellEdit,
    onBulkAction: handleBulkAction,
    onReorder: handleReorder,
    onAddRow: openCreateClientModal,
    fieldDefs: fieldDefs,
    fieldCrosswalks: fieldCrosswalks,
    teams: teams,
    onSaveFieldDef: async def => {
      const schemaRoom = svc.client ? svc.client.getRooms().find(r => {
        const id = r.currentState.getStateEvents(EVT.IDENTITY, '');
        return id?.getContent()?.account_type === 'schema' && id.getContent().owner === svc.userId;
      })?.roomId : null;
      if (!schemaRoom) return;
      const updated = {
        ...fieldDefs,
        [def.uri]: def
      };
      await svc.setState(schemaRoom, EVT.FIELD_DEF, {
        definitions: updated
      });
      setFieldDefs(updated);
    },
    onSaveCrosswalk: async xw => {
      const schemaRoom = svc.client ? svc.client.getRooms().find(r => {
        const id = r.currentState.getStateEvents(EVT.IDENTITY, '');
        return id?.getContent()?.account_type === 'schema' && id.getContent().owner === svc.userId;
      })?.roomId : null;
      if (!schemaRoom) return;
      const updated = [...fieldCrosswalks, {
        ...xw,
        created_by: svc.userId
      }];
      await svc.setState(schemaRoom, EVT.FIELD_CROSSWALK, {
        crosswalks: updated
      });
      setFieldCrosswalks(updated);
    },
    fieldGovernanceConfig: fieldGovernanceConfig,
    onPropose: async (proposal, room) => { if (svc) await svc.setState(room, EVT.GOV_PROPOSAL, proposal, proposal.id); },
    teamMode: teamMode,
    activeTeamObj: activeTeamObj,
    sidebarCollapsed: sidebarCollapsed,
    linkedRecords: linkedRecords,
    onCreateLinkedRecord: (parentRecord) => setCreateLinkedRecordModal({ parentRecord }),
    onRemoveLinkedRecord: async (parentId, linkId) => {
      setLinkedRecords(prev => {
        const next = { ...prev };
        if (next[parentId]) next[parentId] = next[parentId].filter(l => l.id !== linkId);
        return next;
      });
      // Persist removal to Matrix
      const roomId = parentId;
      try {
        await emitOp(roomId, 'NUL', dot('org', 'linked_records', linkId), {
          link_id: linkId,
          edit_source: 'database_linked_record'
        }, { type: 'org', epistemic: 'MEANT', role: orgRole || 'provider' });
      } catch (e) { console.warn('Failed to emit unlink op:', e); }
      if (showToast) showToast('Linked record removed', 'info');
    },
    resourceTypes: resourceTypes,
    onCreateTable: team => setCreateTableModal({ teamId: team.roomId, teamName: team.name }),
    onOpenTable: (table, team) => setActiveCustomTable({ table, teamId: team.roomId }),
    trashedIndividuals: trashedIndividuals,
    onRestoreIndividual: handleRestoreIndividual,
    onRestoreField: async (row, fieldKey, pastValue) => {
      const currentValue = row.fields?.[fieldKey]?.value || row[fieldKey] || '';
      const roomId = row.bridgeRoom || row.id;
      try {
        // EO: ALT(org.individuals.{fieldKey}, {from: current, to: past, reason: 'history_restore'}) — field_restore
        await emitOp(roomId, 'ALT', dot('org', 'individuals', fieldKey), {
          from: currentValue,
          to: pastValue,
          reason: 'history_restore'
        }, { type: 'org', epistemic: 'MEANT', role: orgRole || 'provider' });
        // Persist via same path as handleDbCellEdit
        if (row._case) {
          const updatedData = { ...row._case.sharedData, [fieldKey]: pastValue };
          await svc.setState(roomId, EVT.BRIDGE_REFS, { fields: updatedData });
        } else if (row._clientRecord) {
          const updates = { ...row._clientRecord };
          if (fieldKey === 'name') updates.client_name = pastValue;
          await svc.setState(row.id, EVT.IDENTITY, updates);
        }
        showToast(`Field "${fieldKey.replace(/_/g,' ')}" restored`, 'success');
      } catch (e) {
        showToast('Restore failed: ' + e.message, 'error');
      }
    }
  }), /*#__PURE__*/React.createElement(NoteCreateModal, {
    open: newNoteModal,
    onClose: () => setNewNoteModal(false),
    individuals: cases.map(c => ({
      id: c.bridgeRoomId,
      name: c.sharedData.full_name || c.clientUserId || 'Unknown'
    })),
    staff: staff,
    svc: svc,
    rosterRoom: rosterRoom,
    onSave: handleNoteSave,
    showToast: showToast,
    T: T,
    initialAttachTo: newNoteAttachTo,
    teamContext: teamMode
  }), /*#__PURE__*/React.createElement(CreateLinkedRecordModal, {
    open: !!createLinkedRecordModal,
    onClose: () => setCreateLinkedRecordModal(null),
    parentRecord: createLinkedRecordModal?.parentRecord || null,
    individuals: cases.map(c => ({
      id: c.bridgeRoomId,
      name: c.sharedData?.full_name || c.clientUserId || 'Unknown',
      status: c.meta?.status === 'tombstoned' ? 'revoked' : c.sharedData?.full_name ? 'active' : 'imported'
    })).concat((clientRecords || []).filter(r => !cases.some(c => c.bridgeRoomId === r.roomId)).map(r => ({
      id: r.roomId,
      name: r.client_name || 'Unknown',
      status: r.status || 'created'
    }))),
    notes: dbNotes,
    resourceTypes: resourceTypes,
    cases: cases,
    svc: svc,
    orgRole: orgRole,
    orgRoom: orgRoom,
    teamMode: teamMode,
    activeTeamObj: activeTeamObj,
    showToast: showToast,
    linkedRecords: linkedRecords,
    onLinkCreated: async (parentId, linkRecord) => {
      // Update local state
      setLinkedRecords(prev => ({
        ...prev,
        [parentId]: [...(prev[parentId] || []), linkRecord]
      }));
      // Persist to Matrix via EO operation
      try {
        const roomId = parentId;
        await emitOp(roomId, 'INS', dot('org', 'linked_records', linkRecord.id), {
          ...linkRecord,
          edit_source: 'database_linked_record'
        }, { type: 'org', epistemic: 'MEANT', role: orgRole || 'provider' });
      } catch (e) { console.warn('Failed to emit linked record op:', e); }
    }
  }), /*#__PURE__*/React.createElement(NoteDetailModal, {
    note: noteDetailModal,
    open: !!noteDetailModal,
    onClose: () => setNoteDetailModal(null),
    onSave: handleNoteEdit,
    svc: svc,
    staff: staff,
    rosterRoom: rosterRoom,
    showToast: showToast,
    T: T
  })), view === 'individual-profile' && activeIndividual && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(IndividualProfilePage, {
    individual: activeIndividual,
    notes: dbNotes,
    allocations: allAllocations,
    onBack: () => {
      setView('database');
      setActiveIndividual(null);
    },
    onOpenCase: openCase,
    onAddNote: indId => {
      setNewNoteAttachTo(indId);
      setNewNoteModal(true);
    },
    svc: svc,
    T: T,
    showToast: showToast,
    resourceTypes: resourceTypes,
    resourceRelations: resourceRelations,
    resourceInventory: resourceInventory,
    orgRoom: orgRoom,
    orgRole: orgRole,
    canAllocateResource: canAllocateResource,
    onAllocate: handleProfileAllocate,
    fieldDefs: fieldDefs,
    onFieldEdit: handleDbCellEdit
  }), /*#__PURE__*/React.createElement(NoteCreateModal, {
    open: newNoteModal,
    onClose: () => setNewNoteModal(false),
    individuals: cases.map(c => ({
      id: c.bridgeRoomId,
      name: c.sharedData.full_name || c.clientUserId || 'Unknown'
    })),
    staff: staff,
    svc: svc,
    rosterRoom: rosterRoom,
    onSave: handleNoteSave,
    showToast: showToast,
    T: T,
    initialAttachTo: newNoteAttachTo,
    teamContext: teamMode
  })), view === 'resource-profile' && activeResourceProfile && /*#__PURE__*/React.createElement(ResourceProfilePage, {
    resource: activeResourceProfile,
    allocations: allAllocations,
    onBack: () => {
      setView('database');
      setActiveResourceProfile(null);
    },
    T: T
  }), view === 'inbox' && !activeCase && /*#__PURE__*/React.createElement("div", {
    className: "anim-up inbox-wrap"
  },
    activeTeamObj && /*#__PURE__*/React.createElement("div", {
      style: { display: 'flex', alignItems: 'center', gap: 8, padding: '10px 16px', marginBottom: 12, background: `hsla(${activeTeamObj.color_hue || 260}, 60%, 55%, 0.08)`, border: `1px solid hsla(${activeTeamObj.color_hue || 260}, 60%, 55%, 0.2)`, borderRadius: 'var(--r-lg)' }
    }, /*#__PURE__*/React.createElement(I, { n: "users", s: 14, c: `hsl(${activeTeamObj.color_hue || 260}, 60%, 55%)` }),
      /*#__PURE__*/React.createElement("span", { style: { fontSize: 12.5, fontWeight: 600 } }, "Filtered to: ", activeTeamObj.name),
      /*#__PURE__*/React.createElement("button", { onClick: () => switchTeamContext(null), className: "b-gho b-xs", style: { marginLeft: 'auto', fontSize: 10 } }, "Clear filter")
    ),
    /*#__PURE__*/React.createElement("div", {
    className: "inbox-header"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "Messages"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "Encrypted conversations with ", T.client_term_plural.toLowerCase(), orgRoom ? ' and organizations' : '', " in one place."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: inboxConvo,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Messages",
    extra: [{ label: 'Privacy model', value: 'Each conversation is a separate encrypted Matrix room (bridge). Direct messages are between you and one client. Org channels use opacity envelopes.' }, orgRoom ? { label: 'Org channel opacity', value: orgOpacity + ' \u2014 controls what receiving orgs see about message sender identity' } : null].filter(Boolean)
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6,
      flexShrink: 0
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setDiscoverModal(true),
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "search",
    s: 14
  }), "Find ", T?.client_term || 'Individual'), orgRoom && hasOrgMsgPermission('read') && /*#__PURE__*/React.createElement("button", {
    onClick: () => setComposeOrgModal(true),
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "New Channel"), teamMemberContacts.length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => setNewTeamDMModal(true),
    className: "b-gho b-sm",
    style: { display: 'flex', alignItems: 'center', gap: 6 }
  }, /*#__PURE__*/React.createElement(I, { n: "msg", s: 14 }), "New DM"))), /*#__PURE__*/React.createElement("div", {
    className: "inbox-panel"
  }, /*#__PURE__*/React.createElement("div", {
    className: "inbox-list"
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 14px 8px',
      borderBottom: '1px solid var(--border-0)',
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0,
      flex: 1
    }
  }, `CONVERSATIONS (${teamFilteredCases.length + (orgRoom && hasOrgMsgPermission('read') ? orgChannels.length : 0) + teamFilteredTeamDMs.length})`), /*#__PURE__*/React.createElement("button", {
    onClick: () => setNewBucketModal(true),
    className: "b-gho",
    style: { display: 'flex', alignItems: 'center', gap: 4, padding: '3px 8px', fontSize: 10.5 }
  }, /*#__PURE__*/React.createElement(I, { n: "plus", s: 10 }), "New Group")), /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      overflow: 'auto'
    }
  }, (() => {
    const { bucketSections, teamSections, otherConvos } = inboxGrouped;
    const totalCount = teamFilteredCases.length + (orgRoom && hasOrgMsgPermission('read') ? orgChannels.length : 0) + teamFilteredTeamDMs.length;
    if (totalCount === 0) return /*#__PURE__*/React.createElement("div", { style: { padding: '40px 16px', textAlign: 'center' } }, /*#__PURE__*/React.createElement(I, { n: "msg", s: 28, c: "var(--tx-3)" }), /*#__PURE__*/React.createElement("p", { style: { color: 'var(--tx-3)', fontSize: 11.5, marginTop: 10 } }, "No conversations yet"), /*#__PURE__*/React.createElement("p", { style: { color: 'var(--tx-3)', fontSize: 10.5, marginTop: 4 } }, T.client_term_plural, " must share a bridge, or create an org channel."));
    const convoTypeColor = t => t === 'case' ? 'teal' : t === 'channel' ? 'blue' : 'purple';
    const convoTypeLabel = t => t === 'case' ? 'Direct' : t === 'channel' ? 'Channel' : 'DM';
    const convoName = (type, data) => type === 'case' ? (data.sharedData.full_name || data.clientUserId) : type === 'channel' ? (() => { const pid = data.orgs?.find(o => o !== orgRoom); return data.org_names?.[pid] || pid?.slice(0, 20) || 'Organization'; })() : (data.peerName || data.peerId);
    const renderItem = convo => {
      const { type, id, data } = convo;
      const isActive = inboxConvo === id;
      const tc = convoTypeColor(type);
      const name = convoName(type, data);
      const inBucket = msgBuckets.some(b => b.roomIds.includes(id));
      return /*#__PURE__*/React.createElement("div", {
        key: id,
        onClick: () => openInboxConvo(id),
        style: { padding: '10px 14px', cursor: 'pointer', borderBottom: '1px solid var(--border-0)', background: isActive ? 'var(--bg-4)' : 'transparent', borderLeft: isActive ? `3px solid var(--${tc})` : '3px solid transparent', transition: 'all .15s' },
        onMouseEnter: e => { if (!isActive) e.currentTarget.style.background = 'var(--bg-3)'; },
        onMouseLeave: e => { if (!isActive) e.currentTarget.style.background = 'transparent'; }
      }, /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 8 } },
        /*#__PURE__*/React.createElement("div", {
          style: { width: 32, height: 32, borderRadius: '50%', background: `var(--${tc}-dim)`, display: 'flex', alignItems: 'center', justifyContent: 'center', color: `var(--${tc})`, border: `2px solid var(--${tc})`, flexShrink: 0 }
        }, /*#__PURE__*/React.createElement(I, { n: type === 'channel' ? 'users' : 'user', s: 14 })),
        /*#__PURE__*/React.createElement("div", { style: { flex: 1, minWidth: 0 } },
          /*#__PURE__*/React.createElement("span", { style: { fontSize: 12.5, fontWeight: isActive ? 700 : 500, display: 'block', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, name),
          /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 3, marginTop: 2, flexWrap: 'wrap' } },
            /*#__PURE__*/React.createElement("span", { style: { fontSize: 8, padding: '1px 5px', borderRadius: 10, background: `var(--${tc}-dim)`, color: `var(--${tc})`, fontWeight: 600, textTransform: 'uppercase', letterSpacing: '.5px' } }, convoTypeLabel(type)),
            type === 'case' && /*#__PURE__*/React.createElement("span", { className: "tag tag-green", style: { fontSize: 7 } }, /*#__PURE__*/React.createElement(I, { n: "lock", s: 6 }), "E2EE"),
            type === 'channel' && /*#__PURE__*/React.createElement("span", { className: `tag ${orgOpacity === 'opaque' ? 'tag-red' : orgOpacity === 'translucent' ? 'tag-gold' : 'tag-green'}`, style: { fontSize: 7 } }, orgOpacity),
            type === 'team_dm' && data.teamName && /*#__PURE__*/React.createElement("span", { style: { fontSize: 8, color: 'var(--tx-3)' } }, data.teamName)
          )
        ),
        msgBuckets.length > 0 && /*#__PURE__*/React.createElement("button", {
          onClick: e => { e.stopPropagation(); setAssignBucketTarget(assignBucketTarget === id ? null : id); },
          className: "b-gho", style: { padding: '2px 4px', opacity: .6, flexShrink: 0 }, title: "Move to group"
        }, /*#__PURE__*/React.createElement(I, { n: "more-horizontal", s: 11 }))
      ), assignBucketTarget === id && /*#__PURE__*/React.createElement("div", {
        style: { marginTop: 4, paddingLeft: 40, paddingBottom: 4, display: 'flex', flexDirection: 'column', gap: 2 }
      },
        /*#__PURE__*/React.createElement("span", { style: { fontSize: 9, color: 'var(--tx-3)', textTransform: 'uppercase', letterSpacing: '.5px', padding: '2px 0' } }, "Move to group:"),
        ...msgBuckets.map(b => /*#__PURE__*/React.createElement("button", { key: b.id, onClick: e => { e.stopPropagation(); assignToBucket(id, b.id); }, className: "b-gho", style: { textAlign: 'left', fontSize: 10.5, padding: '2px 6px' } }, b.label)),
        inBucket && /*#__PURE__*/React.createElement("button", { onClick: e => { e.stopPropagation(); removeFromBuckets(id); }, className: "b-gho", style: { textAlign: 'left', fontSize: 10, padding: '2px 6px', color: 'var(--tx-3)' } }, "Remove from group")
      ));
    };
    const renderSection = (key, label, convos, iconName, iconColor, isCustom, bucketId) => convos.length === 0 ? null : /*#__PURE__*/React.createElement(React.Fragment, { key },
      /*#__PURE__*/React.createElement("div", { style: { padding: '6px 14px 4px', display: 'flex', alignItems: 'center', gap: 6, position: 'sticky', top: 0, background: 'var(--bg-1)', zIndex: 1, borderBottom: '1px solid var(--border-0)' } },
        iconName && /*#__PURE__*/React.createElement(I, { n: iconName, s: 11, c: iconColor }),
        /*#__PURE__*/React.createElement("span", { style: { fontSize: 9.5, fontWeight: 700, color: iconColor || 'var(--tx-2)', textTransform: 'uppercase', letterSpacing: '.5px', flex: 1 } }, label, " (", convos.length, ")"),
        isCustom && /*#__PURE__*/React.createElement("button", { onClick: e => { e.stopPropagation(); deleteMsgBucket(bucketId); }, className: "b-gho", style: { padding: '1px 4px', opacity: .5 }, title: "Delete group" }, /*#__PURE__*/React.createElement(I, { n: "x", s: 9 }))
      ),
      convos.map(renderItem)
    );
    const allSections = [
      ...bucketSections.map(s => renderSection(s.id, s.label, s.convos, "folder", "var(--gold)", true, s.id)),
      ...teamSections.map(s => renderSection(s.id, s.label, s.convos, "users", `hsl(${s.team?.color_hue || 260},55%,55%)`)),
      otherConvos.length > 0 ? renderSection('__other__', teamSections.length > 0 || bucketSections.length > 0 ? 'Other' : 'All', otherConvos, null, 'var(--tx-2)') : null
    ].filter(Boolean);
    return /*#__PURE__*/React.createElement(React.Fragment, null, ...allSections);
  })())), /*#__PURE__*/React.createElement("div", {
    className: "inbox-chat"
  }, inboxConvo ? (() => {
    const convoType = getInboxConvoType(inboxConvo);
    const convoName = getInboxConvoName(inboxConvo);
    const caseData = cases.find(c => c.bridgeRoomId === inboxConvo);
    const channelData = orgChannels.find(ch => ch.roomId === inboxConvo);
    const dmData = teamDMs.find(d => d.roomId === inboxConvo);
    const avatarColor = convoType === 'case' ? 'teal' : convoType === 'team_dm' ? 'purple' : 'blue';
    return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      className: "inbox-chat-hdr"
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        width: 32,
        height: 32,
        borderRadius: '50%',
        background: `var(--${avatarColor}-dim)`,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: `var(--${avatarColor})`,
        border: `2px solid var(--${avatarColor})`
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: convoType === 'case' ? 'user' : convoType === 'team_dm' ? 'user' : 'users',
      s: 14
    })), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        minWidth: 0
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 14,
        fontWeight: 700,
        display: 'block'
      }
    }, convoName), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        flexWrap: 'wrap'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: "tag tag-green",
      style: {
        fontSize: 8
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "lock",
      s: 8
    }), "E2EE"), convoType === 'case' && /*#__PURE__*/React.createElement(ConnectionBadges, {
      userType: "client",
      teamName: caseData ? (() => { const t = teams.find(t => (t.members || []).some(m => m.userId === caseData.clientUserId)); return t?.name || null; })() : null,
      teamColors: teamColorsList,
      size: "xs"
    }), convoType === 'case' && caseData && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-2)'
      }
    }, Object.keys(caseData.sharedData).length, " shared fields"), convoType === 'channel' && /*#__PURE__*/React.createElement("span", {
      className: `tag ${orgOpacity === 'opaque' ? 'tag-red' : orgOpacity === 'translucent' ? 'tag-gold' : 'tag-green'}`,
      style: {
        fontSize: 8
      }
    }, "OUTGOING: ", orgOpacity), convoType === 'team_dm' && dmData && /*#__PURE__*/React.createElement(ConnectionBadges, {
      userType: dmData.peerType || 'provider',
      orgName: dmData.orgName,
      teamName: dmData.teamName,
      teamColors: teamColorsList,
      size: "xs"
    }))), convoType === 'case' && /*#__PURE__*/React.createElement("button", {
      onClick: () => openCase(inboxConvo),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "user",
      s: 11
    }), "View Profile"), convoType === 'channel' && /*#__PURE__*/React.createElement("button", {
      onClick: () => openChannel(inboxConvo),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "msg",
      s: 11
    }), "Full Channel"), /*#__PURE__*/React.createElement("button", {
      onClick: () => loadInboxMessages(inboxConvo),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "refresh-cw",
      s: 11
    }))), /*#__PURE__*/React.createElement("div", {
      className: "inbox-msgs"
    }, inboxMessages.length === 0 ? /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        flexDirection: 'column'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "msg",
      s: 32,
      c: "var(--tx-3)"
    }), /*#__PURE__*/React.createElement("p", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 12,
        marginTop: 10
      }
    }, "No messages yet"), /*#__PURE__*/React.createElement("p", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 11,
        marginTop: 4
      }
    }, "Start the conversation below")) : [...inboxMessages].reverse().map((msg, i) => {
      const isOwn = msg.sender === svc.userId;
      const sender = convoType === 'channel' ? resolveMessageSender(msg) : {
        label: isOwn ? 'You' : T.client_term,
        isOwn
      };
      return /*#__PURE__*/React.createElement("div", {
        key: msg.id || i,
        style: {
          display: 'flex',
          flexDirection: 'column',
          alignItems: sender.isOwn ? 'flex-end' : 'flex-start',
          marginBottom: 4
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          maxWidth: '75%',
          padding: '10px 14px',
          borderRadius: sender.isOwn ? '14px 14px 4px 14px' : '14px 14px 14px 4px',
          background: sender.isOwn ? 'var(--gold-dim)' : 'var(--bg-3)',
          border: `1px solid ${sender.isOwn ? 'rgba(201,163,82,.2)' : 'var(--border-0)'}`,
          transition: 'transform .1s'
        }
      }, /*#__PURE__*/React.createElement("p", {
        style: {
          fontSize: 12.5,
          color: 'var(--tx-0)',
          lineHeight: 1.5,
          wordBreak: 'break-word'
        }
      }, msg.content?.body)), /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: 4,
          marginTop: 3,
          padding: '0 6px'
        }
      }, /*#__PURE__*/React.createElement("span", {
        style: {
          fontFamily: 'var(--mono)',
          fontSize: 9,
          color: sender.isOwn ? 'var(--gold)' : 'var(--teal)'
        }
      }, sender.isOwn ? 'You' + (sender.org ? ` (${sender.org})` : convoType === 'case' ? ` (${T.provider_term})` : '') : sender.label), /*#__PURE__*/React.createElement("span", {
        style: {
          fontFamily: 'var(--mono)',
          fontSize: 8,
          color: 'var(--tx-3)'
        }
      }, msg.ts ? new Date(msg.ts).toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      }) : '')));
    })), /*#__PURE__*/React.createElement("div", {
      className: "inbox-compose"
    }, convoType === 'case' || hasOrgMsgPermission('respond') ? /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("input", {
      value: inboxMsgText,
      onChange: e => setInboxMsgText(e.target.value),
      placeholder: convoType === 'channel' ? `Message as ${orgOpacity === 'transparent' ? providerProfile.display_name || 'you' : orgOpacity === 'translucent' ? orgMeta.name || 'your org' : 'anonymous org'}... (E2EE)` : 'Type a message (E2EE)...',
      onKeyDown: e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSendInboxMsg();
        }
      },
      style: {
        flex: 1,
        borderRadius: 20,
        padding: '10px 18px'
      }
    }), /*#__PURE__*/React.createElement("button", {
      onClick: handleSendInboxMsg,
      className: "b-pri",
      disabled: !inboxMsgText.trim(),
      style: {
        borderRadius: 20,
        width: 42,
        height: 42,
        padding: 0,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "send",
      s: 16
    }))) : /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '10px 14px',
        background: 'var(--gold-dim)',
        borderRadius: 'var(--r)',
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "lock",
      s: 13,
      c: "var(--gold)"
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11.5,
        color: 'var(--gold)'
      }
    }, "Your role (", orgRole, ") does not have permission to respond. Ask an organization admin to update your role to enable messaging."))));
  })() : /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      flexDirection: 'column'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 64,
      height: 64,
      borderRadius: '50%',
      background: 'var(--gold-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--gold)',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "inbox",
    s: 28
  })), /*#__PURE__*/React.createElement("h3", {
    style: {
      fontSize: 16,
      fontWeight: 700,
      marginBottom: 6
    }
  }, T.provider_term, " Inbox"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      fontSize: 12,
      maxWidth: 300,
      textAlign: 'center',
      lineHeight: 1.6
    }
  }, cases.length + orgChannels.length > 0 ? 'Select a conversation from the left to start chatting.' : `No conversations yet. ${T.client_term_plural} must share a bridge, or create an org channel.`))))), view === 'clients' && !activeCase && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 960,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, T.client_term_plural), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "Each ", T.client_term.toLowerCase(), " record is a private encrypted room. Invite ", T.client_term_plural.toLowerCase(), " to give them full control.")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setImportModal(true),
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "upload",
    s: 14
  }), "Import Data"), clientRecords.length >= 2 && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setDbMergeRecordA(null);
      setDbMergeRecordB(null);
      setDbMergeModal(true);
    },
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "git-merge",
    s: 14
  }), "Merge Records"), /*#__PURE__*/React.createElement("button", {
    onClick: openCreateClientModal,
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "New ", T.client_term))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(140px,1fr))',
      gap: 10,
      marginBottom: 20
    }
  }, [{
    l: `Total ${T.client_term_plural}`,
    v: clientRecords.length,
    c: 'teal',
    i: 'users'
  }, {
    l: 'Imported',
    v: clientRecords.filter(r => r.imported).length,
    c: 'purple',
    i: 'upload'
  }, {
    l: 'Invited',
    v: clientRecords.filter(r => r.status === 'invited').length,
    c: 'gold',
    i: 'send'
  }, {
    l: 'Joined',
    v: clientRecords.filter(r => r.status === 'joined').length,
    c: 'green',
    i: 'check'
  }, {
    l: 'Claimed',
    v: clientRecords.filter(r => r.status === 'claimed').length,
    c: 'teal',
    i: 'shield'
  }, {
    l: 'Pending',
    v: clientRecords.filter(r => r.status === 'created' && !r.imported).length,
    c: 'orange',
    i: 'clock'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginTop: 2
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700
    }
  }, s.v), /*#__PURE__*/React.createElement("span", {
    style: {
      color: `var(--${s.c})`,
      opacity: .5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: s.i,
    s: 15
  })))))), clientRecords.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '40px 20px',
      borderStyle: 'dashed'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 32
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 10,
      fontSize: 13
    }
  }, "No ", T.client_term.toLowerCase(), " records yet"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 11.5,
      marginTop: 4
    }
  }, "Click \"New ", T.client_term, "\" to create a record, or \"Import Data\" to upload a CSV/JSON. Each ", T.client_term.toLowerCase(), " gets their own encrypted room.")) : /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 0,
      overflow: 'hidden'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '2fr 1.5fr 1fr 1fr 1.2fr',
      gap: 0,
      padding: '10px 16px',
      background: 'var(--bg-3)',
      borderBottom: '1px solid var(--border-1)'
    }
  }, ['NAME', 'MATRIX ID', 'STATUS', 'CREATED', 'ACTIONS'].map(h => /*#__PURE__*/React.createElement("span", {
    key: h,
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-2)',
      letterSpacing: '.07em',
      fontWeight: 600
    }
  }, h))), clientRecords.map((rec, i) => {
    const statusColors = {
      created: 'orange',
      invited: 'gold',
      joined: 'green',
      claimed: 'teal'
    };
    const statusLabels = {
      created: 'Pending',
      invited: 'Invited',
      joined: 'Joined',
      claimed: 'Claimed'
    };
    return /*#__PURE__*/React.createElement("div", {
      key: rec.roomId,
      style: {
        display: 'grid',
        gridTemplateColumns: '2fr 1.5fr 1fr 1fr 1.2fr',
        gap: 0,
        padding: '12px 16px',
        borderBottom: i < clientRecords.length - 1 ? '1px solid var(--border-0)' : 'none',
        alignItems: 'center',
        transition: 'background .15s'
      },
      onMouseEnter: e => e.currentTarget.style.background = 'var(--bg-3)',
      onMouseLeave: e => e.currentTarget.style.background = 'transparent'
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        fontWeight: 600
      }
    }, rec.client_name), rec.imported && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-purple",
      style: {
        fontSize: 8
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "lock",
      s: 8
    }), "Encrypted")), rec.notes && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-3)',
        display: 'block',
        marginTop: 2
      }
    }, rec.notes)), /*#__PURE__*/React.createElement("span", {
      style: {
        fontFamily: 'var(--mono)',
        fontSize: 10.5,
        color: rec.client_matrix_id ? 'var(--tx-1)' : 'var(--tx-3)',
        overflow: 'hidden',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap'
      }
    }, rec.client_matrix_id || '—'), /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${statusColors[rec.status] || 'orange'}`,
      style: {
        fontSize: 9,
        justifySelf: 'start'
      }
    }, statusLabels[rec.status] || rec.status), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)'
      }
    }, rec.created ? new Date(rec.created).toLocaleDateString() : '—'), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => {
        setClientInviteModal(rec);
        setClientInviteMatrixId(rec.client_matrix_id || '');
        setCopiedField(null);
      },
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 3
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "userPlus",
      s: 11
    }), "Invite"), /*#__PURE__*/React.createElement("button", {
      onClick: () => openCase(rec.roomId),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 3
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "chevR",
      s: 11
    }), "Open")));
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '14px 18px',
      marginTop: 20,
      display: 'flex',
      gap: 10,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 16,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--teal)'
    }
  }, T.client_term, " sovereignty:"), " When a ", T.client_term.toLowerCase(), " joins their room, they receive superadmin power level (100). When they claim the room, ownership transfers to them permanently. They can kick anyone \u2014 including you \u2014 from their room at any time. You cannot remove a joined or claimed ", T.client_term.toLowerCase(), "."))), view === 'teams' && !activeCase && !activeTeamDetail && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 960,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "Teams"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "Flexible groups of people for collaboration. Teams can span across organizations \u2014 anyone with a Matrix ID can be invited."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Teams",
    extra: [{ label: 'Storage', value: 'Each team is a separate Matrix room. Team metadata, members, schema, and consent rules are stored as state events in that room. All team members can read the room; only the team owner/admin can modify it.' }, { label: 'Team rooms', value: teams.length + ' team room(s): ' + teams.map(t => t.name || 'Unnamed').join(', ') }]
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setCreateTeamModal(true);
      setNewTeamName('');
      setNewTeamDesc('');
    },
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "New Team")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(140px,1fr))',
      gap: 10,
      marginBottom: 20
    }
  }, [{
    l: 'Total Teams',
    v: teams.length,
    c: 'purple',
    i: 'users'
  }, {
    l: 'My Teams',
    v: teams.filter(t => t.owner === svc.userId).length,
    c: 'gold',
    i: 'briefcase'
  }, {
    l: 'Total Members',
    v: teams.reduce((sum, t) => sum + (t.members?.length || 0), 0),
    c: 'teal',
    i: 'user'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginTop: 2
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 18,
      fontWeight: 700
    }
  }, s.v), /*#__PURE__*/React.createElement("span", {
    style: {
      color: `var(--${s.c})`,
      opacity: .5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: s.i,
    s: 15
  })))))), teams.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '40px 20px',
      borderStyle: 'dashed'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 32
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 10,
      fontSize: 13
    }
  }, "No teams yet"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 11.5,
      marginTop: 4
    }
  }, "Create a team to collaborate with people across your organization or beyond.")) : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fill,minmax(220px,1fr))',
      gap: 10
    }
  }, teams.map(team => /*#__PURE__*/React.createElement("div", {
    key: team.roomId,
    className: "card",
    style: {
      padding: 0,
      overflow: 'hidden',
      cursor: 'pointer',
      borderLeft: team.color_hue != null ? `3px solid hsl(${team.color_hue}, 65%, 55%)` : undefined
    },
    onClick: () => { setActiveTeamDetail(team); setActiveTeamContext(team.roomId); try { localStorage.setItem('khora_active_team', team.roomId); } catch {} }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '14px 18px',
      borderBottom: team.color_hue != null ? `1px solid hsla(${team.color_hue}, 65%, 55%, 0.15)` : '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 15,
      fontWeight: 700
    }
  }, team.name || 'Unnamed Team'), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4
    }
  }, team.owner === svc.userId && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 8
    }
  }, "LEAD"), team.org_name && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-blue",
    style: {
      fontSize: 8
    }
  }, team.org_name), teamMode?.roomId === team.roomId && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 8,
      padding: '3px 10px',
      borderRadius: 14,
      fontWeight: 600,
      fontFamily: 'var(--mono)',
      letterSpacing: '.03em',
      background: `hsla(${team.color_hue || 260}, 65%, 55%, 0.10)`,
      color: `hsl(${team.color_hue || 260}, 65%, 55%)`
    }
  }, "ACTIVE"))), team.description && /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-2)',
      lineHeight: 1.5
    }
  }, team.description)), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 18px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 6
    }
  }, "MEMBERS (", team.members?.length || 0, ")"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 3
    }
  }, (team.members || []).slice(0, 5).map((m, mi) => /*#__PURE__*/React.createElement("div", {
    key: mi,
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 18,
      height: 18,
      borderRadius: '50%',
      background: m.role === 'lead' ? 'var(--gold-dim)' : 'var(--bg-3)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: m.role === 'lead' ? 'var(--gold)' : 'var(--tx-2)',
      flexShrink: 0
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: m.role === 'lead' ? 'briefcase' : 'user',
    s: 9
  })), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-1)',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap',
      flex: 1
    }
  }, m.display_name || m.userId), /*#__PURE__*/React.createElement("span", {
    className: `tag ${m.role === 'lead' ? 'tag-gold' : 'tag-blue'}`,
    style: {
      fontSize: 7.5
    }
  }, m.role?.toUpperCase()), m.sharing_consent === 'pending' && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 7
    }
  }, "PENDING"), m.sharing_consent === 'withheld' && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-red",
    style: {
      fontSize: 7
    }
  }, "WITHHELD"), m.sharing_consent === 'shared' && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green",
    style: {
      fontSize: 7
    }
  }, "SHARING"))), (team.members?.length || 0) > 5 && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      fontStyle: 'italic'
    }
  }, "+", team.members.length - 5, " more"))), (() => {
    const myMembership = (team.members || []).find(m => m.userId === svc.userId);
    return myMembership && myMembership.sharing_consent === 'pending' ? /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '10px 18px',
        background: 'var(--gold-dim)',
        borderTop: '1px solid rgba(218,165,32,.15)'
      }
    }, /*#__PURE__*/React.createElement("p", {
      style: {
        fontSize: 11.5,
        color: 'var(--tx-1)',
        lineHeight: 1.6,
        marginBottom: 8
      }
    }, /*#__PURE__*/React.createElement("strong", null, "Content sharing decision required."), " Content about individuals served by this team will be shared with you by default. Would you like to withhold this content from being shared with you?"), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => setSharingConsentModal({
        team,
        memberId: svc.userId
      }),
      className: "b-pri b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 3
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "shield",
      s: 10
    }), "Make My Choice"))) : null;
  })(), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '8px 18px 14px',
      display: 'flex',
      gap: 6,
      flexWrap: 'wrap'
    }
  }, team.owner === svc.userId && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setTeamInviteModal(team);
      setTeamInviteUserId('');
    },
    className: "b-gho b-xs",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 3
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "userPlus",
    s: 11
  }), "Invite"), (() => {
    const myM = (team.members || []).find(m => m.userId === svc.userId);
    return myM && (myM.sharing_consent === 'shared' || myM.sharing_consent === 'withheld') ? /*#__PURE__*/React.createElement("button", {
      onClick: () => setSharingConsentModal({
        team,
        memberId: svc.userId
      }),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 3
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "shield",
      s: 11
    }), "Change Sharing") : null;
  })(), /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-xs",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 3
    },
    onClick: () => {
      if (navigator.clipboard) navigator.clipboard.writeText(team.roomId);
      showToast('Team room ID copied', 'success');
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "share",
    s: 11
  }), "Share ID"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)',
      marginLeft: 'auto',
      display: 'flex',
      alignItems: 'center',
      gap: 3
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "grid",
    s: 9
  }), team.schema?.fields?.length || 0, " fields"))))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--purple-dim,var(--blue-dim))',
      border: '1px solid rgba(128,90,213,.15)',
      borderRadius: 'var(--r)',
      padding: '14px 18px',
      marginTop: 20,
      display: 'flex',
      gap: 10,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 16,
    c: "var(--purple,var(--blue))"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", null, "Teams are flexible."), " They can include anyone \u2014 ", T.staff_term_plural.toLowerCase(), " from your org, people from other orgs, or unaffiliated individuals. Teams are now governed by their own schema \u2014 click a team to view and manage its data definitions."))), view === 'teams' && !activeCase && activeTeamDetail && /*#__PURE__*/React.createElement(TeamDetailView, {
    team: activeTeamDetail,
    teams: teams,
    svc: svc,
    fieldDefs: fieldDefs,
    fieldCrosswalks: fieldCrosswalks,
    showToast: showToast,
    teamMode: teamMode,
    onSwitchTeam: switchTeam,
    onBack: () => setActiveTeamDetail(null),
    onInvite: team => {
      setTeamInviteModal(team);
      setTeamInviteUserId('');
    },
    onUpdateTeam: updated => {
      setTeams(prev => prev.map(t => t.roomId === updated.roomId ? updated : t));
      setActiveTeamDetail(updated);
      setTeamMode(prev => prev && prev.roomId === updated.roomId ? { ...prev, name: updated.name, color_hue: updated.color_hue } : prev);
    },
    onSaveFieldDef: async def => {
      const schemaRoom = svc.client ? svc.client.getRooms().find(r => {
        const id = r.currentState.getStateEvents(EVT.IDENTITY, '');
        return id?.getContent()?.account_type === 'schema' && id.getContent().owner === svc.userId;
      })?.roomId : null;
      if (!schemaRoom) return;
      const updated = {
        ...fieldDefs,
        [def.uri]: def
      };
      await svc.setState(schemaRoom, EVT.FIELD_DEF, {
        definitions: updated
      });
      setFieldDefs(updated);
    },
    onSaveCrosswalk: async xw => {
      const schemaRoom = svc.client ? svc.client.getRooms().find(r => {
        const id = r.currentState.getStateEvents(EVT.IDENTITY, '');
        return id?.getContent()?.account_type === 'schema' && id.getContent().owner === svc.userId;
      })?.roomId : null;
      if (!schemaRoom) return;
      const updated = [...fieldCrosswalks, {
        ...xw,
        created_by: svc.userId
      }];
      await svc.setState(schemaRoom, EVT.FIELD_CROSSWALK, {
        crosswalks: updated
      });
      setFieldCrosswalks(updated);
    }
  }), view === 'case' && activeCaseData && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setView('dashboard');
      setActiveCase(null);
    },
    className: "b-gho b-sm",
    style: {
      marginBottom: 14,
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "back",
    s: 13
  }), "All Cases"), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'flex-start',
      justifyContent: 'space-between'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 20,
      fontWeight: 700
    }
  }, activeCaseData.sharedData.full_name || activeCaseData.clientUserId), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginTop: 4,
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green"
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 9
  }), "Megolm + AES-GCM"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 9.5,
      color: 'var(--tx-3)'
    }
  }, "Client-owned bridge"), activeCaseData.transferable ? /*#__PURE__*/React.createElement("span", {
    className: "tag tag-teal"
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 9
  }), "Transferable") : /*#__PURE__*/React.createElement("span", {
    className: "tag tag-red"
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 9
  }), "Transfer Locked")), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: activeCase,
    encrypted: true,
    encLabel: "Megolm E2EE + AES-256-GCM at rest",
    label: "Case / Bridge Room",
    members: [{ userId: activeCaseData.clientUserId, role: 'client (room owner)' }, { userId: activeCaseData.meta?.provider || svc.userId, role: 'provider' }, ...(activeCaseData.meta?.assigned_staff || []).filter(s => s !== activeCaseData.meta?.provider).map(s => ({ userId: s, role: 'assigned ' + T.staff_term.toLowerCase() }))],
    extra: [{ label: 'Ownership', value: 'The client owns this bridge room (power level 100). Shared data is encrypted and only visible to room members.' }, { label: 'Transfer status', value: activeCaseData.transferable ? 'Transferable \u2014 case can be reassigned to another ' + T.staff_term.toLowerCase() : 'Transfer locked \u2014 only the current provider can access' }]
  })), orgRoom && (orgRole === 'admin' || orgRole === 'case_manager') && staff.length > 1 && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setTransferModal(activeCaseData);
      setTransferTarget('');
    },
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 12
  }), "Transfer")), (() => {
    const assignment = caseAssignments[activeCaseData.bridgeRoomId];
    if (!assignment || !orgRoom) return null;
    return /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 10,
        padding: '10px 14px',
        background: 'var(--bg-2)',
        border: '1px solid var(--border-0)',
        borderRadius: 'var(--r)',
        display: 'flex',
        alignItems: 'center',
        gap: 10
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "briefcase",
      s: 14,
      c: "var(--gold)"
    }), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11.5,
        fontWeight: 600,
        display: 'block'
      }
    }, "Assigned to: ", assignment.primary?.split(':')[0]?.replace('@', '')), assignment.staff?.length > 1 && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-2)'
      }
    }, "+", assignment.staff.length - 1, " additional ", T.staff_term_plural.toLowerCase(), " with access"), assignment?.transferred_from && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9.5,
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)',
        display: 'block',
        marginTop: 2
      }
    }, "Transferred from ", assignment.transferred_from.split(':')[0]?.replace('@', ''), assignment.transferred_at ? ` on ${new Date(assignment.transferred_at).toLocaleDateString()}` : '')), assignment.primary === svc.userId && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-gold",
      style: {
        fontSize: 8
      }
    }, "YOU"));
  })()), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "SHARED DATA \u2014 CLIENT CONTROLLED"), (() => {
    const allFwFields = getFrameworkFields(FRAMEWORK_FIELD_STANDARDS.map(fw => fw.id));
    const knownKeys = new Set([...VAULT_FIELDS.map(f => f.key), ...allFwFields.map(f => f.key)]);
    const fwFieldsByKey = {};
    allFwFields.forEach(f => {
      fwFieldsByKey[f.key] = f;
    });
    const customShared = Object.keys(activeCaseData.sharedData).filter(k => !knownKeys.has(k));
    const sharedFwFields = allFwFields.filter(f => activeCaseData.sharedData[f.key]);
    return /*#__PURE__*/React.createElement(React.Fragment, null, FIELD_CATEGORIES.map(cat => {
      const fields = VAULT_FIELDS.filter(f => f.category === cat && activeCaseData.sharedData[f.key]);
      if (!fields.length) return null;
      return /*#__PURE__*/React.createElement("div", {
        key: cat,
        style: {
          marginBottom: 10
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: 6,
          marginBottom: 6
        }
      }, /*#__PURE__*/React.createElement("span", {
        style: {
          color: `var(--${CAT_COLORS[cat]})`
        }
      }, /*#__PURE__*/React.createElement(I, {
        n: CAT_ICONS[cat],
        s: 12
      })), /*#__PURE__*/React.createElement("span", {
        style: {
          fontSize: 10.5,
          fontFamily: 'var(--mono)',
          color: 'var(--tx-2)',
          letterSpacing: '.05em'
        }
      }, CAT_LABELS[cat].toUpperCase())), fields.map(f => {
        const provOpen = provenanceTarget?.entityKey === f.key && provenanceTarget?.roomId === activeCase;
        return /*#__PURE__*/React.createElement(React.Fragment, {
          key: f.key
        }, /*#__PURE__*/React.createElement("div", {
          style: {
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            padding: '6px 0',
            borderBottom: '1px solid var(--border-0)'
          }
        }, /*#__PURE__*/React.createElement("span", {
          style: {
            fontSize: 12,
            color: 'var(--tx-1)'
          }
        }, f.label), /*#__PURE__*/React.createElement("div", {
          style: {
            display: 'flex',
            alignItems: 'center',
            gap: 6
          }
        }, /*#__PURE__*/React.createElement("span", {
          style: {
            fontSize: 12.5,
            fontWeight: 500,
            maxWidth: 220,
            overflow: 'hidden',
            textOverflow: 'ellipsis',
            whiteSpace: 'nowrap'
          }
        }, activeCaseData.sharedData[f.key]), /*#__PURE__*/React.createElement("span", {
          onClick: () => setProvenanceTarget(provOpen ? null : {
            entityKey: f.key,
            label: f.label,
            roomId: activeCase
          }),
          style: {
            cursor: 'pointer',
            color: provOpen ? 'var(--teal)' : 'var(--tx-3)',
            transition: 'color .15s',
            flexShrink: 0
          },
          title: "View provenance"
        }, /*#__PURE__*/React.createElement(I, {
          n: "git-commit",
          s: 11
        })))), provOpen && /*#__PURE__*/React.createElement("div", {
          style: {
            padding: '4px 0 8px'
          }
        }, /*#__PURE__*/React.createElement(RecordProvenance, {
          roomId: activeCase,
          entityKey: f.key,
          label: f.label,
          session: session
        })));
      }));
    }), sharedFwFields.length > 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        marginBottom: 10
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginBottom: 6
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--blue)'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "grid",
      s: 12
    })), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        fontFamily: 'var(--mono)',
        color: 'var(--tx-2)',
        letterSpacing: '.05em'
      }
    }, "FRAMEWORK FIELDS")), sharedFwFields.map(f => /*#__PURE__*/React.createElement("div", {
      key: f.key,
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: '6px 0',
        borderBottom: '1px solid var(--border-0)'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        color: 'var(--tx-1)'
      }
    }, f.label), /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${FRAMEWORK_BY_ID[f.framework]?.accent || 'blue'}`,
      style: {
        fontSize: 7.5,
        padding: '1px 5px'
      }
    }, f.frameworkName)), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        fontWeight: 500,
        maxWidth: 220,
        overflow: 'hidden',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap'
      }
    }, activeCaseData.sharedData[f.key])))), customShared.length > 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        marginBottom: 10
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginBottom: 6
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        color: 'var(--purple)'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "file",
      s: 12
    })), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10.5,
        fontFamily: 'var(--mono)',
        color: 'var(--tx-2)',
        letterSpacing: '.05em'
      }
    }, "CLIENT CUSTOM FIELDS")), customShared.map(k => /*#__PURE__*/React.createElement("div", {
      key: k,
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        padding: '6px 0',
        borderBottom: '1px solid var(--border-0)'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12,
        color: 'var(--tx-1)'
      }
    }, k.replace(/^custom_/, '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        fontWeight: 500,
        maxWidth: 260,
        overflow: 'hidden',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap'
      }
    }, activeCaseData.sharedData[k])))));
  })(), Object.keys(activeCaseData.sharedData).length === 0 && /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 12,
      padding: '10px 0'
    }
  }, "No fields shared yet")), provObservations.filter(obs => {
    const prompt = [...DEFAULT_PROMPTS, ...DEFAULT_PROVIDER_PROMPTS].find(p => p.id === obs.prompt_id || p.key === obs.prompt_key);
    return prompt && FRAMEWORK_BINDINGS[prompt.key]?.bindings?.[obs.value];
  }).length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 24,
      height: 24,
      borderRadius: '50%',
      background: 'linear-gradient(135deg,var(--teal),var(--gold))',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--bg-0)',
      fontSize: 11,
      fontWeight: 800
    }
  }, "\u2192"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 15,
      fontWeight: 700
    }
  }, "GIVEN / MEANT Divide"), /*#__PURE__*/React.createElement("span", {
    className: "gm-sup-badge"
  }, "SUP")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginBottom: 10
    }
  }, "Same observations, different institutional meanings. Each framework interprets the data according to its own rules."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 10
    }
  }, provObservations.filter(obs => {
    const prompt = [...DEFAULT_PROMPTS, ...DEFAULT_PROVIDER_PROMPTS].find(p => p.id === obs.prompt_id || p.key === obs.prompt_key);
    return prompt && FRAMEWORK_BINDINGS[prompt.key]?.bindings?.[obs.value];
  }).map((obs, i) => {
    const prompt = [...DEFAULT_PROMPTS, ...DEFAULT_PROVIDER_PROMPTS].find(p => p.id === obs.prompt_id || p.key === obs.prompt_key);
    return /*#__PURE__*/React.createElement(RecordGivenMeant, {
      key: obs.id || i,
      promptKey: prompt.key,
      value: obs.value,
      reporter: obs.author ? `${T.provider_term}: ${obs.author}` : `${T.provider_term} observation`,
      timestamp: obs.ts
    });
  }))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0
    }
  }, T.provider_term.toUpperCase(), " OBSERVATIONS (MEANT)"), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold"
  }, "EPISTEMIC: MEANT")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginBottom: 10
    }
  }, "Structured assessments and case management observations. Each entry is an EO event in the bridge room with full provenance."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fill,minmax(200px,1fr))',
      gap: 6,
      marginBottom: 12
    }
  }, DEFAULT_PROVIDER_PROMPTS.map(p => /*#__PURE__*/React.createElement("div", {
    key: p.id,
    className: "card-h",
    onClick: () => {
      setProvObsModal(p);
      setProvObsValue('');
      setProvObsNotes('');
    },
    style: {
      padding: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4,
      marginBottom: 4,
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tag tag-${OBS_CAT_COLORS[p.category] || 'purple'}`,
    style: {
      fontSize: 8.5
    }
  }, p.category), p.maturity && /*#__PURE__*/React.createElement(MaturityBadge, {
    maturity: p.maturity
  }), p.source && /*#__PURE__*/React.createElement(SourceBadge, {
    source: p.source
  })), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11.5,
      fontWeight: 600,
      display: 'block'
    }
  }, p.question)))), provObservations.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "RECORDED (", provObservations.length, ")"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 3,
      marginTop: 4
    }
  }, [...provObservations].reverse().map((obs, i) => {
    const prompt = DEFAULT_PROVIDER_PROMPTS.find(p => p.id === obs.prompt_id || p.key === obs.prompt_key);
    const optLabel = prompt?.options?.find(o => o.v === obs.value)?.l || obs.value;
    const obsProvKey = obs.prompt_key || prompt?.key || obs.prompt_id;
    const obsProvOpen = provenanceTarget?.entityKey === obsProvKey && provenanceTarget?.roomId === activeCase && provenanceTarget?._obsId === obs.id;
    return /*#__PURE__*/React.createElement(React.Fragment, {
      key: obs.id || i
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '8px 12px',
        background: 'var(--bg-3)',
        borderRadius: 'var(--r)',
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${OBS_CAT_COLORS[prompt?.category] || 'purple'}`,
      style: {
        fontSize: 8.5
      }
    }, prompt?.category || 'obs'), /*#__PURE__*/React.createElement("span", {
      className: "tag tag-gold",
      style: {
        fontSize: 8
      }
    }, "MEANT"), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11.5,
        flex: 1
      }
    }, prompt?.question, ": ", /*#__PURE__*/React.createElement("strong", null, optLabel)), obs.created_by && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 8.5,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      },
      title: obs.created_by
    }, obs.created_by.split(':')[0]?.slice(1)), obs.origin_server && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 8,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, obs.origin_server), obs.notes && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-2)',
        fontStyle: 'italic'
      }
    }, obs.notes), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, obs.ts ? new Date(obs.ts).toLocaleTimeString() : ''), /*#__PURE__*/React.createElement("span", {
      onClick: () => setProvenanceTarget(obsProvOpen ? null : {
        entityKey: obsProvKey,
        label: `Observation: ${prompt?.category || 'obs'}`,
        roomId: activeCase,
        _obsId: obs.id
      }),
      style: {
        cursor: 'pointer',
        color: obsProvOpen ? 'var(--teal)' : 'var(--tx-3)',
        transition: 'color .15s',
        flexShrink: 0
      },
      title: "View provenance"
    }, /*#__PURE__*/React.createElement(I, {
      n: "git-commit",
      s: 10
    }))), obsProvOpen && /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 2,
        marginBottom: 4
      }
    }, /*#__PURE__*/React.createElement(RecordProvenance, {
      roomId: activeCase,
      entityKey: obsProvKey,
      label: `Observation: ${prompt?.category || 'obs'}`,
      session: session
    })));
  })))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0
    }
  }, "RESOURCES"), orgRoom && resourceTypes.length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setAllocDraft({
        resource_type_id: resourceTypes[0]?.id || '',
        quantity: 1,
        notes: ''
      });
      setAllocModal(true);
    },
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 11
  }), "Allocate")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginBottom: 10
    }
  }, "Resources allocated to this ", T.client_term.toLowerCase(), " through this bridge. Each allocation is an EO event with full provenance."), caseAllocations.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '16px 0',
      color: 'var(--tx-3)',
      fontSize: 12
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "layers",
    s: 20
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      marginTop: 6
    }
  }, "No resources allocated yet")) : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 6
    }
  }, [...caseAllocations].sort((a, b) => (b.allocated_at || 0) - (a.allocated_at || 0)).map(alloc => {
    const rt = resourceTypes.find(t => t.id === alloc.resource_type_id);
    const statusColors = {
      active: 'teal',
      consumed: 'blue',
      expired: 'orange',
      revoked: 'red'
    };
    const allocProvOpen = provenanceTarget?.entityKey === alloc.id && provenanceTarget?.roomId === activeCase;
    return /*#__PURE__*/React.createElement(React.Fragment, {
      key: alloc.id
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '10px 14px',
        background: 'var(--bg-3)',
        borderRadius: 'var(--r)',
        border: '1px solid var(--border-0)'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        marginBottom: 4
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        fontWeight: 600
      }
    }, rt?.name || alloc.resource_type_id), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11,
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)'
      }
    }, "x", alloc.quantity, " ", alloc.unit || rt?.unit || '')), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${statusColors[alloc.status] || 'teal'}`,
      style: {
        fontSize: 8.5
      }
    }, alloc.status?.toUpperCase()), /*#__PURE__*/React.createElement("span", {
      onClick: () => setProvenanceTarget(allocProvOpen ? null : {
        entityKey: alloc.id,
        label: `Resource: ${rt?.name || alloc.resource_type_id}`,
        roomId: activeCase
      }),
      style: {
        cursor: 'pointer',
        color: allocProvOpen ? 'var(--teal)' : 'var(--tx-3)',
        transition: 'color .15s'
      },
      title: "View provenance"
    }, /*#__PURE__*/React.createElement(I, {
      n: "git-commit",
      s: 11
    })))), alloc.created_by && /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginBottom: 4
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      },
      title: alloc.created_by
    }, "Allocated by: ", alloc.created_by.split(':')[0]?.slice(1)), alloc.origin_server && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 8.5,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, alloc.origin_server)), alloc.notes && /*#__PURE__*/React.createElement("p", {
      style: {
        fontSize: 11,
        color: 'var(--tx-2)',
        marginBottom: 4,
        fontStyle: 'italic'
      }
    }, alloc.notes), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9.5,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, alloc.allocated_at ? new Date(alloc.allocated_at).toLocaleDateString() : '', alloc.expires_at ? ` · expires ${new Date(alloc.expires_at).toLocaleDateString()}` : ''), alloc.status === 'active' && /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => handleResourceLifecycle(alloc.id, 'consumed'),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 3
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "check",
      s: 10
    }), "Used"), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleResourceLifecycle(alloc.id, 'returned'),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 3
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "refresh-cw",
      s: 10
    }), "Return"), /*#__PURE__*/React.createElement("button", {
      onClick: () => handleResourceLifecycle(alloc.id, 'revoked'),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 3,
        color: 'var(--red)'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "x",
      s: 10
    }), "Revoke")))), allocProvOpen && /*#__PURE__*/React.createElement("div", {
      style: {
        marginTop: 2,
        marginBottom: 4
      }
    }, /*#__PURE__*/React.createElement(RecordProvenance, {
      roomId: activeCase,
      entityKey: alloc.id,
      label: `Resource: ${rt?.name || alloc.resource_type_id}`,
      session: session
    })));
  }))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "REQUEST INFORMATION"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("input", {
    value: requestText,
    onChange: e => setRequestText(e.target.value),
    placeholder: "e.g. Could you share employment docs?",
    onKeyDown: e => {
      if (e.key === 'Enter') handleSendRequest();
    }
  }), /*#__PURE__*/React.createElement("button", {
    onClick: handleSendRequest,
    className: "b-pri",
    style: {
      whiteSpace: 'nowrap'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "send",
    s: 12
  }), "Request"))), /*#__PURE__*/React.createElement("div", {
    className: "card"
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "MESSAGES"), /*#__PURE__*/React.createElement("div", {
    style: {
      maxHeight: 260,
      overflow: 'auto',
      marginBottom: 12
    }
  }, messages.length === 0 ? /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 12,
      padding: '12px 0',
      textAlign: 'center'
    }
  }, "No messages") : messages.map((msg, i) => /*#__PURE__*/React.createElement("div", {
    key: msg.id || i,
    style: {
      padding: '8px 0',
      borderBottom: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      marginBottom: 3
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10,
      color: msg.sender === svc.userId ? 'var(--gold)' : 'var(--teal)'
    }
  }, msg.sender === svc.userId ? `You (${T.provider_term})` : T.client_term), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 9,
      color: 'var(--tx-3)'
    }
  }, msg.ts ? new Date(msg.ts).toLocaleString() : '')), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12.5,
      color: 'var(--tx-1)'
    }
  }, msg.content?.body)))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("input", {
    value: msgText,
    onChange: e => setMsgText(e.target.value),
    placeholder: "Message (E2EE)...",
    onKeyDown: e => {
      if (e.key === 'Enter' && !e.shiftKey) handleSendMsg();
    },
    style: {
      flex: 1
    }
  }), /*#__PURE__*/React.createElement("button", {
    onClick: handleSendMsg,
    className: "b-pri"
  }, /*#__PURE__*/React.createElement(I, {
    n: "send",
    s: 13
  }))))), view === 'hierarchy' && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700,
      marginBottom: 4
    }
  }, "My Network"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginBottom: 20
    }
  }, "Teams and organizations you\u2019re part of, shown as a hierarchy."), (() => {
    /* ─── Build hierarchy tree ─── */
    const rootTeams = teams.filter(t => !t.hierarchy?.parent_team_id);
    const renderTeamNode = (team, depth) => {
      const children = (team.hierarchy?.child_teams || []).map(c => teams.find(t => t.roomId === c.roomId)).filter(Boolean);
      const govMode = TEAM_CONSENT_MODES[team.schemaRule?.consent_mode || team.governance || 'lead_decides'] || TEAM_CONSENT_MODES.lead_decides;
      const teamColor = `hsl(${team.color_hue || 260}, 60%, 55%)`;
      return /*#__PURE__*/React.createElement("div", { key: team.roomId, style: { marginLeft: depth * 20 } },
        /*#__PURE__*/React.createElement("div", {
          style: {
            display: 'flex', alignItems: 'center', gap: 8, padding: '8px 12px',
            borderRadius: 'var(--r)', cursor: 'pointer', transition: 'background .15s',
            borderLeft: `3px solid ${teamColor}`, marginBottom: 4, background: 'var(--bg-2)'
          },
          onClick: () => { switchTeamContext(team.roomId); setView('teams'); setActiveTeamDetail(team); },
          onMouseEnter: e => { e.currentTarget.style.background = 'var(--bg-3)'; },
          onMouseLeave: e => { e.currentTarget.style.background = 'var(--bg-2)'; }
        },
          /*#__PURE__*/React.createElement("span", { style: { width: 8, height: 8, borderRadius: '50%', background: teamColor, flexShrink: 0 } }),
          /*#__PURE__*/React.createElement("div", { style: { flex: 1, minWidth: 0 } },
            /*#__PURE__*/React.createElement("div", { style: { fontWeight: 600, fontSize: 12.5, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, team.name || 'Unnamed Team'),
            /*#__PURE__*/React.createElement("div", { style: { fontSize: 10.5, color: 'var(--tx-2)', marginTop: 1, display: 'flex', gap: 8, flexWrap: 'wrap' } },
              /*#__PURE__*/React.createElement("span", null, (team.members || []).length, " member", (team.members || []).length !== 1 ? "s" : ""),
              (team.customTables || []).filter(t => t.status === 'active').length > 0 && /*#__PURE__*/React.createElement("span", null, (team.customTables || []).filter(t => t.status === 'active').length, " table", (team.customTables || []).filter(t => t.status === 'active').length !== 1 ? "s" : ""),
              children.length > 0 && /*#__PURE__*/React.createElement("span", null, children.length, " sub-team", children.length !== 1 ? "s" : "")
            )
          ),
          /*#__PURE__*/React.createElement("span", {
            className: `tag tag-${govMode.color}`,
            style: { fontSize: 8, flexShrink: 0 }
          }, /*#__PURE__*/React.createElement(I, { n: govMode.icon, s: 8 }), govMode.label)
        ),
        children.length > 0 && children.map(c => renderTeamNode(c, depth + 1))
      );
    };
    return /*#__PURE__*/React.createElement(React.Fragment, null,
      /* ─── Network level ─── */
      networkRoom && /*#__PURE__*/React.createElement("div", { className: "card", style: { marginBottom: 12 } },
        /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 } },
          /*#__PURE__*/React.createElement(I, { n: "globe", s: 16, c: "var(--blue)" }),
          /*#__PURE__*/React.createElement("span", { className: "section-label", style: { marginBottom: 0 } }, "NETWORK")
        ),
        networkMembers.length > 0 ? networkMembers.map((nm, i) => {
          const isOwnOrg = orgMeta && (nm.name === orgMeta.name || nm.id === orgRoom);
          return /*#__PURE__*/React.createElement("div", {
            key: nm.id || i,
            style: {
              display: 'flex', alignItems: 'center', gap: 8, padding: '6px 12px', marginLeft: 20,
              borderLeft: '2px solid var(--border-1)', marginBottom: 2,
              borderRadius: '0 var(--r) var(--r) 0', background: isOwnOrg ? 'var(--blue-dim)' : 'transparent'
            }
          },
            /*#__PURE__*/React.createElement(I, { n: "briefcase", s: 12, c: isOwnOrg ? "var(--blue)" : "var(--tx-2)" }),
            /*#__PURE__*/React.createElement("span", { style: { fontSize: 12, fontWeight: isOwnOrg ? 600 : 400, flex: 1 } }, nm.name || nm.id || 'Unknown Org'),
            isOwnOrg && /*#__PURE__*/React.createElement("span", { className: "tag tag-blue", style: { fontSize: 8 } }, "YOU"),
            nm.role && nm.role !== 'member' && /*#__PURE__*/React.createElement("span", { className: "tag tag-gold", style: { fontSize: 8 } }, nm.role.toUpperCase())
          );
        }) : /*#__PURE__*/React.createElement("p", { style: { fontSize: 11, color: 'var(--tx-3)', marginLeft: 20, fontStyle: 'italic' } }, "No member organizations yet")
      ),
      /* ─── Organization level ─── */
      orgRoom && /*#__PURE__*/React.createElement("div", { className: "card", style: { marginBottom: 12 } },
        /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 } },
          /*#__PURE__*/React.createElement(I, { n: "briefcase", s: 16, c: "var(--gold)" }),
          /*#__PURE__*/React.createElement("span", { className: "section-label", style: { marginBottom: 0 } }, "ORGANIZATION"),
          /*#__PURE__*/React.createElement("span", { style: { fontSize: 12.5, fontWeight: 600, marginLeft: 4 } }, orgMeta?.name || 'My Organization')
        ),
        /*#__PURE__*/React.createElement("div", { style: { display: 'flex', gap: 10, marginBottom: 10, marginLeft: 24 } },
          /*#__PURE__*/React.createElement("span", { style: { fontSize: 11, color: 'var(--tx-2)' } }, (orgStaff || []).length, " staff member", (orgStaff || []).length !== 1 ? "s" : ""),
          teams.length > 0 && /*#__PURE__*/React.createElement("span", { style: { fontSize: 11, color: 'var(--tx-2)' } }, teams.length, " team", teams.length !== 1 ? "s" : ""),
          networkRoom && /*#__PURE__*/React.createElement("span", { style: { fontSize: 11, color: 'var(--tx-2)' } }, /*#__PURE__*/React.createElement(I, { n: "globe", s: 10 }), " In network")
        ),
        /* ─── Teams nested under org ─── */
        rootTeams.length > 0 ? /*#__PURE__*/React.createElement("div", { style: { marginLeft: 4 } },
          /*#__PURE__*/React.createElement("span", { className: "section-label", style: { fontSize: 9, marginBottom: 6, display: 'block', marginLeft: 20 } }, "TEAMS"),
          rootTeams.map(t => renderTeamNode(t, 1))
        ) : /*#__PURE__*/React.createElement("p", { style: { fontSize: 11, color: 'var(--tx-3)', marginLeft: 24, fontStyle: 'italic' } }, "No teams yet \u2014 create one from the Teams view")
      ),
      /* ─── No org fallback: just teams ─── */
      !orgRoom && /*#__PURE__*/React.createElement("div", { className: "card", style: { marginBottom: 12 } },
        /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 } },
          /*#__PURE__*/React.createElement(I, { n: "users", s: 16, c: "var(--gold)" }),
          /*#__PURE__*/React.createElement("span", { className: "section-label", style: { marginBottom: 0 } }, "YOUR TEAMS")
        ),
        rootTeams.length > 0 ? rootTeams.map(t => renderTeamNode(t, 0))
          : /*#__PURE__*/React.createElement("div", { style: { textAlign: 'center', padding: '20px', borderStyle: 'dashed', border: '1px dashed var(--border-1)', borderRadius: 'var(--r)' } },
            /*#__PURE__*/React.createElement(I, { n: "users", s: 28 }),
            /*#__PURE__*/React.createElement("p", { style: { color: 'var(--tx-3)', marginTop: 8 } }, "No teams yet. Create or join a team to see your hierarchy here.")
          )
      )
    );
  })()), view === 'schema' && /*#__PURE__*/React.createElement(SchemaWorkbench, {
    isOrg: !!orgRoom,
    orgMeta: orgMeta,
    networkMembers: networkMembers,
    fieldDefs: fieldDefs,
    catLabels: CAT_LABELS,
    catColors: CAT_COLORS,
    onSaveFieldDef: async def => {
      const schemaRoom = svc.client ? svc.client.getRooms().find(r => {
        const id = r.currentState.getStateEvents(EVT.IDENTITY, '');
        return id?.getContent()?.account_type === 'schema' && id.getContent().owner === svc.userId;
      })?.roomId : null;
      if (!schemaRoom) return;
      const updated = { ...fieldDefs, [def.uri]: def };
      await svc.setState(schemaRoom, EVT.FIELD_DEF, { definitions: updated });
      setFieldDefs(updated);
    }
  }), view === 'org-settings' && orgRoom && orgRole === 'admin' && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700,
      marginBottom: 4
    }
  }, "Organization Settings"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginBottom: 24
    }
  }, "Manage your organization metadata, privacy, and inter-org messaging configuration."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: orgRoom,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Org Settings",
    members: staff.map(s => ({ userId: s.userId, role: s.role })),
    extra: [{ label: 'Org room', value: 'Organization metadata, roster, opacity settings, terminology, and email verification config are stored as state events in this shared org room.' }, { label: 'Access', value: 'All org ' + T.staff_term_plural.toLowerCase() + ' can read. Only admins can modify settings.' }]
  }), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ORGANIZATION DETAILS"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 12,
      marginTop: 8
    }
  }, [{
    l: 'Name',
    v: orgMeta.name || '—'
  }, {
    l: 'Type',
    v: ORG_TYPE_LABELS[orgMeta.type] || orgMeta.type || '—'
  }, {
    l: 'Service Area',
    v: orgMeta.service_area || '—'
  }, {
    l: 'Languages',
    v: (orgMeta.languages || []).join(', ') || '—'
  }, {
    l: T.staff_term_plural,
    v: `${staff.length} members`
  }, {
    l: 'Room',
    v: orgRoom?.slice(0, 24) + '…'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 500,
      display: 'block'
    }
  }, s.v))))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "settings",
    s: 16,
    c: "var(--gold)"
  }), /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0
    }
  }, "TERMINOLOGY"), (T.client_term !== 'Client' || T.provider_term !== 'Provider' || T.staff_term !== 'Team Member') && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 8
    }
  }, "CUSTOMIZED")), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setTerminologyDraft({
        ...orgTerminology
      });
      setTerminologyModal(true);
    },
    className: "b-gho b-xs",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "settings",
    s: 11
  }), "Customize")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-2)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Customize what your organization calls its service recipients and service providers. These terms appear throughout the interface for all ", T.staff_term_plural.toLowerCase(), " in your organization."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 14px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 6
    }
  }, "SERVICE RECIPIENT"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 15,
      fontWeight: 700,
      display: 'block'
    }
  }, T.client_term), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, "Plural: ", T.client_term_plural)), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '12px 14px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 6
    }
  }, "SERVICE PROVIDER"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 15,
      fontWeight: 700,
      display: 'block'
    }
  }, T.provider_term), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, "Plural: ", T.provider_term_plural))), (T.client_term !== 'Client' || T.provider_term !== 'Provider' || T.staff_term !== 'Team Member') && /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 10,
      padding: '8px 12px',
      background: 'var(--gold-dim)',
      borderRadius: 'var(--r)',
      fontSize: 11,
      color: 'var(--gold)',
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "alert",
    s: 12,
    c: "var(--gold)"
  }), "Custom terminology active \u2014 ", T.staff_term_plural.toLowerCase(), " will see \"", T.client_term, "\" and \"", T.provider_term, "\" instead of the defaults.")), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "eyeOff",
    s: 16,
    c: "var(--purple)"
  }), /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0
    }
  }, "ORGANIZATION OPACITY"), /*#__PURE__*/React.createElement("span", {
    className: `tag ${orgOpacity === 'opaque' ? 'tag-red' : orgOpacity === 'translucent' ? 'tag-gold' : 'tag-green'}`,
    style: {
      fontSize: 9
    }
  }, OPACITY_LABELS[orgOpacity]?.toUpperCase())), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-2)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Controls how much of your organization's identity is revealed when communicating with other organizations. This affects all outgoing inter-org messages."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 8
    }
  }, OPACITY_LEVELS.map(level => /*#__PURE__*/React.createElement("div", {
    key: level,
    onClick: () => handleSaveOpacity(level),
    style: {
      padding: '14px 16px',
      borderRadius: 'var(--r-lg)',
      cursor: 'pointer',
      border: `2px solid ${orgOpacity === level ? 'var(--gold)' : 'var(--border-1)'}`,
      background: orgOpacity === level ? 'var(--gold-dim)' : 'var(--bg-3)',
      transition: 'all .18s'
    },
    onMouseEnter: e => {
      if (orgOpacity !== level) e.currentTarget.style.borderColor = 'var(--border-2)';
    },
    onMouseLeave: e => {
      if (orgOpacity !== level) e.currentTarget.style.borderColor = 'var(--border-1)';
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 4
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      width: 10,
      height: 10,
      borderRadius: '50%',
      border: `2px solid ${orgOpacity === level ? 'var(--gold)' : 'var(--tx-3)'}`,
      background: orgOpacity === level ? 'var(--gold)' : 'transparent',
      flexShrink: 0
    }
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 14,
      fontWeight: 700,
      color: orgOpacity === level ? 'var(--gold)' : 'var(--tx-0)'
    }
  }, OPACITY_LABELS[level]), level === 'opaque' && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-red",
    style: {
      fontSize: 8
    }
  }, "MAX PRIVACY"), level === 'translucent' && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 8
    }
  }, "RECOMMENDED"), level === 'transparent' && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green",
    style: {
      fontSize: 8
    }
  }, "OPEN")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-2)',
      lineHeight: 1.5,
      marginLeft: 18
    }
  }, (OPACITY_DESCRIPTIONS[level] || '').replace(/staff member/gi, T.staff_term.toLowerCase())), /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 8,
      marginLeft: 18,
      padding: '8px 12px',
      background: 'var(--bg-1)',
      borderRadius: 'var(--r)',
      border: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 4
    }
  }, "EXTERNAL ORG SEES:"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-1)'
    }
  }, level === 'transparent' ? `"${providerProfile.display_name || 'Jamie R.'} from ${orgMeta.name || 'Your Org'}"` : level === 'translucent' ? `"${orgMeta.name || 'Your Org'}"` : '"An organization"')))))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 16,
    c: "var(--blue)"
  }), /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0
    }
  }, "INTER-ORG MESSAGE ACCESS")), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setMsgAccessDraft({
        ...orgMsgAccess
      });
      setMsgAccessModal(true);
    },
    className: "b-gho b-xs",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "settings",
    s: 11
  }), "Configure")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-2)',
      marginBottom: 12,
      lineHeight: 1.6
    }
  }, "Control which ", T.staff_term_plural.toLowerCase(), " roles can read and respond to messages sent to your organization from other organizations."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 10
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 14px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 6
    }
  }, "CAN READ"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4,
      flexWrap: 'wrap'
    }
  }, orgMsgAccess.read?.map(r => /*#__PURE__*/React.createElement("span", {
    key: r,
    className: "tag tag-blue",
    style: {
      fontSize: 9
    }
  }, activeOrgRoleLabels[r] || r)), (!orgMsgAccess.read || orgMsgAccess.read.length === 0) && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      fontStyle: 'italic'
    }
  }, "No roles assigned"))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 14px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 6
    }
  }, "CAN RESPOND"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4,
      flexWrap: 'wrap'
    }
  }, orgMsgAccess.respond?.map(r => /*#__PURE__*/React.createElement("span", {
    key: r,
    className: "tag tag-gold",
    style: {
      fontSize: 9
    }
  }, activeOrgRoleLabels[r] || r)), (!orgMsgAccess.respond || orgMsgAccess.respond.length === 0) && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      fontStyle: 'italic'
    }
  }, "No roles assigned"))))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "msg",
    s: 16,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0
    }
  }, "MESSAGING CHANNELS (", orgChannels.length, ")")), /*#__PURE__*/React.createElement("button", {
    onClick: () => setComposeOrgModal(true),
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 12
  }), "New Channel")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-2)',
      marginBottom: 10,
      lineHeight: 1.6
    }
  }, "Secure encrypted channels for org-to-org communication. Messages are governed by your opacity setting."), orgChannels.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '20px 0'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "msg",
    s: 24
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 11,
      marginTop: 6
    }
  }, "No messaging channels yet. Create one to start communicating with another organization.")) : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4
    }
  }, orgChannels.map(ch => {
    const peerOrgId = ch.orgs?.find(o => o !== orgRoom);
    const peerName = ch.org_names?.[peerOrgId] || peerOrgId?.slice(0, 20) || 'Unknown Org';
    return /*#__PURE__*/React.createElement("div", {
      key: ch.roomId,
      onClick: () => openChannel(ch.roomId),
      className: "card-h",
      style: {
        padding: '10px 14px'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        width: 28,
        height: 28,
        borderRadius: '50%',
        background: 'var(--teal-dim)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: 'var(--teal)'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "msg",
      s: 14
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        fontWeight: 600,
        display: 'block'
      }
    }, peerName), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9.5,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, ch.roomId?.slice(0, 20), "\u2026"))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag ${orgOpacity === 'opaque' ? 'tag-red' : orgOpacity === 'translucent' ? 'tag-gold' : 'tag-green'}`,
      style: {
        fontSize: 8
      }
    }, OPACITY_LABELS[orgOpacity]), /*#__PURE__*/React.createElement(I, {
      n: "chevR",
      s: 13,
      c: "var(--tx-3)"
    }))));
  }))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ORG ROOM ID"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 11,
      color: 'var(--tx-1)',
      background: 'var(--bg-3)',
      padding: '8px 12px',
      borderRadius: 'var(--r)',
      wordBreak: 'break-all',
      marginTop: 4
    }
  }, orgRoom), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginTop: 8
    }
  }, "Share this room ID with providers who want to join your organization, or with other orgs to open a messaging channel.")), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 8
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 16,
    c: emailVerifyConfig.enabled ? 'var(--green)' : 'var(--tx-3)'
  }), /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      margin: 0
    }
  }, "EMAIL VERIFICATION"), /*#__PURE__*/React.createElement("span", {
    className: `tag ${emailVerifyConfig.enabled ? 'tag-green' : 'tag-gold'}`,
    style: {
      fontSize: 8
    }
  }, emailVerifyConfig.enabled ? 'ENABLED' : 'DISABLED')), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setEmailConfigDraft({
        ...emailVerifyConfig
      });
      setEmailConfigModal(true);
    },
    className: "b-gho b-xs"
  }, /*#__PURE__*/React.createElement(I, {
    n: "settings",
    s: 11
  }), " Configure")), emailVerifyConfig.enabled ? /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6,
      marginBottom: 8
    }
  }, T.staff_term_plural, " must verify their identity via email before accessing cases. Verification confirms they control an email address at an approved domain."), emailVerifyConfig.required_domains?.length > 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 4
    }
  }, "APPROVED DOMAINS"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4,
      flexWrap: 'wrap'
    }
  }, emailVerifyConfig.required_domains.map((d, i) => /*#__PURE__*/React.createElement("span", {
    key: i,
    className: "tag tag-blue",
    style: {
      fontSize: 9
    }
  }, "@", d)))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 4
    }
  }, "REQUIRED FOR ROLES"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4,
      flexWrap: 'wrap'
    }
  }, emailVerifyConfig.require_for_roles?.map((r, i) => /*#__PURE__*/React.createElement("span", {
    key: i,
    className: "tag tag-gold",
    style: {
      fontSize: 9
    }
  }, activeOrgRoleLabels[r] || r)))), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)'
    }
  }, "Grace period: ", emailVerifyConfig.grace_period_hours, "h \xB7 ", staff.filter(s => s.email_verification?.status === 'verified').length, "/", staff.length, " verified")) : /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-2)',
      lineHeight: 1.6
    }
  }, "Email verification is disabled. Enable it to require ", T.staff_term_plural.toLowerCase(), " to confirm their identity with an organization email address before accessing cases."))), view === 'staff' && orgRoom && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, T.staff_term_plural, " Roster"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "Manage ", T.staff_term_plural.toLowerCase(), " membership and roles. Each role determines case access level."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: orgRoom,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: T.staff_term_plural + ' Roster',
    members: staff.map(s => ({ userId: s.userId, role: s.role })),
    extra: [{ label: 'Storage', value: T.staff_term_plural + ' roster is stored as a state event in the shared organization room. All org members can read the roster; only admins can modify it.' }]
  })), orgRole === 'admin' && /*#__PURE__*/React.createElement("button", {
    onClick: () => setInviteModal(true),
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "Invite ", T.staff_term)), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 6 }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ROLE DEFINITIONS"), orgRole === 'admin' && /*#__PURE__*/React.createElement("button", {
    onClick: () => setAddRoleModal(true),
    className: "b-gho b-xs",
    style: { display: 'flex', alignItems: 'center', gap: 4, fontSize: 10 }
  }, /*#__PURE__*/React.createElement(I, { n: "plus", s: 10 }), "Add Role")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 8,
      marginTop: 6
    }
  }, orgRolesConfig.map(rc => /*#__PURE__*/React.createElement("div", {
    key: rc.key,
    style: {
      padding: '8px 12px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      position: 'relative'
    }
  }, editingRole?.key === rc.key ? /*#__PURE__*/React.createElement("div", { style: { display: 'flex', flexDirection: 'column', gap: 6 } },
    /*#__PURE__*/React.createElement("input", {
      value: editingRole.label,
      onChange: e => setEditingRole({ ...editingRole, label: e.target.value }),
      style: { fontSize: 11, padding: '4px 6px' },
      placeholder: "Role name"
    }),
    /*#__PURE__*/React.createElement("input", {
      value: editingRole.description,
      onChange: e => setEditingRole({ ...editingRole, description: e.target.value }),
      style: { fontSize: 10, padding: '4px 6px' },
      placeholder: "Description"
    }),
    /*#__PURE__*/React.createElement("div", { style: { display: 'flex', gap: 4 } },
      /*#__PURE__*/React.createElement("button", {
        onClick: handleSaveRoleEdit,
        className: "b-pri b-xs",
        style: { fontSize: 9 }
      }, "Save"),
      /*#__PURE__*/React.createElement("button", {
        onClick: () => setEditingRole(null),
        className: "b-gho b-xs",
        style: { fontSize: 9 }
      }, "Cancel"))
  ) : /*#__PURE__*/React.createElement(React.Fragment, null,
    /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
      /*#__PURE__*/React.createElement("span", {
        className: `tag ${rc.protected ? 'tag-gold' : 'tag-blue'}`,
        style: { fontSize: 9, marginBottom: 4 }
      }, rc.label),
      orgRole === 'admin' && /*#__PURE__*/React.createElement("div", { style: { display: 'flex', gap: 2 } },
        /*#__PURE__*/React.createElement("button", {
          onClick: () => setEditingRole({ key: rc.key, label: rc.label, description: rc.description }),
          className: "b-gho b-xs",
          title: "Edit role",
          style: { padding: 2, lineHeight: 1 }
        }, /*#__PURE__*/React.createElement(I, { n: "edit", s: 10 })),
        !rc.protected && /*#__PURE__*/React.createElement("button", {
          onClick: () => handleDeleteRole(rc.key),
          className: "b-gho b-xs",
          title: "Delete role",
          style: { padding: 2, lineHeight: 1, color: 'var(--red)' }
        }, /*#__PURE__*/React.createElement(I, { n: "trash", s: 10 })))),
    /*#__PURE__*/React.createElement("p", {
      style: { fontSize: 10.5, color: 'var(--tx-2)', marginTop: 2 }
    }, rc.description || 'Custom role.')))))), addRoleModal && /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: { marginBottom: 16 }
  }, /*#__PURE__*/React.createElement("span", { className: "section-label" }, "ADD NEW ROLE"), /*#__PURE__*/React.createElement("div", { style: { display: 'flex', flexDirection: 'column', gap: 8, marginTop: 6 } },
    /*#__PURE__*/React.createElement("input", {
      value: newRoleDraft.label,
      onChange: e => setNewRoleDraft({ ...newRoleDraft, label: e.target.value }),
      placeholder: "Role name (e.g. Volunteer, Intern)",
      style: { fontSize: 12 }
    }),
    /*#__PURE__*/React.createElement("input", {
      value: newRoleDraft.description,
      onChange: e => setNewRoleDraft({ ...newRoleDraft, description: e.target.value }),
      placeholder: "Description (e.g. Limited access for volunteers)",
      style: { fontSize: 12 }
    }),
    /*#__PURE__*/React.createElement("div", { style: { display: 'flex', gap: 8 } },
      /*#__PURE__*/React.createElement("button", {
        onClick: handleAddRole,
        disabled: !newRoleDraft.label.trim(),
        className: "b-pri b-xs",
        style: { fontSize: 11 }
      }, /*#__PURE__*/React.createElement(I, { n: "plus", s: 11 }), " Create Role"),
      /*#__PURE__*/React.createElement("button", {
        onClick: () => { setAddRoleModal(false); setNewRoleDraft({ label: '', description: '' }); },
        className: "b-gho b-xs",
        style: { fontSize: 11 }
      }, "Cancel")))), /*#__PURE__*/React.createElement("div", {
    className: "card"
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CURRENT ", T.staff_term_plural.toUpperCase(), " (", staff.length, ")"), emailVerifyConfig.enabled && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)'
    }
  }, staff.filter(s => s.email_verification?.status === 'verified').length, " of ", staff.length, " verified")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4,
      marginTop: 6
    }
  }, staff.map(s => {
    const ev = s.email_verification;
    const needsVerify = emailVerifyConfig.enabled && EmailVerification.needsVerification(emailVerifyConfig, s);
    const isMe = s.userId === svc.userId;
    return /*#__PURE__*/React.createElement("div", {
      key: s.userId,
      style: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        padding: '10px 0',
        borderBottom: '1px solid var(--border-0)'
      }
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        fontWeight: 500
      }
    }, s.userId), ev?.status === 'verified' && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-green",
      style: {
        fontSize: 8
      }
    }, "VERIFIED"), needsVerify && !ev && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-gold",
      style: {
        fontSize: 8
      }
    }, "UNVERIFIED"), ev?.status === 'pending' && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-gold",
      style: {
        fontSize: 8
      }
    }, "PENDING"), ev?.status === 'revoked' && /*#__PURE__*/React.createElement("span", {
      className: "tag tag-red",
      style: {
        fontSize: 8
      }
    }, "REVOKED")), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, "Joined ", s.joined ? new Date(s.joined).toLocaleDateString() : '—', ev?.status === 'verified' && ev.email && /*#__PURE__*/React.createElement(React.Fragment, null, " \xB7 ", ev.email))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 6,
        alignItems: 'center'
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag ${s.role === 'admin' ? 'tag-gold' : 'tag-blue'}`,
      style: {
        fontSize: 9
      }
    }, activeOrgRoleLabels[s.role]), isMe && needsVerify && ev?.status !== 'verified' && /*#__PURE__*/React.createElement("button", {
      onClick: openEmailVerifyModal,
      className: "b-pri b-xs",
      style: {
        fontSize: 10
      }
    }, "Verify Email"), orgRole === 'admin' && ev?.status === 'verified' && s.userId !== svc.userId && /*#__PURE__*/React.createElement("button", {
      onClick: () => handleRevokeVerification(s.userId),
      className: "b-gho b-xs",
      title: "Revoke verification"
    }, /*#__PURE__*/React.createElement(I, {
      n: "x",
      s: 10
    })), orgRole === 'admin' && s.userId !== svc.userId && /*#__PURE__*/React.createElement("button", {
      onClick: () => handleRemoveStaff(s.userId),
      className: "b-gho b-xs",
      style: {
        color: 'var(--red)'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "trash",
      s: 11
    }))));
  }))), emailVerifyConfig.enabled && myVerification?.status !== 'verified' && EmailVerification.needsVerification(emailVerifyConfig, {
    role: orgRole,
    email_verification: myVerification
  }) && /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--gold-dim)',
      border: '1px solid var(--gold-mid)',
      borderRadius: 'var(--r)',
      padding: '14px 18px',
      marginTop: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "alert",
    s: 16,
    c: "var(--gold)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 700,
      color: 'var(--gold)'
    }
  }, "Email Verification Required")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6,
      marginBottom: 10
    }
  }, "Your organization requires email verification for your role (", activeOrgRoleLabels[orgRole], "). Verify your identity with an approved email address", emailVerifyConfig.required_domains?.length > 0 ? ` (${emailVerifyConfig.required_domains.map(d => '@' + d).join(', ')})` : '', "."), /*#__PURE__*/React.createElement("button", {
    onClick: openEmailVerifyModal,
    className: "b-pri",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 14
  }), " Verify My Email"))), view === 'network' && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 820,
      margin: '0 auto'
    }
  }, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700,
      marginBottom: 4
    }
  }, "Network"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginBottom: 20
    }
  }, "Networks are org-to-org relationships. Organizations join voluntarily; the network defines shared vocabulary that propagates."), /*#__PURE__*/React.createElement(StorageTransparencyBadge, {
    storageType: "matrix",
    roomId: networkRoom,
    encrypted: true,
    encLabel: "Megolm E2EE",
    label: "Network",
    members: networkMembers.map(m => ({ userId: m.id || m.userId, role: m.role || 'member' })),
    extra: [{ label: 'Storage', value: 'Network metadata and shared schemas are stored as state events in the network room. All network members can read; only admins can modify network-level settings.' }]
  }), !orgRoom ? /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '30px',
      borderStyle: 'dashed'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 32
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 8,
      marginBottom: 8
    }
  }, "Create or join an organization to participate in networks"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-3)'
    }
  }, "Networks are org-to-org relationships. An independent provider who wants to join a network first needs to create an organization."))) : !networkRoom ? /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '30px',
      borderStyle: 'dashed',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "globe",
    s: 32
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 8
    }
  }, "Not part of a network yet"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-3)',
      marginTop: 4
    }
  }, "Your org \"", orgMeta.name, "\" can create or join a network.")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 10
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setNetworkModal(true),
    className: "b-pri",
    style: {
      flex: 1,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "Create Network"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setJoinNetworkModal(true),
    className: "b-gho",
    style: {
      flex: 1,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "globe",
    s: 14
  }), "Join Network"))) : /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green"
  }, /*#__PURE__*/React.createElement(I, {
    n: "globe",
    s: 10
  }), "NETWORK"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 15,
      fontWeight: 700
    }
  }, "Connected"), /*#__PURE__*/React.createElement("span", {
    className: `tag ${networkRole === 'admin' ? 'tag-gold' : 'tag-blue'}`,
    style: {
      fontSize: 9
    }
  }, networkRole === 'admin' ? 'ADMIN' : 'MEMBER')), /*#__PURE__*/React.createElement("span", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 9.5,
      color: 'var(--tx-3)'
    }
  }, networkRoom.slice(0, 24), "\u2026")), networkRole === 'admin' && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "NETWORK ADMINISTRATION"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 8,
      marginTop: 6
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 14px',
      background: 'var(--gold-dim)',
      borderRadius: 'var(--r)',
      border: '1px solid var(--gold-mid)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontWeight: 600,
      color: 'var(--gold)',
      display: 'block',
      marginBottom: 2
    }
  }, "Invite Organization"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)'
    }
  }, "Invite orgs by room ID or token")), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 14px',
      background: 'var(--purple-dim)',
      borderRadius: 'var(--r)',
      border: '1px solid rgba(167,139,250,.15)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontWeight: 600,
      color: 'var(--purple)',
      display: 'block',
      marginBottom: 2
    }
  }, "Schema Proposals"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)'
    }
  }, "Review pending schema changes")), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 14px',
      background: 'var(--blue-dim)',
      borderRadius: 'var(--r)',
      border: '1px solid rgba(91,156,245,.15)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontWeight: 600,
      color: 'var(--blue)',
      display: 'block',
      marginBottom: 2
    }
  }, "Authority Catalog"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)'
    }
  }, "Shared external authorities")), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 14px',
      background: 'var(--teal-dim)',
      borderRadius: 'var(--r)',
      border: '1px solid rgba(62,201,176,.15)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontWeight: 600,
      color: 'var(--teal)',
      display: 'block',
      marginBottom: 2
    }
  }, "Metrics Aggregation"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)'
    }
  }, "Configure cross-org aggregation")))), /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "MEMBER ORGANIZATIONS (", networkMembers.length, ")"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4
    }
  }, networkMembers.map((m, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      padding: '8px 0',
      borderBottom: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 500
    }
  }, m.name || m.id), m.name && /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9.5,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)',
      display: 'block'
    }
  }, m.id)), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6,
      alignItems: 'center'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tag ${m.role === 'admin' ? 'tag-gold' : 'tag-blue'}`,
    style: {
      fontSize: 9
    }
  }, m.role), networkRole === 'admin' && m.role !== 'admin' && /*#__PURE__*/React.createElement("button", {
    className: "b-gho b-xs",
    style: {
      color: 'var(--red)'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "trash",
    s: 10
  }))))))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "SCHEMA COMMONS"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginBottom: 10
    }
  }, "Network schema organized into forms (GIVEN data collection) and interpretations (MEANT frameworks). Forms propagate to member organizations and down to clients through providers."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontFamily: 'var(--mono)',
      color: 'var(--teal)',
      fontWeight: 600,
      letterSpacing: '.05em'
    }
  }, "FORMS"), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-teal",
    style: {
      fontSize: 8
    }
  }, "GIVEN")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 6
    }
  }, DEFAULT_FORMS.map(f => /*#__PURE__*/React.createElement("div", {
    key: f.id,
    style: {
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      border: '1px solid var(--border-0)',
      overflow: 'hidden'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      padding: '8px 12px',
      borderBottom: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 600
    }
  }, f.name), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)'
    }
  }, f.fields.length, " field", f.fields.length !== 1 ? 's' : '')), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(MaturityBadge, {
    maturity: f.maturity || 'normative'
  }), /*#__PURE__*/React.createElement(SourceBadge, {
    source: f.source || {
      level: 'network',
      propagation: 'standard'
    }
  }))), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '4px 12px'
    }
  }, f.fields.map(p => /*#__PURE__*/React.createElement("div", {
    key: p.key,
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      padding: '6px 0',
      borderBottom: '1px solid var(--border-0)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap'
    }
  }, p.question), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 9.5,
      color: 'var(--tx-3)',
      fontFamily: 'var(--mono)',
      flexShrink: 0,
      marginLeft: 8
    }
  }, p.type)))))))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      fontFamily: 'var(--mono)',
      color: 'var(--gold)',
      fontWeight: 600,
      letterSpacing: '.05em'
    }
  }, "INTERPRETATIONS"), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 8
    }
  }, "MEANT")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4
    }
  }, DEFAULT_PROVIDER_PROMPTS.map(p => /*#__PURE__*/React.createElement("div", {
    key: p.key,
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      padding: '8px 12px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      flex: 1,
      minWidth: 0
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 500,
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap'
    }
  }, p.question), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 8
    }
  }, "ASSESSMENT")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      flexShrink: 0
    }
  }, /*#__PURE__*/React.createElement(MaturityBadge, {
    maturity: p.maturity || 'normative'
  }), /*#__PURE__*/React.createElement(SourceBadge, {
    source: p.source || {
      level: 'network',
      propagation: 'standard'
    }
  })))), DEFAULT_DEFINITIONS.map(d => /*#__PURE__*/React.createElement("div", {
    key: d.key,
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      padding: '8px 12px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      flex: 1,
      minWidth: 0
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 500,
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap'
    }
  }, d.name), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-purple",
    style: {
      fontSize: 8
    }
  }, "CLASSIFICATION")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      flexShrink: 0
    }
  }, /*#__PURE__*/React.createElement(MaturityBadge, {
    maturity: d.maturity || 'normative'
  }), /*#__PURE__*/React.createElement(SourceBadge, {
    source: d.source || {
      level: 'network',
      propagation: 'required'
    }
  }))))))), /*#__PURE__*/React.createElement(AdoptionMetrics, {
    adopted: DEFAULT_FORMS.length + DEFAULT_DEFINITIONS.length + DEFAULT_PROVIDER_PROMPTS.length,
    total: DEFAULT_FORMS.length + DEFAULT_DEFINITIONS.length + DEFAULT_PROVIDER_PROMPTS.length + 2,
    extensions: 1,
    divergences: 0
  }), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16,
      marginTop: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "PROPAGATION MODEL (CON SEMANTICS)"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 8,
      marginTop: 6
    }
  }, Object.values(PROPAGATION_LEVELS).map(p => /*#__PURE__*/React.createElement("div", {
    key: p.id,
    style: {
      padding: '8px 12px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)'
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tag tag-${p.color}`,
    style: {
      marginBottom: 4,
      fontSize: 9
    }
  }, p.label.toUpperCase()), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginTop: 2
    }
  }, p.desc))))), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ACTIVE PROPOSALS"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginBottom: 10
    }
  }, "Consent-based governance. Required/standard proposals trigger a consent round; recommended/optional use lazy consensus."), /*#__PURE__*/React.createElement(ProposalCard, {
    proposal: {
      proposal_id: 'prop_example_001',
      type: 'add_field',
      summary: 'Add "safe parking program" as a network-standard option for sleep location',
      detail: 'Multiple orgs already track this locally. Formalizing ensures consistent reporting across the network.',
      proposed_by: '@steward:khora.io',
      proposed_at: Date.now() - 86400000 * 3,
      target_propagation: 'standard',
      target_maturity: 'trial',
      governance_rhythm: 'monthly_review',
      deadline: Date.now() + 86400000 * 4,
      status: 'consent_round',
      positions: {
        '!org_a:khora.io': {
          position: 'adopt_as_is',
          at: Date.now() - 86400000 * 2
        },
        '!org_b:khora.io': {
          position: 'adopt_with_extension',
          at: Date.now() - 86400000,
          note: 'Will add "safe lot" sub-type'
        },
        '!org_c:khora.io': null,
        '!org_d:khora.io': null
      }
    }
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '12px',
      fontSize: 11,
      color: 'var(--tx-3)'
    }
  }, "Active proposals from the network room will appear here. Proposals use consent-based governance \u2014 not majority voting.")), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement(GovernanceCalendar, null)), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement(DeFactoAlert, {
    fieldName: "safe parking",
    orgCount: 4,
    totalOrgs: 5,
    onFormalize: () => showToast('Proposal creation flow coming in Phase 3', 'info'),
    onDismiss: () => showToast('Dismissed', 'info')
  })), networkRole !== 'admin' && /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("button", {
    className: "b-gho",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 13
  }), "Propose Schema Change"), /*#__PURE__*/React.createElement("button", {
    className: "b-red b-sm",
    style: {
      marginLeft: 'auto'
    }
  }, "Leave Network")), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--green-dim)',
      border: '1px solid rgba(61,214,140,.15)',
      borderRadius: 'var(--r)',
      padding: '12px 16px',
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6,
      marginTop: 16
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--green)'
    }
  }, "Polycentric governance:"), " Shared prompts propagate Network \u2192 Org \u2192 Provider \u2192 Client. Observations vary locally; interpretations feeding into shared metrics use network-level definitions for consistency."))), view === 'org-inbox' && orgRoom && /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      maxWidth: 860,
      margin: '0 auto'
    }
  }, !activeChannel ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 24
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
    style: {
      fontFamily: 'var(--serif)',
      fontSize: 22,
      fontWeight: 700
    }
  }, "Organization Inbox"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-1)',
      fontSize: 12.5,
      marginTop: 4
    }
  }, "Encrypted org-to-org messaging. Your opacity is set to ", /*#__PURE__*/React.createElement("strong", {
    style: {
      color: orgOpacity === 'opaque' ? 'var(--red)' : orgOpacity === 'translucent' ? 'var(--gold)' : 'var(--green)'
    }
  }, OPACITY_LABELS[orgOpacity]), ".", orgRole === 'admin' && /*#__PURE__*/React.createElement("span", {
    style: {
      color: 'var(--tx-3)'
    }
  }, " \u2014 change in Org Settings"))), /*#__PURE__*/React.createElement("button", {
    onClick: () => setComposeOrgModal(true),
    className: "b-pri b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "New Channel")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit,minmax(160px,1fr))',
      gap: 10,
      marginBottom: 20
    }
  }, [{
    l: 'Channels',
    v: orgChannels.length,
    c: 'teal',
    i: 'msg'
  }, {
    l: 'Opacity',
    v: OPACITY_LABELS[orgOpacity],
    c: orgOpacity === 'opaque' ? 'red' : orgOpacity === 'translucent' ? 'gold' : 'green',
    i: 'eyeOff'
  }, {
    l: 'Your Role',
    v: activeOrgRoleLabels[orgRole] || orgRole,
    c: 'blue',
    i: 'user'
  }].map((s, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "card",
    style: {
      padding: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, s.l.toUpperCase()), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginTop: 2
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 16,
      fontWeight: 700
    }
  }, s.v), /*#__PURE__*/React.createElement("span", {
    style: {
      color: `var(--${s.c})`,
      opacity: .5
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: s.i,
    s: 15
  })))))), orgChannels.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      textAlign: 'center',
      padding: '40px 20px',
      borderStyle: 'dashed'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "msg",
    s: 32
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      marginTop: 10,
      fontSize: 13
    }
  }, "No messaging channels"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-3)',
      fontSize: 11.5,
      marginTop: 4
    }
  }, "Create a channel to start communicating with another organization."), /*#__PURE__*/React.createElement("button", {
    onClick: () => setComposeOrgModal(true),
    className: "b-pri",
    style: {
      marginTop: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 14
  }), "New Channel")) : /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 0,
      overflow: 'hidden'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      padding: '10px 16px',
      background: 'var(--bg-3)',
      borderBottom: '1px solid var(--border-1)',
      display: 'grid',
      gridTemplateColumns: '2fr 1fr 1fr',
      gap: 0
    }
  }, ['ORGANIZATION', 'OPACITY', 'ACTIONS'].map(h => /*#__PURE__*/React.createElement("span", {
    key: h,
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-2)',
      letterSpacing: '.07em',
      fontWeight: 600
    }
  }, h))), orgChannels.map((ch, i) => {
    const peerOrgId = ch.orgs?.find(o => o !== orgRoom);
    const peerName = ch.org_names?.[peerOrgId] || peerOrgId?.slice(0, 20) || 'Unknown Org';
    return /*#__PURE__*/React.createElement("div", {
      key: ch.roomId,
      style: {
        display: 'grid',
        gridTemplateColumns: '2fr 1fr 1fr',
        gap: 0,
        padding: '12px 16px',
        borderBottom: i < orgChannels.length - 1 ? '1px solid var(--border-0)' : 'none',
        alignItems: 'center',
        transition: 'background .15s'
      },
      onMouseEnter: e => e.currentTarget.style.background = 'var(--bg-3)',
      onMouseLeave: e => e.currentTarget.style.background = 'transparent'
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        width: 28,
        height: 28,
        borderRadius: '50%',
        background: 'var(--teal-dim)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: 'var(--teal)'
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "msg",
      s: 14
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 13,
        fontWeight: 600,
        display: 'block'
      }
    }, peerName), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9.5,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)'
      }
    }, ch.roomId?.slice(0, 20), "\u2026"))), /*#__PURE__*/React.createElement("span", {
      className: `tag ${orgOpacity === 'opaque' ? 'tag-red' : orgOpacity === 'translucent' ? 'tag-gold' : 'tag-green'}`,
      style: {
        fontSize: 9,
        justifySelf: 'start'
      }
    }, OPACITY_LABELS[orgOpacity]), /*#__PURE__*/React.createElement("button", {
      onClick: () => openChannel(ch.roomId),
      className: "b-gho b-sm",
      style: {
        justifySelf: 'start',
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "msg",
      s: 12
    }), "Open"));
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--purple-dim)',
      border: '1px solid rgba(167,139,250,.15)',
      borderRadius: 'var(--r)',
      padding: '14px 18px',
      marginTop: 20,
      display: 'flex',
      gap: 10,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "eyeOff",
    s: 16,
    c: "var(--purple)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--purple)'
    }
  }, "Opacity governs outgoing messages."), " When your org responds, the receiving org will see your identity according to your opacity setting (", OPACITY_LABELS[orgOpacity], "). Incoming messages are displayed according to the ", /*#__PURE__*/React.createElement("em", null, "sending"), " org's opacity setting \u2014 you cannot force another org to reveal more than they choose to."))) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setActiveChannel(null);
      setChannelMessages([]);
    },
    className: "b-gho b-sm",
    style: {
      marginBottom: 14,
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "back",
    s: 13
  }), "All Channels"), (() => {
    const ch = orgChannels.find(c => c.roomId === activeChannel);
    const peerOrgId = ch?.orgs?.find(o => o !== orgRoom);
    const peerName = ch?.org_names?.[peerOrgId] || peerOrgId?.slice(0, 20) || 'Unknown Org';
    return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        marginBottom: 20
      }
    }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h2", {
      style: {
        fontFamily: 'var(--serif)',
        fontSize: 20,
        fontWeight: 700
      }
    }, peerName), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginTop: 4
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: "tag tag-teal"
    }, /*#__PURE__*/React.createElement(I, {
      n: "lock",
      s: 9
    }), "E2EE"), /*#__PURE__*/React.createElement("span", {
      className: `tag ${orgOpacity === 'opaque' ? 'tag-red' : orgOpacity === 'translucent' ? 'tag-gold' : 'tag-green'}`,
      style: {
        fontSize: 9
      }
    }, "OUTGOING: ", OPACITY_LABELS[orgOpacity]?.toUpperCase()), /*#__PURE__*/React.createElement("span", {
      style: {
        fontFamily: 'var(--mono)',
        fontSize: 9.5,
        color: 'var(--tx-3)'
      }
    }, "org-to-org channel"))), /*#__PURE__*/React.createElement("button", {
      onClick: () => loadChannelMessages(activeChannel),
      className: "b-gho b-xs",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "refresh-cw",
      s: 11
    }), "Refresh")), /*#__PURE__*/React.createElement("div", {
      className: "card",
      style: {
        marginBottom: 16
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: "section-label"
    }, "MESSAGES"), /*#__PURE__*/React.createElement("div", {
      style: {
        maxHeight: 400,
        overflow: 'auto',
        marginBottom: 12
      }
    }, channelMessages.length === 0 ? /*#__PURE__*/React.createElement("p", {
      style: {
        color: 'var(--tx-3)',
        fontSize: 12,
        padding: '20px 0',
        textAlign: 'center'
      }
    }, "No messages yet. Start the conversation.") : channelMessages.map((msg, i) => {
      const sender = resolveMessageSender(msg);
      return /*#__PURE__*/React.createElement("div", {
        key: msg.id || i,
        style: {
          padding: '10px 0',
          borderBottom: '1px solid var(--border-0)'
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: 4
        }
      }, /*#__PURE__*/React.createElement("div", {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: 6
        }
      }, /*#__PURE__*/React.createElement("span", {
        style: {
          fontFamily: 'var(--mono)',
          fontSize: 10.5,
          fontWeight: 600,
          color: sender.isOwn ? 'var(--gold)' : 'var(--teal)'
        }
      }, sender.isOwn ? 'You' + (sender.org ? ` (${sender.org})` : '') : sender.label), msg.content?.[`${NS}.envelope`] && /*#__PURE__*/React.createElement("span", {
        className: `tag ${msg.content[`${NS}.envelope`].opacity === 'opaque' ? 'tag-red' : msg.content[`${NS}.envelope`].opacity === 'translucent' ? 'tag-gold' : 'tag-green'}`,
        style: {
          fontSize: 7.5
        }
      }, msg.content[`${NS}.envelope`].opacity?.toUpperCase())), /*#__PURE__*/React.createElement("span", {
        style: {
          fontFamily: 'var(--mono)',
          fontSize: 9,
          color: 'var(--tx-3)'
        }
      }, msg.ts ? new Date(msg.ts).toLocaleString() : '')), /*#__PURE__*/React.createElement("p", {
        style: {
          fontSize: 12.5,
          color: 'var(--tx-1)',
          lineHeight: 1.5
        }
      }, msg.content?.body));
    })), hasOrgMsgPermission('respond') ? /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 6
      }
    }, /*#__PURE__*/React.createElement("input", {
      value: orgMsgText,
      onChange: e => setOrgMsgText(e.target.value),
      placeholder: `Message as ${orgOpacity === 'transparent' ? providerProfile.display_name || 'you' : orgOpacity === 'translucent' ? orgMeta.name || 'your org' : 'anonymous org'}... (E2EE)`,
      onKeyDown: e => {
        if (e.key === 'Enter' && !e.shiftKey) handleSendOrgMsg();
      },
      style: {
        flex: 1
      }
    }), /*#__PURE__*/React.createElement("button", {
      onClick: handleSendOrgMsg,
      className: "b-pri",
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "send",
      s: 13
    }), "Send")) : /*#__PURE__*/React.createElement("div", {
      style: {
        padding: '10px 14px',
        background: 'var(--gold-dim)',
        borderRadius: 'var(--r)',
        display: 'flex',
        alignItems: 'center',
        gap: 8
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: "lock",
      s: 13,
      c: "var(--gold)"
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11.5,
        color: 'var(--gold)'
      }
    }, "Your role (", activeOrgRoleLabels[orgRole] || orgRole, ") does not have permission to respond to org messages. Ask an organization admin to update your role to enable messaging."))));
  })())), view === 'resources' && !activeCase && /*#__PURE__*/React.createElement(ResourcesTableView, {
    resourceTypes: resourceTypes,
    resourceRelations: resourceRelations,
    resourceInventory: resourceInventory,
    T: T,
    svc: svc,
    orgRole: orgRole,
    orgRoom: orgRoom,
    rosterRoom: rosterRoom,
    networkRoom: networkRoom,
    allAllocations: allAllocations,
    onCreateResource: () => {
      setResourceDraft({
        name: '',
        category: 'general',
        unit: 'unit',
        fungible: true,
        perishable: false,
        ttl_days: '',
        tags: '',
        infinite: false,
        initial_quantity: '',
        replenishes: false,
        replenish_cycle: '',
        permissions: buildDefaultResourcePermissions()
      });
      setCreateResourceModal(true);
    },
    onRefresh: () => loadResources(orgRoom, networkRoom, rosterRoom),
    onRestock: relation => {
      setRestockModal(relation);
      setRestockQty('');
      setRestockNote('');
    },
    onEstablishRelation: handleEstablishRelation,
    canViewResource: canViewResource,
    canControlResource: canControlResource,
    canAllocateResource: canAllocateResource,
    individuals: cases
  }), view === 'activity' && /*#__PURE__*/React.createElement(ActivityStream, {
    session: session
  }), view === 'transparency' && /*#__PURE__*/React.createElement(TransparencyPage, {
    onBack: () => setView('dashboard')
  }))), /*#__PURE__*/React.createElement(Modal, {
    open: discoverModal,
    onClose: () => setDiscoverModal(false),
    title: "Find " + (T?.client_term || 'Individual')
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Look up ", aOrAn(T?.client_term || 'individual'), " ", (T?.client_term || 'individual').toLowerCase(), " by their Matrix ID. If they've created a bridge room and invited you, it will appear in your cases."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, (T?.client_term || 'INDIVIDUAL').toUpperCase(), " MATRIX ID"), /*#__PURE__*/React.createElement("input", {
    value: discoverUserId,
    onChange: e => setDiscoverUserId(e.target.value),
    placeholder: "@client:matrix.org"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: handleDiscoverClient,
    className: "b-pri",
    style: {
      width: '100%'
    }
  }, "Search for Bridge")), /*#__PURE__*/React.createElement(Modal, {
    open: createResourceModal,
    onClose: () => setCreateResourceModal(false),
    title: "Create Resource Type",
    w: 480
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Define a new resource type for your catalog. Resource types describe the goods or services your organization can track and allocate to ", T.client_term_plural.toLowerCase(), "."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "NAME"), /*#__PURE__*/React.createElement("input", {
    value: resourceDraft.name,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      name: e.target.value
    }),
    placeholder: "e.g. Bus Voucher, Shelter Bed Night"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CATEGORY"), /*#__PURE__*/React.createElement("select", {
    value: resourceDraft.category,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      category: e.target.value
    })
  }, RESOURCE_CATEGORIES.map(c => /*#__PURE__*/React.createElement("option", {
    key: c,
    value: c
  }, RESOURCE_CATEGORY_LABELS[c] || c)))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "UNIT OF MEASURE"), /*#__PURE__*/React.createElement("input", {
    value: resourceDraft.unit,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      unit: e.target.value
    }),
    placeholder: "e.g. voucher, night, dollar, kit"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 10,
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      fontSize: 12,
      color: 'var(--tx-1)',
      cursor: 'pointer'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: resourceDraft.fungible,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      fungible: e.target.checked
    })
  }), "Fungible (interchangeable units)"), /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      fontSize: 12,
      color: 'var(--tx-1)',
      cursor: 'pointer'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: resourceDraft.perishable,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      perishable: e.target.checked
    })
  }), "Perishable (expires)")), resourceDraft.perishable && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "EXPIRY (DAYS)"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: resourceDraft.ttl_days,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      ttl_days: e.target.value
    }),
    placeholder: "e.g. 30, 90"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      borderTop: '1px solid var(--border-0)',
      paddingTop: 14,
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "layers",
    s: 14,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 600
    }
  }, "Supply & Replenishment")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginBottom: 12,
      lineHeight: 1.5
    }
  }, "Configure the initial stock level and whether this resource automatically replenishes."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 10,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      fontSize: 12,
      color: 'var(--tx-1)',
      cursor: 'pointer'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: resourceDraft.infinite,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      infinite: e.target.checked
    })
  }), "Infinite (unlimited supply)"), /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      fontSize: 12,
      color: 'var(--tx-1)',
      cursor: 'pointer'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: resourceDraft.replenishes,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      replenishes: e.target.checked
    })
  }), "Replenishes (auto-refills)")), !resourceDraft.infinite && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "INITIAL QUANTITY"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    min: "0",
    value: resourceDraft.initial_quantity,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      initial_quantity: e.target.value
    }),
    placeholder: "e.g. 100, 500"
  })), resourceDraft.replenishes && /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "REPLENISH CYCLE"), /*#__PURE__*/React.createElement("select", {
    value: resourceDraft.replenish_cycle,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      replenish_cycle: e.target.value
    })
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select cycle..."), /*#__PURE__*/React.createElement("option", {
    value: "daily"
  }, "Daily"), /*#__PURE__*/React.createElement("option", {
    value: "weekly"
  }, "Weekly"), /*#__PURE__*/React.createElement("option", {
    value: "monthly"
  }, "Monthly"), /*#__PURE__*/React.createElement("option", {
    value: "quarterly"
  }, "Quarterly"), /*#__PURE__*/React.createElement("option", {
    value: "annually"
  }, "Annually")))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "TAGS (comma-separated)"), /*#__PURE__*/React.createElement("input", {
    value: resourceDraft.tags,
    onChange: e => setResourceDraft({
      ...resourceDraft,
      tags: e.target.value
    }),
    placeholder: "e.g. transit, emergency, shelter"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      borderTop: '1px solid var(--border-0)',
      paddingTop: 16,
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 10
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 14,
    c: "var(--gold)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 600
    }
  }, "Permissions")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)',
      marginBottom: 12,
      lineHeight: 1.5
    }
  }, "Control who can manage, allocate, and see this resource. Defaults are pre-filled; adjust as needed."), RESOURCE_PERMISSION_ABILITIES.map(ability => {
    const grants = resourceDraft.permissions?.[ability] || [];
    return /*#__PURE__*/React.createElement("div", {
      key: ability,
      style: {
        marginBottom: 12
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 5,
        marginBottom: 4
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: RESOURCE_PERMISSION_ICONS[ability],
      s: 11,
      c: `var(--${RESOURCE_PERMISSION_COLORS[ability]})`
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 11,
        fontWeight: 600,
        color: `var(--${RESOURCE_PERMISSION_COLORS[ability]})`
      }
    }, RESOURCE_PERMISSION_LABELS[ability]), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9.5,
        color: 'var(--tx-3)',
        fontStyle: 'italic'
      }
    }, RESOURCE_PERMISSION_DESCRIPTIONS[ability])), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        flexWrap: 'wrap',
        gap: 4,
        marginBottom: 6
      }
    }, grants.length === 0 && ability === 'viewers' && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)',
        padding: '2px 8px',
        background: 'var(--bg-3)',
        borderRadius: 10
      }
    }, "Everyone in org"), grants.map((g, gi) => /*#__PURE__*/React.createElement("span", {
      key: gi,
      style: {
        display: 'inline-flex',
        alignItems: 'center',
        gap: 4,
        fontSize: 10,
        padding: '2px 8px',
        borderRadius: 10,
        background: `var(--${RESOURCE_PERMISSION_COLORS[ability]}-dim)`,
        color: `var(--${RESOURCE_PERMISSION_COLORS[ability]})`
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: g.type === 'role' ? 'users' : 'user',
      s: 9
    }), g.type === 'role' ? activeOrgRoleLabels[g.id] || g.id : g.id, /*#__PURE__*/React.createElement("span", {
      onClick: () => {
        const updated = [...grants];
        updated.splice(gi, 1);
        setResourceDraft({
          ...resourceDraft,
          permissions: {
            ...resourceDraft.permissions,
            [ability]: updated
          }
        });
      },
      style: {
        cursor: 'pointer',
        marginLeft: 2,
        opacity: .7
      }
    }, "\xD7")))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement("select", {
      style: {
        flex: '0 0 90px',
        fontSize: 11
      },
      value: "role",
      onChange: e => {
        const type = e.target.value;
        if (type === 'role') {
          // Show role picker
        } else {
          // Will use text input
        }
      }
    }, /*#__PURE__*/React.createElement("option", {
      value: "role"
    }, "Role"), /*#__PURE__*/React.createElement("option", {
      value: "user"
    }, "User")), /*#__PURE__*/React.createElement("select", {
      style: {
        flex: 1,
        fontSize: 11
      },
      onChange: e => {
        if (!e.target.value) return;
        const parts = e.target.value.split(':');
        const grant = {
          type: parts[0],
          id: parts[1]
        };
        if (!grants.some(g => g.type === grant.type && g.id === grant.id)) {
          setResourceDraft({
            ...resourceDraft,
            permissions: {
              ...resourceDraft.permissions,
              [ability]: [...grants, grant]
            }
          });
        }
        e.target.value = '';
      }
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "Add..."), activeOrgRoles.map(r => /*#__PURE__*/React.createElement("option", {
      key: r,
      value: `role:${r}`
    }, activeOrgRoleLabels[r])), staff.filter(s => !grants.some(g => g.type === 'user' && g.id === s.userId)).map(s => /*#__PURE__*/React.createElement("option", {
      key: s.userId,
      value: `user:${s.userId}`
    }, s.userId)))));
  })), /*#__PURE__*/React.createElement("button", {
    onClick: handleCreateResourceType,
    className: "b-pri",
    style: {
      width: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 13
  }), "Create Resource Type")), /*#__PURE__*/React.createElement(Modal, {
    open: allocModal,
    onClose: () => setAllocModal(false),
    title: "Allocate Resource",
    w: 480
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Allocate a resource to this ", T.client_term.toLowerCase(), ". The allocation is recorded in the bridge room (visible to both parties) and updates org inventory."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "RESOURCE TYPE"), /*#__PURE__*/React.createElement("select", {
    value: allocDraft.resource_type_id,
    onChange: e => setAllocDraft({
      ...allocDraft,
      resource_type_id: e.target.value
    })
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "Select a resource..."), resourceTypes.filter(rt => canAllocateResource(rt, svc.userId, orgRole)).map(rt => {
    const relation = resourceRelations.find(r => r.resource_type_id === rt.id);
    const inv = relation ? resourceInventory[relation.id] : null;
    return /*#__PURE__*/React.createElement("option", {
      key: rt.id,
      value: rt.id
    }, rt.name, " (", rt.unit, ")", inv ? ` — ${inv.available || 0} available` : '');
  }))), allocDraft.resource_type_id && (() => {
    const rt = resourceTypes.find(t => t.id === allocDraft.resource_type_id);
    if (!rt) return null;
    return /*#__PURE__*/React.createElement("div", {
      style: {
        background: 'var(--bg-2)',
        border: '1px solid var(--border-0)',
        borderRadius: 'var(--r)',
        padding: '10px 14px',
        marginBottom: 14
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginBottom: 4
      }
    }, /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${RESOURCE_CATEGORY_COLORS[rt.category] || 'teal'}`,
      style: {
        fontSize: 8.5
      }
    }, RESOURCE_CATEGORY_LABELS[rt.category] || rt.category), rt.fungible && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)'
      }
    }, "fungible"), rt.perishable && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 9,
        color: 'var(--orange)',
        fontFamily: 'var(--mono)'
      }
    }, "expires ", rt.ttl_days, "d")), rt.tags?.length > 0 && /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 3,
        flexWrap: 'wrap'
      }
    }, rt.tags.map(tag => /*#__PURE__*/React.createElement("span", {
      key: tag,
      style: {
        fontSize: 8,
        padding: '1px 5px',
        borderRadius: 99,
        background: 'var(--bg-3)',
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)'
      }
    }, tag))));
  })(), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "QUANTITY"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    min: "1",
    value: allocDraft.quantity,
    onChange: e => setAllocDraft({
      ...allocDraft,
      quantity: e.target.value
    }),
    placeholder: "1"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "NOTES (OPTIONAL)"), /*#__PURE__*/React.createElement("input", {
    value: allocDraft.notes,
    onChange: e => setAllocDraft({
      ...allocDraft,
      notes: e.target.value
    }),
    placeholder: "e.g. For medical appointments this week"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: handleAllocateResource,
    className: "b-pri",
    disabled: !allocDraft.resource_type_id,
    style: {
      width: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 13
  }), "Allocate Resource")), /*#__PURE__*/React.createElement(Modal, {
    open: restockModal !== null,
    onClose: () => {
      setRestockModal(null);
      setRestockQty('');
      setRestockNote('');
    },
    title: "Restock Inventory",
    w: 420
  }, restockModal && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Add inventory for ", /*#__PURE__*/React.createElement("strong", null, resourceTypes.find(t => t.id === restockModal.resource_type_id)?.name || restockModal.resource_type_id), "."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "QUANTITY TO ADD"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    min: "1",
    value: restockQty,
    onChange: e => setRestockQty(e.target.value),
    placeholder: "e.g. 100",
    autoFocus: true
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "NOTE (OPTIONAL)"), /*#__PURE__*/React.createElement("input", {
    value: restockNote,
    onChange: e => setRestockNote(e.target.value),
    placeholder: "e.g. Grant #2024-A quarterly restock"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: handleRestock,
    className: "b-pri",
    disabled: !restockQty || parseInt(restockQty) <= 0,
    style: {
      width: '100%'
    }
  }, "Restock"))), /*#__PURE__*/React.createElement(Modal, {
    open: permModal !== null,
    onClose: () => setPermModal(null),
    title: "Resource Permissions",
    w: 520
  }, permModal && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 15,
      fontWeight: 700
    }
  }, permModal.name), /*#__PURE__*/React.createElement("span", {
    className: `tag tag-${RESOURCE_CATEGORY_COLORS[permModal.category] || 'teal'}`,
    style: {
      fontSize: 8.5
    }
  }, RESOURCE_CATEGORY_LABELS[permModal.category] || permModal.category)), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 18,
      lineHeight: 1.6
    }
  }, "Control who can manage, allocate, and view this resource type. Changes apply immediately to all org members."), RESOURCE_PERMISSION_ABILITIES.map(ability => {
    const grants = permDraft[ability] || [];
    return /*#__PURE__*/React.createElement("div", {
      key: ability,
      style: {
        marginBottom: 18,
        padding: '12px 14px',
        background: 'var(--bg-2)',
        borderRadius: 'var(--r)',
        border: '1px solid var(--border-0)'
      }
    }, /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        marginBottom: 8
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: RESOURCE_PERMISSION_ICONS[ability],
      s: 13,
      c: `var(--${RESOURCE_PERMISSION_COLORS[ability]})`
    }), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        fontWeight: 600,
        color: `var(--${RESOURCE_PERMISSION_COLORS[ability]})`
      }
    }, RESOURCE_PERMISSION_LABELS[ability])), /*#__PURE__*/React.createElement("p", {
      style: {
        fontSize: 10.5,
        color: 'var(--tx-2)',
        marginBottom: 8,
        lineHeight: 1.4
      }
    }, RESOURCE_PERMISSION_DESCRIPTIONS[ability]), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        flexWrap: 'wrap',
        gap: 4,
        marginBottom: 10
      }
    }, grants.length === 0 && ability === 'viewers' && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--teal)',
        fontFamily: 'var(--mono)',
        padding: '3px 10px',
        background: 'var(--teal-dim)',
        borderRadius: 10
      }
    }, "Everyone in org (default)"), grants.length === 0 && ability !== 'viewers' && /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-3)',
        fontFamily: 'var(--mono)',
        padding: '3px 10px',
        background: 'var(--bg-3)',
        borderRadius: 10
      }
    }, "Admin only (default)"), grants.map((g, gi) => /*#__PURE__*/React.createElement("span", {
      key: gi,
      style: {
        display: 'inline-flex',
        alignItems: 'center',
        gap: 4,
        fontSize: 10.5,
        padding: '3px 10px',
        borderRadius: 10,
        background: `var(--${RESOURCE_PERMISSION_COLORS[ability]}-dim)`,
        color: `var(--${RESOURCE_PERMISSION_COLORS[ability]})`
      }
    }, /*#__PURE__*/React.createElement(I, {
      n: g.type === 'role' ? 'users' : 'user',
      s: 10
    }), g.type === 'role' ? activeOrgRoleLabels[g.id] || g.id : g.id, /*#__PURE__*/React.createElement("span", {
      onClick: () => handleRemovePermGrant(ability, gi),
      style: {
        cursor: 'pointer',
        marginLeft: 3,
        fontSize: 12,
        fontWeight: 700,
        opacity: .6,
        lineHeight: 1
      }
    }, "\xD7")))), /*#__PURE__*/React.createElement("div", {
      style: {
        display: 'flex',
        gap: 4
      }
    }, /*#__PURE__*/React.createElement("select", {
      style: {
        flex: 1,
        fontSize: 11
      },
      defaultValue: "",
      onChange: e => {
        if (!e.target.value) return;
        const parts = e.target.value.split(':');
        const grant = {
          type: parts[0],
          id: parts.slice(1).join(':')
        };
        if (!grants.some(g => g.type === grant.type && g.id === grant.id)) {
          setPermDraft({
            ...permDraft,
            [ability]: [...grants, grant]
          });
        }
        e.target.value = '';
      }
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "Add role or user..."), /*#__PURE__*/React.createElement("optgroup", {
      label: "Roles"
    }, activeOrgRoles.map(r => /*#__PURE__*/React.createElement("option", {
      key: r,
      value: `role:${r}`,
      disabled: grants.some(g => g.type === 'role' && g.id === r)
    }, activeOrgRoleLabels[r]))), /*#__PURE__*/React.createElement("optgroup", {
      label: T.staff_term_plural
    }, staff.map(s => /*#__PURE__*/React.createElement("option", {
      key: s.userId,
      value: `user:${s.userId}`,
      disabled: grants.some(g => g.type === 'user' && g.id === s.userId)
    }, s.userId))))));
  }), /*#__PURE__*/React.createElement("button", {
    onClick: handleSavePermissions,
    className: "b-pri",
    style: {
      width: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 4,
      padding: 12
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "check",
    s: 14
  }), "Save Permissions"))), /*#__PURE__*/React.createElement(Modal, {
    open: createOrgModal,
    onClose: () => setCreateOrgModal(false),
    title: "Create Organization",
    w: 520
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Create an organization to manage ", T.staff_term_plural.toLowerCase(), ", cases across your team, and participate in networks. You'll be the admin."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ORGANIZATION NAME"), /*#__PURE__*/React.createElement("input", {
    value: setupData.name,
    onChange: e => setSetupData({
      ...setupData,
      name: e.target.value
    }),
    placeholder: "e.g. Metro Services Organization"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ORGANIZATION TYPE"), /*#__PURE__*/React.createElement("select", {
    value: setupData.type,
    onChange: e => setSetupData({
      ...setupData,
      type: e.target.value
    })
  }, ORG_TYPES.map(t => /*#__PURE__*/React.createElement("option", {
    key: t,
    value: t
  }, ORG_TYPE_LABELS[t])))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "SERVICE AREA"), /*#__PURE__*/React.createElement("input", {
    value: setupData.service_area,
    onChange: e => setSetupData({
      ...setupData,
      service_area: e.target.value
    }),
    placeholder: "e.g. Davidson County, TN"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 20
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "LANGUAGES (comma-separated)"), /*#__PURE__*/React.createElement("input", {
    value: setupData.languages,
    onChange: e => setSetupData({
      ...setupData,
      languages: e.target.value
    }),
    placeholder: "en, es"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--blue-dim)',
      border: '1px solid rgba(91,156,245,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 16,
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, "This creates an encrypted Matrix room for your organization. You'll be the admin. ", T.staff_term_plural, " can be invited with specific roles. Your provider account gains org context \u2014 you can manage ", T.staff_term_plural.toLowerCase(), ", cases, and networks from your dashboard."), /*#__PURE__*/React.createElement("button", {
    onClick: handleCreateOrg,
    className: "b-pri",
    disabled: !setupData.name.trim(),
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 16
  }), " Create Organization")), /*#__PURE__*/React.createElement(Modal, {
    open: joinOrgModal,
    onClose: () => setJoinOrgModal(false),
    title: "Join Organization"
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Enter the Matrix room ID of an existing Khora organization to join it. The org admin must have invited you."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ORGANIZATION ROOM ID"), /*#__PURE__*/React.createElement("input", {
    value: joinOrgId,
    onChange: e => setJoinOrgId(e.target.value),
    placeholder: "!roomid:matrix.org"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: handleJoinOrg,
    className: "b-pri",
    style: {
      width: '100%'
    }
  }, "Join Organization")), /*#__PURE__*/React.createElement(Modal, {
    open: inviteModal,
    onClose: () => setInviteModal(false),
    title: 'Invite ' + T.staff_term
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Invite a ", T.staff_term.toLowerCase(), " to your organization. They'll receive access to cases based on their assigned role."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "MATRIX ID"), /*#__PURE__*/React.createElement("input", {
    value: inviteUserId,
    onChange: e => setInviteUserId(e.target.value),
    placeholder: "@staff:matrix.org"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ROLE"), /*#__PURE__*/React.createElement("select", {
    value: inviteRole,
    onChange: e => setInviteRole(e.target.value)
  }, activeOrgRoles.map(r => /*#__PURE__*/React.createElement("option", {
    key: r,
    value: r
  }, activeOrgRoleLabels[r])))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--blue-dim)',
      border: '1px solid rgba(91,156,245,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 14,
      fontSize: 11.5,
      color: 'var(--tx-1)'
    }
  }, "Role determines which cases and data the ", T.staff_term.toLowerCase(), " can access. Admins see everything; read-only users see only aggregate dashboards."), /*#__PURE__*/React.createElement("button", {
    onClick: handleInviteStaff,
    className: "b-pri",
    style: {
      width: '100%'
    }
  }, "Send Invite")), /*#__PURE__*/React.createElement(Modal, {
    open: networkModal,
    onClose: () => setNetworkModal(false),
    title: "Create Network"
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Create a new governance network for your organization. Other organizations can join. Networks define shared vocabulary and schema propagation."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "NETWORK NAME"), /*#__PURE__*/React.createElement("input", {
    value: networkName,
    onChange: e => setNetworkName(e.target.value),
    placeholder: "e.g. Metro Partnership"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--green-dim)',
      border: '1px solid rgba(61,214,140,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 14,
      fontSize: 11.5,
      color: 'var(--tx-1)'
    }
  }, "The network room will contain shared schema definitions that propagate to all member organizations. Your org \"", orgMeta.name, "\" will be the network admin."), /*#__PURE__*/React.createElement("button", {
    onClick: handleCreateNetwork,
    className: "b-pri",
    style: {
      width: '100%'
    }
  }, "Create Network")), /*#__PURE__*/React.createElement(Modal, {
    open: joinNetworkModal,
    onClose: () => setJoinNetworkModal(false),
    title: "Join Network"
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Enter the Matrix room ID of an existing Khora network to join as \"", orgMeta.name || 'your organization', "\"."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "NETWORK ROOM ID"), /*#__PURE__*/React.createElement("input", {
    value: joinNetworkId,
    onChange: e => setJoinNetworkId(e.target.value),
    placeholder: "!roomid:matrix.org"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: handleJoinNetwork,
    className: "b-pri",
    style: {
      width: '100%'
    }
  }, "Join Network")), /*#__PURE__*/React.createElement(Modal, {
    open: !!provObsModal,
    onClose: () => setProvObsModal(null),
    title: provObsModal?.question || 'Record Observation',
    w: 500
  }, provObsModal && /*#__PURE__*/React.createElement(React.Fragment, null, provObsModal.eo?.trace && /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--purple-dim)',
      border: '1px solid rgba(167,139,250,.15)',
      borderRadius: 'var(--r)',
      padding: '8px 12px',
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--purple)'
    }
  }, provObsModal.eo.trace)), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "RESPONSE"), provObsModal.type === 'numeric' ? /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("input", {
    type: "number",
    value: provObsValue,
    onChange: e => setProvObsValue(e.target.value),
    placeholder: `${provObsModal.range?.min || 0} — ${provObsModal.range?.max || 100}`,
    min: provObsModal.range?.min,
    max: provObsModal.range?.max
  }), provObsModal.thresholds && /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4,
      flexWrap: 'wrap',
      marginTop: 6
    }
  }, provObsModal.thresholds.map((t, i) => /*#__PURE__*/React.createElement("span", {
    key: i,
    style: {
      fontSize: 9.5,
      padding: '2px 8px',
      background: provObsValue >= t.v && (i === provObsModal.thresholds.length - 1 || provObsValue < provObsModal.thresholds[i + 1]?.v) ? 'var(--gold-dim)' : 'var(--bg-3)',
      borderRadius: 10,
      color: provObsValue >= t.v && (i === provObsModal.thresholds.length - 1 || provObsValue < provObsModal.thresholds[i + 1]?.v) ? 'var(--gold)' : 'var(--tx-2)'
    }
  }, t.v, "+ ", t.l)))) : /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4
    }
  }, provObsModal.options?.map(o => /*#__PURE__*/React.createElement("div", {
    key: o.v,
    onClick: () => setProvObsValue(o.v),
    style: {
      padding: '10px 14px',
      borderRadius: 'var(--r)',
      cursor: 'pointer',
      border: `1px solid ${provObsValue === o.v ? 'var(--gold)' : 'var(--border-1)'}`,
      background: provObsValue === o.v ? 'var(--gold-dim)' : 'var(--bg-3)',
      transition: 'all .15s'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12.5,
      color: provObsValue === o.v ? 'var(--gold)' : 'var(--tx-1)'
    }
  }, o.l))))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CLINICAL NOTES (OPTIONAL)"), /*#__PURE__*/React.createElement("textarea", {
    value: provObsNotes,
    onChange: e => setProvObsNotes(e.target.value),
    placeholder: "Additional clinical context...",
    style: {
      minHeight: 50
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--gold-dim)',
      borderRadius: 'var(--r)',
      padding: '8px 12px',
      marginBottom: 14,
      fontSize: 11,
      color: 'var(--gold)'
    }
  }, "This observation is recorded as a MEANT event \u2014 a professional assessment with full EO provenance chain."), /*#__PURE__*/React.createElement("button", {
    onClick: handleProviderObservation,
    className: "b-pri",
    disabled: !provObsValue,
    style: {
      width: '100%'
    }
  }, "Record ", T.provider_term, " Observation"))), /*#__PURE__*/React.createElement(Modal, {
    open: shareContactModal,
    onClose: () => setShareContactModal(false),
    title: "Share My Details",
    w: 420
  },
  orgRoom && /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 0, marginBottom: 16, background: 'var(--bg-1)', borderRadius: 'var(--r-lg)', border: '1px solid var(--border-1)', padding: 3 }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShareAsOrg(false),
    style: { flex: 1, padding: '8px 12px', borderRadius: 'var(--r)', cursor: 'pointer', fontSize: 12, fontWeight: 600, transition: 'all .2s', background: !shareAsOrg ? 'var(--gold-dim)' : 'transparent', color: !shareAsOrg ? 'var(--gold)' : 'var(--tx-2)', border: !shareAsOrg ? '1px solid var(--gold)' : '1px solid transparent' }
  }, /*#__PURE__*/React.createElement(I, { n: "user", s: 13, c: !shareAsOrg ? 'var(--gold)' : 'var(--tx-3)' }), " Individual"),
  /*#__PURE__*/React.createElement("button", {
    onClick: () => setShareAsOrg(true),
    style: { flex: 1, padding: '8px 12px', borderRadius: 'var(--r)', cursor: 'pointer', fontSize: 12, fontWeight: 600, transition: 'all .2s', background: shareAsOrg ? 'var(--blue-dim)' : 'transparent', color: shareAsOrg ? 'var(--blue)' : 'var(--tx-2)', border: shareAsOrg ? '1px solid var(--blue)' : '1px solid transparent' }
  }, /*#__PURE__*/React.createElement(I, { n: "shieldCheck", s: 13, c: shareAsOrg ? 'var(--blue)' : 'var(--tx-3)' }), " ", orgMeta?.name || 'Organization')),

  /*#__PURE__*/React.createElement("div", {
    style: { background: 'var(--bg-1)', border: '1px solid var(--border-1)', borderRadius: 'var(--r-lg)', padding: '14px 16px', marginBottom: 16 }
  }, /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 15, fontWeight: 700, color: 'var(--tx-0)', marginBottom: 4 }
  }, providerProfile.display_name || svc.userId?.split(':')[0]?.replace('@', '') || T.provider_term),
  shareAsOrg && providerProfile.title && /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 12, color: 'var(--tx-1)', marginBottom: 2 }
  }, providerProfile.title),
  shareAsOrg && orgMeta?.name && /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 12, color: 'var(--blue)', marginBottom: 2, display: 'flex', alignItems: 'center', gap: 6 }
  }, /*#__PURE__*/React.createElement(I, { n: "shieldCheck", s: 12, c: "var(--blue)" }), orgMeta.name),
  shareAsOrg && providerProfile.credentials && /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 11, color: 'var(--tx-2)', marginBottom: 2 }
  }, providerProfile.credentials),
  shareAsOrg && myVerification?.status === 'verified' && myVerification.email && /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 12, color: 'var(--tx-1)', marginBottom: 2, display: 'flex', alignItems: 'center', gap: 6 }
  }, /*#__PURE__*/React.createElement(I, { n: "mail", s: 12, c: "var(--tx-2)" }), myVerification.email),
  /*#__PURE__*/React.createElement("div", {
    style: { fontSize: 10, color: 'var(--tx-3)', fontFamily: 'var(--mono)', marginTop: 6 }
  }, svc.userId)),

  /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', gap: 8, marginBottom: 16 }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: copyContact,
    style: { flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, padding: '10px 0', background: 'var(--bg-3)', border: '1px solid var(--border-1)', borderRadius: 'var(--r)', cursor: 'pointer', color: copiedField === 'contact' ? 'var(--green)' : 'var(--tx-1)', fontSize: 12, fontWeight: 600, transition: 'all .2s' }
  }, /*#__PURE__*/React.createElement(I, { n: copiedField === 'contact' ? "check" : "copy", s: 14 }), copiedField === 'contact' ? 'Copied!' : 'Copy'),
  /*#__PURE__*/React.createElement("button", {
    onClick: shareContactViaSMS,
    style: { flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, padding: '10px 0', background: 'var(--bg-3)', border: '1px solid var(--border-1)', borderRadius: 'var(--r)', cursor: 'pointer', color: 'var(--tx-1)', fontSize: 12, fontWeight: 600, transition: 'all .2s' }
  }, /*#__PURE__*/React.createElement(I, { n: "msg", s: 14 }), "Text"),
  /*#__PURE__*/React.createElement("button", {
    onClick: shareContactViaEmail,
    style: { flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, padding: '10px 0', background: 'var(--bg-3)', border: '1px solid var(--border-1)', borderRadius: 'var(--r)', cursor: 'pointer', color: 'var(--tx-1)', fontSize: 12, fontWeight: 600, transition: 'all .2s' }
  }, /*#__PURE__*/React.createElement(I, { n: "mail", s: 14 }), "Email")),

  /*#__PURE__*/React.createElement("button", {
    onClick: () => { setShareContactModal(false); openProfileModal(); },
    style: { width: '100%', background: 'transparent', border: 'none', color: 'var(--tx-2)', fontSize: 12, cursor: 'pointer', padding: '6px 0', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, transition: 'color .2s' },
    onMouseEnter: e => e.currentTarget.style.color = 'var(--gold)',
    onMouseLeave: e => e.currentTarget.style.color = 'var(--tx-2)'
  }, /*#__PURE__*/React.createElement(I, { n: "settings", s: 13 }), "Edit Profile")),

  /*#__PURE__*/React.createElement(Modal, {
    open: profileModal,
    onClose: () => setProfileModal(false),
    title: `${T.provider_term} Profile`,
    w: 520
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Your profile is stored in your roster room and synced to your bridge rooms. ", T.client_term_plural, " see your name, title, credentials, and organization membership."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "DISPLAY NAME"), /*#__PURE__*/React.createElement("input", {
    value: profileDraft.display_name,
    onChange: e => setProfileDraft({
      ...profileDraft,
      display_name: e.target.value
    }),
    placeholder: "e.g. Jamie Rivera"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "TITLE / ROLE"), /*#__PURE__*/React.createElement("input", {
    value: profileDraft.title,
    onChange: e => setProfileDraft({
      ...profileDraft,
      title: e.target.value
    }),
    placeholder: "e.g. Case Manager, Outreach Worker"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CREDENTIALS / CERTIFICATIONS"), /*#__PURE__*/React.createElement("input", {
    value: profileDraft.credentials,
    onChange: e => setProfileDraft({
      ...profileDraft,
      credentials: e.target.value
    }),
    placeholder: "e.g. LCSW, CHW, HMIS Certified"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "SERVICE TYPES"), /*#__PURE__*/React.createElement("input", {
    value: profileDraft.service_types,
    onChange: e => setProfileDraft({
      ...profileDraft,
      service_types: e.target.value
    }),
    placeholder: "e.g. Housing navigation, Benefits enrollment"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "BIO"), /*#__PURE__*/React.createElement("textarea", {
    value: profileDraft.bio,
    onChange: e => setProfileDraft({
      ...profileDraft,
      bio: e.target.value
    }),
    placeholder: "Brief description of your role and how you help clients...",
    style: {
      minHeight: 70
    }
  })), orgRoom ? /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--blue-dim)',
      border: '1px solid rgba(91,156,245,.2)',
      borderRadius: 'var(--r)',
      padding: '12px 14px',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 16,
    c: "var(--blue)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 700,
      color: 'var(--blue)'
    }
  }, "Organization Membership"), myVerification?.status === 'verified' ? /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green",
    style: {
      fontSize: 8
    }
  }, "EMAIL VERIFIED") : emailVerifyConfig.enabled ? /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 8
    }
  }, "EMAIL UNVERIFIED") : /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green",
    style: {
      fontSize: 8
    }
  }, "ROSTER VERIFIED")), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", null, orgMeta.name), " \xB7 ", ORG_TYPE_LABELS[orgMeta.type] || orgMeta.type, /*#__PURE__*/React.createElement("br", null), "Role: ", /*#__PURE__*/React.createElement("strong", null, activeOrgRoleLabels[orgRole] || orgRole), orgMeta.service_area && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("br", null), "Service Area: ", orgMeta.service_area), myVerification?.status === 'verified' && myVerification.email && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("br", null), "Verified email: ", /*#__PURE__*/React.createElement("strong", null, myVerification.email))), emailVerifyConfig.enabled && myVerification?.status !== 'verified' ? /*#__PURE__*/React.createElement("div", {
    style: {
      marginTop: 8
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 10,
      color: 'var(--gold)',
      marginBottom: 6
    }
  }, "Your organization requires email verification. Verify your email to display a verified badge to clients."), /*#__PURE__*/React.createElement("button", {
    onClick: openEmailVerifyModal,
    className: "b-pri b-sm",
    style: {
      fontSize: 11
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 12
  }), " Verify Email Now")) : /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 10,
      color: 'var(--tx-2)',
      marginTop: 6
    }
  }, myVerification?.status === 'verified' ? 'Your identity is email-verified and visible to clients on all bridges.' : 'Your organization membership is verified through the Matrix room roster and will be visible to clients on all bridges.')) : /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--gold-dim)',
      border: '1px solid var(--gold-mid)',
      borderRadius: 'var(--r)',
      padding: '12px 14px',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "alert",
    s: 14,
    c: "var(--gold)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11.5,
      color: 'var(--gold)',
      fontWeight: 600
    }
  }, "No organization affiliation")), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-2)',
      marginTop: 4
    }
  }, "Clients will see you as an independent provider. Create or join an organization to display a verified affiliation badge on your profile.")), /*#__PURE__*/React.createElement("button", {
    onClick: handleSaveProfile,
    className: "b-pri",
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "check",
    s: 16
  }), " Save Profile & Broadcast")), /*#__PURE__*/React.createElement(Modal, {
    open: emailVerifyModal,
    onClose: () => setEmailVerifyModal(false),
    title: "Verify Your Email",
    w: 480
  }, verifyStep === 'email' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Enter your organization email address to verify your identity. A 6-digit code will be sent to your email.", emailVerifyConfig.required_domains?.length > 0 && /*#__PURE__*/React.createElement(React.Fragment, null, " Your email must be from: ", /*#__PURE__*/React.createElement("strong", null, emailVerifyConfig.required_domains.map(d => '@' + d).join(', ')), ".")), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "EMAIL ADDRESS"), /*#__PURE__*/React.createElement("input", {
    value: verifyEmail,
    onChange: e => {
      setVerifyEmail(e.target.value);
      setVerifyError('');
    },
    placeholder: emailVerifyConfig.required_domains?.[0] ? `you@${emailVerifyConfig.required_domains[0]}` : 'you@organization.org',
    type: "email"
  })), verifyError && /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--red-dim)',
      border: '1px solid rgba(239,68,68,.2)',
      borderRadius: 'var(--r)',
      padding: '8px 12px',
      marginBottom: 14,
      fontSize: 11.5,
      color: 'var(--red)'
    }
  }, verifyError), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--blue-dim)',
      border: '1px solid rgba(91,156,245,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 14,
      fontSize: 11,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--blue)'
    }
  }, "How it works:"), " We'll send a one-time 6-digit code to this email. Enter it on the next screen to confirm you control this address. The code expires after 15 minutes."), /*#__PURE__*/React.createElement("button", {
    onClick: handleStartEmailVerify,
    disabled: verifyPending || !verifyEmail.trim(),
    className: "b-pri",
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, verifyPending ? 'Sending...' : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(I, {
    n: "msg",
    s: 14
  }), " Send Verification Code"))), verifyStep === 'code' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "A verification code was sent to ", /*#__PURE__*/React.createElement("strong", null, verifyEmail), ". Enter the 6-digit code below."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "VERIFICATION CODE"), /*#__PURE__*/React.createElement("input", {
    value: verifyCode,
    onChange: e => {
      setVerifyCode(e.target.value.replace(/\D/g, '').slice(0, 6));
      setVerifyError('');
    },
    placeholder: "000000",
    maxLength: 6,
    style: {
      fontSize: 28,
      letterSpacing: '0.3em',
      textAlign: 'center',
      fontFamily: 'var(--mono)',
      fontWeight: 700
    }
  })), verifyError && /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--red-dim)',
      border: '1px solid rgba(239,68,68,.2)',
      borderRadius: 'var(--r)',
      padding: '8px 12px',
      marginBottom: 14,
      fontSize: 11.5,
      color: 'var(--red)'
    }
  }, verifyError), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setVerifyStep('email');
      setVerifyCode('');
      setVerifyError('');
    },
    className: "b-gho",
    style: {
      flex: 1
    }
  }, "Back"), /*#__PURE__*/React.createElement("button", {
    onClick: handleSubmitVerifyCode,
    disabled: verifyPending || verifyCode.length !== 6,
    className: "b-pri",
    style: {
      flex: 2,
      padding: 12,
      fontSize: 14
    }
  }, verifyPending ? 'Verifying...' : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 14
  }), " Verify")))), verifyStep === 'done' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center',
      padding: '20px 0'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 60,
      height: 60,
      borderRadius: '50%',
      background: 'var(--green-dim)',
      border: '2px solid var(--green)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      margin: '0 auto 16px'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "check",
    s: 28,
    c: "var(--green)"
  })), /*#__PURE__*/React.createElement("h3", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      color: 'var(--green)',
      marginBottom: 8
    }
  }, "Email Verified"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.6,
      marginBottom: 4
    }
  }, "Your identity has been confirmed via ", /*#__PURE__*/React.createElement("strong", null, myVerification?.email)), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, "Your verified status is now visible to clients on all bridges and reflected in your provider profile.")), /*#__PURE__*/React.createElement("button", {
    onClick: () => setEmailVerifyModal(false),
    className: "b-pri",
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, "Done"))), /*#__PURE__*/React.createElement(Modal, {
    open: emailConfigModal,
    onClose: () => setEmailConfigModal(false),
    title: "Email Verification Settings",
    w: 520
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Configure email verification requirements for your organization. When enabled, ", T.staff_term_plural.toLowerCase(), " must verify they control an email at an approved domain before accessing cases."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("label", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 10,
      cursor: 'pointer',
      padding: '12px 14px',
      background: emailConfigDraft.enabled ? 'var(--green-dim)' : 'var(--bg-3)',
      border: `1px solid ${emailConfigDraft.enabled ? 'rgba(61,214,140,.2)' : 'var(--border-0)'}`,
      borderRadius: 'var(--r)'
    }
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: emailConfigDraft.enabled,
    onChange: e => setEmailConfigDraft({
      ...emailConfigDraft,
      enabled: e.target.checked
    }),
    style: {
      width: 16,
      height: 16
    }
  }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 600,
      display: 'block'
    }
  }, "Require Email Verification"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-2)'
    }
  }, T.staff_term_plural, " must verify their email before full access")))), emailConfigDraft.enabled && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "APPROVED EMAIL DOMAINS"), /*#__PURE__*/React.createElement("input", {
    value: (emailConfigDraft.required_domains || []).join(', '),
    onChange: e => setEmailConfigDraft({
      ...emailConfigDraft,
      required_domains: e.target.value.split(',').map(s => s.trim().replace(/^@/, ''))
    }),
    placeholder: "e.g. metroservices.org, metro-services.com"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      display: 'block',
      marginTop: 4
    }
  }, "Comma-separated list of allowed email domains. Leave empty to allow any domain.")), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "REQUIRED FOR ROLES"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexWrap: 'wrap',
      gap: 6,
      marginTop: 4
    }
  }, activeOrgRoles.map(r => {
    const active = (emailConfigDraft.require_for_roles || []).includes(r);
    return /*#__PURE__*/React.createElement("label", {
      key: r,
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 4,
        cursor: 'pointer',
        padding: '4px 8px',
        background: active ? 'var(--blue-dim)' : 'var(--bg-3)',
        border: `1px solid ${active ? 'rgba(91,156,245,.2)' : 'var(--border-0)'}`,
        borderRadius: 6,
        fontSize: 11
      }
    }, /*#__PURE__*/React.createElement("input", {
      type: "checkbox",
      checked: active,
      onChange: e => {
        const roles = e.target.checked ? [...(emailConfigDraft.require_for_roles || []), r] : (emailConfigDraft.require_for_roles || []).filter(x => x !== r);
        setEmailConfigDraft({
          ...emailConfigDraft,
          require_for_roles: roles
        });
      },
      style: {
        width: 12,
        height: 12
      }
    }), activeOrgRoleLabels[r]);
  }))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "GRACE PERIOD (HOURS)"), /*#__PURE__*/React.createElement("input", {
    type: "number",
    min: 0,
    max: 720,
    value: emailConfigDraft.grace_period_hours || 72,
    onChange: e => setEmailConfigDraft({
      ...emailConfigDraft,
      grace_period_hours: parseInt(e.target.value) || 72
    })
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      display: 'block',
      marginTop: 4
    }
  }, "Time before unverified ", T.staff_term_plural.toLowerCase(), " lose access. 0 = immediate.")), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--gold-dim)',
      border: '1px solid var(--gold-mid)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 14,
      fontSize: 11,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--gold)'
    }
  }, "Note:"), " Enabling verification will prompt all existing ", T.staff_term_plural.toLowerCase(), " in the selected roles to verify their email. Currently ", staff.filter(s => s.email_verification?.status === 'verified').length, " of ", staff.length, " ", T.staff_term_plural.toLowerCase(), " are verified.")), /*#__PURE__*/React.createElement("button", {
    onClick: handleSaveEmailVerifyConfig,
    className: "b-pri",
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 16
  }), " Save Verification Settings")), /*#__PURE__*/React.createElement(Modal, {
    open: createTeamModal,
    onClose: () => setCreateTeamModal(false),
    title: "New Team",
    w: 520
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Create a team for collaboration. Teams are flexible \u2014 they can include people from your organization, other organizations, or individuals with no org affiliation. Anyone with a Matrix ID can be invited."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "TEAM NAME *"), /*#__PURE__*/React.createElement("input", {
    value: newTeamName,
    onChange: e => setNewTeamName(e.target.value),
    placeholder: "e.g. Outreach Unit, Housing Support Team"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "DESCRIPTION (OPTIONAL)"), /*#__PURE__*/React.createElement("textarea", {
    value: newTeamDesc,
    onChange: e => setNewTeamDesc(e.target.value),
    placeholder: "What is this team for?",
    style: {
      minHeight: 50
    }
  })),
  /* ── Parent team (nesting) ── */
  teams.length > 0 && React.createElement('div', { style: { marginBottom: 14 } },
    React.createElement('span', { className: 'section-label' }, 'PARENT TEAM (OPTIONAL — creates a sub-team)'),
    React.createElement('select', {
      value: newTeamParentId,
      onChange: e => setNewTeamParentId(e.target.value),
      style: { fontSize: 12 }
    },
      React.createElement('option', { value: '' }, '— None (top-level team) —'),
      teams.map(t => React.createElement('option', { key: t.roomId, value: t.roomId }, t.name))
    ),
    newTeamParentId && React.createElement('div', { style: { fontSize: 10.5, color: 'var(--teal)', marginTop: 4, display: 'flex', alignItems: 'center', gap: 4 } },
      React.createElement(I, { n: 'arr-r', s: 9, c: 'var(--teal)' }),
      'This team will be nested under ', React.createElement('strong', null, teams.find(t => t.roomId === newTeamParentId)?.name || ''),
      '. Data can roll up if tables are configured to do so.'
    )
  ),
  /* ── Governance mode ── */
  React.createElement('div', { style: { marginBottom: 14 } },
    React.createElement('span', { className: 'section-label' }, 'GOVERNANCE MODE *'),
    Object.values(TEAM_CONSENT_MODES).map(m => {
      const govColor = m.color === 'gold' ? 'var(--gold)' : m.color === 'green' ? 'var(--green)' : 'var(--blue)';
      return React.createElement('label', {
        key: m.id,
        style: { display: 'flex', alignItems: 'flex-start', gap: 10, padding: '8px 10px', borderRadius: 'var(--r)', border: '1px solid ' + (newTeamGovernance === m.id ? govColor : 'var(--border-0)'), background: newTeamGovernance === m.id ? 'var(--bg-3)' : 'transparent', cursor: 'pointer', marginBottom: 6 }
      },
        React.createElement('input', { type: 'radio', name: 'teamGov', value: m.id, checked: newTeamGovernance === m.id, onChange: () => setNewTeamGovernance(m.id), style: { marginTop: 2 } }),
        React.createElement('div', null,
          React.createElement('div', { style: { fontWeight: 600, fontSize: 12, color: newTeamGovernance === m.id ? govColor : 'var(--tx-0)' } },
            React.createElement(I, { n: m.icon, s: 10, c: govColor }), ' ', m.label),
          React.createElement('div', { style: { fontSize: 10.5, color: 'var(--tx-2)', marginTop: 2 } }, m.desc),
          m.id !== 'lead_decides' && React.createElement('div', { style: { fontSize: 10, color: 'var(--tx-3)', marginTop: 2, fontStyle: 'italic' } },
            'Schema and table changes require team votes to take effect.')
        )
      );
    })
  ),
  orgRoom && /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--blue-dim)',
      border: '1px solid rgba(91,156,245,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 16,
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--blue)'
    }
  }, "Org affiliation:"), " This team will be tagged with your org \"", orgMeta.name || 'Organization', "\" but is not restricted to org members."), /*#__PURE__*/React.createElement("button", {
    onClick: handleCreateTeam,
    className: "b-pri",
    disabled: !newTeamName.trim(),
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 16
  }), " Create Team")), /*#__PURE__*/React.createElement(Modal, {
    open: !!teamInviteModal,
    onClose: () => {
      setTeamInviteModal(null);
      setTeamInviteUserId('');
    },
    title: `Invite to: ${teamInviteModal?.name || ''}`,
    w: 520
  }, teamInviteModal && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Invite someone to join this team. They'll be added as a member and will be asked whether they want to withhold content about individuals from being shared with them."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "MATRIX ID"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("input", {
    value: teamInviteUserId,
    onChange: e => setTeamInviteUserId(e.target.value),
    placeholder: "@user:matrix.org",
    style: {
      flex: 1
    }
  }), /*#__PURE__*/React.createElement("button", {
    onClick: handleTeamInvite,
    className: "b-pri",
    disabled: !teamInviteUserId.trim(),
    style: {
      whiteSpace: 'nowrap',
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "send",
    s: 12
  }), "Invite"))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CURRENT MEMBERS (", teamInviteModal.members?.length || 0, ")"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4,
      marginTop: 6
    }
  }, (teamInviteModal.members || []).map((m, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8,
      padding: '6px 10px',
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: m.role === 'lead' ? 'briefcase' : 'user',
    s: 12,
    c: m.role === 'lead' ? 'var(--gold)' : 'var(--tx-2)'
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11.5,
      flex: 1,
      overflow: 'hidden',
      textOverflow: 'ellipsis',
      whiteSpace: 'nowrap'
    }
  }, m.display_name || m.userId), /*#__PURE__*/React.createElement("span", {
    className: `tag ${m.role === 'lead' ? 'tag-gold' : 'tag-blue'}`,
    style: {
      fontSize: 8
    }
  }, m.role?.toUpperCase()), m.sharing_consent === 'pending' && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 7
    }
  }, "PENDING"), m.sharing_consent === 'withheld' && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-red",
    style: {
      fontSize: 7
    }
  }, "WITHHELD"), m.sharing_consent === 'shared' && /*#__PURE__*/React.createElement("span", {
    className: "tag tag-green",
    style: {
      fontSize: 7
    }
  }, "SHARING"))))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      padding: '10px 14px'
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 4
    }
  }, "TEAM ROOM ID"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10.5,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-1)',
      wordBreak: 'break-all'
    }
  }, teamInviteModal.roomId)))), /*#__PURE__*/React.createElement(Modal, {
    open: !!sharingConsentModal,
    onClose: () => setSharingConsentModal(null),
    title: "Content Sharing Preference",
    w: 480
  }, sharingConsentModal && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--gold-dim)',
      border: '1px solid rgba(218,165,32,.15)',
      borderRadius: 'var(--r)',
      padding: '14px 18px',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 16,
    c: "var(--gold)"
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.7,
      margin: 0
    }
  }, "As a member of ", /*#__PURE__*/React.createElement("strong", null, sharingConsentModal.team?.name || 'this team'), ", content created about the individuals this team serves may be shared with you."))), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 13,
      fontWeight: 600,
      color: 'var(--tx-0)',
      marginBottom: 6
    }
  }, "Would you like to withhold content about individuals from being shared with you?"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-2)',
      lineHeight: 1.6,
      marginBottom: 18
    }
  }, "By default, relevant content is shared with all team members to support coordination. If you choose to withhold, you will not receive content created about individuals served by this team."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => handleSharingConsent(sharingConsentModal.team, sharingConsentModal.memberId, false),
    className: "b-pri",
    style: {
      width: '100%',
      padding: '12px 16px',
      fontSize: 13,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "check",
    s: 14
  }), " No, share content with me"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleSharingConsent(sharingConsentModal.team, sharingConsentModal.memberId, true),
    className: "b-gho",
    style: {
      width: '100%',
      padding: '12px 16px',
      fontSize: 13,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 6,
      color: 'var(--red)'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 14
  }), " Yes, withhold content from me")), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginTop: 14
    }
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-3)',
      lineHeight: 1.6,
      margin: 0
    }
  }, "You can change this preference at any time from the team view. This choice is recorded as an epistemic operation for full auditability.")))), /*#__PURE__*/React.createElement(Modal, {
    open: terminologyModal,
    onClose: () => setTerminologyModal(false),
    title: "Customize Terminology",
    w: 520
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Customize the terms your organization uses for service recipients and service providers. These labels will appear throughout the interface for all ", T.staff_term_plural.toLowerCase(), " at your organization."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 14,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 700
    }
  }, "Service Recipient Term"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)'
    }
  }, "(default: Individual)")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 10
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "SINGULAR"), /*#__PURE__*/React.createElement("input", {
    value: terminologyDraft.client_term,
    onChange: e => setTerminologyDraft({
      ...terminologyDraft,
      client_term: e.target.value
    }),
    placeholder: "e.g. Patient, Participant, Member"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "PLURAL"), /*#__PURE__*/React.createElement("input", {
    value: terminologyDraft.client_term_plural,
    onChange: e => setTerminologyDraft({
      ...terminologyDraft,
      client_term_plural: e.target.value
    }),
    placeholder: "e.g. Patients, Participants, Members"
  }))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4,
      flexWrap: 'wrap',
      marginTop: 8
    }
  }, ['Individual', 'Client', 'Patient', 'Participant', 'Member', 'Resident', 'Student', 'Guest'].map(t => /*#__PURE__*/React.createElement("span", {
    key: t,
    onClick: () => setTerminologyDraft({
      ...terminologyDraft,
      client_term: t,
      client_term_plural: t + 's'
    }),
    className: `tag ${terminologyDraft.client_term === t ? 'tag-teal' : 'tag-blue'}`,
    style: {
      fontSize: 9,
      cursor: 'pointer',
      transition: 'all .15s'
    }
  }, t)))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "briefcase",
    s: 14,
    c: "var(--gold)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 700
    }
  }, "Service Provider Term"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)'
    }
  }, "(default: Team Member)")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 10
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "SINGULAR"), /*#__PURE__*/React.createElement("input", {
    value: terminologyDraft.provider_term,
    onChange: e => setTerminologyDraft({
      ...terminologyDraft,
      provider_term: e.target.value
    }),
    placeholder: "e.g. Counselor, Therapist, Advocate"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "PLURAL"), /*#__PURE__*/React.createElement("input", {
    value: terminologyDraft.provider_term_plural,
    onChange: e => setTerminologyDraft({
      ...terminologyDraft,
      provider_term_plural: e.target.value
    }),
    placeholder: "e.g. Counselors, Therapists, Advocates"
  }))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4,
      flexWrap: 'wrap',
      marginTop: 8
    }
  }, ['Team Member', 'Provider', 'Counselor', 'Therapist', 'Advocate', 'Case Worker', 'Coordinator', 'Staff'].map(t => /*#__PURE__*/React.createElement("span", {
    key: t,
    onClick: () => setTerminologyDraft({
      ...terminologyDraft,
      provider_term: t,
      provider_term_plural: t.endsWith('f') ? t.slice(0, -1) + 'ves' : t.endsWith('s') || t.endsWith('x') || t.endsWith('ch') || t.endsWith('sh') ? t + 'es' : t + 's'
    }),
    className: `tag ${terminologyDraft.provider_term === t ? 'tag-gold' : 'tag-blue'}`,
    style: {
      fontSize: 9,
      cursor: 'pointer',
      transition: 'all .15s'
    }
  }, t)))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      marginBottom: 12
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 14,
    c: "var(--blue)"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 13,
      fontWeight: 700
    }
  }, "Roster / Staff Term"), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)'
    }
  }, "(default: Team Member)")), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: 10
    }
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "SINGULAR"), /*#__PURE__*/React.createElement("input", {
    value: terminologyDraft.staff_term,
    onChange: e => setTerminologyDraft({
      ...terminologyDraft,
      staff_term: e.target.value
    }),
    placeholder: "e.g. Team Member, Staff, Employee"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "PLURAL"), /*#__PURE__*/React.createElement("input", {
    value: terminologyDraft.staff_term_plural,
    onChange: e => setTerminologyDraft({
      ...terminologyDraft,
      staff_term_plural: e.target.value
    }),
    placeholder: "e.g. Team Members, Staff, Employees"
  }))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 4,
      flexWrap: 'wrap',
      marginTop: 8
    }
  }, ['Team Member', 'Staff', 'Employee', 'Worker', 'Colleague', 'Personnel'].map(t => /*#__PURE__*/React.createElement("span", {
    key: t,
    onClick: () => setTerminologyDraft({
      ...terminologyDraft,
      staff_term: t,
      staff_term_plural: t.endsWith('f') ? t.slice(0, -1) + 'ves' : t.endsWith('s') || t.endsWith('x') || t.endsWith('ch') || t.endsWith('sh') ? t + 'es' : t + 's'
    }),
    className: `tag ${terminologyDraft.staff_term === t ? 'tag-blue' : 'tag-blue'}`,
    style: {
      fontSize: 9,
      cursor: 'pointer',
      transition: 'all .15s',
      opacity: terminologyDraft.staff_term === t ? 1 : 0.5
    }
  }, t)))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      padding: '12px 14px',
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 8
    }
  }, "PREVIEW"), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      lineHeight: 1.8
    }
  }, /*#__PURE__*/React.createElement("span", null, "\"", terminologyDraft.provider_term || 'Provider', " Dashboard\" \xB7 \"My ", terminologyDraft.client_term_plural || 'Clients', "\" \xB7 \"New ", terminologyDraft.client_term || 'Client', " Record\""), /*#__PURE__*/React.createElement("br", null), /*#__PURE__*/React.createElement("span", null, "\"", terminologyDraft.staff_term_plural || 'Team Members', " Roster\" \xB7 \"Invite ", terminologyDraft.staff_term || 'Team Member', "\" \xB7 \"Current ", terminologyDraft.staff_term_plural || 'Team Members', "\""))), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: handleResetTerminology,
    className: "b-gho",
    style: {
      flex: 1,
      padding: 10
    }
  }, "Reset to Defaults"), /*#__PURE__*/React.createElement("button", {
    onClick: handleSaveTerminology,
    className: "b-pri",
    disabled: !terminologyDraft.client_term?.trim() || !terminologyDraft.client_term_plural?.trim() || !terminologyDraft.provider_term?.trim() || !terminologyDraft.provider_term_plural?.trim() || !terminologyDraft.staff_term?.trim() || !terminologyDraft.staff_term_plural?.trim(),
    style: {
      flex: 1,
      padding: 10,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shieldCheck",
    s: 14
  }), " Save Terminology"))), /*#__PURE__*/React.createElement(Modal, {
    open: createClientModal,
    onClose: () => setCreateClientModal(false),
    title: `New ${T.client_term} Record`,
    w: 520
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Create ", aOrAn(T.client_term), " ", T.client_term.toLowerCase(), " record. This creates a private encrypted Matrix room. If you provide a Matrix ID, the ", T.client_term.toLowerCase(), " will be invited and given superadmin control (power level 100) \u2014 they can remove anyone from the room."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, T.client_term.toUpperCase(), " NAME *"), /*#__PURE__*/React.createElement("input", {
    value: newClientName,
    onChange: e => setNewClientName(e.target.value),
    placeholder: "e.g. John Doe"
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, T.client_term.toUpperCase(), " MATRIX ID (OPTIONAL)"), /*#__PURE__*/React.createElement("input", {
    value: newClientMatrixId,
    onChange: e => setNewClientMatrixId(e.target.value),
    placeholder: "@user:matrix.org"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      display: 'block',
      marginTop: 4
    }
  }, "If provided, the ", T.client_term.toLowerCase(), " will be invited immediately. You can also invite them later.")), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "NOTES (OPTIONAL)"), /*#__PURE__*/React.createElement("textarea", {
    value: newClientNotes,
    onChange: e => setNewClientNotes(e.target.value),
    placeholder: `Any notes about this ${T.client_term.toLowerCase()}...`,
    style: {
      minHeight: 50
    }
  })), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 16,
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--teal)'
    }
  }, "Data sovereignty:"), " The ", T.client_term.toLowerCase(), " will receive power level 100 (superadmin). They can kick any member \u2014 including you \u2014 from their room at any time."), /*#__PURE__*/React.createElement("button", {
    onClick: handleCreateClientRecord,
    className: "b-pri",
    disabled: !newClientName.trim(),
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "plus",
    s: 16
  }), " Create ", T.client_term, " Record")), /*#__PURE__*/React.createElement(Modal, {
    open: !!clientInviteModal,
    onClose: () => {
      setClientInviteModal(null);
      setCopiedField(null);
    },
    title: `Invite: ${clientInviteModal?.client_name || ''}`,
    w: 600
  }, clientInviteModal && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Generate an invite link and setup instructions to share with this ", T.client_term.toLowerCase(), ". When they join, they'll have full control of their room."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, T.client_term.toUpperCase(), " MATRIX ID"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6
    }
  }, /*#__PURE__*/React.createElement("input", {
    value: clientInviteMatrixId,
    onChange: e => setClientInviteMatrixId(e.target.value),
    placeholder: "@user:matrix.org",
    style: {
      flex: 1
    }
  }), /*#__PURE__*/React.createElement("button", {
    onClick: handleClientInvite,
    className: "b-pri",
    disabled: !clientInviteMatrixId.trim(),
    style: {
      whiteSpace: 'nowrap',
      display: 'flex',
      alignItems: 'center',
      gap: 4
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "send",
    s: 12
  }), "Send Invite")), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      display: 'block',
      marginTop: 4
    }
  }, "Enter the client's Matrix ID to send a direct room invite and grant them superadmin (PL 100).")), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "INVITE LINK"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 6,
      alignItems: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      flex: 1,
      fontFamily: 'var(--mono)',
      fontSize: 11,
      color: 'var(--tx-1)',
      background: 'var(--bg-3)',
      padding: '10px 14px',
      borderRadius: 'var(--r)',
      border: '1px solid var(--border-1)',
      wordBreak: 'break-all',
      userSelect: 'all'
    }
  }, getInviteUrl(clientInviteModal.roomId)), /*#__PURE__*/React.createElement("button", {
    onClick: () => copyToClipboard(getInviteUrl(clientInviteModal.roomId), 'link'),
    className: "b-gho b-sm",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 4,
      whiteSpace: 'nowrap'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: copiedField === 'link' ? 'check' : 'copy',
    s: 12
  }), copiedField === 'link' ? 'Copied' : 'Copy'))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 6
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label",
    style: {
      marginBottom: 0
    }
  }, "SETUP INSTRUCTIONS \u2014 SHARE WITH CLIENT"), /*#__PURE__*/React.createElement("button", {
    onClick: () => copyToClipboard(getSetupInstructions(clientInviteModal.roomId), 'instructions'),
    className: "b-gho b-xs",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 3
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: copiedField === 'instructions' ? 'check' : 'copy',
    s: 11
  }), copiedField === 'instructions' ? 'Copied' : 'Copy All')), /*#__PURE__*/React.createElement("div", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 10.5,
      color: 'var(--tx-1)',
      background: 'var(--bg-1)',
      border: '1px solid var(--border-1)',
      borderRadius: 'var(--r)',
      padding: '14px 16px',
      lineHeight: 1.7,
      whiteSpace: 'pre-wrap',
      maxHeight: 300,
      overflow: 'auto'
    }
  }, getSetupInstructions(clientInviteModal.roomId))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "SHARE INVITE"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 8,
      flexWrap: 'wrap'
    }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => shareInviteViaEmail(clientInviteModal.roomId),
    className: "b-gho",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      flex: 1,
      justifyContent: 'center',
      minWidth: 120
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "mail",
    s: 14
  }), "Email"), /*#__PURE__*/React.createElement("button", {
    onClick: () => shareInviteViaSMS(clientInviteModal.roomId),
    className: "b-gho",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      flex: 1,
      justifyContent: 'center',
      minWidth: 120
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "messageSquare",
    s: 14
  }), "Text / SMS"), /*#__PURE__*/React.createElement("button", {
    onClick: () => shareInviteNative(clientInviteModal.roomId),
    className: "b-gho",
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      flex: 1,
      justifyContent: 'center',
      minWidth: 120
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "share",
    s: 14
  }), "More..."))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '12px 16px',
      display: 'flex',
      gap: 10,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "shield",
    s: 16,
    c: "var(--teal)"
  }), /*#__PURE__*/React.createElement("div", {
    style: {
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--teal)'
    }
  }, "Client gets power level 100 (superadmin)."), " Once joined, they can remove anyone from this room \u2014 including you. This ensures the client always has sovereign control over who can access their space.")))), /*#__PURE__*/React.createElement(ImportDataModal, {
    open: importModal,
    onClose: () => setImportModal(false),
    showToast: showToast,
    metricsRoom: metricsRoom,
    onComplete: handleImportComplete
  }),
  /* ── CreateTableModal ── */
  React.createElement(CreateTableModal, {
    open: !!createTableModal,
    onClose: newTable => {
      if (newTable) {
        // Add the newly created table to the active team's customTables in local state
        setTeams(prev => prev.map(t => t.roomId === createTableModal?.teamId ? {
          ...t,
          customTables: [...(t.customTables || []), newTable]
        } : t));
      }
      setCreateTableModal(null);
    },
    team: createTableModal ? (teams.find(t => t.roomId === createTableModal.teamId) || null) : null,
    teams: teams,
    svc: svc,
    showToast: showToast
  }),
  /* ── CustomTableView overlay ── */
  activeCustomTable && React.createElement('div', {
    style: { position: 'fixed', inset: 0, zIndex: 900, background: 'var(--bg-0)', overflowY: 'auto', padding: '24px 32px' }
  },
    React.createElement(CustomTableView, {
      table: activeCustomTable.table,
      team: teams.find(t => t.roomId === activeCustomTable.teamId) || null,
      svc: svc,
      showToast: showToast,
      onBack: () => setActiveCustomTable(null)
    })
  ),
  /*#__PURE__*/React.createElement(DatabaseMergeModal, {
    open: dbMergeModal,
    onClose: () => { setDbMergeModal(false); setDbMergeRecordA(null); setDbMergeRecordB(null); },
    recordA: dbMergeRecordA,
    recordB: dbMergeRecordB,
    allRecords: clientRecords.map(cr => ({
      roomId: cr.roomId,
      name: cr.client_name || cr.name || 'Record',
      fields: cr.fields || {},
      timestamps: cr.timestamps || {},
      ts: cr.created_at || cr.ts || 0
    })),
    targetRoomId: dbMergeRecordA?.roomId || (clientRecords[0] && clientRecords[0].roomId),
    showToast: showToast,
    onComplete: (res) => {
      if (showToast) showToast('Database merge completed: ' + res.ops_emitted + ' auditable EO operations');
    }
  }), /*#__PURE__*/React.createElement(Modal, {
    open: composeOrgModal,
    onClose: () => setComposeOrgModal(false),
    title: "New Org Messaging Channel",
    w: 520
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 14,
      lineHeight: 1.6
    }
  }, "Create an encrypted messaging channel with another organization. Messages you send will be governed by your opacity setting (", /*#__PURE__*/React.createElement("strong", {
    style: {
      color: orgOpacity === 'opaque' ? 'var(--red)' : orgOpacity === 'translucent' ? 'var(--gold)' : 'var(--green)'
    }
  }, OPACITY_LABELS[orgOpacity]), ")."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "PEER ORGANIZATION ROOM ID"), /*#__PURE__*/React.createElement("input", {
    value: composePeerOrgId,
    onChange: e => setComposePeerOrgId(e.target.value),
    placeholder: "!orgroom:matrix.org"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      display: 'block',
      marginTop: 4
    }
  }, "The Matrix room ID of the organization you want to message.")), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ORGANIZATION NAME (OPTIONAL)"), /*#__PURE__*/React.createElement("input", {
    value: composePeerOrgName,
    onChange: e => setComposePeerOrgName(e.target.value),
    placeholder: "e.g. Metro Housing Authority"
  }), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      color: 'var(--tx-3)',
      display: 'block',
      marginTop: 4
    }
  }, "A display name for the other org. Helps identify the channel.")), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--bg-3)',
      borderRadius: 'var(--r)',
      padding: '12px 14px',
      marginBottom: 14
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10,
      fontFamily: 'var(--mono)',
      color: 'var(--tx-3)',
      display: 'block',
      marginBottom: 6
    }
  }, "OPACITY PREVIEW \u2014 THEY WILL SEE:"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: `tag ${orgOpacity === 'opaque' ? 'tag-red' : orgOpacity === 'translucent' ? 'tag-gold' : 'tag-green'}`,
    style: {
      fontSize: 9
    }
  }, OPACITY_LABELS[orgOpacity]?.toUpperCase()), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)'
    }
  }, orgOpacity === 'transparent' ? `${providerProfile.display_name || T.staff_term + ' Name'} from ${orgMeta.name || 'Your Org'}` : orgOpacity === 'translucent' ? orgMeta.name || 'Your Org' : 'An organization'))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 16,
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, "Both organizations maintain independent opacity settings. You control what they see about you; they control what you see about them."), /*#__PURE__*/React.createElement("button", {
    onClick: handleCreateOrgChannel,
    className: "b-pri",
    disabled: !composePeerOrgId.trim(),
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "msg",
    s: 16
  }), " Create Channel")), /*#__PURE__*/React.createElement(Modal, {
    open: newTeamDMModal,
    onClose: () => { setNewTeamDMModal(false); setNewDMTarget(null); },
    title: "New Team Member DM",
    w: 480
  }, /*#__PURE__*/React.createElement("p", {
    style: { fontSize: 12, color: 'var(--tx-1)', marginBottom: 14, lineHeight: 1.6 }
  }, "Start an encrypted direct conversation with a team member. Select someone from your teams below."),
  teamMemberContacts.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: { textAlign: 'center', padding: '20px 0', color: 'var(--tx-3)', fontSize: 12 }
  }, "No team members found. Join a team first.") : /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', flexDirection: 'column', gap: 6, maxHeight: 320, overflow: 'auto', marginBottom: 16 }
  }, teamMemberContacts.map(c => /*#__PURE__*/React.createElement("div", {
    key: c.userId,
    onClick: () => setNewDMTarget(c),
    style: {
      padding: '10px 14px', borderRadius: 'var(--r)', border: `1px solid ${newDMTarget?.userId === c.userId ? 'var(--purple)' : 'var(--border-0)'}`,
      background: newDMTarget?.userId === c.userId ? 'var(--purple-dim)' : 'var(--bg-2)', cursor: 'pointer', transition: 'all .15s'
    }
  }, /*#__PURE__*/React.createElement("div", { style: { display: 'flex', alignItems: 'center', gap: 8, justifyContent: 'space-between' } },
    /*#__PURE__*/React.createElement("div", { style: { flex: 1, minWidth: 0 } },
      /*#__PURE__*/React.createElement("span", { style: { fontSize: 13, fontWeight: 600, display: 'block' } }, c.displayName),
      /*#__PURE__*/React.createElement("div", { style: { marginTop: 3 } },
        /*#__PURE__*/React.createElement(ConnectionBadges, { userType: "provider", teamName: c.teamName, teamColors: teamColorsList, orgName: orgMeta?.name, role: c.role, size: "xs" }))),
    c.hasDM && /*#__PURE__*/React.createElement("span", { className: "tag tag-green", style: { fontSize: 8 } }, "DM exists"))))),
  newDMTarget && /*#__PURE__*/React.createElement("button", {
    onClick: () => startTeamDM(newDMTarget.userId, newDMTarget.displayName, newDMTarget.teamName, newDMTarget.teamRoomId),
    className: "b-pri",
    style: { width: '100%', padding: 12, fontSize: 14 }
  }, /*#__PURE__*/React.createElement(I, { n: "msg", s: 16 }), " Start Conversation with ", newDMTarget.displayName)), /*#__PURE__*/React.createElement(Modal, {
    open: newBucketModal,
    onClose: () => { setNewBucketModal(false); setNewBucketDraft(''); },
    title: "New Group",
    w: 400
  }, /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', flexDirection: 'column', gap: 14 }
  }, /*#__PURE__*/React.createElement("p", {
    style: { fontSize: 12, color: 'var(--tx-1)', lineHeight: 1.5 }
  }, "Create a named group to organize your conversations. You can move any conversation into a group from the messages sidebar."), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    style: { fontSize: 11, fontWeight: 600, display: 'block', marginBottom: 6 }
  }, "Group Name"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newBucketDraft,
    onChange: e => setNewBucketDraft(e.target.value),
    placeholder: "e.g. Priority, Intake, Follow-up...",
    onKeyDown: e => { if (e.key === 'Enter' && newBucketDraft.trim()) { createMsgBucket(newBucketDraft); setNewBucketModal(false); setNewBucketDraft(''); } },
    style: { width: '100%' },
    autoFocus: true
  })), /*#__PURE__*/React.createElement("div", {
    style: { display: 'flex', justifyContent: 'flex-end', gap: 8 }
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => { setNewBucketModal(false); setNewBucketDraft(''); },
    className: "b-gho"
  }, "Cancel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => { if (newBucketDraft.trim()) { createMsgBucket(newBucketDraft); setNewBucketModal(false); setNewBucketDraft(''); } },
    className: "b-pri",
    disabled: !newBucketDraft.trim()
  }, "Create Group")))), /*#__PURE__*/React.createElement(Modal, {
    open: msgAccessModal,
    onClose: () => setMsgAccessModal(false),
    title: "Configure Message Access",
    w: 560
  }, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Control which roles in your organization can read and respond to inter-org messages. Only roles listed under \"Respond\" can send messages on behalf of your organization."), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CAN READ ORG MESSAGES"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-3)',
      marginBottom: 8
    }
  }, "Select roles that can view messages sent to your organization."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4
    }
  }, activeOrgRoles.map(role => /*#__PURE__*/React.createElement("div", {
    key: role,
    onClick: () => {
      setMsgAccessDraft(prev => ({
        ...prev,
        read: prev.read.includes(role) ? prev.read.filter(r => r !== role) : [...prev.read, role]
      }));
    },
    style: {
      padding: '10px 14px',
      borderRadius: 'var(--r)',
      cursor: 'pointer',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      border: `1px solid ${msgAccessDraft.read?.includes(role) ? 'var(--blue)' : 'var(--border-1)'}`,
      background: msgAccessDraft.read?.includes(role) ? 'var(--blue-dim)' : 'var(--bg-3)',
      transition: 'all .15s'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      width: 14,
      height: 14,
      borderRadius: 3,
      border: `2px solid ${msgAccessDraft.read?.includes(role) ? 'var(--blue)' : 'var(--tx-3)'}`,
      background: msgAccessDraft.read?.includes(role) ? 'var(--blue)' : 'transparent',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: '#fff',
      fontSize: 9,
      fontWeight: 800
    }
  }, msgAccessDraft.read?.includes(role) ? '✓' : ''), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12.5,
      fontWeight: msgAccessDraft.read?.includes(role) ? 600 : 400
    }
  }, activeOrgRoleLabels[role])), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-blue",
    style: {
      fontSize: 8
    }
  }, "READ"))))), /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CAN RESPOND TO ORG MESSAGES"), /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-3)',
      marginBottom: 8
    }
  }, "Select roles that can send messages on behalf of your organization. These roles can also read."), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4
    }
  }, activeOrgRoles.map(role => /*#__PURE__*/React.createElement("div", {
    key: role,
    onClick: () => {
      setMsgAccessDraft(prev => ({
        ...prev,
        respond: (prev.respond || []).includes(role) ? (prev.respond || []).filter(r => r !== role) : [...(prev.respond || []), role]
      }));
    },
    style: {
      padding: '10px 14px',
      borderRadius: 'var(--r)',
      cursor: 'pointer',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      border: `1px solid ${msgAccessDraft.respond?.includes(role) ? 'var(--gold)' : 'var(--border-1)'}`,
      background: msgAccessDraft.respond?.includes(role) ? 'var(--gold-dim)' : 'var(--bg-3)',
      transition: 'all .15s'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 8
    }
  }, /*#__PURE__*/React.createElement("span", {
    style: {
      width: 14,
      height: 14,
      borderRadius: 3,
      border: `2px solid ${msgAccessDraft.respond?.includes(role) ? 'var(--gold)' : 'var(--tx-3)'}`,
      background: msgAccessDraft.respond?.includes(role) ? 'var(--gold)' : 'transparent',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--bg-0)',
      fontSize: 9,
      fontWeight: 800
    }
  }, msgAccessDraft.respond?.includes(role) ? '✓' : ''), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12.5,
      fontWeight: msgAccessDraft.respond?.includes(role) ? 600 : 400
    }
  }, activeOrgRoleLabels[role])), /*#__PURE__*/React.createElement("span", {
    className: "tag tag-gold",
    style: {
      fontSize: 8
    }
  }, "RESPOND"))))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--purple-dim)',
      border: '1px solid rgba(167,139,250,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 16,
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--purple)'
    }
  }, "Opacity + Access = Privacy."), " Opacity controls ", /*#__PURE__*/React.createElement("em", null, "what"), " external orgs see. Access controls ", /*#__PURE__*/React.createElement("em", null, "who inside your org"), " can participate. Together, they form your org's communication privacy posture."), /*#__PURE__*/React.createElement("button", {
    onClick: handleSaveMsgAccess,
    className: "b-pri",
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "check",
    s: 16
  }), " Save Access Settings")), /*#__PURE__*/React.createElement(Modal, {
    open: !!transferModal,
    onClose: () => {
      setTransferModal(null);
      setTransferTarget('');
    },
    title: "Transfer Case",
    w: 520
  }, transferModal && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("p", {
    style: {
      fontSize: 12,
      color: 'var(--tx-1)',
      marginBottom: 16,
      lineHeight: 1.6
    }
  }, "Reassign this case to a different ", T.provider_term.toLowerCase(), " within your organization. The new ", T.provider_term.toLowerCase(), " will be invited to the encrypted bridge room."), /*#__PURE__*/React.createElement("div", {
    className: "card",
    style: {
      padding: 14,
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "CURRENT CASE"), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      alignItems: 'center',
      gap: 10,
      marginTop: 4
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 36,
      height: 36,
      borderRadius: '50%',
      background: 'var(--teal-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--teal)',
      border: '2px solid var(--teal)'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "user",
    s: 16
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 14,
      fontWeight: 600,
      display: 'block'
    }
  }, transferModal.sharedData?.full_name || transferModal.clientUserId), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 10.5,
      color: 'var(--tx-2)',
      fontFamily: 'var(--mono)'
    }
  }, "Currently: ", transferModal.meta?.provider?.split(':')[0]?.replace('@', ''))))), !transferModal.transferable && /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--red-dim)',
      border: '1px solid rgba(232,93,93,.18)',
      borderRadius: 'var(--r)',
      padding: '12px 16px',
      marginBottom: 16,
      display: 'flex',
      gap: 10,
      alignItems: 'flex-start'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 16,
    c: "var(--red)"
  }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 12,
      fontWeight: 600,
      color: 'var(--red)',
      display: 'block'
    }
  }, "Transfer Blocked by ", T.client_term), /*#__PURE__*/React.createElement("span", {
    style: {
      fontSize: 11,
      color: 'var(--tx-1)'
    }
  }, "This ", T.client_term.toLowerCase(), " has disabled provider transfers. Only they can change this setting."))), transferModal.transferable && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    style: {
      marginBottom: 16
    }
  }, /*#__PURE__*/React.createElement("span", {
    className: "section-label"
  }, "ASSIGN TO ", T.provider_term.toUpperCase()), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      flexDirection: 'column',
      gap: 4
    }
  }, staff.filter(s => s.userId !== transferModal.meta?.provider).map(s => {
    const isSelected = transferTarget === s.userId;
    return /*#__PURE__*/React.createElement("div", {
      key: s.userId,
      onClick: () => setTransferTarget(s.userId),
      style: {
        padding: '10px 14px',
        borderRadius: 'var(--r)',
        cursor: 'pointer',
        display: 'flex',
        alignItems: 'center',
        gap: 10,
        border: `1px solid ${isSelected ? 'var(--gold)' : 'var(--border-1)'}`,
        background: isSelected ? 'var(--gold-dim)' : 'var(--bg-3)',
        transition: 'all .15s'
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        width: 14,
        height: 14,
        borderRadius: '50%',
        border: `2px solid ${isSelected ? 'var(--gold)' : 'var(--tx-3)'}`,
        background: isSelected ? 'var(--gold)' : 'transparent',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: 'var(--bg-0)',
        fontSize: 9,
        fontWeight: 800
      }
    }, isSelected ? '✓' : ''), /*#__PURE__*/React.createElement("div", {
      style: {
        flex: 1
      }
    }, /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 12.5,
        fontWeight: isSelected ? 600 : 400,
        display: 'block'
      }
    }, s.userId.split(':')[0]?.replace('@', '')), /*#__PURE__*/React.createElement("span", {
      style: {
        fontSize: 10,
        color: 'var(--tx-2)',
        fontFamily: 'var(--mono)'
      }
    }, activeOrgRoleLabels[s.role] || s.role)), /*#__PURE__*/React.createElement("span", {
      className: `tag tag-${s.role === 'admin' ? 'gold' : s.role === 'case_manager' ? 'blue' : 'teal'}`,
      style: {
        fontSize: 8
      }
    }, (activeOrgRoleLabels[s.role] || s.role).toUpperCase()));
  }), staff.filter(s => s.userId !== transferModal.meta?.provider).length === 0 && /*#__PURE__*/React.createElement("div", {
    style: {
      padding: 16,
      textAlign: 'center',
      color: 'var(--tx-3)',
      fontSize: 12
    }
  }, "No other ", T.staff_term_plural.toLowerCase(), " available for transfer."))), /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--teal-dim)',
      border: '1px solid rgba(62,201,176,.15)',
      borderRadius: 'var(--r)',
      padding: '10px 14px',
      marginBottom: 16,
      fontSize: 11.5,
      color: 'var(--tx-1)',
      lineHeight: 1.6
    }
  }, /*#__PURE__*/React.createElement("strong", {
    style: {
      color: 'var(--teal)'
    }
  }, "The ", T.client_term.toLowerCase(), " retains full control."), " They can revoke access from the new ", T.provider_term.toLowerCase(), " at any time. Encrypted field keys remain ", T.client_term.toLowerCase(), "-owned."), /*#__PURE__*/React.createElement("button", {
    onClick: handleTransferCase,
    className: "b-pri",
    disabled: !transferTarget,
    style: {
      width: '100%',
      padding: 12,
      fontSize: 14
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "users",
    s: 16
  }), " Transfer Case")))));
};

/* ═══════════════════ TRANSPARENCY & PRIVACY ═══════════════════
 * Operator Manifest:
 *   DES(transparency.page, {purpose: trust_through_visibility}) — existence
 *   INS(transparency.source, {live_code_introspection}) — source viewer
 *   CON(transparency.eo_sections, {navigable_tree}) — structural navigation
 *   DES(transparency.privacy, {access_matrix, data_flow}) — privacy model
 *
 * Triad Summary:
 *   Existence:       DES (page purpose, privacy model designation)
 *   Structure:       CON (EO section linkage, navigable tree)
 *   Interpretation:  INS (live source introspection — code IS the documentation)
 *
 * This page exists so that anyone using Khora can verify exactly what the
 * software does, who has access to their data, and how the EO operation
 * layer governs all state transitions. The source code viewer reads the
 * live running code — it cannot be out of date.
 * ═══════════════════════════════════════════════════════════ */
const TransparencyPage = ({ onBack }) => {
  const [activeTab, setActiveTab] = useState('overview');
  const [sourceCode, setSourceCode] = useState('');
  const [eoSections, setEoSections] = useState([]);
  const [activeSection, setActiveSection] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [expandedCards, setExpandedCards] = useState({});
  const codeRef = useRef(null);
  const [archLevel, setArchLevel] = useState(0);
  const [archPath, setArchPath] = useState([]);
  const [archSelected, setArchSelected] = useState(null);
  const [archHovered, setArchHovered] = useState(null);

  // Read the live source code from the running page
  useEffect(() => {
    const scripts = document.querySelectorAll('script:not([src]):not([type])');
    let code = '';
    scripts.forEach(s => { if (s.textContent.length > 1000) code = s.textContent; });
    if (!code) {
      const allScripts = document.querySelectorAll('script');
      allScripts.forEach(s => { if (!s.src && s.textContent.length > 1000) code = s.textContent; });
    }
    setSourceCode(code);

    // Parse EO section headers with full operator manifest extraction
    const lines = code.split('\n');
    const sections = [];
    const sectionRe = /\/\*\s*═{3,}\s*(.*?)\s*═{3,}\s*\*\//;
    lines.forEach((line, i) => {
      const m = line.match(sectionRe);
      if (m) {
        sections.push({ name: m[1].trim(), line: i + 1, operators: [], triad: {}, manifestLines: [], definitions: [], emitOpCalls: [] });
      }
    });
    // For each section, parse the Operator Manifest and Triad Summary from the header comment block
    const opLineRe = /^\s*\*\s+(NUL|DES|INS|SEG|CON|SYN|ALT|SUP|REC)\(([^)]*)\)\s*—\s*(.*)$/;
    const triadRe = /^\s*\*\s+(Existence|Structure|Interpretation):\s+(.*)$/;
    const fnRe = /^(?:async\s+)?function\s+(\w+)/;
    const constFnRe = /^const\s+(\w+)\s*=\s*(?:\([^)]*\)\s*=>|function|\(?\{)/;
    const constCompRe = /^const\s+(\w+)\s*=\s*\(\s*\{/;
    const emitOpRe = /emitOp\(\s*\S+,\s*'(NUL|DES|INS|SEG|CON|SYN|ALT|SUP|REC)',\s*dot\(([^)]*)\)/;
    for (let si = 0; si < sections.length; si++) {
      const sec = sections[si];
      const endLine = si < sections.length - 1 ? sections[si + 1].line - 1 : lines.length;
      // Scan the header comment block (first ~30 lines of section)
      const headerEnd = Math.min(sec.line + 30, endLine);
      for (let li = sec.line - 1; li < headerEnd; li++) {
        const raw = lines[li] || '';
        const opMatch = raw.match(opLineRe);
        if (opMatch) {
          sec.operators.push({ op: opMatch[1], target: opMatch[2].trim(), desc: opMatch[3].trim() });
          sec.manifestLines.push(raw.replace(/^\s*\*\s+/, '').trim());
        }
        const triadMatch = raw.match(triadRe);
        if (triadMatch) {
          sec.triad[triadMatch[1]] = triadMatch[2].replace(/^\s*/, '').trim();
        }
      }
      // Scan the section body for function/const definitions and emitOp calls
      for (let li = sec.line - 1; li < endLine; li++) {
        const raw = lines[li] || '';
        const fnMatch = raw.match(fnRe);
        if (fnMatch) sec.definitions.push({ name: fnMatch[1], line: li + 1, type: 'function' });
        else {
          const cfnMatch = raw.match(constFnRe);
          if (cfnMatch) sec.definitions.push({ name: cfnMatch[1], line: li + 1, type: raw.includes('=>') ? 'arrow' : 'component' });
        }
        const emitMatch = raw.match(emitOpRe);
        if (emitMatch) sec.emitOpCalls.push({ op: emitMatch[1], target: emitMatch[2].replace(/'/g, '').trim(), line: li + 1 });
      }
      // Deduplicate operators used
      const opSet = new Set(sec.operators.map(o => o.op));
      sec.emitOpCalls.forEach(c => opSet.add(c.op));
      sec.allOps = [...opSet];
    }
    setEoSections(sections);
    if (sections.length > 0) setActiveSection(sections[0]);
  }, []);

  const toggleCard = (id) => setExpandedCards(prev => ({ ...prev, [id]: !prev[id] }));

  const [sourceView, setSourceView] = useState('code'); // 'code' | 'eomap' | 'info'
  const [jumpToLine, setJumpToLine] = useState(null);

  // Get code for a specific section (no arbitrary cap)
  const getSectionCode = (section) => {
    if (!sourceCode || !section) return '';
    const lines = sourceCode.split('\n');
    const startLine = section.line - 1;
    const nextSection = eoSections.find(s => s.line > section.line);
    const endLine = nextSection ? nextSection.line - 2 : lines.length;
    return lines.slice(startLine, endLine).join('\n');
  };

  // Scroll code viewer to a specific line
  const scrollToLine = (lineNum) => {
    setSourceView('code');
    setJumpToLine(lineNum);
    setTimeout(() => {
      const el = codeRef.current;
      if (el) {
        const lineHeight = 20;
        const sectionStart = activeSection ? activeSection.line : 0;
        el.scrollTop = (lineNum - sectionStart) * lineHeight;
      }
    }, 50);
  };

  // Filter sections by search
  const filteredSections = searchQuery
    ? eoSections.filter(s => s.name.toLowerCase().includes(searchQuery.toLowerCase()))
    : eoSections;

  // Privacy model data
  const accessMatrix = [
    { entity: 'Your Vault Data', you: true, provider: false, org: false, network: false, server: false,
      detail: 'Encrypted in your private Matrix room. Only your session keys can decrypt. Not even the homeserver operator can read vault contents.' },
    { entity: 'Bridge Shared Fields', you: true, provider: true, org: false, network: false, server: false,
      detail: 'Only the specific fields you choose to share via a bridge are visible to the linked provider. You control which fields and can revoke at any time.' },
    { entity: 'Observations', you: true, provider: true, org: false, network: false, server: false,
      detail: 'Written by providers into the bridge room. Both you and the provider can read observations. They cannot be silently edited — EO provenance tracks all changes.' },
    { entity: 'Case Messages', you: true, provider: true, org: false, network: false, server: false,
      detail: 'Messages in a bridge room are visible to both parties. End-to-end encrypted via Matrix. The homeserver sees encrypted blobs only.' },
    { entity: 'Org Channel Messages', you: false, provider: true, org: true, network: false, server: false,
      detail: 'Organization-internal channels are visible to org members only. Not shared with individuals/clients.' },
    { entity: 'Anonymized Metrics', you: false, provider: true, org: true, network: true, server: false,
      detail: 'Aggregate, k-anonymized (k=5) demographic data. No PII — no names, DOB, SSN, addresses. Only statistical ranges and hashed identifiers.' },
    { entity: 'Schema Definitions', you: false, provider: true, org: true, network: true, server: false,
      detail: 'Field definitions, form structures, and data standards. Shared across the network for interoperability. Contains no personal data.' },
    { entity: 'EO Operation Log', you: true, provider: true, org: false, network: false, server: false,
      detail: 'Every state change is recorded as an EO operation with provenance chain. Both parties in a room can audit the full operation history.' },
    { entity: 'Matrix Homeserver', you: false, provider: false, org: false, network: false, server: true,
      detail: 'The homeserver stores encrypted event blobs and room membership. It cannot read encrypted content. It knows which rooms exist and who is in them.' },
  ];

  const dataFlows = [
    { from: 'You', to: 'Your Vault', description: 'All personal data starts in your encrypted vault room. Only your device keys can decrypt it.', icon: 'lock' },
    { from: 'You', to: 'Bridge Room', description: 'When you share fields with a provider, selected data is copied into a shared bridge room. You choose exactly which fields.', icon: 'shield' },
    { from: 'Provider', to: 'Bridge Room', description: 'Providers write observations, notes, and case data into the bridge. Both parties can read.', icon: 'clipboard' },
    { from: 'Bridge Room', to: 'Org Metrics', description: 'If you consent, anonymized aggregate statistics (k=5 anonymity) flow upward. No PII ever leaves the bridge.', icon: 'bar' },
    { from: 'Org', to: 'Network', description: 'Organizations can share anonymized metrics and schema definitions with the broader network. Never individual data.', icon: 'layers' },
  ];

  const eoExplainer = [
    { op: 'NUL', name: 'Null', desc: 'Empty state — no entity exists yet. The starting point before any data is created.', triad: 'Existence' },
    { op: 'DES', name: 'Designate', desc: 'Names or classifies an entity. Sets the frame for what something IS without creating data.', triad: 'Existence' },
    { op: 'INS', name: 'Instantiate', desc: 'Creates a new field or entity with a value. The moment data comes into being.', triad: 'Existence' },
    { op: 'SEG', name: 'Segment', desc: 'Partitions data into structural segments. Creates boundaries between logical groups.', triad: 'Structure' },
    { op: 'CON', name: 'Connect', desc: 'Links entities together — provenance chains, relationships, structural connections.', triad: 'Structure' },
    { op: 'SYN', name: 'Synthesize', desc: 'Combines multiple sources into a unified view. Parallel data hydration.', triad: 'Structure' },
    { op: 'ALT', name: 'Alter', desc: 'Changes a value within an existing frame. Every alteration is tracked with from/to provenance.', triad: 'Interpretation' },
    { op: 'SUP', name: 'Superpose', desc: 'Holds multiple valid values simultaneously. Represents uncertainty or competing interpretations.', triad: 'Interpretation' },
    { op: 'REC', name: 'Reconcile', desc: 'Resolves superposition into a single value. The final judgment that collapses alternatives.', triad: 'Interpretation' },
  ];

  const triadColors = { Existence: 'green', Structure: 'blue', Interpretation: 'purple' };

  const AccessDot = ({ yes }) => React.createElement('div', {
    style: {
      width: 10, height: 10, borderRadius: '50%',
      background: yes ? 'var(--green)' : 'var(--bg-4)',
      border: yes ? 'none' : '1px solid var(--border-1)',
      margin: '0 auto'
    }
  });

  // ── Overview Tab ──
  const renderOverview = () => React.createElement('div', { className: 'anim-up' },
    React.createElement('div', { className: 'card', style: { marginBottom: 16 } },
      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 10, marginBottom: 12 } },
        React.createElement('div', { style: { width: 36, height: 36, borderRadius: 'var(--r)', background: 'var(--teal-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--teal)' } },
          React.createElement(I, { n: 'shield', s: 18 })),
        React.createElement('div', null,
          React.createElement('h3', { style: { fontSize: 15, fontWeight: 700 } }, 'How Khora Works'),
          React.createElement('p', { style: { fontSize: 11.5, color: 'var(--tx-2)' } }, 'Sovereign case management — you own your data'))),
      React.createElement('div', { style: { fontSize: 13, color: 'var(--tx-1)', lineHeight: 1.7 } },
        React.createElement('p', { style: { marginBottom: 10 } },
          'Khora is a case management system built on Matrix, an open federated protocol for encrypted communication. Your data lives in encrypted Matrix rooms — not in a proprietary database controlled by any single organization.'),
        React.createElement('p', { style: { marginBottom: 10 } },
          'Every state change in the system is governed by the EO (Epistemic Operations) layer — a formal ontological framework with 9 canonical operators organized into 3 triads (Existence, Structure, Interpretation). This means every data change is traceable and auditable.'),
        React.createElement('p', null,
          'The source code of this application is fully visible on this page. Nothing is hidden. You can inspect exactly what the software does, verify the privacy claims, and audit the EO operation logic yourself.'))),

    React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 12, marginBottom: 16 } },
      [
        { icon: 'lock', color: 'green', title: 'End-to-End Encrypted', desc: 'All data in Matrix rooms is encrypted. Only participants with session keys can decrypt.' },
        { icon: 'shield', color: 'teal', title: 'You Own Your Rooms', desc: 'When you claim a room, you become superadmin (power level 100). You can kick anyone — including providers.' },
        { icon: 'eye', color: 'blue', title: 'Full Transparency', desc: 'This page lets you read the actual running source code. The code IS the documentation.' },
        { icon: 'users', color: 'gold', title: 'Explicit Consent', desc: 'Data only flows where you allow it. Every bridge share is opt-in. Metrics require consent.' },
      ].map((card, i) => React.createElement('div', { key: i, className: 'card', style: { display: 'flex', gap: 10, alignItems: 'flex-start' } },
        React.createElement('div', { style: { width: 30, height: 30, borderRadius: 'var(--r)', background: `var(--${card.color}-dim)`, display: 'flex', alignItems: 'center', justifyContent: 'center', color: `var(--${card.color})`, flexShrink: 0 } },
          React.createElement(I, { n: card.icon, s: 15 })),
        React.createElement('div', null,
          React.createElement('div', { style: { fontSize: 13, fontWeight: 700, marginBottom: 3 } }, card.title),
          React.createElement('div', { style: { fontSize: 12, color: 'var(--tx-2)', lineHeight: 1.5 } }, card.desc))))),

    // EO Operators
    React.createElement('div', { className: 'card', style: { marginBottom: 16 } },
      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 14 } },
        React.createElement('span', { className: 'section-label', style: { marginBottom: 0 } }, 'EO OPERATION VOCABULARY'),
        React.createElement('span', { style: { fontSize: 10, color: 'var(--tx-3)', fontFamily: 'var(--mono)' } }, '9 canonical operators × 3 triads')),
      React.createElement('div', { className: 'eo-vocab-grid', style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 8 } },
        eoExplainer.map(op => React.createElement('div', {
          key: op.op,
          style: { padding: '10px 12px', border: '1px solid var(--border-0)', borderRadius: 'var(--r)', background: 'var(--bg-1)' }
        },
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6 } },
            React.createElement('span', { className: 'dt-eo', style: { fontWeight: 700 } }, op.op),
            React.createElement('span', { style: { fontSize: 12, fontWeight: 600 } }, op.name),
            React.createElement('span', { className: `tag tag-${triadColors[op.triad]}`, style: { fontSize: 8, padding: '1px 6px', marginLeft: 'auto' } }, op.triad)),
          React.createElement('p', { style: { fontSize: 11.5, color: 'var(--tx-2)', lineHeight: 1.5 } }, op.desc))))));

  // ── Privacy Tab ──
  const renderPrivacy = () => React.createElement('div', { className: 'anim-up' },
    // Access Matrix
    React.createElement('div', { className: 'card', style: { marginBottom: 16 } },
      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 14 } },
        React.createElement(I, { n: 'lock', s: 16, c: 'var(--green)' }),
        React.createElement('h3', { style: { fontSize: 15, fontWeight: 700 } }, 'Access Matrix'),
        React.createElement('span', { style: { fontSize: 11, color: 'var(--tx-2)', marginLeft: 'auto', fontFamily: 'var(--mono)' } }, 'who can see what')),
      React.createElement('div', { style: { overflowX: 'auto' } },
        React.createElement('table', { style: { width: '100%', borderCollapse: 'collapse', fontSize: 12 } },
          React.createElement('thead', null,
            React.createElement('tr', { style: { borderBottom: '2px solid var(--border-1)' } },
              React.createElement('th', { style: { padding: '8px 10px', textAlign: 'left', fontWeight: 600, color: 'var(--tx-1)' } }, 'Data'),
              ['You', 'Provider', 'Org', 'Network', 'Server'].map(h =>
                React.createElement('th', { key: h, style: { padding: '8px 6px', textAlign: 'center', fontWeight: 600, color: 'var(--tx-2)', fontSize: 11 } }, h)))),
          React.createElement('tbody', null,
            accessMatrix.map((row, i) => React.createElement(React.Fragment, { key: i },
              React.createElement('tr', {
                style: { borderBottom: '1px solid var(--border-0)', cursor: 'pointer', transition: 'background .15s' },
                onClick: () => toggleCard('access-' + i),
                onMouseEnter: e => e.currentTarget.style.background = 'var(--bg-3)',
                onMouseLeave: e => e.currentTarget.style.background = 'transparent'
              },
                React.createElement('td', { style: { padding: '10px 10px', fontWeight: 500, display: 'flex', alignItems: 'center', gap: 6 } },
                  React.createElement(I, { n: expandedCards['access-' + i] ? 'chevronDown' : 'chevR', s: 10 }),
                  row.entity),
                [row.you, row.provider, row.org, row.network, row.server].map((v, j) =>
                  React.createElement('td', { key: j, style: { padding: '10px 6px', textAlign: 'center' } },
                    React.createElement(AccessDot, { yes: v })))),
              expandedCards['access-' + i] && React.createElement('tr', null,
                React.createElement('td', { colSpan: 6, style: { padding: '8px 10px 12px 28px', fontSize: 12, color: 'var(--tx-2)', lineHeight: 1.6, background: 'var(--bg-1)', borderBottom: '1px solid var(--border-0)' } }, row.detail))))))),

    // Data Flow
    React.createElement('div', { className: 'card', style: { marginBottom: 16 } },
      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 14 } },
        React.createElement(I, { n: 'layers', s: 16, c: 'var(--blue)' }),
        React.createElement('h3', { style: { fontSize: 15, fontWeight: 700 } }, 'Data Flow'),
        React.createElement('span', { style: { fontSize: 11, color: 'var(--tx-2)', marginLeft: 'auto', fontFamily: 'var(--mono)' } }, 'how data moves through the system')),
      dataFlows.map((flow, i) => React.createElement('div', {
        key: i,
        style: { display: 'flex', alignItems: 'flex-start', gap: 12, padding: '10px 0', borderBottom: i < dataFlows.length - 1 ? '1px solid var(--border-0)' : 'none' }
      },
        React.createElement('div', { style: { width: 28, height: 28, borderRadius: 'var(--r)', background: 'var(--bg-3)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--tx-1)', flexShrink: 0, marginTop: 2 } },
          React.createElement(I, { n: flow.icon, s: 13 })),
        React.createElement('div', null,
          React.createElement('div', { style: { fontSize: 12.5, fontWeight: 600, marginBottom: 2 } },
            React.createElement('span', { style: { color: 'var(--teal)' } }, flow.from),
            React.createElement('span', { style: { color: 'var(--tx-3)', margin: '0 6px' } }, '→'),
            React.createElement('span', { style: { color: 'var(--gold)' } }, flow.to)),
          React.createElement('p', { style: { fontSize: 12, color: 'var(--tx-2)', lineHeight: 1.5 } }, flow.description))))),

    // Key Guarantees
    React.createElement('div', { className: 'card' },
      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 14 } },
        React.createElement(I, { n: 'shieldCheck', s: 16, c: 'var(--teal)' }),
        React.createElement('h3', { style: { fontSize: 15, fontWeight: 700 } }, 'Key Privacy Guarantees')),
      [
        { title: 'No hidden data collection', desc: 'There is no analytics, no telemetry, no tracking pixels, no third-party scripts that phone home. The only network calls are to Matrix homeservers you choose.' },
        { title: 'Encryption at rest', desc: 'Matrix rooms use end-to-end encryption. The homeserver stores encrypted blobs. Decryption keys never leave your device.' },
        { title: 'Sovereignty by default', desc: 'When you claim a room, you get power level 100 (superadmin). You can kick anyone — including the provider who created the room. Ownership cannot be revoked.' },
        { title: 'Consent-gated sharing', desc: 'Every bridge share is opt-in. Metrics aggregation requires explicit consent. You can revoke field sharing at any time from your vault.' },
        { title: 'Auditable operations', desc: 'Every state change emits an EO operation with a provenance chain linking it to the previous operation on that entity. The full history is inspectable.' },
        { title: 'K-anonymity for metrics', desc: 'Aggregate metrics use k-anonymity (k=5). Any demographic combination with fewer than 5 matching individuals is suppressed. PII fields are never included.' },
        { title: 'Open protocol, no lock-in', desc: 'Built on Matrix (open federated protocol). You can run your own homeserver, migrate to a different client, or export your data at any time.' },
      ].map((g, i) => React.createElement('div', {
        key: i, style: { padding: '10px 0', borderBottom: i < 6 ? '1px solid var(--border-0)' : 'none', display: 'flex', gap: 10, alignItems: 'flex-start' }
      },
        React.createElement('div', { style: { color: 'var(--green)', flexShrink: 0, marginTop: 2 } },
          React.createElement(I, { n: 'check', s: 14 })),
        React.createElement('div', null,
          React.createElement('div', { style: { fontSize: 13, fontWeight: 600, marginBottom: 2 } }, g.title),
          React.createElement('div', { style: { fontSize: 12, color: 'var(--tx-2)', lineHeight: 1.5 } }, g.desc)))))));

  // ── Source Code Tab ──
  const opBadgeColors = { NUL: 'var(--red, #e74c3c)', DES: 'var(--green)', INS: 'var(--teal)', SEG: 'var(--blue)', CON: 'var(--gold)', SYN: 'var(--purple, #9b59b6)', ALT: 'var(--gold)', SUP: 'var(--purple, #9b59b6)', REC: 'var(--red, #e74c3c)' };
  const triadForOp = { NUL: 'Existence', DES: 'Existence', INS: 'Existence', SEG: 'Structure', CON: 'Structure', SYN: 'Structure', ALT: 'Interpretation', SUP: 'Interpretation', REC: 'Interpretation' };

  // Build EO cross-reference: operator → sections that use it
  const eoXref = useMemo(() => {
    const xref = {};
    OPERATORS.forEach(op => { xref[op] = []; });
    eoSections.forEach(sec => {
      const ops = new Set((sec.operators || []).map(o => o.op));
      (sec.emitOpCalls || []).forEach(c => ops.add(c.op));
      ops.forEach(op => { if (xref[op]) xref[op].push(sec); });
    });
    return xref;
  }, [eoSections]);

  // Section info panel (above code, shows manifest + definitions + emitOp calls)
  const renderSectionInfo = (sec) => {
    if (!sec) return null;
    const hasManifest = sec.operators && sec.operators.length > 0;
    const hasDefs = sec.definitions && sec.definitions.length > 0;
    const hasEmitOps = sec.emitOpCalls && sec.emitOpCalls.length > 0;
    const hasTriad = sec.triad && Object.keys(sec.triad).length > 0;
    if (!hasManifest && !hasDefs && !hasEmitOps) return null;

    return React.createElement('div', { style: { borderBottom: '1px solid var(--border-0)', background: 'var(--bg-2)', maxHeight: 280, overflow: 'auto' } },
      // Operator Manifest
      hasManifest && React.createElement('div', { style: { padding: '8px 16px', borderBottom: '1px solid var(--border-0)' } },
        React.createElement('div', { style: { fontSize: 9, fontWeight: 700, color: 'var(--tx-3)', letterSpacing: '0.05em', marginBottom: 6 } }, 'OPERATOR MANIFEST'),
        sec.operators.map((o, i) => React.createElement('div', { key: i, style: { display: 'flex', alignItems: 'center', gap: 6, padding: '2px 0', fontSize: 11, fontFamily: 'var(--mono)' } },
          React.createElement('span', { style: { display: 'inline-block', padding: '1px 5px', borderRadius: 3, fontSize: 9, fontWeight: 700, color: '#fff', background: opBadgeColors[o.op] || 'var(--tx-3)', minWidth: 28, textAlign: 'center' } }, o.op),
          React.createElement('span', { style: { color: 'var(--tx-1)' } }, o.target),
          React.createElement('span', { style: { color: 'var(--tx-3)', fontSize: 10 } }, '— ' + o.desc)))),
      // Triad Summary
      hasTriad && React.createElement('div', { style: { padding: '6px 16px', borderBottom: '1px solid var(--border-0)', display: 'flex', gap: 12, flexWrap: 'wrap' } },
        Object.entries(sec.triad).map(([triad, detail]) => React.createElement('div', { key: triad, style: { fontSize: 10, display: 'flex', alignItems: 'center', gap: 4 } },
          React.createElement('span', { className: `tag tag-${triadColors[triad]}`, style: { fontSize: 8, padding: '1px 5px' } }, triad),
          React.createElement('span', { style: { color: 'var(--tx-2)', fontFamily: 'var(--mono)' } }, detail)))),
      // Definitions index + emitOp calls side by side
      (hasDefs || hasEmitOps) && React.createElement('div', { style: { display: 'flex', gap: 0 } },
        // Definitions
        hasDefs && React.createElement('div', { style: { flex: 1, padding: '6px 16px', borderRight: hasEmitOps ? '1px solid var(--border-0)' : 'none' } },
          React.createElement('div', { style: { fontSize: 9, fontWeight: 700, color: 'var(--tx-3)', letterSpacing: '0.05em', marginBottom: 4 } },
            'DEFINITIONS (' + sec.definitions.length + ')'),
          React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: 3 } },
            sec.definitions.slice(0, 20).map((d, i) => React.createElement('span', {
              key: i,
              onClick: () => scrollToLine(d.line),
              style: { fontSize: 10, fontFamily: 'var(--mono)', padding: '2px 6px', borderRadius: 3, background: 'var(--bg-3)', color: d.type === 'function' ? 'var(--blue)' : 'var(--teal)', cursor: 'pointer', whiteSpace: 'nowrap' },
              title: d.type + ' at line ' + d.line
            }, d.name)))),
        // emitOp calls
        hasEmitOps && React.createElement('div', { style: { flex: 1, padding: '6px 16px' } },
          React.createElement('div', { style: { fontSize: 9, fontWeight: 700, color: 'var(--tx-3)', letterSpacing: '0.05em', marginBottom: 4 } },
            'EO CALLS (' + sec.emitOpCalls.length + ')'),
          React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: 3 } },
            sec.emitOpCalls.slice(0, 20).map((c, i) => React.createElement('span', {
              key: i,
              onClick: () => scrollToLine(c.line),
              style: { fontSize: 10, fontFamily: 'var(--mono)', padding: '2px 6px', borderRadius: 3, background: 'var(--bg-3)', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 3 }
            },
              React.createElement('span', { style: { color: opBadgeColors[c.op], fontWeight: 700 } }, c.op),
              React.createElement('span', { style: { color: 'var(--tx-2)' } }, c.target.split(', ').slice(0, 2).join('.'))))))));
  };

  // EO Map: cross-reference view showing how operators map to sections
  const renderEoMap = () => React.createElement('div', { style: { padding: 16, overflow: 'auto', flex: 1 } },
    React.createElement('div', { style: { fontSize: 13, fontWeight: 700, marginBottom: 4 } }, 'EO Operator → Section Map'),
    React.createElement('p', { style: { fontSize: 11, color: 'var(--tx-2)', marginBottom: 14, lineHeight: 1.5 } },
      'Shows which sections declare or invoke each EO operator. Click a section to navigate to its code.'),
    // Triads
    ['Existence', 'Structure', 'Interpretation'].map(triad => React.createElement('div', { key: triad, style: { marginBottom: 16 } },
      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 6, marginBottom: 8 } },
        React.createElement('span', { className: `tag tag-${triadColors[triad]}`, style: { fontSize: 9, padding: '2px 8px' } }, triad)),
      OPERATORS.filter(op => triadForOp[op] === triad).map(op => React.createElement('div', { key: op, style: { marginBottom: 10, paddingLeft: 8 } },
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 6, marginBottom: 4 } },
          React.createElement('span', { style: { display: 'inline-block', padding: '2px 6px', borderRadius: 3, fontSize: 10, fontWeight: 700, color: '#fff', background: opBadgeColors[op], minWidth: 32, textAlign: 'center' } }, op),
          React.createElement('span', { style: { fontSize: 11, fontWeight: 600, color: 'var(--tx-1)' } },
            eoExplainer.find(e => e.op === op)?.name || ''),
          React.createElement('span', { style: { fontSize: 10, color: 'var(--tx-3)', marginLeft: 4 } },
            (eoXref[op] || []).length + ' section' + ((eoXref[op] || []).length !== 1 ? 's' : ''))),
        React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: 4, paddingLeft: 4 } },
          (eoXref[op] || []).map((sec, i) => React.createElement('span', {
            key: i,
            onClick: () => { setActiveSection(sec); setSourceView('code'); },
            style: { fontSize: 10, fontFamily: 'var(--mono)', padding: '3px 8px', borderRadius: 4, background: 'var(--bg-3)', color: 'var(--tx-1)', cursor: 'pointer', border: '1px solid var(--border-0)', whiteSpace: 'nowrap' },
            onMouseEnter: e => { e.currentTarget.style.background = 'var(--bg-4)'; },
            onMouseLeave: e => { e.currentTarget.style.background = 'var(--bg-3)'; }
          }, sec.name))))))));

  const renderSource = () => React.createElement('div', { className: 'anim-up', style: { display: 'flex', gap: 0, border: '1px solid var(--border-0)', borderRadius: 'var(--r-lg)', overflow: 'hidden', height: 'calc(100vh - 220px)', minHeight: 500 } },
    // Section navigator sidebar (enhanced with operator badges)
    React.createElement('div', { style: { width: 280, minWidth: 280, background: 'var(--bg-2)', borderRight: '1px solid var(--border-0)', display: 'flex', flexDirection: 'column' } },
      React.createElement('div', { style: { padding: '12px 10px', borderBottom: '1px solid var(--border-0)' } },
        React.createElement('input', {
          type: 'text', placeholder: 'Search sections…',
          value: searchQuery, onChange: e => setSearchQuery(e.target.value),
          style: { fontSize: 12, padding: '7px 10px' }
        })),
      React.createElement('div', { style: { padding: '6px 10px', fontSize: 10, color: 'var(--tx-3)', fontFamily: 'var(--mono)', textAlign: 'center', borderBottom: '1px solid var(--border-0)', display: 'flex', justifyContent: 'center', gap: 8 } },
        React.createElement('span', null, filteredSections.length + ' sections'),
        React.createElement('span', null, '·'),
        React.createElement('span', null, eoSections.reduce((n, s) => n + (s.emitOpCalls?.length || 0), 0) + ' EO calls')),
      React.createElement('div', { style: { flex: 1, overflow: 'auto', padding: '4px 0' } },
        filteredSections.map((sec, i) => React.createElement('div', {
          key: i,
          onClick: () => { setActiveSection(sec); setSourceView('code'); },
          style: {
            padding: '7px 10px', cursor: 'pointer', fontSize: 11,
            background: activeSection?.line === sec.line ? 'var(--bg-4)' : 'transparent',
            borderLeft: activeSection?.line === sec.line ? '2px solid var(--gold)' : '2px solid transparent',
            color: activeSection?.line === sec.line ? 'var(--tx-0)' : 'var(--tx-2)',
            transition: 'all .12s', lineHeight: 1.4
          },
          onMouseEnter: e => { if (activeSection?.line !== sec.line) e.currentTarget.style.background = 'var(--bg-3)'; },
          onMouseLeave: e => { if (activeSection?.line !== sec.line) e.currentTarget.style.background = 'transparent'; }
        },
          React.createElement('div', { style: { fontWeight: activeSection?.line === sec.line ? 600 : 400, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', fontFamily: 'var(--mono)', fontSize: 10.5 } }, sec.name),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 4, marginTop: 3 } },
            React.createElement('span', { style: { fontSize: 9, color: 'var(--tx-3)', fontFamily: 'var(--mono)' } }, 'L' + sec.line),
            (sec.allOps && sec.allOps.length > 0) && React.createElement('span', { style: { display: 'flex', gap: 2, marginLeft: 4 } },
              sec.allOps.slice(0, 5).map((op, j) => React.createElement('span', {
                key: j,
                style: { fontSize: 7, padding: '0px 3px', borderRadius: 2, fontWeight: 700, color: '#fff', background: opBadgeColors[op] || 'var(--tx-3)', lineHeight: '14px' }
              }, op))),
            sec.definitions && sec.definitions.length > 0 && React.createElement('span', { style: { fontSize: 9, color: 'var(--tx-3)', marginLeft: 'auto', fontFamily: 'var(--mono)' } },
              sec.definitions.length + ' fn')))))),
    // Main content area
    React.createElement('div', { style: { flex: 1, display: 'flex', flexDirection: 'column', background: 'var(--bg-1)', minWidth: 0 } },
      // Header with view toggle
      React.createElement('div', { style: { padding: '8px 16px', borderBottom: '1px solid var(--border-0)', display: 'flex', alignItems: 'center', gap: 8, background: 'var(--bg-2)' } },
        React.createElement(I, { n: 'eye', s: 14, c: 'var(--gold)' }),
        React.createElement('span', { style: { fontSize: 13, fontWeight: 600 } }, activeSection?.name || 'Source Code'),
        // View toggle buttons
        React.createElement('div', { style: { display: 'flex', gap: 2, marginLeft: 'auto', background: 'var(--bg-3)', borderRadius: 'var(--r)', padding: 2 } },
          [{ id: 'code', label: 'Code' }, { id: 'eomap', label: 'EO Map' }].map(v => React.createElement('button', {
            key: v.id,
            onClick: () => setSourceView(v.id),
            style: { fontSize: 10, padding: '3px 10px', borderRadius: 3, border: 'none', cursor: 'pointer', fontWeight: sourceView === v.id ? 700 : 400, background: sourceView === v.id ? 'var(--bg-1)' : 'transparent', color: sourceView === v.id ? 'var(--tx-0)' : 'var(--tx-3)', transition: 'all .12s' }
          }, v.label))),
        React.createElement('span', { style: { fontSize: 9, color: 'var(--tx-3)', fontFamily: 'var(--mono)', background: 'var(--bg-3)', padding: '2px 6px', borderRadius: 'var(--r)' } }, 'LIVE · READ-ONLY')),
      // Section info panel (manifests, definitions, emitOp calls)
      sourceView === 'code' && renderSectionInfo(activeSection),
      // EO Map view
      sourceView === 'eomap' && renderEoMap(),
      // Code viewer with EO highlighting
      sourceView === 'code' && React.createElement('pre', {
        ref: codeRef,
        style: { flex: 1, overflow: 'auto', padding: '12px 0', margin: 0, fontFamily: 'var(--mono)', fontSize: 11.5, lineHeight: 1.6, color: 'var(--tx-1)', whiteSpace: 'pre', tabSize: 2 }
      },
        (activeSection ? getSectionCode(activeSection) : sourceCode.slice(0, 5000)).split('\n').map((line, i) => {
          const lineNum = activeSection ? activeSection.line + i : i + 1;
          const isEmitOp = line.includes('emitOp(');
          const isComment = line.trim().startsWith('/*') || line.trim().startsWith('*') || line.trim().startsWith('//');
          const isDef = line.match(/^(?:async\s+)?function\s+/) || line.match(/^const\s+\w+\s*=/);
          const isSectionHeader = line.includes('═══');
          return React.createElement('div', {
            key: i,
            style: {
              display: 'flex', paddingRight: 16, minHeight: 20,
              background: isEmitOp ? 'rgba(243, 156, 18, 0.06)' : isSectionHeader ? 'rgba(52, 152, 219, 0.04)' : 'transparent'
            }
          },
            React.createElement('span', { style: { width: 52, textAlign: 'right', paddingRight: 12, color: isEmitOp ? 'var(--gold)' : 'var(--tx-3)', userSelect: 'none', flexShrink: 0, fontSize: 10, fontWeight: isEmitOp ? 700 : 400 } }, lineNum),
            isEmitOp ? React.createElement('span', { style: { flex: 1, paddingLeft: 4 } },
              (() => {
                const parts = line.split(/(emitOp\([^,]+,\s*'(?:NUL|DES|INS|SEG|CON|SYN|ALT|SUP|REC)')/);
                return parts.map((part, pi) => {
                  const m = part.match(/emitOp\([^,]+,\s*'(NUL|DES|INS|SEG|CON|SYN|ALT|SUP|REC)'/);
                  if (m) return React.createElement('span', { key: pi },
                    React.createElement('span', { style: { color: 'var(--gold)', fontWeight: 600 } }, 'emitOp'),
                    React.createElement('span', { style: { color: 'var(--tx-1)' } }, part.slice(6, part.indexOf("'" + m[1] + "'"))),
                    React.createElement('span', { style: { display: 'inline-block', padding: '0 4px', borderRadius: 2, fontSize: 10, fontWeight: 700, color: '#fff', background: opBadgeColors[m[1]], margin: '0 1px' } }, m[1]),
                    React.createElement('span', { style: { color: 'var(--tx-1)' } }, "'"));
                  return React.createElement('span', { key: pi, style: { color: 'var(--tx-1)' } }, part);
                });
              })()
            ) : React.createElement('span', { style: {
              flex: 1, paddingLeft: 4,
              color: isComment ? 'var(--tx-3)' :
                     isSectionHeader ? 'var(--blue)' :
                     isDef ? 'var(--blue)' :
                     line.includes("'NUL'") || line.includes("'DES'") || line.includes("'INS'") || line.includes("'SEG'") || line.includes("'CON'") || line.includes("'SYN'") || line.includes("'ALT'") || line.includes("'SUP'") || line.includes("'REC'") ? 'var(--gold)' :
                     line.match(/['"`]/) ? 'var(--green)' : 'var(--tx-1)',
              fontWeight: isDef ? 600 : isSectionHeader ? 700 : 400
            } }, line || ' '));
        }))));

  // ── Architecture Tab ──
  const ARCH_NODES = [
    {
      id: 'vault', label: 'Your Vault', desc: 'Personal encrypted Matrix room that stores all your data. Only you hold the keys.',
      color: '#3ecf8e', dimColor: 'rgba(62,207,142,.15)', icon: 'lock',
      children: [
        { id: 'vault-fields', label: 'Vault Fields', desc: 'Encrypted personal data fields — name, DOB, identifiers, custom fields. Stored as Matrix state events.', color: '#3ecf8e', dimColor: 'rgba(62,207,142,.15)' },
        { id: 'vault-consent', label: 'Consent Settings', desc: 'Per-field consent flags controlling which data can be shared with providers via bridges.', color: '#3ecf8e', dimColor: 'rgba(62,207,142,.15)' },
        { id: 'vault-schemas', label: 'Field Schemas', desc: 'Schema definitions that describe the structure and validation rules for vault data fields.', color: '#3ecf8e', dimColor: 'rgba(62,207,142,.15)' },
        { id: 'vault-oplog', label: 'Operation Log', desc: 'Chronological log of every EO operation performed on vault data — fully auditable.', color: '#3ecf8e', dimColor: 'rgba(62,207,142,.15)' }
      ],
      childEdges: [
        { from: 0, to: 1, label: 'gates sharing' },
        { from: 2, to: 0, label: 'validates' },
        { from: 3, to: 0, label: 'records changes' }
      ]
    },
    {
      id: 'bridge', label: 'Bridge Room', desc: 'Shared encrypted room between you and a provider. Data only flows here with explicit consent.',
      color: '#5bc0be', dimColor: 'rgba(91,192,190,.15)', icon: 'link',
      children: [
        { id: 'bridge-fields', label: 'Shared Fields', desc: 'Vault fields you have explicitly consented to share with this provider.', color: '#5bc0be', dimColor: 'rgba(91,192,190,.15)' },
        { id: 'bridge-obs', label: 'Observations', desc: 'Clinical or service observations recorded by the provider about this case.', color: '#5bc0be', dimColor: 'rgba(91,192,190,.15)' },
        { id: 'bridge-msgs', label: 'Messages', desc: 'End-to-end encrypted messages between you and the provider within this bridge.', color: '#5bc0be', dimColor: 'rgba(91,192,190,.15)' },
        { id: 'bridge-settings', label: 'Bridge Settings', desc: 'Configuration for the bridge — consent state, power levels, room permissions.', color: '#5bc0be', dimColor: 'rgba(91,192,190,.15)' }
      ],
      childEdges: [
        { from: 0, to: 1, label: 'context for' },
        { from: 0, to: 2, label: 'referenced in' },
        { from: 3, to: 0, label: 'controls access' }
      ]
    },
    {
      id: 'provider', label: 'Provider', desc: 'Provider dashboard for managing cases, recording observations, and coordinating care.',
      color: '#5b9cf5', dimColor: 'rgba(91,156,245,.15)', icon: 'briefcase',
      children: [
        { id: 'prov-cases', label: 'Cases', desc: 'Active cases the provider manages — each linked to a bridge room with a client.', color: '#5b9cf5', dimColor: 'rgba(91,156,245,.15)' },
        { id: 'prov-individuals', label: 'Individuals', desc: 'Client profiles visible to the provider, built from consented shared data.', color: '#5b9cf5', dimColor: 'rgba(91,156,245,.15)' },
        { id: 'prov-resources', label: 'Resources', desc: 'Services, programs, and referral resources the provider can allocate to cases.', color: '#5b9cf5', dimColor: 'rgba(91,156,245,.15)' },
        { id: 'prov-metrics', label: 'Metrics', desc: 'Outcome and activity metrics tracked per case and per provider.', color: '#5b9cf5', dimColor: 'rgba(91,156,245,.15)' }
      ],
      childEdges: [
        { from: 0, to: 1, label: 'linked to' },
        { from: 2, to: 0, label: 'allocated to' },
        { from: 3, to: 0, label: 'measured from' }
      ]
    },
    {
      id: 'org', label: 'Organization', desc: 'Org-level coordination — teams, internal channels, schema management, and aggregated metrics.',
      color: '#e5a550', dimColor: 'rgba(229,165,80,.15)', icon: 'briefcase',
      children: [
        { id: 'org-teams', label: 'Teams', desc: 'Provider teams within the organization, with role-based access control.', color: '#e5a550', dimColor: 'rgba(229,165,80,.15)' },
        { id: 'org-channels', label: 'Channels', desc: 'Internal encrypted communication channels for org-wide coordination.', color: '#e5a550', dimColor: 'rgba(229,165,80,.15)' },
        { id: 'org-schema', label: 'Schema Registry', desc: 'Shared field schemas and observation templates used across the organization.', color: '#e5a550', dimColor: 'rgba(229,165,80,.15)' },
        { id: 'org-settings', label: 'Org Settings', desc: 'Organization configuration — branding, consent policies, governance rules.', color: '#e5a550', dimColor: 'rgba(229,165,80,.15)' }
      ],
      childEdges: [
        { from: 0, to: 1, label: 'communicate via' },
        { from: 2, to: 0, label: 'shared across' },
        { from: 3, to: 2, label: 'governs' }
      ]
    },
    {
      id: 'network', label: 'Network', desc: 'Cross-organization discovery and schema sharing. Enables interoperability between orgs.',
      color: '#b090d4', dimColor: 'rgba(176,144,212,.15)', icon: 'users',
      children: [
        { id: 'net-discovery', label: 'Discovery', desc: 'Find other organizations and their published service catalogs.', color: '#b090d4', dimColor: 'rgba(176,144,212,.15)' },
        { id: 'net-schemas', label: 'Schema Sharing', desc: 'Cross-org schema federation — publish and subscribe to field definitions.', color: '#b090d4', dimColor: 'rgba(176,144,212,.15)' },
        { id: 'net-resources', label: 'Resource Catalog', desc: 'Network-wide directory of available services and resources.', color: '#b090d4', dimColor: 'rgba(176,144,212,.15)' }
      ],
      childEdges: [
        { from: 0, to: 2, label: 'finds' },
        { from: 1, to: 0, label: 'enables' }
      ]
    },
    {
      id: 'matrix', label: 'Matrix Protocol', desc: 'The underlying open federation protocol. All rooms, events, and encryption happen here.',
      color: '#6b7385', dimColor: 'rgba(107,115,133,.15)', icon: 'layers',
      children: [
        { id: 'mx-rooms', label: 'Rooms', desc: 'Matrix rooms are the containers for all data — vaults, bridges, channels are all rooms.', color: '#6b7385', dimColor: 'rgba(107,115,133,.15)' },
        { id: 'mx-events', label: 'Events', desc: 'State events and timeline events — every data change is a Matrix event.', color: '#6b7385', dimColor: 'rgba(107,115,133,.15)' },
        { id: 'mx-e2ee', label: 'E2E Encryption', desc: 'Olm/Megolm encryption ensures only room members with session keys can read data.', color: '#6b7385', dimColor: 'rgba(107,115,133,.15)' },
        { id: 'mx-federation', label: 'Federation', desc: 'Homeservers federate — data is replicated but encrypted. No single point of control.', color: '#6b7385', dimColor: 'rgba(107,115,133,.15)' }
      ],
      childEdges: [
        { from: 0, to: 1, label: 'contain' },
        { from: 2, to: 1, label: 'encrypts' },
        { from: 3, to: 0, label: 'replicates' }
      ]
    },
    {
      id: 'eo', label: 'EO Layer', desc: 'Epistemic Operations — 9 canonical operators that track every state change with formal semantics.',
      color: '#e06c75', dimColor: 'rgba(224,108,117,.15)', icon: 'shield',
      children: [
        { id: 'eo-nul', label: '\u2205 NUL', desc: 'Null / Destroy — absence, void, revocation. When data or access is removed.', color: '#e06c75', dimColor: 'rgba(224,108,117,.15)', sublabel: 'Existence' },
        { id: 'eo-des', label: '\u225d DES', desc: 'Designate — names or classifies an entity. Sets the frame for what something IS.', color: '#3ecf8e', dimColor: 'rgba(62,207,142,.15)', sublabel: 'Existence' },
        { id: 'eo-ins', label: '\u25b3 INS', desc: 'Instantiate — creates a new entity with a value. The moment data comes into being.', color: '#5bc0be', dimColor: 'rgba(91,192,190,.15)', sublabel: 'Existence' },
        { id: 'eo-seg', label: '\u22a2 SEG', desc: 'Segment — partitions data into structural segments. Creates boundaries between groups.', color: '#5b9cf5', dimColor: 'rgba(91,156,245,.15)', sublabel: 'Structure' },
        { id: 'eo-con', label: '\u22c8 CON', desc: 'Connect — links entities together. Provenance chains, allocations, bridges.', color: '#e5a550', dimColor: 'rgba(229,165,80,.15)', sublabel: 'Structure' },
        { id: 'eo-syn', label: '\u2228 SYN', desc: 'Synthesize — merges multiple sources into a unified view. Parallel hydration.', color: '#b090d4', dimColor: 'rgba(176,144,212,.15)', sublabel: 'Structure' },
        { id: 'eo-alt', label: '\u223f ALT', desc: 'Alter — changes a value within an existing frame. Status transitions, field updates.', color: '#e5a550', dimColor: 'rgba(229,165,80,.15)', sublabel: 'Interpretation' },
        { id: 'eo-sup', label: '\u29a6 SUP', desc: 'Superpose — holds multiple valid values simultaneously. Competing interpretations.', color: '#b090d4', dimColor: 'rgba(176,144,212,.15)', sublabel: 'Interpretation' },
        { id: 'eo-rec', label: '\u21bb REC', desc: 'Reconcile — resolves superposition into a single value. The final judgment.', color: '#e06c75', dimColor: 'rgba(224,108,117,.15)', sublabel: 'Interpretation' }
      ],
      childEdges: [
        { from: 0, to: 1, label: 'precedes' },
        { from: 1, to: 2, label: 'precedes' },
        { from: 3, to: 4, label: 'precedes' },
        { from: 4, to: 5, label: 'precedes' },
        { from: 6, to: 7, label: 'precedes' },
        { from: 7, to: 8, label: 'resolves' }
      ]
    }
  ];

  const ARCH_EDGES = [
    { from: 0, to: 1, label: 'opt-in sharing' },
    { from: 1, to: 2, label: 'shared observations' },
    { from: 2, to: 3, label: 'anonymized metrics' },
    { from: 3, to: 4, label: 'schema sharing' },
    { from: 5, to: 0, label: 'encrypted sync' },
    { from: 5, to: 1, label: 'encrypted sync', dashed: true },
    { from: 6, to: 0, label: 'tracks changes', dashed: true },
    { from: 6, to: 1, label: 'tracks changes', dashed: true }
  ];

  // Map sub-components to source code sections for Level 2 drill-down
  const SECTION_MAP = {
    'vault-fields': ['VAULT', 'FIELD', 'CLAIM'],
    'vault-consent': ['CONSENT', 'BRIDGE'],
    'vault-schemas': ['SCHEMA', 'FIELD'],
    'vault-oplog': ['EO FRAMEWORK', 'OPERATION'],
    'bridge-fields': ['BRIDGE', 'FIELD'],
    'bridge-obs': ['OBSERVATION'],
    'bridge-msgs': ['BRIDGE', 'MESSAGE', 'INBOX'],
    'bridge-settings': ['BRIDGE', 'CONSENT'],
    'prov-cases': ['CASE', 'PROVIDER'],
    'prov-individuals': ['INDIVIDUAL', 'CLIENT'],
    'prov-metrics': ['METRIC', 'DASHBOARD'],
    'prov-resources': ['RESOURCE'],
    'org-teams': ['TEAM'],
    'org-channels': ['CHANNEL', 'ORG'],
    'org-schema': ['SCHEMA', 'REGISTRY'],
    'org-settings': ['ORG', 'SETTINGS'],
    'net-discovery': ['NETWORK', 'DISCOVER'],
    'net-schemas': ['SCHEMA', 'NETWORK'],
    'net-resources': ['RESOURCE', 'CATALOG'],
    'mx-rooms': ['MATRIX', 'ROOM'],
    'mx-events': ['EVENT', 'STATE'],
    'mx-e2ee': ['ENCRYPT', 'CRYPTO'],
    'mx-federation': ['FEDERATION', 'HOMESERVER'],
    'eo-nul': ['NUL'], 'eo-des': ['DES'], 'eo-ins': ['INS'],
    'eo-seg': ['SEG'], 'eo-con': ['CON'], 'eo-syn': ['SYN'],
    'eo-alt': ['ALT'], 'eo-sup': ['SUP'], 'eo-rec': ['REC']
  };

  const getArchNodes = () => {
    if (archLevel === 0) {
      return ARCH_NODES.map(n => ({
        id: n.id, label: n.label, desc: n.desc, color: n.color, dimColor: n.dimColor,
        childCount: n.children.length, sublabel: n.children.length + ' components', type: 'system'
      }));
    }
    if (archLevel === 1) {
      const parent = ARCH_NODES.find(n => n.id === archPath[0]?.id);
      if (!parent) return [];
      return parent.children.map(c => ({
        id: c.id, label: c.label, desc: c.desc, color: c.color, dimColor: c.dimColor,
        sublabel: c.sublabel || '', type: 'component',
        childCount: (SECTION_MAP[c.id] || []).length > 0 ? 1 : 0
      }));
    }
    if (archLevel === 2) {
      const parentNode = ARCH_NODES.find(n => n.id === archPath[0]?.id);
      const child = parentNode?.children.find(c => c.id === archPath[1]?.id);
      if (!child) return [];
      const keywords = SECTION_MAP[child.id] || [];
      const matched = eoSections.filter(s => keywords.some(k => s.name.toUpperCase().includes(k)));
      if (matched.length === 0) return [];
      return matched.map((s, i) => ({
        id: 'sec-' + i, label: s.name.length > 28 ? s.name.slice(0, 26) + '\u2026' : s.name,
        fullLabel: s.name,
        desc: 'Line ' + s.line + ' \xb7 ' + s.definitions.length + ' definitions \xb7 ' + s.allOps.length + ' operators',
        color: child.color, dimColor: child.dimColor,
        childCount: 0, sublabel: s.definitions.length + ' funcs',
        allOps: s.allOps, operators: s.operators, definitions: s.definitions, type: 'section'
      }));
    }
    return [];
  };

  const getArchEdges = (nodes) => {
    if (archLevel === 0) return ARCH_EDGES;
    if (archLevel === 1) {
      const parent = ARCH_NODES.find(n => n.id === archPath[0]?.id);
      return parent?.childEdges || [];
    }
    if (archLevel === 2) {
      const edges = [];
      for (let i = 0; i < nodes.length; i++) {
        for (let j = i + 1; j < nodes.length; j++) {
          const shared = (nodes[i].allOps || []).filter(o => (nodes[j].allOps || []).includes(o));
          if (shared.length > 0) edges.push({ from: i, to: j, label: shared.slice(0, 3).join(','), dashed: shared.length === 1 });
        }
      }
      return edges.slice(0, 20);
    }
    return [];
  };

  const archDrillDown = (node) => {
    if (node.type === 'section') { setArchSelected(node); return; }
    if (node.childCount === 0) { setArchSelected(node); return; }
    setArchPath(prev => [...prev, node]);
    setArchLevel(prev => prev + 1);
    setArchSelected(null);
  };

  const archNavigateTo = (depth) => {
    if (depth < 0) { setArchLevel(0); setArchPath([]); setArchSelected(null); }
    else { setArchPath(prev => prev.slice(0, depth + 1)); setArchLevel(depth + 1); setArchSelected(null); }
  };

  const archComputeLayout = (nodes, edges) => {
    const count = nodes.length;
    if (count === 0) return { positions: [], edgePaths: [] };
    const W = 900, H = Math.max(600, Math.ceil(count / 5) * 120 + 200);
    const positions = [];
    if (count <= 3) {
      if (count === 1) positions.push({ x: W / 2, y: H / 2 });
      else if (count === 2) { positions.push({ x: W / 3, y: H / 2 }); positions.push({ x: 2 * W / 3, y: H / 2 }); }
      else { positions.push({ x: W / 2, y: 130 }); positions.push({ x: 180, y: H - 150 }); positions.push({ x: W - 180, y: H - 150 }); }
    } else if (count <= 9) {
      const cols = Math.ceil(Math.sqrt(count));
      const rows = Math.ceil(count / cols);
      const gapX = W / (cols + 1), gapY = H / (rows + 1);
      for (let i = 0; i < count; i++) positions.push({ x: gapX * ((i % cols) + 1), y: gapY * (Math.floor(i / cols) + 1) });
    } else {
      const cols = Math.min(5, count);
      const gapX = W / (cols + 1), gapY = Math.min(110, (H - 60) / (Math.ceil(count / cols) + 1));
      for (let i = 0; i < count; i++) positions.push({ x: gapX * ((i % cols) + 1), y: 80 + gapY * (Math.floor(i / cols) + 1) });
    }
    const edgePaths = edges.map(e => {
      const from = positions[e.from], to = positions[e.to];
      if (!from || !to) return null;
      const dx = to.x - from.x, dy = to.y - from.y;
      const dist = Math.sqrt(dx * dx + dy * dy) || 1;
      const nx = dx / dist, ny = dy / dist;
      const x1 = from.x + nx * 45, y1 = from.y + ny * 35;
      const x2 = to.x - nx * 45, y2 = to.y - ny * 35;
      const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
      const cx = mx - (y2 - y1) * 0.12, cy = my + (x2 - x1) * 0.12;
      return { ...e, path: 'M' + x1 + ',' + y1 + ' Q' + cx + ',' + cy + ' ' + x2 + ',' + y2, x1, y1, x2, y2, cx, cy };
    }).filter(Boolean);
    return { positions, edgePaths };
  };

  const levelLabels = ['System', 'Component', 'Sub-component', 'Source'];

  const renderArchitecture = () => {
    const nodes = getArchNodes();
    const edges = getArchEdges(nodes);
    const { positions, edgePaths } = archComputeLayout(nodes, edges);
    const svgH = Math.max(600, Math.ceil(nodes.length / 5) * 120 + 200);

    return React.createElement('div', { className: 'eo-graph-wrap', style: { height: 'calc(100vh - 220px)', minHeight: 500 } },
      // Header + breadcrumb
      React.createElement('div', { className: 'eo-graph-header' },
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
          React.createElement(I, { n: 'graphNodes', s: 18, c: 'var(--teal)' }),
          React.createElement('h3', { style: { fontSize: 16, fontWeight: 700 } }, 'How Khora Works')),
        React.createElement('div', { style: { flex: 1 } }),
        React.createElement('div', { className: 'eo-graph-breadcrumb' },
          React.createElement('span', { className: 'bc-seg', onClick: () => { setArchLevel(0); setArchPath([]); setArchSelected(null); } }, 'System'),
          archPath.map((p, i) => React.createElement(React.Fragment, { key: i },
            React.createElement('span', { className: 'bc-sep' }, ' \u203a '),
            i < archPath.length - 1
              ? React.createElement('span', { className: 'bc-seg', onClick: () => archNavigateTo(i) }, p.label)
              : React.createElement('span', { className: 'bc-cur' }, p.label)
          ))
        ),
        React.createElement('span', {
          style: { fontSize: 10, color: 'var(--tx-3)', fontFamily: 'var(--mono)', padding: '3px 8px', background: 'var(--bg-3)', borderRadius: 'var(--r)' }
        }, 'L' + archLevel + ' \xb7 ' + (levelLabels[archLevel] || 'Detail'))
      ),
      // SVG canvas
      React.createElement('div', { className: 'eo-graph-canvas' },
        React.createElement('svg', {
          className: 'eo-graph-svg', viewBox: '0 0 900 ' + svgH, preserveAspectRatio: 'xMidYMid meet'
        },
          React.createElement('defs', null,
            React.createElement('marker', { id: 'arch-arrow', markerWidth: '8', markerHeight: '6', refX: '8', refY: '3', orient: 'auto' },
              React.createElement('polygon', { points: '0 0, 8 3, 0 6', className: 'eo-edge-arrow' })),
            React.createElement('filter', { id: 'arch-glow' },
              React.createElement('feGaussianBlur', { stdDeviation: '3', result: 'coloredBlur' }),
              React.createElement('feMerge', null,
                React.createElement('feMergeNode', { in: 'coloredBlur' }),
                React.createElement('feMergeNode', { in: 'SourceGraphic' })))
          ),
          // Edges
          edgePaths.map((e, i) => React.createElement('g', { key: 'e' + i },
            React.createElement('path', { d: e.path, className: 'eo-edge', markerEnd: 'url(#arch-arrow)', strokeDasharray: e.dashed ? '6,4' : 'none' }),
            e.label && React.createElement('text', {
              x: e.cx || (e.x1 + e.x2) / 2, y: (e.cy || (e.y1 + e.y2) / 2) - 8,
              textAnchor: 'middle', style: { fontSize: 9, fill: 'var(--tx-3)', fontFamily: 'var(--mono)' }
            }, e.label)
          )),
          // Nodes
          nodes.map((node, i) => {
            const pos = positions[i];
            if (!pos) return null;
            const isHov = archHovered === node.id;
            const isSel = archSelected?.id === node.id;
            const nW = archLevel === 0 ? 160 : (archLevel === 2 ? 180 : 160);
            const nH = archLevel === 0 ? 80 : (archLevel === 2 ? 80 : 70);
            return React.createElement('g', {
              key: node.id, className: 'eo-node',
              transform: 'translate(' + (pos.x - nW / 2) + ',' + (pos.y - nH / 2) + ')',
              onClick: () => archDrillDown(node),
              onMouseEnter: () => setArchHovered(node.id),
              onMouseLeave: () => setArchHovered(null)
            },
              React.createElement('rect', {
                className: 'eo-node-bg', width: nW, height: nH,
                fill: node.dimColor || 'var(--bg-2)',
                stroke: isSel ? node.color : (isHov ? node.color : 'var(--border-1)'),
                strokeWidth: isSel ? 2.5 : (isHov ? 2 : 1),
                filter: isHov ? 'url(#arch-glow)' : 'none'
              }),
              React.createElement('text', {
                x: nW / 2, y: nH / 2 - 8, textAnchor: 'middle',
                style: { fontSize: archLevel === 0 ? 14 : 12, fontWeight: 700, fill: node.color || 'var(--tx-0)' }
              }, node.label),
              React.createElement('text', {
                x: nW / 2, y: nH / 2 + 8, textAnchor: 'middle',
                style: { fontSize: 9, fill: 'var(--tx-2)', fontFamily: 'var(--mono)' }
              }, node.sublabel),
              node.childCount > 0 && React.createElement('text', {
                x: nW / 2, y: nH - 6, textAnchor: 'middle', style: { fontSize: 8, fill: 'var(--tx-3)' }
              }, 'click to expand \u203a')
            );
          })
        ),
        // Detail panel
        archSelected && React.createElement('div', { className: 'eo-graph-detail' },
          React.createElement('div', { className: 'detail-head' },
            React.createElement('div', {
              style: { width: 28, height: 28, borderRadius: 'var(--r)', background: archSelected.dimColor || 'var(--bg-3)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                color: archSelected.color || 'var(--tx-0)', fontWeight: 700, fontSize: 11, fontFamily: 'var(--mono)' }
            }, (archSelected.label || '').slice(0, 3)),
            React.createElement('div', { style: { flex: 1 } },
              React.createElement('div', { style: { fontSize: 14, fontWeight: 700 } }, archSelected.fullLabel || archSelected.label),
              React.createElement('div', { style: { fontSize: 10, color: 'var(--tx-2)', fontFamily: 'var(--mono)' } }, archSelected.sublabel)),
            React.createElement('div', { onClick: () => setArchSelected(null), style: { cursor: 'pointer', padding: 4 } },
              React.createElement(I, { n: 'x', s: 14 }))
          ),
          React.createElement('div', { className: 'detail-body' },
            React.createElement('p', null, archSelected.desc),
            archSelected.allOps && archSelected.allOps.length > 0 && React.createElement('div', null,
              React.createElement('div', { style: { fontSize: 10, fontWeight: 600, color: 'var(--tx-2)', marginTop: 10, marginBottom: 4 } }, 'OPERATORS USED'),
              React.createElement('div', { className: 'detail-ops' },
                (archSelected.allOps || []).map(op => React.createElement('span', { key: op,
                  style: { padding: '2px 8px', borderRadius: 'var(--r)', fontSize: 10, fontWeight: 700, fontFamily: 'var(--mono)',
                    background: 'var(--bg-3)', color: 'var(--tx-1)' }
                }, op)))),
            archSelected.definitions && archSelected.definitions.length > 0 && React.createElement('div', null,
              React.createElement('div', { style: { fontSize: 10, fontWeight: 600, color: 'var(--tx-2)', marginTop: 10, marginBottom: 4 } }, 'FUNCTIONS'),
              archSelected.definitions.map((d, di) => React.createElement('div', { key: di,
                style: { padding: '4px 8px', marginBottom: 2, fontSize: 11, fontFamily: 'var(--mono)', color: 'var(--tx-1)', background: 'var(--bg-3)', borderRadius: 'var(--r)' }
              }, d.name + ' (line ' + d.line + ')')))
          )
        )
      ),
      // Legend
      React.createElement('div', { className: 'eo-graph-legend' },
        React.createElement(I, { n: 'graphNodes', s: 13 }),
        React.createElement('span', { style: { fontWeight: 600 } }, 'Architecture:'),
        ARCH_NODES.slice(0, 4).map(n => React.createElement('div', { key: n.id, style: { display: 'flex', alignItems: 'center', gap: 5 } },
          React.createElement('div', { className: 'leg-dot', style: { background: n.color } }),
          React.createElement('span', null, n.label))),
        React.createElement('div', { style: { marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: 8 } },
          React.createElement('span', null, 'Level ' + archLevel),
          React.createElement('span', null, nodes.length + ' nodes'),
          React.createElement('span', null, edgePaths.length + ' edges'))
      )
    );
  };

  return React.createElement('div', { className: 'anim-up', style: { maxWidth: activeTab === 'source' || activeTab === 'architecture' ? 1400 : 1000, margin: '0 auto', transition: 'max-width .3s' } },
    // Header
    React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 20 } },
      onBack && React.createElement('button', { onClick: onBack, className: 'b-gho b-sm', style: { display: 'flex', alignItems: 'center', gap: 4 } },
        React.createElement(I, { n: 'back', s: 13 }), 'Back'),
      React.createElement('div', null,
        React.createElement('h2', { style: { fontFamily: 'var(--serif)', fontSize: 22, fontWeight: 700 } }, 'Transparency & Privacy'),
        React.createElement('p', { style: { color: 'var(--tx-1)', fontSize: 12.5, marginTop: 2 } },
          'How Khora works, who has access, and the full source code — nothing hidden'))),
    // Tabs
    React.createElement('div', { className: 'tabs' },
      [{ id: 'overview', label: 'How It Works' }, { id: 'privacy', label: 'Privacy & Access' }, { id: 'source', label: 'Source Code' }, { id: 'architecture', label: 'Architecture' }].map(t =>
        React.createElement('div', {
          key: t.id,
          className: 'tab' + (activeTab === t.id ? ' active' : ''),
          onClick: () => setActiveTab(t.id)
        }, t.label))),
    // Content
    activeTab === 'overview' && renderOverview(),
    activeTab === 'privacy' && renderPrivacy(),
    activeTab === 'source' && renderSource(),
    activeTab === 'architecture' && renderArchitecture());
};

/* ═══════════════════ MAIN APP ═══════════════════ */
const App = () => {
  const [welcomed, setWelcomed] = useState(() => {
    try {
      return localStorage.getItem('khora_welcomed') === '1';
    } catch {
      return false;
    }
  });
  const [session, setSession] = useState(null);
  const [availableContexts, setAvailableContexts] = useState([]);
  const [activeContext, setActiveContext] = useState(null);
  const [detectedRoles, setDetectedRoles] = useState(null); // roles from inferRolesFromRooms
  const [toast, setToast] = useState(null);

  const [restoring, setRestoring] = useState(true);
  const [restoreError, setRestoreError] = useState(null); // {type:'expired'|'network', message?:string}
  const [detectingRoles, setDetectingRoles] = useState(false);
  const showToast = (msg, type = 'info') => setToast({
    msg,
    type,
    k: Date.now()
  });

  // Context detection: scan rooms to infer roles (MVP §Screen 1)
  // Uses inferRolesFromRooms for fine-grained role detection (client/provider/org_admin/network)
  const detectContexts = React.useCallback(async () => {
    setDetectingRoles(true);
    try {
      const scanned = await svc.scanRooms([EVT.ORG_ROSTER]);
      // Fine-grained role detection via inferRolesFromRooms
      const roles = inferRolesFromRooms(scanned, svc.userId);
      setDetectedRoles(roles);

      // Context detection for app routing (client vs provider)
      let hasClient = false;
      let hasProvider = false;
      for (const state of Object.values(scanned || {})) {
        const accountType = state?.[EVT.IDENTITY]?.account_type;
        if (accountType === 'client' || accountType === 'client_record') hasClient = true;
        if (accountType === 'provider' || accountType === 'organization' || accountType === 'schema' || accountType === 'metrics' || accountType === 'network') hasProvider = true;
      }
      const contexts = [];
      if (hasProvider) contexts.push('provider');
      if (hasClient) contexts.push('client');
      if (contexts.length === 0) contexts.push('provider');
      setAvailableContexts(contexts);
      let preferred = null;
      try {
        preferred = localStorage.getItem('khora_active_context');
      } catch {}
      const next = preferred && contexts.includes(preferred) ? preferred : contexts[0];
      setActiveContext(next);
    } catch (e) {
      console.warn('Context detection failed, defaulting to provider:', e.message);
      setAvailableContexts(['provider']);
      setActiveContext('provider');
    }
    setDetectingRoles(false);
  }, []);
  const switchContext = context => {
    if (!availableContexts.includes(context)) return;
    setActiveContext(context);
    try {
      localStorage.setItem('khora_active_context', context);
    } catch {}
  };

  // Attempt to restore previous session from localStorage on mount
  const attemptRestore = React.useCallback(async () => {
    setRestoring(true);
    setRestoreError(null);
    try {
      const restored = await svc.restoreSession();
      if (!restored) {
        setRestoring(false);
        return;
      }
      if (restored.expired) {
        setRestoreError({
          type: 'expired'
        });
        setRestoring(false);
        return;
      }
      if (restored.networkError) {
        setRestoreError({
          type: 'network',
          message: restored.message
        });
        setRestoring(false);
        return;
      }
      setSession(restored);
      // Ensure restored session bypasses welcome screen (even if khora_welcomed was cleared)
      setWelcomed(true);
      try { localStorage.setItem('khora_welcomed', '1'); } catch {}
      await detectContexts();
    } catch (e) { console.warn('Session restore error:', e?.message); } finally {
      setRestoring(false);
    }
  }, [detectContexts]);
  React.useEffect(() => {
    attemptRestore();
  }, [attemptRestore]);
  const handleLogin = async s => {
    setSession(s);
    // Detect contexts + roles from room membership (MVP §Screen 1)
    await detectContexts();
  };
  if (restoring || detectingRoles) return /*#__PURE__*/React.createElement("div", {
    className: "grid-bg",
    style: {
      height: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement(Spin, {
    s: 32
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      fontSize: 13,
      marginTop: 16
    }
  }, detectingRoles ? 'Setting up your workspace\u2026' : 'Restoring session\u2026')));

  // Network error during restore — offer retry without wiping the saved session
  if (restoreError?.type === 'network' && !session) return /*#__PURE__*/React.createElement("div", {
    className: "grid-bg",
    style: {
      height: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      width: '100%',
      maxWidth: 400,
      padding: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--bg-1)',
      border: '1px solid var(--border-0)',
      borderRadius: 'var(--r-lg)',
      padding: '36px 32px',
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 48,
      height: 48,
      borderRadius: '50%',
      background: 'var(--gold-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--gold)',
      margin: '0 auto 16px'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "wifi-off",
    s: 22
  })), /*#__PURE__*/React.createElement("h2", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      marginBottom: 8
    }
  }, "Connection issue"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      fontSize: 13,
      lineHeight: 1.6,
      marginBottom: 20
    }
  }, "Could not reach the server to restore your session. Your login is saved and will reconnect automatically."), restoreError.message && /*#__PURE__*/React.createElement("p", {
    style: {
      fontFamily: 'var(--mono)',
      fontSize: 11,
      color: 'var(--tx-3)',
      marginBottom: 16
    }
  }, restoreError.message), /*#__PURE__*/React.createElement("div", {
    style: {
      display: 'flex',
      gap: 10,
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("button", {
    className: "b-pri",
    onClick: () => attemptRestore(),
    style: {
      padding: '10px 24px',
      fontSize: 13
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "refresh-cw",
    s: 14
  }), " Retry"), /*#__PURE__*/React.createElement("button", {
    className: "b-gho",
    onClick: () => {
      setRestoreError(null);
    },
    style: {
      padding: '10px 24px',
      fontSize: 13
    }
  }, "Sign in manually")))));

  // Token expired — inform user and route to login
  if (restoreError?.type === 'expired' && !session) return /*#__PURE__*/React.createElement("div", {
    className: "grid-bg",
    style: {
      height: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "anim-up",
    style: {
      width: '100%',
      maxWidth: 400,
      padding: 20
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      background: 'var(--bg-1)',
      border: '1px solid var(--border-0)',
      borderRadius: 'var(--r-lg)',
      padding: '36px 32px',
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      width: 48,
      height: 48,
      borderRadius: '50%',
      background: 'var(--gold-dim)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'var(--gold)',
      margin: '0 auto 16px'
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "clock",
    s: 22
  })), /*#__PURE__*/React.createElement("h2", {
    style: {
      fontSize: 18,
      fontWeight: 700,
      marginBottom: 8
    }
  }, "Session expired"), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      fontSize: 13,
      lineHeight: 1.6,
      marginBottom: 20
    }
  }, "Your previous session has expired. Please sign in again to continue."), /*#__PURE__*/React.createElement("button", {
    className: "b-pri",
    onClick: () => setRestoreError(null),
    style: {
      padding: '10px 28px',
      fontSize: 13
    }
  }, /*#__PURE__*/React.createElement(I, {
    n: "lock",
    s: 14
  }), " Sign in"))));
  if (!session) return /*#__PURE__*/React.createElement(LoginScreen, {
    onLogin: handleLogin
  });
  if (!activeContext) return /*#__PURE__*/React.createElement("div", {
    className: "grid-bg",
    style: {
      height: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: 'center'
    }
  }, /*#__PURE__*/React.createElement(Spin, {
    s: 28
  }), /*#__PURE__*/React.createElement("p", {
    style: {
      color: 'var(--tx-2)',
      fontSize: 13,
      marginTop: 16
    }
  }, "Detecting role context\u2026")));
  const handleLogout = async () => {
    try {
      localStorage.removeItem('khora_session');
      localStorage.removeItem('khora_active_context');
      localStorage.removeItem('khora_active_org');
      localStorage.removeItem('khora_welcomed');
    } catch {}
    await svc.logout();
    setSession(null);
    setAvailableContexts([]);
    setActiveContext(null);
    setDetectedRoles(null);
    setWelcomed(false);
  };
  return /*#__PURE__*/React.createElement(React.Fragment, null, activeContext === 'client' ? /*#__PURE__*/React.createElement(ClientApp, {
    session: session,
    onLogout: handleLogout,
    showToast: showToast,
    availableContexts: availableContexts,
    activeContext: activeContext,
    onSwitchContext: switchContext
  }) : /*#__PURE__*/React.createElement(ProviderApp, {
    session: session,
    onLogout: handleLogout,
    showToast: showToast,
    availableContexts: availableContexts,
    activeMode: activeContext,
    onSwitchContext: switchContext
  }), toast && /*#__PURE__*/React.createElement(Toast, {
    key: toast.k,
    msg: toast.msg,
    type: toast.type,
    onClose: () => setToast(null)
  }));
};
ReactDOM.createRoot(document.getElementById('root')).render(/*#__PURE__*/React.createElement(ThemeProvider, null, /*#__PURE__*/React.createElement(App, null)));
</script>
</body>
</html>
